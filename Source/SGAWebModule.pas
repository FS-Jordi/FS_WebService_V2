// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │                                                                       │ \\
// │ FACTORYSTART LICENSE SERVER v1.0                                      │ \\
// │                                                                       │ \\
// ├───────────────────────────────────────────────────────────────────────┤ \\
// │                                                                       │ \\
// │ WEBSERVICE PER A L'APLICACIÓ SGA MÒBIL                                │ \\
// │                                                                       │ \\
// ├───────────────────────────────────────────────────────────────────────┤ \\
// │ COPYRIGHT © 2019-2020 ARTECSOFT, S.L.                                 │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\

unit SGAWebModule;


interface


{$REGION '--- IMPORTACIONS'}

uses
  System.SysUtils,
  System.Classes,
  Vcl.StdCtrls,
  System.Math,
  Vcl.ExtCtrls,
  Web.HTTPApp,
  Data.DB,
  IdUri,
  Printers,
  WinSpool,
  Windows,
  WinInet,
  StrUtils,
  Data.Win.ADODB,
  System.DateUtils,
  WinApi.ActiveX,
  System.JSON,
  Functions_SAGE,
  System.RegularExpressions,
  Functions_PARAMS,
  cxImage,
  System.NetEncoding,
  IdCoderMIME,
  IdGlobal,
  Variants,
  Functions,
  jPeg,
  ppEndUsr, ppParameter, ppDesignLayer,
  ppBands, ppPrnabl, ppClass, ppCtrls, ppBarCode2D, ppCache, ppProd, ppReport,
  ppDB, ppComm, ppRelatv, ppDBPipe,
  ppBarCod, raCodMod, ppModule, ppVar, raIDE, ppDsgnDB;



{$ENDREGION}


var
  LP: TLogTrace;

{$REGION '--- DEFINICIÓ DE TIPUS'}

const
  DEFAULT_PAGE_SIZE = 50;


procedure WebModuleBeforeDispatch ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1DefaultHandlerAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1reconnectDBAction  ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1logoAction  ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1userImageAction  ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1artImageAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1logoutAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getLicenseInfoAction  ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getConnectionInfoAction  ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listCompaniesAction  ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listAlmacenesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1entradaStockAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1cabeceraPedidoVentaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1cabeceraPedidoCompraAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1salidaStockAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1traspasoStockAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1cambiarUnidadMedidaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1regularizacionStockAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getPackingListAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getPackingListExpedicionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1ubicacionesArticuloAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1movimientosArticuloAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1clearExpedicionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1deleteExpedicionDetalleAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1codigoArticuloAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getZonasPreparacionesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getTransportistasPreparacionesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getComisionistasPreparacionesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getRutasPreparacionesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getUbicacionesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listArticulosUbicacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getZonasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listProveedoresAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listClientesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listLineasPedidoCompraAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listLineasAlbaranProveedorAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listLineasPedidoVentaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listPartidasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listTallasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listColoresAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listCabeceraAlbaranClienteAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listCabeceraAlbaranCompraAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1checkEmptyTargetAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updateTraspasosSelectedAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1traspasarListaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listLineasAlbaranVentaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listArticulosAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1refreshStockArticuloAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getNumerosSeriePreparacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getNumerosSerieRecepcionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1findArticulosAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listFamiliasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listSubfamiliasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getPasilloAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listEstanteriasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listAlturasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listFondosAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updatePedidosListAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1startPreparacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1stopPreparacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listPreparacionesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1saveMetodoRutaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getMetodoRutaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listAprovisionamientosAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getAprovisionamientoDetailAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1refreshAprovisionamientoDetailAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1cerrarAprovisionamientoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1setBloqueoUbicacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getAprovisionamientoMovimientosAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1detallePreparacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1preparacionUbicacionesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listInventariosAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updateCajasPaletsAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updateReservaPaletAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1userListAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1validateUserAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; Port: Integer; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1readFormPermsAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; Port: Integer; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getArticuloDetailsAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updateUnidadesPreparacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updateUnidadesPreparacionTCAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1deletePreparacionDetailTCAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listRecepcionesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1detalleRecepcionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updateRecepcionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updateDevolucionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updateDevolucionProvAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1dashboardAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1validateUbicacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listInventarioUbicacionesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updateInventarioUbicacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listIncidenciasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listUbicacionesFavoritasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1ubicacionesRecepcionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1ubicacionesDevolucionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1ubicacionesDevolucionProvAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1servirRecepcionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1servirDevolucionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1servirDevolucionProvAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listDevolucionesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listDevolucionesProvAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1detalleDevolucionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1detalleDevolucionProvAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1detalleExpedicionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1expedicionDisponibleAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getDefaultLocationsAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1readBarcodeAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1actualizarExpedicionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1deleteRecepcionDetailAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1deleteDevolucionDetailAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1deleteDevolucionProvDetailAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1actualizarExpedicionAllAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updateDevolucionOldAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1readParamAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1detallePreparacionOrdenAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1preparacionCalcularIndiceAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1expedicionPartidasArticuloAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1expedicionPartidasArticuloTCAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1expedicionPartidasArticuloBryocanTCAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1detalleExpedicion2Action ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1traspasoUbicacionDestinoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1articulosCajaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1actualizarRutaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listArticulosRecepcionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listArticulosDevolucionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listArticulosDevolucionProvAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1desgloseRecepcionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1desgloseDevolucionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1desgloseDevolucionProvAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updateCabeceraRecepcionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updateCabeceraDevolucionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updateCabeceraDevolucionProvAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1readParamsAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1detallePreparacionPedidoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1expedirPedidoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1contenidoUbicacionInventarioAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listPreparacionOrdenadaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listInformesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1generarInformeAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1prepareServirPrepAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1servirPreparacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1prepareServirRecAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1prepareServirDevAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1prepareServirDevProvAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1diagnosticsAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getArticulo128DetailsAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1detallePreparacionPedidoNewAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1imprimirMatriculaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listPackagingsAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listPackagingsPreparacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updatePackagingMatriculaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updatePackagingMatriculaCajaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updatePackagingPaletAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updatePackagingCajaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1detalleExpedicionTCAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1detalleExpedicionTCAgrupacionesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1detallerecuperarPackingListScansAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1detalleExpedicionTCPartidasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1detallePackingListArticuloAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1saveScansAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1saveNumerosSeriePreparacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1loadScansAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getDetallePartidasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getAgrupacionesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getInfoPreparacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1checkUnidadesPreparadas ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updateObservacionesPreparacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1generatePackingListAuto ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1generatePackingListAsis ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getexpedicioncajaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getArticuloagrupadoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getArticuloTallaColor ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listAprovisionamientoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1finishTransitosAprovisionamientoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1refreshRutaAprovisionamientoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1moveAprovisionamientoToEndAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1doAprovisionamientoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1detalleAprovisionamientoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updatePaletCajaActualAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1findPaletMatriculaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1generarPackingListAutoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1expedirTodoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1expedirLineaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1checkNumeroSeriePreparacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1checkNumeroSerieRecepcionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1borrarLineaExpedicionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getLastCajaIdAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1renumerarCajasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1recibirLineaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1proximaUbicacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1checkUbicacionInventarioAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1validarUbicacionInventarioAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updateInventarioDetailAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1deleteInventarioDetailAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1validateInventarioDetailAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1closeInventarioAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1impresorasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1listTemplatesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1printCajaExpedicionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1testPrinterAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getMaxUsedPartidaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1encodeUrlAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; Port: Integer; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1checkLicenseAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; Port: Integer; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1freeLicenseAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; Port: Integer; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getReposicionesCountAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getReposicionesAlmacenAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1articuloEnReposicionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1restartServiceAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1restorePaletMatriculaCajaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1generateMatriculaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1getMatriculaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1paletsEnUbicacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1moverPaletAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1checkUbicacionPaletAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1recuperarInfoPaletAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1updateEstadoPaletAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1recuperarMotivosBloqueoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1cambiarMotivoBloqueoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1cambiarTipoReservaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1clientesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1cadenasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1changePaletPackagingAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
procedure WebModule1findUbicacionMatriculaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );


{
procedure WebModule1updateAprovisionamientoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
}

{$ENDREGION}


function FS_SGA_ObtenerMovimientosPreparacion ( Conn: TADOConnection; IdPreparacion: Integer; CodigoEmpresa: TOrigenCodigoEmpresa;
  LineasPosicion, CodigoArticulo, Partida, CodigoTalla, CodigoColor, CodigoAlmacen: String; MostrarPartidas: Integer;
  var Error: Boolean; var iStockTotal: Double ): String;

function FS_SGA_ObtenerUbicaciones ( Conn: TADOConnection; IdPreparacion: Integer; CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoArticulo, UnidadMedida, Partida, CodigoTalla, CodigoColor, CodigoAlmacen, CodigoCliente: String;
  PermitirCaducados: String; MostrarPartidas: Integer; SoloConStock: Boolean;
  var Error: Boolean; var iStockTotal: Double ): String;


function BARCODE_Tipo ( Conn: TADOConnection; CodigoEmpresa: TOrigenCodigoEmpresa; CodigoAlmacen: String; var Barcode: String ): Integer;


implementation


{$REGION '--- IMPORTACIONS'}

uses
  Globals,
  Functions_EncryptDecrypt,
  Functions_LogV2,
  Functions_Code128,
  Functions_Network,
  Functions_DB,
  Functions_SGA,
  Functions_JSON,
  Functions_LicenseDll,
  Main;

{$ENDREGION}


{$REGION '--- FUNCIONS GENERALS'}

// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ AFEGIM EL CORS A TOTES LES RESPOSTES DEL WEBSERVICE                   │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModuleBeforeDispatch ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
begin

  {
  Response.SetCustomHeader('Access-Control-Allow-Origin','*');

  if Trim(Request.GetFieldByName('Access-Control-Request-Headers')) <> '' then
  begin
    Response.SetCustomHeader('Access-Control-Allow-Headers',
      Request.GetFieldByName('Access-Control-Request-Headers'));
    Handled := True;
  end;

  if Conn=nil then
    Conn := FS_MainWebServiceSGA.SQLConn;

  //CONFIG_Server_Alive();
  }

end;



// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ PÀGINA INDEX                                                          │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1actualizarExpedicionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  IdPreparacion: Integer;
  PickingId: Integer;
  sSQL: String;
  Data: String;
  Desglose: String;
  lJSonValue: TJSonValue;
  CodigoUbicacion: String;
  CodigoArticulo: String;
  Partida: String;
  LineasPosicion: String;
  Q: TADOQuery;
  aUbicacion: TSGAUbicacion;
  Stock: Double;
  bErr: Boolean;
  sMsg: String;
  sNewGuid: String;
  sNewMovOrigen: String;
  sOrigenMovimiento: String;
  YY: Integer;
  CodigoUsuario: Integer;
  iNum: Integer;
  Cantidad: Double;
  UnidadMedida: String;
  CantidadBase: Double;
  UnidadMedidaBase: String;
  UnidadesMaximas: Double;
  FactorConversion: Double;
  TratamientoPartidas: Boolean;
  IdentificadorExpedicion: Integer;
  CajaId, PaletId: Integer;
  CajaRef, PaletRef: String;
  Ejercicio: Integer;
  sId: string;
  sStr: String;
  CodigoAgrupacion: Integer;
  contentfields: TStringList;
  iMetodoExpedicion: Integer;
  sUnidadMedidaAgrupacion: String;
  bNew: Boolean;
  bAll: Boolean;
  bCajaAuto: Boolean;
  fStockBase: Double;
  CodigoAlmacenDefecto: string;
  CodigoAlmacen: String;
  DefaultUbi: TDefaultUbicaciones;
  UnidadesAgrupacion: Double;
  GrupoTalla: Integer;
  CodigoTalla: string;
  CodigoColor: string;
  sPROC: String;
  proc: TADOStoredProc;
  Matricula: string;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(ContentFields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID          := contentfields.values['UUID'];

  Matricula := (contentfields.Values['Matricula']);
  CodigoAlmacenDefecto := (contentfields.Values['CodigoAlmacenDefecto']);
  if CodigoAlmacenDefecto='' then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  YY := SGA_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  PickingId := StrToIntDef(contentfields.values['PickingId'],0);
  if PickingId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de línea no especificado","Data":[]}';
    Exit;
  end;

  IdentificadorExpedicion := StrToIntDef(contentfields.values['IdExpedicion'],0);
  if IdentificadorExpedicion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de expedición no especificado","Data":[]}';
    Exit;
  end;

  CajaId := StrToIntDef(contentfields.values['CajaId'],0);
  if CajaId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de caja no especificado","Data":[]}';
    Exit;
  end;

  CajaRef := (contentfields.values['CajaRef']);

  PaletId := StrToIntDef(contentfields.values['PaletId'],0);
  if PaletId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de palet no especificado","Data":[]}';
    Exit;
  end;

  PaletRef := (contentfields.values['PaletRef']);

  bNew := (StrToIntDef(contentfields.values['New'],0)=1);
  bAll := (StrToIntDef(contentfields.values['All'],0)=1);

  LineasPosicion := (contentfields.values['LineasPosicion']);
  LineasPosicion := StringReplace(LineasPosicion, '{', '', [rfReplaceAll]);
  LineasPosicion := StringReplace(LineasPosicion, '}', '', [rfReplaceAll]);
  if LineasPosicion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"GUID de línea del pedido no especificado","Data":[]}';
    Exit;
  end;

  CodigoArticulo := (contentfields.values['CodigoArticulo']);

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );
  if CodigoArticulo=''then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;

  TratamientoPartidas := ARTICULO_TratamientoPartida ( Conn, CodigoEmpresa, CodigoArticulo );

  Partida := (contentfields.values['Partida']);
  if (Partida='') and (TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de partida no especificado","Data":[]}';
    Exit;
  end;

  if (Partida<>'') and (not TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no requiere partida","Data":[]}';
    Exit;
  end;

  // Llegim la ubicació on tenim les unitats preparades
  sSQL :=
      'SELECT AlmacenPreparacion ' +
      'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
      'WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  CodigoAlmacen := SQL_Execute ( Conn, sSQL );

  if (CodigoAlmacen='') or (CodigoAlmacen='0') then
  begin
    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacion, CodigoEmpresa.EmpresaOrigen );
    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacion );
  end;

  FS_SGA_ObtenerUbicacionesAlmacen ( Conn, CodigoEmpresa, CodigoAlmacen, DefaultUbi );
  CodigoUbicacion := DefaultUbi.UbicacionExpediciones;

  //PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacion, CodigoEmpresa.EmpresaOrigen );

  // Conversió al codi d'article real
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de ubicación incorrecto en parámetros","Data":[]}';
    Exit;
  end;

  aUbicacion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );
  if aUbicacion.CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de ubicación es incorrecto","Data":[]}';
    Exit;
  end;

  Cantidad := FS_StrToFloatDef ( Trim(contentfields.values['Cantidad']), -1 );
  if Cantidad<0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Cantidad no especificada","Data":[]}';
    Exit;
  end;

  CantidadBase := FS_StrToFloatDef ( Trim(contentfields.values['CantidadBase']), -1 );
  if Cantidad<0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Cantidad base no especificada","Data":[]}';
    Exit;
  end;

  UnidadMedida       := ( AnsiUpperCase(contentfields.values['UnidadMedida']) );
  UnidadMedidaBase   := ( AnsiUpperCase(contentfields.values['UnidadMedidaBase']) );
  FactorConversion   := FS_StrToFloatDef(contentfields.values['FactorConversion'],1);
  CodigoAgrupacion   := StrToIntDef(contentfields.values['CodigoAgrupacion'],0);
  UnidadesAgrupacion := FS_StrToFloatDef(contentfields.values['UnidadesAgrupacion'],0);
  GrupoTalla         := StrToIntDef(contentfields.values['GrupoTalla'],0);
  CodigoTalla        := ( contentfields.values['CodigoTalla'] );
  CodigoColor        := ( contentfields.values['CodigoColor'] );

  FS_SGA_Check_UnidadMedidaBase ( Conn, CodigoEmpresa, CodigoArticulo, UnidadMedida, UnidadMedidaBase );

  (*
  if CodigoAgrupacion=0 then
  begin
    sUnidadMedidaAgrupacion := UnidadMedida;
    fUnidadesAgrupacion     := 1;
  end else begin
    FS_SGA_ObtenerAgrupacion (
      Conn, CodigoEmpresa, CodigoArticulo, CodigoAgrupacion, fUnidadesAgrupacion, sUnidadMedidaAgrupacion );
    if sUnidadMedidaAgrupacion='' then
      sUnidadMedidaAgrupacion := UnidadMedida;
  end;

  UnidadesBase := SGA_FS_ARTICULO_ConversionUnidades ( Conn, CodigoEmpresa, CodigoArticulo,
                    Unidades, UnidadMedidaBase, UnidadMedida, FactorConversion );

  if UnidadesBase<0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Las unidades de medida son incorrectas","Data":[]}';
    Exit;
  end;
  *)

  Stock :=
    SGA_ALMACEN_Stock (
      Conn,
      CodigoEmpresa,
      aUbicacion.CodigoAlmacen,
      CodigoUbicacion,
      CodigoArticulo,
      Partida,
      CodigoTalla,
      CodigoColor,
      Matricula,
      UnidadMedida,
      UnidadMedidaBase,
      fStockBase,
      gbTratamientoSimplificado
    );

  if (Cantidad>Stock) or (CantidadBase>fStockBase) then begin
    if (Stock=0) and (fStockBase=0) then
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No hay stock en la ubicación de expedición","Data":[]}'
    else
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La cantidad es superior al stock de la ubicación de expedición","Data":[]}';
    gaLogFile.Write ( Result + 'Unidades requeridas: ' + FloatToStr(CantidadBase) + ', Stock en ubicación: ' + FloatToStr(Stock) + ', Ubicación: ' + CodigoUbicacion, sIDCall, LOG_LEVEL_INFO );
    Exit;
  end;

  sSQL := 'SELECT ' +
          '  Ejercicio ' +
          'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  if Ejercicio=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Ejercicio de preparación no encontrado","Data":[]}';
    Exit;
  end;

  if bNew then begin
    sSQL := 'SELECT ' +
            '  SUM(CantidadBase) ' +
            'FROM FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
            'WHERE ' +
            '  (LineaPedidoCliente = ''00000000-0000-0000-0000-000000000000'') ' +
            //'  LineaPedidoCliente = ''' + SQL_Str(LineasPosicion) + ''') ' +
            '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
            '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
            '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
            '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
            '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
            '  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion);
  end else begin
    sSQL := 'SELECT ' +
            '  SUM(CantidadBase) ' +
            'FROM FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
            'WHERE ' +
            '  CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
            '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
            '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
            '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
            '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
            '  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion);
  end;

  try
    UnidadesMaximas := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      gaLogFile.Write_DBException ( E, sSQL, 'Error al recuperar los datos', sIDCall, LOG_LEVEL_EXCEPTION );
    end;
  end;

  if (CantidadBase>UnidadesMaximas) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No hay unidades disponibles. Refrescar pantalla","Data":[]}';
    Exit;
  end;

  FreeAndNil(contentfields);

  {$ENDREGION}

  {$REGION 'Guardar les dades'}

  try
    // // Conn.BeginTrans;
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","' + JSON_Str(E.Message) + '","Data":[]}';
      Exit;
    end;
  end;

  bErr := FALSE;
  sMsg := '';

  if not bErr then try
    sNewGuid           := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sNewMovOrigen      := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sOrigenMovimiento  := 'S';
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if not bErr then try

    gaLogFile.Write ( 'Before SGA_Reservar_stock_pedidoExpedicion', sIDCall, LOG_LEVEL_INFO );

    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_GenerarNumCajaAuto, bCajaAuto, CodigoEmpresa.EmpresaOrigen );

    sMsg := SGA_Expedir_Linea (
        Conn,
        CodigoEmpresa,
        Ejercicio,
        CodigoArticulo,
        Partida,
        CodigoTalla,
        CodigoColor,
        IdPreparacion,
        PickingId,
        LineasPosicion,
        Cantidad,
        UnidadMedida,
        CantidadBase,
        UnidadMedidaBase,
        IdentificadorExpedicion,
        CajaId,
        PaletId,
        Matricula,
        CajaRef,
        PaletRef,
        CodigoAgrupacion,
        UnidadesAgrupacion,
        FactorConversion,
        true
      );


    (*
    if bCajaAuto then
    begin

      sMsg := SGA_Reservar_stock_pedidoExpedicionNormal (
        Conn,
        CodigoEmpresa,
        Ejercicio,
        CodigoArticulo,
        Partida,
        CodigoTalla,
        CodigoColor,
        IdPreparacion,
        PickingId,
        LineasPosicion,
        Cantidad,
        UnidadMedida,
        CantidadBase,
        UnidadMedidaBase,
        IdentificadorExpedicion,
        CajaId,
        PaletId,
        CajaRef,
        PaletRef,
        CodigoAgrupacion,
        UnidadesAgrupacion,
        bNew
      );

    end else begin

      sMsg := SGA_Reservar_stock_pedidoExpedicionCaja (
        Conn,
        CodigoEmpresa,
        Ejercicio,
        CodigoArticulo,
        Partida,
        CodigoTalla,
        CodigoColor,
        IdPreparacion,
        PickingId,
        LineasPosicion,
        Cantidad,
        UnidadMedida,
        CantidadBase,
        UnidadMedidaBase,
        IdentificadorExpedicion,
        CajaId,
        PaletId,
        CajaRef,
        PaletRef,
        CodigoAgrupacion,
        UnidadesAgrupacion,
        bNew
      );

    end;
    *)

    bErr := (sMsg<>'');

    if bErr then
      gaLogFile.Write ( 'After SGA_Reservar_stock_pedidoExpedicion: ERROR', sIDCall, LOG_LEVEL_ERROR )
    else
      gaLogFile.Write ( 'After SGA_Reservar_stock_pedidoExpedicion: OK', sIDCall, LOG_LEVEL_INFO );

  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;

  end;

  sStr := '  Preparacion    : ' + IntToStr(IdPreparacion) + #13 + #10 +
          '                       CodigoArticulo : ' + CodigoArticulo + #13 + #10 +
          '                       Partida        : ' + Partida + #13 + #10 +
          '                       LineasPosicion : ' + LineasPosicion + #13 + #10 +
          '                       Cantidad       : ' + FloatToStr(Cantidad) + #13 + #10 +
          '                       CantidadBase   : ' + FloatToStr(CantidadBase) + #13 + #10;
  gaLogFile.Write ( sStr, sIDCall, LOG_LEVEL_INFO );

  if not bErr then try
    // Conn.CommitTrans;
  except
    on E:Exception do begin
      // Conn.RollbackTrans;
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end else begin
    // Conn.RollbackTrans;
  end;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(sMsg) + '","Data":[]}';
    gaLogFile.Write ( Result, sIDCall, LOG_LEVEL_ERROR );
    Exit;
  end;

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-EXP', 'Actualizar expedición del artículo (' + CodigoArticulo + ') de la preparación', @LP );
  
  {$ENDREGION}

  sId := Format ( '%d.%d.%d', [IdPreparacion,IdentificadorExpedicion,CajaId]);
  sParams := sParams + '&IdentificadorExpedicion=' + sId + '&NewPaletId=' + IntToStr(PaletId) + '&NewCajaId=' + IntToStr(CajaId);

  WebModule1detalleExpedicionAction ( Conn, sParams, sRemoteAddr, statusCode, statusText, Result );

end;


procedure WebModule1deleteRecepcionDetailAction (
  Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  IdPreparacion: Integer;
  PickingId: Integer;
  sSQL: String;
  Data: String;
  Desglose: String;
  lJSonValue: TJSonValue;
  CodigoUbicacion: String;
  CodigoArticulo: String;
  Partida: String;
  LineasPosicion: String;
  Q: TADOQuery;
  aUbicacion: TSGAUbicacion;
  Stock: Double;
  bErr: Boolean;
  sMsg: String;
  sNewGuid: String;
  sNewMovOrigen: String;
  sOrigenMovimiento: String;
  YY: Integer;
  CodigoUsuario: Integer;
  iNum: Integer;
  Unidades: Double;
  UnidadMedida: String;
  UnidadesBase: Double;
  UnidadMedidaBase: String;
  UnidadesMaximas: Double;
  FactorConversion: Double;
  //TratamientoPartidas: Boolean;
  IdentificadorExpedicion: Integer;
  CajaId, PaletId: Integer;
  CajaRef, PaletRef: String;
  Ejercicio: Integer;
  sId: string;
  sStr: String;
  contentfields: TStringList;
  Cantidad: Double;
  iMetodoExpedicion: Integer;
  UnidadesAgrupacion: Double;
  CodigoAgrupacion: Integer;
  CodigoAlmacenDefecto: string;
  DefaultUbi: TDefaultUbicaciones;
  CodigoAlmacen: String;
  RecepcionId: Integer;
  Linea: Integer;
  LineaDetalle: Integer;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID          := contentfields.values['UUID'];

  CodigoAlmacenDefecto := (contentfields.Values['CodigoAlmacenDefecto']);
  if CodigoAlmacenDefecto='' then
  begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    FreeAndNil(contentfields);
    Exit;
  end;

  RecepcionId := StrToIntDef(contentfields.Values['RecepcionId'],0);
  if RecepcionId=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Código de recepción no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    FreeAndNil(contentfields);
    Exit;
  end;

  Linea := StrToIntDef(contentfields.Values['Linea'],0);
  if Linea=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Número de línea no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    FreeAndNil(contentfields);
    Exit;
  end;

  LineaDetalle := StrToIntDef(contentfields.Values['LineaDetalle'],-1);
  if LineaDetalle=-1 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Número de detalle de línea no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    FreeAndNil(contentfields);
    Exit;
  end;

  FreeAndNil(contentfields);

  {$ENDREGION}

  {$REGION 'Esborrar les dades'}

  bErr := FALSE;
  sMsg := '';

  sSQL :=
    'DELETE FROM FS_SGA_Recepciones_Lineas_Detalle_NumerosSerie ' +
    'WHERE ' +
      '  RecepcionId = ' + IntToStr(RecepcionId) + ' ' +
      '  AND RecepcionIdLinea = ' + IntToStr(Linea) + ' ' +
      '  AND RecepcionIdLineaDetalle = ' + IntToStr(LineaDetalle);
  SQL_Execute_NoRes ( Conn, sSQL );

  sSQL :=
    'DELETE FROM FS_SGA_Recepciones_Lineas_Detalle ' +
    'WHERE ' +
    '  RecepcionId = ' + IntToStr(RecepcionId) + ' ' +
    '  AND RecepcionIdLinea = ' + IntToStr(Linea) + ' ';

  if (LineaDetalle>0) then
  begin
    sSQL := sSQL +
      '  AND RecepcionIdLineaDetalle = ' + IntToStr(LineaDetalle);
  end;

  try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do
    begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"' + JSON_Str(sMsg) + '","Data":[]}';
    gaLogFile.Write ( Result, sIDCall, LOG_LEVEL_ERROR );
    Exit;
  end;

  LP := LOG_Clear();
  LP.IdRecepcion := RecepcionId;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'DELETE-REC-DET', 'Quitar artículo (' + CodigoArticulo + ') de la recepción', @LP );

  {$ENDREGION}

  Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"OK","Message":"","Data":[]}';

end;


procedure WebModule1deleteDevolucionDetailAction (
  Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  IdDevolucion: Integer;
  PickingId: Integer;
  sSQL: String;
  Data: String;
  Desglose: String;
  lJSonValue: TJSonValue;
  CodigoUbicacion: String;
  CodigoArticulo: String;
  Partida: String;
  LineasPosicion: String;
  Q: TADOQuery;
  aUbicacion: TSGAUbicacion;
  Stock: Double;
  bErr: Boolean;
  sMsg: String;
  sNewGuid: String;
  sNewMovOrigen: String;
  sOrigenMovimiento: String;
  YY: Integer;
  CodigoUsuario: Integer;
  iNum: Integer;
  Unidades: Double;
  UnidadMedida: String;
  UnidadesBase: Double;
  UnidadMedidaBase: String;
  UnidadesMaximas: Double;
  FactorConversion: Double;
  //TratamientoPartidas: Boolean;
  IdentificadorExpedicion: Integer;
  CajaId, PaletId: Integer;
  CajaRef, PaletRef: String;
  Ejercicio: Integer;
  sId: string;
  sStr: String;
  contentfields: TStringList;
  Cantidad: Double;
  iMetodoExpedicion: Integer;
  UnidadesAgrupacion: Double;
  CodigoAgrupacion: Integer;
  CodigoAlmacenDefecto: string;
  DefaultUbi: TDefaultUbicaciones;
  CodigoAlmacen: String;
  DevolucionId: Integer;
  Linea: Integer;
  LineaDetalle: Integer;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID          := contentfields.values['UUID'];

  CodigoAlmacenDefecto := (contentfields.Values['CodigoAlmacenDefecto']);
  if CodigoAlmacenDefecto='' then
  begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    FreeAndNil(contentfields);
    Exit;
  end;

  DevolucionId := StrToIntDef(contentfields.Values['DevolucionId'],0);
  if DevolucionId=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Código de devolución no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    FreeAndNil(contentfields);
    Exit;
  end;

  Linea := StrToIntDef(contentfields.Values['Linea'],0);
  if Linea=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Número de línea no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    FreeAndNil(contentfields);
    Exit;
  end;

  LineaDetalle := StrToIntDef(contentfields.Values['LineaDetalle'],-1);
  if LineaDetalle=-1 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Número de detalle de línea no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    FreeAndNil(contentfields);
    Exit;
  end;

  FreeAndNil(contentfields);

  {$ENDREGION}

  {$REGION 'Esborrar les dades'}

  bErr := FALSE;
  sMsg := '';

  sSQL :=
    'DELETE FROM FS_SGA_Devoluciones_Lineas_Detalle ' +
    'WHERE ' +
    '  DevolucionId = ' + IntToStr(DevolucionId) + ' ' +
    '  AND DevolucionIdLinea = ' + IntToStr(Linea) + ' ';

  if (LineaDetalle>0) then
  begin
    sSQL := sSQL +
      '  AND DevolucionIdLineaDetalle = ' + IntToStr(LineaDetalle);
  end;

  try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do
    begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"' + JSON_Str(sMsg) + '","Data":[]}';
    gaLogFile.Write ( Result, sIDCall, LOG_LEVEL_ERROR );
    Exit;
  end;

  LP := LOG_Clear();
  LP.IdDevolucion := DevolucionId;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'DELETE-DEV-DET', 'Quitar artículo (' + CodigoArticulo + ') de la devolución', @LP );

  {$ENDREGION}

  Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"OK","Message":"","Data":[]}';

end;


procedure WebModule1deleteDevolucionProvDetailAction (
  Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  IdDevolucion: Integer;
  PickingId: Integer;
  sSQL: String;
  Data: String;
  Desglose: String;
  lJSonValue: TJSonValue;
  CodigoUbicacion: String;
  CodigoArticulo: String;
  Partida: String;
  LineasPosicion: String;
  Q: TADOQuery;
  aUbicacion: TSGAUbicacion;
  Stock: Double;
  bErr: Boolean;
  sMsg: String;
  sNewGuid: String;
  sNewMovOrigen: String;
  sOrigenMovimiento: String;
  YY: Integer;
  CodigoUsuario: Integer;
  iNum: Integer;
  Unidades: Double;
  UnidadMedida: String;
  UnidadesBase: Double;
  UnidadMedidaBase: String;
  UnidadesMaximas: Double;
  FactorConversion: Double;
  //TratamientoPartidas: Boolean;
  IdentificadorExpedicion: Integer;
  CajaId, PaletId: Integer;
  CajaRef, PaletRef: String;
  Ejercicio: Integer;
  sId: string;
  sStr: String;
  contentfields: TStringList;
  Cantidad: Double;
  iMetodoExpedicion: Integer;
  UnidadesAgrupacion: Double;
  CodigoAgrupacion: Integer;
  CodigoAlmacenDefecto: string;
  DefaultUbi: TDefaultUbicaciones;
  CodigoAlmacen: String;
  DevolucionId: Integer;
  Linea: Integer;
  LineaDetalle: Integer;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID          := contentfields.values['UUID'];

  CodigoAlmacenDefecto := (contentfields.Values['CodigoAlmacenDefecto']);
  if CodigoAlmacenDefecto='' then
  begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    FreeAndNil(contentfields);
    Exit;
  end;

  DevolucionId := StrToIntDef(contentfields.Values['DevolucionId'],0);
  if DevolucionId=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Código de devolución no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    FreeAndNil(contentfields);
    Exit;
  end;

  Linea := StrToIntDef(contentfields.Values['Linea'],0);
  if Linea=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Número de línea no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    FreeAndNil(contentfields);
    Exit;
  end;

  LineaDetalle := StrToIntDef(contentfields.Values['LineaDetalle'],-1);
  if LineaDetalle=-1 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Número de detalle de línea no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    FreeAndNil(contentfields);
    Exit;
  end;

  FreeAndNil(contentfields);

  {$ENDREGION}

  {$REGION 'Esborrar les dades'}

  bErr := FALSE;
  sMsg := '';

  sSQL :=
    'DELETE FROM FS_SGA_DevolucionesP_Lineas_Detalle ' +
    'WHERE ' +
    '  DevolucionId = ' + IntToStr(DevolucionId) + ' ' +
    '  AND DevolucionIdLinea = ' + IntToStr(Linea) + ' ';

  if (LineaDetalle>0) then
  begin
    sSQL := sSQL +
      '  AND DevolucionIdLineaDetalle = ' + IntToStr(LineaDetalle);
  end;

  try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do
    begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"' + JSON_Str(sMsg) + '","Data":[]}';
    gaLogFile.Write ( Result, sIDCall, LOG_LEVEL_ERROR );
    Exit;
  end;

  LP := LOG_Clear();
  LP.IdDevolucionP := DevolucionId;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'DELETE-DEVP-DET', 'Quitar artículo (' + CodigoArticulo + ') de la devolución de compras', @LP );

  {$ENDREGION}

  Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"OK","Message":"","Data":[]}';

end;



procedure WebModule1actualizarExpedicionAllAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  IdPreparacion: Integer;
  PickingId: Integer;
  sSQL: String;
  Data: String;
  Desglose: String;
  lJSonValue: TJSonValue;
  CodigoUbicacion: String;
  CodigoArticulo: String;
  Partida: String;
  LineasPosicion: String;
  Q: TADOQuery;
  aUbicacion: TSGAUbicacion;
  Stock: Double;
  bErr: Boolean;
  sMsg: String;
  sNewGuid: String;
  sNewMovOrigen: String;
  sOrigenMovimiento: String;
  YY: Integer;
  CodigoUsuario: Integer;
  iNum: Integer;
  Unidades: Double;
  UnidadMedida: String;
  UnidadesBase: Double;
  UnidadMedidaBase: String;
  UnidadesMaximas: Double;
  FactorConversion: Double;
  //TratamientoPartidas: Boolean;
  IdentificadorExpedicion: Integer;
  CajaId, PaletId: Integer;
  CajaRef, PaletRef: String;
  Ejercicio: Integer;
  sId: string;
  sStr: String;
  contentfields: TStringList;
  Cantidad: Double;
  iMetodoExpedicion: Integer;
  UnidadesAgrupacion: Double;
  CodigoAgrupacion: Integer;
  CodigoAlmacenDefecto: string;
  DefaultUbi: TDefaultUbicaciones;
  CodigoAlmacen: String;
  Matricula: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(ContentFields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoAlmacenDefecto := (contentfields.Values['CodigoAlmacenDefecto']);
  if CodigoAlmacenDefecto='' then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  YY := SGA_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  IdentificadorExpedicion := StrToIntDef(contentfields.values['IdExpedicion'],0);
  if IdentificadorExpedicion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de expedición no especificado","Data":[]}';
    Exit;
  end;

  CajaId := StrToIntDef(contentfields.values['CajaId'],0);
  if CajaId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de caja no especificado","Data":[]}';
    Exit;
  end;

  CajaRef := (contentfields.values['CajaRef']);

  PaletId := StrToIntDef(contentfields.values['PaletId'],0);
  if PaletId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de palet no especificado","Data":[]}';
    Exit;
  end;

  PaletRef := (contentfields.values['PaletRef']);

  PickingId := StrToIntDef(contentfields.values['PickingId'],0);
  if PickingId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de línea no especificado","Data":[]}';
    Exit;
  end;

  LineasPosicion := (contentfields.values['LineasPosicion']);
  LineasPosicion := StringReplace(LineasPosicion, '{', '', [rfReplaceAll]);
  LineasPosicion := StringReplace(LineasPosicion, '}', '', [rfReplaceAll]);
  if LineasPosicion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"GUID de línea del pedido no especificado","Data":[]}';
    Exit;
  end;

  CodigoArticulo := (contentfields.values['CodigoArticulo']);

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );
  if CodigoArticulo=''then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;

  // Llegim la ubicació on tenim les unitats preparades
  sSQL :=
      'SELECT AlmacenPreparacion ' +
      'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
      'WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  CodigoAlmacen := SQL_Execute ( Conn, sSQL );

  if (CodigoAlmacen='') or (CodigoAlmacen='0') then
  begin
    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacion, CodigoEmpresa.EmpresaOrigen );
    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacion );
  end;

  FS_SGA_ObtenerUbicacionesAlmacen ( Conn, CodigoEmpresa, CodigoAlmacen, DefaultUbi );
  CodigoUbicacion := DefaultUbi.UbicacionExpediciones;

  //PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacion, CodigoEmpresa.EmpresaOrigen );

  // Conversió al codi d'article real
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de ubicación incorrecto en parámetros","Data":[]}';
    Exit;
  end;

  aUbicacion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );
  if aUbicacion.CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de ubicación es incorrecto","Data":[]}';
    Exit;
  end;

  Unidades := FS_StrToFloatDef ( Trim(contentfields.values['Cantidad']), 0 );
  if Unidades<0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Cantidad no especificada","Data":[]}';
    Exit;
  end;

  Matricula        := contentfields.values['Matricula'];
  UnidadMedida     := ( AnsiUpperCase(contentfields.values['UnidadMedida']) );
  UnidadMedidaBase := FS_SGA_ARTICULO_UnidadBase ( Conn, CodigoEmpresa, CodigoArticulo );

  if (UnidadMedidaBase='') and (gbTratamientoSimplificado) then
    Unidadmedida := '';

  sSQL := 'SELECT ' +
          '  Ejercicio ' +
          'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  if Ejercicio=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Ejercicio de preparación no encontrado","Data":[]}';
    Exit;
  end;

  FreeAndNil(contentfields);

  {$ENDREGION}

  {$REGION 'Guardar les dades'}

  bErr := FALSE;
  sMsg := '';

  if not bErr then try
    sNewGuid           := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sNewMovOrigen      := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sOrigenMovimiento  := 'S';
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if Unidades>0 then
  begin

    sSQL := 'SELECT ' +
            '  Partida, SUM(Cantidad) AS Cantidad ' +
            'FROM FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
            'WHERE ' +
            '  (LineaPedidoCliente = ''00000000-0000-0000-0000-000000000000'' OR ' +
            '  LineaPedidoCliente = ''' + SQL_Str(LineasPosicion) + ''') ' +
            '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
            '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
            'GROUP BY ' +
            '  Partida';

  end else begin

    sSQL := 'SELECT ' +
            '  Partida, 0 AS Cantidad, CajaId, PaletId, CodigoAgrupacion, UnidadesAgrupacion ' +
            'FROM FS_SGA_PACKINGLIST WITH (NOLOCK) ' +
            'WHERE ' +
            '  preparacionId = ' + IntToStr(IdPreparacion) + ' ' +
            '  AND pickingId = ' + IntToStr(pickingId) + ' ' +
            'ORDER BY ' +
            '  CajaId DESC';

  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_MetodoExpedicion, iMetodoExpedicion, CodigoEmpresa.EmpresaOrigen );

  sStr := '  Preparacion    : ' + IntToStr(IdPreparacion) + #13 + #10 +
          '                       CodigoArticulo : ' + CodigoArticulo + #13 + #10 +
          '                       LineasPosicion : ' + LineasPosicion + #13 + #10;

  while (not bErr) and (not Q.EOF) do
  begin

    Partida      := Q.FieldByName('Partida').AsString;
    Cantidad     := Q.FieldByName('Cantidad').AsFloat;
    CodigoAgrupacion := Q.FieldByName('CodigoAgrupacion').AsInteger;
    UnidadesAgrupacion := Q.FieldByName('UnidadesAgrupacion').AsFloat;
    UnidadesBase := SGA_FS_ARTICULO_ConversionUnidades ( Conn, CodigoEmpresa, CodigoArticulo,
                      Cantidad, UnidadMedidaBase, UnidadMedida, FactorConversion );

    if Unidades=0 then
    begin
      cajaId  := Q.FieldByName('cajaId').AsInteger;
      paletId := Q.FieldByName('paletId').AsInteger;
    end;

    if UnidadesBase<0 then begin
      bErr := TRUE;
      sMsg := 'Las unidades de medida son incorrectas';
    end;

    gaLogFile.Write ( 'Before SGA_Reservar_stock_pedidoExpedicion', sIDCall, LOG_LEVEL_INFO );

    if not bErr then try

      if iMetodoExpedicion = 1 then
      begin

        sMsg := SGA_Reservar_stock_pedidoExpedicionNormal (
          Conn,
          CodigoEmpresa,
          Ejercicio,
          CodigoArticulo,
          Partida,
          '', // CodigoTalla,
          '', // CodigoColor,
          IdPreparacion,
          PickingId,
          LineasPosicion,
          Cantidad,
          UnidadMedida,
          UnidadesBase,
          UnidadMedidaBase,
          IdentificadorExpedicion,
          CajaId,
          PaletId,
          CajaRef,
          PaletRef,
          CodigoAgrupacion,
          UnidadesAgrupacion,
          false
        );

      end else begin

        sMsg := SGA_Reservar_stock_pedidoExpedicion (
          Conn,
          CodigoEmpresa,
          Ejercicio,
          CodigoArticulo,
          Partida,
          '', // CodigoTalla,
          '', // CodigoColor,
          IdPreparacion,
          PickingId,
          LineasPosicion,
          Cantidad,
          UnidadMedida,
          UnidadesBase,
          UnidadMedidaBase,
          IdentificadorExpedicion,
          CajaId,
          PaletId,
          CajaRef,
          PaletRef
        );

      end;

    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message;
      end;
    end;

    bErr := (sMsg<>'');

    if bErr then
      gaLogFile.Write ( 'After SGA_Reservar_stock_pedidoExpedicion: ERROR', sIDCall, LOG_LEVEL_ERROR )
    else
      gaLogFile.Write ( 'After SGA_Reservar_stock_pedidoExpedicion: OK', sIDCall, LOG_LEVEL_INFO );

    sStr := sStr + '                       Partida        : ' + Partida + #13 + #10 +
                   '                       Cantidad       : ' + FloatToStr(Unidades) + #13 + #10;

    Q.Next;

  end;

  SQL_CloseFree ( Q );

  gaLogFile.Write ( sStr, sIDCall, LOG_LEVEL_INFO );



  if not bErr then try
    // Conn.CommitTrans;
  except
    on E:Exception do begin
      // Conn.RollbackTrans;
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end else begin
    // Conn.RollbackTrans;
  end;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(sMsg) + '","Data":[]}';
    gaLogFile.Write ( Result, sIDCall, LOG_LEVEL_ERROR );
    Exit;
  end;

  {$ENDREGION}

  sId := Format ( '%d.%d.%d', [IdPreparacion,IdentificadorExpedicion,CajaId]);
  sParams := sParams + '&IdentificadorExpedicion=' + sId;

  WebModule1detalleExpedicionAction ( Conn, sParams, sRemoteAddr, statusCode, statusText, Result );

end;


procedure WebModule1actualizarRutaAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  iTotalRegs, iNumRegs: Integer;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoAlmacen: String;
  CodigoUbicacionExpedicion: String;
  CodigoUbicacionExpedicionTemp: String;
  bResult: Boolean;
  sMsg: String;
  bIsBuilding: Boolean;
  contentfields: TStringList;
  CodigoAlmacenDefecto: string;
  DefaultUbi: TDefaultUbicaciones;
  sSQL: string;
  CodigoUbicacion: string;
  CodigoUsuario: Integer;
  UUID: string;
  FromMenu: Boolean;
  sConsiderarReservas: String;
  sSoloReservas: String;
  sIgnorarPartidaSolicitada: String;
  sIgnorarUbicacionSolicitada: String;

{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID          := contentfields.values['UUID'];
  FromMenu      := (StrToIntDef(contentfields.Values['FromMenu'],0)<>0);

  sConsiderarReservas         := contentfields.Values['ConsiderarReservas'];
  sSoloReservas               := contentfields.Values['SoloReservas'];
  sIgnorarPartidaSolicitada   := contentfields.Values['IgnorarPartidaSolicitada'];
  sIgnorarUbicacionSolicitada := contentfields.Values['IgnorarUbicacionSolicitada'];

  if sConsiderarReservas='' then sConsiderarReservas := '1';
  if sSoloReservas='' then sSoloReservas := '0';
  if sIgnorarPartidaSolicitada='' then sIgnorarPartidaSolicitada := '0';
  if sIgnorarUbicacionSolicitada='' then sIgnorarUbicacionSolicitada := '0';

  CodigoAlmacenDefecto := (contentfields.Values['CodigoAlmacenDefecto']);
  if CodigoAlmacenDefecto='' then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  CodigoAlmacen := (contentfields.Values['CodigoAlmacen']);
  if CodigoAlmacen='' then
    CodigoAlmacen := (contentfields.Values['CodigoAlmacenDefecto']);

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  sSQL :=
      'SELECT AlmacenPreparacion ' +
      'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
      'WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  CodigoAlmacen := SQL_Execute ( Conn, sSQL );

  if (CodigoAlmacen='') or (CodigoAlmacen='0') then
  begin
    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacion, CodigoEmpresa.EmpresaOrigen );
    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacion );
  end;

  FS_SGA_ObtenerUbicacionesAlmacen ( Conn, CodigoEmpresa, CodigoAlmacen, DefaultUbi );
  CodigoUbicacion := DefaultUbi.UbicacionExpediciones;

  //PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacionExpedicion, CodigoEmpresa.EmpresaOrigen );

  (*
  if CodigoAlmacen='' then begin
    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacionExpedicionTemp, CodigoEmpresa.EmpresaOrigen );
    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacionExpedicionTemp );
  end;*)

  {$ENDREGION}

  {$REGION 'Refem la ruta de la preparació' }

  bResult := SGA_Check_PreparacionOrdenada (
    gsPath,
    Conn,
    CodigoEmpresa,
    CodigoUsuario,
    YY,
    IdPreparacion,
    CodigoAlmacenDefecto,
    CodigoUbicacionExpedicion,
    sConsiderarReservas,
    sSoloReservas,
    sIgnorarPartidaSolicitada,
    sIgnorarUbicacionSolicitada,
    sMsg,
    TRUE,
    bIsBuilding
  );

  if bIsBuilding then
  begin
    Result := '{"Result":"ERROR","Error":"Calculando la ruta. Volver a intentar en unos segundos","TotalRecords":0,"NumPages":0,"NumRecords":0,"Data":[]}';
  end else begin
    if bResult then begin
      Result := '{"Result":"OK","Error":"","TotalRecords":1,"NumPages":1,"NumRecords":1,"Data":[]}';
    end else begin
      Result := '{"Result":"ERROR","Error":"' + JSON_Str(sMsg) + '","TotalRecords":1,"NumPages":1,"NumRecords":1,"Data":[]}';
    end;
  end;

  if FromMenu then
  begin
    LP := LOG_Clear();
    LP.IdPreparacion := IdPreparacion;
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'RECALC-ROUTE', 'Recalcular ruta de la preparación', @LP );
  end;

  {$ENDREGION}

end;

procedure WebModule1articulosCajaAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  sCodigoExpedicion: String;
  YY: WORD;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoAlmacen: String;
  sAndWhere: String;
  Partida: string;
  EmpresaOrigen: Integer;
  iNumPunts: Integer;
  t: TStringList;
  sIdExpedicion: String;
  sIdentificadorExpedicion: String;
  sCajaId: String;
  iIdExpedicion: Integer;
  iIdentificadorExpedicion: Integer;
  iCajaId: Integer;

  sSQL: String;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  sCodigoExpedicion := contentfields.values['CodigoExpedicion'];

  iNumPunts := Length(sCodigoExpedicion)-Length(StringReplace(sCodigoExpedicion, '.','', [rfReplaceAll, rfIgnoreCase]));
  if iNumPunts<>2 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de expedición no es correcto","Data":[]}';

    Exit;
  end;

  t := TStringList.Create;
  t.Delimiter := '.';
  t.DelimitedText := sCodigoExpedicion;
  if t.Count=3 then begin
    sIdExpedicion := t[0];
    sIdentificadorExpedicion := t[1];
    sCajaId := t[2];
  end;
  t.Free;

  iIdExpedicion := StrToIntDef ( sIdExpedicion, 0 );
  iIdentificadorExpedicion := StrToIntDef ( sIdentificadorExpedicion, 0 );
  iCajaId := StrToIntDef ( sCajaId, 0 );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_PACKINGLIST WITH (NOLOCK) ' +
          'WHERE ' +
          '  preparacionId = ' + IntToStr(iIdExpedicion) + ' AND ' +
          '  identificadorExpedicion = ' + IntToStr(iIdentificadorExpedicion) + ' AND ' +
          '  cajaId = ' + IntToStr(iCajaId);

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  fspl.unidades, fspl.cajaId, fspl.cajaRef, fspl.paletId, fspl.paletRef, ' +
          '  fspl.Fecha, fsppl.* ' +
          'FROM FS_SGA_PACKINGLIST fspl WITH (NOLOCK) ' +
          'INNER JOIN FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'ON ' +
          '  fspl.preparacionId = fsppl.PreparacionId AND ' +
          '  fspl.pickingId = fsppl.PickingId ' +
          'WHERE ' +
          '  fspl.preparacionId = ' + IntToStr(iIdExpedicion) + ' AND ' +
          '  fspl.identificadorExpedicion = ' + IntToStr(iIdentificadorExpedicion) + ' AND ' +
          '  fspl.cajaId = ' + IntToStr(iCajaId) + ' ' +
          'ORDER BY ' +
          '  fsppl.CodigoArticulo ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ', ' +
      '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
      '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '", ' +
      '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
      '"OrdenLineaPedido":"' + Q.FieldByName('OrdenLineaPedido').AsString + '",' +
      '"LineasPosicion":"' + JSON_Str(Q.FieldByName('LineasPosicion').AsString) + '", ' +
      '"PreparacionId":' + Q.FieldByName('PreparacionId').AsString + ', ' +
      '"IdentificadorExpedicion":' + Q.FieldByName('IdentificadorExpedicion').AsString + ', ' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '", ' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '", ' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '", ' +
      '"CodigoCliente":"' + JSON_Str(Q.FieldByName('CodigoCliente').AsString) + '", ' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '", ' +
      '"Unidades":' + SQL_FloatToStr(Q.FieldByName('unidades').AsFloat) + ', ' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '", ' +
      '"CajaId":' + Q.FieldByName('cajaId').AsString + ', ' +
      '"CajaRef":"' + JSON_Str(Q.FieldByName('cajaRef').AsString) + '", ' +
      '"PaletId":' + Q.FieldByName('cajaId').AsString + ', ' +
      '"PaletRef":"' + JSON_Str(Q.FieldByName('paletRef').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;

procedure WebModule1codigoArticuloAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoArticulo: string;
  CodigoUbicacion: string;
  EmpresaOrigen: Integer;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoArticulo := contentfields.values['CodigoArticulo'];

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );

  if CodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';

    Exit;
  end;

  CodigoUbicacion := contentfields.values['CodigoUbicacion'];

  // Conversió al codi d'article real
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación no especificado","Data":[]}';

    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM dbo.FS_SGA_TABLE_Almacenes ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
          'WHERE ' +
          '  ISNULL(VisiblePDA,1)<>0';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  CodigoEmpresa, CodigoAlmacen, Almacen, Domicilio, CodigoPostal, Municipio, Provincia ' +
          'FROM dbo.FS_SGA_TABLE_Almacenes ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
          'WHERE ' +
          '  ISNULL(VisiblePDA,1)<>0 ' +
          'ORDER BY ' +
          '  CodigoEmpresa, CodigoAlmacen ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      FreeAndNil(Q);
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', sIDCall, LOG_LEVEL_EXCEPTION );
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ', ' +
      '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
      '"Almacen":"' + JSON_Str(Q.FieldByName('Almacen').AsString) + '",' +
      '"Domicilio":"' + JSON_Str(Q.FieldByName('Domicilio').AsString) + '",' +
      '"CodigoPostal":"' + JSON_Str(Q.FieldByName('CodigoPostal').AsString) + '",' +
      '"Municipio":"' + JSON_Str(Q.FieldByName('Municipio').AsString) + '",' +
      '"Provincia":"' + JSON_Str(Q.FieldByName('Provincia').AsString) + '"' +
      '}';

    Q.Next;
  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


procedure WebModule1contenidoUbicacionInventarioAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q, Q2: TADOQuery;
  EmpresaOrigen: Integer;
  InventarioId: Integer;
  CodigoUbicacion: String;
  CodigoAlmacen: String;
  CodigoPasillo: String;
  CodigoEstanteria: String;
  Altura: String;
  Fondo: String;
  TipoUbicacion: String;
  Data, Articulos: String;
  Desglose: String;
  lJSonValue: TJSonValue;
  sMsg: String;
  bErr: Boolean;
  CodigoArticulo: String;
  Partida: String;
  UnidadMedida: String;
  UnidadesSaldo: Double;
  dFechaCaduca: TDate;
  FechaCaduca: String;
  CodigoUsuario: Integer;
  bAdded: Boolean;
  TipoUbicaciones: String;
  iNum: Integer;
  YY: Integer;
  iTotalRegs, iNumRegs: Integer;
  listArticulos: String;
  iPages: Integer;
  contentfields: TStringList;
  CodigoAlternativo: string;
  sFechaCaduca: string;
  JSonUnidadesMedida: String;
  sContenido: String;
  bVerificada: Boolean;
  dFechaValidacion: TDateTime;
  sFechaValidacion: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  InventarioId := StrToIntDef(contentfields.Values['InventarioId'], 0 );
  if InventarioId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de inventario no especificado","Data":[]}';
    Exit;
  end;

  sSQL := 'SELECT ' +
          '  Inventario_TipoUbicaciones ' +
          'FROM FS_SGA_Inventario WITH (NOLOCK) ' +
          'WHERE ' +
          '  Inventario_Id = ' + IntToStr(InventarioId);
  TipoUbicaciones := SQL_Execute ( Conn, sSQL );

  //gaLogFile.Write('Tipo ubicaciones = ' + TipoUbicaciones);

  // Tipus d'ubicació (TODAS,PENDIENTES,VERIFICADAS)
  CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);

  // Conversió al codi d'article real
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de ubicación incorrecto o no especificado","Data":[]}';
    Exit;
  end;

  // Verifiquem que la ubicació pertany a l'inventari
  if TipoUbicaciones<>'LIBRE' then begin

    sSQL := 'SELECT ' +
            '  COUNT(*) ' +
            'FROM FS_SGA_Inventario_Detalle WITH (NOLOCK) ' +
            'WHERE ' +
            '  Inventario_Id = ' + IntToStr(InventarioId) + ' AND ' +
            '  CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + ''' ';
    iNum := SQL_Execute ( Conn, sSQL );
    if iNum=0 then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La ubicación no está incluida en este inventario","Data":[]}';
      Exit;
    end;

  end;

  // Verifiquem que la ubicació pertany al magatzem
  FS_SGA_UBICACION_Desglosar ( Conn, CodigoEmpresa, CodigoUbicacion, CodigoAlmacen, CodigoPasillo, CodigoEstanteria, Altura, Fondo, CodigoAlternativo );
  sSQL := 'SELECT ' +
          '  Inventario_CodigoAlmacen ' +
          'FROM FS_SGA_Inventario WITH (NOLOCK) ' +
          'WHERE ' +
          '  Inventario_Id = ' + IntToStr(InventarioId);
  if CodigoAlmacen<>SQL_Execute(Conn,sSQL) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El almacén de la ubicación no está incluida en este inventario","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT TOP 1 ' +
          '  fsid.CodigoEmpresa, fsid.Inventario_Id, fsid.CodigoAlmacen, fsid.CodigoUbicacion, ' +
          '  fsid.Verificada, fsid.UsuarioId, MAX(fsid.FechaHoraValidacion) AS FechaHoraValidacion, ' +
          '  fstu.CodigoAlternativo ' +
          'FROM FS_SGA_Inventario_Detalle fsid WITH (NOLOCK) ' +
          'LEFT JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) fstu ' +
          'ON ' +
          '  fstu.CodigoUbicacion = fsid.CodigoUbicacion ' +
          'WHERE ' +
          '  fsid.Inventario_Id = ' + IntToStr(InventarioId) + ' AND ' +
          '  fstu.CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + ''' ' +
          'GROUP BY ' +
          '  fsid.CodigoEmpresa, fsid.Inventario_Id, fsid.CodigoAlmacen, fsid.CodigoUbicacion, ' +
          '  fsid.Verificada, fsid.UsuarioId,  fstu.CodigoAlternativo ' +
          'ORDER BY ' +
          '  fsid.CodigoUbicacion';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  Q2 := SQL_PrepareQuery ( Conn );

  iTotalRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","Data":[';
  iNumRegs := 0;

  bVerificada := FALSE;
  sFechaValidacion := '';
  if not Q.Eof then
  begin
    bVerificada := Q.FieldByName('Verificada').AsBoolean;
    dFechaValidacion := Q.FieldByName('FechaHoraValidacion').AsDateTime;
    sFechaValidacion := FormatDateTime('dd/mm/yyyy hh:nn:ss', dFechaValidacion);
  end;

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  sContenido := '[' + FS_SGA_ContenidoUbicacion ( Conn, CodigoEmpresa, YY, InventarioId, CodigoUbicacion ) + ']';

  Result := Result +
    '{' +
    '"CodigoEmpresa":' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ',' +
    '"Inventario_Id":' + IntToStr(InventarioId) + ',' +
    '"CodigoAlmacen":"' + JSON_Str(CodigoAlmacen) + '",' +
    '"CodigoUbicacion":"' + JSON_Str(CodigoUbicacion) + '",' +
    '"CodigoUbicacionAlternativo":"' + JSON_Str(CodigoAlternativo) + '",' +
    '"Verificada":' + SQL_BooleanToStr (bVerificada) + ',' +
    '"UsuarioId":' + IntToStr(CodigoUsuario) + ',' +
    '"FechaHoraValidacion":"' + sFechaValidacion + '",' +
    '"Articulos":' + sContenido + '' +
    '}';

  Result := Result + ']}';

  Q2.Close;
  FreeAndNil(Q2);

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;

procedure WebModule1dashboardAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  EmpresaOrigen: Integer;
  iArticulosCaducados: Integer;
  iArticulosTotal: Integer;
  fPorcentajeCaducados: Double;
  CodigoAlmacen: String;
  iUbicacionesTotales: Integer;
  iUbicacionesVacias: Integer;
  fPorcentajeVacias: Double;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoAlmacen := (contentfields.Values['CodigoAlmacen']);
  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  {$REGION '-- Caducidades'}
  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM dbo.fS_SGA_TABLE_AcumuladoStock ( ' + IntToStr(CodigoEmpresa.Stocks) + ' ) ' +
          'WHERE ' +
          '  FechaCaduca < GETDATE() ' +
          '  AND CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + '''';
  iArticulosCaducados := SQL_Execute ( Conn, sSQL );

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM dbo.fS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) ';
  iArticulosTotal := SQL_Execute ( Conn, sSQL );

  if iArticulosTotal=0 then
    fPorcentajeCaducados := 0
  else
    fPorcentajeCaducados := Round(10*(iArticulosCaducados/iArticulosTotal)*100) / 10;
  {$ENDREGION}

  {$REGION '-- Ubicaciones'}
  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM dbo.FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) ';
  if CodigoAlmacen<>'' then
    sSQL := sSQL + 'WHERE CodigoAlmacen=''' + SQL_Str(CodigoAlmacen) + ''' ';
  iUbicacionesTotales := SQL_Execute ( Conn, sSQL );

  sSQL := 'SELECT ' +
          '  COUNT(fstu.CodigoUbicacion) ' +
          'FROM dbo.FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) fstu ' +
          'INNER JOIN dbo.FS_SGA_TABLE_AcumuladoStock ( ' + IntToStr(CodigoEmpresa.Stocks) + ' ) fstas ' +
          'ON ' +
          '  fstu.CodigoAlmacen = fstas.CodigoAlmacen AND ' +
          '  fstu.CodigoUbicacion = fstas.CodigoUbicacion ';
  if CodigoAlmacen<>'' then
    sSQL := sSQL + 'WHERE fstu.CodigoAlmacen=''' + SQL_Str(CodigoAlmacen) + ''' ';

  iUbicacionesVacias := iUbicacionesTotales - SQL_Execute ( Conn, sSQL );

  if iUbicacionesTotales=0 then
    fPorcentajeVacias := 0
  else
    fPorcentajeVacias := Round(10*(iUbicacionesVacias/iUbicacionesTotales)*100) / 10;
  {$ENDREGION}

  {$REGION '-- Reubicaciones'}
  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM dbo.FS_SGA_TABLE_Movimientos ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
          'WHERE ' +
          '  Fecha = ' + SQL_DateToStr ( Date() ) + ' ';

  if CodigoAlmacen<>'' then
    sSQL := sSQL + 'WHERE CodigoAlmacen=''' + SQL_Str(CodigoAlmacen) + ''' ';
  iUbicacionesTotales := SQL_Execute ( Conn, sSQL );

  sSQL := 'SELECT ' +
          '  COUNT(fstu.CodigoUbicacion) ' +
          'FROM dbo.FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) fstu ' +
          'INNER JOIN dbo.FS_SGA_TABLE_AcumuladoStock ( ' + IntToStr(CodigoEmpresa.Stocks) + ' ) fstas ' +
          'ON ' +
          '  fstu.CodigoAlmacen = fstas.CodigoAlmacen AND ' +
          '  fstu.CodigoUbicacion = fstas.CodigoUbicacion ';
  if CodigoAlmacen<>'' then
    sSQL := sSQL + 'WHERE fstu.CodigoAlmacen=''' + SQL_Str(CodigoAlmacen) + ''' ';

  iUbicacionesVacias := iUbicacionesTotales - SQL_Execute ( Conn, sSQL );

  if iUbicacionesTotales=0 then
    fPorcentajeVacias := 0
  else
    fPorcentajeVacias := Round(10*(iUbicacionesVacias/iUbicacionesTotales)*100) / 10;
  {$ENDREGION}

  Result := '{"Result":"OK","Error":"","Data":{';
  Result := Result + '' +
    '"Caducidades":{' +
      '"TotalArticulos":' + IntToStr(iArticulosTotal) + ', ' +
      '"TotalCaducados":' + IntToStr(iArticulosCaducados) + ', ' +
      '"Porcentaje":' + SQL_FloatToStr(fPorcentajeCaducados) +
    '}' +
    '"UbicacionesVacias":{' +
      '"UbicacionesTotales":' + IntToStr(iUbicacionesTotales) + ', ' +
      '"UbicacionesVacias":' + IntToStr(iUbicacionesVacias) + ', ' +
      '"Porcentaje":' + SQL_FloatToStr(fPorcentajeVacias) +
    '}' +
  '}';

  Result := Result + '}';

  {$ENDREGION}




end;

procedure WebModule1DefaultHandlerAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
begin

  Result := '{"Result":"OK","Error":"","Data":"SGA - Servidor web v0.1"}';

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ DETALLS D'UNA PREPARACIÓ                                              │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1desgloseRecepcionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  RecepcionId: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoArticulo: string;
  CodigoUbicacion: string;
  sDesglose: string;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoUsuario: Integer;
  CodigoUbicacionRecepcion: String;
  CodigoUbicacionRechazos: String;
  RecepcionIdLinea: Integer;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  RecepcionId := StrToIntDef(contentfields.values['RecepcionId'],0);
  if RecepcionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de recepción no especificado","Data":[]}';

    Exit;
  end;

  RecepcionIdLinea := StrToIntDef(contentfields.values['RecepcionIdLinea'],0);
  CodigoArticulo   := (contentfields.values['CodigoArticulo']);
  CodigoUsuario    := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionRecepcion,         CodigoUbicacionRecepcion, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionRecepcionRechazos, CodigoUbicacionRechazos, CodigoEmpresa.EmpresaOrigen );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_Recepciones_Lineas_Detalle fsrld WITH (NOLOCK) ' +
          'INNER JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) stu ' +
          'ON ' +
          '  stu.CodigoUbicacion = fsrld.CodigoUbicacion ' +
          'LEFT JOIN FS_SGA_TABLE_Incidencias ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ''R'' ) fsi ' +
          'ON ' +
          '  fsi.IdIncidencia = fsrld.AnomaliaId ' +
          'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
          'ON ' +
          '  art.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          'WHERE ' +
          '  fsrld.RecepcionIdLinea = ' + IntToStr(RecepcionIdLinea) + ' AND ' +
          '  fsrld.RecepcionId = ' + IntToStr(RecepcionId);

  (*
  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', sIDCall, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;
  *)

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', sIDCall, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT ' +
    '  fsrld.*, agrup.Agrupacion, agrupR.Agrupacion AS AgrupacionRechazos, stu.CodigoAlternativo AS CodigoUbicacionAlternativo, stur.CodigoAlternativo AS CodigoUbicacionRechazosAlternativo, ' +
    '  fsi.NombreIncidencia, fsrld.Unidades * art.PesoBrutoUnitario_ as PesoBruto, art.TratamientoPartidas, art.TrataNumerosSerieLc, ' +
    '  fsrld.Unidades * art.PesoNetoUnitario_ as PesoNeto, fsrld.Unidades * art.VolumenUnitario_ as Volumen ' +
    'FROM FS_SGA_Recepciones_Lineas_Detalle fsrld WITH (NOLOCK) ' +
    'INNER JOIN FS_SGA_Recepciones_Lineas fsrl WITH (NOLOCK) ' +
    'ON ' +
    '  fsrl.RecepcionId = fsrld.RecepcionId ' +
    '  AND fsrl.RecepcionIdLinea = fsrld.RecepcionIdLinea ' +
    'LEFT JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) stu ' +
    'ON ' +
    '  stu.CodigoUbicacion = fsrld.CodigoUbicacion ' +
    'LEFT JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) stur ' +
    'ON ' +
    '  stur.CodigoUbicacion = fsrld.CodigoUbicacionRechazos ' +
    'LEFT JOIN FS_SGA_TABLE_Incidencias ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ''R'' ) fsi ' +
    'ON ' +
    '  fsi.IdIncidencia = fsrld.AnomaliaId ' +
    'LEFT JOIN Agrupaciones agrup WITH (NOLOCK) ' +
    'ON ' +
    '  agrup.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
    '  AND agrup.CodigoArticulo = fsrl.CodigoArticulo ' +
    '  AND agrup.UnidadMedida1_ = fsrld.UnidadMedida1_ ' +
    '  AND agrup.CodigoAgrupacion = fsrld.CodigoAgrupacion ' +
    'LEFT JOIN Agrupaciones agrupR WITH (NOLOCK) ' +
    'ON ' +
    '  agrupR.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
    '  AND agrupR.CodigoArticulo = fsrl.CodigoArticulo ' +
    '  AND agrupR.UnidadMedida1_ = fsrld.UnidadMedida1_ ' +
    '  AND agrupR.CodigoAgrupacion = fsrld.CodigoAgrupacionRechazos ' +
    'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
    'ON ' +
    '  art.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
    'WHERE ' +
    '  fsrld.RecepcionIdLinea = ' + IntToStr(RecepcionIdLinea) + ' AND ' +
    '  fsrld.RecepcionId = ' + IntToStr(RecepcionId) +
    'ORDER BY ' +
    '  fsrld.RecepcionIdLineaDetalle';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', sIDCall, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"RecepcionId":' + IntToStr(Q.FieldByName('RecepcionId').AsInteger) + ',' +
      '"RecepcionIdLinea":' + IntToStr(Q.FieldByName('RecepcionIdLinea').AsInteger) + ',' +
      '"RecepcionIdLineaDetalle":' + IntToStr(Q.FieldByName('RecepcionIdLineaDetalle').AsInteger) + ',' +
      '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
      '"CodigoUbicacion":"' + JSON_Str(Q.FieldByName('CodigoUbicacion').AsString) + '",' +
      '"CodigoUbicacionAlternativo":"' + JSON_Str(Q.FieldByName('CodigoUbicacionAlternativo').AsString) + '",' +
      '"Matricula":"' + JSON_Str(Q.FieldByName('Matricula').AsString) + '",' +
      '"CodigoAlmacenRechazos":"' + JSON_Str(Q.FieldByName('CodigoAlmacenRechazos').AsString) + '",' +
      '"CodigoUbicacionRechazos":"' + JSON_Str(Q.FieldByName('CodigoUbicacionRechazos').AsString) + '",' +
      '"CodigoUbicacionRechazosAlternativo":"' + JSON_Str(Q.FieldByName('CodigoUbicacionRechazosAlternativo').AsString) + '",' +
      '"MatriculaRechazos":"' + JSON_Str(Q.FieldByName('MatriculaRechazos').AsString) + '",' +
      '"Caja":"' + JSON_Str(Q.FieldByName('Caja').AsString) + '",' +
      '"Palet":"' + JSON_Str(Q.FieldByName('Palet').AsString) + '",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"PartidaProveedor":"' + JSON_Str(Q.FieldByName('PartidaProveedor').AsString) + '",' +
      '"FechaCaduca":"' + Q.FieldByName('FechaCaducidad').AsString + '",' +
      '"Verificacion":"' + JSON_Str(Q.FieldByName('Verificacion').AsString) + '",' +
      '"IdIncidencia":' + IntToStr(Q.FieldByName('AnomaliaId').AsInteger) + ',' +
      '"NombreIncidencia":"' + JSON_Str(Q.FieldByName('NombreIncidencia').AsString) + '",' +
      '"Precio":' + SQL_FloatToStr(Q.FieldByName('Precio').AsFloat) + ',' +
      '"UnidadesEntrada":' + SQL_FloatToStr(Q.FieldByName('UnidadesEntrada').AsFloat) + ',' +
      '"UnidadesEntradaBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesEntradaBase').AsFloat) + ',' +
      '"TratamientoPartidas":' + SQL_BooleanToStr(Q.FieldByName('TratamientoPartidas').AsInteger<>0) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString)) + '",' +
      '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '",' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion').AsFloat) + ',' +
      '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
      '"Agrupacion":"' + SQL_Str(Q.FieldByName('Agrupacion').AsString) + '",' +
      '"UnidadesAgrupacion":' + SQL_FloatToStr(Q.FieldByName('UnidadesAgrupacion').AsFloat) + ',' +
      '"UnidadesRechazo":' + SQL_FloatToStr(Q.FieldByName('CantidadErrorEntrada').AsFloat) + ',' +
      '"UnidadesRechazoBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesErrorBase').AsFloat) + ',' +
      '"UnidadMedidaRechazo":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaRechazo').AsString)) + '",' +
      '"UnidadMedidaRechazoBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaRechazoBase').AsString)) + '",' +
      '"FactorConversionRechazo":' + SQL_FloatToStr(Q.FieldByName('FactorConversionRechazos').AsFloat) + ',' +
      '"CodigoAgrupacionRechazo":' + IntToStr(Q.FieldByName('CodigoAgrupacionRechazos').AsInteger) + ',' +
      '"AgrupacionRechazos":"' + SQL_Str(Q.FieldByName('AgrupacionRechazos').AsString) + '",' +
      '"UnidadesAgrupacionRechazo":' + SQL_FloatToStr(Q.FieldByName('UnidadesAgrupacionRechazos').AsFloat) + '' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ DETALLS D'UNA DEVOLUCIÓ                                               │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1desgloseDevolucionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  DevolucionId: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoArticulo: string;
  CodigoUbicacion: string;
  sDesglose: string;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoUsuario: Integer;
  CodigoUbicacionDevolucion: String;
  CodigoUbicacionDevolucionRechazos: String;
  DevolucionIdLinea: Integer;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  DevolucionId := StrToIntDef(contentfields.values['DevolucionId'],0);
  if DevolucionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no especificado","Data":[]}';

    Exit;
  end;

  DevolucionIdLinea := StrToIntDef(contentfields.values['DevolucionIdLinea'],0);
  CodigoArticulo    := (contentfields.values['CodigoArticulo']);
  CodigoUsuario     := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucion,         CodigoUbicacionDevolucion, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucionRechazos, CodigoUbicacionDevolucionRechazos, CodigoEmpresa.EmpresaOrigen );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_Devoluciones_Lineas_Detalle fsdld WITH (NOLOCK) ' +
          'INNER JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) stu ' +
          'ON ' +
          '  stu.CodigoUbicacion = fsdld.CodigoUbicacion ' +
          'LEFT JOIN FS_SGA_TABLE_Incidencias ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ''R'' ) fsi ' +
          'ON ' +
          '  fsi.IdIncidencia = fsdld.AnomaliaId ' +
          'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
          'ON ' +
          '  art.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          'WHERE ' +
          '  fsdld.DevolucionIdLinea = ' + IntToStr(DevolucionIdLinea) + ' AND ' +
          '  fsdld.DevolucionId = ' + IntToStr(DevolucionId);

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', sIDCall, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT ' +
    '  fsdld.*, agrup.Agrupacion, agrupR.Agrupacion AS AgrupacionRechazos, stu.CodigoAlternativo AS CodigoUbicacionAlternativo, stur.CodigoAlternativo AS CodigoUbicacionRechazosAlternativo, ' +
    '  fsi.NombreIncidencia, fsdld.Unidades * art.PesoBrutoUnitario_ as PesoBruto, ' +
    '  fsdld.Unidades * art.PesoNetoUnitario_ as PesoNeto, fsdld.Unidades * art.VolumenUnitario_ as Volumen ' +
    'FROM FS_SGA_Devoluciones_Lineas_Detalle fsdld WITH (NOLOCK) ' +
    'INNER JOIN FS_SGA_Devoluciones_Lineas fsdl WITH (NOLOCK) ' +
    'ON ' +
    '  fsdl.DevolucionId = fsdld.DevolucionId ' +
    '  AND fsdl.DevolucionIdLinea = fsdld.DevolucionIdLinea ' +
    'LEFT JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) stu ' +
    'ON ' +
    '  stu.CodigoUbicacion = fsdld.CodigoUbicacion ' +
    'LEFT JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) stur ' +
    'ON ' +
    '  stur.CodigoUbicacion = fsdld.CodigoUbicacionRechazos ' +
    'LEFT JOIN FS_SGA_TABLE_Incidencias ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ''R'' ) fsi ' +
    'ON ' +
    '  fsi.IdIncidencia = fsdld.AnomaliaId ' +
    'LEFT JOIN Agrupaciones agrup WITH (NOLOCK) ' +
    'ON ' +
    '  agrup.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
    '  AND agrup.CodigoArticulo = fsdl.CodigoArticulo ' +
    '  AND agrup.UnidadMedida1_ = fsdld.UnidadMedida1_ ' +
    '  AND agrup.CodigoAgrupacion = fsdld.CodigoAgrupacion ' +
    'LEFT JOIN Agrupaciones agrupR WITH (NOLOCK) ' +
    'ON ' +
    '  agrupR.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
    '  AND agrupR.CodigoArticulo = fsdl.CodigoArticulo ' +
    '  AND agrupR.UnidadMedida1_ = fsdld.UnidadMedida1_ ' +
    '  AND agrupR.CodigoAgrupacion = fsdld.CodigoAgrupacionRechazos ' +
    'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
    'ON ' +
    '  art.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
    'WHERE ' +
    '  fsdld.DevolucionIdLinea = ' + IntToStr(DevolucionIdLinea) + ' AND ' +
    '  fsdld.DevolucionId = ' + IntToStr(DevolucionId) +
    'ORDER BY ' +
    '  fsdld.DevolucionIdLineaDetalle';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', sIDCall, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"DevolucionId":' + IntToStr(Q.FieldByName('DevolucionId').AsInteger) + ',' +
      '"DevolucionIdLinea":' + IntToStr(Q.FieldByName('DevolucionIdLinea').AsInteger) + ',' +
      '"DevolucionIdLineaDetalle":' + IntToStr(Q.FieldByName('DevolucionIdLineaDetalle').AsInteger) + ',' +
      '"CodigoAlmacen":"' + Q.FieldByName('CodigoAlmacen').AsString + '",' +
      '"CodigoUbicacion":"' + Q.FieldByName('CodigoUbicacion').AsString + '",' +
      '"CodigoUbicacionAlternativo":"' + Q.FieldByName('CodigoUbicacionAlternativo').AsString + '",' +
      '"CodigoAlmacenRechazos":"' + Q.FieldByName('CodigoAlmacenRechazos').AsString + '",' +
      '"CodigoUbicacionRechazos":"' + Q.FieldByName('CodigoUbicacionRechazos').AsString + '",' +
      '"CodigoUbicacionRechazosAlternativo":"' + Q.FieldByName('CodigoUbicacionRechazosAlternativo').AsString + '",' +
      '"Caja":' + IntToStr(Q.FieldByName('Caja').AsInteger) + ',' +
      '"Palet":' + IntToStr(Q.FieldByName('Palet').AsInteger) + ',' +
      '"Matricula":"' + JSON_Str(Q.FieldByName('Matricula').AsString) + '",' +
      '"MatriculaRechazos":"' + JSON_Str(Q.FieldByName('MatriculaRechazos').AsString) + '",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"FechaCaduca":"' + Q.FieldByName('FechaCaducidad').AsString + '",' +
      '"Verificacion":"' + JSON_Str(Q.FieldByName('Verificacion').AsString) + '",' +
      '"IdIncidencia":' + IntToStr(Q.FieldByName('AnomaliaId').AsInteger) + ',' +
      '"NombreIncidencia":"' + JSON_Str(Q.FieldByName('NombreIncidencia').AsString) + '",' +
      '"Precio":' + SQL_FloatToStr(Q.FieldByName('Precio').AsFloat) + ',' +
      '"UnidadesEntrada":' + SQL_FloatToStr(abs(Q.FieldByName('UnidadesEntrada').AsFloat)) + ',' +
      '"UnidadesEntradaBase":' + SQL_FloatToStr(abs(Q.FieldByName('UnidadesEntradaBase').AsFloat)) + ',' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString)) + '",' +
      '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '",' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion').AsFloat) + ',' +
      '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
      '"Agrupacion":"' + SQL_Str(Q.FieldByName('Agrupacion').AsString) + '",' +
      '"UnidadesAgrupacion":' + SQL_FloatToStr(Q.FieldByName('UnidadesAgrupacion').AsFloat) + ',' +
      '"UnidadesRechazo":' + SQL_FloatToStr(abs(Q.FieldByName('CantidadErrorEntrada').AsFloat)) + ',' +
      '"UnidadesRechazoBase":' + SQL_FloatToStr(abs(Q.FieldByName('UnidadesErrorBase').AsFloat)) + ',' +
      '"UnidadMedidaRechazo":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaRechazo').AsString)) + '",' +
      '"UnidadMedidaRechazoBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaRechazoBase').AsString)) + '",' +
      '"FactorConversionRechazo":' + SQL_FloatToStr(Q.FieldByName('FactorConversionRechazos').AsFloat) + ',' +
      '"CodigoAgrupacionRechazo":' + IntToStr(Q.FieldByName('CodigoAgrupacionRechazos').AsInteger) + ',' +
      '"AgrupacionRechazos":"' + SQL_Str(Q.FieldByName('AgrupacionRechazos').AsString) + '",' +
      '"UnidadesAgrupacionRechazo":' + SQL_FloatToStr(Q.FieldByName('UnidadesAgrupacionRechazos').AsFloat) + '' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ DETALLS D'UNA DEVOLUCIÓ DE PROVEÏDOR                                  │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1desgloseDevolucionProvAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  DevolucionId: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoArticulo: string;
  CodigoUbicacion: string;
  sDesglose: string;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoUsuario: Integer;
  CodigoUbicacionDevolucionProv: String;
  CodigoUbicacionDevolucionProvRechazos: String;
  DevolucionIdLinea: Integer;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  DevolucionId := StrToIntDef(contentfields.values['DevolucionId'],0);
  if DevolucionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no especificado","Data":[]}';

    Exit;
  end;

  DevolucionIdLinea := StrToIntDef(contentfields.values['DevolucionIdLinea'],0);
  CodigoArticulo    := (contentfields.values['CodigoArticulo']);
  CodigoUsuario     := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucion,         CodigoUbicacionDevolucionProv, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucionRechazos, CodigoUbicacionDevolucionProvRechazos, CodigoEmpresa.EmpresaOrigen );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_DevolucionesP_Lineas_Detalle fsdld WITH (NOLOCK) ' +
          'INNER JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) stu ' +
          'ON ' +
          '  stu.CodigoUbicacion = fsdld.CodigoUbicacion ' +
          'LEFT JOIN FS_SGA_TABLE_Incidencias ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ''R'' ) fsi ' +
          'ON ' +
          '  fsi.IdIncidencia = fsdld.AnomaliaId ' +
          'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
          'ON ' +
          '  art.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          'WHERE ' +
          '  fsdld.DevolucionIdLinea = ' + IntToStr(DevolucionIdLinea) + ' AND ' +
          '  fsdld.DevolucionId = ' + IntToStr(DevolucionId);

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', sIDCall, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT ' +
    '  fsdld.*, agrup.Agrupacion, agrupR.Agrupacion AS AgrupacionRechazos, stu.CodigoAlternativo AS CodigoUbicacionAlternativo, stur.CodigoAlternativo AS CodigoUbicacionRechazosAlternativo, ' +
    '  fsi.NombreIncidencia, fsdld.Unidades * art.PesoBrutoUnitario_ as PesoBruto, ' +
    '  fsdld.Unidades * art.PesoNetoUnitario_ as PesoNeto, fsdld.Unidades * art.VolumenUnitario_ as Volumen ' +
    'FROM FS_SGA_DevolucionesP_Lineas_Detalle fsdld WITH (NOLOCK) ' +
    'INNER JOIN FS_SGA_DevolucionesP_Lineas fsdl WITH (NOLOCK) ' +
    'ON ' +
    '  fsdl.DevolucionId = fsdld.DevolucionId ' +
    '  AND fsdl.DevolucionIdLinea = fsdld.DevolucionIdLinea ' +
    'LEFT JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) stu ' +
    'ON ' +
    '  stu.CodigoUbicacion = fsdld.CodigoUbicacion ' +
    'LEFT JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) stur ' +
    'ON ' +
    '  stur.CodigoUbicacion = fsdld.CodigoUbicacionRechazos ' +
    'LEFT JOIN FS_SGA_TABLE_Incidencias ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ''R'' ) fsi ' +
    'ON ' +
    '  fsi.IdIncidencia = fsdld.AnomaliaId ' +
    'LEFT JOIN Agrupaciones agrup WITH (NOLOCK) ' +
    'ON ' +
    '  agrup.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
    '  AND agrup.CodigoArticulo = fsdl.CodigoArticulo ' +
    '  AND agrup.UnidadMedida1_ = fsdld.UnidadMedida1_ ' +
    '  AND agrup.CodigoAgrupacion = fsdld.CodigoAgrupacion ' +
    'LEFT JOIN Agrupaciones agrupR WITH (NOLOCK) ' +
    'ON ' +
    '  agrupR.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
    '  AND agrupR.CodigoArticulo = fsdl.CodigoArticulo ' +
    '  AND agrupR.UnidadMedida1_ = fsdld.UnidadMedida1_ ' +
    '  AND agrupR.CodigoAgrupacion = fsdld.CodigoAgrupacionRechazos ' +
    'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
    'ON ' +
    '  art.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
    'WHERE ' +
    '  fsdld.DevolucionIdLinea = ' + IntToStr(DevolucionIdLinea) + ' AND ' +
    '  fsdld.DevolucionId = ' + IntToStr(DevolucionId) +
    'ORDER BY ' +
    '  fsdld.DevolucionIdLineaDetalle';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', sIDCall, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"DevolucionId":' + IntToStr(Q.FieldByName('DevolucionId').AsInteger) + ',' +
      '"DevolucionIdLinea":' + IntToStr(Q.FieldByName('DevolucionIdLinea').AsInteger) + ',' +
      '"DevolucionIdLineaDetalle":' + IntToStr(Q.FieldByName('DevolucionIdLineaDetalle').AsInteger) + ',' +
      '"CodigoAlmacen":"' + Q.FieldByName('CodigoAlmacen').AsString + '",' +
      '"CodigoUbicacion":"' + Q.FieldByName('CodigoUbicacion').AsString + '",' +
      '"CodigoUbicacionAlternativo":"' + Q.FieldByName('CodigoUbicacionAlternativo').AsString + '",' +
      '"CodigoAlmacenRechazos":"' + Q.FieldByName('CodigoAlmacenRechazos').AsString + '",' +
      '"CodigoUbicacionRechazos":"' + Q.FieldByName('CodigoUbicacionRechazos').AsString + '",' +
      '"CodigoUbicacionRechazosAlternativo":"' + Q.FieldByName('CodigoUbicacionRechazosAlternativo').AsString + '",' +
      '"Caja":' + IntToStr(Q.FieldByName('Caja').AsInteger) + ',' +
      '"Palet":' + IntToStr(Q.FieldByName('Palet').AsInteger) + ',' +
      '"Matricula":"' + JSON_Str(Q.FieldByName('Matricula').AsString) + '",' +
      '"MatriculaRechazos":"' + JSON_Str(Q.FieldByName('MatriculaRechazos').AsString) + '",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"FechaCaduca":"' + Q.FieldByName('FechaCaducidad').AsString + '",' +
      '"Verificacion":"' + JSON_Str(Q.FieldByName('Verificacion').AsString) + '",' +
      '"IdIncidencia":' + IntToStr(Q.FieldByName('AnomaliaId').AsInteger) + ',' +
      '"NombreIncidencia":"' + JSON_Str(Q.FieldByName('NombreIncidencia').AsString) + '",' +
      '"Precio":' + SQL_FloatToStr(Q.FieldByName('Precio').AsFloat) + ',' +
      '"UnidadesEntrada":' + SQL_FloatToStr(abs(Q.FieldByName('UnidadesEntrada').AsFloat)) + ',' +
      '"UnidadesEntradaBase":' + SQL_FloatToStr(abs(Q.FieldByName('UnidadesEntradaBase').AsFloat)) + ',' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString)) + '",' +
      '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '",' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion').AsFloat) + ',' +
      '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
      '"Agrupacion":"' + SQL_Str(Q.FieldByName('Agrupacion').AsString) + '",' +
      '"UnidadesAgrupacion":' + SQL_FloatToStr(Q.FieldByName('UnidadesAgrupacion').AsFloat) + ',' +
      '"UnidadesRechazo":' + SQL_FloatToStr(abs(Q.FieldByName('CantidadErrorEntrada').AsFloat)) + ',' +
      '"UnidadesRechazoBase":' + SQL_FloatToStr(abs(Q.FieldByName('UnidadesErrorBase').AsFloat)) + ',' +
      '"UnidadMedidaRechazo":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaRechazo').AsString)) + '",' +
      '"UnidadMedidaRechazoBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaRechazoBase').AsString)) + '",' +
      '"FactorConversionRechazo":' + SQL_FloatToStr(Q.FieldByName('FactorConversionRechazos').AsFloat) + ',' +
      '"CodigoAgrupacionRechazo":' + IntToStr(Q.FieldByName('CodigoAgrupacionRechazos').AsInteger) + ',' +
      '"AgrupacionRechazos":"' + SQL_Str(Q.FieldByName('AgrupacionRechazos').AsString) + '",' +
      '"UnidadesAgrupacionRechazo":' + SQL_FloatToStr(Q.FieldByName('UnidadesAgrupacionRechazos').AsFloat) + '' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


procedure WebModule1detalleDevolucionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  DevolucionId: Integer;
  sSQL: String;
  Q, Q2: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoArticulo: string;
  CodigoUbicacion: string;
  sDesglose: string;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoUsuario: Integer;
  CodigoUbicacionDevolucion: String;
  CodigoUbicacionDevolucionRechazos: String;

  contentfields: TStringList;
  Pending: Boolean;
  Linea: Integer;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  DevolucionId := StrToIntDef(contentfields.values['DevolucionId'],0);
  if DevolucionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no especificado","Data":[]}';
    Exit;
  end;

  Pending := (StrToIntDef(contentfields.Values['Pendientes'],0)<>0);
  Linea   := StrToIntDef(contentfields.values['Linea'],0);

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  OrdenarPor    := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden     := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy      := '';

  if OrdenarPor='PEDIDO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsdl.EjercicioPedido DESC, fsdl.SeriePedido DESC, fsdl.NumeroPedido DESC, fsdl.OrdenLineaPedido ';
    end else begin
      sOrderBy := 'fsdl.EjercicioPedido, fsdl.SeriePedido, fsdl.NumeroPedido, fsdl.OrdenLineaPedido ';
    end;
  end else if OrdenarPor='ESTADO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsdl.UdSaldo DESC ';
    end else begin
      sOrderBy := 'fsdl.UdSaldo ';
    end;
  end else if OrdenarPor='ARTICULO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsdl.CodigoArticulo DESC, fsdl.Partida DESC ';
    end else begin
      sOrderBy := 'fsdl.CodigoArticulo, fsdl.Partida ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsdl.DevolucionIdLinea DESC ';
    end else begin
      sOrderBy := 'fsdl.DevolucionIdLinea ';
    end;
  end;

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucion,         CodigoUbicacionDevolucion, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucionRechazos, CodigoUbicacionDevolucionRechazos, CodigoEmpresa.EmpresaOrigen );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_Devoluciones_Lineas WITH (NOLOCK) ' +
          'WHERE ' +
          '  DevolucionId = ' + IntToStr(DevolucionId);

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'ART', '' );

  sSQL :=
    'SELECT ' +
    '  fsdl.*, T.DescripcionTalla01_ as DescripcionTalla, C.Color_ AS DescripcionColor, ' +
    '  art.GrupoTalla_, art.Colores_, art.TratamientoPartidas, art.CodigoAlternativo, art.CodigoAlternativo2, ' +
    '  CTC.CodigoAlternativo AS CodigoAlternativoTC, art.Descripcion2Articulo, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc, ' +
    '  ISNULL(agrup.DescripcionArticulo,''Unidades'') AS Agrupacion ' +
    'FROM FS_SGA_Devoluciones_Lineas fsdl WITH (NOLOCK) ' +
    'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
    'ON ' +
    '  fsdl.CodigoArticulo = art.CodigoArticulo ' +
    'INNER JOIN LineasPedidoCliente LPC WITH (NOLOCK) ' +
    'ON ' +
    '  fsdl.CodigoEmpresa = LPC.CodigoEmpresa ' +
    '  AND fsdl.EjercicioPedido = LPC.EjercicioPedido ' +
    '  AND fsdl.SeriePedido = LPC.SeriePedido ' +
    '  AND fsdl.NumeroPedido = LPC.NumeroPedido ' +
    '  AND fsdl.OrdenLineaPedido = LPC.Orden ' +
    '  AND fsdl.LineasPosicion = LPC.LineasPosicion ' +
    'INNER JOIN CabeceraPedidoCliente CPC WITH (NOLOCK) ' +
    'ON ' +
    '  CPC.CodigoEmpresa = LPC.CodigoEmpresa ' +
    '  AND CPC.EjercicioPedido = LPC.EjercicioPedido ' +
    '  AND CPC.SeriePedido = LPC.SeriePedido ' +
    '  AND CPC.NUmeroPedido = LPC.NumeroPedido ' +
    'LEFT JOIN Agrupaciones agrup WITH (NOLOCK) ' +
    'ON ' +
    '  agrup.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
    '  AND agrup.CodigoArticulo = fsdl.CodigoArticulo ' +
    '  AND agrup.CodigoAgrupacion = fsdl.CodigoAgrupacion ' +
    'LEFT JOIN Colores_ C WITH (NOLOCK) ' +
    'ON ' +
    '  C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
    '  AND C.CodigoColor_ = fsdl.CodigoColor_ ' +
    'LEFT JOIN Vis_VistaTallas T WITH (NOLOCK) ' +
    'ON ' +
    '  T.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
    '  AND T.GrupoTalla_= art.GrupoTalla_ ' +
    '  AND T.CodigoTalla01_ = fsdl.CodigoTalla01_ ' +
    'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
    'ON ' +
    '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
    '  AND CTC.CodigoArticulo = fsdl.CodigoArticulo ' +
    '  AND CTC.CodigoTalla01_ = fsdl.CodigoTalla01_ ' +
    '  AND CTC.CodigoColor_ = fsdl.CodigoColor_ ' +
    'WHERE ' +
    '  fsdl.DevolucionId = ' + IntToStr(DevolucionId) + ' ' +
    '  AND CPC.Estado = 0 ' +
    '  AND LPC.Estado = 0 ';

  if Linea<>0 then
  begin
    sSQL := sSQL +
      'AND fsdl.DevolucionIdLinea = ' + IntToStr(Linea) + ' ';
  end;

  sSQL := sSQL +
    'ORDER BY ' +
    sOrderBy +
    'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
    'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', sIDCall, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  //Q2 := SQL_PrepareQuery ( Conn );

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    (*
    sSQL := 'SELECT ' +
            '  fsdld.*, stu.CodigoAlternativo AS CodigoUbicacionAlternativo, fsi.NombreIncidencia, fsdld.Unidades * art.PesoBrutoUnitario_ as PesoBruto, ' +
            '   fsdld.Unidades * art.PesoNetoUnitario_ as PesoNeto, fsdld.Unidades * art.VolumenUnitario_ as Volumen ' +
            'FROM FS_SGA_Devoluciones_Lineas_Detalle fsdld WITH (NOLOCK) ' +
            'INNER JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) stu ' +
            'ON ' +
            '  stu.CodigoUbicacion = fsdld.CodigoUbicacion ' +
            'LEFT JOIN FS_SGA_TABLE_Incidencias ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ''R'' ) fsi ' +
            'ON ' +
            '  fsi.IdIncidencia = fsdld.AnomaliaId ' +
            'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
            'ON ' +
            '  art.CodigoArticulo = ''' + SQL_Str(Q.FieldByName('CodigoArticulo').AsString) + ''' ' +
            'WHERE ' +
            '  fsdld.DevolucionIdLinea = ' + IntToStr(Q.FieldByName('DevolucionIdLinea').AsInteger) + ' AND ' +
            '  fsdld.DevolucionId = ' + IntToStr(DevolucionId) +
            'ORDER BY ' +
            '  fsdld.DevolucionIdLineaDetalle';

    Q2.Close;
    Q2.SQL.Text := sSQL;
    try
      Q2.Open;
    except
      on E:Exception do begin
        gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', CONST_LOGID_SGA, LOG_LEVEL_EXCEPTION );
        Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
        FreeAndNil(Q);
        FreeAndNil(Q2);
        Exit;
      end;
    end;

    sDesglose := '';

    while not Q2.EOF do begin

      if sDesglose<>'' then
        sDesglose := sDesglose + ',';

      sDesglose := sDesglose + '{' +
                               '"DevolucionId":"' + Q2.FieldByName('DevolucionId').AsString + '",' +
                               '"DevolucionIdLinea":"' + Q2.FieldByName('DevolucionIdLinea').AsString + '",' +
                               '"DevolucionIdLineaDetalle":"' + Q2.FieldByName('DevolucionIdLineaDetalle').AsString + '",' +
                               '"CodigoAlmacen":"' + Q2.FieldByName('CodigoAlmacen').AsString + '",' +
                               '"CodigoUbicacion":"' + Q2.FieldByName('CodigoUbicacion').AsString + '",' +
                               '"CodigoUbicacionAlternativo":"' + Q2.FieldByName('CodigoUbicacionAlternativo').AsString + '",' +
                               '"CodigoAlmacenRechazos":"' + Q2.FieldByName('CodigoAlmacenRechazos').AsString + '",' +
                               '"CodigoUbicacionRechazos":"' + Q2.FieldByName('CodigoUbicacionRechazos').AsString + '",' +
                               '"Caja":"' + JSON_Str(Q2.FieldByName('Caja').AsString) + '",' +
                               '"Palet":"' + JSON_Str(Q2.FieldByName('Palet').AsString) + '",' +
                               '"Partida":"' + JSON_Str(Q2.FieldByName('Partida').AsString) + '",' +
                               '"FechaCaduca":"' + Q2.FieldByName('FechaCaducidad').AsString + '",' +
                               '"Verificacion":"' + JSON_Str(Q2.FieldByName('Verificacion').AsString) + '",' +
                               '"IdIncidencia":"' + JSON_Str(Q2.FieldByName('AnomaliaId').AsString) + '",' +
                               '"NombreIncidencia":"' + JSON_Str(Q2.FieldByName('NombreIncidencia').AsString) + '",' +
                               '"Precio":' + SQL_FloatToStr(Q2.FieldByName('Precio').AsFloat) + ',' +
                               '"UnidadesEntrada":' + SQL_FloatToStr(abs(Q2.FieldByName('UnidadesEntrada').AsFloat)) + ',' +
                               '"CantidadErrorEntrada":' + SQL_FloatToStr(abs(Q2.FieldByName('CantidadErrorEntrada').AsFloat)) + ',' +
                               '"TotalEntrada":' + SQL_FloatToStr(abs(Q2.FieldByName('TotalEntrada').AsFloat)) +
                               '}';

      Q2.Next;

    end;

    Q2.Close;
    *)

    //sDesglose := sDesglose + '';

    Result := Result + '{' +
                       '"DevolucionId":' + Q.FieldByName('DevolucionId').AsString + ',' +
                       '"DevolucionIdLinea":' + Q.FieldByName('DevolucionIdLinea').AsString + ',' +
                       '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
                       '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
                       '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
                       '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
                       '"OrdenLineaPedido":"' + Q.FieldByName('OrdenLineaPedido').AsString + '",' +
                       '"LineasPosicion":"' + Q.FieldByName('LineasPosicion').AsString + '",' +
                       '"UdPedidas":' + SQL_FloatToStr(abs(Q.FieldByName('UdPedidas').AsFloat)) + ',' +
                       '"UdRecibidas":' + SQL_FloatToStr(abs(Q.FieldByName('UdRecibidas').AsFloat)) + ',' +
                       '"UdSaldo":' + SQL_FloatToStr(abs(Q.FieldByName('UdSaldo').AsFloat)) + ',' +
                       '"UdPedidasBase":' + SQL_FloatToStr(abs(Q.FieldByName('UdPedidasBase').AsFloat)) + ',' +
                       '"UdRecibidasBase":' + SQL_FloatToStr(abs(Q.FieldByName('UdRecibidasBase').AsFloat)) + ',' +
                       '"UdSaldoBase":' + SQL_FloatToStr(abs(Q.FieldByName('UdSaldoBase').AsFloat)) + ',' +
                       '"Precio":' + SQL_FloatToStr(Q.FieldByName('Precio').AsFloat) + ',' +
                       '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
                       '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
                       '"CodigoAlternativo2":"' + JSON_Str(Q.FieldByName('CodigoAlternativo2').AsString) + '",' +
                       '"CodigoAlternativoTC":"' + JSON_Str(Q.FieldByName('CodigoAlternativoTC').AsString) + '",' +
                       '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
                       '"Descripcion2Articulo":"' + JSON_Str(Q.FieldByName('Descripcion2Articulo').AsString) + '",' +
                       '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
                       '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
                       '"CodigoCliente":"' + JSON_Str(Q.FieldByName('CodigoCliente').AsString) + '",' +
                       '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
                       '"IdAlbaranCli":"' + JSON_Str(Q.FieldByName('IdAlbaranCli').AsString) + '",' +
                       '"Albaran":"' + JSON_Str(Q.FieldByName('Albaran').AsString) + '",' +
                       '"FechaRecepcion":"' + Q.FieldByName('FechaRecepcion').AsString + '",' +
                       '"TratamientoPartidas":' + SQL_BooleanToStr(Q.FieldByName('TratamientoPartidas').AsInteger<>0) + ',' +
                       '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
                       '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString)) + '",' +
                       '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '",' +
                       '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion').AsFloat) + ',' +
                       '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
                       '"Agrupacion":"' + JSON_Str(Q.FieldByName('Agrupacion').AsString) + '",' +
                       '"UnidadesAgrupacion":' + SQL_FloatToStr(Q.FieldByName('UnidadesAgrupacion').AsFloat) + ',' +
                       '"GrupoTalla":' + IntToStr(Q.FieldByName('GrupoTalla_').AsInteger) + ',' +
                       '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('Colores_').AsInteger<>0) + ',' +
                       '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
                       '"DescripcionTalla":"' + JSON_Str(Q.FieldByName('DescripcionTalla').AsString) + '",' +
                       '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
                       '"DescripcionColor":"' + JSON_Str(Q.FieldByName('DescripcionColor').AsString) + '"' +
//                       '"Desglose":[' + sDesglose + ']' +
                       '}';

    Q.Next;

  end;

  Result := Result + ']}';

  //Q2.Close;
  //FreeAndNil(Q2);
  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


procedure WebModule1detalleDevolucionProvAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  DevolucionId: Integer;
  sSQL: String;
  Q, Q2: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoArticulo: string;
  CodigoUbicacion: string;
  sDesglose: string;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoUsuario: Integer;
  CodigoUbicacionDevolucion: String;
  CodigoUbicacionDevolucionRechazos: String;
  contentfields: TStringList;
  Pending: Boolean;
  Linea: Integer;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  DevolucionId := StrToIntDef(contentfields.values['DevolucionId'],0);
  if DevolucionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no especificado","Data":[]}';
    Exit;
  end;

  Pending := (StrToIntDef(contentfields.Values['Pendientes'],0)<>0);
  Linea   := StrToIntDef(contentfields.values['Linea'],0);

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  OrdenarPor    := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden     := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy      := '';

  if OrdenarPor='PEDIDO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsdl.EjercicioPedido DESC, fsdl.SeriePedido DESC, fsdl.NumeroPedido DESC, fsdl.OrdenLineaPedido ';
    end else begin
      sOrderBy := 'fsdl.EjercicioPedido, fsdl.SeriePedido, fsdl.NumeroPedido, fsdl.OrdenLineaPedido ';
    end;
  end else if OrdenarPor='ESTADO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsdl.UdSaldo DESC ';
    end else begin
      sOrderBy := 'fsdl.UdSaldo ';
    end;
  end else if OrdenarPor='ARTICULO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsdl.CodigoArticulo DESC, fsdl.Partida DESC ';
    end else begin
      sOrderBy := 'fsdl.CodigoArticulo, fsdl.Partida ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsdl.DevolucionIdLinea DESC ';
    end else begin
      sOrderBy := 'fsdl.DevolucionIdLinea ';
    end;
  end;

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucion,         CodigoUbicacionDevolucion, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucionRechazos, CodigoUbicacionDevolucionRechazos, CodigoEmpresa.EmpresaOrigen );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_DevolucionesP_Lineas WITH (NOLOCK) ' +
          'WHERE ' +
          '  DevolucionId = ' + IntToStr(DevolucionId);

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'ART', '' );

  sSQL :=
    'SELECT ' +
    '  fsdl.*, T.DescripcionTalla01_ as DescripcionTalla, C.Color_ AS DescripcionColor, ' +
    '  art.GrupoTalla_, art.Colores_, art.TratamientoPartidas, art.CodigoAlternativo, art.CodigoAlternativo2, ' +
    '  CTC.CodigoAlternativo AS CodigoAlternativoTC, art.Descripcion2Articulo, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc, ' +
    '  ISNULL(agrup.DescripcionArticulo,''Unidades'') AS Agrupacion ' +
    'FROM FS_SGA_DevolucionesP_Lineas fsdl WITH (NOLOCK) ' +
    'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
    'ON ' +
    '  fsdl.CodigoArticulo = art.CodigoArticulo ' +
    'INNER JOIN LineasPedidoProveedor LPP WITH (NOLOCK) ' +
    'ON ' +
    '  fsdl.CodigoEmpresa = LPP.CodigoEmpresa ' +
    '  AND fsdl.EjercicioPedido = LPP.EjercicioPedido ' +
    '  AND fsdl.SeriePedido = LPP.SeriePedido ' +
    '  AND fsdl.NumeroPedido = LPP.NumeroPedido ' +
    '  AND fsdl.OrdenLineaPedido = LPP.Orden ' +
    '  AND fsdl.LineasPosicion = LPP.LineasPosicion ' +
    'INNER JOIN CabeceraPedidoProveedor CPP WITH (NOLOCK) ' +
    'ON ' +
    '  CPP.CodigoEmpresa = LPP.CodigoEmpresa ' +
    '  AND CPP.EjercicioPedido = LPP.EjercicioPedido ' +
    '  AND CPP.SeriePedido = LPP.SeriePedido ' +
    '  AND CPP.NUmeroPedido = LPP.NumeroPedido ' +
    'LEFT JOIN Agrupaciones agrup WITH (NOLOCK) ' +
    'ON ' +
    '  agrup.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
    '  AND agrup.CodigoArticulo = fsdl.CodigoArticulo ' +
    '  AND agrup.CodigoAgrupacion = fsdl.CodigoAgrupacion ' +
    'LEFT JOIN Colores_ C WITH (NOLOCK) ' +
    'ON ' +
    '  C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
    '  AND C.CodigoColor_ = fsdl.CodigoColor_ ' +
    'LEFT JOIN Vis_VistaTallas T WITH (NOLOCK) ' +
    'ON ' +
    '  T.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
    '  AND T.GrupoTalla_= art.GrupoTalla_ ' +
    '  AND T.CodigoTalla01_ = fsdl.CodigoTalla01_ ' +
    'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
    'ON ' +
    '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
    '  AND CTC.CodigoArticulo = fsdl.CodigoArticulo ' +
    '  AND CTC.CodigoTalla01_ = fsdl.CodigoTalla01_ ' +
    '  AND CTC.CodigoColor_ = fsdl.CodigoColor_ ' +
    'WHERE ' +
    '  fsdl.DevolucionId = ' + IntToStr(DevolucionId) + ' ' +
    '  AND CPP.Estado = 0 ' +
    '  AND LPP.Estado = 0 ';

  if Linea<>0 then
  begin
    sSQL := sSQL +
      'AND fsdl.DevolucionIdLinea = ' + IntToStr(Linea) + ' ';
  end;

  sSQL := sSQL +
    'ORDER BY ' +
    sOrderBy +
    'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
    'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', sIDCall, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  //Q2 := SQL_PrepareQuery ( Conn );

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    (*
    sSQL := 'SELECT ' +
            '  fsdld.*, stu.CodigoAlternativo AS CodigoUbicacionAlternativo, fsi.NombreIncidencia, fsdld.Unidades * art.PesoBrutoUnitario_ as PesoBruto, ' +
            '   fsdld.Unidades * art.PesoNetoUnitario_ as PesoNeto, fsdld.Unidades * art.VolumenUnitario_ as Volumen ' +
            'FROM FS_SGA_Devoluciones_Lineas_Detalle fsdld WITH (NOLOCK) ' +
            'INNER JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) stu ' +
            'ON ' +
            '  stu.CodigoUbicacion = fsdld.CodigoUbicacion ' +
            'LEFT JOIN FS_SGA_TABLE_Incidencias ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ''R'' ) fsi ' +
            'ON ' +
            '  fsi.IdIncidencia = fsdld.AnomaliaId ' +
            'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
            'ON ' +
            '  art.CodigoArticulo = ''' + SQL_Str(Q.FieldByName('CodigoArticulo').AsString) + ''' ' +
            'WHERE ' +
            '  fsdld.DevolucionIdLinea = ' + IntToStr(Q.FieldByName('DevolucionIdLinea').AsInteger) + ' AND ' +
            '  fsdld.DevolucionId = ' + IntToStr(DevolucionId) +
            'ORDER BY ' +
            '  fsdld.DevolucionIdLineaDetalle';

    Q2.Close;
    Q2.SQL.Text := sSQL;
    try
      Q2.Open;
    except
      on E:Exception do begin
        gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', CONST_LOGID_SGA, LOG_LEVEL_EXCEPTION );
        Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
        FreeAndNil(Q);
        FreeAndNil(Q2);
        Exit;
      end;
    end;

    sDesglose := '';

    while not Q2.EOF do begin

      if sDesglose<>'' then
        sDesglose := sDesglose + ',';

      sDesglose := sDesglose + '{' +
                               '"DevolucionId":"' + Q2.FieldByName('DevolucionId').AsString + '",' +
                               '"DevolucionIdLinea":"' + Q2.FieldByName('DevolucionIdLinea').AsString + '",' +
                               '"DevolucionIdLineaDetalle":"' + Q2.FieldByName('DevolucionIdLineaDetalle').AsString + '",' +
                               '"CodigoAlmacen":"' + Q2.FieldByName('CodigoAlmacen').AsString + '",' +
                               '"CodigoUbicacion":"' + Q2.FieldByName('CodigoUbicacion').AsString + '",' +
                               '"CodigoUbicacionAlternativo":"' + Q2.FieldByName('CodigoUbicacionAlternativo').AsString + '",' +
                               '"CodigoAlmacenRechazos":"' + Q2.FieldByName('CodigoAlmacenRechazos').AsString + '",' +
                               '"CodigoUbicacionRechazos":"' + Q2.FieldByName('CodigoUbicacionRechazos').AsString + '",' +
                               '"Caja":"' + JSON_Str(Q2.FieldByName('Caja').AsString) + '",' +
                               '"Palet":"' + JSON_Str(Q2.FieldByName('Palet').AsString) + '",' +
                               '"Partida":"' + JSON_Str(Q2.FieldByName('Partida').AsString) + '",' +
                               '"FechaCaduca":"' + Q2.FieldByName('FechaCaducidad').AsString + '",' +
                               '"Verificacion":"' + JSON_Str(Q2.FieldByName('Verificacion').AsString) + '",' +
                               '"IdIncidencia":"' + JSON_Str(Q2.FieldByName('AnomaliaId').AsString) + '",' +
                               '"NombreIncidencia":"' + JSON_Str(Q2.FieldByName('NombreIncidencia').AsString) + '",' +
                               '"Precio":' + SQL_FloatToStr(Q2.FieldByName('Precio').AsFloat) + ',' +
                               '"UnidadesEntrada":' + SQL_FloatToStr(abs(Q2.FieldByName('UnidadesEntrada').AsFloat)) + ',' +
                               '"CantidadErrorEntrada":' + SQL_FloatToStr(abs(Q2.FieldByName('CantidadErrorEntrada').AsFloat)) + ',' +
                               '"TotalEntrada":' + SQL_FloatToStr(abs(Q2.FieldByName('TotalEntrada').AsFloat)) +
                               '}';

      Q2.Next;

    end;

    Q2.Close;
    *)

    //sDesglose := sDesglose + '';

    Result := Result + '{' +
                       '"DevolucionId":' + Q.FieldByName('DevolucionId').AsString + ',' +
                       '"DevolucionIdLinea":' + Q.FieldByName('DevolucionIdLinea').AsString + ',' +
                       '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
                       '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
                       '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
                       '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
                       '"OrdenLineaPedido":"' + Q.FieldByName('OrdenLineaPedido').AsString + '",' +
                       '"LineasPosicion":"' + Q.FieldByName('LineasPosicion').AsString + '",' +
                       '"UdPedidas":' + SQL_FloatToStr(abs(Q.FieldByName('UdPedidas').AsFloat)) + ',' +
                       '"UdRecibidas":' + SQL_FloatToStr(abs(Q.FieldByName('UdRecibidas').AsFloat)) + ',' +
                       '"UdSaldo":' + SQL_FloatToStr(abs(Q.FieldByName('UdSaldo').AsFloat)) + ',' +
                       '"UdPedidasBase":' + SQL_FloatToStr(abs(Q.FieldByName('UdPedidasBase').AsFloat)) + ',' +
                       '"UdRecibidasBase":' + SQL_FloatToStr(abs(Q.FieldByName('UdRecibidasBase').AsFloat)) + ',' +
                       '"UdSaldoBase":' + SQL_FloatToStr(abs(Q.FieldByName('UdSaldoBase').AsFloat)) + ',' +
                       '"Precio":' + SQL_FloatToStr(Q.FieldByName('Precio').AsFloat) + ',' +
                       '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
                       '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
                       '"CodigoAlternativo2":"' + JSON_Str(Q.FieldByName('CodigoAlternativo2').AsString) + '",' +
                       '"CodigoAlternativoTC":"' + JSON_Str(Q.FieldByName('CodigoAlternativoTC').AsString) + '",' +
                       '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
                       '"Descripcion2Articulo":"' + JSON_Str(Q.FieldByName('Descripcion2Articulo').AsString) + '",' +
                       '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
                       '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
                       '"CodigoProveedor":"' + JSON_Str(Q.FieldByName('CodigoProveedor').AsString) + '",' +
                       '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
                       '"IdAlbaranPro":"' + JSON_Str(Q.FieldByName('IdAlbaranPro').AsString) + '",' +
                       '"Albaran":"' + JSON_Str(Q.FieldByName('Albaran').AsString) + '",' +
                       '"FechaRecepcion":"' + Q.FieldByName('FechaRecepcion').AsString + '",' +
                       '"TratamientoPartidas":' + SQL_BooleanToStr(Q.FieldByName('TratamientoPartidas').AsInteger<>0) + ',' +
                       '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
                       '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString)) + '",' +
                       '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '",' +
                       '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion').AsFloat) + ',' +
                       '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
                       '"Agrupacion":"' + JSON_Str(Q.FieldByName('Agrupacion').AsString) + '",' +
                       '"UnidadesAgrupacion":' + SQL_FloatToStr(Q.FieldByName('UnidadesAgrupacion').AsFloat) + ',' +
                       '"GrupoTalla":' + IntToStr(Q.FieldByName('GrupoTalla_').AsInteger) + ',' +
                       '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('Colores_').AsInteger<>0) + ',' +
                       '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
                       '"DescripcionTalla":"' + JSON_Str(Q.FieldByName('DescripcionTalla').AsString) + '",' +
                       '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
                       '"DescripcionColor":"' + JSON_Str(Q.FieldByName('DescripcionColor').AsString) + '"' +
//                       '"Desglose":[' + sDesglose + ']' +
                       '}';

    Q.Next;

  end;

  Result := Result + ']}';

  //Q2.Close;
  //FreeAndNil(Q2);
  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;

procedure WebModule1detalleExpedicion2Action
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoArticulo: String;
  sFiltro: string;
  IdentificadorExp: string;
  t: TStringList;
  EjercicioPedido: Integer;
  NumeroPedido: Integer;
  SeriePedido: string;

  contentfields: TStringList;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';

    Exit;
  end;

  sFiltro := '';

  CodigoArticulo   := (contentfields.values['CodigoArticulo']);

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );

  if CodigoArticulo<>'' then begin
    sFiltro := sFiltro + 'AND fsppl.CodigoArticulo=''' + SQL_Str(CodigoArticulo) + ''' ';
  end;

  IdentificadorExp := (contentfields.values['IdentificadorExpedicion']);
  if IdentificadorExp<>'' then begin
    t := TStringList.Create;
    t.Delimiter := '.';
    t.DelimitedText := IdentificadorExp;
    if t.Count=2 then begin
      if StrToIntDef(t[0],0)=IdPreparacion then begin
        sFiltro := sFiltro + 'AND fsppl.IdentificadorExpedicion=' + SQL_Str(t[1]) + ' ';
        FreeAndNil(t);
      end else begin
        FreeAndNil(t);
        Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de expedición no válido","Data":[]}';

        Exit;
      end;
    end else begin
      FreeAndNil(t);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de expedición no válido","Data":[]}';

      Exit;
    end;
  end;

  EjercicioPedido := StrToIntDef(contentfields.values['EjercicioPedido'],0);
  if (EjercicioPedido<>0) then begin
    sFiltro := sFiltro + 'AND fsppl.EjercicioPedido=' + IntToStr(EjercicioPedido) + ' ';
  end;

  NumeroPedido := StrToIntDef(contentfields.values['NumeroPedido'],0);
  if (NumeroPedido<>0) then begin
    sFiltro := sFiltro + 'AND fsppl.NumeroPedido=' + IntToStr(NumeroPedido) + ' ';
  end;

  if contentfields.IndexOfName('SeriePedido')>=0 then begin
    SeriePedido := (contentfields.values['SeriePedido']);
    sFiltro := sFiltro + 'AND fsppl.SeriePedido=''' + SQL_Str(SeriePedido) + ''' ';
  end;

  OrdenarPor := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden  := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy   := '';

  if OrdenarPor='ARTICULO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsppl.CodigoArticulo DESC, fsppl.Partida DESC ';
    end else begin
      sOrderBy := 'fsppl.CodigoArticulo, fsppl.Partida ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsppl.CodigoArticulo DESC, fsppl.Partida DESC ';
    end else begin
      sOrderBy := 'fsppl.CodigoArticulo DESC, fsppl.Partida ';
    end;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'WHERE ' +
          '  fsppl.PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          sFiltro;

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'ART', '' );

  sSQL := 'SELECT ' +
          '  fsppl.EjercicioPedido, fsppl.SeriePedido, fsppl.NumeroPedido, fsppl.PreparacionId, fsppl.PickingId, ' +
          '  fsppl.CodigoEmpresa, fsppl.LineasPosicion, fsppl.CodigoArticulo, fsppl.UnidadMedida, fsppl.DescripcionArticulo, fsppl.CodigoAlmacen, fsppl.UnidadMedida, Partida, ' +
          '  art.TratamientoPartidas, fsppl.UdNecesarias, fsppl.UdSaldo, fsppl.UdRetiradas, fsppl.UdExpedidas, fsppl.IdentificadorExpedicion, ' +
          '  art.CodigoAlternativo AS CodigoArticuloAlternativo, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
          'ON ' +
          '  fsppl.CodigoArticulo = art.CodigoArticulo ' +
          'WHERE ' +
          '  fsppl.PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          sFiltro +
          'ORDER BY ' +
          sOrderBy +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', CONST_LOGID_SGA, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
                       '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
                       '"PreparacionId":' + Q.FieldByName('PreparacionId').AsString + ',' +
                       '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
                       '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
                       '"PickingId":' + Q.FieldByName('PickingId').AsString + ',' +
                       '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
                       '"LineasPosicion":"' + JSON_Str(Q.FieldByName('LineasPosicion').AsString) + '",' +
                       '"IdentificadorExpedicion":"' + Q.FieldByName('IdentificadorExpedicion').AsString + '",' +
                       '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
                       '"CodigoArticuloAlternativo":"' + JSON_Str(Q.FieldByName('CodigoArticuloAlternativo').AsString) + '",' +
                       '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
                       '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
                       '"TratamientoPartidas":' + IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) + ',' +
                       '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
                       '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
                       '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
                       '"UdNecesarias":' + SQL_FloatToStr(Q.FieldByName('UdNecesarias').AsFloat) + ',' +
                       '"UdRetiradas":' + SQL_FloatToStr(Q.FieldByName('UdRetiradas').AsFloat) + ',' +
                       '"UdExpedidas":' + SQL_FloatToStr(Q.FieldByName('UdExpedidas').AsFloat) + ',' +
                       '"UdSaldo":' + SQL_FloatToStr(Q.FieldByName('UdExpedidas').AsFloat) +
                       '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;

procedure WebModule1detalleExpedicionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoArticulo: String;
  sFiltro: string;
  IdentificadorExp: string;
  t: TStringList;
  TratamientoPartidas: Boolean;
  Partida: String;
  bHasData: Boolean;
  fUnidadesExpedidas: Double;
  sFilterPartida: String;
  contentfields: TStringList;
  fUnidadesUsadas: Double;
  fUnidadesPreparadas: Double;
  PaletId, CajaId: Integer;
  sPaletCaja: String;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  sFiltro := '';

  CodigoArticulo := (contentfields.values['CodigoArticulo']);
  if CodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );
  if CodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo inválido","Data":[]}';
    Exit;
  end;

  TratamientoPartidas := ARTICULO_TratamientoPartida ( Conn, CodigoEmpresa, CodigoArticulo );
  Partida := (contentfields.values['Partida']);

  if TratamientoPartidas then
  begin
    sFilterPartida := 'AND Preparacion.PartidaSel = ''' + SQL_Str(Partida) + ''' ';
  end else begin
    sFilterPartida := '';
  end;

  (*
  if TratamientoPartidas and (Partida='') then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El artículo tiene tratamiento de partidas pero no se ha especificado ninguna","Data":[]}';

    Exit;
  end;

  if (not TratamientoPartidas) and (Partida<>'') then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El artículo no tiene tratamiento de partidas pero se ha especificado una","Data":[]}';

    Exit;
  end;
  *)

  PaletId := StrToIntDef(contentfields.Values['NewPaletId'],0);
  CajaId  := StrToIntDef(contentfields.Values['NewCajaId'],0);

  IdentificadorExp := (contentfields.values['IdentificadorExpedicion']);
  if IdentificadorExp<>'' then begin
    t := TStringList.Create;
    t.Delimiter := '.';
    t.DelimitedText := IdentificadorExp;
    if (t.Count>=2) then begin
      if StrToIntDef(t[0],0)=IdPreparacion then begin
        sFiltro := sFiltro + 'AND fsppl.IdentificadorExpedicion=' + SQL_Str(t[1]) + ' ';
        FreeAndNil(t);
      end else begin
        FreeAndNil(t);
        Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de expedición no válido","Data":[]}';
        Exit;
      end;
    end else begin
      FreeAndNil(t);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de expedición no válido","Data":[]}';
      Exit;
    end;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'ART', '' );

  sSQL := 'SELECT ' +
          '  fsppl.EjercicioPedido, fsppl.SeriePedido, fsppl.NumeroPedido, fsppl.PreparacionId, fsppl.PickingId, ' +
          '  fsppl.CodigoEmpresa, fsppl.LineasPosicion, fsppl.CodigoArticulo, fsppl.UnidadMedida, fsppl.DescripcionArticulo, fsppl.CodigoAlmacen, fsppl.UnidadMedida, Partida, ' +
          '  ISNULL(PartidaSel,'''') AS PartidaSel, art.TratamientoPartidas, fsppl.UdNecesarias, fsppl.UdSaldo, fsppl.UdRetiradas, fsppl.UdExpedidas, fsppl.IdentificadorExpedicion, ' +
          '  art.CodigoAlternativo AS CodigoArticuloAlternativo, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc, fsppl.RazonSocial, fsppl.CodigoCliente, ' +
          '  MIN (ISNULL(Preparacion.CantidadPreparada,0)) AS CantidadPendienteExpedir ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'LEFT JOIN  ' +
          '( SELECT  ' +
          '    IdPreparacion, CodigoArticulo,	Partida AS PartidaSel, SUM(Cantidad) AS CantidadPreparada  ' +
          '  FROM dbo.FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
          '  WHERE  ' +
          '    LineaPedidoCliente = ''00000000-0000-0000-0000-000000000000''  ' +
          '  GROUP BY  ' +
          '    IdPreparacion, CodigoArticulo, Partida ' +
          ') as Preparacion  ' +
          'ON   ' +
          '  Preparacion.CodigoArticulo = fsppl.CodigoArticulo AND  ' +
          '  Preparacion.IdPreparacion = fsppl.PreparacionId  ' +
          'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
          'ON ' +
          '  fsppl.CodigoArticulo = art.CodigoArticulo ' +
          'WHERE ' +
          '  fsppl.PreparacionId = ' + IntToStr(IdPreparacion) + ' AND ' +
          '  fsppl.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          sFilterPartida +
          'GROUP BY ' +
          '  fsppl.EjercicioPedido, fsppl.SeriePedido, fsppl.NumeroPedido, fsppl.PreparacionId, fsppl.PickingId, ' +
          '  fsppl.CodigoEmpresa, fsppl.LineasPosicion, fsppl.CodigoArticulo, fsppl.UnidadMedida, Partida, PartidaSel, ' +
          '  fsppl.DescripcionArticulo, fsppl.CodigoAlmacen, ' +
          '  art.TratamientoPartidas, fsppl.UdNecesarias, fsppl.UdSaldo, fsppl.UdRetiradas, fsppl.UdExpedidas, fsppl.IdentificadorExpedicion, ' +
          '  art.CodigoAlternativo, fsppl.RazonSocial, fsppl.CodigoCliente ' +
          'ORDER BY ' +
          '  IdentificadorExpedicion';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', CONST_LOGID_SGA, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":1,"NumPages":1,"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;
  bHasData := FALSE;

  if not Q.EOF then begin

    sSQL := 'SELECT ' +
            '  SUM(Cantidad) AS Cantidad ' +
            'FROM FS_SGA_AcumuladoPendiente WITH (NOLOCK) ' +
            'WHERE ' +
            '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
            //'  AND LineaPedidoCliente = ''00000000-0000-0000-0000-000000000000'' ' +
            '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND UnidadMedida = ''' + SQL_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + ''' ' +
            '  AND Partida = ''' + SQL_Str(Partida) + '''';
    fUnidadesPreparadas := SQL_Execute ( Conn, sSQL );

    // Recuperem el toral d'unitata preparades
    sSQL := 'SELECT ' +
            '  SUM(fspl.unidades) ' +
            'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
            'INNER JOIN FS_SGA_PACKINGLIST fspl WITH (NOLOCK) ' +
            'ON ' +
            '  fsppl.PreparacionId = fspl.PreparacionId ' +
            '  AND fsppl.PickingId = fspl.PickingId ' +
            'WHERE ' +
            '  fspl.preparacionId = ' + IntToStr(IdPreparacion) + ' ' +
            '  AND fsppl.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND fspl.partida = ''' + SQL_Str(Partida) + ''' ' +
            '  AND fspl.unidadmedida = ''' + SQL_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '''';
    fUnidadesUsadas := SQL_Execute ( Conn, sSQL );

    if (PaletId<>0) and (CajaId<>0) then
    begin
      sPaletCaja :=
        '"PaletId":' + IntToStr(PaletId) + ',' +
        '"CajaId":' + IntToStr(CajaId) + ',';
    end;

    bHasData := TRUE;
    Result := Result + '{' +
                       '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
                       '"PreparacionId":' + Q.FieldByName('PreparacionId').AsString + ',' +
                       '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
                       '"CodigoArticuloAlternativo":"' + JSON_Str(Q.FieldByName('CodigoArticuloAlternativo').AsString) + '",' +
                       '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
                       '"TratamientoPartidas":' + IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) + ',' +
                       '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
                       '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
                       '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
                       '"unidadesPreparadas":' + SQL_FloatToStr(fUnidadesPreparadas) + ',' +
                       '"unidadesExpedicion":' + SQL_FloatToStr(fUnidadesUsadas) + ',' +
                       sPaletCaja +
                       '"Detalle":[';
  end;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    sSQL := 'SELECT ' +
            '  SUM(Cantidad) ' +
            'FROM FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
            'WHERE ' +
            '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' AND ' +
            '  CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' AND ' +
            '  Partida = ''' + SQL_Str(Partida) + ''' AND ' +
            '  LineaPedidoCliente = ''' + SQL_Str(Q.FieldByName('LineasPosicion').AsString) + ''' ';
    fUnidadesExpedidas := SQL_Execute ( Conn, sSQL );

    sSQL := 'SELECT' +
          '  SUM(fspl.unidades) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'INNER JOIN FS_SGA_PACKINGLIST fspl WITH (NOLOCK) ' +
          'ON ' +
          '  fsppl.PreparacionId = fspl.PreparacionId ' +
          '  AND fsppl.PickingId = fspl.PickingId ' +
          'WHERE ' +
          '  fspl.preparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND fsppl.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND fspl.partida = ''' + SQL_Str(Partida) + ''' ' +
          '  AND fspl.unidadmedida = ''' + SQL_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '''';
    fUnidadesUsadas := SQL_Execute ( Conn, sSQL );

    Result := Result + '{' +
                       '"PickingId":' + Q.FieldByName('PickingId').AsString + ',' +
                       '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
                       '"CodigoCliente":"' + JSON_Str(Q.FieldByName('CodigoCliente').AsString) + '",' +
                       '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
                       '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
                       '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
                       '"LineasPosicion":"' + JSON_Str(Q.FieldByName('LineasPosicion').AsString) + '",' +
                       '"IdentificadorExpedicion":"' + Q.FieldByName('IdentificadorExpedicion').AsString + '",' +
                       '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +

                       '"UnidadesNecesariasTotales":' + SQL_FloatToStr(Q.FieldByName('UdNecesarias').AsFloat) + ',' +
                       '"UnidadesRetiradasTotales":' + SQL_FloatToStr(Q.FieldByName('UdRetiradas').AsFloat) + ',' +
                       '"UnidadesExpedidasTotales":' + SQL_FloatToStr(Q.FieldByName('UdExpedidas').AsFloat) + ',' +
                       '"UnidadesPendientesPreparar":' + SQL_FloatToStr(Q.FieldByName('UdNecesarias').AsFloat - Q.FieldByName('UdRetiradas').AsFloat) + ',' +
                       '"UnidadesPendientesExpedir":' + SQL_FloatToStr(Q.FieldByName('UdNecesarias').AsFloat - Q.FieldByName('UdExpedidas').AsFloat) + ',' +

                       '"UnidadesRetiradasPartida":' + SQL_FloatToStr(fUnidadesExpedidas + Q.FieldByName('CantidadPendienteExpedir').AsFloat) + ',' +
                       '"UnidadesExpedidasPartida":' + SQL_FloatToStr(fUnidadesExpedidas) + ',' +

                       '"UdNecesarias":' + SQL_FloatToStr(fUnidadesExpedidas + Q.FieldByName('CantidadPendienteExpedir').AsFloat) + ',' +
                       '"UdNecesariasTotales":' + SQL_FloatToStr(Q.FieldByName('UdNecesarias').AsFloat) + ',' +
                       '"UdRetiradas":' + SQL_FloatToStr(Q.FieldByName('CantidadPendienteExpedir').AsFloat) + ',' +
                       '"UdRetiradas2":' + SQL_FloatToStr(Q.FieldByName('UdRetiradas').AsFloat) + ',' +
                       '"UdSaldo":' + SQL_FloatToStr(Q.FieldByName('UdSaldo').AsFloat) + ',' +
                       '"UdExpedidasLinea":' + SQL_FloatToStr(Q.FieldByName('UdExpedidas').AsFloat) + ',' +
                       '"UdExpedidas":' + SQL_FloatToStr(fUnidadesExpedidas) + ',' +
                       '"UdUsadas":' + SQL_FloatToStr(fUnidadesUsadas) +
                       '}';

    Q.Next;

  end;

  if bHasData then begin
    Result := Result + ']}';
  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;

procedure WebModule1detallePreparacionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;

  contentfields: TStringList;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';

    Exit;
  end;

  OrdenarPor := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden  := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy   := '';

  if OrdenarPor='ARTICULO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'CodigoArticulo DESC, Partida DESC ';
    end else begin
      sOrderBy := 'CodigoArticulo, Partida ';
    end;
  end else if OrdenarPor='CODIGOUBICACION' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'CodigoUbicacion DESC ';
    end else begin
      sOrderBy := 'CodigoUbicacion ';
    end;
  end else if OrdenarPor='CODIGOUBICACIONALTERNATIVO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'CodigoUbicacionAlternativo DESC ';
    end else begin
      sOrderBy := 'CodigoUbicacionAlternativo ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'CodigoArticulo DESC, Partida DESC ';
    end else begin
      sOrderBy := 'CodigoArticulo DESC, Partida ';
    end;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion);

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', CONST_LOGID_SGA, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'art', '' );

  sSQL := 'SELECT ' +
          '  fsppl.PreparacionId, fsppl.CodigoEmpresa, fsppl.CodigoArticulo, fsppl.UnidadMedida, ' +
          '  art.DescripcionArticulo, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc, fsppl.CodigoAlmacen, fsppl.UnidadMedida, Partida, ' +
          '  art.TratamientoPartidas, SUM(fsppl.UdNecesarias) as UdNecesarias, MIN(fsppl.UdRetiradas) as UdRetiradas, ' +
          '  SUM(fsppl.UdExpedidas) as UdExpedidas, ' +
          '  ( ' +
          '    SELECT ' +
          '      ISNULL(SUM(UnidadesSaldo),0) ' +
          '    FROM dbo.FS_SGA_TABLE_AcumuladoStock ( ' + IntToStr(CodigoEmpresa.Stocks) + ' ) ' +
          '    WHERE ' +
          '      CodigoAlmacen = fsppl.CodigoAlmacen AND ' +
          '      CodigoArticulo = fsppl.CodigoArticulo AND ' +
          '      Partida = fsppl.Partida AND ' +
          '      Periodo = 99 AND ' +
          '      Ejercicio = ' + IntToStr(YY) + ' AND ' +
          '      UnidadMedida = fsppl.UnidadMedida ' +
          '  ) AS UnidadesStock, ' +
          '  ( ' +
          '    SELECT TOP 1 ' +
          '      CodigoUbicacion ' +
          '    FROM FS_SGA_TABLE_AcumuladoStock ( ' + IntToStr(CodigoEmpresa.Stocks) + ' ) ' +
          '    WHERE ' +
          '      CodigoAlmacen = fsppl.CodigoAlmacen AND ' +
          '      CodigoArticulo = fsppl.CodigoArticulo AND ' +
//          '      Partida = fsppl.Partida AND ' +
          '      Periodo = 99 AND ' +
          '      Ejercicio = ' + IntToStr(YY) + ' AND ' +
          '      UnidadMedida = fsppl.UnidadMedida AND ' +
          '      UnidadesSaldo > 0 ' +
          '    ORDER BY ' +
          '      FechaCaduca DESC, Partida ' +
          '    ) AS CodigoUbicacion, ' +
          '  ( ' +
          '    SELECT TOP 1 ' +
          '      CodigoUbicacionAlternativo ' +
          '    FROM FS_SGA_TABLE_AcumuladoStock ( ' + IntToStr(CodigoEmpresa.Stocks) + ' ) ' +
          '    WHERE ' +
          '      CodigoAlmacen = fsppl.CodigoAlmacen AND ' +
          '      CodigoArticulo = fsppl.CodigoArticulo AND ' +
//          '      Partida = fsppl.Partida AND ' +
          '      Periodo = 99 AND ' +
          '      Ejercicio = ' + IntToStr(YY) + ' AND ' +
          '      UnidadMedida = fsppl.UnidadMedida AND ' +
          '      UnidadesSaldo > 0 ' +
          '    ORDER BY ' +
          '      FechaCaduca DESC, Partida ' +
          '    ) AS CodigoUbicacionAlternativo ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
          'ON ' +
          '  fsppl.CodigoArticulo = art.CodigoArticulo ' +
          'WHERE ' +
          '  fsppl.PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          'GROUP BY ' +
          '  fsppl.PreparacionId, fsppl.CodigoEmpresa, fsppl.CodigoArticulo, fsppl.UnidadMedida, ' +
          '  art.DescripcionArticulo, ' + sFieldTratamientoSeries + ', fsppl.CodigoAlmacen, fsppl.UnidadMedida, ' +
          '  Partida, art.TratamientoPartidas ' +
          'ORDER BY ' +
          sOrderBy +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', CONST_LOGID_SGA, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
                       '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
                       '"UdNecesarias":' + SQL_FloatToStr(Q.FieldByName('UdNecesarias').AsFloat) + ',' +
                       '"UdRetiradas":' + SQL_FloatToStr(Q.FieldByName('UdRetiradas').AsFloat) + ',' +
                       '"UdExpedidas":' + SQL_FloatToStr(Q.FieldByName('UdExpedidas').AsFloat) + ',' +
                       '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
                       '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
                       '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
                       '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
                       '"PreparacionId":' + Q.FieldByName('PreparacionId').AsString + ',' +
                       '"TratamientoPartidas":' + IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) + ',' +
                       '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
                       '"UnidadesStock":' + SQL_FloatToStr(Q.FieldByName('UnidadesStock').AsFloat) + ',' +
                       '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
                       '"CodigoUbicacion":"' + JSON_Str(Q.FieldByName('CodigoUbicacion').AsString) + '",' +
                       '"CodigoUbicacionAlternativo":"' + JSON_Str(Q.FieldByName('CodigoUbicacionAlternativo').AsString) + '"' +
                       '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


procedure WebModule1detallePackingListArticuloAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  contentfields: TStringList;
  sPacking: String;
  Q2: TADOQuery;
  sDetallePartidas: String;
  CodigoArticulo: String;
  PickingId: Integer;
  Estado: Integer;
  Cantidad: Double;
  CantidadBase: Double;
  UnidadMedida: String;
  UnidadMedidaBase: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  PickingId := StrtoIntDef(contentfields.Values['PickingId'],0);
  if PickingId=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de línea no especificado","Data":[]}';
    Exit;
  end;

  
  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_PACKINGLIST WITH (NOLOCK) ' +
          'WHERE ' +
          '  preparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND pickingId = ' + IntToStr(PickingId);

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', CONST_LOGID_SGA, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  Estado := SGA_GetEstadoPreparacion ( Conn, IdPreparacion );

  sSQL := 'SELECT DISTINCT ' +
          '  * ' +
          'FROM FS_SGA_PACKINGLIST WITH (NOLOCK) ' +
          'WHERE ' +
          '  preparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND pickingId = ' + IntToStr(PickingId) + ' ' +
          'ORDER BY ' +
          '  paletId, cajaId, Partida ';// +
          //'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          //'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', CONST_LOGID_SGA, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  Cantidad := 0;
  CantidadBase := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Cantidad         := Cantidad + Q.FieldByName('unidades').AsFloat;
    CantidadBase     := CantidadBase + Q.FieldByName('unidadesBase').AsFloat;
    UnidadMedida     := AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString);
    UnidadMedidaBase := AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString);

    if (UnidadMedida<>'') and (UnidadMedidaBase='') then
    begin
      UnidadMedidaBase := UnidadMedida;
    end;

    Result := Result + '{' +
                       '"Id":' + IntToStr(Q.FieldByName('Id').AsInteger) + ',' +
                       '"Estado":' + IntToStr(Estado) + ',' +
                       '"CajaId":' + IntToStr(Q.FieldByName('cajaId').AsInteger) + ',' +
                       '"CajaRef":"' + JSON_Str(Q.FieldByName('cajaRef').AsString) + '",' +
                       '"PaletId":' + IntToStr(Q.FieldByName('paletId').AsInteger) + ',' +
                       '"PaletRef":"' + JSON_Str(Q.FieldByName('paletRef').AsString) + '",' +
                       '"Matricula":"' + JSON_Str(Q.FieldByName('Matricula').AsString) + '",' +
                       '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
                       '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
                       '"UnidadesAgrupacion":' + SQL_FloatToStr(Q.FieldByName('UnidadesAgrupacion').AsFloat) + ',' +
                       '"CantidadExpedida":' + SQL_FloatToStr(Q.FieldByName('unidades').AsFloat) + ',' +
                       '"CantidadExpedidaBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesBase').AsFloat) + ',' +
                       '"UnidadMedida":"' + JSON_Str(UnidadMedida) + '",' +
                       '"UnidadMedidaBase":"' + JSON_Str(UnidadMedidaBase) + '",' +
                       '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion').AsFloat) + ',' +
                       '"PesoBruto":"' + SQL_FloatToStr(Q.FieldByName('Peso').AsFloat) + '",' +
                       '"PesoNeto":"' + SQL_FloatToStr(Q.FieldByName('PesoNeto').AsFloat) + '",' +
                       '"Volumen":"' + SQL_FloatToStr(Q.FieldByName('Volumen').AsFloat) + '",' +
                       '"Fecha":"' + SQL_DateTimeToStr(Q.FieldByName('fecha').AsDateTime) + '"' +
                       '}';

    Q.Next;

  end;

  Result := Result + '],"Totales":{"CantidadExpedida":' + SQL_FloatToStr(Cantidad) + ',"CantidadExpedidaBase":' + SQL_FloatToStr(CantidadBase) + '}}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


procedure WebModule1getexpedicioncajaAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  sSQL: String;
  Q: TADOQuery;
  PreparacionId: Integer;
  IdentificadorExpedicion: Integer;
  CajaId: Integer;
  CodigoArticulo, Partida, UnidadMedida: String;
  TratamientoPartidas: Boolean;
  PickingId: Integer;
  fUnidadesPreparadas: Double;
  fUnidadesCaja: Double;
  fUnidadesUsadas: Double;
  fUnidadesExpedicion: Double;
  sPartidaPedido: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  PreparacionId           := StrToIntDef(contentfields.values['PreparacionId'], 0);
  IdentificadorExpedicion := StrToIntDef(contentfields.values['IdentificadorExpedicion'], 0);
  CajaId                  := StrToIntDef(contentfields.values['CajaId'], 0);
  PickingId               := StrToIntDef(contentfields.values['pickingId'], 0);
  CodigoArticulo          := contentfields.values['codigoArticulo'];

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );
  if CodigoArticulo=''then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;

  TratamientoPartidas := ARTICULO_TratamientoPartida ( Conn, CodigoEmpresa, CodigoArticulo );

  Partida := (contentfields.values['Partida']);
  if (Partida='') and (TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de partida no especificado","Data":[]}';
    Exit;
  end;

  if (Partida<>'') and (not TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no requiere partida","Data":[]}';
    Exit;
  end;

  if PickingId=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de picking no especificado","Data":[]}';
    Exit;
  end;

  if PreparacionId=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de preparación no especificado","Data":[]}';
    Exit;
  end;

  if IdentificadorExpedicion=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de expedición no especificado","Data":[]}';
    Exit;
  end;

  if CajaId=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de caja no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  // Recuperem el toral d'unitata preparades
  (*
  sSQL := 'SELECT ' +
          '  UdRetiradas ' +
          'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(PreparacionId) + ' ' +
          '  AND PickingId = ' + IntToStr(PickingId);
  fUnidadesPreparadas := SQL_Execute ( Conn, sSQL );
  *)

  sSQL := 'SELECT ' +
          '  SUM(Cantidad) AS Cantidad ' +
          'FROM FS_SGA_AcumuladoPendiente WITH (NOLOCK) ' +
          'WHERE ' +
          '  IdPreparacion = ' + IntToStr(PreparacionId) + ' ' +
//          '  AND LineaPedidoCliente = ''00000000-0000-0000-0000-000000000000'' ' +
          '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
          '  AND Partida = ''' + SQL_Str(Partida) + '''';
  fUnidadesPreparadas := SQL_Execute ( Conn, sSQL );


  sSQL := 'SELECT' +
          '  unidades ' +
          'FROM FS_SGA_PACKINGLIST WITH (NOLOCK) ' +
          'WHERE ' +
          '  preparacionId = ' + IntToStr(PreparacionId) + ' ' +
          '  AND identificadorExpedicion = ' + IntToStr(IdentificadorExpedicion) + ' ' +
          '  AND cajaId = ' + IntToStr(CajaId) + ' ' +
          '  AND pickingId = ' + IntToStr(PickingId) + ' ' +
          '  AND partida = ''' + SQL_Str(Partida) + ''' ' +
          '  AND unidadmedida = ''' + SQL_Str(UnidadMedida) + '''';
  fUnidadesCaja := SQL_Execute ( Conn, sSQL );

  sSQL := 'SELECT' +
          '  SUM(fspl.unidades) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'INNER JOIN FS_SGA_PACKINGLIST fspl WITH (NOLOCK) ' +
          'ON ' +
          '  fsppl.PreparacionId = fspl.PreparacionId ' +
          '  AND fsppl.PickingId = fspl.PickingId ' +
          'WHERE ' +
          '  fspl.preparacionId = ' + IntToStr(PreparacionId) + ' ' +
          '  AND fsppl.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND fspl.partida = ''' + SQL_Str(Partida) + ''' ' +
          '  AND fspl.unidadmedida = ''' + SQL_Str(AnsiUpperCase(UnidadMedida)) + '''';
  fUnidadesUsadas := SQL_Execute ( Conn, sSQL );

  sSQL := 'SELECT' +
          '  Partida AS PartidaPedido ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'WHERE ' +
          '  fsppl.preparacionId = ' + IntToStr(PreparacionId) + ' ' +
          '  AND fsppl.PickingId = ' + IntToStr(PickingId);
  sPartidaPedido := SQL_Execute ( Conn, sSQL );

  sSQL := 'SELECT' +
          '  SUM(unidades) ' +
          'FROM FS_SGA_PACKINGLIST WITH (NOLOCK) ' +
          'WHERE ' +
          '  preparacionId = ' + IntToStr(PreparacionId) + ' ' +
          '  AND identificadorExpedicion = ' + IntToStr(IdentificadorExpedicion) + ' ' +
          '  AND pickingId = ' + IntToStr(PickingId) + ' ' +
          '  AND partida = ''' + SQL_Str(Partida) + ''' ' +
          '  AND unidadmedida = ''' + SQL_Str(UnidadMedida) + '''';
  fUnidadesExpedicion := SQL_Execute ( Conn, sSQL );

  Result := '{"Result":"OK","Error":"","Data":[';
    Result := Result +
      '{' +
      '"UnidadesCaja":' + SQL_FloatToStr(fUnidadesCaja) + ',' +
      '"UnidadesUsadas":' + SQL_FloatToStr(fUnidadesUsadas) + ',' +
      '"UnidadesPreparadas":' + SQL_FloatToStr(fUnidadesPreparadas) + ',' +
      '"UnidadesExpedicion":' + SQL_FloatToStr(fUnidadesExpedicion) + ',' +
      '"PartidaPedido":"' + JSON_Str(sPartidaPedido) + '"' +
      '}';

  Result := Result + ']';
  Result := Result + '}';

  {$ENDREGION}

end;


procedure WebModule1getAgrupacionesAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iTotalRegsFiltered, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  sAgrupaciones: String;
  CodigoArticulo: String;
  UnidadMedida: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, CodigoEmpresa, 'Agrupaciones' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoArticulo := (contentfields.values['CodigoArticulo']);

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );
  if CodigoArticulo=''then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;

  UnidadMedida := (AnsiUpperCase(contentfields.values['UnidadMedida']));

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  0 AS CodigoAgrupacion, ' +
          '  ''Sin agrupar'' as Agrupacion, ' +
          '  ''Sin agrupar'' as DescripcionArticulo, ' +
          '  '''' AS CodigoAlternativo, ' +
          '  1 as UnidadesAgrupacion ' +
          'UNION ' +
          'SELECT' +
          '  CodigoAgrupacion, ' +
          '  Agrupacion, ' +
          '  DescripcionArticulo, ' +
          '  CodigoAlternativo, ' +
          '  UnidadesAgrupacion ' +
          'FROM Agrupaciones WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
          '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND UnidadMedida1_ = ''' + SQL_Str(UnidadMedida) + ''' ' +
          'ORDER BY ' +
          '  CodigoAgrupacion';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
  end;

  sAgrupaciones := '';
  while not Q.EOF do
  begin

    if sAgrupaciones<>'' then
      sAgrupaciones := sAgrupaciones + ',';

    sAgrupaciones := sAgrupaciones +
      '{' +
      '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
      '"Agrupacion":"' + JSON_Str(Q.FieldByName('Agrupacion').AsString) + '",' +
      '"DescripcionAgrupacion":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"UnidadesAgrupacion":' + SQL_FloatToStr(Q.FieldByName('UnidadesAgrupacion').AsFloat) +
      '}';

    Q.Next;

  end;

  Q.Close;
  FreeAndNil(Q);

  Result := '{"Result":"OK","Error":"","Data":[';

  Result := Result + '{' +
                     '"Agrupaciones":[' + sAgrupaciones + ']' +
                     '}';

  Result := Result + ']';
  Result := Result + '}';

  {$ENDREGION}

end;


procedure WebModule1saveScansAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  contentfields: TStringList;
  iTotalRegs, iTotalRegsFiltered, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  IdPreparacion: Integer;
  PickingId: Integer;
  DT: TDateTime;
  CodigoArticulo: String;
  CodigoTalla: String;
  CodigoColor: String;
  UnidadMedida: String;
  Cantidad: Double;
  CantidadBase: Double;
  CodigoUbicacion: String;
  Partida: String;
  sSQL: String;
  Q: TADOQuery;
  i: Integer;
  Scans: string;
  JSonObject: TJSONObject;
  JSonValue: TJSONValue;
  JSonArray: TJSONArray;
  lJSonValue: TJSonValue;
  CodigoUsuario: Integer;
  PickingIdAsignado: Integer;
  Ejercicio: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  sSQL := 'SELECT Ejercicio FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  PickingId      := StrToIntDef(Trim(contentfields.values['PickingId']),0);
  CodigoArticulo := contentfields.values['CodigoArticulo'];
  Partida        := contentfields.values['Partida'];
  CodigoTalla    := contentfields.values['CodigoTalla'];
  CodigoColor    := contentfields.values['CodigoColor'];
  UnidadMedida   := AnsiUpperCase(contentfields.values['UnidadMedida']);
  Scans          := contentfields.values['Scans'];

  JSonObject := _Parse_JSonObject ( Scans );
  if JSonObject=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El formato JSON del elemento Data es incorrecto","Data":[]}';
    Exit;
  end;

  JSonValue  := JSonObject.Get('List').JsonValue;
  if JSonValue=nil then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no son válidos","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  JSonArray := TJSONArray(JSonValue);
  if JSonArray=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no contienen un array válido","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Guardem les dades'}

  sSQL :=
    'DELETE FROM FS_SGA_Picking_Pedido_Scans ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND PickingId = ' + IntToStr(PickingId) + ' ' +
    '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
    '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
    '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
    '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
    '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + '''';
  SQL_Execute_NoRes ( Conn, sSQL );

  for lJSonValue in JSonArray do begin

      DT                := StrToDateTime(_Get_JSonValue ( lJSonValue, 'DT' ));
      CodigoUbicacion   := (_Get_JSonValue ( lJSonValue, 'CodigoUbicacion' ));
      CodigoUsuario     := StrToIntDef ( _Get_JSonValue ( lJSonValue, 'CodigoUsuario' ),0);
      Partida           := (_Get_JSonValue ( lJSonValue, 'Partida' ));
      Cantidad          := FS_StrToFloatDef( _Get_JSonValue ( lJSonValue, 'Cantidad' ),0);
      CantidadBase      := FS_StrToFloatDef( _Get_JSonValue ( lJSonValue, 'CantidadBase' ),0);
      PickingIdAsignado := StrToIntDef( _Get_JSonValue ( lJSonValue, 'PickingIdAsignado' ),0);

      sSQL :=
        'INSERT INTO FS_SGA_Picking_Pedido_Scans ( PreparacionId, PickingId, Ejercicio, FechaRegistro, CodigoUsuario, ' +
        '  CodigoUbicacion, CodigoArticulo, Partida, CodigoTalla01_, CodigoColor_, UnidadMedida, Cantidad, ' +
        '  CantidadBase, PaletId, CajaId, PickingIdAsignado ) ' +
        'VALUES ( ' +
        IntToStr(IdPreparacion) + ', ' +
        IntToStr(PickingId) + ', ' +
        IntToStr(Ejercicio) + ', ' +
        SQL_DateTimeToStr(DT) + ', ' +
        IntToStr(CodigoUsuario) + ', ' +
        '''' + SQL_Str(CodigoUbicacion) + ''', ' +
        '''' + SQL_Str(CodigoArticulo) + ''', ' +
        '''' + SQL_Str(Partida) + ''', ' +
        '''' + SQL_Str(CodigoTalla) + ''', ' +
        '''' + SQL_Str(CodigoColor) + ''', ' +
        '''' + SQL_Str(UnidadMedida) + ''', ' +
        SQL_FloatToStr(Cantidad) + ', ' +
        SQL_FloatToStr(CantidadBase) + ', ' +
        '0, ' +
        '0, ' +
        IntToStr(PickingIdAsignado) + ' ' +
        ')';

      SQL_Execute_NoRes ( Conn, sSQL );


  end;


  Result := '{"Result":"OK","Error":"","Data":[';

  Result := Result + ']}';

  {$ENDREGION}

end;


procedure WebModule1saveNumerosSeriePreparacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  contentfields: TStringList;
  iTotalRegs, iTotalRegsFiltered, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  PreparacionId: Integer;
  PickingId: Integer;
  AutoId: Integer;
  DT: TDateTime;
  CodigoArticulo: String;
  CodigoTalla: String;
  CodigoColor: String;
  UnidadMedida: String;
  Cantidad: Double;
  CantidadBase: Double;
  CodigoUbicacion: String;
  Partida: String;
  sSQL: String;
  Q: TADOQuery;
  i: Integer;
  Scans: string;
  JSonObject: TJSONObject;
  JSonValue: TJSONValue;
  JSonArray: TJSONArray;
  lJSonValue: TJSonValue;
  CodigoUsuario: Integer;
  PickingIdAsignado: Integer;
  Ejercicio: Integer;
  NumeroSerie: String;
  NumeroSerieFabricante: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  PreparacionId := StrToIntDef(contentfields.values['PreparacionId'],0);
  if PreparacionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  sSQL := 'SELECT Ejercicio FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) WHERE PreparacionId = ' + IntToStr(PreparacionId);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  PickingId      := StrToIntDef(Trim(contentfields.values['PickingId']),0);
  AutoId         := StrToIntDef(Trim(contentfields.values['AutoId']),0);
  Scans          := contentfields.values['Scans'];

  JSonObject := _Parse_JSonObject ( Scans );
  if JSonObject=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El formato JSON del elemento Data es incorrecto","Data":[]}';
    Exit;
  end;

  JSonValue  := JSonObject.Get('List').JsonValue;
  if JSonValue=nil then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no son válidos","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  JSonArray := TJSONArray(JSonValue);
  if JSonArray=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no contienen un array válido","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Guardem les dades'}

  sSQL :=
    'DELETE FROM FS_SGA_Picking_Pedido_Lineas_Detalle_NumerosSerie ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(PreparacionId) + ' ' +
    '  AND PickingId = ' + IntToStr(PickingId) + ' ' +
    '  AND AutoID = ' + IntToStr(AutoId);
  SQL_Execute_NoRes ( Conn, sSQL );

  for lJSonValue in JSonArray do begin

      NumeroSerie           := _Get_JSonValue ( lJSonValue, 'NumeroSerie' );
      NumeroSerieFabricante := _Get_JSonValue ( lJSonValue, 'NumeroSerieFabricante' );
      Cantidad              := FS_StrToFloatDef( _Get_JSonValue ( lJSonValue, 'Cantidad' ),0);

      sSQL :=
        'INSERT INTO FS_SGA_Picking_Pedido_Lineas_Detalle_NumerosSerie ( CodigoEmpresa, PreparacionId, PickingId, AutoId, ' +
        '  Tipo, NumeroSerie, NumeroSerieFabricante, Cantidad ) ' +
        'VALUES ( ' +
        IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
        IntToStr(PreparacionId) + ', ' +
        IntToStr(PickingId) + ', ' +
        IntToStr(AutoId) + ', ' +
        '0, ' + // Número de serie normal (1: rechazo)
        '''' + SQL_Str(NumeroSerie) + ''', ' +
        '''' + SQL_Str(NumeroSerieFabricante) + ''', ' +
        SQL_FloatToStr(Cantidad) + ' ' +
        ')';
      SQL_Execute_NoRes ( Conn, sSQL );

  end;

  Result := '{"Result":"OK","Error":"","Data":[';

  Result := Result + ']}';

  {$ENDREGION}

end;


procedure WebModule1loadScansAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  contentfields: TStringList;
  iTotalRegs, iTotalRegsFiltered, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  IdPreparacion: Integer;
  PickingId: Integer;
  DT: TDateTime;
  CodigoArticulo: String;
  CodigoTalla: String;
  CodigoColor: String;
  UnidadMedida: String;
  sSQL: String;
  Q: TADOQuery;
  i: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  PickingId      := StrToIntDef(Trim(contentfields.values['PickingId']),0);
  CodigoArticulo := contentfields.values['CodigoArticulo'];
  CodigoTalla    := contentfields.values['CodigoTalla'];
  CodigoColor    := contentfields.values['CodigoColor'];
  UnidadMedida   := AnsiUpperCase(contentfields.values['UnidadMedida']);

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  // DETALL DE PARTIDES
  sSQL :=
    'SELECT * ' +
    'FROM FS_SGA_Picking_Pedido_Scans WITH (NOLOCK) ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND PickingId = ' + IntToStr(PickingId) + ' ' +
    '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
    '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
    '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
    '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
    'ORDER BY FechaRegistro ';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
  end;

  Result := '{"Result":"OK","Error":"","Data":[';

  i := 0;

  while not Q.EOF do
  begin

    if i>0 then
      Result := Result + ',';

    Result := Result +
      '{' +
      '"DT":"' + FormatDateTime('dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaRegistro').AsDateTime) + '",' +
      '"CodigoUsuario":' + IntToStr(Q.FieldByName('CodigoUsuario').AsInteger) + ',' +
      '"CodigoUbicacion":"' + JSON_Str(Q.FieldByName('CodigoUbicacion').AsString) + '",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"Cantidad":' + SQL_FloatToStr(Q.FieldByName('Cantidad').AsFloat) + ',' +
      '"CantidadBase":' + SQL_FloatToStr(Q.FieldByName('CantidadBase').AsFloat) + ',' +
      '"PickingIdAsignado":' + IntToStr(Q.FieldByName('PickingIdAsignado').AsInteger) + ',' +
      '"Saved":1' +
      '}';

    Inc(i);
    Q.Next;

  end;

  Q.Close;
  FreeAndNil(Q);

  Result := Result + ']}';

  {$ENDREGION}

end;


procedure WebModule1getDetallePartidasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iTotalRegsFiltered, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  sAgrupaciones: String;
  contentfields: TStringList;
  sPacking: String;
  Q2: TADOQuery;
  sDetallePartidas: String;
  CodigoArticulo: String;
  CodigoAgrupacion: Integer;
  bOnlyPending: Boolean;
  iLiniesCompletes: Integer;
  iLiniesStarted: Integer;
  PickingId: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  PickingId := StrToIntDef(Trim(contentfields.values['PickingId']),0);
  if PickingId = 0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de línea no especificado","Data":[]}';
    Exit;
  end;

  sSQL := 'SELECT ' +
          '  CodigoArticulo, CodigoAgrupacion ' +
          'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND PickingId = ' + IntToStr(PickingId);
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.SQL.Text := sSQL;
  Q.Open;

  if Q.Eof then
  begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de línea incorrecto","Data":[]}';
    Exit;
  end;

  CodigoArticulo   := Q.FieldByName('CodigoArticulo').AsString;
  CodigoAgrupacion := Q.FieldByName('CodigoAgrupacion').AsInteger;

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  // DETALL DE PARTIDES
  sSQL := 'SELECT ' +
          '  Partida, ' +
          '  SUM(Cantidad) AS CantidadPreparada, ' +
          '  SUM(CASE WHEN PickingId<>0 THEN Cantidad ELSE 0 END) AS CantidadExpedida ' +
          'FROM FS_SGA_AcumuladoPendiente WITH (NOLOCK) ' +
          'WHERE ' +
          '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion) + ' ' +
          'GROUP BY ' +
          '  Partida';

  Q2 := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q2.Open;
  except
  end;

  sDetallePartidas := '';
  while not Q2.EOF do
  begin

    if sDetallePartidas<>'' then
      sDetallePartidas := sDetallePartidas + ',';

    sDetallePartidas := sDetallePartidas +
      '{' +
      '"Partida":"' + JSON_Str(Q2.FieldByName('Partida').AsString) + '",' +
      '"CantidadPreparada":' + SQL_FloatToStr(Q2.FieldByName('CantidadPreparada').AsFloat) + ',' +
      '"CantidadExpedida":' + SQL_FloatToStr(Q2.FieldByName('CantidadExpedida').AsFloat) +
      '}';

    Q2.Next;

  end;

  SQL_CloseFree(Q2);

  Result := '{"Result":"OK","Error":"","Data":[';

  Result := Result + '{' +
                     '"Expedicion":[' + sDetallePartidas + ']' +
                     '}';

  Result := Result + ']';
  Result := Result + '}';

  {$ENDREGION}

end;


procedure WebModule1restartServiceAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  contentfields: TStringList;
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  Code: String;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  Code := contentfields.values['Code'];
  if Code<>FormatDateTime('yyyymmdd',date()) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código PIN de seguridad incorrecto","Data":[]}';
    Exit;
  end;

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'],0);
  UUID          := contentfields.Values['UUID'];

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'RESTART-SERVICE', 'Solicitud de reinicio del webservice', nil );
  gbFinalitzar := TRUE;
  Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1restorePaletMatriculaCajaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  contentfields: TStringList;
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoUsuario: Integer;
  IdPreparacion: Integer;
  CodigoUbicacion: String;
  EmpresaOrigen: Integer;
  DigitoSSCC: Integer;
  PrefijoEmpresaGS1: String;
  PackagingId: Integer;
  sSQL: String;
  Q: TADOQuery;
  YY: Integer;
  iNum: Integer;
  sPROC: String;
  proc: TADOStoredProc;
  SSCCGenerado: String;
  Estado: Integer;
  bError: Boolean;
  bExists: Boolean;
  sErrMsg: string;
  MatriculaActual: String;
  PaletActual: Integer;
  CajaActual: Integer;
  aUbicacion: TSGAUbicacion;
  CajaRef: string;
  CajaPackagingId: Integer;
  PaletRef: string;
  PaletPackagingId: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  IdPreparacion := StrToIntDef(contentfields.Values['IdPreparacion'], 0 );
  if IdPreparacion = 0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de preparación no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT ' +
    '  PaletActual, CajaActual, MatriculaActual ' +
    'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion);
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then
  begin
    Q.Close;
    FreeAndNil(Q);
    Result :=
      '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[{' +
      '"MatriculaActual":"",' +
      '"PaletActualPackagingId":0,' +
      '"CajaActualPackagingId":1,' +
      '"PaletRef":"(ninguno)",' +
      '"CajaRef":"(ninguna)"' +
      '}]}';
    Exit;
  end;

  MatriculaActual := Q.FieldByName('MatriculaActual').AsString;
  PaletActual     := Q.FieldByName('PaletActual').AsInteger;
  CajaActual     := Q.FieldByName('CajaActual').AsInteger;

  Q.Close;

  Q.Close;
  Q.SQL.Text :=
    'SELECT FSPLPP.*, FSPD.Dt_Nombre ' +
    'FROM FS_SGA_PackingList_PackagingPalet FSPLPP WITH (NOLOCK) ' +
    'INNER JOIN FS_SGA_PackagingDetalle FSPD WITH (NOLOCK) ' +
    'ON ' +
    '  FSPLPP.IdPackaging = FSPD.Dt_Id ' +
    'WHERE ' +
    '  FSPLPP.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND FSPLPP.IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND FSPLPP.IdPalet = ' + IntToStr(PaletActual) + ' ' +
    '  AND FSPLPP.Matricula = ''' + SQL_Str(MatriculaActual) + '''';
  Q.Open;
  if Q.EOF then
  begin
    Q.Close;
    Q.SQL.Text :=
      'SELECT FSP.PackagingId, FSPD.Dt_Nombre ' +
      'FROM FS_SGA_Palet FSP WITH (NOLOCK) ' +
      'INNER JOIN FS_SGA_PackagingDetalle FSPD WITH (NOLOCK) ' +
      'ON ' +
      '  FSP.PackagingId = FSPD.Dt_Id ' +
      'WHERE ' +
      '  FSP.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
      '  AND FSP.Matricula = ''' + SQL_Str(MatriculaActual) + '''';
    Q.Open;
    if Q.EOF then
    begin
      PaletRef := '(ninguno)';
      PaletPackagingId := 0;
    end else begin
      PaletRef := Q.FieldByName('Dt_Nombre').AsString;
      PaletPackagingId := Q.FieldByName('PackagingId').AsInteger;
    end;
  end else begin
    PaletRef := Q.FieldByName('Dt_Nombre').AsString;
    PaletPackagingId := Q.FieldByName('IdPackaging').AsInteger;
  end;

  if MatriculaActual<>'' then
  begin
    sSQL :=
      'SELECT CodigoUbicacionActual ' +
      'FROM FS_SGA_Palet FSP WITH (NOLOCK) ' +
      'WHERE ' +
      '  FSP.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
      '  AND FSP.Matricula = ''' + SQL_Str(MatriculaActual) + ''' ';
    Q.SQL.Text := sSQL;
    Q.Open;

    if Q.EOF then
    begin
      CodigoUbicacion := '';
    end else begin
      CodigoUbicacion := Q.FieldByName('CodigoUbicacionActual').AsString;
      CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
      aUbicacion      := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );
      CodigoUbicacion := aUbicacion.CodigoUbicacion;
    end;

  end;

  Q.Close;
  Q.SQL.Text :=
    'SELECT FSPLPC.*, FSPD.Dt_Nombre ' +
    'FROM FS_SGA_PackingList_PackagingCaja FSPLPC WITH (NOLOCK) ' +
    'INNER JOIN FS_SGA_PackagingDetalle FSPD WITH (NOLOCK) ' +
    'ON ' +
    '  FSPLPC.IdPackaging = FSPD.Dt_Id ' +
    'WHERE ' +
    '  FSPLPC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND FSPLPC.IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND FSPLPC.IdPalet = ' + IntToStr(PaletActual) + ' ' +
    '  AND FSPLPC.Matricula = ''' + SQL_Str(MatriculaActual) + ''' ' +
    '  AND FSPLPC.IdCaja = ' + IntToStr(CajaActual);
  Q.Open;
  if Q.EOF then
  begin
    CajaRef := '(ninguna)';
    CajaPackagingId := 0;
  end else begin
    CajaRef := Q.FieldByName('Dt_Nombre').AsString;
    CajaPackagingId := Q.FieldByName('IdPackaging').AsInteger;
  end;

  Result :=
    '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[{' +
    '"MatriculaActual":"' + JSON_Str(MatriculaActual) + '",' +
    '"PaletActual":' + IntToStr(PaletActual) + ', ' +
    '"CajaActual":' + IntToStr(CajaActual) + ', ' +
    '"PaletActualPackagingId":' + IntToStr(PaletPackagingId) + ',' +
    '"CajaActualPackagingId":' + IntToStr(CajaPackagingId) + ',' +
    '"PaletRef":"' + JSON_Str(PaletRef) + '",' +
    '"CajaRef":"' + JSON_Str(CajaRef) + '"';

  Q.Close;
  FreeAndNil(Q);

  if CodigoUbicacion<>'' then
  begin
    Result := Result +
      ',"Ubicacion":{' +
        '"CodigoUbicacion":"' + aUbicacion.CodigoUbicacion + '",' +
        '"CodigoAlternativo":"' + JSON_Str(aUbicacion.CodigoAlternativo) + '",' +
        '"CodigoUbicacionAlternativo":"' + JSON_Str(aUbicacion.CodigoAlternativo) + '",' +
        '"CodigoAlmacen":"' + JSON_Str(aUbicacion.CodigoAlmacen) + '",' +
        '"CodigoZona":"' + JSON_Str(aUbicacion.CodigoZona) + '",' +
        '"CodigoPasillo":"' + JSON_Str(aUbicacion.CodigoPasillo) + '",' +
        '"CodigoEstanteria":"' + JSON_Str(aUbicacion.CodigoEstanteria) + '",' +
        '"Altura":"' + JSON_Str(aUbicacion.Altura) + '",' +
        '"Fondo":"' + JSON_Str(aUbicacion.Fondo) + '",' +
        '"Matricula":"' + JSON_Str(MatriculaActual) + '"' +
      '}';
  end;

  Result := Result +
    '}]}';

  {$ENDREGION}

end;


procedure WebModule1findUbicacionMatriculaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  contentfields: TStringList;
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoUsuario: Integer;
  CodigoUbicacion: String;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  Matricula: String;
  aUbicacion: TSGAUbicacion;
  Estado: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  Matricula     := contentfields.Values['Matricula'];


  {$ENDREGION}

  {$REGION 'Recuperació de dades'}
  sSQL :=
    'SELECT CodigoUbicacionActual, Estado ' +
    'FROM FS_SGA_Palet FSP WITH (NOLOCK) ' +
    'WHERE ' +
    '  FSP.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '  AND FSP.Matricula = ''' + SQL_Str(Matricula) + ''' ';
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then
  begin
    CodigoUbicacion := '';
    Estado := 0;
  end else begin
    Estado          := Q.FieldByName('Estado').AsInteger;
    CodigoUbicacion := Q.FieldByName('CodigoUbicacionActual').AsString;
    CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
    aUbicacion      := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );
    CodigoUbicacion := aUbicacion.CodigoUbicacion;
  end;

  Q.Close;
  FreeAndNil(Q);

  Result :=
    '{' +
      '"CodigoUbicacion":"' + aUbicacion.CodigoUbicacion + '",' +
      '"CodigoAlternativo":"' + JSON_Str(aUbicacion.CodigoAlternativo) + '",' +
      '"CodigoUbicacionAlternativo":"' + JSON_Str(aUbicacion.CodigoAlternativo) + '",' +
      '"CodigoAlmacen":"' + JSON_Str(aUbicacion.CodigoAlmacen) + '",' +
      '"CodigoZona":"' + JSON_Str(aUbicacion.CodigoZona) + '",' +
      '"CodigoPasillo":"' + JSON_Str(aUbicacion.CodigoPasillo) + '",' +
      '"CodigoEstanteria":"' + JSON_Str(aUbicacion.CodigoEstanteria) + '",' +
      '"Altura":"' + JSON_Str(aUbicacion.Altura) + '",' +
      '"Fondo":"' + JSON_Str(aUbicacion.Fondo) + '",' +
      '"Matricula":"' + JSON_Str(Matricula) + '",' +
      '"Estado":' + IntToStr(Estado) +
    '}';

  {$ENDREGION}

end;


procedure WebModule1generateMatriculaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  contentfields: TStringList;
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoUsuario: Integer;
  CodigoUbicacion: String;
  EmpresaOrigen: Integer;
  DigitoSSCC: Integer;
  PrefijoEmpresaGS1: String;
  PackagingId: Integer;
  sSQL: String;
  Q: TADOQuery;
  YY: Integer;
  iNum: Integer;
  sPROC: String;
  proc: TADOStoredProc;
  SSCCGenerado: String;
  Estado: Integer;
  bError: Boolean;
  bExists: Boolean;
  sErrMsg: string;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario   := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID            := contentfields.Values['UUID'];
  CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);
  if CodigoUbicacion<>'' then
  begin
    // Conversió al codi d'ubicació real
    CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
  end;

  PackagingId := StrToIntDef(contentfields.Values['PackagingId'], -1 );
  if PackagingId=-1 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de packaging no especificado","Data":[]}';
    Exit;
  end;

  Estado := StrToIntDef(contentfields.Values['Estado'], 0 );

  sSQL :=
    'SELECT TOP 1 Dt_DigitoMatricula ' +
    'FROM FS_SGA_PackagingDetalle WITH (NOLOCK) ' +
    'WHERE ' +
    '  Dt_Id = ' + IntToStr(PackagingId);
  DigitoSSCC := SQL_Execute ( Conn, sSQL, bExists );
  if not bExists then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No existe el código de packaging especificado","Data":[]}';
    Exit;
  end;

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  sSQL :=
    'SELECT TOP 1 parametro_value ' +
    'FROM FS_SGA_Parametros WITH (NOLOCK) ' +
    'WHERE parametro_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
    'AND parametro_id = 114 ' +
    'ORDER BY parametro_CodigoEmpresa DESC';
  PrefijoEmpresaGS1 := SQL_Execute ( Conn, sSQL, bExists );
  if not bExists then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No existe el parámetro 114 en la base de datos","Data":[]}';
    Exit;
  end;

  if (Length(PrefijoEmpresaGS1)<7) or (Length(PrefijoEmpresaGS1)>10) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código GS1 del parámetro 114 debe tener entre 7 y 10 dígitos","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Generació de matrícula'}

  SSCCGenerado := FS_SGA_GenerarMatricula (
    Conn,
    CodigoEmpresa,
    YY,
    PrefijoEmpresaGS1,
    DigitoSSCC,
    sErrMsg
  );

  if sErrMsg<>'' then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(sErrMsg) + '","Data":[]}';
    Exit;
  end;

  sSQL :=
    'INSERT INTO FS_SGA_Palet ( CodigoEmpresa, Matricula, CodigoUbicacionActual, Estado, CodigoUsuario, ' +
    '  PesoNetoTotal, PesoBrutoTotal, VolumenTotal, PackagingId ) ' +
    'VALUES ( ' +
    IntToStr(CodigoEmpresa.Stocks) + ', ' +
    '''' + SQL_Str(SSCCGenerado) + ''', ' +
    '''' + SQL_Str(CodigoUbicacion) + ''', ' +
    IntToStr(Estado) + ', ' +
    IntToStr(CodigoUsuario) + ', ' +
    '0, 0, 0, ' +
    IntToStr(PackagingId) + ' ' +
    ')';

  try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(sErrMsg) + '","Data":[]}';
      Exit;
    end;
  end;

  LP := LOG_Clear();
  LP.Matricula := SSCCGenerado;

  if CodigoUbicacion<>'' then
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'GENERATE-PALLET', 'Generar matrícula de palet en ' + CodigoUbicacion, @LP )
  else
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'GENERATE-PALLET', 'Generar matrícula de palet', @LP );

  Result :=
    '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[{' +
    '"SSCCGenerado":"' + JSON_Str(SSCCGenerado) + '"' +
    '}]}';

  {$ENDREGION}

end;


procedure WebModule1articuloEnReposicionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  contentfields: TStringList;
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  CodigoAlmacen: String;
  CodigoArticulo: String;
  CodigoTalla: String;
  CodigoColor: String;
  UnidadMedida: String;
  sSQL: String;
  Q: TADOQuery;
  YY: Integer;
  iNum: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  CodigoAlmacen := contentfields.values['CodigoAlmacen'];
  if CodigoAlmacen='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    Exit;
  end;

  CodigoArticulo := contentfields.values['CodigoArticulo'];
  if CodigoArticulo='' then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );

  UnidadMedida := AnsiUpperCase(contentfields.values['UnidadMedida']);
  CodigoTalla  := contentfields.values['CodigoTalla'];
  CodigoColor  := contentfields.values['CodigoColor'];

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL :=
    'SELECT ' +
    '  COUNT(*) ' +
    'FROM FS_SGA_TABLE_ReposicionesAlmacen ( ' +
    IntToStr(CodigoEmpresa.Stocks) + ', ' +
    IntToStr(CodigoEmpresa.Articulos) + ', ' +
    IntToStr(CodigoEmpresa.GrupoTallas) + ', ' +
    IntToStr(CodigoEmpresa.Colores) + ', ' +
    IntToStr(CodigoEmpresa.CodigosTallaColor) + ', ' +
    IntToStr(YY) + ', ' +
    '''' + SQL_Str(CodigoAlmacen) + ''' ' +
    ') ' +
    'WHERE ' +
    '  CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
    '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
    '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
    '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + '''';

  iNum := SQL_Execute ( Conn, sSQL );

  if iNum=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El artículo no requiere reposición","Data":[]}';
  end else begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[]}';
  end;

  {$ENDREGION}

end;


procedure WebModule1getReposicionesAlmacenAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  contentfields: TStringList;
  CodigoEmpresa: TOrigenCodigoEmpresa;
  iTotalRegs, iTotalRegsFiltered, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  CodigoAlmacen: String;
  Segment: String;
  sSQL: String;
  Q: TADOQuery;
  YY: Integer;
  iRepoAlmacen: Integer;
  iRepoPicking: Integer;
  sPROC: String;
  sWhere: String;
  JSonUnidadesMedida: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  Segment := AnsiUpperCase(contentfields.values['Segment']);
  if Segment='' then
    Segment := 'TODAS';

  CodigoAlmacen := contentfields.values['CodigoAlmacen'];
  if CodigoAlmacen='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    Exit;
  end;

  if Segment='TODAS' then
    sWhere := ''
  else if Segment='CON STOCK' then
    sWhere := ' AND StockOtrosAlmacenesBase > 0 '
  else
    sWhere := ' AND StockOtrosAlmacenesBase = 0 ';



  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL :=
    'SELECT ' +
    '  COUNT(*) ' +
    'FROM FS_SGA_TABLE_ReposicionesAlmacen ( ' +
    IntToStr(CodigoEmpresa.Stocks) + ', ' +
    IntToStr(CodigoEmpresa.Articulos) + ', ' +
    IntToStr(CodigoEmpresa.GrupoTallas) + ', ' +
    IntToStr(CodigoEmpresa.Colores) + ', ' +
    IntToStr(CodigoEmpresa.CodigosTallaColor) + ', ' +
    IntToStr(YY) + ', ' +
    '''' + SQL_Str(CodigoAlmacen) + ''' ' +
    ') ' +
    'WHERE 1 = 1 ' +
    sWhere;
  iTotalRegs := SQL_Execute ( Conn, sSQL );

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  if SQL_Function_Exists ( Conn, 'FS_SGA_TABLE_ReposicionesAlmacen', sPROC ) then
  begin

    sSQL :=
      'SELECT ' +
      '  * ' +
      'FROM [dbo].[' + sPROC + '] ( ' +
      IntToStr(CodigoEmpresa.Stocks) + ', ' +
      IntToStr(CodigoEmpresa.Articulos) + ', ' +
      IntToStr(CodigoEmpresa.GrupoTallas) + ', ' +
      IntToStr(CodigoEmpresa.Colores) + ', ' +
      IntToStr(CodigoEmpresa.CodigosTallaColor) + ', ' +
      IntToStr(YY) + ', ' +
      '''' + SQL_Str(CodigoAlmacen) + ''' ' +
      ') ' +
      'WHERE 1 = 1 ' +
      sWhere +
      'ORDER BY ' +
      '  CodigoArticulo ' +
      'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
      'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.EOF do
  begin

    JSonUnidadesMedida := SGA_FS_ARTICULO_Obtener_UnidadesMedida (
      Conn,
      CodigoEmpresa,
      Q.FieldByName('CodigoArticulo').AsString
    );

    if iNumRegs>0 then
      Result := Result + ',';

    Result := Result +
      '{' +
      '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
      '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"CodigoAlternativo2":"' + JSON_Str(Q.FieldByName('CodigoAlternativo2').AsString) + '",' +
      '"CodigoAlternativoTC":"' + JSON_Str(Q.FieldByName('CodigoAlternativoTC').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"Descripcion2Articulo":"' + JSON_Str(Q.FieldByName('Descripcion2Articulo').AsString) + '",' +
      '"GrupoTalla":' + IntToStr(Q.FieldByName('GrupoTalla_').AsInteger) + ',' +
      '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
      '"DescripcionTalla":"' + JSON_Str(Q.FieldByName('DescripcionTalla').AsString) + '",' +
      '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
      '"DescripcionColor":"' + JSON_Str(Q.FieldByName('DescripcionColor').AsString) + '",' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion_').AsFloat) + ',' +
      '"TratamientoPartidas":' + SQL_BooleanToStr(Q.FieldByName('TratamientoPartidas').AsInteger<>0) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('Colores_').AsInteger<>0) + ',' +
      '"CodigoAgrupacion":0,' +
      '"UnidadesAgrupacion":1,' +
      '"UnidadesSaldo":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldo').AsFloat) + ',' +
      '"UnidadesSaldoBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldoBase').AsFloat) + ',' +
      '"StockMinimo":' + SQL_FloatToStr(Q.FieldByName('StockMinimo').AsFloat) + ',' +
      '"StockMaximo":' + SQL_FloatToStr(Q.FieldByName('StockMaximo').AsFloat) + ',' +
      '"StockMinimoBase":' + SQL_FloatToStr(Q.FieldByName('StockMinimoBase').AsFloat) + ',' +
      '"StockMaximoBase":' + SQL_FloatToStr(Q.FieldByName('StockMaximoBase').AsFloat) + ',' +
      JSonUnidadesMedida +
      '}';

    Inc(iNumRegs);
    Q.Next;

  end;

  Result := Result +
    ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


procedure WebModule1getReposicionesCountAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  contentfields: TStringList;
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  CodigoAlmacen: String;
  sSQL: String;
  Q: TADOQuery;
  YY: Integer;
  iRepoAlmacen: Integer;
  iRepoPicking: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  CodigoAlmacen := contentfields.values['CodigoAlmacen'];
  if CodigoAlmacen='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL :=
    'SELECT ' +
    '  COUNT(*) ' +
    'FROM FS_SGA_TABLE_ReposicionesAlmacen ( ' +
    IntToStr(CodigoEmpresa.Stocks) + ', ' +
    IntToStr(CodigoEmpresa.Articulos) + ', ' +
    IntToStr(CodigoEmpresa.GrupoTallas) + ', ' +
    IntToStr(CodigoEmpresa.Colores) + ', ' +
    IntToStr(CodigoEmpresa.CodigosTallaColor) + ', ' +
    IntToStr(YY) + ', ' +
    '''' + SQL_Str(CodigoAlmacen) + ''' ' +
    ')';

  iRepoAlmacen := SQL_Execute ( Conn, sSQL );
  iRepoPicking := 0;

  Result :=
    '{"Result":"OK","Error":"","TotalRecords":1,"NumPages":1,"Data":[{' +
    '"NumRepoAlmacen":' + IntToStr(iRepoAlmacen) + ',' +
    '"NumRepoPicking":' + IntToStr(iRepoPicking) +
    '}]}';

  {$ENDREGION}

end;



procedure WebModule1detalleExpedicionTCAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  PickingId: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iTotalRegsFiltered, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  sAgrupaciones: String;
  contentfields: TStringList;
  sPacking: String;
  Q2: TADOQuery;
  sDetallePartidas: String;
  CodigoArticulo: String;
  CodigoAgrupacion: Integer;
  bOnlyPending: Boolean;
  iLiniesCompletes: Integer;
  iLiniesStarted: Integer;
  Estado: Integer;
  bMultiPedido: Boolean;
  fUnidadesAgrupacion: Double;
  CodigoTalla: string;
  CodigoColor: string;
  iCurrentIndex: Integer;
  bSepararPorLinea: Boolean;
  UnidadMedida: String;
  UnidadMedidaBase: String;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  PickingId := StrToIntDef(contentfields.values['PickingId'],0);

  bOnlyPending := (StrToIntDef(contentfields.values['OnlyPending'],0)<>0);

  CodigoArticulo := contentfields.values['CodigoArticulo'];
  CodigoTalla    := contentfields.values['CodigoTalla'];
  CodigoColor    := contentfields.values['CodigoColor'];

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_DesglosarPreparacionesPorLinea, bSepararPorLinea, CodigoEmpresa.EmpresaOrigen );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'INNER JOIN LineasPedidoCliente lpc WITH (NOLOCK) ' +
          'ON ' +
          '  fsppl.CodigoEmpresa = lpc.CodigoEmpresa ' +
          '  AND fsppl.EjercicioPedido = lpc.EjercicioPedido ' +
          '  AND fsppl.SeriePedido = lpc.SeriePedido ' +
          '  AND fsppl.NumeroPedido = lpc.NumeroPedido ' +
          '  AND fsppl.LineasPosicion = lpc.LineasPosicion ' +
          'WHERE ' +
          '  fsppl.PreparacionId = ' + IntToStr(IdPreparacion) + ' ';

  if PickingId<>0 then
  begin
    sSQL := sSQL +
      'AND fsppl.PickingId = ' + IntToStr(PickingId) + ' ';
  end;

  if CodigoArticulo<>'' then
  begin
    sSQL := sSQL +
      'AND fsppl.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
      'AND fsppl.CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
      'AND fsppl.CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ';
  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  if bOnlyPending then
  begin
    sSQL := sSQL + '  AND fsppl.UdSaldoBase>0';
  end;

  try
    iTotalRegsFiltered := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  // Línies ja completes
  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'INNER JOIN LineasPedidoCliente lpc WITH (NOLOCK) ' +
          'ON ' +
          '  fsppl.CodigoEmpresa = lpc.CodigoEmpresa ' +
          '  AND fsppl.EjercicioPedido = lpc.EjercicioPedido ' +
          '  AND fsppl.SeriePedido = lpc.SeriePedido ' +
          '  AND fsppl.NumeroPedido = lpc.NumeroPedido ' +
          '  AND fsppl.LineasPosicion = lpc.LineasPosicion ' +
          'WHERE ' +
          '  fsppl.PreparacionId = ' + IntToStr(IdPreparacion) +
          '  AND fsppl.UdSaldo<=0 ';

  if PickingId<>0 then
  begin
    sSQL := sSQL +
      'AND PickingId = ' + IntToStr(PickingId) + ' ';
  end;

  if CodigoArticulo<>'' then
  begin
    sSQL := sSQL +
      'AND fsppl.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
      'AND fsppl.CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
      'AND fsppl.CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ';
  end;

  try
    iLiniesCompletes := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  // Línies començades
  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'INNER JOIN LineasPedidoCliente lpc WITH (NOLOCK) ' +
          'ON ' +
          '  fsppl.CodigoEmpresa = lpc.CodigoEmpresa ' +
          '  AND fsppl.EjercicioPedido = lpc.EjercicioPedido ' +
          '  AND fsppl.SeriePedido = lpc.SeriePedido ' +
          '  AND fsppl.NumeroPedido = lpc.NumeroPedido ' +
          '  AND fsppl.LineasPosicion = lpc.LineasPosicion ' +
          'WHERE ' +
          '  fsppl.PreparacionId = ' + IntToStr(IdPreparacion) +
          '  AND fsppl.UdExpedidas>0 ';

  if PickingId<>0 then
  begin
    sSQL := sSQL +
      'AND fsppl.PickingId = ' + IntToStr(PickingId) + ' ';
  end;

  if CodigoArticulo<>'' then
  begin
    sSQL := sSQL +
      'AND fsppl.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
      'AND fsppl.CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
      'AND fsppl.CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ';
  end;

  try
    iLiniesStarted := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  Estado := SGA_GetEstadoPreparacion ( Conn, IdPreparacion );
  sPacking := '';

  (*
  sSQL :=
    'SELECT ' +
    '  fsppl.PickingId, fsppl.IdentificadorExpedicion, fsppl.CodigoEmpresa, fsppl.EjercicioPedido, fsppl.SeriePedido, ' +
    '  fsppl.NumeroPedido, fsppl.OrdenLineaPedido, fsppl.LineasPosicion, ' +
    '  fsppl.UnidadMedida, fsppl.UnidadMedidaBase, fsppl.BloqueoRebaje_, fsppl.LineasPosicionCompuesto, ' +
    '  fsppl.UdNecesarias, fsppl.UdNecesariasBase, fsppl.UdRetiradas, fsppl.UdRetiradasBase, ' +
    '  fsppl.UdExpedidas, fsppl.UdExpedidasBase, ' +
    '  fsppl.CodigoArticulo, fsppl.DescripcionArticulo, fsppl.FactorConversion, ' +
    '  fsppl.Partida, fsppl.PreparacionId, fsppl.CodigoCliente, fsppl.RazonSocial, ' +
    '  fsppl.LineaPedidoTalla, fsppl.OrdenDetalleTalla, ' +
    '  art.TratamientoPartidas, art.CodigoAlternativo, art.CodigoAlternativo2, CTC.CodigoAlternativo AS CodigoAlternativoTC, ' +
    '  fsppl.CodigoTalla01_, fsppl.CodigoColor_, art.GrupoTalla_, ' +
    '  T.DescripcionTalla01_ as DescripcionTalla, C.Color_ AS DescripcionColor, ' +
    '  fsppl.CodigoAgrupacion, fsppl.UnidadesAgrupacion, ISNULL(agrup.DescripcionArticulo, ''Unidades'') as Agrupacion, ' +
    '  USADAS.Cantidad AS UdUsadas, USADAS.CantidadBase AS UdUsadasBase, ISNULL(fspl.CajaActual,1) AS CajaActual, ' +
    '  art.Colores_ AS TratamientoColores ' +
    'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
    'INNER JOIN LineasPedidoCliente lpc WITH (NOLOCK) ' +
    'ON ' +
    '  fsppl.CodigoEmpresa = lpc.CodigoEmpresa ' +
    '  AND fsppl.EjercicioPedido = lpc.EjercicioPedido ' +
    '  AND fsppl.SeriePedido = lpc.SeriePedido ' +
    '  AND fsppl.NumeroPedido = lpc.NumeroPedido ' +
    '  AND fsppl.LineasPosicion = lpc.LineasPosicion ';

  if bSepararPorLinea then
  begin

    sSQL := sSQL +
      'LEFT JOIN ( ' +
      '  SELECT LineaPedidoAsignada, CodigoArticulo, CodigoTalla01_, CodigoColor_, UnidadMedida, ' +
      '  SUM(Cantidad) AS Cantidad, SUM(CantidadBase) AS CantidadBase ' +
      '  FROM FS_SGA_AcumuladoPendiente WITH (NOLOCK) ' +
      '  WHERE ' +
      '    IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
      '    AND LineaPedidoCliente <> ''' + SQL_Str(GUID0) + ''' ' +
      '  GROUP BY LineaPedidoAsignada, CodigoArticulo, CodigoTalla01_, CodigoColor_, UnidadMedida ) USADAS ' +
      'ON '+
      '  USADAS.CodigoArticulo = fsppl.CodigoArticulo ' +
      '  AND USADAS.CodigoTalla01_ = fsppl.CodigoTalla01_ ' +
      '  AND USADAS.CodigoColor_ = fsppl.CodigoColor_ ' +
      '  AND USADAS.UnidadMedida = fsppl.UnidadMedida ' +
      '  AND USADAS.LineaPedidoAsignada = fsppl.LineasPosicion ';

  end else begin

    sSQL := sSQL +
      'LEFT JOIN ( ' +
      '  SELECT CodigoArticulo, CodigoTalla01_, CodigoColor_, UnidadMedida, ' +
      '  SUM(Cantidad) AS Cantidad, SUM(CantidadBase) AS CantidadBase ' +
      '  FROM FS_SGA_AcumuladoPendiente WITH (NOLOCK) ' +
      '  WHERE ' +
      '    IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
      '    AND LineaPedidoCliente <> ''' + SQL_Str(GUID0) + ''' ' +
      '  GROUP BY CodigoArticulo, CodigoTalla01_, CodigoColor_, UnidadMedida ) USADAS ' +
      'ON '+
      '  USADAS.CodigoArticulo = fsppl.CodigoArticulo ' +
      '  AND USADAS.CodigoTalla01_ = fsppl.CodigoTalla01_ ' +
      '  AND USADAS.CodigoColor_ = fsppl.CodigoColor_ ' +
      '  AND USADAS.UnidadMedida = fsppl.UnidadMedida ';

  end;

  sSQL := sSQL +
    'INNER JOIN FS_SGA_Picking_Preparaciones fspp WITH (NOLOCK) ' +
    'ON ' +
    '  fspp.PreparacionId = fsppl.PreparacionId ' +
    'LEFT JOIN FS_COMMON_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
    'ON ' +
    '  fsppl.codigoarticulo = art.codigoarticulo ' +
    'LEFT JOIN Agrupaciones agrup WITH (NOLOCK) ' +
    'ON ' +
    '  agrup.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones)+ ' ' +
    '  AND agrup.CodigoArticulo = fsppl.CodigoArticulo ' +
    '  AND agrup.CodigoAgrupacion = fsppl.CodigoAgrupacion ' +
    'LEFT JOIN Colores_ C WITH (NOLOCK) ' +
    'ON ' +
    '  C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
    '  AND C.CodigoColor_ = fsppl.CodigoColor_ ' +
    'LEFT JOIN Vis_VistaTallas T WITH (NOLOCK) ' +
    'ON ' +
    '  T.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
    '  AND T.GrupoTalla_= art.GrupoTalla_ ' +
    '  AND T.CodigoTalla01_ = fsppl.CodigoTalla01_ ' +
    'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
    'ON ' +
    '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
    '  AND CTC.CodigoArticulo = fsppl.CodigoArticulo ' +
    '  AND CTC.CodigoTalla01_ = fsppl.CodigoTalla01_ ' +
    '  AND CTC.CodigoColor_ = fsppl.CodigoColor_ ' +
    'LEFT JOIN ( ' +
    '  SELECT CodigoEmpresa, PreparacionId, IdentificadorExpedicion, MAX(CajaId) AS CajaActual ' +
    '  FROM FS_SGA_PACKINGLIST fspl WITH (NOLOCK) ' +
    '  WHERE UnidadesBase > 0 ' +
    '  GROUP BY CodigoEmpresa, PreparacionId, IdentificadorExpedicion ' +
    ') fspl ' +
    'ON ' +
    '  fspl.CodigoEmpresa = fsppl.CodigoEmpresa ' +
    '  AND fspl.PreparacionId = fsppl.PreparacionId ' +
    '  AND fspl.IdentificadorExpedicion = fsppl.IdentificadorExpedicion ' +
    'WHERE ' +
    '  fsppl.PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND (art.TipoArticulo = ''M'' ' +
    '    OR fsppl.LineasPosicionCompuesto=''00000000-0000-0000-0000-000000000001'') ';

  if PickingId<>0 then
  begin
    sSQL := sSQL +
      'AND fsppl.PickingId = ' + IntToStr(PickingId) + ' ';
  end;

  if CodigoArticulo<>'' then
  begin
    sSQL := sSQL +
      'AND fsppl.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
      'AND fsppl.CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
      'AND fsppl.CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ';
  end;

  if bOnlyPending then
  begin
    sSQL := sSQL + '  AND fsppl.UdSaldoBase>0';
  end;

  sSQL := sSQL +
    'ORDER BY ' +
    //'  case when UdNecesariasBase - UdExpedidasBase <= 0 THEN 99999 ELSE 0 END, ' +
    '  fsppl.IdentificadorExpedicion, ' +
    '  fsppl.OrdenLineaPedido, fsppl.FechaRegistro, ' +
    '  fsppl.LineasPosicionCompuesto, fsppl.Codigoarticulo ' + //, fsap.Partida ' +
    'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
    'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';
  *)

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'art', '' );

  sSQL :=
    'SELECT ' +
    '  fsppl.PickingId, fsppl.IdentificadorExpedicion, fsppl.CodigoEmpresa, fsppl.EjercicioPedido, fsppl.SeriePedido, ' +
    '  fsppl.NumeroPedido, fsppl.OrdenLineaPedido, fsppl.LineasPosicion, ' +
    '  fsppl.UnidadMedida, fsppl.UnidadMedidaBase, fsppl.BloqueoRebaje_, fsppl.LineasPosicionCompuesto, ' +
    '  fsppl.UdNecesarias, fsppl.UdNecesariasBase, fsppl.UdRetiradas, fsppl.UdRetiradasBase, ' +
    '  fsppl.UdExpedidas, fsppl.UdExpedidasBase, ' +
    '  fsppl.CodigoArticulo, fsppl.DescripcionArticulo, fsppl.FactorConversion, ' +
    '  fsppl.Partida, fsppl.PreparacionId, fsppl.CodigoCliente, fsppl.RazonSocial, ' +
    '  fsppl.LineaPedidoTalla, fsppl.OrdenDetalleTalla, ' +
    '  art.TratamientoPartidas, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc, art.CodigoAlternativo, art.CodigoAlternativo2, ' +
    '  CTC.CodigoAlternativo AS CodigoAlternativoTC, ' +
    '  fsppl.CodigoTalla01_, fsppl.CodigoColor_, art.GrupoTalla_, ' +
    '  T.DescripcionTalla01_ as DescripcionTalla, C.Color_ AS DescripcionColor, ' +
    '  fsppl.CodigoAgrupacion, fsppl.UnidadesAgrupacion, ISNULL(agrup.Agrupacion, ''Unidades'') as Agrupacion, ' +
    '  USADAS.Cantidad AS UdUsadas, USADAS.CantidadBase AS UdUsadasBase, ' +
    '  ISNULL(fspl_last.CajaActual,1) AS CajaActual, ' + // <— canvia fspl per fspl_last
    '  art.Colores_ AS TratamientoColores ' +
    'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
    'INNER JOIN LineasPedidoCliente lpc WITH (NOLOCK) ' +
    'ON ' +
    '  fsppl.CodigoEmpresa = lpc.CodigoEmpresa ' +
    '  AND fsppl.EjercicioPedido = lpc.EjercicioPedido ' +
    '  AND fsppl.SeriePedido = lpc.SeriePedido ' +
    '  AND fsppl.NumeroPedido = lpc.NumeroPedido ' +
    '  AND fsppl.LineasPosicion = lpc.LineasPosicion ';

  if bSepararPorLinea then
  begin
    sSQL := sSQL +
      'LEFT JOIN ( ' +
      '  SELECT LineaPedidoAsignada, CodigoArticulo, CodigoTalla01_, CodigoColor_, UnidadMedida, ' +
      '         SUM(Cantidad) AS Cantidad, SUM(CantidadBase) AS CantidadBase ' +
      '  FROM FS_SGA_AcumuladoPendiente WITH (NOLOCK) ' +
      '  WHERE IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
      '    AND LineaPedidoCliente <> ''' + SQL_Str(GUID0) + ''' ' +
      '  GROUP BY LineaPedidoAsignada, CodigoArticulo, CodigoTalla01_, CodigoColor_, UnidadMedida ' +
      ') USADAS ' +
      'ON USADAS.CodigoArticulo = fsppl.CodigoArticulo ' +
      ' AND USADAS.CodigoTalla01_ = fsppl.CodigoTalla01_ ' +
      ' AND USADAS.CodigoColor_ = fsppl.CodigoColor_ ' +
      ' AND USADAS.UnidadMedida = fsppl.UnidadMedida ' +
      ' AND USADAS.LineaPedidoAsignada = fsppl.LineasPosicion ';
  end
  else
  begin
    sSQL := sSQL +
      'LEFT JOIN ( ' +
      '  SELECT CodigoArticulo, CodigoTalla01_, CodigoColor_, UnidadMedida, ' +
      '         SUM(Cantidad) AS Cantidad, SUM(CantidadBase) AS CantidadBase ' +
      '  FROM FS_SGA_AcumuladoPendiente WITH (NOLOCK) ' +
      '  WHERE IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
      '    AND LineaPedidoCliente <> ''' + SQL_Str(GUID0) + ''' ' +
      '  GROUP BY CodigoArticulo, CodigoTalla01_, CodigoColor_, UnidadMedida ' +
      ') USADAS ' +
      'ON USADAS.CodigoArticulo = fsppl.CodigoArticulo ' +
      ' AND USADAS.CodigoTalla01_ = fsppl.CodigoTalla01_ ' +
      ' AND USADAS.CodigoColor_ = fsppl.CodigoColor_ ' +
      ' AND USADAS.UnidadMedida = fsppl.UnidadMedida ';
  end;

  sSQL := sSQL +
    'INNER JOIN FS_SGA_Picking_Preparaciones fspp WITH (NOLOCK) ' +
    '  ON fspp.PreparacionId = fsppl.PreparacionId ' +
    'LEFT JOIN FS_COMMON_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
    '  ON fsppl.codigoarticulo = art.codigoarticulo ' +
    'LEFT JOIN Agrupaciones agrup WITH (NOLOCK) ' +
    '  ON agrup.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones)+ ' ' +
    ' AND agrup.CodigoArticulo = fsppl.CodigoArticulo ' +
    ' AND agrup.CodigoAgrupacion = fsppl.CodigoAgrupacion ' +
    'LEFT JOIN Colores_ C WITH (NOLOCK) ' +
    '  ON C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
    ' AND C.CodigoColor_ = fsppl.CodigoColor_ ' +
    'LEFT JOIN Vis_VistaTallas T WITH (NOLOCK) ' +
    '  ON T.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
    ' AND T.GrupoTalla_ = art.GrupoTalla_ ' +
    ' AND T.CodigoTalla01_ = fsppl.CodigoTalla01_ ' +
    'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
    '  ON CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
    ' AND CTC.CodigoArticulo = fsppl.CodigoArticulo ' +
    ' AND CTC.CodigoTalla01_ = fsppl.CodigoTalla01_ ' +
    ' AND CTC.CodigoColor_ = fsppl.CodigoColor_ ' +
    // ▼▼ OUTER APPLY substitueix el LEFT JOIN amb MAX(CajaId)
    'OUTER APPLY ( ' +
    '   SELECT TOP (1) fspl.CajaId AS CajaActual ' +
    '   FROM FS_SGA_PACKINGLIST fspl WITH (NOLOCK) ' +
    '   WHERE fspl.CodigoEmpresa = fsppl.CodigoEmpresa ' +
    '     AND fspl.PreparacionId = fsppl.PreparacionId ' +
    '     AND fspl.IdentificadorExpedicion = fsppl.IdentificadorExpedicion ' +
    '     AND fspl.UnidadesBase > 0 ' +
    '   ORDER BY fspl.CajaId DESC ' +
    ') fspl_last ' + // ▲▲ fi OUTER APPLY
    'WHERE ' +
    '  fsppl.PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND (art.TipoArticulo = ''M'' ' +
    '       OR fsppl.LineasPosicionCompuesto = ''00000000-0000-0000-0000-000000000001'') ';

  if PickingId <> 0 then
  begin
    sSQL := sSQL +
      'AND fsppl.PickingId = ' + IntToStr(PickingId) + ' ';
  end;

  if CodigoArticulo <> '' then
  begin
    sSQL := sSQL +
      'AND fsppl.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
      'AND fsppl.CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
      'AND fsppl.CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ';
  end;

  if bOnlyPending then
  begin
    sSQL := sSQL + 'AND fsppl.UdSaldoBase > 0 ';
  end;

  sSQL := sSQL +
    'ORDER BY ' +
    '  fsppl.IdentificadorExpedicion, ' +
    '  fsppl.OrdenLineaPedido, fsppl.FechaRegistro, ' +
    '  fsppl.LineasPosicionCompuesto, fsppl.CodigoArticulo ' +
    'OFFSET ' + IntToStr(iPage * iPageSize) + ' ROWS ' +
    'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';


  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', CONST_LOGID_SGA, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) +
            ',"RecordsStarted":' + IntToStr(iLiniesStarted) + ',"TotalRecordsFiltered":' + IntToStr(iTotalRegsFiltered) + ',"LineasCompletas":' + IntToStr(iLiniesCompletes) + ',"Data":[';
  iNumRegs := 0;
  iCurrentIndex := 0;

  while not Q.Eof do begin

    CodigoArticulo   := Q.FieldByName('CodigoArticulo').AsString;
    CodigoAgrupacion := Q.FieldByName('CodigoAgrupacion').AsInteger;

    // AGRUPACIONS DE L'ARTICLE
    sSQL := 'SELECT ' +
            '  0 AS CodigoAgrupacion, ''Sin agrupar'' as Agrupacion, CodigoArticulo AS CodigoAlternativo, ' +
            '  UnidadMedida2_ as UnidadMedidaAgrupacion, 1 as UnidadesAgrupacion ' +
            'FROM Articulos WITH (NOLOCK)' +
            'WHERE ' +
            '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
            '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            'UNION ' +
            'SELECT ' +
            '  CodigoAgrupacion, Agrupacion, CodigoAlternativo, ' +
            '  UnidadMedida1_ AS UnidadMedidaAgrupacion, UnidadesAgrupacion ' +
            'FROM Agrupaciones WITH (NOLOCK) ' +
            'WHERE ' +
            '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
            '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            'ORDER BY ' +
            '  CodigoAgrupacion';

    Q2 := SQL_PrepareQuery ( Conn, sSQL );
    try
      Q2.Open;
    except
    end;

    sAgrupaciones := '';
    while not Q2.EOF do
    begin

      if sAgrupaciones<>'' then
        sAgrupaciones := sAgrupaciones + ',';

      sAgrupaciones := sAgrupaciones +
        '{' +
        '"CodigoAgrupacion":' + IntToStr(Q2.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
        '"Agrupacion":"' + JSON_Str(Q2.FieldByName('Agrupacion').AsString) + '",' +
        '"CodigoAlternativo":"' + JSON_Str(Q2.FieldByName('CodigoAlternativo').AsString) + '",' +
        '"UnidadMedidaAgrupacion":"' + JSON_Str(AnsiUpperCase(Q2.FieldByName('UnidadMedidaAgrupacion').AsString)) + '",' +
        '"UnidadesAgrupacion":' + SQL_FloatToStr(Q2.FieldByName('UnidadesAgrupacion').AsFloat) +
        '}';

      Q2.Next;

    end;

    // DETALL DE PARTIDES
    sSQL := 'SELECT ' +
            '  fsap.Partida, ' +
            '  fsap.CodigoTalla01_, ' +
            '  fsap.CodigoColor_, ' +
            '  SUM(fsap.Cantidad) AS CantidadPreparada, ' +
            '  SUM(CASE WHEN fsap.PickingId<>0 THEN fsap.Cantidad ELSE 0 END) AS CantidadExpedida ' +
            'FROM FS_SGA_AcumuladoPendiente fsap WITH (NOLOCK) ' +
            'INNER JOIN Articulos art WITH (NOLOCK) ' +
            'ON ' +
            '  art.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
            '  AND art.CodigoArticulo = fsap.CodigoArticulo ' +
            'LEFT JOIN Colores_ C WITH (NOLOCK) ' +
            'ON ' +
            '  C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
            '  AND C.CodigoColor_ = fsap.CodigoColor_ ' +
            'LEFT JOIN Vis_VistaTallas T WITH (NOLOCK) ' +
            'ON ' +
            '  T.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
            '  AND T.GrupoTalla_= art.GrupoTalla_ ' +
            '  AND T.CodigoTalla01_ = fsap.CodigoTalla01_ ' +
            'WHERE ' +
            '  fsap.IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
            '  AND fsap.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND fsap.CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
            '  AND fsap.CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
            '  AND fsap.CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion) + ' ' +
            '  AND LineaPedidoAsignada IN ( ' +
            '    ''00000000-0000-0000-0000-000000000000'' , ''' + SQL_GUID_ToStr(Q.FieldByName('LineasPosicion').AsString) + ''' ' +
            '  ) ' +
            'GROUP BY ' +
            '  fsap.Partida, fsap.CodigoTalla01_, fsap.CodigoColor_';

    Q2 := SQL_PrepareQuery ( Conn, sSQL );
    try
      //Q2.Open;
    except
    end;

    sDetallePartidas := '';
    while not Q2.EOF do
    begin

      if sDetallePartidas<>'' then
        sDetallePartidas := sDetallePartidas + ',';

      sDetallePartidas := sDetallePartidas +
        '{' +
        '"Partida":"' + JSON_Str(Q2.FieldByName('Partida').AsString) + '",' +
        '"CodigoTalla":"' + JSON_Str(Q2.FieldByName('CodigoTalla01_').AsString) + '",' +
        '"CodigoColor":"' + JSON_Str(Q2.FieldByName('CodigoColor_').AsString) + '",' +
        '"CantidadPreparada":' + SQL_FloatToStr(Q2.FieldByName('CantidadPreparada').AsFloat) + ',' +
        '"CantidadExpedida":' + SQL_FloatToStr(Q2.FieldByName('CantidadExpedida').AsFloat) +
        '}';

      Q2.Next;

    end;

    SQL_CloseFree(Q2);

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    fUnidadesAgrupacion := Q.FieldByName('UnidadesAgrupacion').AsFloat;
    if fUnidadesAgrupacion=0 then
      fUnidadesAgrupacion := 1;

    if Q.FieldByName('UdNecesariasBase').AsFloat - Q.FieldByName('UdExpedidasBase').AsFloat <= 0 then
      iCurrentIndex := iCurrentIndex + 1;

    UnidadMedida     := AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString);
    UnidadMedidaBase := AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString);

    if (UnidadMedida<>'') and (UnidadMedidaBase='') then
    begin
      UnidadMedidaBase := UnidadMedida;
    end;

    Result := Result +
      '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
      '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
      '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
      '"CodigoCliente":"' + JSON_Str(Q.FieldByName('CodigoCliente').AsString) + '",' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"Orden":' + Q.FieldByName('OrdenLineaPedido').AsString + ',' +
      '"LineasPosicion":"' + SQL_GUID_ToStr(Q.FieldByName('LineasPosicion').AsString) + '",' +
      '"CodigoArticulo":"' + JSON_Str(CodigoArticulo) + '",' +
      '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"CodigoAlternativo2":"' + JSON_Str(Q.FieldByName('CodigoAlternativo2').AsString) + '",' +
      '"CodigoAlternativoTC":"' + JSON_Str(Q.FieldByName('CodigoAlternativoTC').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('TratamientoColores').AsInteger<>0) + ',' +
      '"TratamientoPartidas":' + SQL_BooleanToStr(Q.FieldByName('TratamientoPartidas').AsInteger<>0) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"PickingId":' + Q.FieldByName('PickingId').AsString + ',' +
      '"IdentificadorExpedicion":' + Q.FieldByName('IdentificadorExpedicion').AsString + ',' +
      '"UnidadMedida":"' + JSON_Str(UnidadMedida) + '",' +
      '"UnidadMedidaBase":"' + JSON_Str(UnidadMedidaBase) + '",' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion').AsFloat) + ',' +
      '"UdNecesarias":' + SQL_FloatToStr(Q.FieldByName('UdNecesarias').AsFloat) + ',' +
      '"UdRetiradas":' + SQL_FloatToStr(Q.FieldByName('UdRetiradas').AsFloat) + ',' +
      '"UdExpedidas":' + SQL_FloatToStr(Q.FieldByName('UdExpedidas').AsFloat) + ',' +
      '"UdNecesariasBase":' + SQL_FloatToStr(Q.FieldByName('UdNecesariasBase').AsFloat) + ',' +
      '"UdRetiradasBase":' + SQL_FloatToStr(Q.FieldByName('UdRetiradasBase').AsFloat) + ',' +
      '"UdExpedidasBase":' + SQL_FloatToStr(Q.FieldByName('UdExpedidasBase').AsFloat) + ',' +
      '"UdUsadas":' + SQL_FloatToStr(Q.FieldByName('UdUsadas').AsFloat) + ',' +
      '"UdUsadasBase":' + SQL_FloatToStr(Q.FieldByName('UdUsadasBase').AsFloat) + ',' +
      '"Expedicion":[' + sDetallePartidas + '],' +
      '"GrupoTalla":' + IntToStr(Q.FieldByName('GrupoTalla_').AsInteger) + ',' +
      '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
      '"DescripcionTalla":"' + JSON_Str(Q.FieldByName('DescripcionTalla').AsString) + '",' +
      '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
      '"DescripcionColor":"' + JSON_Str(Q.FieldByName('DescripcionColor').AsString) + '",' +
      '"LineaPedidoTalla":"' + SQL_GUID_ToStr(Q.FieldByName('LineaPedidoTalla').AsString) + '",' +
      '"OrdenDetalleTalla":' + IntToStr(Q.FieldByName('OrdenDetalleTalla').AsInteger) + ',' +
      '"Estado":' + IntToStr(Estado) + ',' +
      '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
      '"UnidadesAgrupacion":' + SQL_FloatToStr(fUnidadesAgrupacion) + ',' +
      '"Agrupacion":"' + JSON_Str(Q.FieldByName('Agrupacion').AsString) + '",' +
      '"CajaActual":' + IntToStr(Q.FieldByName('CajaActual').AsInteger) + ',' +
      '"LineasPosicionCompuesto":"' + SQL_GUID_ToStr(Q.FieldByName('LineasPosicionCompuesto').AsString) + '",' +
      '"BloqueoRebaje":' + SQL_BooleanToStr(Q.FieldByName('BloqueoRebaje_').AsInteger<>0) + ',' +
      '"Lote":' + SQL_BooleanToStr(SQL_GUID_ToStr(Q.FieldByName('LineasPosicionCompuesto').AsString)<>GUID0) + ',' +
      '"Agrupaciones":[' + sAgrupaciones + ']' +
      '}';

    Q.Next;

  end;

  if iCurrentIndex=iTotalRegs then
    iCurrentIndex := 9999;

  Result := Result + '],"CurrentIndex":' + IntToStr(iCurrentIndex);
  Result := Result + '}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


procedure WebModule1detalleExpedicionTCAgrupacionesAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  PickingId: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iTotalRegsFiltered, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  sAgrupaciones: String;
  contentfields: TStringList;
  sPacking: String;
  Q2: TADOQuery;
  sDetallePartidas: String;
  CodigoArticulo: String;
  CodigoAgrupacion: Integer;
  bOnlyPending: Boolean;
  iLiniesCompletes: Integer;
  iLiniesStarted: Integer;
  Estado: Integer;
  bMultiPedido: Boolean;
  fUnidadesAgrupacion: Double;
  CodigoTalla: string;
  CodigoColor: string;
  iCurrentIndex: Integer;
  bSepararPorLinea: Boolean;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  CodigoArticulo := contentfields.values['CodigoArticulo'];

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  // AGRUPACIONS DE L'ARTICLE
  sSQL :=
    'SELECT ' +
    '  0 AS CodigoAgrupacion, ''Sin agrupar'' as Agrupacion, CodigoArticulo AS CodigoAlternativo, ' +
    '  UnidadMedida2_ as UnidadMedidaAgrupacion, 1 as UnidadesAgrupacion ' +
    'FROM Articulos WITH (NOLOCK)' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
    '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
    'UNION ' +
    'SELECT ' +
    '  CodigoAgrupacion, Agrupacion, CodigoAlternativo, ' +
    '  UnidadMedida1_ AS UnidadMedidaAgrupacion, UnidadesAgrupacion ' +
    'FROM Agrupaciones WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
    '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
    'ORDER BY ' +
    '  CodigoAgrupacion';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) +
            ',"Data":[';
  iNumRegs := 0;
  iCurrentIndex := 0;

  while not Q.EOF do
  begin

    if iCurrentIndex<>0 then
      Result := Result + ',';

    Result := Result +
      '{' +
      '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
      '"Agrupacion":"' + JSON_Str(Q.FieldByName('Agrupacion').AsString) + '",' +
      '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"UnidadMedidaAgrupacion":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaAgrupacion').AsString)) + '",' +
      '"UnidadesAgrupacion":' + SQL_FloatToStr(Q.FieldByName('UnidadesAgrupacion').AsFloat) +
      '}';

    Inc(iCurrentIndex);

    Q.Next;

  end;

  SQL_CloseFree(Q);

  Result := Result + ']}';

  {$ENDREGION}

end;


procedure WebModule1detallerecuperarPackingListScansAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  PickingId: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iTotalRegsFiltered, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  sAgrupaciones: String;
  contentfields: TStringList;
  sPacking: String;
  Q2: TADOQuery;
  sDetallePartidas: String;
  CodigoArticulo: String;
  CodigoAgrupacion: Integer;
  bOnlyPending: Boolean;
  iLiniesCompletes: Integer;
  iLiniesStarted: Integer;
  Estado: Integer;
  bMultiPedido: Boolean;
  fUnidadesAgrupacion: Double;
  CodigoTalla: string;
  CodigoColor: string;
  iCurrentIndex: Integer;
  bSepararPorLinea: Boolean;
  LineasPosicion: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  IdPreparacion := StrToIntDef(contentfields.values['PreparacionId'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  PickingId := StrToIntDef(contentfields.values['PickingId'],0);

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  // DETALL DE PARTIDES
  sSQL :=
    'SELECT * ' +
    'FROM FS_SGA_PackingList WITH (NOLOCK) ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND PickingId = ' + IntToStr(PickingId) + ' ' +
    'ORDER BY ' +
    '  Id';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) +
            ',"Data":[';
  iNumRegs := 0;
  iCurrentIndex := 0;

  while not Q.EOF do
  begin

    if iCurrentIndex<>0 then
      Result := Result + ',';

    Result := Result +
      '{' +
      '"DT":"' + FormatDateTime('dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaRegistro').AsDateTime) + '",' +
      '"Id":' + IntToStr(Q.FieldByName('Id').AsInteger) + ',' +
      '"CodigoUsuario":' + IntToStr(Q.FieldByName('UserId').AsInteger) + ',' +
      '"CodigoUbicacion":"",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"Cantidad":' + SQL_FloatToStr(Q.FieldByName('Unidades').AsFloat) + ',' +
      '"CantidadBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesBase').AsFloat) + ',' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
      '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '",' +
      '"Saved":1' +
      '}';

    Inc(iCurrentIndex);

    Q.Next;

  end;

  SQL_CloseFree(Q);

  Result := Result + ']}';

  {$ENDREGION}

end;


procedure WebModule1detalleExpedicionTCPartidasAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  PickingId: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iTotalRegsFiltered, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  sAgrupaciones: String;
  contentfields: TStringList;
  sPacking: String;
  Q2: TADOQuery;
  sDetallePartidas: String;
  CodigoArticulo: String;
  CodigoAgrupacion: Integer;
  bOnlyPending: Boolean;
  iLiniesCompletes: Integer;
  iLiniesStarted: Integer;
  Estado: Integer;
  bMultiPedido: Boolean;
  fUnidadesAgrupacion: Double;
  CodigoTalla: string;
  CodigoColor: string;
  iCurrentIndex: Integer;
  bSepararPorLinea: Boolean;
  LineasPosicion: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  CodigoArticulo   := contentfields.values['CodigoArticulo'];
  CodigoTalla      := contentfields.values['CodigoTalla'];
  CodigoColor      := contentfields.values['CodigoColor'];
  LineasPosicion   := contentfields.values['LineasPosicion'];
  CodigoAgrupacion := StrToIntDef(contentfields.values['CodigoAgrupacion'], 0);

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  // DETALL DE PARTIDES
  sSQL :=
    'SELECT ' +
    '  fsap.Partida, ' +
    '  fsap.CodigoTalla01_, ' +
    '  fsap.CodigoColor_, ' +
    '  SUM(fsap.Cantidad) AS CantidadPreparada, ' +
    '  SUM(CASE WHEN fsap.PickingId<>0 THEN fsap.Cantidad ELSE 0 END) AS CantidadExpedida ' +
    'FROM FS_SGA_AcumuladoPendiente fsap WITH (NOLOCK) ' +
    'INNER JOIN Articulos art WITH (NOLOCK) ' +
    'ON ' +
    '  art.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
    '  AND art.CodigoArticulo = fsap.CodigoArticulo ' +
    'LEFT JOIN Colores_ C WITH (NOLOCK) ' +
    'ON ' +
    '  C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
    '  AND C.CodigoColor_ = fsap.CodigoColor_ ' +
    'LEFT JOIN Vis_VistaTallas T WITH (NOLOCK) ' +
    'ON ' +
    '  T.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
    '  AND T.GrupoTalla_= art.GrupoTalla_ ' +
    '  AND T.CodigoTalla01_ = fsap.CodigoTalla01_ ' +
    'WHERE ' +
    '  fsap.IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND fsap.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
    '  AND fsap.CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
    '  AND fsap.CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
    '  AND fsap.CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion) + ' ' +
    '  AND LineaPedidoAsignada IN ( ' +
    '    ''00000000-0000-0000-0000-000000000000'' , ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ' +
    '  ) ' +
    'GROUP BY ' +
    '  fsap.Partida, fsap.CodigoTalla01_, fsap.CodigoColor_';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) +
            ',"Data":[';
  iNumRegs := 0;
  iCurrentIndex := 0;

  while not Q.EOF do
  begin

    if iCurrentIndex<>0 then
      Result := Result + ',';

    Result := Result +
      '{' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
      '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
      '"CantidadPreparada":' + SQL_FloatToStr(Q.FieldByName('CantidadPreparada').AsFloat) + ',' +
      '"CantidadExpedida":' + SQL_FloatToStr(Q.FieldByName('CantidadExpedida').AsFloat) +
      '}';

    Inc(iCurrentIndex);

    Q.Next;

  end;

  SQL_CloseFree(Q);

  Result := Result + ']}';

  {$ENDREGION}

end;


procedure WebModule1detallePreparacionPedidoNewAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iTotalRegsFiltered, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  sAgrupaciones: String;
  contentfields: TStringList;
  sPacking: String;
  Q2: TADOQuery;
  sDetallePartidas: String;
  CodigoArticulo: String;
  CodigoAgrupacion: Integer;
  bOnlyPending: Boolean;
  iLiniesCompletes: Integer;
  iLiniesStarted: Integer;
  Estado: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  bOnlyPending := (AnsiLowerCase(contentfields.values['OnlyPending'])='true');

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'WHERE ' +
          '  fsppl.PreparacionId = ' + IntToStr(IdPreparacion);

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  if bOnlyPending then
  begin
    sSQL := sSQL + '  AND fsppl.UdSaldo>0';
  end;

  try
    iTotalRegsFiltered := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  // Línies ja completes
  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'WHERE ' +
          '  fsppl.PreparacionId = ' + IntToStr(IdPreparacion) +
          '  AND fsppl.UdSaldo<=0';

  try
    iLiniesCompletes := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  // Línies començades
  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'WHERE ' +
          '  fsppl.PreparacionId = ' + IntToStr(IdPreparacion) +
          '  AND fsppl.UdExpedidas>0';

  try
    iLiniesStarted := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  Estado := SGA_GetEstadoPreparacion ( Conn, IdPreparacion );
  sPacking := '';

  sSQL := 'SELECT ' +
          '  fsppl.PickingId, fsppl.CodigoEmpresa, fsppl.EjercicioPedido, fsppl.SeriePedido, ' +
          '  fsppl.NumeroPedido, fsppl.OrdenLineaPedido, fsppl.LineasPosicion, fsppl.UnidadMedida, ' +
          '  fsppl.UdNecesarias, fsppl.UdRetiradas, fsppl.CodigoArticulo, fsppl.DescripcionArticulo, ' +
          '  fsppl.Partida, fsppl.PreparacionId, ' +
          '  art.TratamientoPartidas, art.CodigoAlternativo, fsppl.UdExpedidas, ' +
          '  fsppl.CodigoAgrupacion, ISNULL(agrup.Agrupacion, ''Unidades'') as Agrupacion ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'LEFT JOIN FS_COMMON_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
          'ON ' +
          '  fsppl.codigoarticulo = art.codigoarticulo ' +
          'LEFT JOIN Agrupaciones agrup WITH (NOLOCK) ' +
          'ON ' +
          '  agrup.CodigoEmpresa = fsppl.CodigoEmpresa ' +
          '  AND agrup.CodigoArticulo = fsppl.CodigoArticulo ' +
          '  AND agrup.CodigoAgrupacion = fsppl.CodigoAgrupacion ' +
          'WHERE ' +
          '  fsppl.PreparacionId = ' + IntToStr(IdPreparacion);

  if bOnlyPending then
  begin
    sSQL := sSQL + '  AND fsppl.UdSaldo>0';
  end;

  sSQL := sSQL +
    'ORDER BY ' +
    '  fsppl.OrdenLineaPedido, fsppl.Codigoarticulo ' + //, fsap.Partida ' +
    'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
    'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', CONST_LOGID_SGA, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) +
            ',"RecordsStarted":' + IntToStr(iLiniesStarted) + ',"TotalRecordsFiltered":' + IntToStr(iTotalRegsFiltered) + ',"LineasCompletas":' + IntToStr(iLiniesCompletes) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    CodigoArticulo   := Q.FieldByName('CodigoArticulo').AsString;
    CodigoAgrupacion := Q.FieldByName('CodigoAgrupacion').AsInteger;

    // AGRUPACIONS DE L'ARTICLE
    sSQL := 'SELECT ' +
            '  0 AS CodigoAgrupacion, ''Sin agrupar'' as Agrupacion, CodigoArticulo AS CodigoAlternativo, ' +
            '  UnidadMedida2_ as UnidadMedidaAgrupacion, 1 as UnidadesAgrupacion ' +
            'FROM Articulos WITH (NOLOCK)' +
            'WHERE ' +
            '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
            '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            'UNION ' +
            'SELECT ' +
            '  CodigoAgrupacion, Agrupacion, CodigoAlternativo, ' +
            '  UnidadMedida1_ AS UnidadMedidaAgrupacion, UnidadesAgrupacion ' +
            'FROM Agrupaciones WITH (NOLOCK) ' +
            'WHERE ' +
            '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
            '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            'ORDER BY ' +
            '  CodigoAgrupacion';

    Q2 := SQL_PrepareQuery ( Conn, sSQL );
    try
      Q2.Open;
    except
    end;

    sAgrupaciones := '';
    while not Q2.EOF do
    begin

      if sAgrupaciones<>'' then
        sAgrupaciones := sAgrupaciones + ',';

      sAgrupaciones := sAgrupaciones +
        '{' +
        '"CodigoAgrupacion":' + IntToStr(Q2.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
        '"Agrupacion":"' + JSON_Str(Q2.FieldByName('Agrupacion').AsString) + '",' +
        '"CodigoAlternativo":"' + JSON_Str(Q2.FieldByName('CodigoAlternativo').AsString) + '",' +
        '"UnidadMedidaAgrupacion":"' + JSON_Str(AnsiUpperCase(Q2.FieldByName('UnidadMedidaAgrupacion').AsString)) + '",' +
        '"UnidadesAgrupacion":' + SQL_FloatToStr(Q2.FieldByName('UnidadesAgrupacion').AsFloat) +
        '}';

      Q2.Next;

    end;


    // DETALL DE PARTIDES
    sSQL := 'SELECT ' +
            '  Partida, ' +
            '  SUM(Cantidad) AS CantidadPreparada, ' +
            '  SUM(CASE WHEN PickingId<>0 THEN Cantidad ELSE 0 END) AS CantidadExpedida ' +
            'FROM FS_SGA_AcumuladoPendiente WITH (NOLOCK) ' +
            'WHERE ' +
            '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
            '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion) + ' ' +
            '  AND LineaPedidoAsignada IN ( ' +
            '    ''00000000-0000-0000-0000-000000000000'' , ''' + SQL_GUID_ToStr(Q.FieldByName('LineasPosicion').AsString) + ''' ' +
            '  ) ' +
            'GROUP BY ' +
            '  Partida';

    Q2 := SQL_PrepareQuery ( Conn, sSQL );
    try
      Q2.Open;
    except
    end;

    sDetallePartidas := '';
    while not Q2.EOF do
    begin

      if sDetallePartidas<>'' then
        sDetallePartidas := sDetallePartidas + ',';

      sDetallePartidas := sDetallePartidas +
        '{' +
        '"Partida":"' + JSON_Str(Q2.FieldByName('Partida').AsString) + '",' +
        '"CantidadPreparada":' + SQL_FloatToStr(Q2.FieldByName('CantidadPreparada').AsFloat) + ',' +
        '"CantidadExpedida":' + SQL_FloatToStr(Q2.FieldByName('CantidadExpedida').AsFloat) +
        '}';

      Q2.Next;

    end;

    SQL_CloseFree(Q2);

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
                       '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
                       '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
                       '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
                       '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
                       '"Orden":' + Q.FieldByName('OrdenLineaPedido').AsString + ',' +
                       '"LineasPosicion":"' + JSON_Str(Q.FieldByName('LineasPosicion').AsString) + '",' +
                       '"CodigoArticulo":"' + JSON_Str(CodigoArticulo) + '",' +
                       '"CodigoArticuloAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
                       '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
                       '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
                       '"PickingId":' + Q.FieldByName('PickingId').AsString + ',' +
                       '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
                       '"UdNecesarias":' + SQL_FloatToStr(Q.FieldByName('UdNecesarias').AsFloat) + ',' +
                       '"UdRetiradasTotales":' + SQL_FloatToStr(Q.FieldByName('UdRetiradas').AsFloat) + ',' +
                       '"UdExpedidas":' + SQL_FloatToStr(Q.FieldByName('UdExpedidas').AsFloat) + ',' +
                       '"Expedicion":[' + sDetallePartidas + '],' +
                       '"Estado":' + IntToStr(Estado) + ',' +
                       '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
                       '"Agrupacion":"' + JSON_Str(Q.FieldByName('Agrupacion').AsString) + '",' +
                       '"Agrupaciones":[' + sAgrupaciones + ']' +
                       '}';

    Q.Next;

  end;

  Result := Result + '],' + sPacking;
  Result := Result + '}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


procedure WebModule1detallePreparacionPedidoAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;

  contentfields: TStringList;
  sPacking: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'LEFT JOIN FS_SGA_AcumuladoPendiente fsap WITH (NOLOCK) ' +
          'ON ' +
          '  fsap.codigoarticulo = fsppl.CodigoArticulo AND ' +
          '  fsap.IdPreparacion = fsppl.PreparacionId ' +
          'WHERE ' +
          '  fsppl.PreparacionId = ' + IntToStr(IdPreparacion);

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', CONST_LOGID_SGA, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sPacking := '';

  sSQL := 'SELECT ' +
          '  fsppl.PickingId, fsppl.CodigoEmpresa, fsppl.EjercicioPedido, fsppl.SeriePedido, ' +
          '  fsppl.NumeroPedido, fsppl.OrdenLineaPedido, fsppl.LineasPosicion, fsppl.UnidadMedida, ' +
          '  fsppl.UdNecesarias, fsppl.UdRetiradas, fsppl.CodigoArticulo, fsppl.DescripcionArticulo, ' +
          '  fsppl.Partida, fsppl.PreparacionId, fsap.Partida AS PartidaPreparada, ' +
          '  fsap.Cantidad, art.TratamientoPartidas, art.CodigoAlternativo, fsppl.UdExpedidas ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'LEFT JOIN FS_SGA_AcumuladoPendiente fsap WITH (NOLOCK) ' +
          'ON ' +
          '  fsap.codigoarticulo = fsppl.CodigoArticulo AND ' +
          '  fsap.IdPreparacion = fsppl.PreparacionId ' +
          'LEFT JOIN FS_COMMON_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
          'ON ' +
          '  fsppl.codigoarticulo = art.codigoarticulo ' +
          'WHERE ' +
          '  fsppl.PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          'ORDER BY ' +
          '  fsppl.OrdenLineaPedido, fsppl.Codigoarticulo, fsap.Partida ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', CONST_LOGID_SGA, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
                       '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
                       '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
                       '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
                       '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
                       '"Orden":' + Q.FieldByName('OrdenLineaPedido').AsString + ',' +
                       '"LineasPosicion":"' + JSON_Str(Q.FieldByName('LineasPosicion').AsString) + '",' +
                       '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
                       '"CodigoArticuloAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
                       '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
                       '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
                       '"PartidaPreparada":"' + JSON_Str(Q.FieldByName('PartidaPreparada').AsString) + '",' +
                       '"PickingId":' + Q.FieldByName('PickingId').AsString + ',' +
                       '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
                       '"UdNecesarias":' + SQL_FloatToStr(Q.FieldByName('UdNecesarias').AsFloat) + ',' +
                       '"UdRetiradasTotales":' + SQL_FloatToStr(Q.FieldByName('UdRetiradas').AsFloat) + ',' +
                       '"UdExpedidas":' + SQL_FloatToStr(Q.FieldByName('UdExpedidas').AsFloat) + ',' +
                       '"UdRetiradas":' + SQL_FloatToStr(Q.FieldByName('Cantidad').AsFloat) +
                       '}';

    Q.Next;

  end;

  Result := Result + '],' + sPacking;
  Result := Result + '}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;

procedure WebModule1detallePreparacionOrdenAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  sSQL: String;
  sSQL1: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  Indice: Integer;
  MostrarPartidas: Integer;
  sTable: string;
  CodigoAlmacen: String;
  CodigoArticulo: String;
  sUbicaciones: String;
  sMovimientosRealizados: String;
  Partida: String;
  PartidaSugerida: String;
  bError: Boolean;
  Pendientes: Integer;
  SoloConStock: Boolean;
  iStockTotal: Double;
  Direccion: Integer;
  CodigoUbicacionExpedicion: String;
  CodigoUbicacionesExcluidas: String;
  sMsg: String;
  bIsBuilding: Boolean;
  contentfields: TStringList;
  fUnidadesAgrupacion: Double;
  fUnidadesNecesariasAgrupadas: Double;
  UnidadesRetiradasAgrupadas: Double;
  UnidadesExpedidasAgrupadas: Double;
  LineasPosicion: String;
  sMostrarControlesPorCaja: string;
  PaletActual, CajaActual: Integer;
  MatriculaActual: String;
  CodigoTalla: String;
  CodigoColor: String;
  JSonUnidadesMedida: String;
  CodigoAlmacenDefecto: string;
  DefaultUbi: TDefaultUbicaciones;
  sConsiderarReservas: String;
  sSoloReservas: String;
  sIgnorarPartidaSolicitada: String;
  sIgnorarUbicacionSolicitada: String;
  CodigoCliente: string;
  PermitirCaducados: string;
  FechaCaducaMin: TDate;
  sFechaCaducaMin: string;
  CodigoUsuario: Integer;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  if contentfields.Values['LogID']<>'' then
    sIDCall := contentfields.Values['LogID'];

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  gaLogFile.Write ( 'EmpresaOrigen = ' + IntToStr(CodigoEmpresa.EmpresaOrigen), sIDCall  );

  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario               := StrToIntDef(contentfields.Values['CodigoUsuario'],0);
  sConsiderarReservas         := contentfields.Values['ConsiderarReservas'];
  sSoloReservas               := contentfields.Values['SoloReservas'];
  sIgnorarPartidaSolicitada   := contentfields.Values['IgnorarPartidaSolicitada'];
  sIgnorarUbicacionSolicitada := contentfields.Values['IgnorarUbicacionSolicitada'];

  if sConsiderarReservas='' then sConsiderarReservas := '1';
  if sSoloReservas='' then sSoloReservas := '0';
  if sIgnorarPartidaSolicitada='' then sIgnorarPartidaSolicitada := '0';
  if sIgnorarUbicacionSolicitada='' then sIgnorarUbicacionSolicitada := '0';

  CodigoAlmacenDefecto := (contentfields.Values['CodigoAlmacenDefecto']);
  if CodigoAlmacenDefecto='' then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  gaLogFile.Write('CodigoAlmacenDefecto= ' + CodigoAlmacenDefecto);

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  sSQL1           := Trim(contentfields.Values['SQL']);
  Indice          := StrToIntDef(contentfields.values['Indice'],0);
  MostrarPartidas := 1; //StrToIntDef(contentfields.values['MostrarPartidas'],0);
  Pendientes      := StrToIntDef(contentfields.values['Pendientes'],0);
  SoloConStock    := (StrToIntDef(contentfields.values['SoloConStock'],0)<>0);
  Direccion       := StrToIntDef(contentfields.values['Direccion'],1);
  CodigoAlmacen   := (contentfields.Values['CodigoAlmacen']);
  LineasPosicion  := (contentfields.Values['LineasPosicion']);
  CodigoTalla     := (contentfields.Values['CodigoTalla']);
  CodigoColor     := (contentfields.Values['CodigoColor']);

  // Temporal
  //if CodigoAlmacen='' then
  //  CodigoAlmacen := 'ALM1';

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;
  gaLogFile.Write ( 'IdPreparacion = ' + IntToStr(IdPreparacion), sIDCall  );

  PaletActual     := 1;
  CajaActual      := 1;
  MatriculaActual := '';

  sSQL :=
    'SELECT ' +
    '  PaletActual, CajaActual, MatriculaActual ' +
    'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
    'WHERE ' +
    '  PreparacionId=' + IntToStr(IdPreparacion);
  Q := SQL_PrepareQuery(Conn,sSQL);
  Q.Open;
  if not Q.EOF then
  begin
    PaletActual     := Q.FieldByName('PaletActual').AsInteger;
    CajaActual      := Q.FieldByName('CajaActual').AsInteger;
    MatriculaActual := Q.FieldByName('MatriculaActual').AsString;
  end;
  Q.Close;
  FreeAndNil(Q);

  OrdenarPor := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden  := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy   := '';
  sOperation := '>';

  if Direccion=0 then begin
    sOperation := '>=';
    Direccion := 0;
    sOrderBy := 'fspo.rn';
  end else begin
    if Direccion>0 then begin
      sOperation := '>';
    end else begin
      sOperation := '<';
    end;

    if OrdenarPor='ARTICULO' then begin
      if Direccion<0 then begin
        sOrderBy := 'fspo.CodigoArticulo DESC, fspo.Partida DESC ';
      end else begin
        sOrderBy := 'fspo.CodigoArticulo, fspo.Partida ';
      end;
    end else if OrdenarPor='CODIGOUBICACION' then begin
      if Direccion<0 then begin
        sOrderBy := 'fspo.CodigoUbicacion DESC, fspo.rn DESC ';
      end else begin
        sOrderBy := 'fspo.CodigoUbicacion, rn ';
      end;
    end else if OrdenarPor='CODIGOUBICACIONALTERNATIVO' then begin
      if Direccion<0 then begin
        sOrderBy := 'fspo.CodigoUbicacionAlternativo DESC ';
      end else begin
        sOrderBy := 'fspo.CodigoUbicacionAlternativo ';
      end;
    end else begin
      if Direccion<0 then begin
        sOrderBy := 'fspo.CodigoArticulo DESC, fspo.Partida DESC ';
      end else begin
        sOrderBy := 'fspo.CodigoArticulo DESC, fspo.Partida ';
      end;
    end;

  end;

  sOrderBy := 'fspo.rn';
  if Direccion<0 then
    sOrderBy := sOrderBy + ' DESC ';

  sSQL :=
      'SELECT AlmacenPreparacion ' +
      'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
      'WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  CodigoAlmacen := SQL_Execute ( Conn, sSQL );

  FS_SGA_ObtenerUbicacionesAlmacen ( Conn, CodigoEmpresa, CodigoAlmacen, DefaultUbi );
  CodigoUbicacionExpedicion := DefaultUbi.UbicacionExpediciones;

  //PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacionExpedicion, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionesExcluidasExpedicion, CodigoUbicacionesExcluidas, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_MostrarControlesPaletCaja, sMostrarControlesPorCaja, CodigoEmpresa.EmpresaOrigen );

  if (CodigoUbicacionesExcluidas='') or (CodigoUbicacionesExcluidas='0') then
    CodigoUbicacionesExcluidas := '''''';

  if CodigoAlmacen='' then begin
    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacionExpedicion );
  end;

  // RECUPERAMOS CAJA/PALET DE LA PREPARACIÓN ACTUAL
  if sMostrarControlesPorCaja='' then
  begin

  end;

  {$ENDREGION}

  {$REGION 'Ens assegurem que tenim creada la taula amb l´ordenació creada'}
  sSQL := 'SELECT COUNT(*) FROM FS_SGA_ActualizarRuta WITH (NOLOCK) WHERE PreparacionId=' + IntToStr(IdPreparacion);

  if SQL_Execute(Conn,sSQL)>0 then
  begin
    gaLogFile.Write ( 'Before SGA_Check_PreparacionOrdenada Manual', sIDCall  );
    SGA_Check_PreparacionOrdenada (
      gsPath,
      Conn,
      CodigoEmpresa,
      CodigoUsuario,
      YY,
      IdPreparacion,
      CodigoAlmacen,
      CodigoUbicacionExpedicion,
      sConsiderarReservas,
      sSoloReservas,
      sIgnorarPartidaSolicitada,
      sIgnorarUbicacionSolicitada,
      sMsg,
      TRUE,
      bIsBuilding
    );
    gaLogFile.Write ( 'After SGA_Check_PreparacionOrdenada Manual: ' + sMsg, sIDCall  );
  end else begin
    gaLogFile.Write ( 'Before SGA_Check_PreparacionOrdenada', sIDCall  );
    SGA_Check_PreparacionOrdenada (
      gsPath,
      Conn,
      CodigoEmpresa,
      CodigoUsuario,
      YY,
      IdPreparacion,
      CodigoAlmacen,
      CodigoUbicacionExpedicion,
      sConsiderarReservas,
      sSoloReservas,
      sIgnorarPartidaSolicitada,
      sIgnorarUbicacionSolicitada,
      sMsg,
      FALSE,
      bIsBuilding
    );
    gaLogFile.Write ( 'After SGA_Check_PreparacionOrdenada: ' + sMsg, sIDCall  );
  end;

  if bIsBuilding then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Se está calculando la ruta. Volver a intentar en unos segundos","Data":[]}';
    Exit;
  end;
  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT TOP 1 UPPER(parametro_value) ' +
    'FROM FS_SGA_Parametros WITH (NOLOCK) ' +
    'WHERE parametro_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
    '  AND parametro_id = 142 ' +
    'ORDER BY parametro_CodigoEmpresa DESC';
  PermitirCaducados := SQL_Execute ( Conn, sSQL );

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'ART', '' );

  sSQL := 'SELECT TOP 1 ' +
          '  PEDIDO.NumLineas, PEDIDO.EjercicioPedido, PEDIDO.SeriePedido, PEDIDO.NumeroPedido, PEDIDO.CodigoCliente, ' +
          '  fssa.UnidadesSaldo, fssa.UnidadesSaldoBase, fspp.PaletActual, fspp.CajaActual, fspp.MatriculaActual, fspo.*, ' +
          '  ISNULL(agrup.Agrupacion,''Unidades'') AS Agrupacion, ' +
          '  T.DescripcionTalla01_ as DescripcionTalla, C.Color_ AS DescripcionColor, ' +
          '  art.CodigoAlternativo, art.CodigoAlternativo2, CTC.CodigoAlternativo AS CodigoAlternativoTC, ' +
          '  art.Colores_ AS TratamientoColores, art.GrupoTalla_ AS TratamientoTallas, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc ' +
          'FROM FS_SGA_PreparacionOrdenada fspo WITH (NOLOCK) ' +
          'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
          'ON ' +
          '  fspo.CodigoArticulo = art.CodigoArticulo ' +
          'LEFT JOIN ( ' +
          '  SELECT ' +
          '    PreparacionId, CodigoEmpresa, CodigoArticulo, Partida, CodigoTalla01_, CodigoColor_, UnidadMedida, ' +
          '    UnidadMedidaBase, CodigoCliente, COUNT(PickingId) AS NumLineas, MIN(EjercicioPedido) AS EjercicioPedido, ' +
          '    MIN(SeriePedido) AS SeriePedido, MIN(NumeroPedido) AS NumeroPedido ' +
          '  FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
          '  GROUP BY ' +
          '    PreparacionId, CodigoEmpresa, CodigoArticulo, Partida, CodigoTalla01_, CodigoColor_, UnidadMedida, ' +
          '    UnidadMedidaBase, CodigoCliente ' +
          ') PEDIDO ' +
          'ON ' +
          '  PEDIDO.PreparacionId = fspo.PreparacionId ' +
          '    AND PEDIDO.CodigoEmpresa = fspo.CodigoEmpresa ' +
          '    AND PEDIDO.CodigoArticulo = fspo.CodigoArticulo ' +
          '    AND PEDIDO.Partida = fspo.Partida ' +
          '    AND PEDIDO.CodigoTalla01_ = fspo.CodigoTalla01_ ' +
          '    AND PEDIDO.CodigoColor_ = fspo.CodigoColor_ ' +
          '    AND PEDIDO.UnidadMedida = fspo.UnidadMedida ' +
          '    AND PEDIDO.UnidadMedidaBase = fspo.UnidadMedidaBase ' +
          'INNER JOIN FS_SGA_Picking_Preparaciones fspp WITH (NOLOCK) ' +
          'ON ' +
          ' fspp.PreparacionId = fspo.PreparacionId ' +
          'LEFT JOIN Agrupaciones agrup WITH (NOLOCK) ' +
          'ON ' +
          '  agrup.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
          '  AND agrup.CodigoArticulo = fspo.CodigoArticulo ' +
          '  AND agrup.CodigoAgrupacion = fspo.CodigoAgrupacion ' +
          'LEFT JOIN Colores_ C WITH (NOLOCK) ' +
          'ON ' +
          '  C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
          '  AND C.CodigoColor_ = fspo.CodigoColor_ ' +
          'LEFT JOIN Vis_VistaTallas T WITH (NOLOCK) ' +
          'ON ' +
          '  T.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
          '  AND T.GrupoTalla_= art.GrupoTalla_ ' +
          '  AND T.CodigoTalla01_ = fspo.CodigoTalla01_ ' +
          'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
          'ON ' +
          '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
          '  AND CTC.CodigoArticulo = fspo.CodigoArticulo ' +
          '  AND CTC.CodigoTalla01_ = fspo.CodigoTalla01_ ' +
          '  AND CTC.CodigoColor_ = fspo.CodigoColor_ ' +
          'LEFT JOIN ( ' +
          '  SELECT ' +
          '    CodigoArticulo, CodigoTalla01_, CodigoColor_, UnidadMedida, SUM(UnidadesSaldo) AS UnidadesSaldo, SUM(UnidadesSaldoBase) AS UnidadesSaldoBase  ' +
          '  FROM FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', ' + IntToStr(YY) + ' ) ' +
          '  WHERE ' +
          '    ( ' +
          '      CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ' +
          '      OR ( ' +
          '        CodigoAlmacen IN ( ' +
          '          SELECT AlmacenAnexo ' +
          '          FROM FS_SGA_AlmacenesAnexos WITH (NOLOCK) ' +
          '          WHERE CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
          '          AND EmpresaOrigen = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
          '          AND CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ' +
          '        ) '+
          '      ) ' +
          '    ) ' +
          '    AND CodigoUbicacion NOT IN ( ' +
          '      SELECT EXCL_Ubicacion ' +
          '      FROM FS_SGA_UbicacionesExcluidas WITH (NOLOCK) ' +
          '      WHERE EXCL_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) ' +
          '        AND EXCL_Tipo = 0 ' +
          '  ) ' +
          '  GROUP BY ' +
          '    CodigoArticulo, CodigoTalla01_, CodigoColor_, UnidadMedida ' +
          ') fssa ' +
          'ON ' +
          '  fssa.CodigoArticulo = fspo.CodigoArticulo ' +
          '  AND fssa.CodigoTalla01_ = fspo.CodigoTalla01_ ' +
          '  AND fssa.CodigoColor_ = fspo.CodigoColor_ ' +
          '  AND fssa.UnidadMedida = fspo.UnidadMedida ' +
          'WHERE ' +
          '  fspo.PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND fspo.rn ' + sOperation + ' ' + IntToStr(Indice) + ' ';

  if Pendientes=1 then
     sSQL := sSQL + 'AND (fspo.UdNecesarias > fspo.Udretiradas OR fspo.UdNecesariasBase > fspo.UdretiradasBase ) ';

  if SoloConStock then
     sSQL := sSQL + 'AND fspo.CodigoUbicacion IS NOT NULL ';


  sSQL := sSQL + 'ORDER BY ' + sOrderBy;
  gaLogFile.Write(sSQL);

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":1,"NumPages":1,"NumRecords":' + IntToStr(iNumRegs) + ',';

  Result := Result +
    '"PaletActual":' + IntToStr(PaletActual) + ',' +
    '"CajaActual":' + IntToStr(CajaActual) + ',' +
    '"MatriculaActual":"' + JSON_Str(MatriculaActual) + '",';

  Result := Result + '"Data":[';

  iNumRegs := 0;

  if not Q.Eof then begin

    Q.Last;

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    CodigoAlmacen   := FS_SGA_CodigoAlmacen ( Q.FieldByName('CodigoUbicacion').AsString );
    CodigoArticulo  := Q.FieldByName('CodigoArticulo').AsString;
    Partida         := Q.FieldByName('Partida').AsString;
    PartidaSugerida := Q.FieldByName('PartidaSugerida').AsString;
    CodigoCliente   := Q.FieldByName('CodigoCliente').AsString;
    FechaCaducaMin  := Q.FieldByName('FechaCaducaMin').AsDateTime;
    if FechaCaducaMin>0 then
      sFechaCaducaMin := FormatDateTime('dd/mm/yyyy', FechaCaducaMin)
    else
      sFechaCaducaMin := '';


    sUbicaciones := FS_SGA_ObtenerUbicaciones (
      Conn,
      IdPreparacion,
      CodigoEmpresa,
      CodigoArticulo,
      AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString),
      Partida,
      Q.FieldByName('CodigoTalla01_').AsString,
      Q.FieldByName('CodigoColor_').AsString,
      CodigoAlmacen,
      CodigoCliente,
      PermitirCaducados,
      MostrarPartidas,
      SoloConStock,
      bError,
      iStockTotal );

    JSonUnidadesMedida := SGA_FS_ARTICULO_Obtener_UnidadesMedida (
      Conn,
      CodigoEmpresa,
      CodigoArticulo
    );

    sMovimientosRealizados := FS_SGA_ObtenerMovimientosPreparacion (
      Conn,
      IdPreparacion,
      CodigoEmpresa,
      Q.FieldByName('LineasPosicion').AsString,
      CodigoArticulo,
      Partida,
      Q.FieldByName('CodigoTalla01_').AsString,
      Q.FieldByName('CodigoColor_').AsString,
      CodigoAlmacen,
      MostrarPartidas,
      bError,
      iStockTotal
    );

    if not bError then begin

      fUnidadesAgrupacion := Q.FieldByName('UnidadesAgrupacion').AsFloat;

      if fUnidadesAgrupacion = 0 then
      begin
        fUnidadesAgrupacion := 1;
      end;

      fUnidadesNecesariasAgrupadas := Q.FieldByName('UdNecesarias').AsFloat / fUnidadesAgrupacion;
      UnidadesRetiradasAgrupadas   := Q.FieldByName('UdRetiradas').AsFloat / fUnidadesAgrupacion;
      UnidadesExpedidasAgrupadas   := Q.FieldByName('UdExpedidas').AsFloat / fUnidadesAgrupacion;

      Result := Result +
        '{' +
        '"Indice":' + Q.FieldByName('rn').AsString + ',' +
        '"CodigoEmpresa":' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ',' +
        '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
        '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
        '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ',' +
        '"NumLineasAgrupadas":' + IntToStr(Q.FieldByName('NumLineas').AsInteger) + ',' +
        '"UdNecesarias":' + SQL_FloatToStr(Q.FieldByName('UdNecesarias').AsFloat) + ',' +
        '"UdRetiradas":' + SQL_FloatToStr(Q.FieldByName('UdRetiradas').AsFloat) + ',' +
        '"UdExpedidas":' + SQL_FloatToStr(Q.FieldByName('UdExpedidas').AsFloat) + ',' +
        '"UdNecesariasBase":' + SQL_FloatToStr(Q.FieldByName('UdNecesariasBase').AsFloat) + ',' +
        '"UdRetiradasBase":' + SQL_FloatToStr(Q.FieldByName('UdRetiradasBase').AsFloat) + ',' +
        '"UdExpedidasBase":' + SQL_FloatToStr(Q.FieldByName('UdExpedidasBase').AsFloat) + ',' +
        '"CodigoArticulo":"' + JSON_Str(CodigoArticulo) + '",' +
        '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
        '"CodigoAlternativo2":"' + JSON_Str(Q.FieldByName('CodigoAlternativo2').AsString) + '",' +
        '"CodigoAlternativoTC":"' + JSON_Str(Q.FieldByName('CodigoAlternativoTC').AsString) + '",' +
        '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
        '"Descripcion2Articulo":"' + JSON_Str(Q.FieldByName('Descripcion2Articulo').AsString) + '",' +
        '"GrupoTalla":' + IntToStr(Q.FieldByName('TratamientoTallas').AsInteger) + ',' +
        '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
        '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion').AsFloat) + ',' +
        '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
        '"DescripcionTalla":"' + JSON_Str(Q.FieldByName('DescripcionTalla').AsString) + '",' +
        '"DescripcionColor":"' + JSON_Str(Q.FieldByName('DescripcionColor').AsString) + '",' +
        '"Partida":"",' +
        '"PartidaPedido":"' + JSON_Str(Partida) + '",' +
        '"PartidaSugerida":"' + JSON_Str(PartidaSugerida) + '",' +
        '"CodigoAlmacen":"' + JSON_Str(CodigoAlmacen) + '",' +
        '"PreparacionId":' + Q.FieldByName('PreparacionId').AsString + ',' +
        '"PickingId":' + IntToStr(StrToIntDef(Q.FieldByName('PickingId').AsString,0)) + ',' +
        '"Orden":' + Q.FieldByName('Orden').AsString + ',' +
        '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('TratamientoColores').AsInteger<>0) + ',' +
        '"TratamientoPartidas":' + IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) + ',' +
        '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
        '"UnidadesStockBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldoBase').AsFloat) + ',' +
        '"UnidadesStock":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldo').AsFloat) + ',' +
        '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
        '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '",' +
        '"CodigoUbicacion":"' + JSON_Str(Q.FieldByName('CodigoUbicacion').AsString) + '",' +
        '"CodigoUbicacionAlternativo":"' + JSON_Str(Q.FieldByName('CodigoUbicacionAlternativo').AsString) + '",' +
        '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
        '"Agrupacion":"' + JSON_Str(Q.FieldByName('Agrupacion').AsString) + '",' +
        '"UnidadesAgrupacion":' + SQL_FloatToStr(fUnidadesAgrupacion) + ',' +
        '"UdNecesariasAgrupacion":' + SQL_FloatToStr(fUnidadesNecesariasAgrupadas) + ',' +
        '"UdRetiradasAgrupacion":' + SQL_FloatToStr(UnidadesRetiradasAgrupadas) + ',' +
        '"UdExpedidasAgrupacion":' + SQL_FloatToStr(UnidadesExpedidasAgrupadas) + ',' +
        '"LineasPosicion":"' + SQL_GUID_ToStr(Q.FieldByName('LineasPosicion').AsString) + '",' +
        '"PaletActual":' + Q.FieldByName('PaletActual').AsString + ',' +
        '"CajaActual":' + Q.FieldByName('CajaActual').AsString + ',' +
        '"MatriculaActual":"' + JSON_Str(Q.FieldByName('MatriculaActual').AsString) + '",' +
        '"UdReservadas":' + SQL_FloatToStr(Q.FieldByName('UdReservadasExternas').AsFloat) + ',' +
        '"UdReservadasBase":' + SQL_FloatToStr(Q.FieldByName('UdReservadasExternasBase').AsFloat) + ',' +
        '"UdPickable":' + SQL_FloatToStr(Q.FieldByName('UdPickable').AsFloat) + ',' +
        '"UdPickableBase":' + SQL_FloatToStr(Q.FieldByName('UdPickableBase').AsFloat) + ',' +
        '"FechaCaducaMin":"' + sFechaCaducaMin + '",' +
        JSonUnidadesMedida + ',' +
        sUbicaciones + ',' +
        sMovimientosRealizados +
        '}';

    end;

  end;

  if not bError then
    Result := Result + ']}'
  else
    Result := sUbicaciones;

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;



// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ DETALLS D'UNA RECEPCIÓ                                                │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1detalleRecepcionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  RecepcionId: Integer;
  sSQL: String;
  Q, Q2: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoArticulo: string;
  CodigoUbicacion: string;
  sDesglose: string;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoUsuario: Integer;
  CodigoUbicacionRecepcion: String;
  CodigoUbicacionRechazos: String;

  contentfields: TStringList;
  fTotalEntrada: Double;
  fTotalEntradaBase: Double;
  fTotalErrorBase: Double;
  fTotalError: Double;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  RecepcionId := StrToIntDef(contentfields.values['RecepcionId'],0);
  if RecepcionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de recepción no especificado","Data":[]}';

    Exit;
  end;

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  OrdenarPor    := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden     := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy      := '';

  if OrdenarPor='PEDIDO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsrl.EjercicioPedido DESC, fsrl.SeriePedido DESC, fsrl.NumeroPedido DESC, fsrl.OrdenLineaPedido ';
    end else begin
      sOrderBy := 'fsrl.EjercicioPedido, fsrl.SeriePedido, fsrl.NumeroPedido, fsrl.OrdenLineaPedido ';
    end;
  end else if OrdenarPor='ESTADO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsrl.UdSaldo DESC ';
    end else begin
      sOrderBy := 'fsrl.UdSaldo ';
    end;
  end else if OrdenarPor='ARTICULO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsrl.CodigoArticulo DESC, fsrl.Partida DESC ';
    end else begin
      sOrderBy := 'fsrl.CodigoArticulo, fsrl.Partida ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsrl.RecepcionIdLinea DESC ';
    end else begin
      sOrderBy := 'fsrl.RecepcionIdLinea ';
    end;
  end;

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionRecepcion,         CodigoUbicacionRecepcion, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionRecepcionRechazos, CodigoUbicacionRechazos, CodigoEmpresa.EmpresaOrigen );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_Recepciones_Lineas WITH (NOLOCK) ' +
          'WHERE ' +
          '  RecepcionId = ' + IntToStr(RecepcionId);

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'art', '' );

  sSQL := 'SELECT ' +
          '  fsrl.*, art.TratamientoPartidas, art.CodigoAlternativo, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc ' +
          'FROM FS_SGA_Recepciones_Lineas fsrl WITH (NOLOCK) ' +
          'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
          'ON ' +
          '  fsrl.CodigoArticulo = art.CodigoArticulo ' +
          'WHERE ' +
          '  fsrl.RecepcionId = ' + IntToStr(RecepcionId) + ' ' +
          'ORDER BY ' +
          sOrderBy +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  Q2 := SQL_PrepareQuery ( Conn );

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    sSQL := 'SELECT ' +
            '  fsrld.*, stu.CodigoAlternativo, fsi.NombreIncidencia, fsrld.Unidades * art.PesoBrutoUnitario_ as PesoBruto, ' +
            '   fsrld.Unidades * art.PesoNetoUnitario_ as PesoNeto, fsrld.Unidades * art.VolumenUnitario_ as Volumen ' +
            'FROM FS_SGA_Recepciones_Lineas_Detalle fsrld WITH (NOLOCK) ' +
            'INNER JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) stu ' +
            'ON ' +
            '  stu.CodigoUbicacion = fsrld.CodigoUbicacion ' +
            'LEFT JOIN FS_SGA_TABLE_Incidencias ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ''R'' ) fsi ' +
            'ON ' +
            '  fsi.IdIncidencia = fsrld.AnomaliaId ' +
            'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
            'ON ' +
            '  art.CodigoArticulo = ''' + SQL_Str(Q.FieldByName('CodigoArticulo').AsString) + ''' ' +
            'WHERE ' +
            '  fsrld.RecepcionIdLinea = ' + IntToStr(Q.FieldByName('RecepcionIdLinea').AsInteger) + ' AND ' +
            '  fsrld.RecepcionId = ' + IntToStr(RecepcionId) +
            'ORDER BY ' +
            '  fsrld.RecepcionIdLineaDetalle';

    Q2.Close;
    Q2.SQL.Text := sSQL;
    try
      Q2.Open;
    except
      on E:Exception do begin
        gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
        Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
        FreeAndNil(Q2);
        FreeAndNil(Q);
        Exit;
      end;
    end;

    sDesglose := '';

    while not Q2.EOF do begin

      if sDesglose<>'' then
        sDesglose := sDesglose + ',';

      fTotalEntrada     := Q2.FieldByName('UnidadesEntrada').AsFloat;
      fTotalEntradaBase := Q2.FieldByName('UnidadesEntradaBase').AsFloat;
      fTotalError       := Q2.FieldByName('CantidadErrorEntrada').AsFloat;
      fTotalErrorBase   := Q2.FieldByName('UnidadesErrorBase').AsFloat;

      sDesglose := sDesglose +
        '{' +
        '"RecepcionId":' + IntToStr(Q2.FieldByName('RecepcionId').AsInteger) + ',' +
        '"RecepcionIdLinea":' + IntToStr(Q2.FieldByName('RecepcionIdLinea').AsInteger) + ',' +
        '"RecepcionIdLineaDetalle":' + IntToStr(Q2.FieldByName('RecepcionIdLineaDetalle').AsInteger) + ',' +
        '"CodigoAlmacen":"' + Q2.FieldByName('CodigoAlmacen').AsString + '",' +
        '"CodigoUbicacion":"' + Q2.FieldByName('CodigoUbicacion').AsString + '",' +
        '"CodigoArticuloAlternativo":"' + Q2.FieldByName('CodigoAlternativo').AsString + '",' +
        '"CodigoAlmacenRechazos":"' + Q2.FieldByName('CodigoAlmacenRechazos').AsString + '",' +
        '"CodigoUbicacionRechazos":"' + Q2.FieldByName('CodigoUbicacionRechazos').AsString + '",' +
        '"Caja":"' + JSON_Str(Q2.FieldByName('Caja').AsString) + '",' +
        '"Palet":"' + JSON_Str(Q2.FieldByName('Palet').AsString) + '",' +
        '"Partida":"' + JSON_Str(Q2.FieldByName('Partida').AsString) + '",' +
        '"FechaCaduca":"' + Q2.FieldByName('FechaCaducidad').AsString + '",' +
        '"Verificacion":"' + JSON_Str(Q2.FieldByName('Verificacion').AsString) + '",' +
        '"IdIncidencia":"' + JSON_Str(Q2.FieldByName('AnomaliaId').AsString) + '",' +
        '"NombreIncidencia":"' + JSON_Str(Q2.FieldByName('NombreIncidencia').AsString) + '",' +
        '"Precio":' + SQL_FloatToStr(Q2.FieldByName('Precio').AsFloat) + ',' +
        '"UnidadesEntrada":' + SQL_FloatToStr(fTotalEntrada) + ',' +
        '"UnidadesEntradaBase":' + SQL_FloatToStr(fTotalEntradaBase) + ',' +
        '"CantidadErrorEntrada":' + SQL_FloatToStr(fTotalError) + ',' +
        '"CantidadErrorEntradaBase":' + SQL_FloatToStr(fTotalErrorBase) + ',' +
        '"TotalEntrada":' + SQL_FloatToStr(fTotalEntrada+fTotalError) + ',' +
        '"TotalEntradaBase":' + SQL_FloatToStr(fTotalEntradaBase+fTotalErrorBase) +
        '}';

      Q2.Next;

    end;

    Q2.Close;

    sDesglose := sDesglose + '';

    Result := Result +
      '{' +
      '"RecepcionId":' + Q.FieldByName('RecepcionId').AsString + ',' +
      '"RecepcionIdLinea":' + Q.FieldByName('RecepcionIdLinea').AsString + ',' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
      '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
      '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
      '"OrdenLineaPedido":"' + Q.FieldByName('OrdenLineaPedido').AsString + '",' +
      '"LineasPosicion":"' + Q.FieldByName('LineasPosicion').AsString + '",' +
      '"UdPedidas":' + SQL_FloatToStr(Q.FieldByName('UdPedidas').AsFloat) + ',' +
      '"UdRecibidas":' + SQL_FloatToStr(Q.FieldByName('UdRecibidas').AsFloat) + ',' +
      '"UdSaldo":' + SQL_FloatToStr(Q.FieldByName('UdSaldo').AsFloat) + ',' +
      '"Precio":' + SQL_FloatToStr(Q.FieldByName('Precio').AsFloat) + ',' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
      '"CodigoArticuloAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
      '"CodigoProveedor":"' + JSON_Str(Q.FieldByName('CodigoProveedor').AsString) + '",' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"IdAlbaranPro":"' + JSON_Str(Q.FieldByName('IdAlbaranPro').AsString) + '",' +
      '"Albaran":"' + JSON_Str(Q.FieldByName('Albaran').AsString) + '",' +
      '"FechaRecepcion":"' + Q.FieldByName('FechaRecepcion').AsString + '",' +
      '"TratamientoPartidas":' + IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString)) + '",' +
      '"Desglose":[' + sDesglose + ']' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q2.Close;
  FreeAndNil(Q2);
  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;

procedure WebModule1diagnosticsAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  iNumOperacionesPendientes: Integer;
  contentfields: TStringList;
{$ENDREGION}

begin

  {$REGION 'Recuperació de paràmetres'}

  REQUEST_Split ( sParams, contentfields );

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  * ' +
          'FROM FS_SGA_VIEW_DIAGNOSTICS WITH (NOLOCK) ' +
          'WHERE ' +
          '  oper_CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen);

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_Operations WITH (NOLOCK) ' +
          'WHERE '+
          '  oper_status = 0';

  iNumOperacionesPendientes := SQL_Execute ( Conn, sSQL );

  Result := '{"Result":"OK","Error":"","Data":[{' +
    '"NumOperacionesPendientes":' + IntToStr(iNumOperacionesPendientes) +
    '}]}';

  {$ENDREGION}

end;

{$ENDREGION}


{$REGION '--- FUNCIONS D´EMPRESES'}

// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT DE TOTES LES EMPRESES ACTIVES A SAGE                          │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listCabeceraAlbaranClienteAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoCliente: String;
  EjercicioAlbaran: Integer;
  sAndWhere: String;
  EmpresaOrigen: Integer;
  OrdenarPor: String;
  TipoOrden: String;
  sOrderBy: String;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoCliente    := (contentfields.values['CodigoCliente']);
  EjercicioAlbaran := StrToIntDef(contentfields.Values['EjercicioAlbaran'], 0 );

  OrdenarPor := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden  := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy   := '';

  if OrdenarPor='ALBARAN' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'EjercicioAlbaran DESC, NumeroAlbaran DESC, SerieAlbaran DESC ';
    end else begin
      sOrderBy := 'EjercicioAlbaran DESC, NumeroAlbaran, SerieAlbaran ';
    end;
  end else if OrdenarPor='CLIENTE' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'EjercicioAlbaran DESC, RazonSocial DESC, NumeroAlbaran DESC, SerieAlbaran DESC ';
    end else begin
      sOrderBy := 'EjercicioAlbaran DESC, RazonSocial, NumeroAlbaran, SerieAlbaran ';
    end;
  end else if OrdenarPor='FECHA' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'EjercicioAlbaran DESC, FechaAlbaran DESC, NumeroAlbaran DESC, SerieAlbaran DESC ';
    end else begin
      sOrderBy := 'EjercicioAlbaran DESC, FechaAlbaran, NumeroAlbaran, SerieAlbaran ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'EjercicioAlbaran DESC, NumeroAlbaran DESC, SerieAlbaran DESC ';
    end else begin
      sOrderBy := 'EjercicioAlbaran DESC, NumeroAlbaran, SerieAlbaran ';
    end;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sAndWhere := '';

  if CodigoCliente<>'' then begin
    sAndWhere := sAndWhere + 'AND CodigoCliente=''' + SQL_Str(CodigoCliente) + ''' ';
  end;

  if EjercicioAlbaran<>0 then begin
    sAndWhere := sAndWhere + 'AND EjercicioAlbaran=' + IntToStr(EjercicioAlbaran) + ' ';
  end;

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM CabeceraAlbaranCliente WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + //+ ' AND ' +
          //'  AND FechaAlbaran >= DATEADD(day,-30,GETDATE()) ' +
          //'  Estado <> 2 ' +
          sAndWhere;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT * ' +
    'FROM CabeceraAlbaranCliente WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    sAndWhere + ' ' +
    'ORDER BY ' + sOrderBy +
    'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
    'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"EjercicioAlbaran":' + Q.FieldByName('EjercicioAlbaran').AsString + ',' +
      '"SerieAlbaran":"' + Q.FieldByName('SerieAlbaran').AsString + '",' +
      '"NumeroAlbaran":' + Q.FieldByName('NumeroAlbaran').AsString + ',' +
      '"FechaAlbaran":"' + FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaAlbaran').AsDateTime ) + '",' +
      '"CodigoCliente":"' + Q.FieldByName('CodigoCliente').AsString + '",' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"Nombre":"' + JSON_Str(Q.FieldByName('Nombre').AsString) + '",' +
      '"Domicilio":"' + JSON_Str(Q.FieldByName('Domicilio').AsString) + '",' +
      '"CodigoPostal":"' + JSON_Str(Q.FieldByName('CodigoPostal').AsString) + '",' +
      '"Municipio":"' + JSON_Str(Q.FieldByName('Municipio').AsString) + '",' +
      '"Provincia":"' + JSON_Str(Q.FieldByName('Provincia').AsString) + '",' +
      '"Nacion":"' + JSON_Str(Q.FieldByName('Nacion').AsString) + '",' +
      '"NumeroLineas":' + Q.FieldByName('NumeroLineas').AsString + ',' +
      '"PesoBruto_":' + SQL_FloatToStr(Q.FieldByName('PesoBruto_').AsFloat) + ',' +
      '"PesoNeto_":' + SQL_FloatToStr(Q.FieldByName('PesoNeto_').AsFloat) + ',' +
      '"Volumen_":' + SQL_FloatToStr(Q.FieldByName('Volumen_').AsFloat) + ',' +
      '"IdAlbaranCli":"' + Q.FieldByName('IdAlbaranCli').AsString + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


procedure WebModule1listCabeceraAlbaranCompraAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoProveedor: String;
  EjercicioAlbaran: Integer;
  sAndWhere: String;
  EmpresaOrigen: Integer;
  OrdenarPor: String;
  TipoOrden: String;
  sOrderBy: String;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoProveedor  := (contentfields.values['CodigoProveedor']);
  EjercicioAlbaran := StrToIntDef(contentfields.Values['EjercicioAlbaran'], 0 );

  OrdenarPor := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden  := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy   := '';

  if OrdenarPor='ALBARAN' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'EjercicioAlbaran DESC, NumeroAlbaran DESC, SerieAlbaran DESC ';
    end else begin
      sOrderBy := 'EjercicioAlbaran DESC, NumeroAlbaran, SerieAlbaran ';
    end;
  end else if OrdenarPor='CLIENTE' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'EjercicioAlbaran DESC, RazonSocial DESC, NumeroAlbaran DESC, SerieAlbaran DESC ';
    end else begin
      sOrderBy := 'EjercicioAlbaran DESC, RazonSocial, NumeroAlbaran, SerieAlbaran ';
    end;
  end else if OrdenarPor='FECHA' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'EjercicioAlbaran DESC, FechaAlbaran DESC, NumeroAlbaran DESC, SerieAlbaran DESC ';
    end else begin
      sOrderBy := 'EjercicioAlbaran DESC, FechaAlbaran, NumeroAlbaran, SerieAlbaran ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'EjercicioAlbaran DESC, NumeroAlbaran DESC, SerieAlbaran DESC ';
    end else begin
      sOrderBy := 'EjercicioAlbaran DESC, NumeroAlbaran, SerieAlbaran ';
    end;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sAndWhere := '';

  if CodigoProveedor<>'' then begin
    sAndWhere := sAndWhere + 'AND CodigoProveedor=''' + SQL_Str(CodigoProveedor) + ''' ';
  end;

  if EjercicioAlbaran<>0 then begin
    sAndWhere := sAndWhere + 'AND EjercicioAlbaran=' + IntToStr(EjercicioAlbaran) + ' ';
  end;

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM CabeceraAlbaranProveedor WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
          //'  AND FechaAlbaran >= DATEADD(day,-30,GETDATE()) ' +
          sAndWhere;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  * ' +
          'FROM CabeceraAlbaranProveedor WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
          //'  AND FechaAlbaran >= DATEADD(day,-30,GETDATE()) ' +
          sAndWhere + ' ' +
          'ORDER BY ' +
          sOrderBy +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"EjercicioAlbaran":' + Q.FieldByName('EjercicioAlbaran').AsString + ',' +
      '"SerieAlbaran":"' + Q.FieldByName('SerieAlbaran').AsString + '",' +
      '"NumeroAlbaran":' + Q.FieldByName('NumeroAlbaran').AsString + ',' +
      '"FechaAlbaran":"' + FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaAlbaran').AsDateTime ) + '",' +
      '"NumeroLineas":' + Q.FieldByName('NumeroLineas').AsString + ',' +
      '"CodigoProveedor":"' + Q.FieldByName('CodigoProveedor').AsString + '",' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"Nombre":"' + JSON_Str(Q.FieldByName('Nombre').AsString) + '",' +
      '"Domicilio":"' + JSON_Str(Q.FieldByName('Domicilio').AsString) + '",' +
      '"CodigoPostal":"' + JSON_Str(Q.FieldByName('CodigoPostal').AsString) + '",' +
      '"Municipio":"' + JSON_Str(Q.FieldByName('Municipio').AsString) + '",' +
      '"Provincia":"' + JSON_Str(Q.FieldByName('Provincia').AsString) + '",' +
      '"Nacion":"' + JSON_Str(Q.FieldByName('Nacion').AsString) + '",' +
      '"IdAlbaranPro":"' + Q.FieldByName('IdAlbaranPro').AsString + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;



// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT DE PARTIDES D'UN ARTICLE                                      │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listPartidasAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoArticulo: String;
  CodigoAlmacen: String;
  GrupoTalla: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  sData: String;
  i: Integer;
  YY: Integer;
  CodigoUbicacion: String;
  UnidadMedida: String;
  sWhere: String;
  FechaCaduca: TDate;
  sFechaCaduca: String;
  Matricula: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoArticulo  := (contentfields.Values['CodigoArticulo']);
  CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);
  CodigoAlmacen   := (contentfields.values['CodigoAlmacen']);
  UnidadMedida    := (AnsiUpperCase(contentfields.Values['UnidadMedida']));
  Matricula       := (contentfields.Values['Matricula']);

  sWhere := '';
  if UnidadMedida<>'' then
    sWhere := sWhere + 'AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ';
  if CodigoUbicacion<>'' then
    sWhere := sWhere + 'AND CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + ''' ';
  if Matricula<>'*' then
  begin
    sWhere := sWhere + 'AND Matricula = ''' + SQL_Str(Matricula) + ''' ';
  end;
  if CodigoAlmacen<>'' then
    sWhere := sWhere + 'AND CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ';

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Date() );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL :=
    'SELECT ' +
    '  COUNT(DISTINCT Partida) ' +
    'FROM FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', ' + IntToStr(YY) + ' )' +
    'WHERE ' +
    '  CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
    '  AND Partida<>'''' ' +
    '  AND ( ' +
    '    UnidadesSaldo > 0 ' +
    '    OR UnidadesSaldoBase > 0 ' +
    '  ) ' +
    sWhere;
    //'  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
    //'  AND CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + '''';

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT DISTINCT ' +
    '   Partida, FechaCaduca ' +
    'FROM FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', ' + IntToStr(YY) + ' )' +
    'WHERE ' +
    '  CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
    '  AND Partida<>'''' ' +
    '  AND ( ' +
    '    UnidadesSaldo <> 0 ' +
    '    OR UnidadesSaldoBase <> 0 ' +
    '  ) ' +
    sWhere;
    //'  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
    //'  AND CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + '''';
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then
  begin
    Result := '{"Result":"OK","Error":"","TotalRecords":0,"NumPages":0,"NumRecords":0,"Data":[]}';
    Exit;
  end;

  iNumRegs := Q.RecordCount;
  sData := '';

  while not Q.Eof do
  begin

    FechaCaduca := Q.FieldByName('FechaCaduca').AsDateTime;
    if FechaCaduca>0 then
      sFechaCaduca := FormatDateTime('dd/mm/yyyy',FechaCaduca)
    else
      sFechaCaduca := '';

    if sData<>'' then
      sData := sData + ',';

    sData := sData +
      '{' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"FechaCaduca":"' + JSON_Str(sFechaCaduca) + '"' +
      '}';

    Q.Next;

  end;

  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) +
    ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[[' + sData + ']]}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT DE TALLES D'UN ARTICLE                                        │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listTallasAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoArticulo: String;
  CodigoUbicacion: String;
  UnidadMedida: String;
  GrupoTalla: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  sData: String;
  i: Integer;
  CodigoTalla: String;
  sDescripcionTalla: String;
{$ENDREGION}
begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoArticulo := (contentfields.Values['CodigoArticulo']);

  sSQL :=
    'SELECT GrupoTalla_ ' +
    'FROM Articulos WITH (NOLOCK) ' +
    'WHERE CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
    'AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + '''';
  GrupoTalla := SQL_Execute ( Conn, sSQL );

  CodigoArticulo  := (contentfields.Values['CodigoArticulo']);
  CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);
  UnidadMedida    := (AnsiUpperCase(contentfields.Values['UnidadMedida']));

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  if CodigoUbicacion='' then
  begin
    sSQL :=
      'SELECT ' +
      '  NumeroTallas_ ' +
      'FROM GrupoTallas_ WITH (NOLOCK) ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
      '  AND GrupoTalla_ = ' + IntToStr(GrupoTalla);
  end else begin
    sSQL :=
      'SELECT COUNT(DISTINCT CodigoTalla01_ ) ' +
      'FROM FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', YEAR(GETDATE()) ) ' +
      'WHERE ' +
      '  CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' '+
      '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
      '  AND CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + '''';
  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  if CodigoUbicacion='' then
  begin
    sSQL :=
      'SELECT * ' +
      'FROM GrupoTallas_ WITH (NOLOCK) ' +
      'WHERE CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
      'AND GrupoTalla_ = ' + IntToStr(GrupoTalla);
  end else begin
    sSQL :=
      'SELECT DISTINCT FSAS.CodigoTalla01_ ' +
      'FROM FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', YEAR(GETDATE()) ) FSAS ' +
      'WHERE ' +
      '  CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' '+
      '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
      '  AND CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + '''';
  end;
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then
  begin
    Result := '{"Result":"OK","Error":"","TotalRecords":0,"NumPages":0,"NumRecords":0,"Data":[]}';
    Exit;
  end;

  if CodigoUbicacion='' then
  begin

    iNumRegs := Q.RecordCount;
    sData := '';

    for i := 1 to iTotalRegs do
    begin
      if i>1 then
        sData := sData + ',';
      sData := sData +
        '{' +
        '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla' + Format('%0.2d',[i]) + '_').AsString) + '",' +
        '"DescripcionTalla":"' + JSON_Str(Q.FieldByName('DescripcionTalla' + Format('%0.2d',[i]) + '_').AsString) + '"' +
        '}';
    end;

  end else begin

    while not Q.EOF do
    begin

      CodigoTalla       := Q.FieldByName('CodigoTalla01_').AsString;
      sDescripcionTalla := FS_SAGE_DescripcionTalla ( Conn, CodigoEmpresa, GrupoTalla, CodigoTalla );

      if sData<>'' then sData := sData + ',';
      sData := sData +
        '{' +
        '"CodigoTalla":"' + JSON_Str(CodigoTalla) + '",' +
        '"DescripcionTalla":"' + JSON_Str(sDescripcionTalla) + '"' +
        '}';

      Q.Next;

    end;

  end;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) +
    ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[[' + sData + ']]}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT DE COLORS D'UN ARTICLE                                        │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listColoresAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoArticulo: String;
  CodigoUbicacion: String;
  UnidadMedida: String;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  sData: String;
  i: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Colores_' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    'AcumuladoStock;ColoresArticulo_;Colores_;CodigosTallaColor',
    CodigoEmpresa
  );

  CodigoArticulo  := (contentfields.Values['CodigoArticulo']);
  CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);
  UnidadMedida    := (AnsiUpperCase(contentfields.Values['UnidadMedida']));

  // Conversió al codi d'article real
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );


  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  if CodigoUbicacion<>'' then
  begin
    sSQL :=
      'SELECT COUNT(DISTINCT CodigoColor_) ' +
      'FROM FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', YEAR(GETDATE()) ) ' +
      'WHERE ' +
      '  CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' '+
      '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
      '  AND CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + '''';
  end else begin
    sSQL :=
      'SELECT COUNT(*) ' +
      'FROM ColoresArticulo_ WITH (NOLOCK) ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.ColoresArticulo) + ' ' +
      '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + '''';
  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  if CodigoUbicacion<>'' then
  begin
    sSQL :=
      'SELECT DISTINCT UBI.CodigoColor_, C.Color_, ISNULL(ctc.CodigoAlternativo, '''') AS CodigoAlternativoTC ' +
      'FROM FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', YEAR(GETDATE()) ) UBI ' +
      'INNER JOIN ColoresArticulo_ CA WITH (NOLOCK) ' +
      'ON CA.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.ColoresArticulo) + ' ' +
      'AND CA.CodigoArticulo = UBI.CodigoArticulo ' +
      'INNER JOIN Colores_ C WITH (NOLOCK) ' +
      'ON C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
      'AND C.CodigoColor_ = UBI.CodigoColor_ ' +
      'INNER JOIN Articulos A WITH (NOLOCK) ' +
      'ON A.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
      'AND UBI.CodigoArticulo = A.CodigoArticulo ' +
      'LEFT JOIN CodigosTallaColor ctc WITH (NOLOCK) ON ctc.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
      'AND ctc.CodigoArticulo = A.CodigoArticulo ' +
      'AND ctc.CodigoColor_ = CA.CodigoColor_ ' +
      'WHERE UBI.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
      'AND A.Colores_ <> 0 ' +
      'ORDER BY C.Color_';
  end else begin
    sSQL :=
      'SELECT DISTINCT CA.CodigoColor_, C.Color_, ISNULL(ctc.CodigoAlternativo, '''') AS CodigoAlternativoTC ' +
      'FROM ColoresArticulo_ CA WITH (NOLOCK) ' +
      'INNER JOIN Colores_ C WITH (NOLOCK) ' +
      'ON C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
      'AND C.CodigoColor_ = CA.CodigoColor_ ' +
      'INNER JOIN Articulos A WITH (NOLOCK) ' +
      'ON A.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.ColoresArticulo) + ' ' +
      'AND CA.CodigoArticulo = A.CodigoArticulo ' +
      'LEFT JOIN CodigosTallaColor ctc WITH (NOLOCK) ON ctc.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
      'AND ctc.CodigoArticulo = A.CodigoArticulo ' +
      'AND ctc.CodigoColor_ = CA.CodigoColor_ ' +
      'WHERE CA.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.ColoresArticulo) + ' ' +
      'AND CA.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
      'AND A.Colores_ <> 0 ' +
      'ORDER BY C.Color_';
  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  iNumRegs := Q.RecordCount;

  sData := '';
  while not Q.EOF do
  begin
    if sData<>'' then
      sData := sData + ',';
    sData := sData +
      '{' +
      '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
      '"DescripcionColor":"' + JSON_Str(Q.FieldByName('Color_').AsString) + '",' +
      '"CodigoAlternativoTC":"' + JSON_Str(Q.FieldByName('CodigoAlternativoTC').AsString) + '"' +
      '}';
    Q.Next;
  end;

  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) +
    ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[[' + sData + ']]}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT DE CLIENTS D'UNA EMPRESA                                      │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listClientesAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Filter: String;
  sAndWhere: String;
  EmpresaOrigen: Integer;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  Filter := (contentfields.Values['Filtro']);

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sAndWhere := '';

  if Filter<>'' then begin
    sAndWhere := sAndWhere + 'AND ( ' +
                             '  c.Nombre LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  c.RazonSocial LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  c.Domicilio LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  c.CodigoCliente LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  c.CodigoPostal LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  c.Municipio LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  c.Provincia LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  c.Telefono LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  c.Telefono2 LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  c.Telefono3 LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  c.Email1 LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  c.Email2 LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  c.CifDni LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  c.CifEuropeo LIKE ''%' + SQL_Str(Filter) + '%'' ' +
                             ')';
  end;

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM Clientes c WITH (NOLOCK) ' +
          'WHERE ' +
          '  c.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Clientes) + ' AND ' +
          '  c.FechaBajaLc IS NULL ' +
          sAndWhere;


  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  c.* ' +
          'FROM Clientes c WITH (NOLOCK) ' +
          'WHERE ' +
          '  c.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Clientes) + ' AND ' +
          '  c.FechaBajaLc IS NULL ' +
          sAndWhere +
          'ORDER BY ' +
          '  c.CodigoEmpresa, c.RazonSocial ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"CodigoCliente":"' + Q.FieldByName('CodigoCliente').AsString + '",' +
      '"CifEuropeo":"' + JSON_Str(Q.FieldByName('CifEuropeo').AsString) + '",' +
      '"Nombre":"' + JSON_Str(Q.FieldByName('Nombre').AsString) + '",' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"Domicilio":"' + JSON_Str(Q.FieldByName('Domicilio').AsString) + '",' +
      '"CodigoPostal":"' + JSON_Str(Q.FieldByName('CodigoPostal').AsString) + '",' +
      '"Municipio":"' + JSON_Str(Q.FieldByName('Municipio').AsString) + '",' +
      '"Provincia":"' + JSON_Str(Q.FieldByName('Provincia').AsString) + '",' +
      '"Nacion":"' + JSON_Str(Q.FieldByName('Nacion').AsString) + '",' +
      '"Telefono":"' + JSON_Str(Q.FieldByName('Telefono').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


procedure Recuperar_imatge ( Conn: TADOConnection; Taula, Camp, Index, Valor: String; var Imatge: TImage; Escala: TJPEGScale = jsEighth );

  function IsBMP ( var Stream: TStream ): Boolean;
  var
    FileSize: integer;    // calculated file size
    ImageSize: integer;    // calculated image size
    bmf: TBITMAPFILEHEADER;  // the bitmap header
    lpBitmapInfo: PBITMAPINFO;  // bitmap info record
    BitmapHeaderSize: integer;  // size of header of bitmap
    BitmapInfo: PBITMAPINFO;
    bits: Pointer;
  begin

    Result := False;

    FileSize := Stream.Size;
    Stream.ReadBuffer ( bmf, SizeOf(TBITMAPFILEHEADER) );
    BitmapHeaderSize := bmf.bfOffBits - SizeOf(TBITMAPFILEHEADER);
    ImageSize := FileSize - Integer(bmf.bfOffBits);
    if ((bmf.bfType <> $4D42) or
      (Integer(bmf.bfOffBits) < 1) or
      (FileSize < 1) or (BitmapHeaderSize < 1) or (ImageSize < 1) or
      (FileSize < (SizeOf(TBITMAPFILEHEADER) + BitmapHeaderSize + ImageSize))) then
     Result := False
    else
     Result := True;

  end;

var
  MS: TStream;
  J1: TJPEGImage;
  bIsBitmap: Boolean;
  Q: TADOQuery;
  sSQL: String;

begin

  J1 := TJPEGImage.Create;
  MS := TMemoryStream.Create;
  bIsBitmap := False;

  Imatge.Picture.Assign ( nil );

  if Trim(Valor)='' then Exit;

  sSQL := 'SELECT ' + Camp + ' FROM ' + Taula + ' WITH (NOLOCK) WHERE ' + Index + ' =''' + Valor + '''';
  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    Q.Free;
  end;

  if Q.EOF then begin
    Q.Close;
    Q.Free;
    Exit;
  end;

  // BMP
  try

    TBlobField(Q.Fields[0]).SaveToStream(MS);
    MS.Seek ( soFromBeginning, 0 );

    if MS.Size <= 0 then begin
       J1.Free;
       MS.Free;
       Exit;
    end;

    bIsBitmap := IsBMP ( MS );
    if bIsBitmap then begin
     MS.Seek ( soFromBeginning, 0 );
     Imatge.Picture.Bitmap.LoadFromStream ( MS );
    end;

  except
  end;

  Q.Close;
  Q.Free;

  if bIsBitmap then begin
     J1.Free;
     MS.Free;
     Exit;
  end;

  // JPEG
  try
    MS.Seek ( soFromBeginning, 0 );
    with J1 do begin
      PixelFormat         := jf24Bit;
      Scale               := Escala;
      Grayscale           := False;
      Performance         := jpBestSpeed;
      ProgressiveDisplay  := True;
      ProgressiveEncoding := True;
      Smoothing           := True;
      LoadFromStream ( MS );
    end;
    Imatge.Picture.Bitmap.Assign ( J1 );
  except
    Imatge.Picture.Graphic := nil;
  end;
  J1.Free;
  MS.Free;

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ RECUPERAR LA IMATGE D'UN ARTICLE                                      │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1artImageAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
var
  sBase64        : String;
  MS             : TStream;
  Encoder        : TIdEncoderMIME;
  Image          : TImage;
  J1             : TJPEGImage;
  bIsBitmap      : Boolean;
  CodigoUsuario  : Integer;
  contentfields  : TStringList;
  sSQL           : string;
  Q              : TADOQuery;
  EmpresaOrigen  : Integer;
  CodigoEmpresa  : TOrigenCodigoEmpresa;
  CodigoArticulo : string;
begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario  := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  CodigoArticulo := contentfields.Values['CodigoArticulo'];
  MS            := TMemoryStream.Create;
  Encoder       := TIdEncoderMIME.Create(nil);
  sBase64       := '';

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT TOP 1 img.sysBinario ' +
    'FROM lsysBinary img WITH (NOLOCK) ' +
    'INNER JOIN Articulos art WITH (NOLOCK) ' +
    'ON ' +
    '  art.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
    '  AND art.ImagenExt = img.sysIdBinario ' +
    'WHERE ' +
    '  art.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
    '  AND art.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + '''';
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if not Q.EOF then
  begin

    try
      TBlobField(Q.Fields[0]).SaveToStream(MS);
      MS.Seek ( soFromBeginning, 0 );
      sBase64 := Encoder.Encode(MS);
    except
    end;

  end;

  MS.Free;
  Encoder.Free;
  Q.Close;
  FreeAndNil(Q);

  if sBase64<>'' then
  begin

    Result := '{"Result":"OK","Error":"","Data":"' + sBase64 + '"}';

  end else begin

    Result := '{"Result":"ERROR","Error":"Error al cargar la imagen del usuario","Data":""}';

  end;

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ RECUPERAR LA IMATGE DE L'USUARI                                       │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1userImageAction  ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
var
  sBase64       : String;
  MS            : TStream;
  Encoder       : TIdEncoderMIME;
  Image         : TImage;
  J1            : TJPEGImage;
  bIsBitmap     : Boolean;
  CodigoUsuario : Integer;
  contentfields : TStringList;
  sSQL          : string;
  Q             : TADOQuery;
begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  MS            := TMemoryStream.Create;
  Encoder       := TIdEncoderMIME.Create(nil);
  sBase64       := '';

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT UserImage ' +
    'FROM FS_SGA_Usuarios WITH (NOLOCK) ' +
    'WHERE CodigoUsuario = ' + IntToStr(CodigoUsuario) + ' ' +
    'AND UserImage IS NOT NULL';
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if not Q.EOF then
  begin

    try
      TBlobField(Q.Fields[0]).SaveToStream(MS);
      MS.Seek ( soFromBeginning, 0 );
      sBase64 := Encoder.Encode(MS);
    except
    end;

  end;

  MS.Free;
  Encoder.Free;
  Q.Close;
  FreeAndNil(Q);

  if sBase64<>'' then
  begin

    Result := '{"Result":"OK","Error":"","Data":"' + sBase64 + '"}';

  end else begin

    Result := '{"Result":"ERROR","Error":"Error al cargar la imagen del usuario","Data":""}';

  end;

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ RECUPERAR EL LOGO DEL CLIENT                                          │ \\
// │ L'arxiu d'estar a la mateixa carpeta del servei i s'ha de dir         │ \\
// │ logo.png                                                              │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1logoAction  ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
var
  sBase64 : String;
  Stream  : TFileStream;
  Encoder : TIdEncoderMIME;
  sLogo   : String;
begin

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_Logo, sLogo, 0 );
  if (sLogo='0') or (sLogo='') then
    sLogo := 'logo.png';

  try
    Stream := TFileStream.Create(gsPath + '\' + sLogo, fmOpenRead or fmShareDenyWrite);
  except
    on E:Exception do
    begin
      gaLogFile.Write_DBException(E,'', 'Error al cargar el logotipo ' + sLogo, CONST_LOGID_GENERAL);
      Result := '{"Result":"ERROR","Error":"Error al cargar el logotipo","Data":""}';
      Exit;
    end;
  end;

  Encoder := TIdEncoderMIME.Create(nil);

  try
    sBase64 := Encoder.Encode(Stream);
  except
    on E:Exception do
    begin
      Encoder.Free;
      Stream.Free;
      gaLogFile.Write_DBException(E,'', 'Error al codificar en base64 el logotipo', CONST_LOGID_GENERAL);
      Result := '{"Result":"ERROR","Error":"Error al cargar el logotipo","Data":""}';
      Exit;
    end;
  end;

  Encoder.Free;
  Stream.Free;

  Result := '{"Result":"OK","Error":"","Data":"' + sBase64 + '"}';

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ DADES DE LLICÈNCIA                                                    │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getLicenseInfoAction  ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  contentfields: TStringList;
{$ENDREGION}

begin

  Result :=
    '{"Result":"OK","Error":"","Data":[{' +
    '"customerCode":"' + JSON_Str(gsCustomerCode) + '"' +
    '}]}';

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ DADES DE CONNEXIÓ                                                     │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getConnectionInfoAction  ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  contentfields: TStringList;
{$ENDREGION}

begin

  Result :=
    '{"Result":"OK","Error":"","Data":[{' +
    '"Servidor":"' + JSON_Str(gsHost) + '",' +
    '"BBDD":"' + JSON_Str(gsBBDD) + '",' +
    '"VersionWS":"' + JSON_Str(TVSFixedFileInfo.FileVersion) + '"' +
    '}]}';

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT D'EMPRESES                                                    │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listCompaniesAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM Empresas WITH (NOLOCK) ' +
          'WHERE ' +
          '  FechaBaja IS NULL ' +
          '  OR (FechaBaja > Getdate()) ' +
          '  OR (YEAR(FechaBaja)=1899) ';

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  CodigoEmpresa, Empresa ' +
          'FROM Empresas WITH (NOLOCK) ' +
          'WHERE ' +
          '  FechaBaja IS NULL ' +
          '  OR (FechaBaja > Getdate()) ' +
          '  OR (YEAR(FechaBaja)=1899) ' +
          'ORDER BY ' +
          '  CodigoEmpresa ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ', ' +
      '"Empresa":"' + JSON_Str(Q.FieldByName('Empresa').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


procedure WebModule1listDevolucionesAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Tipo: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Filter: String;
  sAndWhere: String;
  sSort: String;
  CodigoUsuario: Integer;
  EmpresaOrigen: Integer;
  sFecha: String;
  contentfields: TStringList;
  sFechaInicio: string;
  sFechaFin: string;
  sFechaAlbaranRef: String;
  lSortItems: TStringList;
  sortItem: String;
  sAscDesc: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  Tipo := StrToIntDef(contentfields.values['Tipo'],0);

  sSort := AnsiLowerCase((contentfields.Values['OrdenarPor']));

  lSortItems := TStringList.Create;
  lSortItems.Delimiter := '|';
  lSortItems.StrictDelimiter := TRUE;
  lSortItems.DelimitedText := sSort;

  sSort := '';

  while lSortItems.Count>0 do
  begin

    if sSort<>'' then
      sSort := sSort + ', ';

    sortItem := AnsiUpperCase(lSortItems[0]);
    sAscDesc := '';

    if LeftStr(sortItem,1)='-' then
    begin
      sAscDesc := ' DESC';
      Delete(sortItem,1,1);
    end;

    if sortItem = 'FECHA' then
    begin
      if Tipo = 0 then sSort := sSort + 'd.Fecha' + sAscDesc
      else if Tipo = 1 then sSort := sSort + 'd.FechaInicioRecepcion' + sAscDesc
      else sSort := sSort + 'd.FechaFinRecepcion' + sAscDesc;
    end else if (sortItem='CLIENTE') then
      sSort := sSort + 'd.CodigoCliente' + sAscDesc
    else if (sortItem='LINEAS') then
      sSort := sSort + '1' + sAscDesc
    else if (sortItem='PEDIDO') then
      sSort := sSort + 'd.EjercicioPedido' + sAscDesc + ', d.NumeroPedido' + sAscDesc + ', d.SeriePedido' + sAscDesc
    else if (sortItem='DEVOLUCION') then
      sSort := sSort + 'd.DevolucionId' + sAscDesc
    else
      sSort := sSort + 'd.DevolucionId' + sAscDesc;

    lSortItems.Delete(0);

  end;

  lSortItems.Free;

  if sSort='' then
  begin
    sSort := 'd.DevolucionId';
  end;

  if (Pos('devolucionid', ansilowercase(sSort))<=0) then
    sSort := sSort + ', d.DevolucionId';

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sAndWhere := ' ';

  if (Tipo=0) or (Tipo=1) then
  begin
    sAndWhere := sAndWhere +
      'AND d.Estado = ' + IntToStr(Tipo) + ' ' +
      'AND cpc.Estado = 0 ';
  end else begin
    sAndWhere := sAndWhere +
      'AND d.Estado IN (2,3) ';
  end;

  sSQL :=
    'SELECT ' +
    '  COUNT(*) ' +
    'FROM FS_SGA_Devoluciones d WITH (NOLOCK) ' +
    'INNER JOIN CabeceraPedidoCliente cpc WITH (NOLOCK) ' +
    'ON ' +
    '  d.CodigoEmpresa = cpc.CodigoEmpresa ' +
    '  AND d.EjercicioPedido = cpc.EjercicioPedido ' +
    '  AND d.SeriePedido = cpc.SeriePedido ' +
    '  AND d.NumeroPedido = cpc.NumeroPedido ' +
    'WHERE ' +
    '  d.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    sAndWhere;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT DISTINCT ' +
    '  ( ' +
    '    SELECT ' +
    '      COUNT(*) ' +
    '    FROM FS_SGA_Devoluciones_Lineas dl WITH (NOLOCK) ' +
    '    INNER JOIN LineasPedidoCliente lpc WITH (NOLOCK) ' +
    '    ON ' +
    '      dl.CodigoEmpresa = lpc.CodigoEmpresa ' +
    '      AND dl.EjercicioPedido = lpc.EjercicioPedido ' +
    '      AND dl.SeriePedido = lpc.SeriePedido ' +
    '      AND dl.NumeroPedido = lpc.NumeroPedido ' +
    '      AND dl.OrdenLineaPedido = lpc.Orden ' +
    '      AND dl.LineasPosicion = lpc.LineasPosicion ' +
    '    INNER JOIN Articulos ART WITH (NOLOCK) ' +
    '    ON ' +
    '      ART.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
    '      AND ART.CodigoArticulo = lpc.CodigoArticulo ' +
    '    WHERE ' +
    '      d.CodigoEmpresa = dl.CodigoEmpresa ' +
    '      AND d.DevolucionId = dl.DevolucionId ' +
    '      AND ART.TipoArticulo = ''M'' ' +
    '  ) AS NumLineasTotales, ' +
    '  ( ' +
    '    SELECT ' +
    '      COUNT(*) ' +
    '    FROM FS_SGA_Devoluciones_Lineas dl WITH (NOLOCK) ' +
    '    INNER JOIN LineasPedidoCliente lpc WITH (NOLOCK) ' +
    '    ON ' +
    '      dl.CodigoEmpresa = lpc.CodigoEmpresa ' +
    '      AND dl.EjercicioPedido = lpc.EjercicioPedido ' +
    '      AND dl.SeriePedido = lpc.SeriePedido ' +
    '      AND dl.NumeroPedido = lpc.NumeroPedido ' +
    '      AND dl.OrdenLineaPedido = lpc.Orden ' +
    '      AND dl.LineasPosicion = lpc.LineasPosicion ' +
    '    INNER JOIN Articulos ART WITH (NOLOCK) ' +
    '    ON ' +
    '      ART.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
    '      AND ART.CodigoArticulo = lpc.CodigoArticulo ' +
    '    WHERE ' +
    '      d.CodigoEmpresa = dl.CodigoEmpresa ' +
    '      AND d.DevolucionId = dl.DevolucionId ' +
    '      AND (dl.UdSaldo<0 OR dl.UdSaldoBase<0) ' +
    '      AND ART.TipoArticulo = ''M'' ' +
    '  ) AS NumLineasPendientes, ' +
    '  d.* ' +
    'FROM FS_SGA_Devoluciones d WITH (NOLOCK) ' +
    'INNER JOIN CabeceraPedidoCliente cpc WITH (NOLOCK) ' +
    'ON ' +
    '  d.CodigoEmpresa = cpc.CodigoEmpresa AND ' +
    '  d.EjercicioPedido = cpc.EjercicioPedido AND ' +
    '  d.SeriePedido = cpc.SeriePedido AND ' +
    '  d.NumeroPedido = cpc.NumeroPedido ' +
    'INNER JOIN FS_SGA_Devoluciones_Lineas dl WITH (NOLOCK) ' +
    'ON ' +
    '  d.CodigoEmpresa = dl.CodigoEmpresa ' +
    '  AND d.DevolucionId = dl.DevolucionId ' +
    'INNER JOIN LineasPedidoCliente LPC WITH (NOLOCK) ' +
    'ON dl.CodigoEmpresa = LPC.CodigoEmpresa ' +
    'AND dl.EjercicioPedido = LPC.EjercicioPedido ' +
    'AND dl.SeriePedido = LPC.SeriePedido ' +
    'AND dl.NumeroPedido = LPC.NumeroPedido ' +
    'AND dl.OrdenLineaPedido = LPC.Orden ' +
    'AND dl.LineasPosicion = LPC.LineasPosicion ' +
    'WHERE ' +
    '  d.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    sAndWhere +
    'ORDER BY ' +
    sSort + ' ' +
    'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
    'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    if (Q.FieldByName('Fecha').IsNull) or (Q.FieldByName('Fecha').AsDateTime=0) then
      sFecha := FormatDateTime ( 'dd/mm/yyyy', Now)
    else
      sFecha := FormatDateTime ( 'dd/mm/yyyy', Q.FieldByName('Fecha').AsDateTime);

    if Q.FieldByName('FechaInicioRecepcion').AsDateTime>0 then
      sFechaInicio := FormatDateTime ( 'dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaInicioRecepcion').AsDateTime)
    else
      sFechaInicio := '';

    if Q.FieldByName('FechaFinRecepcion').AsDateTime>0 then
      sFechaFin := FormatDateTime ( 'dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaFinRecepcion').AsDateTime)
    else
      sFechaFin := '';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"DevolucionId":' + Q.FieldByName('DevolucionId').AsString + ',' +
      '"Fecha":"' + sFecha + '",' +
      '"CodigoCliente":"' + JSON_Str(Q.FieldByName('CodigoCliente').AsString) + '",' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"IdAlbaranCli":"' + JSON_Str(Q.FieldByName('IdAlbaranCli').AsString) + '",' +
      '"Albaran":"' + JSON_Str(Q.FieldByName('Albaran').AsString) + '",' +
      '"Observaciones":"' + JSON_Str(Q.FieldByName('Observaciones').AsString) + '",' +
      '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
      '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
      '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
      '"FechaInicioDevolucion":"' + sFechaInicio + '",' +
      '"FechaFinDevolucion":"' + sFechaFin + '",' +
      '"Bultos":' + IntToStr(Q.FieldByName('Bultos').AsInteger) + ',' +
      '"Cajas":' + IntToStr(Q.FieldByName('Cajas').AsInteger) + ',' +
      '"Palets":' + IntToStr(Q.FieldByName('Palets').AsInteger) + ',' +
      '"Estado":' + Q.FieldByName('Estado').AsString + ',' +
      '"NumLineasTotales":' + Q.FieldByName('NumLineasTotales').AsString + ',' +
      '"NumLineasPendientes":' + Q.FieldByName('NumLineasPendientes').AsString + ',' +
      '"NumLineasRealizadas":' + IntToStr(Q.FieldByName('NumLineasTotales').AsInteger-Q.FieldByName('NumLineasPendientes').AsInteger) +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


procedure WebModule1listDevolucionesProvAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Tipo: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Filter: String;
  sAndWhere: String;
  sSort: String;
  sSortType: String;
  CodigoUsuario: Integer;
  EmpresaOrigen: Integer;
  sFecha: String;
  contentfields: TStringList;
  sFechaInicio: string;
  sFechaFin: string;
  sFechaAlbaranRef: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  Tipo := StrToIntDef(contentfields.values['Tipo'],0);

  sSort := AnsiLowerCase((contentfields.Values['OrdenarPor']));
  sSortType := AnsiLowerCase((contentfields.Values['TipoOrden']));

  if (sSort='fecha') then
    sSort := ' d.Fecha ' + sSortType
  else if (sSort='proveedor') then
    sSort := ' d.CodigoProveedor ' + sSortType
  else if (sSort='lineas') then
    sSort := ' 1 ' + sSortType
  else if (sSort='pedido') then
    sSort := ' d.EjercicioPedido ' + sSortType + ', d.NumeroPedido ' + sSortType + ', d.SeriePedido ' + sSortType
  else
    sSort := ' d.DevolucionId ' + sSortType;

  sSort := sSort + ' ';

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sAndWhere := ' ';

  if (Tipo=0) or (Tipo=1) then
  begin
    sAndWhere := sAndWhere +
      'AND d.Estado = ' + IntToStr(Tipo) + ' ' +
      'AND cpp.Estado = 0 ';
  end else begin
    sAndWhere := sAndWhere +
      'AND d.Estado IN (2,3) ';
  end;

  sSQL :=
    'SELECT ' +
    '  COUNT(*) ' +
    'FROM FS_SGA_DevolucionesP d WITH (NOLOCK) ' +
    'INNER JOIN CabeceraPedidoProveedor cpp WITH (NOLOCK) ' +
    'ON ' +
    '  d.CodigoEmpresa = cpp.CodigoEmpresa ' +
    '  AND d.EjercicioPedido = cpp.EjercicioPedido ' +
    '  AND d.SeriePedido = cpp.SeriePedido ' +
    '  AND d.NumeroPedido = cpp.NumeroPedido ' +
    'WHERE ' +
    '  d.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    sAndWhere;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT DISTINCT ' +
    '  ( ' +
    '    SELECT ' +
    '      COUNT(*) ' +
    '    FROM FS_SGA_DevolucionesP_Lineas dl WITH (NOLOCK) ' +
    '    INNER JOIN LineasPedidoProveedor lpp WITH (NOLOCK) ' +
    '    ON ' +
    '      dl.CodigoEmpresa = lpp.CodigoEmpresa ' +
    '      AND dl.EjercicioPedido = lpp.EjercicioPedido ' +
    '      AND dl.SeriePedido = lpp.SeriePedido ' +
    '      AND dl.NumeroPedido = lpp.NumeroPedido ' +
    '      AND dl.OrdenLineaPedido = lpp.Orden ' +
    '      AND dl.LineasPosicion = lpp.LineasPosicion ' +
    '    WHERE ' +
    '      d.CodigoEmpresa = dl.CodigoEmpresa ' +
    '      AND d.DevolucionId = dl.DevolucionId ' +
    '  ) AS NumLineasTotales, ' +
    '  ( ' +
    '    SELECT ' +
    '      COUNT(*) ' +
    '    FROM FS_SGA_DevolucionesP_Lineas dl WITH (NOLOCK) ' +
    '    INNER JOIN LineasPedidoProveedor lpp WITH (NOLOCK) ' +
    '    ON ' +
    '      dl.CodigoEmpresa = lpp.CodigoEmpresa ' +
    '      AND dl.EjercicioPedido = lpp.EjercicioPedido ' +
    '      AND dl.SeriePedido = lpp.SeriePedido ' +
    '      AND dl.NumeroPedido = lpp.NumeroPedido ' +
    '      AND dl.OrdenLineaPedido = lpp.Orden ' +
    '      AND dl.LineasPosicion = lpp.LineasPosicion ' +
    '    WHERE ' +
    '      d.CodigoEmpresa = dl.CodigoEmpresa ' +
    '      AND d.DevolucionId = dl.DevolucionId ' +
    '      AND (dl.UdSaldo<0 OR dl.UdSaldoBase<0) ' +
    '  ) AS NumLineasPendientes, ' +
    '  d.* ' +
    'FROM FS_SGA_DevolucionesP d WITH (NOLOCK) ' +
    'INNER JOIN CabeceraPedidoProveedor cpp WITH (NOLOCK) ' +
    'ON ' +
    '  d.CodigoEmpresa = cpp.CodigoEmpresa AND ' +
    '  d.EjercicioPedido = cpp.EjercicioPedido AND ' +
    '  d.SeriePedido = cpp.SeriePedido AND ' +
    '  d.NumeroPedido = cpp.NumeroPedido ' +
    'INNER JOIN FS_SGA_DevolucionesP_Lineas dl WITH (NOLOCK) ' +
    'ON ' +
    '  d.CodigoEmpresa = dl.CodigoEmpresa ' +
    '  AND d.DevolucionId = dl.DevolucionId ' +
    'INNER JOIN LineasPedidoProveedor LPP WITH (NOLOCK) ' +
    'ON dl.CodigoEmpresa = LPP.CodigoEmpresa ' +
    'AND dl.EjercicioPedido = LPP.EjercicioPedido ' +
    'AND dl.SeriePedido = LPP.SeriePedido ' +
    'AND dl.NumeroPedido = LPP.NumeroPedido ' +
    'AND dl.OrdenLineaPedido = LPP.Orden ' +
    'AND dl.LineasPosicion = LPP.LineasPosicion ' +
    'WHERE ' +
    '  d.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    sAndWhere +
    'ORDER BY ' +
    sSort +
    'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
    'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    if (Q.FieldByName('Fecha').IsNull) or (Q.FieldByName('Fecha').AsDateTime=0) then
      sFecha := FormatDateTime ( 'dd/mm/yyyy', Now)
    else
      sFecha := FormatDateTime ( 'dd/mm/yyyy', Q.FieldByName('Fecha').AsDateTime);

    if Q.FieldByName('FechaInicioRecepcion').AsDateTime>0 then
      sFechaInicio := FormatDateTime ( 'dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaInicioRecepcion').AsDateTime)
    else
      sFechaInicio := '';

    if Q.FieldByName('FechaFinRecepcion').AsDateTime>0 then
      sFechaFin := FormatDateTime ( 'dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaFinRecepcion').AsDateTime)
    else
      sFechaFin := '';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"DevolucionId":' + Q.FieldByName('DevolucionId').AsString + ',' +
      '"Fecha":"' + sFecha + '",' +
      '"CodigoProveedor":"' + JSON_Str(Q.FieldByName('CodigoProveedor').AsString) + '",' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"IdAlbaranPro":"' + JSON_Str(Q.FieldByName('IdAlbaranPro').AsString) + '",' +
      '"Albaran":"' + JSON_Str(Q.FieldByName('Albaran').AsString) + '",' +
      '"Observaciones":"' + JSON_Str(Q.FieldByName('Observaciones').AsString) + '",' +
      '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
      '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
      '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
      '"FechaInicioDevolucion":"' + sFechaInicio + '",' +
      '"FechaFinDevolucion":"' + sFechaFin + '",' +
      '"Bultos":' + IntToStr(Q.FieldByName('Bultos').AsInteger) + ',' +
      '"Cajas":' + IntToStr(Q.FieldByName('Cajas').AsInteger) + ',' +
      '"Palets":' + IntToStr(Q.FieldByName('Palets').AsInteger) + ',' +
      '"Estado":' + Q.FieldByName('Estado').AsString + ',' +
      '"NumLineasTotales":' + Q.FieldByName('NumLineasTotales').AsString + ',' +
      '"NumLineasPendientes":' + Q.FieldByName('NumLineasPendientes').AsString + ',' +
      '"NumLineasRealizadas":' + IntToStr(Q.FieldByName('NumLineasTotales').AsInteger-Q.FieldByName('NumLineasPendientes').AsInteger) +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ GUARDAR MÈTODE DE RUTA                                                │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1saveMetodoRutaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
var
  contentfields: TStringList;
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoUsuario: Integer;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  PreparacionId: Integer;
  MetodoCalculo: String;
  OrdenCalculo: String;
  PermitirCaducados: string;
  VidaUtil: Integer;
  UnidadVidaUtil: string;
  IncluirReservas: boolean;
  SoloReservas: boolean;
  IgnorarPartidas: boolean;
  IgnorarUbicaciones: boolean;
  Clear: Boolean;
{$ENDREGION}

begin


  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario      := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  PreparacionId      := StrToIntDef(contentfields.values['PreparacionId'],0);
  MetodoCalculo      := AnsiUpperCase(contentfields.values['MetodoCalculo']);
  OrdenCalculo       := AnsiUpperCase(contentfields.values['OrdenCalculo']);
  PermitirCaducados  := AnsiUpperCase(contentfields.values['PermitirCaducados']);
  VidaUtil           := StrToIntDef(contentfields.values['VidaUtil'],0);
  UnidadVidaUtil     := AnsiLowerCase(contentfields.values['UnidadVidaUtil']);
  IncluirReservas    := (contentfields.values['IncluirReservas']='1');
  SoloReservas       := (contentfields.values['SoloReservas']='1');
  IgnorarPartidas    := (contentfields.values['IgnorarPartidas']='1');
  IgnorarUbicaciones := (contentfields.values['IgnorarUbicaciones']='1');
  Clear             := (contentfields.values['Clear']='1');

  if Clear then
  begin
    sSQL :=
      'UPDATE FS_SGA_Picking_Preparaciones ' +
      'SET ' +
      '  MetodoCalculo = NULL, ' +
      '  OrdenCalculo = NULL, ' +
      '  PermitirCaducados = NULL, ' +
      '  VidaUtil = NULL, ' +
      '  UnidadVidaUtil = NULL, ' +
      '  IncluirReservas = NULL, ' +
      '  SoloReservas = NULL, ' +
      '  IgnorarPartidas = NULL, ' +
      '  IgnorarUbicaciones = NULL ' +
      'WHERE ' +
      '  PreparacionId = ' + IntToStr(PreparacionId);
  end else begin
    sSQL :=
      'UPDATE FS_SGA_Picking_Preparaciones ' +
      'SET ' +
      '  MetodoCalculo = ''' + SQL_Str(MetodoCalculo) + ''', ' +
      '  OrdenCalculo = ''' + SQL_Str(OrdenCalculo) + ''', ' +
      '  PermitirCaducados = ''' + SQL_Str(PermitirCaducados) + ''', ' +
      '  VidaUtil = ' + IntToStr(VidaUtil) + ', ' +
      '  UnidadVidaUtil = ''' + SQL_Str(UnidadVidaUtil) + ''', ' +
      '  IncluirReservas = ' + SQL_BooleanToStr(IncluirReservas) + ', ' +
      '  SoloReservas = ' + SQL_BooleanToStr(SoloReservas) + ', ' +
      '  IgnorarPartidas = ' + SQL_BooleanToStr(IgnorarPartidas) + ', ' +
      '  IgnorarUbicaciones = ' + SQL_BooleanToStr(IgnorarUbicaciones) + ' ' +
      'WHERE ' +
      '  PreparacionId = ' + IntToStr(PreparacionId);
  end;

  SQL_Execute_NoRes ( Conn, sSQL );

  WebModule1getMetodoRutaAction ( Conn, sParams, sRemoteAddr, StatusCode, statusText, Result );

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ MÈTODE DE RUTA                                                        │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getMetodoRutaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  contentfields: TStringList;
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoUsuario: Integer;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  PreparacionId: Integer;
  PermitirCaducados: string;
  VidaUtil: Integer;
  UnidadVidaUtil: string;
  sFUNCCustom: string;
  IncluirReservas: Boolean;
  SoloReservas: Boolean;
  IgnorarPartidas: Boolean;
  IgnorarUbicaciones: Boolean;
  MetodoCalculo: String;
  OrdenCalculo: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario     := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  PreparacionId     := StrToIntDef(contentfields.values['PreparacionId'],0);

  sSQL :=
    'SELECT TOP 1 UPPER(parametro_value) FROM FS_SGA_Parametros WITH (NOLOCK) ' +
    'WHERE parametro_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
    '  AND parametro_id = 142 ' +
    'ORDER BY parametro_CodigoEmpresa DESC';
  PermitirCaducados := SQL_Execute ( Conn, sSQL );

  sSQL :=
    'SELECT TOP 1 UPPER(parametro_value) FROM FS_SGA_Parametros WITH (NOLOCK) ' +
    'WHERE parametro_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
    '  AND parametro_id = 143 ' +
    'ORDER BY parametro_CodigoEmpresa DESC';
  VidaUtil := StrToIntDef ( SQL_Execute ( Conn, sSQL ), 0 );

  sSQL :=
    'SELECT TOP 1 UPPER(parametro_value) FROM FS_SGA_Parametros WITH (NOLOCK) ' +
    'WHERE parametro_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
    '  AND parametro_id = 144 ' +
    'ORDER BY parametro_CodigoEmpresa DESC';
  UnidadVidaUtil := SQL_Execute ( Conn, sSQL );

  sSQL :=
    'SELECT TOP 1 UPPER(parametro_value) FROM FS_SGA_Parametros WITH (NOLOCK) ' +
    'WHERE parametro_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
    '  AND parametro_id = 145 ' +
    'ORDER BY parametro_CodigoEmpresa DESC';
  MetodoCalculo := SQL_Execute ( Conn, sSQL );

  sSQL :=
    'SELECT TOP 1 UPPER(parametro_value) FROM FS_SGA_Parametros WITH (NOLOCK) ' +
    'WHERE parametro_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
    '  AND parametro_id = 146 ' +
    'ORDER BY parametro_CodigoEmpresa DESC';
  OrdenCalculo := SQL_Execute ( Conn, sSQL );

  sSQL :=
    'SELECT TOP 1 UPPER(parametro_value) FROM FS_SGA_Parametros WITH (NOLOCK) ' +
    'WHERE parametro_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
    '  AND parametro_id = 147 ' +
    'ORDER BY parametro_CodigoEmpresa DESC';
  IncluirReservas := (SQL_Execute ( Conn, sSQL )='TRUE');

  sSQL :=
    'SELECT TOP 1 UPPER(parametro_value) FROM FS_SGA_Parametros WITH (NOLOCK) ' +
    'WHERE parametro_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
    '  AND parametro_id = 148 ' +
    'ORDER BY parametro_CodigoEmpresa DESC';
  SoloReservas := (SQL_Execute ( Conn, sSQL )='TRUE');

  sSQL :=
    'SELECT TOP 1 UPPER(parametro_value) FROM FS_SGA_Parametros WITH (NOLOCK) ' +
    'WHERE parametro_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
    '  AND parametro_id = 149 ' +
    'ORDER BY parametro_CodigoEmpresa DESC';
  IgnorarPartidas := (SQL_Execute ( Conn, sSQL )='TRUE');

  sSQL :=
    'SELECT TOP 1 UPPER(parametro_value) FROM FS_SGA_Parametros WITH (NOLOCK) ' +
    'WHERE parametro_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
    '  AND parametro_id = 150 ' +
    'ORDER BY parametro_CodigoEmpresa DESC';
  IgnorarUbicaciones := (SQL_Execute ( Conn, sSQL )='TRUE');

  if UnidadVidaUtil='días' then UnidadVidaUtil := 'd'
  else if UnidadVidaUtil='semanas' then UnidadVidaUtil := 'w'
  else if UnidadVidaUtil='meses' then UnidadVidaUtil := 'm'
  else if UnidadVidaUtil='años' then UnidadVidaUtil := 'y'
  else UnidadVidaUtil := 'd';

  if SQL_Function_Exists ( Conn, 'FS_SGA_MetodoRutaCliente', sFUNCCustom ) then
  begin

    sSQL :=
      'SELECT * ' +
      'FROM dbo.[' + sFUNCCustom + '] ( ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(PreparacionId) + ', ' +
      '''' + SQL_Str(PermitirCaducados) + ''', ' +
      IntToStr(VidaUtil) + ', ' +
      '''' + SQL_Str(UnidadVidaUtil) + ''', ' +
      '''' + SQL_Str(MetodoCalculo) + ''', ' +
      '''' + SQL_Str(OrdenCalculo) + ''', ' +
      SQL_BooleanToStr(IncluirReservas) + ', ' +
      SQL_BooleanToStr(SoloReservas) + ', ' +
      SQL_BooleanToStr(IgnorarPartidas) + ', ' +
      SQL_BooleanToStr(IgnorarUbicaciones) + ' ' +
      ')';

    Q := SQL_PrepareQuery ( Conn, sSQL );
    Q.Open;

    Result := '{"Result":"OK","Error":"","Data":[' +
      '{"MetodoCalculo":"' + JSON_Str(Q.FieldByName('Metodo').AsString) + '",' +
      '"OrdenCalculo":"' + JSON_Str(Q.FieldByName('Orden').AsString) + '",' +
      '"PermitirCaducados":"' + JSON_Str(Q.FieldByName('PermitirCaducados').AsString) + '",' +
      '"VidaUtil":' + IntToStr(StrToIntDef(Q.FieldByName('VidaUtil').AsString,0)) + ',' +
      '"UnidadVidaUtil":"' + JSON_Str(Q.FieldByName('UnidadVidaUtil').AsString) + '",' +
      '"IncluirReservas":' + SQL_BooleanToStr(Q.FieldByName('IncluirReservas').AsBoolean) + ',' +
      '"SoloReservas":' + SQL_BooleanToStr(Q.FieldByName('SoloReservas').AsBoolean) + ',' +
      '"IgnorarPartidas":' + SQL_BooleanToStr(Q.FieldByName('IgnorarPartidas').AsBoolean) + ',' +
      '"IgnorarUbicaciones":' + SQL_BooleanToStr(Q.FieldByName('IgnorarUbicaciones').AsBoolean) +
      '}]}';

    Q.Close;
    FreeAndNil(Q);

  end;

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT D'ESTANTERIES D'UN PASSADÍS                                   │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listEstanteriasAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoAlmacen: String;
  CodigoPasillo: String;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoAlmacen := contentfields.values['CodigoAlmacen'];
  if CodigoAlmacen='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    Exit;
  end;

  CodigoPasillo := contentfields.values['CodigoPasillo'];
  if CodigoPasillo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de pasillo no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(DISTINCT CodigoEstanteria) ' +
          'FROM dbo.FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) ' +
          'WHERE ' +
          '  CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' AND ' +
          '  CodigoPasillo = ''' + SQL_Str(CodigoPasillo) + ''' ';

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  DISTINCT CodigoEstanteria ' +
          'FROM dbo.FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) ' +
          'WHERE ' +
          '  CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' AND ' +
          '  CodigoPasillo = ''' + SQL_Str(CodigoPasillo) + ''' ' +
          'ORDER BY ' +
          '  CodigoEstanteria ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
      '"CodigoEstanteria":"' + JSON_Str(Q.FieldByName('CodigoEstanteria').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT DE NÚMEROS DE SÈRIE DE PREPARACIONS                           │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getNumerosSeriePreparacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegsS, iNumRegsSR: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  PreparacionId: Integer;
  PickingId: Integer;
  AutoID: Integer;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  NSR: String;
  NS: String;
  Tipo: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  PreparacionId := StrToIntDef(contentfields.values['PreparacionId'],0);
  if PreparacionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  PickingId := StrToIntDef(contentfields.values['PickingId'],0);
  AutoID := StrToIntDef(contentfields.values['AutoID'],0);

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT * ' +
    'FROM FS_SGA_Picking_Pedido_Lineas_Detalle_NumerosSerie WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND PreparacionId = ' + IntToStr(PreparacionId) + ' ' +
    '  AND PickingId = ' + IntToStr(PickingId) + ' ';
  if AutoID<>0 then
  begin
    sSQL := sSQL +
      '  AND AutoID = ' + IntToStr(AutoID) + ' ';
  end;

  sSQL := sSQL +
    'ORDER BY Tipo, IdNumeroSerie';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iTotalRegs := Q.RecordCount;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iTotalRegs) + ',"Data":[';
  iNumRegsS := 0;
  iNumRegsSR := 0;

  NS := '';
  NSR := '';

  while not Q.Eof do begin

    Tipo := Q.FieldByName('Tipo').AsInteger;

    if (Tipo=0) then
    begin

      if iNumRegsS<>0 then
        NS := NS + ',';

      Inc(iNumRegsS);

      NS := NS +
        '{' +
        '"NumeroSerie":"' + JSON_Str(Q.FieldByName('NumeroSerie').AsString) + '",' +
        '"NumeroSerieFabricante":"' + JSON_Str(Q.FieldByName('NumeroSerieFabricante').AsString) + '",' +
        '"Cantidad":' + IntToStr(Q.FieldByName('Cantidad').AsInteger) +
        '}';

    end else begin

      if iNumRegsSR<>0 then
        NSR := NSR + ',';

      Inc(iNumRegsSR);

      NSR := NSR +
        '{' +
        '"NumeroSerie":"' + JSON_Str(Q.FieldByName('NumeroSerie').AsString) + '",' +
        '"NumeroSerieFabricante":"' + JSON_Str(Q.FieldByName('NumeroSerieFabricante').AsString) + '",' +
        '"Cantidad":' + IntToStr(Q.FieldByName('Cantidad').AsInteger) +
        '}';

    end;

    Q.Next;

  end;

  Result := Result +
    '{' +
    '"NumerosSerie":[' + NS + '],' +
    '"NumerosSerieRechazos":[' + NSR + ']' +
    '}' +
  ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT DE NÚMEROS DE SÈRIE DE RECEPCIONS                             │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getNumerosSerieRecepcionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegsS, iNumRegsSR: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  RecepcionId: Integer;
  RecepcionIdLinea: Integer;
  RecepcionIdLineaDetalle: Integer;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  NSR: String;
  NS: String;
  Tipo: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  RecepcionId             := StrToIntDef(contentfields.values['RecepcionId'],0);
  if RecepcionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de recepción no especificado","Data":[]}';
    Exit;
  end;

  RecepcionIdLinea        := StrToIntDef(contentfields.values['RecepcionIdLinea'],0);
  if RecepcionIdLinea=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Línea de recepción no especificado","Data":[]}';
    Exit;
  end;

  RecepcionIdLineaDetalle := StrToIntDef(contentfields.values['RecepcionIdLineaDetalle'],0);
  if RecepcionIdLineaDetalle=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Detalle de línea de recepción no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT * ' +
    'FROM FS_SGA_Recepciones_Lineas_Detalle_NumerosSerie WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND RecepcionId = ' + IntToStr(RecepcionId) + ' ' +
    '  AND RecepcionIdLinea = ' + IntToStr(RecepcionIdLinea) + ' ' +
    '  AND RecepcionIdLineaDetalle = ' + IntToStr(RecepcionIdLineaDetalle) + ' ' +
    'ORDER BY Tipo, IdNumeroSerie';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iTotalRegs := Q.RecordCount;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iTotalRegs) + ',"Data":[';
  iNumRegsS := 0;
  iNumRegsSR := 0;

  NS := '';
  NSR := '';

  while not Q.Eof do begin

    Tipo := Q.FieldByName('Tipo').AsInteger;

    if (Tipo=0) then
    begin

      if iNumRegsS<>0 then
        NS := NS + ',';

      Inc(iNumRegsS);

      NS := NS +
        '{' +
        '"NumeroSerie":"' + JSON_Str(Q.FieldByName('NumeroSerie').AsString) + '",' +
        '"NumeroSerieFabricante":"' + JSON_Str(Q.FieldByName('NumeroSerieFabricante').AsString) + '",' +
        '"Cantidad":' + IntToStr(Q.FieldByName('Cantidad').AsInteger) +
        '}';

    end else begin

      if iNumRegsSR<>0 then
        NSR := NSR + ',';

      Inc(iNumRegsSR);

      NSR := NSR +
        '{' +
        '"NumeroSerie":"' + JSON_Str(Q.FieldByName('NumeroSerie').AsString) + '",' +
        '"NumeroSerieFabricante":"' + JSON_Str(Q.FieldByName('NumeroSerieFabricante').AsString) + '",' +
        '"Cantidad":' + IntToStr(Q.FieldByName('Cantidad').AsInteger) +
        '}';

    end;

    Q.Next;

  end;

  Result := Result +
    '{' +
    '"NumerosSerie":[' + NS + '],' +
    '"NumerosSerieRechazos":[' + NSR + ']' +
    '}' +
  ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT DE FAMÍLIES D'ARTICLES                                        │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listFamiliasAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Filtro: String;
  sAndWhere: String;
  EmpresaOrigen: Integer;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Familias' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  Filtro := (contentfields.values['Filtro']);

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sAndWhere := '';

  if Filtro<>'' then begin
    sAndWhere := sAndWhere + 'AND ( ' +
      'CodigoFamilia LIKE ''%' + SQL_Str(Filtro) + '%'' OR ' +
      'Descripcion LIKE ''%' + SQL_Str(Filtro) + '%'' ' +
      ' ) ';
  end;

  sSQL := 'SELECT ' +
          '  COUNT(DISTINCT CodigoFamilia) ' +
          'FROM dbo.FS_SGA_TABLE_Familias ( ' + IntToStr(CodigoEmpresa.Familias) + ' ) ' +
          'WHERE ' +
          '  CodigoSubfamilia = ''**********'' ' +
          sAndWhere;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  DISTINCT CodigoFamilia, Descripcion ' +
          'FROM dbo.FS_SGA_TABLE_Familias ( ' + IntToStr(CodigoEmpresa.Familias) + ' ) ' +
          'WHERE ' +
          '  CodigoSubfamilia = ''**********'' ' +
          sAndWhere +
          'ORDER BY ' +
          '  CodigoFamilia ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
      '"CodigoFamilia":"' + JSON_Str(Q.FieldByName('CodigoFamilia').AsString) + '",' +
      '"Descripcion":"' + JSON_Str(Q.FieldByName('Descripcion').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT DE FONDOS D'UNA UBICACIÓ                                      │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listFondosAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoAlmacen: String;
  CodigoPasillo: String;
  CodigoEstanteria: String;
  Altura: String;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoAlmacen := contentfields.values['CodigoAlmacen'];
  if CodigoAlmacen='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    Exit;
  end;

  CodigoPasillo := contentfields.values['CodigoPasillo'];
  if CodigoPasillo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de pasillo no especificado","Data":[]}';
    Exit;
  end;

  CodigoEstanteria := contentfields.values['CodigoEstanteria'];
  if CodigoEstanteria='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de estantería no especificado","Data":[]}';
    Exit;
  end;

  Altura := contentfields.values['Altura'];
  if Altura='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Altura no especificada","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(DISTINCT Fondo) ' +
          'FROM dbo.FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) ' +
          'WHERE ' +
          '  CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' AND ' +
          '  CodigoPasillo = ''' + SQL_Str(CodigoPasillo) + ''' AND ' +
          '  CodigoEstanteria = ''' + SQL_Str(CodigoEstanteria) + ''' AND ' +
          '  Altura = ''' + SQL_Str(Altura) + ''' ';

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  DISTINCT Fondo ' +
          'FROM dbo.FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) ' +
          'WHERE ' +
          '  CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' AND ' +
          '  CodigoPasillo = ''' + SQL_Str(CodigoPasillo) + ''' AND ' +
          '  CodigoEstanteria = ''' + SQL_Str(CodigoEstanteria) + ''' AND ' +
          '  Altura = ''' + SQL_Str(Altura) + ''' ' +
          'ORDER BY ' +
          '  Fondo ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
      '"Fondo":"' + JSON_Str(Q.FieldByName('Fondo').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


procedure WebModule1listIncidenciasAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Tipo: String;
  OrdenarPor: String;
  TipoOrden: String;
  sOrderBy: String;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;


  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  Tipo := AnsiUpperCase((contentfields.Values['TipoIncidencia']));
  if Tipo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se ha especificado el tipo de incidencia","Data":[]}';
    Exit;
  end;

  OrdenarPor := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden  := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy   := '';

  if OrdenarPor='NOMBRE' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'NombreIncidencia DESC ';
    end else begin
      sOrderBy := 'NombreIncidencia ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'IdIncidencia DESC ';
    end else begin
      sOrderBy := 'IdIncidencia ';
    end;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM dbo.FS_SGA_TABLE_Incidencias ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ''' + SQL_Str(Tipo) + ''' ) ';

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  * ' +
          'FROM dbo.FS_SGA_TABLE_Incidencias ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ''' + SQL_Str(Tipo) + ''' ) ' +
          'ORDER BY ' +
          sOrderBy +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"IdIncidencia":' + Q.FieldByName('IdIncidencia').AsString + ',' +
      '"TipoIncidencia":"' + JSON_Str(Q.FieldByName('TipoIncidencia').AsString) + '",' +
      '"NombreIncidencia":"' + JSON_Str(Q.FieldByName('NombreIncidencia').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


procedure WebModule1generatePackingListAuto ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Ejercicio: Integer;
  IdPreparacion: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  fUnidadesRetiradas: Double;
  sExcep: String;
  CodigoUsuario: Integer;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID          := contentfields.values['UUID'];
  IdPreparacion := StrToIntDef(contentfields.Values['IdPreparacion'], 0);

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  SUM(UdRetiradas) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas ppl WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion);
  fUnidadesRetiradas := SQL_Execute ( Conn, sSQL );

  if fUnidadesRetiradas<=0 then
  begin
    Result := '{"Result":"ERROR","Message":"No hay unidades preparadas","Data":[]}';
    Exit;
  end;

  gaLogFile.Write ( 'Generamos packing list automático', CONST_LOGID_BBDD, LOG_LEVEL_INFO );

  sSQL := 'EXEC dbo.FS_SGA_PROC_PackingList_AUTO ' +
          IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
          IntToStr(IdPreparacion);
  try
    if SQL_Execute_NoRes ( Conn, sSQL, sExcep ) then
    begin
      gaLogFile.Write ( 'Packing list automático generado sin errores', CONST_LOGID_BBDD, LOG_LEVEL_INFO );
      Result := '{"Result":"OK","Error":"","Data":[]}';
    end else begin
      Result := '{"Result":"ERROR","Message":"' + JSON_Str(sExcep) + '","Data":[]}';
    end;
  except
    on E:Exception do
    begin
      gaLogFile.Write_DBException(E,sSQL,'Error al generar el packing list automático', CONST_LOGID_BBDD );
      Result := '{"Result":"ERROR","Message":"' + JSON_Str(E.Message) + '","Data":[]}';
    end;
  end;

  {$ENDREGION}

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'PACKINGLIST-AUTO', 'Generar packing list automático', @LP );

end;


procedure WebModule1generatePackingListAsis ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Ejercicio: Integer;
  IdPreparacion: Integer;
  NumEtiquetas: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  fUnidadesRetiradas: Double;
  sExcep: String;
  InformeAuto: Integer;
  sParams2: String;
  CodigoUsuario: Integer;
  bIsCustomReport: Boolean;
  sOperation: String;
  iStatus: Integer;
  UUID: string;
  sPROCCustom: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID          := contentfields.values['UUID'];
  IdPreparacion := StrToIntDef(contentfields.Values['IdPreparacion'], 0);

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  NumEtiquetas  := StrToIntDef(contentfields.Values['NumEtiquetas'], 0);
  InformeAuto   := StrToIntDef(contentfields.Values['Informe'], 0);
  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  SUM(UdRetiradas) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas ppl WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion);
  fUnidadesRetiradas := SQL_Execute ( Conn, sSQL );

  if fUnidadesRetiradas<=0 then
  begin
    Result := '{"Result":"ERROR","Message":"No hay unidades preparadas","Data":[]}';
    Exit;
  end;

  gaLogFile.Write ( 'Generamos packing list asistido', CONST_LOGID_BBDD, LOG_LEVEL_INFO );

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_PackingList_ASIS', sPROCCustom ) then
  begin
    sSQL := 'EXEC dbo.[' + sPROCCustom + '] ' +
            IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
            IntToStr(IdPreparacion) + ', ' +
            IntToStr(NumEtiquetas);
    try
      if SQL_Execute_NoRes ( Conn, sSQL, sExcep ) then
      begin
        gaLogFile.Write ( 'Packing list asistido generado sin errores', CONST_LOGID_BBDD, LOG_LEVEL_INFO );
        Result := '{"Result":"OK","Error":"","Data":[]}';
      end else begin
        Result := '{"Result":"ERROR","Message":"' + JSON_Str(sExcep) + '","Data":[]}';
      end;
    except
      on E:Exception do
      begin
        gaLogFile.Write_DBException(E,sSQL,'Error al generar el packing list asistido', CONST_LOGID_BBDD );
        Result := '{"Result":"ERROR","Message":"' + JSON_Str(E.Message) + '","Data":[]}';
      end;
    end;

  end;

  if InformeAuto <> 0 then
  begin

    sParams2 := '{' +
      '"CodigoEmpresa":' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ',' +
      '"Informe":' + IntToStr(InformeAuto) + ',' +
      '"Objeto":' + IntToStr(IdPreparacion) + ',' +
      '"Albaran":0,' +
      '"Usuario":' + IntToStr(CodigoUsuario) +
    '}';

    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_ActivarCustomReport, bIsCustomReport, CodigoEmpresa.EmpresaOrigen );

    if bIsCustomReport then
    begin
      sOperation := 'GENERARINFORME_CUSTOM';
      iStatus    := 50;
    end else begin
      sOperation := 'GENERARINFORME';
      iStatus    := 0;
    end;

    // Afegim un 1 a oper_num_retries perquè no intenti generar el document
    // més d'una vegada
    sSQL := 'INSERT INTO ' +
            '  FS_Operations ( oper_product_code, oper_name, oper_status, oper_ip_address, oper_datetime,' +
            '  oper_params, oper_CodigoEmpresa ) ' +
            'VALUES ( ' +
            '''' + SQL_Str(CONST_SGA) + ''', ' +
            '''' + SQL_Str(sOperation) + ''', ' +
            IntToStr(iStatus) + ', ' +
            '''' + SQL_Str(sRemoteAddr) + ''', ' +
            SQL_DateTimeToStr ( Now() ) + ', ' +
            '''' + sParams2 + ''', ' +
            IntToStr(CodigoEmpresa.EmpresaOrigen) + ' )';
    //gaLogFile.Write(sSQL, CONST_LOGID_BBDD, LOG_LEVEL_INFO );

    try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E:Exception do begin
        Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(E.Message) + '","Data":[]}';
        Exit;
      end;
    end;

    sParams := sParams + '&PreparacionId=' + IntToStr(IdPreparacion) + '&InformeAuto=' + IntToStr(InformeAuto);
    WebModule1servirPreparacionAction ( Conn, sParams, sRemoteAddr, statusCode, statusText, Result );
    Exit;

  end;

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'PACKINGLIST-ASIST', 'Generar packing list asistido', @LP );
  Result := '{"Result":"OK","Error":"","Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1checkUnidadesPreparadas ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Ejercicio: Integer;
  IdPreparacion: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  SP: TServirPreparacion;
  fUnidadesRetiradas: Double;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdPreparacion := StrToIntDef(contentfields.Values['IdPreparacion'], 0);

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  if not FS_SGA_GetServirPrepStats ( Conn, CodigoEmpresa, IdPreparacion, SP ) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se ha podido recuperar la información de la preparación","Data":[]}';
    Exit;
  end;

  sSQL := 'SELECT ' +
          '  SUM(UdRetiradas) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas ppl WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion);
  fUnidadesRetiradas := SQL_Execute ( Conn, sSQL );

  if fUnidadesRetiradas<=0 then
  begin
    Result := '{"Result":"ERROR","Message":"No hay unidades preparadas","Data":[]}';
  end else begin
    Result := '{"Result":"OK","Error":"","Data":[{' +
    '"Estado":' + IntToStr(SP.Estado) + ',' +
    '"LineasAPreparar":' + IntToStr(SP.LineasAPreparar) + ',' +
    '"LineasPreparadas":' + IntToStr(SP.LineasPreparadas) + ',' +
    '"LineasExpedidas":' + IntToStr(SP.LineasExpedidas) + ',' +
    '"LineasExpedidasTotal":' + IntToStr(SP.LineasExpedidasTotal) + ',' +
    '"LineasExpedidasParcial":' + IntToStr(SP.LineasExpedidasParcial) + ',' +
    '"StockNegativoMsg":"' + JSON_Str(SP.StockNegativoMsg) + '",' +
    '"iStockNegativo":"' + IntToStr(SP.iStockNegativo) + '",' +
    '"bPendienteExpedir":' + SQL_BooleanToStr(SP.bPendienteExpedir) + ',' +
    '"Msg":"' + JSON_Str(SP.Msg) + '",' +
    '"Cajas":' + IntToStr(SP.Cajas) + ',' +
    '"Palets":' + IntToStr(SP.Palets) + '}]}';
  end;

  {$ENDREGION}

end;


procedure WebModule1updateObservacionesPreparacionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  UUID: String;
  IdPreparacion: Integer;
  ObservacionesAlbaran: String;
  ObservacionesFactura: String;
  sSQL: String;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario        := StrToIntDef(contentfields.Values['CodigoUsuario'], 0);
  UUID                 := contentfields.Values['UUID'];
  IdPreparacion        := StrToIntDef(contentfields.Values['IdPreparacion'], 0);
  ObservacionesAlbaran := contentfields.Values['ObservacionesAlbaran'];
  ObservacionesFactura := contentfields.Values['ObservacionesFactura'];

  ObservacionesAlbaran := StringReplace ( ObservacionesAlbaran, '\n', #13 + #10, [rfReplaceAll] );
  ObservacionesFactura := StringReplace ( ObservacionesFactura, '\n', #13 + #10, [rfReplaceAll] );

  {$ENDREGION}

  {$REGION 'Actualització de dades'}

  sSQL :=
    'UPDATE FS_SGA_Picking_Preparaciones ' +
    'SET ' +
    '  ObservacionesAlbaran = ''' + SQL_Str(ObservacionesAlbaran) + ''', ' +
    '  ObservacionesFactura = ''' + SQL_Str(ObservacionesFactura) + ''' ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND PreparacionId = ' + IntToStr(IdPreparacion);

  SQL_Execute_NoRes ( Conn, sSQL );

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE_OBS_PREP', 'Actualizar observaciones preparación', @LP );

  Result := '{"Result":"OK","Error":"","Data":[';
  Result := Result + ']}';

end;


procedure WebModule1getInfoPreparacionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Ejercicio: Integer;
  IdPreparacion: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  Tipo: Integer;
  sWhere: String;
  sInfo: String;
  contentfields: TStringList;
  LineasPosicion: String;
  CodigoArticulo: String;
  Partida: String;
  PartidaSugerida: String;
  UnidadMedida: String;
  sFUNCCustom: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdPreparacion := StrToIntDef(contentfields.Values['IdPreparacion'], 0);
  LineasPosicion := SQL_GUID_ToStr(AnsiUpperCase((contentfields.Values['LineasPosicion'])));
  Partida := (contentfields.Values['Partida']);
  PartidaSugerida := (contentfields.Values['PartidaSugerida']);
  UnidadMedida := (AnsiUpperCase(contentfields.Values['UnidadMedida']));
  CodigoArticulo := (contentfields.Values['CodigoArticulo']);

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := '';

  if CodigoArticulo='' then
  begin

    if SQL_Function_Exists ( Conn, 'FS_SGA_InfoPreparacion', sFUNCCustom ) then
    begin

      sSQL :=
        'SELECT dbo.[' + sFUNCCustom + '] ( ' +
        IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
        IntToStr(IdPreparacion) +
        ' ) ';

    end;

  end else begin

    if SQL_Function_Exists ( Conn, 'FS_SGA_InfoPreparacionDetalle', sFUNCCustom ) then
    begin

      sSQL :=
        'SELECT dbo.[' + sFUNCCustom + '] ( ' +
        IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
        IntToStr(IdPreparacion) + ', ' +
        '''' + SQL_GUID_ToStr(LineasPosicion) + ''', ' +
        '''' + SQL_Str(CodigoArticulo) + ''', ' +
        '''' + SQL_Str(Partida) + ''', ' +
        '''' + SQL_Str(PartidaSugerida) + ''', ' +
        '''' + SQL_Str(UnidadMedida) + ''' ' +
        ' ) ';

    end;

  end;

  try
    sInfo := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(E.Message) + '","Data":[]}';
      Exit;
    end;
  end;

  Result := '{"Result":"OK","Error":"","Data":[';

  Result := Result +
    '{' +
    '"Info":"' + JSON_Str(sInfo) + '"' +
    '}';

  Result := Result + ']}';

  {$ENDREGION}

end;


procedure WebModule1listInformesAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Ejercicio: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  Tipo: Integer;
  sWhere: String;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  Tipo := StrToIntDef(contentfields.Values['Tipo'], 0);

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM dbo.FS_SGA_InformesPredefinidos WITH (NOLOCK) ' +
          'WHERE ' +
          '  (CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' OR ' +
          '  CodigoEmpresa = 0 ) AND ' +
          '  Tipo = ' + IntToStr(Tipo) + ' AND ' +
          '  Activo <> 0';

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  * ' +
          'FROM dbo.FS_SGA_InformesPredefinidos WITH (NOLOCK) ' +
          'WHERE ' +
          '  (CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' OR ' +
          '  CodigoEmpresa = 0 ) AND ' +
          '  Tipo = ' + IntToStr(Tipo) + ' AND ' +
          '  Activo <> 0 ' +
          'ORDER BY ' +
          '  Id ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"Id":' + Q.FieldByName('Id').AsString + ',' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"Nombre":"' + JSON_Str(Q.FieldByName('Nombre').AsString) + '",' +
      '"Descripcion":"' + JSON_Str(Q.FieldByName('Descripcion').AsString) + '",' +
      '"NombreCalculo":"' + JSON_Str(Q.FieldByName('Nombre_Calculo').AsString) + '",' +
      '"Parametros":"' + JSON_Str(Q.FieldByName('Parametros').AsString) + '",' +
      '"Tipo":' + Q.FieldByName('Tipo').AsString +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}


end;

procedure WebModule1listInventariosAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Ejercicio: Integer;
  YY: WORD;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  Estado: String;
  sWhere: String;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Date() );
  Ejercicio := StrToIntDef(contentfields.Values['Ejercicio'], YY );

  Estado    := (contentfields.Values['Estado']);

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  if Estado='PENDIENTES' then sWhere := ' AND Inventario_Finalizado=0 '
  else if Estado='FINALIZADO' then sWhere := ' AND Inventario_Finalizado=1 '
  else sWhere := '';

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM dbo.FS_SGA_TABLE_Inventario ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
          'WHERE ' +
          '  Ejercicio = ' + IntToStr(Ejercicio) + ' AND ' +
          '  Inventario_TipoUbicaciones <> ''EXCEL'' ' +
          sWhere;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  fsti.*, ISNULL(fsu.NombreUsuario,''???'') AS NombreUsuario ' +
          'FROM dbo.FS_SGA_TABLE_Inventario ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fsti ' +
          'LEFT JOIN dbo.FS_SGA_Usuarios fsu WITH (NOLOCK) ' +
          'ON ' +
          '  fsti.Inventario_UsuarioId = fsu.CodigoUsuario ' +
          'WHERE ' +
          '  fsti.Inventario_TipoUbicaciones <> ''EXCEL'' ' +
          sWhere +
          'ORDER BY ' +
          '  fsti.Inventario_Id DESC ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"Inventario_Id":' + Q.FieldByName('Inventario_Id').AsString + ',' +
      '"Ejercicio":"' + Q.FieldByName('Ejercicio').AsString + '",' +
      '"CodigoAlmacen":"' + Q.FieldByName('Inventario_CodigoAlmacen').AsString + '",' +
      '"InventarioFinalizado":' + SQL_BooleanToStr(Q.FieldByName('Inventario_Finalizado').AsBoolean) + ',' +
      '"Inventario_Nombre":"' + SQL_Str(Q.FieldByName('Inventario_Nombre').AsString) + '",' +
      '"Inventario_Fecha":"' + FormatDateTime ( 'dd/mm/yyyy', Q.FieldByName('Inventario_Fecha').AsDateTime ) + '",' +
      '"Inventario_FechaInicio":"' + FormatDateTime ( 'dd/mm/yyyy', Q.FieldByName('Inventario_FechaInicio').AsDateTime ) + '",' +
      '"Inventario_FechaFin":"' + FormatDateTime ( 'dd/mm/yyyy', Q.FieldByName('Inventario_FechaFin').AsDateTime ) + '",' +
      '"Inventario_NumUbicaciones":"' + Q.FieldByName('Inventario_NumUbicaciones').AsString + '",' +
      '"Inventario_NumCompletadas":"' + Q.FieldByName('Inventario_NumCompletadas').AsString + '",' +
      '"Inventario_Porcentaje":"' + Q.FieldByName('Inventario_Porcentaje').AsString + '",' +
      '"Inventario_Aplicado":"' + Q.FieldByName('Inventario_Aplicado').AsString + '",' +
      '"Inventario_FechaAplicacion":"' + FormatDateTime ( 'dd/mm/yyyy', Q.FieldByName('Inventario_FechaAplicacion').AsDateTime ) + '",' +
      '"Inventario_UsuarioId":' + SQL_VariantNull(Q.FieldByName('Inventario_UsuarioId').AsString) + ',' +
      '"NombreUsuario":"' + Q.FieldByName('NombreUsuario').AsString + '",' +
      '"TipoUbicaciones":"' + Q.FieldByName('Inventario_TipoUbicaciones').AsString + '",' +
      '"InventarioPadre":' + SQL_VariantNull(Q.FieldByName('Inventario_Padre').AsString) +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;

procedure WebModule1listInventarioUbicacionesAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q, Q2: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  InventarioId: Integer;
  TipoUbicacion: String;
  listArticulos: String;
  sTipo: String;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  InventarioId := StrToIntDef(contentfields.Values['InventarioId'], 0 );
  if InventarioId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de inventario no especificado","Data":[]}';
    Exit;
  end;

  // Tipus d'ubicació (TODAS,PENDIENTES,VERIFICADAS)
  TipoUbicacion := (contentfields.Values['TipoUbicacion']);
  if TipoUbicacion='' then
    TipoUbicacion := 'TODAS';

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(DISTINCT CodigoUbicacion) ' +
          'FROM FS_SGA_Inventario_Detalle WITH (NOLOCK) ' +
          'WHERE ' +
          '  Inventario_Id = ' + IntToStr(InventarioId) + ' ';
  if TipoUbicacion='PENDIENTES' then
    sSQL := sSQL + ' AND Verificada = 0'
  else if TipoUbicacion='VERIFICADAS' then
    sSQL := sSQL + ' AND Verificada <> 0';

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT DISTINCT ' +
          '  fsid.CodigoEmpresa, fsid.Inventario_Id, fsid.CodigoAlmacen, fsid.CodigoUbicacion, ' +
          '  fsid.Verificada, fsid.UsuarioId, fsu.NombreUsuario, MAX(fsid.FechaHoraValidacion) AS FechaHoraValidacion, ' +
          '  fstu.CodigoAlternativo ' +
          'FROM FS_SGA_Inventario_Detalle fsid WITH (NOLOCK) ' +
          'LEFT JOIN FS_SGA_Usuarios fsu WITH (NOLOCK) ' +
          'ON ' +
          '  fsid.UsuarioId = fsu.CodigoUsuario ' +
          'LEFT JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) fstu ' +
          'ON ' +
          '  fstu.CodigoUbicacion = fsid.CodigoUbicacion ' +
          'WHERE ' +
          '  fsid.Inventario_Id = ' + IntToStr(InventarioId) + ' ';

  if TipoUbicacion='PENDIENTES' then
    sSQL := sSQL + ' AND fsid.Verificada = 0 '
  else if TipoUbicacion='VERIFICADAS' then
    sSQL := sSQL + ' AND fsid.Verificada <> 0 ';

  sSQL := sSQL + 'GROUP BY ' +
                 '  fsid.CodigoEmpresa, fsid.Inventario_Id, fsid.CodigoAlmacen, fsid.CodigoUbicacion, ' +
                 '  fsid.Verificada, fsid.UsuarioId, fsu.NombreUsuario,  fstu.CodigoAlternativo ' +
                 'ORDER BY ' +
                 '  fsid.CodigoUbicacion DESC ' +
                 'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
                 'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  Q2 := SQL_PrepareQuery ( Conn );

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
      '"CodigoUbicacion":"' + Q.FieldByName('CodigoUbicacion').AsString + '",' +
      '"CodigoUbicacionAlternativo":"' + Q.FieldByName('CodigoAlternativo').AsString + '",' +
      '"Verificada":' + SQL_BooleanToStr (Q.FieldByName('Verificada').AsBoolean) + ',' +
      '"UsuarioId":"' + Q.FieldByName('UsuarioId').AsString + '",' +
      '"NombreUsuario":"' + Q.FieldByName('NombreUsuario').AsString + '",' +
      '"FechaHoraValidacion":"' + FormatDateTime('dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaHoraValidacion').AsDateTime) + '"' +
      //'"Articulos":[' + listArticulos + ']' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q2.Close;
  FreeAndNil(Q2);

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;

procedure WebModule1listLineasAlbaranProveedorAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EjercicioAlbaran: Integer;
  SerieAlbaran: String;
  NumeroAlbaran: Integer;
  EmpresaOrigen: Integer;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  EjercicioAlbaran := StrToIntDef(contentfields.Values['EjercicioAlbaran'], 0 );
  if EjercicioAlbaran=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Ejercicio del albarán no especificado","Data":[]}';
    Exit;
  end;

  SerieAlbaran := (contentfields.Values['SerieAlbaran']);

  NumeroAlbaran := StrToIntDef(contentfields.Values['NumeroAlbaran'], 0 );
  if NumeroAlbaran=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Número del albarán no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM LineasAlbaranProveedor WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' AND ' +
          '  EjercicioAlbaran = ' + IntToStr(EjercicioAlbaran) + ' AND ' +
          '  SerieAlbaran = ''' + SQL_Str(SerieAlbaran) + ''' AND ' +
          '  NumeroAlbaran = ' + IntToStr(NumeroAlbaran );

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  * ' +
          'FROM LineasAlbaranProveedor WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' AND ' +
          '  EjercicioAlbaran = ' + IntToStr(EjercicioAlbaran) + ' AND ' +
          '  SerieAlbaran = ''' + SQL_Str(SerieAlbaran) + ''' AND ' +
          '  NumeroAlbaran = ' + IntToStr(NumeroAlbaran ) + ' ' +
          'ORDER BY ' +
          '  Orden ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"EjercicioAlbaran":' + Q.FieldByName('EjercicioAlbaran').AsString + ',' +
      '"SerieAlbaran":"' + Q.FieldByName('SerieAlbaran').AsString + '",' +
      '"NumeroAlbaran":' + Q.FieldByName('NumeroAlbaran').AsString + ',' +
      '"Orden":' + Q.FieldByName('Orden').AsString + ',' +
      '"LineasPosicion":"' + Q.FieldByName('LineasPosicion').AsString + '",' +
      '"LineaPedido":"' + Q.FieldByName('LineaPedido').AsString + '",' +
      '"FechaRegistro":"' + FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaRegistro').AsDateTime) + '",' +
      '"CodigoArticulo":"' + Q.FieldByName('CodigoArticulo').AsString + '",' +
      '"CodigoAlmacen":"' + Q.FieldByName('CodigoAlmacen').AsString + '",' +
      '"Partida":"' + Q.FieldByName('Partida').AsString + '",' +
      '"CodigoFamilia":"' + JSON_Str(Q.FieldByName('CodigoFamilia').AsString) + '",' +
      '"CodigoSubfamilia":"' + JSON_Str(Q.FieldByName('CodigoSubfamilia').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"UnidadesRecibidas":' + SQL_FloatToStr(Q.FieldByName('UnidadesRecibidas').AsFloat) + ',' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString)) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;

procedure WebModule1listLineasAlbaranVentaAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EjercicioAlbaran: Integer;
  SerieAlbaran: String;
  NumeroAlbaran: Integer;
  EmpresaOrigen: Integer;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  EjercicioAlbaran := StrToIntDef(contentfields.Values['EjercicioAlbaran'], 0 );
  if EjercicioAlbaran=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Ejercicio del albarán no especificado","Data":[]}';
    Exit;
  end;

  SerieAlbaran := (contentfields.Values['SerieAlbaran']);

  NumeroAlbaran := StrToIntDef(contentfields.Values['NumeroAlbaran'], 0 );
  if NumeroAlbaran=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Número del albarán no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM LineasAlbaranCliente WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' AND ' +
          '  EjercicioAlbaran = ' + IntToStr(EjercicioAlbaran) + ' AND ' +
          '  SerieAlbaran = ''' + SQL_Str(SerieAlbaran) + ''' AND ' +
          '  NumeroAlbaran = ' + IntToStr(NumeroAlbaran );

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  * ' +
          'FROM LineasAlbaranCliente WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' AND ' +
          '  EjercicioAlbaran = ' + IntToStr(EjercicioAlbaran) + ' AND ' +
          '  SerieAlbaran = ''' + SQL_Str(SerieAlbaran) + ''' AND ' +
          '  NumeroAlbaran = ' + IntToStr(NumeroAlbaran ) + ' ' +
          'ORDER BY ' +
          '  Orden ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"EjercicioAlbaran":' + Q.FieldByName('EjercicioAlbaran').AsString + ',' +
      '"SerieAlbaran":"' + JSON_Str(Q.FieldByName('SerieAlbaran').AsString) + '",' +
      '"NumeroAlbaran":' + Q.FieldByName('NumeroAlbaran').AsString + ',' +
      '"Orden":' + Q.FieldByName('Orden').AsString + ',' +
      '"LineasPosicion":"' + JSON_Str(Q.FieldByName('LineasPosicion').AsString) + '",' +
      '"LineaPedido":"' + JSON_Str(Q.FieldByName('LineaPedido').AsString) + '",' +
      '"FechaRegistro":"' + FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaRegistro').AsDateTime) + '",' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
      '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"CodigoFamilia":"' + JSON_Str(Q.FieldByName('CodigoFamilia').AsString) + '",' +
      '"CodigoSubfamilia":"' + JSON_Str(Q.FieldByName('CodigoSubfamilia').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"SuPedido":"' + JSON_Str(Q.FieldByName('SuPedido').AsString) + '",' +
      '"Unidades":' + SQL_FloatToStr(Q.FieldByName('Unidades').AsFloat) + ',' +
      '"UnidadesServidas":' + SQL_FloatToStr(Q.FieldByName('UnidadesServidas').AsFloat) + ',' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString)) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;

procedure WebModule1listLineasPedidoCompraAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EjercicioPedido: Integer;
  SeriePedido: String;
  NumeroPedido: Integer;
  EmpresaOrigen: Integer;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Albaranes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  EjercicioPedido := StrToIntDef(contentfields.Values['EjercicioPedido'], 0 );
  if EjercicioPedido=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Ejercicio del pedido no especificado","Data":[]}';
    Exit;
  end;

  SeriePedido := (contentfields.Values['SeriePedido']);

  NumeroPedido := StrToIntDef(contentfields.Values['NumeroPedido'], 0 );
  if NumeroPedido=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Número del pedido no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM LineasPedidoProveedor WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' AND ' +
          '  EjercicioPedido = ' + IntToStr(EjercicioPedido) + ' AND ' +
          '  SeriePedido = ''' + SQL_Str(SeriePedido) + ''' AND ' +
          '  NumeroPedido = ' + IntToStr(NumeroPedido );

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  * ' +
          'FROM LineasPedidoProveedor WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' AND ' +
          '  EjercicioPedido = ' + IntToStr(EjercicioPedido) + ' AND ' +
          '  SeriePedido = ''' + SQL_Str(SeriePedido) + ''' AND ' +
          '  NumeroPedido = ' + IntToStr(NumeroPedido ) + ' ' +
          'ORDER BY ' +
          '  Orden ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
      '"SeriePedido":"' + Q.FieldByName('SeriePedido').AsString + '",' +
      '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
      '"Orden":' + Q.FieldByName('Orden').AsString + ',' +
      '"LineasPosicion":"' + Q.FieldByName('LineasPosicion').AsString + '",' +
      '"LineaPedidoCli":"' + Q.FieldByName('LineaPedidoCli').AsString + '",' +
      '"FechaRegistro":"' + FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaRegistro').AsDateTime) + '",' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
      '"CodigoAlmacen":"' + Q.FieldByName('CodigoAlmacen').AsString + '",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"CodigoFamilia":"' + JSON_Str(Q.FieldByName('CodigoFamilia').AsString) + '",' +
      '"CodigoSubfamilia":"' + JSON_Str(Q.FieldByName('CodigoSubfamilia').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"Estado":' + Q.FieldByName('Estado').AsString + ',' +
      '"FechaRecepcion":"' + FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaRecepcion').AsDateTime) + '",' +
      '"UnidadesPedidas":' + SQL_FloatToStr(Q.FieldByName('UnidadesPedidas').AsFloat) + ',' +
      '"UnidadesRecibidas":' + SQL_FloatToStr(Q.FieldByName('UnidadesRecibidas').AsFloat) + ',' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString)) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;

procedure WebModule1listLineasPedidoVentaAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EjercicioPedido: Integer;
  SeriePedido: String;
  NumeroPedido: Integer;
  EmpresaOrigen: Integer;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  EjercicioPedido := StrToIntDef(contentfields.Values['EjercicioPedido'], 0 );
  if EjercicioPedido=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Ejercicio del pedido no especificado","Data":[]}';
    Exit;
  end;

  SeriePedido := (contentfields.Values['SeriePedido']);

  NumeroPedido := StrToIntDef(contentfields.Values['NumeroPedido'], 0 );
  if NumeroPedido=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Número del pedido no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM LineasPedidoCliente WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' AND ' +
          '  EjercicioPedido = ' + IntToStr(EjercicioPedido) + ' AND ' +
          '  SeriePedido = ''' + SQL_Str(SeriePedido) + ''' AND ' +
          '  NumeroPedido = ' + IntToStr(NumeroPedido );

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  * ' +
          'FROM LineasPedidoCliente WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(EmpresaOrigen) + ' AND ' +
          '  EjercicioPedido = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' AND ' +
          '  SeriePedido = ''' + SQL_Str(SeriePedido) + ''' AND ' +
          '  NumeroPedido = ' + IntToStr(NumeroPedido ) + ' ' +
          'ORDER BY ' +
          '  Orden ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
      '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
      '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
      '"Orden":' + Q.FieldByName('Orden').AsString + ',' +
      '"LineasPosicion":"' + JSON_Str(Q.FieldByName('LineasPosicion').AsString) + '",' +
      '"FechaRegistro":"' + FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaRegistro').AsDateTime) + '",' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
      '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"CodigoFamilia":"' + JSON_Str(Q.FieldByName('CodigoFamilia').AsString) + '",' +
      '"CodigoSubfamilia":"' + JSON_Str(Q.FieldByName('CodigoSubfamilia').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"CodigodelCliente":"' + JSON_Str(Q.FieldByName('CodigodelCliente').AsString) + '",' +
      '"CodigoProveedor":"' + JSON_Str(Q.FieldByName('CodigoProveedor').AsString) + '",' +
      '"FechaEntrega":"' + FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaEntrega').AsDateTime) + '",' +
      '"SuPedido":"' + JSON_Str(Q.FieldByName('SuPedido').AsString) + '",' +
      '"Estado":' + Q.FieldByName('Estado').AsString + ',' +
      '"CodigoColor_":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
      '"GrupoTalla_":"' + JSON_Str(Q.FieldByName('GrupoTalla_').AsString) + '",' +
      '"CodigoTalla01_":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
      '"UnidadesPedidas":' + SQL_FloatToStr(Q.FieldByName('UnidadesPedidas').AsFloat) + ',' +
      '"UnidadesServidas":' + SQL_FloatToStr(Q.FieldByName('UnidadesServidas').AsFloat) + ',' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString)) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;

{$ENDREGION}


{$REGION '--- FUNCIONS DE MAGATZEM'}

// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT DE MAGATEMS D'UNA EMPRESA                                     │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listAlmacenesAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoUsuario: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  HideAlmacen: String;
  contentfields: TStringList;
  RolId: Integer;
  TodosAlmacenes: Boolean;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;
  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  RolId := FS_SGA_USUARIO_Rol ( Conn, CodigoEmpresa, CodigoUsuario );

  if CodigoUsuario<>0 then
  begin
    TodosAlmacenes := FS_SGA_Usuario_TodosAlmacenes ( Conn, CodigoEmpresa, CodigoUsuario );
  end else begin
    TodosAlmacenes := TRUE;
  end;

  HideAlmacen := contentfields.Values['HideAlmacen'];

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL :=
    'SELECT ' +
    '  COUNT(*) ' +
    'FROM dbo.FS_SGA_TABLE_Almacenes ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) FSTA ' +
    'LEFT JOIN ( ' +
    '  SELECT * ' +
    '  FROM FS_SGA_AlmacenesUsuario WITH (NOLOCK) ' +
    '  WHERE CodigoUsuario = ' + IntToStr(CodigoUsuario) + ' ' +
    ') FSAU ' +
    'ON dbo.FS_GetEmpresaStocks(FSAU.CodigoEmpresa, ''Almacenes'') = FSTA.CodigoEmpresa ' +
    'AND FSAU.CodigoAlmacen = FSTA.CodigoAlmacen ' +
    'WHERE ISNULL(FSTA.VisiblePDA, 1) <> 0 ';

  // El rol 5 és el d'aministrador
  if (RolId <> 5) and (not TodosAlmacenes) and (CodigoUsuario<>0) then
  begin
    sSQL := sSQL +
      '  AND FSAU.CodigoUsuario IS NOT NULL ';
  end;

  if (HideAlmacen<>'') then
  begin
    sSQL := sSQL +
      'AND FSTA.CodigoAlmacen <> ''' + SQL_Str(HideAlmacen) + ''' ';
  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT ' +
    '  FSTA.CodigoEmpresa, FSTA.CodigoAlmacen, FSTA.Almacen, FSTA.Domicilio, FSTA.CodigoPostal, FSTA.Municipio, FSTA.Provincia ' +
    'FROM dbo.FS_SGA_TABLE_Almacenes ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) FSTA ' +
    'LEFT JOIN ( ' +
    '  SELECT * ' +
    '  FROM FS_SGA_AlmacenesUsuario WITH (NOLOCK) ' +
    '  WHERE CodigoUsuario = ' + IntToStr(CodigoUsuario) + ' ' +
    '    AND CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    ') FSAU ' +
    'ON dbo.FS_GetEmpresaStocks(FSAU.CodigoEmpresa, ''Almacenes'') = FSTA.CodigoEmpresa ' +
    'AND FSAU.CodigoAlmacen = FSTA.CodigoAlmacen ' +
    'WHERE ISNULL(FSTA.VisiblePDA, 1) <> 0 ';

  // El rol 5 és el d'aministrador
  if (RolId <> 5) and (not TodosAlmacenes) and (CodigoUsuario<>0) then
  begin
    sSQL := sSQL +
      '  AND FSAU.CodigoUsuario IS NOT NULL ';
  end;

  if (HideAlmacen<>'') then
  begin
    sSQL := sSQL +
      'AND FSTA.CodigoAlmacen <> ''' + SQL_Str(HideAlmacen) + ''' ';
  end;

  sSQL := sSQL +
    'ORDER BY ' +
    '  FSTA.CodigoEmpresa, FSTA.CodigoAlmacen ' +
    'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
    'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ', ' +
      '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
      '"Almacen":"' + JSON_Str(Q.FieldByName('Almacen').AsString) + '",' +
      '"Domicilio":"' + JSON_Str(Q.FieldByName('Domicilio').AsString) + '",' +
      '"CodigoPostal":"' + JSON_Str(Q.FieldByName('CodigoPostal').AsString) + '",' +
      '"Municipio":"' + JSON_Str(Q.FieldByName('Municipio').AsString) + '",' +
      '"Provincia":"' + JSON_Str(Q.FieldByName('Provincia').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT D'ALTURES D'UNA ESTANTERIA                                    │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listAlturasAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoAlmacen: String;
  CodigoPasillo: String;
  CodigoEstanteria: String;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoAlmacen := contentfields.values['CodigoAlmacen'];
  if CodigoAlmacen='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    Exit;
  end;

  CodigoPasillo := contentfields.values['CodigoPasillo'];
  if CodigoPasillo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de pasillo no especificado","Data":[]}';
    Exit;
  end;

  CodigoEstanteria := contentfields.values['CodigoEstanteria'];
  if CodigoEstanteria='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de estantería no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(DISTINCT Altura) ' +
          'FROM dbo.FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) ' +
          'WHERE ' +
          '  CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' AND ' +
          '  CodigoPasillo = ''' + SQL_Str(CodigoPasillo) + ''' AND ' +
          '  CodigoEstanteria = ''' + SQL_Str(CodigoEstanteria) + ''' ';

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  DISTINCT Altura ' +
          'FROM dbo.FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) ' +
          'WHERE ' +
          '  CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' AND ' +
          '  CodigoPasillo = ''' + SQL_Str(CodigoPasillo) + ''' AND ' +
          '  CodigoEstanteria = ''' + SQL_Str(CodigoEstanteria) + ''' ' +
          'ORDER BY ' +
          '  Altura ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
      '"Altura":"' + JSON_Str(Q.FieldByName('Altura').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;



// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT D'ARTICLES D'UNA EMPRESA                                      │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1findArticulosAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Ejercicio: Integer;
  sAndWhere: String;
  CodigoFamilia: String;
  CodigoSubfamilia: String;
  EmpresaOrigen: Integer;
  Articulo: String;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  Articulo         := (contentfields.values['Articulo']);
  CodigoFamilia    := (contentfields.values['CodigoFamilia']);
  CodigoSubfamilia := (contentfields.values['CodigoSubfamilia']);

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sAndWhere := '';

  if CodigoFamilia<>'' then begin
    sAndWhere := sAndWhere + 'AND ' +
      'CodigoFamilia=''' + SQL_Str(CodigoFamilia) + ''' ';
  end;

  if Codigosubfamilia<>'' then begin
    sAndWhere := sAndWhere + 'AND ' +
      'CodigoSubfamilia=''' + SQL_Str(CodigoSubfamilia) + ''' ';
  end;

  if Articulo<>'' then begin
    sAndWhere := sAndWhere + 'AND ( ' +
      'CodigoArticulo LIKE ''%' + SQL_Str(Articulo) + '%'' OR ' +
      'DescripcionArticulo LIKE ''%' + SQL_Str(Articulo) + '%'' ' +
      ' ) ';
  end;

  if (CodigoFamilia='') and (Codigosubfamilia='') and (Articulo='') then begin
    sAndWhere := 'AND 1=2 ';
  end;

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) ' +
          'WHERE ' +
          '  TipoArticulo = ''M'' ' +
          sAndWhere;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  * ' +
          'FROM dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) ' +
          'WHERE ' +
          '  1 = 1 ' +
          sAndWhere +
          'ORDER BY ' +
          '  CodigoArticulo ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"CodigoFamilia":"' + JSON_Str(Q.FieldByName('CodigoFamilia').AsString) + '",' +
      '"CodigoSubfamilia":"' + JSON_Str(Q.FieldByName('CodigoSubfamilia').AsString) + '",' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"TratamientoPartidas":' + IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ STOCK D''UN ARTICLE EN UNA UBICACIÓ                                   │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1refreshStockArticuloAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Filtro: String;
  Ejercicio: Integer;
  sAndWhere: String;
  CodigoFamilia: String;
  CodigoSubfamilia: String;
  EmpresaOrigen: Integer;
  CodigoUbicacion: String;
  contentfields: TStringList;
  sFechaCaduca: String;
  JSonUnidadesMedida: String;
  CodigoTalla: String;
  CodigoColor: String;
  CodigoArticulo: String;
  Partida: String;
  UnidadMedida: String;
  UnidadMedidaBase: String;
  fUnidadesSaldo     : Double;
  fUnidadesSaldoBase : Double;
  sUnidadMedida      : String;
  sUnidadMedidaBase  : String;
  Matricula: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  Matricula        := (contentfields.values['Matricula']);
  CodigoFamilia    := (contentfields.values['CodigoFamilia']);
  CodigoSubfamilia := (contentfields.values['CodigoSubfamilia']);
  Filtro           := (contentfields.values['Filtro']);
  CodigoUbicacion  := (contentfields.values['CodigoUbicacion']);
  CodigoTalla      := (contentfields.values['CodigoTalla']);
  CodigoColor      := (contentfields.values['CodigoColor']);
  CodigoArticulo   := (contentfields.values['CodigoArticulo']);
  Partida          := (contentfields.values['Partida']);
  UnidadMedida     := (AnsiUpperCase(contentfields.values['UnidadMedida']));
  UnidadMedidaBase := (AnsiUpperCase(contentfields.values['UnidadMedidaBase']));

  FS_SGA_Check_UnidadMedidaBase ( Conn, CodigoEmpresa, CodigoArticulo, UnidadMedida, UnidadMedidaBase );

  // Conversió al codi d'article real
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sAndWhere := '';

  if CodigoArticulo<>'' then
  begin
    sAndWhere := sAndWhere + 'AND ' +
      'art.CodigoArticulo=''' + SQL_Str(CodigoArticulo) + ''' ';
  end;

  if CodigoFamilia<>'' then begin
    sAndWhere := sAndWhere + 'AND ' +
      'art.CodigoFamilia=''' + SQL_Str(CodigoFamilia) + ''' ';
  end;

  if Codigosubfamilia<>'' then begin
    sAndWhere := sAndWhere + 'AND ' +
      'art.CodigoSubfamilia=''' + SQL_Str(CodigoSubfamilia) + ''' ';
  end;

  if CodigoUbicacion<>'' then
  begin

    sAndWhere := sAndWhere +
      'AND ubi.CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + ''' ';

    sAndWhere := sAndWhere +
    'AND ubi.CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ';

    sAndWhere := sAndWhere +
      'AND ubi.CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ';

    sAndWhere := sAndWhere +
      'AND ubi.Matricula = ''' + SQL_Str(Matricula) + ''' ';

    if gbTratamientoSimplificado then
    begin
      if (UnidadMedida<>UnidadMedidaBase) then
      begin
        sAndWhere := sAndWhere +
          'AND ubi.UnidadMedida = ''' + SQL_Str(AnsiUpperCase(UnidadMedida)) + ''' ';
      end;
    end else begin
      sAndWhere := sAndWhere +
        'AND ubi.UnidadMedida = ''' + SQL_Str(AnsiUpperCase(UnidadMedida)) + ''' ';
    end;

    (*
    if (UnidadMedidaBase<>'') then
    begin
      sAndWhere := sAndWhere +
        'AND ubi.UnidadMedidaBase = ''' + SQL_Str(AnsiUpperCase(UnidadMedidaBase)) + ''' ';
    end;
    *)

    if Partida<>'*' then
    begin
      sAndWhere := sAndWhere +
        'AND ubi.Partida = ''' + SQL_Str(Partida) + ''' ';
    end;

    sAndWhere := sAndWhere +
      'AND ubi.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ';

  end;

  if Filtro<>'' then begin
    sAndWhere := sAndWhere + 'AND ( ' +
      'art.CodigoArticulo LIKE ''%' + SQL_Str(Filtro) + '%'' OR ' +
      'art.DescripcionArticulo LIKE ''%' + SQL_Str(Filtro) + '%'' ' +
      ' ) ';
  end;

  sSQL :=
    'SELECT ' +
    '  COUNT(*) ' +
    'FROM dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ';

  if CodigoUbicacion<>'' then
  begin
    sSQL := sSQL +
      'INNER JOIN FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', ' + IntToStr(YearOf(Now())) + ' ) ubi ' +
      'ON ' +
      '  ubi.CodigoArticulo = art.CodigoArticulo ';
  end;

  sSQL := sSQL +
    'WHERE ' +
    '  art.TipoArticulo = ''M'' ';

  if CodigoUbicacion<>'' then
    sSQL := sSQL +
      '  AND (ubi.UnidadesSaldo>0 OR ubi.UnidadesSaldoBase>0) ';

  sSQL := sSQL + sAndWhere;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  if CodigoUbicacion<>'' then
  begin
    sSQL :=
      'SELECT DISTINCT ubi.CodigoArticulo, ubi.UnidadesSaldo, ubi.FechaCaduca, ubi.UnidadesSaldoBase, ubi.Partida, ubi.CodigoColor_, ' +
      '  ubi.CodigoTalla01_, art.DescripcionArticulo, art.CodigoFamilia, art.CodigoSubfamilia, art.TratamientoPartidas, ' +
      '  art.Colores_, art.GrupoTalla_, ubi.UnidadMedida AS UnidadMedida2_, ubi.UnidadMedidaBase AS UnidadMedidaAlternativa_, ' +
      '  CTC.CodigoAlternativo AS CodigoAlternativoTC ' +
      'FROM dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
      'INNER JOIN FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', ' + IntToStr(YearOf(Now())) + ' ) ubi ' +
      'ON ' +
      '  ubi.CodigoArticulo = art.CodigoArticulo ' +
      'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
      'ON ' +
      '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
      '  AND CTC.CodigoArticulo = ubi.CodigoArticulo ' +
      '  AND CTC.CodigoTalla01_ = ubi.CodigoTalla01_ ' +
      '  AND CTC.CodigoColor_ = ubi.CodigoColor_ ' +
      'WHERE ' +
      '  art.TipoArticulo = ''M'' ' +
      '  AND (ubi.UnidadesSaldo>0 OR ubi.UnidadesSaldoBase>0) ' +
      sAndWhere +
      'ORDER BY ' +
      '  ubi.CodigoArticulo ' +
      'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
      'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';
  end else begin
    sSQL :=
      'SELECT *, '''' AS Partida, '''' AS CodigoColor_, Null as FechaCaduca, '''' AS CodigoTalla01_, 0 as UnidadesSaldo, 0 AS UnidadesSaldoBase, ' +
      '  CTC.CodigoAlternativo AS CodigoAlternativoTC ' +
      'FROM dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
      'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
      'ON ' +
      '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
      '  AND CTC.CodigoArticulo = art.CodigoArticulo ' +
      '  AND CTC.CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
      '  AND CTC.CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
      'WHERE ' +
      '  art.TipoArticulo = ''M'' ' +
      sAndWhere +
      'ORDER BY ' +
      '  art.CodigoArticulo ' +
      'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
      'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';
  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  if Q.RecordCount=0 then
  begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
    Result := Result +
      '{' +
      '"CodigoAlternativoTC":"",' +
      '"UnidadesSaldo":0,' +
      '"UnidadesSaldoBase":0,' +
      '"FechaCaduca":""' +
      '}';
    Result := Result + ']}';
    Exit;
  end;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    if (Q.FieldByName('FechaCaduca').IsNull) or (Q.FieldByName('FechaCaduca').AsDateTime=0) then
      sFechaCaduca := ''
    else
      sFechaCaduca := FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaCaduca').AsDateTime);

    sUnidadMedida      := AnsiUpperCase(Q.FieldByName('UnidadMedida2_').AsString);
    sUnidadMedidaBase  := AnsiUpperCase(Q.FieldByName('UnidadMedidaAlternativa_').AsString);

    if sUnidadMedidaBase='' then
    begin
      sUnidadMedidaBase := sUnidadMedida;
      sUnidadMedida     := '';
    end;

    fUnidadesSaldo     := Q.FieldByName('UnidadesSaldo').AsFloat;
    fUnidadesSaldoBase := Q.FieldByName('UnidadesSaldoBase').AsFloat;

    if (gbTratamientoSimplificado) and (UnidadMedida=UnidadMedidaBase) then
    begin
      fUnidadesSaldo := fUnidadesSaldoBase;
    end;

    Result := Result + '{' +
      '"CodigoAlternativoTC":"' + JSON_Str(Q.FieldByName('CodigoAlternativoTC').AsString) + '",' +
      '"UnidadesSaldo":' + SQL_FloatToStr(fUnidadesSaldo) + ', ' +
      '"UnidadesSaldoBase":' + SQL_FloatToStr(fUnidadesSaldoBase) + ',' +
      '"FechaCaduca":"' + sFechaCaduca + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;



// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT D'ARTICLES D'UNA EMPRESA                                      │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listArticulosAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Filtro: String;
  Ejercicio: Integer;
  sAndWhere: String;
  CodigoFamilia: String;
  CodigoSubfamilia: String;
  EmpresaOrigen: Integer;
  CodigoUbicacion: String;
  contentfields: TStringList;
  sFechaCaduca: String;
  JSonUnidadesMedida: String;
  CodigoTalla: String;
  IdPreparacion: Integer;
  CodigoColor: String;
  CodigoArticulo: String;
  Partida: String;
  UnidadMedida: String;
  UnidadMedidaBase: String;
  fUnidadesSaldo     : Double;
  fUnidadesSaldoBase : Double;
  sUnidadMedida: String;
  sUnidadMedidaBase: String;
  Matricula: String;
  PBT, PNT, VT: Double;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  Matricula        := (contentfields.values['Matricula']);
  CodigoFamilia    := (contentfields.values['CodigoFamilia']);
  CodigoSubfamilia := (contentfields.values['CodigoSubfamilia']);
  Filtro           := (contentfields.values['Filtro']);
  CodigoUbicacion  := (contentfields.values['CodigoUbicacion']);
  CodigoTalla      := (contentfields.values['CodigoTalla']);
  CodigoColor      := (contentfields.values['CodigoColor']);
  CodigoArticulo   := (contentfields.values['CodigoArticulo']);
  Partida          := (contentfields.values['Partida']);
  UnidadMedida     := (AnsiUpperCase(contentfields.values['UnidadMedida']));
  UnidadMedidaBase := (AnsiUpperCase(contentfields.values['UnidadMedidaBase']));
  IdPreparacion    := StrToIntDef(contentfields.Values['IdPreparacion'],0);

  FS_SGA_Check_UnidadMedidaBase ( Conn, CodigoEmpresa, CodigoArticulo, UnidadMedida, UnidadMedidaBase );

  // Conversió al codi d'article real
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sAndWhere := 'AND art.ObsoletoLC=0 ';

  if CodigoFamilia<>'' then begin
    sAndWhere := sAndWhere + 'AND ' +
      'art.CodigoFamilia=''' + SQL_Str(CodigoFamilia) + ''' ';
  end;

  if Codigosubfamilia<>'' then begin
    sAndWhere := sAndWhere + 'AND ' +
      'art.CodigoSubfamilia=''' + SQL_Str(CodigoSubfamilia) + ''' ';
  end;

  if CodigoUbicacion<>'' then
  begin
    sAndWhere := sAndWhere +
      'AND ubi.CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + ''' ';
  end;

  if (CodigoTalla<>'') then
  begin
    sAndWhere := sAndWhere +
      'AND ubi.CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ';
  end;

  if (CodigoColor<>'') then
  begin
    sAndWhere := sAndWhere +
      'AND ubi.CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ';
  end;

  if (UnidadMedida<>'') then
  begin
    if gbTratamientoSimplificado then
    begin
      if (UnidadMedida<>UnidadMedidaBase) then
      begin
        sAndWhere := sAndWhere +
          'AND ubi.UnidadMedida = ''' + SQL_Str(AnsiUpperCase(UnidadMedida)) + ''' ';
      end;
    end else begin
      sAndWhere := sAndWhere +
        'AND ubi.UnidadMedida = ''' + SQL_Str(AnsiUpperCase(UnidadMedida)) + ''' ';
    end;
  end;

  if (UnidadMedidaBase<>'') then
  begin
    sAndWhere := sAndWhere +
      'AND ubi.UnidadMedidaBase = ''' + SQL_Str(AnsiUpperCase(UnidadMedidaBase)) + ''' ';
  end;

  if (Partida<>'') then
  begin
    sAndWhere := sAndWhere +
      'AND ubi.Partida = ''' + SQL_Str(Partida) + ''' ';
  end;

  if CodigoArticulo<>'' then
  begin
    sAndWhere := sAndWhere +
      'AND ubi.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ';
  end;

  if Filtro<>'' then
  begin
    sAndWhere := sAndWhere + 'AND ( ' +
      'art.CodigoArticulo LIKE ''%' + SQL_Str(Filtro) + '%'' OR ' +
      'art.DescripcionArticulo LIKE ''%' + SQL_Str(Filtro) + '%'' ' +
      ' ) ';
  end;

  if IdPreparacion<>0 then
  begin
    sAndWhere := sAndWhere +
      'AND fsap.PickingId = 0 ';
  end;

  sSQL :=
    'SELECT ' +
    '  COUNT(*) ' +
    'FROM dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ';

  if CodigoUbicacion<>'' then
  begin
    sSQL := sSQL +
      'INNER JOIN FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', ' + IntToStr(YearOf(Now())) + ' ) ubi ' +
      'ON ' +
      '  ubi.CodigoArticulo = art.CodigoArticulo ';
  end;

  if IdPreparacion<>0 then
  begin

    sSQL := sSQL +
      'INNER JOIN FS_SGA_AcumuladoPendiente fsap WITH (NOLOCK) ' +
      'ON ' +
      '  fsap.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
      '  AND fsap.CodigoArticulo = art.CodigoArticulo ' +
      '  AND fsap.IdPreparacion = ' + IntToStr(IdPreparacion) + ' ';

  end;

  sSQL := sSQL +
    'WHERE ' +
    '  art.TipoArticulo = ''M'' ';

  if CodigoUbicacion<>'' then
    sSQL := sSQL +
      '  AND (ubi.UnidadesSaldo>0 OR ubi.UnidadesSaldoBase>0) ' +
      '  AND ubi.Matricula = ''' + SQL_Str(Matricula) + ''' ';

  sSQL := sSQL + sAndWhere;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  PBT := 0;
  PNT := 0;
  VT  := 0;

  if CodigoUbicacion<>'' then
  begin

    sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'art', '' );

    sSQL :=
      'SELECT DISTINCT 0 AS CodigoAgrupacion, 1 AS UnidadesAgrupacion, '''' AS Agrupacion, ubi.CodigoArticulo, ubi.Matricula, ubi.UnidadesSaldo, ubi.FechaCaduca, ubi.UnidadesSaldoBase, ubi.Partida, ubi.CodigoColor_, ' +
      '  ubi.CodigoTalla01_, art.DescripcionArticulo, art.CodigoFamilia, art.CodigoSubfamilia, art.TratamientoPartidas, ' +
      '  art.Colores_, art.GrupoTalla_, ubi.UnidadMedida AS UnidadMedida2_, ubi.UnidadMedidaBase AS UnidadMedidaAlternativa_, ' +
      '  ubi.FactorConversion_, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc, ' +
      '  art.CodigoAlternativo, art.CodigoAlternativo2, art.Descripcion2Articulo, CTC.CodigoAlternativo AS CodigoAlternativoTC, ' +
      '  ubi.UnidadesSaldoBase * art.PesoBrutoUnitario_ AS PesoBruto, ubi.UnidadesSaldoBase * art.PesoNetoUnitario_ AS PesoNeto, ' +
      '  ubi.UnidadesSaldoBase * art.VolumenUnitario_ AS Volumen, T.DescripcionTalla01_ as DescripcionTalla, C.Color_ AS DescripcionColor ' +
      'FROM dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
      'INNER JOIN FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', ' + IntToStr(YearOf(Now())) + ' ) ubi ' +
      'ON ' +
      '  ubi.CodigoArticulo = art.CodigoArticulo ' +
      'LEFT JOIN Colores_ C WITH (NOLOCK) ' +
      'ON ' +
      '  C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
      '  AND C.CodigoColor_ = ubi.CodigoColor_ ' +
      'LEFT JOIN Vis_VistaTallas T WITH (NOLOCK) ' +
      'ON ' +
      '  T.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
      '  AND T.GrupoTalla_= art.GrupoTalla_ ' +
      '  AND T.CodigoTalla01_ = ubi.CodigoTalla01_ ' +
      'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
      'ON ' +
      '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
      '  AND CTC.CodigoArticulo = ubi.CodigoArticulo ' +
      '  AND CTC.CodigoTalla01_ = ubi.CodigoTalla01_ ' +
      '  AND CTC.CodigoColor_ = ubi.CodigoColor_ ' +
      'WHERE ' +
      '  art.TipoArticulo = ''M'' ' +
      '  AND (ubi.UnidadesSaldo>0 OR ubi.UnidadesSaldoBase>0) ' +
      '  AND ubi.CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + ''' ';
    if Matricula<>'' then
    begin
      sSQL := sSQL +
        '  AND ( ubi.Matricula = ''' + SQL_Str(Matricula) + ''' )';
    end;

    sSQL := sSQL +
      sAndWhere + ' ' +
      'ORDER BY ' +
      '  ubi.CodigoArticulo ';

    if CodigoArticulo='' then
    begin
      sSQL := sSQL +
        'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
        'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';
    end;

  end else if IdPreparacion<>0 then
  begin

    sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'ART', '' );

    sSQL :=
      'SELECT fsap.CodigoAgrupacion, fsap.UnidadesAgrupacion, ISNULL(AGRUP.Agrupacion,''UNIDADES'') AS Agrupacion, '''' AS Matricula, ' +
      '  fsap.CodigoArticulo, fsap.Cantidad AS UnidadesSaldo, fsap.FechaCaduca, fsap.CantidadBase AS UnidadesSaldoBase, ' +
      '  fsap.Partida, fsap.CodigoColor_, fsap.CodigoTalla01_, art.DescripcionArticulo, art.CodigoFamilia, art.CodigoSubfamilia, ' +
      '  art.TratamientoPartidas, art.Colores_, art.GrupoTalla_, fsap.UnidadMedida AS UnidadMedida2_, fsap.UnidadMedidaBase AS UnidadMedidaAlternativa_, ' +
      '  art.CodigoAlternativo, art.CodigoAlternativo2, art.Descripcion2Articulo, CTC.CodigoAlternativo AS CodigoAlternativoTC, ' +
      '  T.DescripcionTalla01_ as DescripcionTalla, C.Color_ AS DescripcionColor, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc, ' +
      '  fsap.CantidadBase * art.PesoBrutoUnitario_ AS PesoBruto, ' +
      '  fsap.CantidadBase * art.PesoNetoUnitario_ AS PesoNeto, ' +
      '  fsap.CantidadBase * art.VolumenUnitario_ AS Volumen, ' +
      '  ISNULL(UM.FactorConversion_, 1) AS FactorConversion_ ' +
      'FROM dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
      'INNER JOIN FS_SGA_AcumuladoPendiente fsap ' +
      'ON ' +
      '  fsap.CodigoArticulo = art.CodigoArticulo ' +
      'LEFT JOIN UnidadesMedida UM WITH (NOLOCK) ' +
      'ON ' +
      '  UM.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.UnidadesMedida) + ' ' +
      '  AND UM.CodigoArticulo = fsap.CodigoArticulo ' +
      '  AND UM.UnidadMedida1_ = fsap.UnidadMedida ' +
      'LEFT JOIN Agrupaciones AGRUP ' +
      'ON ' +
      '  AGRUP.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
      '  AND AGRUP.CodigoArticulo = fsap.CodigoArticulo ' +
      '  AND AGRUP.CodigoAgrupacion = fsap.CodigoAgrupacion ' +
      'LEFT JOIN Colores_ C WITH (NOLOCK) ' +
      'ON ' +
      '  C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
      '  AND C.CodigoColor_ = fsap.CodigoColor_ ' +
      'LEFT JOIN Vis_VistaTallas T WITH (NOLOCK) ' +
      'ON ' +
      '  T.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
      '  AND T.GrupoTalla_= art.GrupoTalla_ ' +
      '  AND T.CodigoTalla01_ = fsap.CodigoTalla01_ ' +
      'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
      'ON ' +
      '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
      '  AND CTC.CodigoArticulo = fsap.CodigoArticulo ' +
      '  AND CTC.CodigoTalla01_ = fsap.CodigoTalla01_ ' +
      '  AND CTC.CodigoColor_ = fsap.CodigoColor_ ' +
      'WHERE ' +
      '  art.TipoArticulo = ''M'' ' +
      '  AND (fsap.Cantidad>=0 OR fsap.CantidadBase>=0) ' +
      '  AND fsap.IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
      sAndWhere +
      'ORDER BY ' +
      '  CASE WHEN fsap.CantidadBase = 0 THEN 1 ELSE 0 END, ' +
      '  fsap.CodigoArticulo ';

      sSQL := sSQL +
        'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
        'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  end else begin

    sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'ART', '' );

    sSQL :=
      'SELECT *, 0 AS CodigoAgrupacion, 1 AS UnidadesAgrupacion, '''' AS Agrupacion, '''' AS Partida, '''' AS CodigoColor_, Null as FechaCaduca, '''' AS CodigoTalla01_, 0 as UnidadesSaldo, 0 AS UnidadesSaldoBase, ' +
      '  '''' AS CodigoAlternativoTC, '''' AS DescripcionColor, '''' AS DescripcionTalla, '''' AS Matricula, ' +
      '  art.PesoBrutoUnitario_ AS PesoBruto, ' +
      '  art.PesoNetoUnitario_ AS PesoNeto, ' +
      '  art.VolumenUnitario_ AS Volumen, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc, art.FactorConversion_ ' +
      'FROM dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
      'LEFT JOIN UnidadesMedida UM WITH (NOLOCK) ' +
      'ON ' +
      '  UM.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.UnidadesMedida) + ' ' +
      '  AND UM.CodigoArticulo = art.CodigoArticulo ' +
      '  AND UM.UnidadMedida1_ = art.UnidadMedidaAlternativa_ ' +
      'WHERE ' +
      '  art.TipoArticulo = ''M'' ' +
      sAndWhere +
      'ORDER BY ' +
      '  art.CodigoArticulo ' +
      'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
      'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    JSonUnidadesMedida := SGA_FS_ARTICULO_Obtener_UnidadesMedida ( Conn, CodigoEmpresa, Q.FieldByName('CodigoArticulo').AsString );

    if Q.FieldByName('FechaCaduca').IsNull then
      sFechaCaduca := ''
    else
      sFechaCaduca := FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaCaduca').AsDateTime);

    fUnidadesSaldo     := Q.FieldByName('UnidadesSaldo').AsFloat;
    fUnidadesSaldoBase := Q.FieldByName('UnidadesSaldoBase').AsFloat;

    sUnidadMedida      := AnsiUpperCase(Q.FieldByName('UnidadMedida2_').AsString);
    sUnidadMedidaBase  := AnsiUpperCase(Q.FieldByName('UnidadMedidaAlternativa_').AsString);

    if sUnidadMedidaBase='' then
    begin
      sUnidadMedidaBase := sUnidadMedida;
      sUnidadMedida     := '';
    end;

    Result := Result + '{' +
      '"Matricula":"' + JSON_Str(Q.FieldByName('Matricula').AsString) + '",' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
      '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"CodigoAlternativo2":"' + JSON_Str(Q.FieldByName('CodigoAlternativo2').AsString) + '",' +
      '"CodigoAlternativoTC":"' + JSON_Str(Q.FieldByName('CodigoAlternativoTC').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"Descripcion2Articulo":"' + JSON_Str(Q.FieldByName('Descripcion2Articulo').AsString) + '",' +
      '"CodigoFamilia":"' + JSON_Str(Q.FieldByName('CodigoFamilia').AsString) + '",' +
      '"CodigoSubfamilia":"' + JSON_Str(Q.FieldByName('CodigoSubfamilia').AsString) + '",' +
      '"TratamientoPartidas":' + IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('Colores_').AsInteger<>0) + ',' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
      '"DescripcionColor":"' + JSON_Str(Q.FieldByName('DescripcionColor').AsString) + '",' +
      '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
      '"DescripcionTalla":"' + JSON_Str(Q.FieldByName('DescripcionTalla').AsString) + '",' +
      '"GrupoTalla":' + Q.FieldByName('GrupoTalla_').AsString + ',' +
      '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
      '"UnidadesAgrupacion":' + SQL_FloatToStr(Q.FieldByName('UnidadesAgrupacion').AsFloat) + ',' +
      '"Agrupacion":"' + JSON_Str(Q.FieldByName('Agrupacion').AsString) + '",' +
      '"UnidadesSaldo":' + SQL_FloatToStr(fUnidadesSaldo) + ', ' +
      '"UnidadesSaldoBase":' + SQL_FloatToStr(fUnidadesSaldoBase) + ', ' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(sUnidadMedida)) + '",' +
      '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(sUnidadMedidaBase)) + '",' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion_').AsFloat) + ',' +
      '"PesoNeto":' + SQL_FloatToStr(Q.FieldByName('PesoNeto').AsFloat) + ',' +
      '"PesoBruto":' + SQL_FloatToStr(Q.FieldByName('PesoBruto').AsFloat) + ',' +
      '"Volumen":' + SQL_FloatToStr(Q.FieldByName('Volumen').AsFloat) + ',' +
      '"FechaCaduca":"' + sFechaCaduca + '",' +
      JSonUnidadesMedida +
      '}';

    PBT := PBT + Q.FieldByName('PesoBruto').AsFloat;
    PNT := PNT + Q.FieldByName('PesoNeto').AsFloat;
    VT  := VT + Q.FieldByName('Volumen').AsFloat;

    Q.Next;

  end;

  Result := Result + '],"Totales":{' +
    '"PesoNeto":' + SQL_FloatToStr(PBT) + ',' +
    '"PesoBruto":' + SQL_FloatToStr(PNT) + ',' +
    '"Volumen":' + SQL_FloatToStr(VT) +
  '}}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT D'ARTICLES D'UNA RECEPCIÓ                                     │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listArticulosRecepcionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  RecepcionId: Integer;
  sSQL: String;
  Q, Q2: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoArticulo: string;
  CodigoUbicacion: string;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoUsuario: Integer;
  CodigoUbicacionRecepcion: String;
  CodigoUbicacionRechazos: String;

  contentfields: TStringList;
  UnidadesAgrupacion: Double;
  JSonUnidadesMedida: string;
  Linea: Integer;
  Pending: Boolean;
  sFechaCaduca: String;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  RecepcionId := StrToIntDef(contentfields.values['RecepcionId'],0);
  if RecepcionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de recepción no especificado","Data":[]}';
    Exit;
  end;

  Pending := (StrToIntDef(contentfields.Values['Pendientes'],0)<>0);
  Linea   := StrToIntDef(contentfields.values['Linea'],0);

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  OrdenarPor    := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden     := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy      := '';

  if OrdenarPor='PEDIDO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsrl.EjercicioPedido DESC, fsrl.SeriePedido DESC, fsrl.NumeroPedido DESC, fsrl.OrdenLineaPedido ';
    end else begin
      sOrderBy := 'fsrl.EjercicioPedido, fsrl.SeriePedido, fsrl.NumeroPedido, fsrl.OrdenLineaPedido ';
    end;
  end else if OrdenarPor='ESTADO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsrl.UdSaldo DESC ';
    end else begin
      sOrderBy := 'fsrl.UdSaldo ';
    end;
  end else if OrdenarPor='ARTICULO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsrl.CodigoArticulo DESC, fsrl.Partida DESC ';
    end else begin
      sOrderBy := 'fsrl.CodigoArticulo, fsrl.Partida ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsrl.RecepcionIdLinea DESC ';
    end else begin
      sOrderBy := 'fsrl.RecepcionIdLinea ';
    end;
  end;

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionRecepcion,         CodigoUbicacionRecepcion, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionRecepcionRechazos, CodigoUbicacionRechazos, CodigoEmpresa.EmpresaOrigen );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_Recepciones_Lineas FSRL WITH (NOLOCK) ' +
          'INNER JOIN LineasPedidoProveedor LPP WITH (NOLOCK) ' +
          'ON FSRL.CodigoEmpresa = LPP.CodigoEmpresa ' +
          'AND FSRL.EjercicioPedido = LPP.EjercicioPedido ' +
          'AND FSRL.SeriePedido = LPP.SeriePedido ' +
          'AND FSRL.NumeroPedido = LPP.NumeroPedido ' +
          'AND FSRL.OrdenLineaPedido = LPP.Orden ' +
          'AND FSRL.LineasPosicion = LPP.LineasPosicion ' +
          'INNER JOIN CabeceraPedidoProveedor CPP WITH (NOLOCK) ' +
          'ON CPP.CodigoEmpresa = LPP.CodigoEmpresa ' +
          'AND CPP.EjercicioPedido = LPP.EjercicioPedido ' +
          'AND CPP.SeriePedido = LPP.SeriePedido ' +
          'AND CPP.NUmeroPedido = LPP.NumeroPedido ' +
          'WHERE ' +
          '  FSRL.RecepcionId = ' + IntToStr(RecepcionId) + ' ';
          //'  AND CPP.Estado = 0 ' +
          //'  AND LPP.Estado = 0 ';
  if Linea<>0 then
  begin
    sSQL := sSQL +
      'AND FSRL.RecepcionIdLinea = ' + IntToStr(Linea) + ' ';
  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'ART', '' );

  sSQL :=
    'SELECT ' +
    '  fsr.Estado, fsrl.*, T.DescripcionTalla01_ as DescripcionTalla, C.Color_ AS DescripcionColor, ' +
    '  art.GrupoTalla_, art.Colores_, art.TratamientoPartidas, art.CodigoAlternativo, art.CodigoAlternativo2, ' +
    '  CTC.CodigoAlternativo AS CodigoAlternativoTC, art.Descripcion2Articulo, ' +
    '  ISNULL(agrup.DescripcionArticulo,''Unidades'') AS Agrupacion, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc ' +
    'FROM FS_SGA_Recepciones_Lineas fsrl WITH (NOLOCK) ' +
    'INNER JOIN FS_SGA_Recepciones fsr WITH (NOLOCK) ' +
    'ON fsr.RecepcionId = fsrl.RecepcionId ' +
    'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
    'ON ' +
    '  fsrl.CodigoArticulo = art.CodigoArticulo ' +
    'INNER JOIN LineasPedidoProveedor LPP WITH (NOLOCK) ' +
    'ON ' +
    '  FSRL.CodigoEmpresa = LPP.CodigoEmpresa ' +
    '  AND FSRL.EjercicioPedido = LPP.EjercicioPedido ' +
    '  AND FSRL.SeriePedido = LPP.SeriePedido ' +
    '  AND FSRL.NumeroPedido = LPP.NumeroPedido ' +
    '  AND FSRL.OrdenLineaPedido = LPP.Orden ' +
    '  AND FSRL.LineasPosicion = LPP.LineasPosicion ' +
    'INNER JOIN CabeceraPedidoProveedor CPP WITH (NOLOCK) ' +
    'ON ' +
    '  CPP.CodigoEmpresa = LPP.CodigoEmpresa ' +
    '  AND CPP.EjercicioPedido = LPP.EjercicioPedido ' +
    '  AND CPP.SeriePedido = LPP.SeriePedido ' +
    '  AND CPP.NUmeroPedido = LPP.NumeroPedido ' +
    'LEFT JOIN Agrupaciones agrup WITH (NOLOCK) ' +
    'ON ' +
    '  agrup.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
    '  AND agrup.CodigoArticulo = fsrl.CodigoArticulo ' +
    '  AND agrup.CodigoAgrupacion = fsrl.CodigoAgrupacion ' +
    'LEFT JOIN Colores_ C WITH (NOLOCK) ' +
    'ON ' +
    '  C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
    '  AND C.CodigoColor_ = fsrl.CodigoColor_ ' +
    'LEFT JOIN Vis_VistaTallas T WITH (NOLOCK) ' +
    'ON ' +
    '  T.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
    '  AND T.GrupoTalla_= art.GrupoTalla_ ' +
    '  AND T.CodigoTalla01_ = fsrl.CodigoTalla01_ ' +
    'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
    'ON ' +
    '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
    '  AND CTC.CodigoArticulo = fsrl.CodigoArticulo ' +
    '  AND CTC.CodigoTalla01_ = fsrl.CodigoTalla01_ ' +
    '  AND CTC.CodigoColor_ = fsrl.CodigoColor_ ' +
    'WHERE ' +
    '  fsrl.RecepcionId = ' + IntToStr(RecepcionId) + ' ';
    //'  AND CPP.Estado = 0 ' +
    //'  AND LPP.Estado = 0 ';

  if Linea<>0 then
  begin
    sSQL := sSQL +
      'AND fsrl.RecepcionIdLinea = ' + IntToStr(Linea) + ' ';
  end;

  sSQL := sSQL +
    'ORDER BY ' +
    sOrderBy +
    'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
    'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', sIDCall, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    JSonUnidadesMedida := SGA_FS_ARTICULO_Obtener_UnidadesMedida ( Conn, CodigoEmpresa, Q.FieldByName('CodigoArticulo').AsString );

    if Q.FieldByName('CodigoAgrupacion').AsInteger = 0 then
      UnidadesAgrupacion := 1
    else
      UnidadesAgrupacion := Q.FieldByName('UnidadesAgrupacion').AsFloat;

    if (not Q.FieldByName('FechaCaduca').IsNull) and (Q.FieldByName('FechaCaduca').AsDateTime>0) then
      sFechaCaduca := FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaCaduca').AsDateTime)
    else
      sFechaCaduca := '';

    Result := Result +
      '{' +
      '"Estado":' + Q.FieldByName('Estado').AsString + ',' +
      '"RecepcionId":' + Q.FieldByName('RecepcionId').AsString + ',' +
      '"RecepcionIdLinea":' + Q.FieldByName('RecepcionIdLinea').AsString + ',' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
      '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
      '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
      '"OrdenLineaPedido":' + Q.FieldByName('OrdenLineaPedido').AsString + ',' +
      '"LineasPosicion":"' + Q.FieldByName('LineasPosicion').AsString + '",' +
      '"UdPedidas":' + SQL_FloatToStr(Q.FieldByName('UdPedidas').AsFloat) + ',' +
      '"UdRecibidas":' + SQL_FloatToStr(Q.FieldByName('UdRecibidas').AsFloat) + ',' +
      '"UdRechazo":' + SQL_FloatToStr(Q.FieldByName('UdRechazo').AsFloat) + ',' +
      '"UdSaldo":' + SQL_FloatToStr(Q.FieldByName('UdSaldo').AsFloat) + ',' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion').AsFloat) + ',' +
      '"UdPedidasBase":' + SQL_FloatToStr(Q.FieldByName('UdPedidasBase').AsFloat) + ',' +
      '"UdRecibidasBase":' + SQL_FloatToStr(Q.FieldByName('UdRecibidasBase').AsFloat) + ',' +
      '"UdRechazoBase":' + SQL_FloatToStr(Q.FieldByName('UdRechazoBase').AsFloat) + ',' +
      '"UdSaldoBase":' + SQL_FloatToStr(Q.FieldByName('UdSaldoBase').AsFloat) + ',' +
      '"Precio":' + SQL_FloatToStr(Q.FieldByName('Precio').AsFloat) + ',' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
      '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"CodigoAlternativo2":"' + JSON_Str(Q.FieldByName('CodigoAlternativo2').AsString) + '",' +
      '"CodigoAlternativoTC":"' + JSON_Str(Q.FieldByName('CodigoAlternativoTC').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"Descripcion2Articulo":"' + JSON_Str(Q.FieldByName('Descripcion2Articulo').AsString) + '",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
      '"CodigoProveedor":"' + JSON_Str(Q.FieldByName('CodigoProveedor').AsString) + '",' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"IdAlbaranPro":"' + JSON_Str(Q.FieldByName('IdAlbaranPro').AsString) + '",' +
      '"Albaran":"' + JSON_Str(Q.FieldByName('Albaran').AsString) + '",' +
      '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
      '"Agrupacion":"' + JSON_Str(Q.FieldByName('Agrupacion').AsString) + '",' +
      '"UnidadesAgrupacion":' + SQL_FloatToStr(UnidadesAgrupacion) + ',' +
      '"FechaRecepcion":"' + Q.FieldByName('FechaRecepcion').AsString + '",' +
      '"FechaCaduca":"' + sFechaCaduca + '",' +
      '"TratamientoPartidas":' + SQL_BooleanToStr(Q.FieldByName('TratamientoPartidas').AsInteger<>0) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString)) + '",' +
      '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '",' +
      '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
      '"DescripcionTalla":"' + JSON_Str(Q.FieldByName('DescripcionTalla').AsString) + '",' +
      '"GrupoTalla":' + IntToStr(Q.FieldByName('GrupoTalla_').AsInteger) + ',' +
      '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('Colores_').AsInteger<>0) + ',' +
      '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
      '"DescripcionColor":"' + JSON_Str(Q.FieldByName('DescripcionColor').AsString) + '",' +
      '"LineaPedidoTalla":"' + JSON_Str(Q.FieldByName('LineaPedidoTalla').AsString) + '",' +
      '"OrdenDetalleTalla":' + IntToStr(Q.FieldByName('OrdenDetalleTalla').AsInteger) + ',' +
      JSonUnidadesMedida +

      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT D'ARTICLES D'UNA DEVOLUCIÓ                                    │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listArticulosDevolucionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  DevolucionId: Integer;
  sSQL: String;
  Q, Q2: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoArticulo: string;
  CodigoUbicacion: string;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoUsuario: Integer;
  CodigoUbicacionDevolucion: String;
  CodigoUbicacionDevolucionRechazos: String;
  contentfields: TStringList;
  UnidadesAgrupacion: Double;
  JSonUnidadesMedida: string;
  Linea: Integer;
  Pending: Boolean;
  sPending: string;
  giNumDecimalesUnidades: Integer;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  DevolucionId := StrToIntDef(contentfields.values['DevolucionId'],0);
  if DevolucionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no especificado","Data":[]}';
    Exit;
  end;

  Pending := (AnsiUpperCase(contentfields.Values['Pendiente'])<>'FALSE');
  Linea   := StrToIntDef(contentfields.values['Linea'],0);

  giNumDecimalesUnidades := SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GPR', 'NumeroDecimales' );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  OrdenarPor    := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden     := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy      := '';

  sPending := '';
  if Pending then
  begin
    sPending := 'AND ABS(ROUND(UdRecibidas,' + IntToStr(giNumDecimalesUnidades) + ')) < ABS(ROUND(UdPedidas,' + IntToStr(giNumDecimalesUnidades) + ' )) ';
  end;

  if OrdenarPor='PEDIDO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsdl.EjercicioPedido DESC, fsdl.SeriePedido DESC, fsdl.NumeroPedido DESC, fsdl.OrdenLineaPedido ';
    end else begin
      sOrderBy := 'fsdl.EjercicioPedido, fsdl.SeriePedido, fsdl.NumeroPedido, fsdl.OrdenLineaPedido ';
    end;
  end else if OrdenarPor='ESTADO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsdl.UdSaldo DESC ';
    end else begin
      sOrderBy := 'fsdl.UdSaldo ';
    end;
  end else if OrdenarPor='ARTICULO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsdl.CodigoArticulo DESC, fsdl.Partida DESC ';
    end else begin
      sOrderBy := 'fsdl.CodigoArticulo, fsdl.Partida ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsdl.DevolucionIdLinea DESC ';
    end else begin
      sOrderBy := 'fsdl.DevolucionIdLinea ';
    end;
  end;

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucion,         CodigoUbicacionDevolucion, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucionRechazos, CodigoUbicacionDevolucionRechazos, CodigoEmpresa.EmpresaOrigen );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_Devoluciones_Lineas FSDL WITH (NOLOCK) ' +
          'INNER JOIN LineasPedidoCliente LPC WITH (NOLOCK) ' +
          'ON FSDL.CodigoEmpresa = LPC.CodigoEmpresa ' +
          'AND FSDL.EjercicioPedido = LPC.EjercicioPedido ' +
          'AND FSDL.SeriePedido = LPC.SeriePedido ' +
          'AND FSDL.NumeroPedido = LPC.NumeroPedido ' +
          'AND FSDL.OrdenLineaPedido = LPC.Orden ' +
          'AND FSDL.LineasPosicion = LPC.LineasPosicion ' +
          'INNER JOIN CabeceraPedidoCliente CPC WITH (NOLOCK) ' +
          'ON CPC.CodigoEmpresa = LPC.CodigoEmpresa ' +
          'AND CPC.EjercicioPedido = LPC.EjercicioPedido ' +
          'AND CPC.SeriePedido = LPC.SeriePedido ' +
          'AND CPC.NUmeroPedido = LPC.NumeroPedido ' +
          'INNER JOIN Articulos ART WITH (NOLOCK) ' +
          'ON ART.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
          '  AND ART.CodigoArticulo = LPC.CodigoArticulo ' +
          'WHERE ' +
          '  FSDL.DevolucionId = ' + IntToStr(DevolucionId) + ' ' +
          //'  AND CPC.Estado = 0 ' +
          //'  AND LPC.Estado = 0 ' +
          '  AND ART.TipoArticulo = ''M'' ' +
          sPending;
  if Linea<>0 then
  begin
    sSQL := sSQL +
      'AND FSDL.DevolucionIdLinea = ' + IntToStr(Linea) + ' ';
  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'ART', '' );

  sSQL :=
    'SELECT ' +
    '  fsd.Estado, fsdl.*, T.DescripcionTalla01_ as DescripcionTalla, C.Color_ AS DescripcionColor, ' +
    '  art.GrupoTalla_, art.Colores_, art.TratamientoPartidas, art.CodigoAlternativo, art.CodigoAlternativo2, ' +
    '  CTC.CodigoAlternativo AS CodigoAlternativoTC, art.Descripcion2Articulo, ' +
    '  ISNULL(agrup.DescripcionArticulo,''Unidades'') AS Agrupacion, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc ' +
    'FROM FS_SGA_Devoluciones_Lineas fsdl WITH (NOLOCK) ' +
    'INNER JOIN FS_SGA_Devoluciones fsd WITH (NOLOCK) ' +
    'ON ' +
    '  fsd.DevolucionId = fsdl.DevolucionId ' +
    'INNER JOIN Articulos ART WITH (NOLOCK) ' +
    'ON ART.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
    '  AND ART.CodigoArticulo = fsdl.CodigoArticulo ' +
    'INNER JOIN LineasPedidoCliente LPC WITH (NOLOCK) ' +
    'ON ' +
    '  FSDL.CodigoEmpresa = LPC.CodigoEmpresa ' +
    '  AND FSDL.EjercicioPedido = LPC.EjercicioPedido ' +
    '  AND FSDL.SeriePedido = LPC.SeriePedido ' +
    '  AND FSDL.NumeroPedido = LPC.NumeroPedido ' +
    '  AND FSDL.OrdenLineaPedido = LPC.Orden ' +
    '  AND FSDL.LineasPosicion = LPC.LineasPosicion ' +
    'INNER JOIN CabeceraPedidoCliente CPC WITH (NOLOCK) ' +
    'ON ' +
    '  CPC.CodigoEmpresa = LPC.CodigoEmpresa ' +
    '  AND CPC.EjercicioPedido = LPC.EjercicioPedido ' +
    '  AND CPC.SeriePedido = LPC.SeriePedido ' +
    '  AND CPC.NUmeroPedido = LPC.NumeroPedido ' +
    'LEFT JOIN Agrupaciones agrup WITH (NOLOCK) ' +
    'ON ' +
    '  agrup.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
    '  AND agrup.CodigoArticulo = fsdl.CodigoArticulo ' +
    '  AND agrup.CodigoAgrupacion = fsdl.CodigoAgrupacion ' +
    'LEFT JOIN Colores_ C WITH (NOLOCK) ' +
    'ON ' +
    '  C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
    '  AND C.CodigoColor_ = fsdl.CodigoColor_ ' +
    'LEFT JOIN Vis_VistaTallas T WITH (NOLOCK) ' +
    'ON ' +
    '  T.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
    '  AND T.GrupoTalla_= art.GrupoTalla_ ' +
    '  AND T.CodigoTalla01_ = fsdl.CodigoTalla01_ ' +
    'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
    'ON ' +
    '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
    '  AND CTC.CodigoArticulo = fsdl.CodigoArticulo ' +
    '  AND CTC.CodigoTalla01_ = fsdl.CodigoTalla01_ ' +
    '  AND CTC.CodigoColor_ = fsdl.CodigoColor_ ' +
    'WHERE ' +
    '  fsdl.DevolucionId = ' + IntToStr(DevolucionId) + ' ' +
    //'  AND CPC.Estado = 0 ' +
    //'  AND LPC.Estado = 0 ' +
    '  AND ART.TipoArticulo = ''M'' ' +
    sPending;

  if Linea<>0 then
  begin
    sSQL := sSQL +
      'AND fsdl.DevolucionIdLinea = ' + IntToStr(Linea) + ' ';
  end;

  sSQL := sSQL +
    'ORDER BY ' +
    sOrderBy +
    'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
    'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', sIDCall, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    JSonUnidadesMedida := SGA_FS_ARTICULO_Obtener_UnidadesMedida ( Conn, CodigoEmpresa, Q.FieldByName('CodigoArticulo').AsString );

    if Q.FieldByName('CodigoAgrupacion').AsInteger = 0 then
      UnidadesAgrupacion := 1
    else
      UnidadesAgrupacion := Q.FieldByName('UnidadesAgrupacion').AsFloat;

    Result := Result +
      '{' +
      '"Estado":' + Q.FieldByName('Estado').AsString + ',' +
      '"DevolucionId":' + Q.FieldByName('DevolucionId').AsString + ',' +
      '"DevolucionIdLinea":' + Q.FieldByName('DevolucionIdLinea').AsString + ',' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
      '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
      '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
      '"OrdenLineaPedido":' + Q.FieldByName('OrdenLineaPedido').AsString + ',' +
      '"LineasPosicion":"' + Q.FieldByName('LineasPosicion').AsString + '",' +
      '"UdPedidas":' + SQL_FloatToStr(abs(Q.FieldByName('UdPedidas').AsFloat)) + ',' +
      '"UdRecibidas":' + SQL_FloatToStr(abs(Q.FieldByName('UdRecibidas').AsFloat)) + ',' +
      '"UdRechazo":' + SQL_FloatToStr(abs(Q.FieldByName('UdRechazo').AsFloat)) + ',' +
      '"UdSaldo":' + SQL_FloatToStr(abs(Q.FieldByName('UdSaldo').AsFloat)) + ',' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion').AsFloat) + ',' +
      '"UdPedidasBase":' + SQL_FloatToStr(abs(Q.FieldByName('UdPedidasBase').AsFloat)) + ',' +
      '"UdRecibidasBase":' + SQL_FloatToStr(abs(Q.FieldByName('UdRecibidasBase').AsFloat)) + ',' +
      '"UdRechazoBase":' + SQL_FloatToStr(abs(Q.FieldByName('UdRechazoBase').AsFloat)) + ',' +
      '"UdSaldoBase":' + SQL_FloatToStr(abs(Q.FieldByName('UdSaldoBase').AsFloat)) + ',' +
      '"Precio":' + SQL_FloatToStr(Q.FieldByName('Precio').AsFloat) + ',' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
      '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"CodigoAlternativo2":"' + JSON_Str(Q.FieldByName('CodigoAlternativo2').AsString) + '",' +
      '"CodigoAlternativoTC":"' + JSON_Str(Q.FieldByName('CodigoAlternativoTC').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"Descripcion2Articulo":"' + JSON_Str(Q.FieldByName('Descripcion2Articulo').AsString) + '",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
      '"CodigoCliente":"' + JSON_Str(Q.FieldByName('CodigoCliente').AsString) + '",' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"IdAlbaranCli":"' + JSON_Str(Q.FieldByName('IdAlbaranCli').AsString) + '",' +
      '"Albaran":"' + JSON_Str(Q.FieldByName('Albaran').AsString) + '",' +
      '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
      '"Agrupacion":"' + JSON_Str(Q.FieldByName('Agrupacion').AsString) + '",' +
      '"UnidadesAgrupacion":' + SQL_FloatToStr(UnidadesAgrupacion) + ',' +
      '"FechaRecepcion":"' + Q.FieldByName('FechaRecepcion').AsString + '",' +
      '"TratamientoPartidas":' + SQL_BooleanToStr(Q.FieldByName('TratamientoPartidas').AsInteger<>0) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString)) + '",' +
      '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '",' +
      '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
      '"DescripcionTalla":"' + JSON_Str(Q.FieldByName('DescripcionTalla').AsString) + '",' +
      '"GrupoTalla":' + IntToStr(Q.FieldByName('GrupoTalla_').AsInteger) + ',' +
      '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('Colores_').AsInteger<>0) + ',' +
      '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
      '"DescripcionColor":"' + JSON_Str(Q.FieldByName('DescripcionColor').AsString) + '",' +
      JSonUnidadesMedida +

      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT D'ARTICLES D'UNA DEVOLUCIÓ DE PROVEÏDOR                       │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listArticulosDevolucionProvAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  DevolucionId: Integer;
  sSQL: String;
  Q, Q2: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoArticulo: string;
  CodigoUbicacion: string;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoUsuario: Integer;
  CodigoUbicacionDevolucion: String;
  CodigoUbicacionDevolucionRechazos: String;
  contentfields: TStringList;
  UnidadesAgrupacion: Double;
  JSonUnidadesMedida: string;
  Linea: Integer;
  Pending: Boolean;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  DevolucionId := StrToIntDef(contentfields.values['DevolucionId'],0);
  if DevolucionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no especificado","Data":[]}';
    Exit;
  end;

  Pending := (StrToIntDef(contentfields.Values['Pendientes'],0)<>0);
  Linea   := StrToIntDef(contentfields.values['Linea'],0);

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  OrdenarPor    := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden     := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy      := '';

  if OrdenarPor='PEDIDO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsdl.EjercicioPedido DESC, fsdl.SeriePedido DESC, fsdl.NumeroPedido DESC, fsdl.OrdenLineaPedido ';
    end else begin
      sOrderBy := 'fsdl.EjercicioPedido, fsdl.SeriePedido, fsdl.NumeroPedido, fsdl.OrdenLineaPedido ';
    end;
  end else if OrdenarPor='ESTADO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsdl.UdSaldo DESC ';
    end else begin
      sOrderBy := 'fsdl.UdSaldo ';
    end;
  end else if OrdenarPor='ARTICULO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsdl.CodigoArticulo DESC, fsdl.Partida DESC ';
    end else begin
      sOrderBy := 'fsdl.CodigoArticulo, fsdl.Partida ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsdl.DevolucionIdLinea DESC ';
    end else begin
      sOrderBy := 'fsdl.DevolucionIdLinea ';
    end;
  end;

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucion,         CodigoUbicacionDevolucion, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucionRechazos, CodigoUbicacionDevolucionRechazos, CodigoEmpresa.EmpresaOrigen );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_DevolucionesP_Lineas FSDL WITH (NOLOCK) ' +
          'INNER JOIN LineasPedidoProveedor LPP WITH (NOLOCK) ' +
          'ON FSDL.CodigoEmpresa = LPP.CodigoEmpresa ' +
          'AND FSDL.EjercicioPedido = LPP.EjercicioPedido ' +
          'AND FSDL.SeriePedido = LPP.SeriePedido ' +
          'AND FSDL.NumeroPedido = LPP.NumeroPedido ' +
          'AND FSDL.OrdenLineaPedido = LPP.Orden ' +
          'AND FSDL.LineasPosicion = LPP.LineasPosicion ' +
          'INNER JOIN CabeceraPedidoProveedor CPP WITH (NOLOCK) ' +
          'ON CPP.CodigoEmpresa = LPP.CodigoEmpresa ' +
          'AND CPP.EjercicioPedido = LPP.EjercicioPedido ' +
          'AND CPP.SeriePedido = LPP.SeriePedido ' +
          'AND CPP.NUmeroPedido = LPP.NumeroPedido ' +
          'WHERE ' +
          '  FSDL.DevolucionId = ' + IntToStr(DevolucionId) + ' ' +
          '  AND CPP.Estado = 0 ' +
          '  AND LPP.Estado = 0 ';
  if Linea<>0 then
  begin
    sSQL := sSQL +
      'AND FSDL.DevolucionIdLinea = ' + IntToStr(Linea) + ' ';
  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'ART', '' );

  sSQL :=
    'SELECT ' +
    '  fsdl.*, T.DescripcionTalla01_ as DescripcionTalla, C.Color_ AS DescripcionColor, ' +
    '  art.GrupoTalla_, art.Colores_, art.TratamientoPartidas, art.CodigoAlternativo, art.CodigoAlternativo2, ' +
    '  CTC.CodigoAlternativo AS CodigoAlternativoTC, art.Descripcion2Articulo, ' +
    '  ISNULL(agrup.DescripcionArticulo,''Unidades'') AS Agrupacion, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc ' +
    'FROM FS_SGA_DevolucionesP_Lineas fsdl WITH (NOLOCK) ' +
    'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
    'ON ' +
    '  fsdl.CodigoArticulo = art.CodigoArticulo ' +
    'INNER JOIN LineasPedidoProveedor LPP WITH (NOLOCK) ' +
    'ON ' +
    '  FSDL.CodigoEmpresa = LPP.CodigoEmpresa ' +
    '  AND FSDL.EjercicioPedido = LPP.EjercicioPedido ' +
    '  AND FSDL.SeriePedido = LPP.SeriePedido ' +
    '  AND FSDL.NumeroPedido = LPP.NumeroPedido ' +
    '  AND FSDL.OrdenLineaPedido = LPP.Orden ' +
    '  AND FSDL.LineasPosicion = LPP.LineasPosicion ' +
    'INNER JOIN CabeceraPedidoProveedor CPP WITH (NOLOCK) ' +
    'ON ' +
    '  CPP.CodigoEmpresa = LPP.CodigoEmpresa ' +
    '  AND CPP.EjercicioPedido = LPP.EjercicioPedido ' +
    '  AND CPP.SeriePedido = LPP.SeriePedido ' +
    '  AND CPP.NUmeroPedido = LPP.NumeroPedido ' +
    'LEFT JOIN Agrupaciones agrup WITH (NOLOCK) ' +
    'ON ' +
    '  agrup.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
    '  AND agrup.CodigoArticulo = fsdl.CodigoArticulo ' +
    '  AND agrup.CodigoAgrupacion = fsdl.CodigoAgrupacion ' +
    'LEFT JOIN Colores_ C WITH (NOLOCK) ' +
    'ON ' +
    '  C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
    '  AND C.CodigoColor_ = fsdl.CodigoColor_ ' +
    'LEFT JOIN Vis_VistaTallas T WITH (NOLOCK) ' +
    'ON ' +
    '  T.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
    '  AND T.GrupoTalla_= art.GrupoTalla_ ' +
    '  AND T.CodigoTalla01_ = fsdl.CodigoTalla01_ ' +
    'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
    'ON ' +
    '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
    '  AND CTC.CodigoArticulo = fsdl.CodigoArticulo ' +
    '  AND CTC.CodigoTalla01_ = fsdl.CodigoTalla01_ ' +
    '  AND CTC.CodigoColor_ = fsdl.CodigoColor_ ' +
    'WHERE ' +
    '  fsdl.DevolucionId = ' + IntToStr(DevolucionId) + ' ' +
    '  AND CPP.Estado = 0 ' +
    '  AND LPP.Estado = 0 ';

  if Linea<>0 then
  begin
    sSQL := sSQL +
      'AND fsdl.DevolucionIdLinea = ' + IntToStr(Linea) + ' ';
  end;

  sSQL := sSQL +
    'ORDER BY ' +
    sOrderBy +
    'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
    'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', sIDCall, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    JSonUnidadesMedida := SGA_FS_ARTICULO_Obtener_UnidadesMedida ( Conn, CodigoEmpresa, Q.FieldByName('CodigoArticulo').AsString );

    if Q.FieldByName('CodigoAgrupacion').AsInteger = 0 then
      UnidadesAgrupacion := 1
    else
      UnidadesAgrupacion := Q.FieldByName('UnidadesAgrupacion').AsFloat;

    Result := Result +
      '{' +
      '"DevolucionId":' + Q.FieldByName('DevolucionId').AsString + ',' +
      '"DevolucionIdLinea":' + Q.FieldByName('DevolucionIdLinea').AsString + ',' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
      '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
      '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
      '"OrdenLineaPedido":' + Q.FieldByName('OrdenLineaPedido').AsString + ',' +
      '"LineasPosicion":"' + Q.FieldByName('LineasPosicion').AsString + '",' +
      '"UdPedidas":' + SQL_FloatToStr(abs(Q.FieldByName('UdPedidas').AsFloat)) + ',' +
      '"UdRecibidas":' + SQL_FloatToStr(abs(Q.FieldByName('UdRecibidas').AsFloat)) + ',' +
      '"UdRechazo":' + SQL_FloatToStr(abs(Q.FieldByName('UdRechazo').AsFloat)) + ',' +
      '"UdSaldo":' + SQL_FloatToStr(abs(Q.FieldByName('UdSaldo').AsFloat)) + ',' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion').AsFloat) + ',' +
      '"UdPedidasBase":' + SQL_FloatToStr(abs(Q.FieldByName('UdPedidasBase').AsFloat)) + ',' +
      '"UdRecibidasBase":' + SQL_FloatToStr(abs(Q.FieldByName('UdRecibidasBase').AsFloat)) + ',' +
      '"UdRechazoBase":' + SQL_FloatToStr(abs(Q.FieldByName('UdRechazoBase').AsFloat)) + ',' +
      '"UdSaldoBase":' + SQL_FloatToStr(abs(Q.FieldByName('UdSaldoBase').AsFloat)) + ',' +
      '"Precio":' + SQL_FloatToStr(Q.FieldByName('Precio').AsFloat) + ',' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
      '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"CodigoAlternativo2":"' + JSON_Str(Q.FieldByName('CodigoAlternativo2').AsString) + '",' +
      '"CodigoAlternativoTC":"' + JSON_Str(Q.FieldByName('CodigoAlternativoTC').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"Descripcion2Articulo":"' + JSON_Str(Q.FieldByName('Descripcion2Articulo').AsString) + '",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
      '"CodigoProveedor":"' + JSON_Str(Q.FieldByName('CodigoProveedor').AsString) + '",' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"IdAlbaranPro":"' + JSON_Str(Q.FieldByName('IdAlbaranPro').AsString) + '",' +
      '"Albaran":"' + JSON_Str(Q.FieldByName('Albaran').AsString) + '",' +
      '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
      '"Agrupacion":"' + JSON_Str(Q.FieldByName('Agrupacion').AsString) + '",' +
      '"UnidadesAgrupacion":' + SQL_FloatToStr(UnidadesAgrupacion) + ',' +
      '"FechaRecepcion":"' + Q.FieldByName('FechaRecepcion').AsString + '",' +
      '"TratamientoPartidas":' + SQL_BooleanToStr(Q.FieldByName('TratamientoPartidas').AsInteger<>0) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString)) + '",' +
      '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '",' +
      '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
      '"DescripcionTalla":"' + JSON_Str(Q.FieldByName('DescripcionTalla').AsString) + '",' +
      '"GrupoTalla":' + IntToStr(Q.FieldByName('GrupoTalla_').AsInteger) + ',' +
      '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('Colores_').AsInteger<>0) + ',' +
      '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
      '"DescripcionColor":"' + JSON_Str(Q.FieldByName('DescripcionColor').AsString) + '",' +
      JSonUnidadesMedida +

      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;

// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ RETORNA EL LLISTAT D'UBICACIONS D'UN ARTICLE                          │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1ubicacionesArticuloAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  sCodigoArticulo: String;
  YY: WORD;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoAlmacen: String;
  sAndWhere: String;
  Partida: string;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  sSQL: String;
  sFechaCaducidad: string;
  sFechaPrimeraEntrada: string;
  sFechaUltimaSalida: string;
  CodigoTalla: String;
  CodigoColor: String;
  CodigoUbicacion: string;
  bTransito: Boolean;
  fPesoMaximo: Double;
  sPackagings: string;
  CodigoPasillo: string;
  CodigoEstanteria: string;
  Altura: string;
  Fondo: string;
  CodigoAlternativo: string;
  StockPrevio: Boolean;
  sFechaUltimaEntrada: string;
  i: Integer;
  sUnidadMedida: string;
  sUnidadMedidaBase: string;
  sFieldTratamientoSeries: string;
  bBloqueada: Boolean;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  sCodigoArticulo := contentfields.values['CodigoArticulo'];
  CodigoTalla     := contentfields.values['CodigoTalla'];
  CodigoColor     := contentfields.values['CodigoColor'];
  StockPrevio     := AnsiUpperCase(contentfields.values['StockPrevio'])='TRUE';

  // Conversió al codi d'article real
  sCodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, sCodigoArticulo );

  if sCodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;

  CodigoAlmacen := (contentfields.values['CodigoAlmacen']);
  (*
  if CodigoAlmacen='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    Exit;
  end;
  *)

  Partida := (contentfields.values['Partida']);
  YY      := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sAndWhere := '';

  if (CodigoAlmacen<>'') and (CodigoAlmacen<>'-1') then begin
    sAndWhere := sAndWhere + ' AND fsas.CodigoAlmacen=''' + SQL_Str(CodigoAlmacen) + ''' ';
  end;

  if Partida<>'' then
  begin
    sAndWhere := sAndWhere + ' AND fsas.Partida=''' + SQL_Str(Partida) + ''' ';
  end;

  if (CodigoTalla<>'') then
  begin
    sAndWhere := sAndWhere + ' AND fsas.CodigoTalla01_=''' + SQL_Str(CodigoTalla) + ''' ';
  end;

  if (CodigoColor<>'') then
  begin
    sAndWhere := sAndWhere + ' AND fsas.CodigoColor_=''' + SQL_Str(CodigoColor) + ''' ';
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'ART', '' );

  sSQL :=
    'WITH CTE_ConStock AS ( ' +
    'SELECT 0 AS TipoRegistro, fsas.CodigoEmpresa, fsas.Ejercicio, fsas.Periodo, fsas.CodigoAlmacen, ' +
    '  fsas.CodigoUbicacion, fsas.CodigoArticulo, fsas.Partida, fsas.UnidadMedida, fsas.CodigoColor_, ' +
    '  fsas.CodigoTalla01_, fsas.UnidadesEntrada, fsas.UnidadesSalida, fsas.UnidadesSaldo, ' +
    '  fsas.UnidadMedidaBase, fsas.UnidadesEntradaBase, fsas.UnidadesSalidaBase, fsas.UnidadesSaldoBase, ' +
    '  fsas.FechaCaduca, fsas.Agrupacion, fsas.GrupoTalla_, fsas.Matricula, fsas.Almacen, ' +
    '  fsas.CodigoZona, fsas.NombreZona, fsas.CodigoPasillo, fsas.CodigoUbicacionAlternativo, ' +
    '  fsas.DescripcionPasillo, fsas.CodigoEstanteria, fsas.Altura, fsas.Fondo, fsas.Picking, fsas.Bloqueada, ' +
    '  fsas.Inactiva, fsas.MultiRef, fsas.MultiLote, fsas.Rotacion, fsas.DescripcionArticulo, ' +
    '  fsas.TipoArticulo, fsas.CodigoFamilia, fsas.CodigoSubfamilia, fsas.CodigoAlternativo, ' +
    '  fsas.CodigoAlternativo2, fsas.UnidadMedida2_, fsas.UnidadMedidaAlternativa_, fsas.FactorConversion_, ' +
    '  fsas.TratamientoPartidas, fsas.PrecioMedio, fsas.PrecioTotal, art.CodigoAlternativo AS CodigoAlternativoArt, ' +
    '  art.CodigoAlternativo2 AS CodigoAlternativo2Art, CTC.CodigoAlternativo AS CodigoAlternativoTC, ' +
    '  art.DescripcionArticulo AS DescripcionArticuloArt, u.CodigoZona AS Ubi_CodigoZona, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc, ' +
    '  u.NombreZona AS Ubi_NombreZona, u.Transito, u.PesoMaxPermitido, c.Color_ AS DescripcionColor, ' +
    '  t.DescripcionTalla01_ AS DescripcionTalla, fsas.FechaPrimeraEntrada, fsas. FechaUltimaEntrada, ' +
    '  fsas.FechaUltimaSalida ' +
    'FROM dbo.FS_SGA_TABLE_AcumuladoStock ( ' + IntToStr(CodigoEmpresa.Stocks) + ' ) fsas ' +
    'INNER JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' )  art ' +
    'ON ' +
    '  fsas.CodigoArticulo = art.CodigoArticulo ' +
    'LEFT JOIN dbo.FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) u ' +
    'ON ' +
    '  u.CodigoAlmacen = fsas.CodigoAlmacen AND ' +
    '  u.CodigoUbicacion = fsas.CodigoUbicacion ' +
    'LEFT JOIN Colores_ c WITH (NOLOCK) ' +
    'ON ' +
    '  c.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
    '  AND c.CodigoColor_ = fsas.CodigoColor_ ' +
    'LEFT JOIN Vis_VistaTallas t WITH (NOLOCK) ' +
    'ON ' +
    '  t.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
    '  AND t.GrupoTalla_= art.GrupoTalla_ ' +
    '  AND t.CodigoTalla01_ = fsas.CodigoTalla01_ ' +
    'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
    'ON ' +
    '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
    '  AND CTC.CodigoArticulo = fsas.CodigoArticulo ' +
    '  AND CTC.CodigoTalla01_ = fsas.CodigoTalla01_ ' +
    '  AND CTC.CodigoColor_ = fsas.CodigoColor_ ' +
    'WHERE ' +
    '  fsas.CodigoArticulo = ''' + SQL_Str(sCodigoArticulo) + ''' ' +
    '  AND fsas.Periodo = 99 ' +
    '  AND fsas.Ejercicio = ' + IntToStr(YY) + ' ' +
    sAndWhere + ' ' +
    '  AND (fsas.UnidadesSaldo <> 0 OR fsas.UnidadesSaldoBase <> 0) ' +
    '), ' +
    'CTE_SinStock AS ( ' +
    'SELECT DISTINCT 1 AS TipoRegistro, fsas.CodigoEmpresa, fsas.Ejercicio, fsas.Periodo, fsas.CodigoAlmacen, ' +
    '  fsas.CodigoUbicacion, fsas.CodigoArticulo, '''' AS Partida, fsas.UnidadMedida, fsas.CodigoColor_, ' +
    '  fsas.CodigoTalla01_, CAST(0 AS DECIMAL(28, 10)) AS UnidadesEntrada, CAST(0 AS DECIMAL(28, 10)) AS UnidadesSalida, ' +
    '  CAST(0 AS DECIMAL(28, 10)) AS UnidadesSaldo, fsas.UnidadMedidaBase, CAST(0 AS DECIMAL(28, 10)) AS UnidadesEntradaBase, ' +
    '  CAST(0 AS DECIMAL(28, 10)) AS UnidadesSalidaBase, CAST(0 AS DECIMAL(28, 10)) AS UnidadesSaldoBase, ' +
    '  NULL AS FechaCaduca, fsas.Agrupacion, fsas.GrupoTalla_, fsas.Matricula, fsas.Almacen, fsas.CodigoZona, ' +
    '  fsas.NombreZona, fsas.CodigoPasillo, fsas.CodigoUbicacionAlternativo, fsas.DescripcionPasillo, ' +
    '  fsas.CodigoEstanteria, fsas.Altura, fsas.Fondo, fsas.Picking, fsas.Bloqueada, fsas.Inactiva, fsas.MultiRef, ' +
    '  fsas.MultiLote, fsas.Rotacion, fsas.DescripcionArticulo, fsas.TipoArticulo, fsas.CodigoFamilia, ' +
    '  fsas.CodigoSubfamilia, fsas.CodigoAlternativo, fsas.CodigoAlternativo2, fsas.UnidadMedida2_, ' +
    '  fsas.UnidadMedidaAlternativa_, fsas.FactorConversion_, fsas.TratamientoPartidas, ' +
    '  CAST(0 AS DECIMAL(28, 10)) AS PrecioMedio, CAST(0 AS DECIMAL(28, 10)) AS PrecioTotal, ' +
    '  art.CodigoAlternativo AS CodigoAlternativoArt, art.CodigoAlternativo2 AS CodigoAlternativo2Art, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc, ' +
    '  CTC.CodigoAlternativo AS CodigoAlternativoTC, art.DescripcionArticulo AS DescripcionArticuloArt, ' +
    '  u.CodigoZona AS Ubi_CodigoZona, u.NombreZona AS Ubi_NombreZona, u.Transito, u.PesoMaxPermitido, ' +
    '  c.Color_ AS DescripcionColor, t.DescripcionTalla01_ AS DescripcionTalla, MIN(FechaPrimeraEntrada) AS FechaPrimeraEntrada, ' +
    '  MAX(FechaUltimaEntrada) AS FechaUltimaEntrada, MAX(FechaUltimaSalida) AS FechaUltimaSalida ' +
    'FROM dbo.FS_SGA_TABLE_AcumuladoStock ( ' + IntToStr(CodigoEmpresa.Stocks) + ' ) fsas ' +
    'INNER JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' )  art ' +
    'ON ' +
    '  fsas.CodigoArticulo = art.CodigoArticulo ' +
    'LEFT JOIN dbo.FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) u ' +
    'ON ' +
    '  u.CodigoAlmacen = fsas.CodigoAlmacen AND ' +
    '  u.CodigoUbicacion = fsas.CodigoUbicacion ' +
    'LEFT JOIN Colores_ c WITH (NOLOCK) ' +
    'ON ' +
    '  c.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
    '  AND c.CodigoColor_ = fsas.CodigoColor_ ' +
    'LEFT JOIN Vis_VistaTallas t WITH (NOLOCK) ' +
    'ON ' +
    '  t.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
    '  AND t.GrupoTalla_= art.GrupoTalla_ ' +
    '  AND t.CodigoTalla01_ = fsas.CodigoTalla01_ ' +
    'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
    'ON ' +
    '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
    '  AND CTC.CodigoArticulo = fsas.CodigoArticulo ' +
    '  AND CTC.CodigoTalla01_ = fsas.CodigoTalla01_ ' +
    '  AND CTC.CodigoColor_ = fsas.CodigoColor_ ' +
    'WHERE ' +
    '  fsas.CodigoArticulo = ''' + SQL_Str(sCodigoArticulo) + ''' ' +
    '  AND fsas.Periodo = 99 ' +
    '  AND fsas.Ejercicio = ' + IntToStr(YY) + ' ' +
    sAndWhere + ' ' +
    '  AND (fsas.UnidadesSaldo = 0 AND fsas.UnidadesSaldoBase = 0) ' +
    'GROUP BY fsas.CodigoEmpresa, fsas.Ejercicio, fsas.Periodo, fsas.CodigoAlmacen, fsas.UnidadMedidaBase, ' +
    '  fsas.CodigoUbicacion, fsas.CodigoArticulo, fsas.UnidadMedida, fsas.CodigoColor_, ' +
    '  fsas.CodigoTalla01_, fsas.Agrupacion, fsas.GrupoTalla_, fsas.Matricula, fsas.Almacen, fsas.CodigoZona, ' +
    '  fsas.NombreZona, fsas.CodigoPasillo, fsas.CodigoUbicacionAlternativo, fsas.DescripcionPasillo, ' +
    '  fsas.CodigoEstanteria, fsas.Altura, fsas.Fondo, fsas.Picking, fsas.Bloqueada, fsas.Inactiva, fsas.MultiRef, ' +
    '  fsas.MultiLote, fsas.Rotacion, fsas.DescripcionArticulo, fsas.TipoArticulo, fsas.CodigoFamilia, ' +
    '  fsas.CodigoSubfamilia, fsas.CodigoAlternativo, fsas.CodigoAlternativo2, fsas.UnidadMedida2_, ' +
    '  fsas.UnidadMedidaAlternativa_, fsas.FactorConversion_, fsas.TratamientoPartidas, ' + sFieldTratamientoSeries + ', ' +
    '  art.CodigoAlternativo, art.CodigoAlternativo2, CTC.CodigoAlternativo, art.DescripcionArticulo, ' +
    '  u.CodigoZona, u.NombreZona, u.Transito, u.PesoMaxPermitido, c.Color_, t.DescripcionTalla01_ ' +
    ') ' +
    'SELECT * ' +
    'FROM CTE_ConStock ';

  if stockPrevio then
  begin
    sSQL := sSQL +
    'UNION ALL ' +
    'SELECT s.* ' +
    'FROM CTE_SinStock s ' +
    'WHERE NOT EXISTS ( ' +
    '  SELECT 1 ' +
    '  FROM CTE_ConStock a ' +
    '  WHERE a.CodigoEmpresa = s.CodigoEmpresa ' +
    '    AND a.Ejercicio = s.Ejercicio ' +
    '    AND a.Periodo = s.Periodo ' +
    '    AND a.CodigoAlmacen = s.CodigoAlmacen ' +
    '    AND a.CodigoUbicacion = s.CodigoUbicacion ' +
    '    AND a.CodigoArticulo = s.CodigoArticulo ' +
    '    AND a.Matricula = s.Matricula ' +
    '    AND a.CodigoColor_ = s.CodigoColor_ ' +
    '    AND a.CodigoTalla01_ = s.CodigoTalla01_ ' +
    ') ';
  end;

  sSQL := sSQL +
    'ORDER BY TipoRegistro ASC, CodigoAlmacen, Matricula, CodigoUbicacion, Partida ' +
    'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
    'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iTotalRegs := Q.RecordCount;
  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    CodigoUbicacion := Q.FieldByName('CodigoUbicacion').AsString;
    bTransito       := Q.FieldByName('Transito').AsBoolean;
    bBloqueada      := Q.FieldByName('Bloqueada').AsBoolean;
    fPesoMaximo     := Q.FieldByName('PesoMaxPermitido').AsFloat;
    sPackagings     := FS_SGA_PackagingsUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );

    FS_SGA_UBICACION_Desglosar ( Conn, CodigoEmpresa, CodigoUbicacion, CodigoAlmacen, CodigoPasillo, CodigoEstanteria, Altura, Fondo, CodigoAlternativo );

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    if Q.FieldByName('FechaPrimeraEntrada').AsDateTime>0 then
      sFechaPrimeraEntrada := FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaPrimeraEntrada').AsDateTime )
    else
      sFechaPrimeraEntrada := '';

    if Q.FieldByName('FechaUltimaEntrada').AsDateTime>0 then
      sFechaUltimaEntrada := FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaUltimaEntrada').AsDateTime )
    else
      sFechaUltimaEntrada := '';

    if Q.FieldByName('FechaUltimaSalida').AsDateTime>0 then
      sFechaUltimaSalida := FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaUltimaSalida').AsDateTime )
    else
      sFechaUltimaSalida := '';

    if (i=0) and (Q.FieldByName('FechaCaduca').AsDateTime>0) then
      sFechaCaducidad := FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaCaduca').AsDateTime )
    else
      sFechaCaducidad := '';

    sUnidadMedida     := AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString);
    sUnidadMedidaBase := AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString);

    if sUnidadMedidaBase='' then
      sUnidadMedidaBase := sUnidadMedida;

    Result := Result + '{' +
      '"TipoRegistro":' + IntToStr(Q.FieldByName('TipoRegistro').AsInteger) + ',' +
      '"Tipo":2,' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ', ' +
      '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
      '"CodigoZona":"' + JSON_Str(Q.FieldByName('CodigoZona').AsString) + '",' +
      '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
      '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"CodigoAlternativo2":"' + JSON_Str(Q.FieldByName('CodigoAlternativo2').AsString) + '",' +
      '"CodigoAlternativoTC":"' + JSON_Str(Q.FieldByName('CodigoAlternativoTC').AsString) + '",' +
      '"DescripcionTalla":"' + JSON_Str(Q.FieldByName('DescripcionTalla').AsString) + '",' +
      '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
      '"DescripcionColor":"' + JSON_Str(Q.FieldByName('DescripcionColor').AsString) + '",' +
      '"CodigoUbicacion":"' + JSON_Str(Q.FieldByName('CodigoUbicacion').AsString) + '",' +
      '"CodigoUbicacionAlternativo":"' + JSON_Str(Q.FieldByName('CodigoUbicacionAlternativo').AsString) + '",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"UnidadesSaldo":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldo').AsFloat ) + ',' +
      '"UnidadesSaldoBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldoBase').AsFloat ) + ',' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion_').AsFloat) + ',' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(sUnidadMedida)) + '",' +
      '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(sUnidadMedidaBase)) + '",' +
      '"FechaPrimeraEntrada":"' + sFechaPrimeraEntrada + '",' +
      '"FechaUltimaEntrada":"' + sFechaUltimaEntrada + '",' +
      '"FechaUltimaSalida":"' + sFechaUltimaSalida + '",' +
      '"FechaCaduca":"' + sFechaCaducidad + '",' +
      '"Matricula":"' + JSON_Str(Q.FieldByName('Matricula').AsString) + '",' +
      '"TratamientoPartidas":' + IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"Bloqueada":' + SQL_BooleanToStr(bBloqueada) + ','+
      '"Transito":' + SQL_BooleanToStr(bTransito) + ',' +
      '"PesoMaximo":' + SQL_FloatToStr(fPesoMaximo) + ',' +
      '"Packagings":[' + sPackagings + ']' +
      '}';

    Q.Next;

  end;

  Q.Close;
  FreeAndNil(Q);

  Result := Result + ']}';

  {$ENDREGION}

end;


procedure WebModule1listUbicacionesFavoritasAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Tipo: String;
  OrdenarPor: String;
  TipoOrden: String;
  sOrderBy: String;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  SoloTransito: boolean;
  UbicacionDestino: String;
  HideAlmacen: String;
  ShowAlmacen: String;
  CodigoUbicacion: String;
  sPackagings: String;
  fPesoMaximo: Double;
  CodigoAlmacen: string;
  CodigoPasillo: string;
  CodigoEstanteria: string;
  Altura: string;
  Fondo: string;
  CodigoAlternativo: string;
  bTransito: Boolean;
  bBloqueada: Boolean;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  SoloTransito     := strtointdef(contentfields.Values['SoloTransito'],0)<>0;
  UbicacionDestino := contentfields.Values['UbicacionDestino'];
  HideAlmacen      := contentfields.Values['HideAlmacen'];
  ShowAlmacen      := contentfields.Values['ShowAlmacen'];

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM dbo.FS_SGA_TABLE_UbicacionesFavoritas ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) fsuf ' +
          'INNER JOIN dbo.FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) fstu ' +
          'ON ' +
          '  fsuf.ubifav_CodigoUbicacion = fstu.CodigoUbicacion ' +
          'INNER JOIN ( ' +
          '  SELECT * FROM FS_SGA_Almacenes WITH (NOLOCK) ' +
          '  WHERE ' +
          '    CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
          '    AND VisiblePDA <> 0 ' +
          '  ) FSA ' +
          'ON ' +
          '  FSA.CodigoAlmacen = fstu.CodigoAlmacen ' +
          'WHERE 1 = 1 ';

  if (SoloTransito) and (UbicacionDestino<>'') then
  begin
    sSQL := sSQL +
      'AND (fstu.Transito <> 0 OR fsuf.ubifav_CodigoUbicacion=''' + SQL_Str(UbicacionDestino) + ''')';
  end else begin
    if (SoloTransito) then
    begin
      sSQL := sSQL +
        'AND fstu.Transito <> 0 ';
    end else if (UbicacionDestino<>'') then
    begin
      sSQL := sSQL +
        'AND fsuf.ubifav_CodigoUbicacion=''' + SQL_Str(UbicacionDestino) + '''';
    end;
  end;

  if HideAlmacen<>'' then
  begin
    sSQL := sSQL +
      'AND fstu.CodigoAlmacen <> ''' + SQL_Str(HideAlmacen) + ''' ';
  end;

  if ShowAlmacen<>'' then
  begin
    sSQL := sSQL +
      'AND fstu.CodigoAlmacen = ''' + SQL_Str(ShowAlmacen) + ''' ';
  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT ' +
    '  fsuf.*, fstu.CodigoAlternativo, fstu.CodigoAlmacen, fstu.PesoMaxPermitido ' +
    'FROM dbo.FS_SGA_TABLE_UbicacionesFavoritas ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) fsuf ' +
    'INNER JOIN dbo.FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) fstu ' +
    'ON ' +
    '  fsuf.ubifav_CodigoUbicacion = fstu.CodigoUbicacion ' +
    'INNER JOIN ( ' +
    '  SELECT * FROM FS_SGA_TABLE_Almacenes ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
    '  WHERE ' +
    '    VisiblePDA <> 0 ' +
    '  ) FSA ' +
    'ON ' +
    '  FSA.CodigoAlmacen = fstu.CodigoAlmacen ' +
    'WHERE 1 = 1 ';

  if (SoloTransito) and (UbicacionDestino<>'') then
  begin
    sSQL := sSQL +
      'AND (fstu.Transito <> 0 OR fsuf.ubifav_CodigoUbicacion=''' + SQL_Str(UbicacionDestino) + ''')';
  end else begin
    if (SoloTransito) then
    begin
      sSQL := sSQL +
        'AND fstu.Transito <> 0 ';
    end else if (UbicacionDestino<>'') then
    begin
      sSQL := sSQL +
        'AND fsuf.ubifav_CodigoUbicacion=''' + SQL_Str(UbicacionDestino) + '''';
    end;
  end;

  if HideAlmacen<>'' then
  begin
    sSQL := sSQL +
      'AND fsuf.CodigoAlmacen <> ''' + SQL_Str(HideAlmacen) + ''' ';
  end;

  if ShowAlmacen<>'' then
  begin
    sSQL := sSQL +
      'AND fstu.CodigoAlmacen = ''' + SQL_Str(ShowAlmacen) + ''' ';
  end;

  sSQL := sSQL +
    'ORDER BY ' +
    '  fsuf.ubifav_order, fsuf.ubifav_descripcion ' +
    'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
    'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    CodigoUbicacion := Q.FieldByName('ubifav_CodigoUbicacion').AsString;
    bTransito       := Q.FieldByName('Transito').AsBoolean;
    bBloqueada      := Q.FieldByName('Bloqueada').AsBoolean;
    fPesoMaximo     := Q.FieldByName('PesoMaxPermitido').AsFloat;
    sPackagings     := FS_SGA_PackagingsUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );

    FS_SGA_UBICACION_Desglosar ( Conn, CodigoEmpresa, CodigoUbicacion, CodigoAlmacen, CodigoPasillo, CodigoEstanteria, Altura, Fondo, CodigoAlternativo );


    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"Tipo":2,' +
      '"Descripcion":"' + JSON_Str(Q.FieldByName('ubifav_Descripcion').AsString) + '",' +
      '"CodigoAlmacen":"' + JSON_Str(CodigoAlmacen) + '",' +
      '"CodigoPasillo":"' + JSON_Str(CodigoPasillo) + '",' +
      '"CodigoEstanteria":"' + JSON_Str(CodigoEstanteria) + '",' +
      '"Altura":"' + JSON_Str(Altura) + '",' +
      '"Fondo":"' + JSON_Str(Fondo) + '",' +
      '"Matricula":"",' +
      '"CodigoUbicacion":"' + JSON_Str(CodigoUbicacion) + '",' +
      '"CodigoUbicacionAlternativo":"' + JSON_Str(CodigoAlternativo) + '",' +
      '"Bloqueada":' + SQL_BooleanToStr(bBloqueada) + ',' +
      '"Transito":' + SQL_BooleanToStr(bTransito) + ',' +
      '"PesoMaximo":' + SQL_FloatToStr(fPesoMaximo) + ',' +
      '"Packagings":[' + sPackagings + ']' +
      '}';

    (*
    Result := Result +
      '{' +
      '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
      '"CodigoUbicacion":"' + JSON_Str(Q.FieldByName('ubifav_CodigoUbicacion').AsString) + '",' +
      '"CodigoUbicacionAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"Matricula":"",' +
      '"Descripcion":"' + JSON_Str(Q.FieldByName('ubifav_Descripcion').AsString) + '",' +
      '"Transito":' + SQL_BooleanToStr(Q.FieldByName('Transito').AsBoolean) +
      '}';
    *)

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ RETORNA EL PACKING LIST D'UNA EXPEDICIÓ                               │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getPackingListExpedicionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegsPalet: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdPreparacion: Integer;
  IdExpedicion: Integer;
  PickingId: Integer;
  PaletId: Integer;
  CajaId: Integer;
  EmpresaOrigen: Integer;
  LastExpedicion: Integer;
  LastPaletId: Integer;
  LastCajaId: Integer;
  LastPickingId: Integer;
  iNumRegsCaja: Integer;
  iNumRegsPicking: Integer;
  iNumRegsExpedicion: Integer;
  PesoBrutoExpedicion: Double;
  PesoNetoExpedicion: Double;
  VolumenExpedicion: Double;
  PesoBrutoPalet: Double;
  PesoNetoPalet: Double;
  VolumenPalet: Double;
  PesoBrutoTotal: Double;
  PesoNetoTotal: Double;
  VolumenTotal: Double;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación incorrecto","Data":[]}';
    Exit;
  end;

  IdExpedicion := StrToIntDef(contentfields.values['IdExpedicion'],0);
  PickingId    := StrToIntDef(contentfields.values['PickingId'],0);
  PaletId      := StrToIntDef(contentfields.values['PaletId'],0);
  CajaId       := StrToIntDef(contentfields.values['CajaId'],0);

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL :=
    'SELECT ' +
    '  COUNT(*) ' +
    'FROM dbo.FS_SGA_PACKINGLIST WITH (NOLOCK) ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ';

  if IdExpedicion<>0 then
  begin
    sSQL := sSQL +
      '  AND IdentificadorExpedicion = ' + IntToStr(IdExpedicion) + ' ';
  end;

  if PickingId<>0 then
  begin
    sSQL := sSQL +
      '  AND PickingId = ' + IntToStr(PickingId) + ' ';
  end;

  if PaletId<>0 then
  begin
    sSQL := sSQL +
      '  AND PaletId = ' + IntToStr(PaletId) + ' ';
  end;

  if CajaId<>0 then
  begin
    sSQL := sSQL +
      '  AND CajaId = ' + IntToStr(CajaId) + ' ';
  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'ART', '' );

  sSQL :=
    'SELECT ' +
    '  FSPPL.CodigoArticulo, FSPPL.DescripcionArticulo, FSPPL.Descripcion2Articulo, FSPPL.UnidadMedida, ' +
    '  FSPPL.UnidadMedidaBase, FSPPL.UdNecesarias, FSPPL.UdNecesariasBase, FSPPL.UdRetiradas, FSPPL.UdRetiradasBase, ' +
    '  FSPPL.UdExpedidas, FSPPL.UdExpedidasBase, FSPPL.FactorConversion, FSPPL.EjercicioPedido, FSPPL.SeriePedido, ' +
    '  FSPPL.NumeroPedido, FSPPL.OrdenLineaPedido, FSPPL.LineasPosicion, FSPPL.GrupoTalla_, FSPPL.CodigoTalla01_, ' +
    '  FSPPL.CodigoColor_, FSPPL.CodigoCliente, VVT.DescripcionTalla01_, C.Color_, FSPLP.IdPackaging AS PackagingPalet, ' +
    '  FSPDP.Dt_Nombre AS DescripcionPackagingPalet, FSPLC.IdPackaging AS PackagingCaja, CPC.RazonSocial, ' +
    '  FSPDC.Dt_Nombre AS DescripcionPackagingCaja, ISNULL(LPCT.UnidadesAServir, 0) AS AServirTalla, ' +
    '  ART.TratamientoPartidas, ART.Colores_, FSPL.*, ART.PesoBrutoUnitario_, ART.PesoNetoUnitario_, ' +
    '  ART.VolumenUnitario_,FSPLP.PesoBruto AS Palet_PesoBruto, FSPLP.PesoNeto AS Palet_PesoNeto, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc, ' +
    '  FSPLP.Volumen AS Palet_Volumen, FSPLP.Ancho AS Palet_Ancho, FSPLP.Fondo AS Palet_Fondo, FSPLP.Alto AS Palet_Alto, ' +
    '  FSPLC.PesoBruto AS Caja_PesoBruto, FSPLC.PesoNeto AS Caja_PesoNeto, FSPLC.Volumen AS Caja_Volumen, ' +
    '  FSPLC.Ancho AS Caja_Ancho, FSPLC.Fondo AS Caja_Fondo, FSPLC.Alto AS Caja_Alto ' +
    'FROM FS_SGA_Picking_Pedido_Lineas FSPPL WITH (NOLOCK) ' +
    'LEFT JOIN FS_SGA_PackingList FSPL WITH (NOLOCK) ' +
    'ON ' +
    '  FSPL.preparacionId = FSPPL.PreparacionId ' +
    '  AND FSPL.pickingId = FSPPL.PickingId ' +
    'INNER JOIN LineasPedidoCliente LPC WITH (NOLOCK) ' +
    'ON ' +
    '  LPC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND LPC.EjercicioPedido = FSPPL.EjercicioPedido ' +
    '  AND LPC.SeriePedido = FSPPL.SeriePedido ' +
    '  AND LPC.NumeroPedido = FSPPL.NumeroPedido ' +
    '  AND LPC.Orden = FSPPL.OrdenLineaPedido ' +
    '  AND LPC.LineasPosicion = FSPPL.LineasPosicion ' +
    'INNER JOIN CabeceraPedidoCliente CPC WITH (NOLOCK) ' +
    'ON ' +
    '  CPC.CodigoEmpresa = LPC.CodigoEmpresa ' +
    '  AND CPC.EjercicioPedido = LPC.EjercicioPedido ' +
    '  AND CPC.SeriePedido = LPC.SeriePedido ' +
    '  AND CPC.NumeroPedido = LPC.NumeroPedido ' +
    'INNER JOIN Articulos ART WITH (NOLOCK) ' +
    'ON ' +
    '  ART.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
    '  AND ART.CodigoArticulo = LPC.CodigoArticulo ' +
    'LEFT JOIN FS_SAGE_TABLE_LineasPedidoClienteTC ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' + IntToStr(CodigoEmpresa.GrupoTallas) + ', ' + IntToStr(CodigoEmpresa.Colores ) + ' ) LPCT ' +
    'ON ' +
    '  LPCT.GrupoTalla_ = LPC.GrupoTalla_ ' +
    '  AND LPCT.CodigoTalla = FSPPL.CodigoTalla01_ ' +
    '  AND LPCT.CodigoColor = FSPPL.CodigoColor_ ' +
    'LEFT JOIN Vis_VistaTallas VVT WITH (NOLOCK) ' +
    'ON ' +
    '  VVT.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
    '  AND VVT.GrupoTalla_ = FSPPL.GrupoTalla_ ' +
    '  AND VVT.CodigoTalla01_ = FSPPL.CodigoTalla01_ ' +
    'LEFT JOIN Colores_ C WITH (NOLOCK) ' +
    'ON ' +
    '  C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
    '  AND C.CodigoColor_ = FSPPL.CodigoColor_ ' +
    'LEFT JOIN FS_SGA_PackingList_PackagingPalet FSPLP WITH (NOLOCK) ' +
    'ON ' +
    '  FSPL.preparacionId = FSPLP.IdPreparacion ' +
    '  AND FSPL.paletId = FSPLP.IdPalet ' +
    'LEFT JOIN FS_SGA_PackagingDetalle FSPDP WITH (NOLOCK) ' +
    'ON ' +
    '  FSPDP.Dt_Id = FSPLP.IdPackaging ' +
    'LEFT JOIN FS_SGA_PackingList_PackagingCaja FSPLC WITH (NOLOCK) ' +
    'ON ' +
    '  FSPL.preparacionId = FSPLC.IdPreparacion ' +
    '  AND FSPL.paletId = FSPLC.IdPalet ' +
    '  AND FSPL.cajaId = FSPLC.IdCaja ' +
    'LEFT JOIN FS_SGA_PackagingDetalle FSPDC WITH (NOLOCK) ' +
    'ON ' +
    '  FSPDC.Dt_Id = FSPLC.IdPackaging ' +
    'WHERE ' +
    '  FSPPL.PreparacionId = ' + IntToStr(IdPreparacion) + ' ';

  if IdExpedicion<>0 then
  begin
    sSQL := sSQL +
      '  AND FSPL.IdentificadorExpedicion = ' + IntToStr(IdExpedicion) + ' ';
  end;

  if PickingId<>0 then
  begin
    sSQL := sSQL +
      '  AND FSPL.PickingId = ' + IntToStr(PickingId) + ' ';
  end;

  if PaletId<>0 then
  begin
    sSQL := sSQL +
      '  AND FSPL.PaletId = ' + IntToStr(PaletId) + ' ';
  end;

  if CajaId<>0 then
  begin
    sSQL := sSQL +
      '  AND FSPL.CajaId = ' + IntToStr(CajaId) + ' ';
  end;

  sSQL := sSQL +
    'ORDER BY IdentificadorExpedicion, PaletId, CajaId, fecha ';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  PesoBrutoExpedicion := 0;
  PesoNetoExpedicion  := 0;
  VolumenExpedicion   := 0;
  PesoBrutoPalet      := 0;
  PesoNetoPalet       := 0;
  VolumenPalet        := 0;
  PesoBrutoTotal      := 0;
  PesoNetoTotal       := 0;
  VolumenTotal        := 0;

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Q.RecordCount=0 then
  begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[]}';
    Exit;
  end;

  iNumRegsPalet := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegsPalet) + ',"Data":[';

  iNumRegsExpedicion := 0;
  iNumRegsPalet := 0;
  iNumRegsCaja := 0;
  iNumRegsPicking := 0;

  if not Q.EOF then
    CajaId  := Q.FieldByName('CajaId').AsInteger;

  LastExpedicion := -1;
  LastPaletId    := -1;
  LastPickingId  := -1;
  LastCajaId     := -1;

  while not Q.EOF do begin

    IdExpedicion := Q.FieldByName('IdentificadorExpedicion').AsInteger;
    PaletId      := Q.FieldByName('PaletId').AsInteger;
    CajaId       := Q.FieldByName('CajaId').AsInteger;
    PickingId    := Q.FieldByName('PickingId').AsInteger;

    PesoBrutoExpedicion := PesoBrutoExpedicion + Q.FieldByName('Caja_PesoBruto').AsFloat;
    PesoNetoExpedicion  := PesoNetoExpedicion + Q.FieldByName('Caja_PesoNeto').AsFloat;
    VolumenExpedicion   := VolumenExpedicion + Q.FieldByName('Caja_Volumen').AsFloat;
    PesoBrutoPalet      := PesoBrutoPalet + Q.FieldByName('Caja_PesoBruto').AsFloat;
    PesoNetoPalet       := PesoNetoPalet + Q.FieldByName('Caja_PesoNeto').AsFloat;
    VolumenPalet        := VolumenPalet + Q.FieldByName('Caja_Volumen').AsFloat;
    PesoBrutoTotal      := PesoBrutoTotal + Q.FieldByName('Caja_PesoBruto').AsFloat;
    PesoNetoTotal       := PesoNetoTotal + Q.FieldByName('Caja_PesoNeto').AsFloat;
    VolumenTotal        := VolumenTotal + Q.FieldByName('Caja_Volumen').AsFloat;

    if iNumRegsPicking<>0 then
    begin
      if (CajaId<>LastCajaId) or (PaletId<>LastPaletId) or (IdExpedicion<>LastExpedicion) then
        Result := Result + ']}';
    end;

    if iNumRegsCaja<>0 then
    begin
      if (PaletId<>LastPaletId) or (IdExpedicion<>LastExpedicion) then
        Result := Result + ']}';
    end;

    if iNumRegsExpedicion<>0 then
    begin
      if  (IdExpedicion<>LastExpedicion) then
      begin
        if IdExpedicion<>LastExpedicion then
          Result := Result + ']}';
      end;
    end;

    if IdExpedicion <> LastExpedicion then
    begin
      LastExpedicion := IdExpedicion;
      if iNumRegsExpedicion<>0 then
        Result := Result + ',';
      Inc(iNumRegsExpedicion);
      iNumRegsPalet := 0;
      iNumRegsCaja := 0;
      iNumRegsPicking := 0;
      LastPaletId := -1;
      LastCajaId := -1;
      Result := Result +
        '{' +
        '"Expedicion":' + IntToStr(IdExpedicion) + ',' +
        '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
        '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
        '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ',' +
        '"OrdenLineaPedido":' + IntToStr(Q.FieldByName('OrdenLineaPedido').AsInteger) + ',' +
        '"LineasPosicion":"' + JSON_Str(Q.FieldByName('LineasPosicion').AsString) + '",' +
        '"CodigoCliente":"' + JSON_Str(Q.FieldByName('CodigoCliente').AsString) + '",' +
        '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
        '"Expanded":true,' +
        '"Palets":[';
    end;

    if (PaletId>0) and (PaletId<>LastPaletId) then
    begin
      LastPaletId := PaletId;
      if iNumRegsPalet<>0 then
        Result := Result + ',';
      Inc(iNumRegsPalet);
      iNumRegsCaja := 0;
      iNumRegsPicking := 0;
      LastCajaId := -1;
      Result := Result +
        '{' +
        '"Palet":' + IntToStr(PaletId) + ',' +
        '"Packaging":' + IntToStr(Q.FieldByName('PackagingPalet').AsInteger) + ',' +
        '"Matricula":"' + JSON_Str(Q.FieldByName('Matricula').AsString) + '",' +
        '"DescripcionPackaging":"' + SQL_Str(Q.FieldByName('DescripcionPackagingPalet').AsString) + '",' +
        '"PesoBruto":' + SQL_FloatToStr(Q.FieldByName('Palet_PesoBruto').AsFloat) + ',' +
        '"PesoNeto":' + SQL_FloatToStr(Q.FieldByName('Palet_PesoNeto').AsFloat) + ',' +
        '"Volumen":' + SQL_FloatToStr(Q.FieldByName('Palet_Volumen').AsFloat) + ',' +
        '"Ancho":' + SQL_FloatToStr(Q.FieldByName('Palet_Ancho').AsFloat) + ',' +
        '"Fondo":' + SQL_FloatToStr(Q.FieldByName('Palet_Fondo').AsFloat) + ',' +
        '"Alto":' + SQL_FloatToStr(Q.FieldByName('Palet_Alto').AsFloat) + ',' +
        '"Expanded":true,' +
        '"Cajas":[';
    end;

    if (PaletId>0) and (CajaId>0) and (CajaId<>LastCajaId) then
    begin
      LastCajaId := CajaId;
      if iNumRegsCaja<>0 then
        Result := Result + ',';
      Inc(iNumRegsCaja);
      iNumRegsPicking := 0;
      Result := Result +
        '{' +
        '"Caja":' + IntToStr(CajaId) + ',' +
        '"Packaging":' + IntToStr(Q.FieldByName('PackagingCaja').AsInteger) + ',' +
        '"DescripcionPackaging":"' + SQL_Str(Q.FieldByName('DescripcionPackagingCaja').AsString) + '",' +
        '"PesoBruto":' + SQL_FloatToStr(Q.FieldByName('Caja_PesoBruto').AsFloat) + ',' +
        '"PesoNeto":' + SQL_FloatToStr(Q.FieldByName('Caja_PesoNeto').AsFloat) + ',' +
        '"Volumen":' + SQL_FloatToStr(Q.FieldByName('Caja_Volumen').AsFloat) + ',' +
        '"Ancho":' + SQL_FloatToStr(Q.FieldByName('Caja_Ancho').AsFloat) + ',' +
        '"Fondo":' + SQL_FloatToStr(Q.FieldByName('Caja_Fondo').AsFloat) + ',' +
        '"Alto":' + SQL_FloatToStr(Q.FieldByName('Caja_Alto').AsFloat) + ',' +
        '"Expanded":true,' +
        '"Articulos":[';
    end;

    if (PaletId>0) and (CajaId>0) then
    begin

      if iNumRegsPicking<>0 then
        Result := Result + ',';

      Inc(iNumRegsPicking);

      Result := Result + '{' +
        '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
        '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
        '"Descripcion2Articulo":"' + JSON_Str(Q.FieldByName('Descripcion2Articulo').AsString) + '",' +
        '"TratamientoPartidas":' + SQL_BooleanToStr(Q.FieldByName('TratamientoPartidas').AsInteger<>0) + ',' +
        '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
        '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('Colores_').AsInteger<>0) + ',' +
        '"Cantidad":' + SQL_FloatToStr(Q.FieldByName('Unidades').AsFloat) + ', ' +
        '"CantidadBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesBase').AsFloat) + ', ' +
        '"PesoBrutoUnitario":' + SQL_FloatToStr(Q.FieldByName('PesoBrutoUnitario_').AsFloat) + ', ' +
        '"PesoNetoUnitario":' + SQL_FloatToStr(Q.FieldByName('PesoNetoUnitario_').AsFloat) + ', ' +
        '"VolumenUnitario":' + SQL_FloatToStr(Q.FieldByName('VolumenUnitario_').AsFloat) + ', ' +
        '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
        '"CodigoAgrupacion":' + Q.FieldByName('CodigoAgrupacion').AsString + ', ' +
        '"UnidadesAgrupacion":' + SQL_FloatToStr(Q.FieldByName('UnidadesAgrupacion').AsFloat) + ', ' +
        '"FechaCaduca":"' + JSON_Str(Q.FieldByName('FechaCaduca').AsString) + '",' +
        '"GrupoTalla":"' + IntToStr(Q.FieldByName('GrupoTalla_').AsInteger) + '",' +
        '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
        '"DescripcionTalla":"' + JSON_Str(Q.FieldByName('DescripcionTalla01_').AsString) + '",' +
        '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
        '"DescripcionColor":"' + JSON_Str(Q.FieldByName('Color_').AsString) + '"' +
        '}';

    end;

    Q.Next;

  end;

  //if iNumRegsExpedicion>0 then
  //  Result := Result + ']}';

  if (PaletId>0) and (CajaId>0) then
    Result := Result + ']}';

  if (PaletId>0) then
    Result := Result + ']}';

  Result := Result + '],' +
    '"Total":{' +
    '"PesoNeto":' + SQL_FloatToStr(PesoNetoTotal) + ',' +
    '"PesoBruto":' + SQL_FloatToStr(PesoBrutoTotal) + ',' +
    '"Volumen":' + SQL_FloatToStr(VolumenTotal) +
    '}}]}';

  gaLogFile.Write(Result);
  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ RETORNA EL PACKING LIST D'UNA LÍNIA DE COMANDA                        │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getPackingListAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdPreparacion: Integer;
  PickingId: Integer;
  EmpresaOrigen: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación incorrecto","Data":[]}';
    Exit;
  end;

  PickingId := StrToIntDef(contentfields.values['PickingId'],0);
  if PickingId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Línea de preparación incorrecto","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM dbo.FS_SGA_PACKINGLIST WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND PickingId = ' + IntToStr(PickingId);

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  * ' +
          'FROM dbo.FS_SGA_PACKINGLIST WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND PickingId = ' + IntToStr(PickingId) + ' ' +
          'ORDER BY IdentificadorExpedicion, CajaId, PaletId, fecha ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
      '"IdentificadorExpedicion":' + Q.FieldByName('IdentificadorExpedicion').AsString + ', ' +
      '"PaletId":' + Q.FieldByName('PaletId').AsString + ', ' +
      '"CajaId":' + Q.FieldByName('CajaId').AsString + ', ' +
      '"Cantidad":' + SQL_FloatToStr(Q.FieldByName('Unidades').AsFloat) + ', ' +
      '"CantidadBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesBase').AsFloat) + ', ' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"CodigoAgrupacion":' + Q.FieldByName('CodigoAgrupacion').AsString + ', ' +
      '"UnidadesAgrupacion":' + SQL_FloatToStr(Q.FieldByName('UnidadesAgrupacion').AsFloat) + ', ' +
      '"FechaCaduca":"' + JSON_Str(Q.FieldByName('FechaCaduca').AsString) + '",' +
      '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
      '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ RETORNA EL LLISTAT DE MOVIMENTS D'UN ARTICLE                          │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1movimientosArticuloAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  CodigoArticulo: String;
  YY: WORD;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoAlmacen: String;
  sAndWhere: String;
  EmpresaOrigen: Integer;
  Partida: String;
  CodigoUbicacion: String;
  aUbicacion: TSGAUbicacion;
  TipoMovimiento: Integer;
  CodigoUsuario: Integer;
  Fecha: TDate;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoArticulo := (contentfields.values['CodigoArticulo']);

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );

  if CodigoArticulo<>'' then begin
    if SGA_ALMACEN_ArticuloCorrecto ( Conn, CodigoEmpresa, CodigoArticulo )<>CodigoArticulo then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo incorrecto","Data":[]}';

      Exit;
    end;
  end;

  CodigoAlmacen := (contentfields.values['CodigoAlmacen']);
  if CodigoAlmacen<>'' then begin
    if SGA_ALMACEN_AlmacenCorrecto ( Conn, CodigoEmpresa, CodigoAlmacen )<>CodigoAlmacen then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén incorrecto","Data":[]}';

      Exit;
    end;
  end;

  CodigoUbicacion := (contentfields.values['CodigoUbicacion']);

  // Conversió al codi d'article real
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  if CodigoUbicacion<>'' then begin
    aUbicacion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );
    if aUbicacion.CodigoUbicacion='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación incorrecto","Data":[]}';

      Exit;
    end;
  end;

  CodigoUsuario  := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  TipoMovimiento := StrToIntDef(contentfields.values['TipoMovimiento'], 0 );
  Partida        := (contentfields.values['Partida']);
  Fecha          := StrToDateDef(contentfields.Values['Fecha'], 0);
  YY             := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sAndWhere := '';

  if CodigoAlmacen<>'' then begin
    sAndWhere := sAndWhere + 'AND CodigoAlmacen=''' + SQL_Str(CodigoAlmacen) + ''' ';
  end;

  if CodigoUbicacion<>'' then begin
    sAndWhere := sAndWhere + 'AND CodigoUbicacion=''' + SQL_Str(CodigoUbicacion) + ''' ';
  end;

  if CodigoArticulo<>'' then begin
    sAndWhere := sAndWhere + 'AND CodigoArticulo=''' + SQL_Str(CodigoArticulo) + ''' ';
  end;

  if Partida<>'' then begin
    sAndWhere := sAndWhere + 'AND Partida=''' + SQL_Str(Partida) + ''' ';
  end;

  if CodigoUsuario<>0 then begin
    sAndWhere := sAndWhere + 'AND CodigoUsuario = ' + IntToStr(CodigoUsuario) + ' ';
  end;

  if TipoMovimiento<>0 then begin
    sAndWhere := sAndWhere + 'AND TipoMovimiento = ' + IntToStr(TipoMovimiento) + ' ';
  end;

  if Fecha<>0 then begin
    sAndWhere := sAndWhere + 'AND Fecha = ' + SQL_DateToStr ( Fecha ) + ' ';
  end;

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM dbo.FS_SGA_TABLE_Movimientos ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fsma ' +
          'WHERE ' +
          '  fsma.Periodo BETWEEN 1 AND 12 AND ' +
          '  fsma.Ejercicio = ' + IntToStr(YY) + ' ' +
          sAndWhere;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  *  ' +
          'FROM dbo.FS_SGA_TABLE_Movimientos ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fsma ' +
          'WHERE ' +
          '  fsma.Periodo BETWEEN 1 AND 12 AND ' +
          '  fsma.Ejercicio = ' + IntToStr(YY) + ' ' +
          sAndWhere +
          'ORDER BY ' +
          '  fsma.FechaHora DESC ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
      '"IdMovimiento":' + Q.FieldByName('IdMovimiento').AsString + ', ' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ', ' +
      '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
      '"CodigoZona":"' + JSON_Str(Q.FieldByName('CodigoZona').AsString) + '",' +
      '"CodigoUbicacion":"' + JSON_Str(Q.FieldByName('CodigoUbicacion').AsString) + '",' +
      '"CodigoUbicacionAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
      '"CodigoArticuloAlternativo":"' + JSON_Str(Q.FieldByName('CodigoArticuloAlternativo').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"Fecha":"' + JSON_Str(FormatDateTime('dd/mm/yyyy', Trunc(Q.FieldByName('FechaHora').AsDateTime) )) + '",' +
      '"FechaRegistro":"' + JSON_Str(FormatDateTime('dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaHora').AsDateTime )) + '",' +
      '"TipoMovimiento":' + Q.FieldByName('TipoMovimiento').AsString + ',' +
      '"OrigenMovimiento":"' + JSON_Str(Q.FieldByName('OrigenMovimiento').AsString) + '",' +
      '"Unidades":' + SQL_FloatToStr(Q.FieldByName('Unidades').AsFloat ) + ',' +
      '"CodigoUsuario":' + Q.FieldByName('CodigoUsuario').AsString + ',' +
      '"NombreUsuario":"' + JSON_Str(Q.FieldByName('NombreUsuario').AsString) + '",' +
      '"Comentario":"' + JSON_Str(Q.FieldByName('Comentario').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT D'UBICACIONS AMB STOCK PER PREPARAR UNA LÍNIA DE COMANDA      │
// │ JUNTAMENT AMB LES UBICACIONS BUIDES PERÒ QUE S'HAN FET SERVIR         │
// │ PER PREPARAR LA MATEIXA LÍNIA DE COMANDA                              │
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1preparacionCalcularIndiceAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  Indice: Integer;
  MostrarPartidas: Integer;
  sTable: string;
  CodigoAlmacen: String;
  CodigoArticulo: String;
  sUbicaciones: String;
  Partida: String;
  bError: Boolean;
  Pendientes: Integer;
  SoloConStock: Integer;
  CodigoUbicacion: String;
  CodigoUbicacionExpedicion: String;
  contentfields: TStringList;
  CodigoAlmacenDefecto: string;
  DefaultUbi: TDefaultUbicaciones;
  sFUNCCustom: string;
  bAlmacenPedido: Boolean;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoAlmacenDefecto := (contentfields.Values['CodigoAlmacenDefecto']);
  if CodigoAlmacenDefecto='' then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';

    Exit;
  end;

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  MostrarPartidas := 1; // StrToIntDef(contentfields.values['MostrarPartidas'],0);
  Pendientes      := StrToIntDef(contentfields.values['Pendientes'],0);
  SoloConStock    := StrToIntDef(contentfields.values['SoloConStock'],0);

  CodigoUbicacion := (contentfields.values['CodigoUbicacion']);
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  OrdenarPor    := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden     := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy      := '';
  CodigoAlmacen := (contentfields.Values['CodigoAlmacen']);

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_AlmacenPedido, bAlmacenPedido, CodigoEmpresa.EmpresaOrigen );

  // Temporal
  //if CodigoAlmacen='' then
  //  CodigoAlmacen := 'ALM1';

  if OrdenarPor='ARTICULO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'CodigoArticulo DESC, Partida DESC ';
    end else begin
      sOrderBy := 'CodigoArticulo, Partida ';
    end;
  end else if OrdenarPor='CODIGOUBICACION' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'CodigoUbicacion DESC ';
    end else begin
      sOrderBy := 'CodigoUbicacion ';
    end;
  end else if OrdenarPor='CODIGOUBICACIONALTERNATIVO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'CodigoUbicacionAlternativo DESC ';
    end else begin
      sOrderBy := 'CodigoUbicacionAlternativo ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'CodigoArticulo DESC, Partida DESC ';
    end else begin
      sOrderBy := 'CodigoArticulo DESC, Partida ';
    end;
  end;

  sOrderBy := 'rn';
  if TipoOrden='DESC' then
    sOrderBy := sOrderBy + ' DESC ';

  sSQL :=
      'SELECT AlmacenPreparacion ' +
      'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
      'WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  CodigoAlmacen := SQL_Execute ( Conn, sSQL );

  (*
  if (CodigoAlmacen='') or (CodigoAlmacen='0') then
  begin
    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacion, CodigoEmpresa.EmpresaOrigen );
    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacion );
  end;

  FS_SGA_ObtenerUbicacionesAlmacen ( Conn, CodigoEmpresa, CodigoAlmacen, DefaultUbi );
  CodigoUbicacionExpedicion := DefaultUbi.UbicacionExpediciones;

  //PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacionExpedicion, CodigoEmpresa.EmpresaOrigen );

  if CodigoAlmacen='' then begin
    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacionExpedicion );
  end;
  *)

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}
  if MostrarPartidas=0 then sTable := 'FS_SGA_TABLE_PreparacionDetallesPeriodo'
  else sTable := 'FS_SGA_TABLE_PreparacionDetallesPartidaPeriodo';

  sTable := 'FS_SGA_TABLE_PreparacionDetallesPeriodo';

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_GetIndicePreparacion', sFUNCCustom ) then
  begin

    sSQL := 'EXEC dbo.[' + sFUNCCustom + '] ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(IdPreparacion) + ', ' +
      '''' + SQL_Str(CodigoUbicacion) + ''', ' +
      SQL_BooleanToStr(Pendientes<>0) + ', ' +
      SQL_BooleanToStr(SoloConStock<>0);

  end else begin

    sSQL :=
      'SELECT TOP 1 rn ' +
      'FROM FS_SGA_PreparacionOrdenada WITH (NOLOCK) ' +
      'WHERE ' +
      '  PreparacionId = ' + IntToStr(IdPreparacion) + ' AND ' +
      '  ISNULL(CodigoUbicacion,''zzzzzzzzzz'') >= ''' + SQL_Str(CodigoUbicacion) + ''' ';

      if Pendientes=1 then
         sSQL := sSQL + 'AND UdNecesarias >= Udretiradas ';

      if SoloConStock=1 then
         sSQL := sSQL + 'AND CodigoUbicacion IS NOT NULL ';

      sSQL := sSQL + 'ORDER BY ' + sOrderBy;

  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"SQL":"' + JSON_Str(sSQL) + '","Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  if Q.EOF then Indice := 0
  else begin

    //if CodigoUbicacion=Q.FieldByName('CodigoUbicacion').AsString then
      Indice := Q.FieldByName('rn').AsInteger - 1
   // else
   //  Indice := Q.FieldByName('rn').AsInteger;

  end;

  Q.Close;
  FreeAndNil(Q);

  sParams := sParams +
    '&Indice=' + IntToStr(Indice) +
    '&SQL=' + sSQL;

  WebModule1detallePreparacionOrdenAction ( Conn, sParams, sRemoteAddr, statusCode, statusText, Result );

  {$ENDREGION}

end;


(*
procedure WebModule1preparacionCalcularIndiceActionOld(Sender: TObject;
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  Indice: Integer;
  MostrarPartidas: Integer;
  sTable: string;
  CodigoAlmacen: String;
  CodigoArticulo: String;
  sUbicaciones: String;
  Partida: String;
  bError: Boolean;
  Pendientes: Integer;
  SoloConStock: Integer;
  CodigoUbicacion: String;
  CodigoUbicacionExpedicion: String;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';

    Exit;
  end;

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  MostrarPartidas := 1; // StrToIntDef(contentfields.values['MostrarPartidas'],0);
  Pendientes      := StrToIntDef(contentfields.values['Pendientes'],0);
  SoloConStock    := StrToIntDef(contentfields.values['SoloConStock'],0);

  CodigoUbicacion := (contentfields.values['CodigoUbicacion']);
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  OrdenarPor    := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden     := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy      := '';
  CodigoAlmacen := (contentfields.Values['CodigoAlmacen']);

  // Temporal
  //if CodigoAlmacen='' then
  //  CodigoAlmacen := 'ALM1';

  if OrdenarPor='ARTICULO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'CodigoArticulo DESC, Partida DESC ';
    end else begin
      sOrderBy := 'CodigoArticulo, Partida ';
    end;
  end else if OrdenarPor='CODIGOUBICACION' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'CodigoUbicacion DESC ';
    end else begin
      sOrderBy := 'CodigoUbicacion ';
    end;
  end else if OrdenarPor='CODIGOUBICACIONALTERNATIVO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'CodigoUbicacionAlternativo DESC ';
    end else begin
      sOrderBy := 'CodigoUbicacionAlternativo ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'CodigoArticulo DESC, Partida DESC ';
    end else begin
      sOrderBy := 'CodigoArticulo DESC, Partida ';
    end;
  end;

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacionExpedicion, CodigoEmpresa.EmpresaOrigen );

  if CodigoAlmacen='' then begin
    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacionExpedicion );
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}
  if MostrarPartidas=0 then sTable := 'FS_SGA_TABLE_PreparacionDetallesPeriodo'
  else sTable := 'FS_SGA_TABLE_PreparacionDetallesPartidaPeriodo';

  sTable := 'FS_SGA_TABLE_PreparacionDetallesPeriodo';

  sSQL := 'SELECT TOP 1 * ' +
          'FROM ( ' +
          '  SELECT ' +
          '    ROW_NUMBER() OVER ( ORDER BY CASE WHEN CodigoUbicacion IN ( ''' + SQL_Str(CodigoUbicacionExpedicion) + ''' ) OR CodigoUbicacion IS NULL THEN ''zzz'' ELSE CodigoUbicacion END ) AS rn, * ' +
          '  FROM ' + sTable + ' ( ' + IntToStr(EmpresaOrigen) + ', ' + IntToStr(IdPreparacion) + ', ''' + SQL_Str(CodigoUbicacionExpedicion) + ''', ' + IntToStr(YY) + ', ''' + SQL_Str(CodigoAlmacen) + ''' ) ' +
          '  ) q ' +
          'WHERE '+
          '  CodigoUbicacion >= ''' + SQL_Str(CodigoUbicacion) + ''' ';

  if Pendientes=1 then
     sSQL := sSQL + 'AND UdNecesarias >= Udretiradas ';

  if SoloConStock=1 then
     sSQL := sSQL + 'AND CodigoUbicacion IS NOT NULL ';

  sSQL := sSQL + 'ORDER BY ' + sOrderBy;

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"SQL":"' + JSON_Str(sSQL) + '","Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  if Q.EOF then Indice := 0
  else begin

    //if CodigoUbicacion=Q.FieldByName('CodigoUbicacion').AsString then
      Indice := Q.FieldByName('rn').AsInteger - 1
   // else
   //  Indice := Q.FieldByName('rn').AsInteger;

  end;

  Q.Close;
  FreeAndNil(Q);

  Request.QueryFields.AddPair('Indice', IntToStr(Indice) );
  contentfields.AddPair('Indice', IntToStr(Indice) );

  Request.QueryFields.AddPair('SQL', sSQL );
  contentfields.AddPair('SQL', sSQL );

  WebModule1detallePreparacionOrdenAction ( Sender, Request, Response, Handled );
  Exit;

  {$ENDREGION}

end;
*)

procedure WebModule1preparacionUbicacionesAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoArticulo: string;
  CodigoUbicacion: string;
  sDesglose: string;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  PickingId: Integer;
  MostrarAlmacenes: Integer;
  MostrarPartidas: Integer;
  sMostrarAlmacenes: String;
  sMostrarPartidas: String;
  CodigoAlmacen: String;
  Partida: String;
  YY: WORD;
  sFechaUltimaEntrada: string;
  FechaUltimaEntrada: TDateTime;
  FechaCaduca: TDateTime;
  sFechaCaduca: string;
  TratamientoPartidas: Boolean;
  EmpresaOrigen: Integer;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';

    Exit;
  end;

  CodigoArticulo := (contentfields.values['CodigoArticulo']);

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );

  if CodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';

    Exit;
  end;

  TratamientoPartidas := ARTICULO_TratamientoPartida ( Conn, CodigoEmpresa, CodigoArticulo );

  Partida := (contentfields.values['Partida']);
  if (Partida='') and (TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de partida no especificado","Data":[]}';

    Exit;
  end;

  CodigoAlmacen := (contentfields.values['CodigoAlmacen']);
  if (CodigoAlmacen='') and (TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';

    Exit;
  end;

  if (Partida<>'') and (not TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no requiere partida","Data":[]}';

    Exit;
  end;

  YY               := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );
  MostrarAlmacenes := StrToIntDef(contentfields.values['MostrarAlmacenes'],0);
  MostrarPartidas  := StrToIntDef(contentfields.values['MostrarPartidas'],0);
  OrdenarPor       := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden        := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy         := '';

  if OrdenarPor='CANTIDAD' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'UnidadesSaldo DESC ';
    end else begin
      sOrderBy := 'UnidadesSaldo ';
    end;
  end else if OrdenarPor='UBICACION' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'CodigoUbicacion DESC ';
    end else begin
      sOrderBy := 'CodigoUbicacion ';
    end;
  end else if OrdenarPor='PARTIDA' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'Partida DESC ';
    end else begin
      sOrderBy := 'Partida ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'CodigoUbicacion DESC ';
    end else begin
      sOrderBy := 'CodigoUbicacion ';
    end;
  end;

  sMostrarAlmacenes := '';
  MostrarAlmacenes  := 0;
  if MostrarAlmacenes<>1 then begin
    sMostrarAlmacenes := 'AND CodigoAlmacen=''' + SQL_Str(CodigoAlmacen) + ''' ';
  end;

  sMostrarPartidas := '';
  if MostrarPartidas<>1 then begin
    sMostrarPartidas := 'AND Partida=''' + SQL_Str(Partida) + ''' ';
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals i dades'}

  sSQL := 'SELECT ' +
          '  CodigoAlmacen, Almacen, CodigoZona, NombreZona, CodigoUbicacion, CodigoPasillo, ' +
          '  DescripcionPasillo, CodigoEstanteria, Altura, Fondo, Picking, Bloqueada, Inactiva, ' +
          '  MultiRef, MultiLote, Rotacion, CodigoArticulo, Partida, ' +
          '  CodigoFamilia, CodigoSubfamilia, CodigoAlternativo, codigoUbicacionAlternativo, ' +
          '  CodigoAlternativo2, TratamientoPartidas, ' +
          '  SUM(UnidadesSaldo) AS UnidadesSaldo, SUM(UnidadesUsadas) AS UnidadesUsadas, ' +
          '  MIN(FechaPrimeraEntrada) AS FechaPrimeraEntrada, MIN(FechaUltimaEntrada) AS FechaUltimaEntrada, ' +
          '  MAX(FechaUltimaSalida) AS FechaUltimaSalida, MIN(FechaCaduca) AS FechaCaduca ' +
          'FROM FS_SGA_TABLE_UbicacionsPickingPedidos ( ' + IntToStr(CodigoEmpresa.Stocks) + ' ) ' +
          'WHERE ' +
          '  Ejercicio = ' + IntToStr ( YY ) + ' AND ' +
          '  CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          sMostrarAlmacenes +
          sMostrarPartidas +
          'GROUP BY ' +
          '  CodigoAlmacen, Almacen, CodigoZona, NombreZona, CodigoUbicacion, CodigoPasillo, ' +
          '  DescripcionPasillo, CodigoEstanteria, Altura, Fondo, Picking, Bloqueada, Inactiva, ' +
          '  MultiRef, MultiLote, Rotacion, CodigoArticulo, Partida, ' +
          '  CodigoFamilia, CodigoSubfamilia, CodigoAlternativo, codigoUbicacionAlternativo, ' +
          '  CodigoAlternativo2, TratamientoPartidas ';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
    iTotalRegs := Q.RecordCount;
  except
    on E:Exception do begin
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  sSQL := sSQL + 'ORDER BY ' +
                 sOrderBy +
                 'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
                 'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q.Close;
  Q.SQL.Text := sSQL;
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    FechaUltimaEntrada := Q.FieldByName('FechaUltimaEntrada').AsDateTime;
    if FechaUltimaEntrada=0 then
      FechaUltimaEntrada := Q.FieldByName('FechaPrimeraEntrada').AsDateTime;
    if FechaUltimaEntrada=0 then
      sFechaUltimaEntrada := ''
    else
      sFechaUltimaEntrada := FormatDateTime('dd/mm/yyyy',FechaUltimaEntrada);

    FechaCaduca := Q.FieldByName('FechaCaduca').AsDateTime;
    if FechaCaduca=0 then
      sFechaCaduca := ''
    else
      sFechaCaduca := FormatDateTime('dd/mm/yyyy',FechaCaduca);

    Result := Result + '{' +
                       '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
                       '"Almacen":"' + JSON_Str(Q.FieldByName('Almacen').AsString) + '",' +
                       '"CodigoZona":"' + JSON_Str(Q.FieldByName('CodigoZona').AsString) + '",' +
                       '"NombreZona":"' + JSON_Str(Q.FieldByName('NombreZona').AsString) + '",' +
                       '"CodigoUbicacion":"' + JSON_Str(Q.FieldByName('CodigoUbicacion').AsString) + '",' +
                       '"CodigoUbicacionAlternativo":"' + JSON_Str(Q.FieldByName('codigoUbicacionAlternativo').AsString) + '",' +
                       '"CodigoPasillo":"' + JSON_Str(Q.FieldByName('CodigoPasillo').AsString) + '",' +
                       '"DescripcionPasillo":"' + JSON_Str(Q.FieldByName('DescripcionPasillo').AsString) + '",' +
                       '"CodigoEstanteria":"' + JSON_Str(Q.FieldByName('CodigoEstanteria').AsString) + '",' +
                       '"Altura":"' + JSON_Str(Q.FieldByName('Altura').AsString) + '",' +
                       '"Fondo":"' + JSON_Str(Q.FieldByName('Fondo').AsString) + '",' +
                       '"Picking":' + SQL_BooleanToStr(Q.FieldByName('Picking').AsBoolean) + ',' +
                       '"Bloqueada":' + SQL_BooleanToStr(Q.FieldByName('Bloqueada').AsBoolean) + ',' +
                       '"Inactiva":' + SQL_BooleanToStr(Q.FieldByName('Inactiva').AsBoolean) + ',' +
                       '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
                       '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
                       '"UnidadesSaldo":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldo').AsFloat) + ',' +
                       '"FechaUltimaEntrada":"' + sFechaUltimaEntrada + '",' +
                       '"FechaCaduca":"' + sFechaCaduca + '",' +
                       '"CodigoFamilia":"' + JSON_Str(Q.FieldByName('CodigoFamilia').AsString) + '",' +
                       '"CodigoSubfamilia":"' + JSON_Str(Q.FieldByName('CodigoSubfamilia').AsString) + '",' +
                       '"CodigoArticuloAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
                       '"TratamientoPartidas":' + IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) + ',' +
                       '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
                       '"UnidadesUsadas":' + SQL_FloatToStr(Q.FieldByName('UnidadesUsadas').AsFloat) +
                       '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


procedure WebModule1checkNumeroSeriePreparacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  PreparacionId: Integer;
  PickingId: Integer;
  AutoId: Integer;
  NumeroSerie: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  PreparacionId := StrToIntDef(contentfields.values['PreparacionId'],0);
  if PreparacionId=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de preparación no es correcto","Data":[]}';
    Exit;
  end;

  PickingId := StrToIntDef(contentfields.values['PickingId'],0);
  AutoId    := StrToIntDef(contentfields.values['AutoId'],0);

  NumeroSerie := contentfields.values['NumeroSerie'];
  if NumeroSerie='' then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El número de serie está en blanco","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT COUNT(*) ' +
    'FROM FS_SGA_Picking_Pedido_Lineas_Detalle_NumerosSerie WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND PreparacionId = ' + IntToStr(PreparacionId) + ' ' +
    '  AND PickingId = ' + IntToStr(PickingId) + ' ' +
    '  AND AutoId <> ' + IntToStr(AutoId) + ' ' +
    '  AND NumeroSerie = ''' + SQL_Str(NumeroSerie) + ''' ';
  Result := SQL_Execute ( Conn, sSQL );

  {$ENDREGION}

end;


procedure WebModule1checkNumeroSerieRecepcionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  RecepcionId: Integer;
  RecepcionIdLinea: Integer;
  RecepcionIdLineaDetalle: Integer;
  NumeroSerie: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  RecepcionId := StrToIntDef(contentfields.values['RecepcionId'],0);
  if RecepcionId=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de recepción no es correcto","Data":[]}';
    Exit;
  end;

  RecepcionIdLinea := StrToIntDef(contentfields.values['RecepcionIdLinea'],0);
  if RecepcionIdLinea=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de línea de recepción no es correcto","Data":[]}';
    Exit;
  end;

  RecepcionIdLineaDetalle := StrToIntDef(contentfields.values['RecepcionIdLineaDetalle'],0);

  NumeroSerie := contentfields.values['NumeroSerie'];
  if NumeroSerie='' then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El número de serie está en blanco","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT COUNT(*) ' +
    'FROM FS_SGA_Recepciones_Lineas_Detalle_NumerosSerie WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND RecepcionId = ' + IntToStr(RecepcionId) + ' ' +
    '  AND RecepcionIdLinea = ' + IntToStr(RecepcionIdLinea) + ' ' +
    '  AND RecepcionIdLineaDetalle <> ' + IntToStr(RecepcionIdLineaDetalle) + ' ' +
    '  AND NumeroSerie = ''' + SQL_Str(NumeroSerie) + ''' ';
  Result := SQL_Execute ( Conn, sSQL );

  {$ENDREGION}

end;


procedure WebModule1getLastCajaIdAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdPreparacion: Integer;
  IdExpedicion: Integer;
  PaletId: Integer;
  CajaId: Integer;
  CajaActual: Integer;
  Matricula: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de preparación no es correcto","Data":[]}';
    Exit;
  end;

  IdExpedicion := StrToIntDef(contentfields.values['IdExpedicion'],0);
  if IdExpedicion=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El identificador de expedición de la preparación no es correcto","Data":[]}';
    Exit;
  end;

  PaletId   := StrToIntDef(contentfields.values['PaletActual'],0);
  Matricula := contentfields.values['MatriculaActual'];

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  if Matricula<>'' then
  begin
    sSQL :=
      'SELECT ' +
      '  MAX(cajaId) ' +
      'FROM FS_SGA_PACKINGLIST WITH (NOLOCK) ' +
      'WHERE ' +
      '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND IdentificadorExpedicion = ' + IntToStr(IdExpedicion) + ' ' +
      '  AND Matricula = ''' + SQL_Str(Matricula) + ''' ';
    CajaId := SQL_Execute ( Conn, sSQL );
  end else begin
    sSQL :=
      'SELECT ' +
      '  MAX(cajaId) ' +
      'FROM FS_SGA_PACKINGLIST WITH (NOLOCK) ' +
      'WHERE ' +
      '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND IdentificadorExpedicion = ' + IntToStr(IdExpedicion) + ' ' +
      '  AND PaletId = ' + IntToStr(PaletId);
    CajaId := SQL_Execute ( Conn, sSQL );
  end;

  sSQL :=
    'SELECT ' +
    '  CajaActual ' +
    'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion);
  CajaActual := SQL_Execute ( Conn, sSQL );

  if CajaActual<0 then
  begin
    CajaId := -CajaId;
    if CajaId=0 then CajaId := -1;
  end else begin
    CajaId := CajaId + 1;
    if CajaId=0 then CajaId := 1;
  end;

  Result := '{"Result":"OK","Error":"","Data":[';

  Result := Result +
    '{' +
    '"CajaId":' + IntToStr(CajaId) +
    '}';

  Result := Result + ']}';

  {$ENDREGION}


end;


procedure WebModule1recibirLineaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  RecepcionId: Integer;
  IdLinea: Integer;
  UdSaldo: Double;
  UdSaldoBase: Double;
  UdRecibidas: Double;
  UdRecibidasBase: Double;
  CodigoAlmacen: String;
  DefaultUbi: TDefaultUbicaciones;
  UUID: string;
  Ejercicio: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];
  
  RecepcionId := StrToIntDef(contentfields.values['RecepcionId'],0);
  if RecepcionId=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de preparación no es correcto","Data":[]}';
    Exit;
  end;

  sSQL := 'SELECT Ejercicio FROM FS_SGA_Recepciones WITH (NOLOCK) WHERE RecepcionId = ' + IntToStr(RecepcionId);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  IdLinea := StrToIntDef(contentfields.values['Linea'],0);
  if IdLinea=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El número de línea no es correcto","Data":[]}';
    Exit;
  end;

  CodigoAlmacen := contentfields.values['CodigoAlmacen'];
  if (Trim(CodigoAlmacen)='') then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de almacén es incorrecto","Data":[]}';
    Exit;
  end;

  FS_SGA_ObtenerUbicacionesAlmacen ( Conn, CodigoEmpresa, CodigoAlmacen, DefaultUbi );
  if DefaultUbi.UbicacionRecepciones='' then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El almacén no tiene definida una ubicación de recepción por defecto","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Actualitzem dades'}

  sSQL :=
    'SELECT ' +
    '  UdSaldo, UdSaldoBase, UdRecibidas, UdRecibidasBase ' +
    'FROM FS_SGA_Recepciones_Lineas WITH (NOLOCK) ' +
    'WHERE ' +
    '  RecepcionId = ' + IntToStr(RecepcionId) + ' ' +
    '  AND RecepcionIdLinea = ' + IntToStr(IdLinea);
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then
  begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No quedan cantidades para expedir","Data":[]}';
    Exit;
  end;

  UdSaldo := Q.FieldByName('UdSaldo').AsFloat;
  if UdSaldo<0 then UdSaldo := 0;
  UdSaldoBase := Q.FieldByName('UdSaldoBase').AsFloat;
  if UdSaldoBase<0 then UdSaldoBase := 0;
  UdRecibidas := Q.FieldByName('UdRecibidas').AsFloat;
  UdRecibidasBase := Q.FieldByName('UdRecibidasBase').AsFloat;

  Q.Close;
  FreeAndNil(Q);

  sSQL :=
    'INSERT INTO FS_SGA_Recepciones_Lineas_Detalle ( RecepcionId, RecepcionIdLinea, Ejercicio, CodigoAlmacen, CodigoUbicacion, ' +
    '  CodigoAlmacenRechazos, CodigoUbicacionRechazos, Caja, Palet, Partida, FechaCaducidad, Verificacion, AnomaliaId, ' +
    '  Precio, UnidadMedida1_, UnidadesEntrada, Unidades, CantidadErrorEntrada, CantidadError, TotalEntrada, ' +
    '  TotalEntradaBase, Total, FechaRegistro, UnidadMedidaBase, UnidadesEntradaBase, UnidadesErrorBase, ' +
    '  CodigoAgrupacion, UnidadesAgrupacion, CodigoAgrupacionRechazos, UnidadesAgrupacionRechazos, FactorConversion, ' +
    '  FactorConversionRechazos, UnidadMedidaRechazo, UnidadMedidaRechazoBase, CodigoColor_, CodigoTalla01_, GrupoTalla_ ) ' +
    'SELECT ' +
    IntToStr(RecepcionId) + ', ' +
    IntToStr(IdLinea) + ', ' +
    IntToStr(Ejercicio) + ', ' +
    '''' + SQL_Str(CodigoAlmacen) + ''', ' +
    '''' + SQL_Str(DefaultUbi.UbicacionRecepciones) + ''', ' +
    '''' + SQL_Str(CodigoAlmacen) + ''', ' +
    '''' + SQL_Str(DefaultUbi.UbicacionRecepcionesRechazos) + ''', ' +
    '0, ' +
    '0, ';

  Result := '{"Result":"OK","Error":"","Data":[';

  Result := Result +
    '{' +
    '"UdRecibidas":' + SQL_FloatToStr(UdRecibidas+UdSaldo) + ',' +
    '"UdRecibidasBase":' + SQL_FloatToStr(UdRecibidasBase+UdSaldoBase) +
    '}';

  Result := Result + ']}';

  LP := LOG_Clear();
  LP.IdRecepcion := RecepcionId;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'RECEIVE-ORD-LIN', 'Recibir línea de pedido en ' + DefaultUbi.UbicacionRecepciones, @LP );

  {$ENDREGION}

end;


procedure WebModule1renumerarCajasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdPreparacion: Integer;
  IdExpedicion: Integer;
  CajaId: Integer;
  PaletId: Integer;
  sPROC: String;
  proc: TADOStoredProc;
  Matricula: String;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de preparación no es correcto","Data":[]}';
    Exit;
  end;

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  IdExpedicion := StrToIntDef(contentfields.values['IdExpedicion'],0);
  Matricula    := contentfields.values['Matricula'];

  {$ENDREGION}

  {$REGION 'Actualitzem dades'}

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_RenumerarCajas', sPROC ) then
  begin

    proc := TADOStoredProc.Create(nil);
    proc.Connection := Conn;
    proc.ProcedureName := 'dbo.[' + sPROC + ']';
    proc.Parameters.Refresh;

    proc.Parameters.ParamByName('@CodigoEmpresa').Value  := CodigoEmpresa.EmpresaOrigen;
    proc.Parameters.ParamByName('@IdPreparacion').Value  := IdPreparacion;
    proc.Parameters.ParamByName('@IdExpedicion').Value   := IdExpedicion;
    proc.Parameters.ParamByName('@NuevoPaletID').Value   := 0;
    proc.Parameters.ParamByName('@NuevaCajaID').Value    := 0;

    proc.Prepared := TRUE;
    proc.ExecProc;

    PaletId   := proc.Parameters.ParamValues['@NuevoPaletID'];
    CajaId    := proc.Parameters.ParamValues['@NuevaCajaID'];

    FreeAndNil(proc);

    if PaletId<=0 then PaletId := 1;
    if CajaId<=0 then CajaId := 1;

  end else begin

    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No existe el procedure para FS_SGA_RenumerarCajas.","Data":[]}';
    Exit;

  end;

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'RENUMBER-BOXES', 'Renumerar cajas de la preparación', @LP );

  Result := '{"Result":"OK","Error":"","Data":[';

  Result := Result +
    '{' +
    '"PaletId":' + IntToStr(PaletId) + ',' +
    '"CajaId":' + IntToStr(CajaId) +
    '}';

  Result := Result + ']}';

  {$ENDREGION}

end;


procedure fOnTimer ( Sender: TObject );
begin

  TTimer(Sender).Enabled := FALSE;
  //FTerminated := TRUE;

end;


procedure WebModule1imprimirMatriculaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  Matricula: String;
  Impresora: string;
  Template: String;
  MACAddress: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  MACAddress    := contentfields.Values['UUID'];
  Matricula     := (contentfields.Values['Matricula']);
  Impresora     := contentfields.Values['Impresora'];
  Impresora     := TNetEncoding.URL.Decode(Impresora);
  Template      := contentfields.Values['Template'];

  if Printer.Printers.IndexOf(Impresora)<0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La impresora especificada no está disponible","Data":[]}';
    Exit;
  end;

  sSQL :=
    'SELECT TOP 1 parametro_value FROM FS_SGA_Parametros WITH (NOLOCK) ' +
    'WHERE parametro_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
    '  AND parametro_id = 151 ' +
    'ORDER BY parametro_CodigoEmpresa DESC';
  gsPathRepositorio := Trim(SQL_Execute ( Conn, sSQL ));
  if gsPathRepositorio='' then
    gsPathRepositorio := gsPath + '\labels';
  gsPathRepositorio := ExcludeTrailingBackslash(gsPathRepositorio);

  {$ENDREGION}

  {$REGION 'Fem la impressió'}

  if not FileExists(gsPathRepositorio + '\matriculas\' + Template) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' +
      JSON_Str('No existe el archivo de plantilla ' + Template + ' para imprimir la etiqueta de palet') + '","Data":[]}';
    Exit;
  end;

  FS_MainWebServiceSGA.ppReport1.Template.FileName := gsPathRepositorio + '\matriculas\' + Template;

  sSQL :=
    'SELECT TOP 1 * ' +
    'FROM FS_SGA_Palet WITH (NOLOCK) ' +
    'WHERE CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    'AND Matricula = ''' + SQL_Str(Matricula) + '''';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' +
        JSON_Str('No se han encontrado los datos del palet para imprimir') + '","Data":[]}';
    Q.Close;
    FreeAndNil(Q);
    Exit;
  end;

  try
    FS_MainWebServiceSGA.ppReport1.Template.LoadFromFile;
  except
    on E:Exception do
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' +
        JSON_Str('Error en el archivo de plantilla ' + gsPathRepositorio + '\' + Template + ': ' + E.Message) + '","Data":[]}';
      Q.Close;
      FreeAndNil(Q);
      Exit;
    end;
  end;

  FS_MainWebServiceSGA.tmrTimeout.Enabled := FALSE;
  FS_MainWebServiceSGA.tmrTimeout.Interval := 3000;

  FS_MainWebServiceSGA.DataSource1.DataSet := Q;
  FS_MainWebServiceSGA.ppReport1.PrinterSetup.PrinterName := Impresora;
  FS_MainWebServiceSGA.ppReport1.DeviceType := 'Printer';
  FS_MainWebServiceSGA.ppReport1.PrinterSetup.Copies := 1;
  FS_MainWebServiceSGA.ppReport1.ShowPrintDialog := FALSE;
  FS_MainWebServiceSGA.ppReport1.ShowCancelDialog := FALSE;
  FS_MainWebServiceSGA.ppReport1.ShowAutoSearchDialog := FALSE;

  FS_MainWebServiceSGA.ppReport1.Parameters['Matricula'].AsString  := Matricula;

  Q.Close;
  FreeAndNil(Q);

  FS_MainWebServiceSGA.tmrTimeout.Enabled := TRUE;
  FS_MainWebServiceSGA.ppReport1.Print;
  FS_MainWebServiceSGA.tmrTimeout.Enabled := FALSE;

  FS_SGA_Audita ( 
    Conn, 
    CodigoEmpresa.EmpresaOrigen, 
    CodigoUsuario, 
    MACAddress, 
    Now(), 
    'Almacén', 
    'Impresión matrícula palet (' + Matricula + ')' 
  );

  LP := LOG_Clear();
  LP.Matricula := Matricula;

  LOG_Add ( Conn, CodigoUsuario, MACAddress, sRemoteAddr, 'PRINT-PALLET-LAB', 'Imprimir etiqueta de matrícula de palet', @LP );

  Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1printCajaExpedicionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  i: Integer;
  IdPreparacion: Integer;
  IdExpedicion: Integer;
  NumCaja: Integer;
  Impresora: string;
  Template: String;
  MACAddress: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  MACAddress    := contentfields.Values['UUID'];
  IdPreparacion := StrToIntDef(contentfields.Values['IdPreparacion'], 0 );
  IdExpedicion  := StrToIntDef(contentfields.Values['IdExpedicion'], 0 );
  NumCaja       := StrToIntDef(contentfields.Values['NumCaja'], 0 );
  Impresora     := contentfields.Values['Impresora'];
  Impresora     := TNetEncoding.URL.Decode(Impresora);
  Template      := contentfields.Values['Template'];

  sSQL :=
    'SELECT TOP 1 parametro_value FROM FS_SGA_Parametros WITH (NOLOCK) ' +
    'WHERE parametro_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
    '  AND parametro_id = 151 ' +
    'ORDER BY parametro_CodigoEmpresa DESC';
  gsPathRepositorio := Trim(SQL_Execute ( Conn, sSQL ));
  if gsPathRepositorio='' then
    gsPathRepositorio := gsPath + '\labels';
  gsPathRepositorio := ExcludeTrailingBackslash(gsPathRepositorio);

  if Printer.Printers.IndexOf(Impresora)<0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La impresora especificada no está disponible","Data":[]}';
    Exit;
  end;

  if NumCaja=0 then
  begin

    sSQL :=
      'SELECT ' +
      '  MAX(CajaId) ' +
      'FROM FS_SGA_PACKINGLIST WITH (NOLOCK) ' +
      'WHERE ' +
      '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND IdentificadorExpedicion = ' + IntToStr(IdExpedicion);
    NumCaja := SQL_Execute ( Conn, sSQL) + 1;

  end;

  {$ENDREGION}

  {$REGION 'Fem la impressió'}

  if not FileExists(gsPathRepositorio + '\cubeta\' + Template) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' +
      JSON_Str('No existe el archivo de plantilla ' + Template + ' para imprimir las cajas de expedición') + '","Data":[]}';
    Exit;
  end;

  FS_MainWebServiceSGA.ppReport1.Template.FileName := gsPathRepositorio + '\cubeta\' + Template;

  sSQL :=
    'SELECT DISTINCT TOP 1 ' +
    '  fsppl.PreparacionId, fsppl.EjercicioPedido, fsppl.Codigoempresa, fsppl.SeriePedido, fsppl.NumeroPedido, ' +
    '  fsppl.CodigoCliente, c.RazonSocial, c.Domicilio, c.Domicilio2, ' +
    '  c.DomicilioEnvio, c.CodigoSigla, c.ViaPublica, c.Numero1, ' +
    '  c.Numero2, c.Escalera, c.Piso, c.Puerta, c.Letra, c.CodigoPostal, ' +
    '  c.CodigoMunicipio, c.Municipio, c.ColaMunicipio, c.CodigoProvincia, ' +
    '  c.Provincia, c.CodigoNacion, c.Nacion, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.RazonSocial ELSE d.RazonSocial END AS RazonSocialE, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.RazonSocial2 ELSE d.RazonSocial2 END AS RazonSocial2E, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.Domicilio ELSE d.Domicilio END AS DomicilioE, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.Domicilio2 ELSE d.Domicilio2 END AS Domicilio2E, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.CodigoSigla ELSE d.CodigoSigla END AS CodigoSiglaE, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.ViaPublica ELSE d.ViaPublica END AS ViaPublicaE, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.Numero1 ELSE d.Numero1 END AS Numero1E, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.Numero2 ELSE d.Numero2 END AS Numero2E, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.Escalera ELSE d.Escalera END AS EscaleraE, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.Piso ELSE d.Piso END AS PisoE, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.Puerta ELSE d.Puerta END AS PuertaE, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.Letra ELSE d.Letra END AS LetraE, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.CodigoPostal ELSE d.CodigoPostal END AS CodigoPostalE, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.CodigoMunicipio ELSE d.CodigoMunicipio END AS CodigoMunicipioE, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.Municipio ELSE d.Municipio END AS MunicipioE, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.ColaMunicipio ELSE d.ColaMunicipio END AS ColaMunicipioE, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.CodigoProvincia ELSE d.CodigoProvincia END AS CodigoProvinciaE, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.Provincia ELSE d.Provincia END AS ProvinciaE, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.CodigoNacion ELSE d.CodigoNacion END AS CodigoNacionE, ' +
    '  CASE WHEN d.RazonSocial IS NULL THEN c.Nacion ELSE d.Nacion END AS NacionE, ' +
    '  fsppl.IdentificadorExpedicion, ' + intToStr( NumCaja ) + ' as CajaId '+
    'FROM ' +
    '  FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
    'INNER JOIN ' +
    '  CabeceraPedidoCliente cpc WITH (NOLOCK) ' +
    'ON ' +
    '  cpc.CodigoEmpresa = fsppl.CodigoEmpresa AND ' +
    '  cpc.EjercicioPedido = fsppl.EjercicioPedido AND ' +
    '  cpc.SeriePedido = fsppl.SeriePedido AND ' +
    '  cpc.NumeroPedido = fsppl.NumeroPedido ' +
    'LEFT JOIN ' +
    '  FS_SGA_TABLE_Domicilios ( ' + intToStr( CodigoEmpresa.Domicilios ) + ' ) d ' +
    'ON ' +
    '  d.CodigoCliente = cpc.CodigoCliente AND ' +
    '  d.NumeroDomicilio = cpc.DomicilioEnvio AND ' +
    '  d.TipoDomicilio = ''E'' ' +
    'INNER JOIN ' +
    '  FS_SGA_TABLE_Clientes ( ' + intToStr( CodigoEmpresa.Clientes ) + ' ) c ' +
    'ON ' +
    '  c.CodigoCliente = fsppl.CodigoCliente ' +
    'WHERE ' +
    '  fsppl.PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND fsppl.IdentificadorExpedicion = ' + IntToStr(IdExpedicion) + ' ';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' +
        JSON_Str('No se han encontrado los datos del cliente para imprimir') + '","Data":[]}';
    Q.Close;
    FreeAndNil(Q);
    Exit;
  end;

  try
    FS_MainWebServiceSGA.ppReport1.Template.LoadFromFile;
  except
    on E:Exception do
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' +
        JSON_Str('Error en el archivo de plantilla ' + gsPathRepositorio + '\cubeta\' + Template + ': ' + E.Message) + '","Data":[]}';
      Q.Close;
      FreeAndNil(Q);
      Exit;
    end;
  end;

  FS_MainWebServiceSGA.tmrTimeout.Enabled := FALSE;
  FS_MainWebServiceSGA.tmrTimeout.Interval := 3000;

  FS_MainWebServiceSGA.ppReport1.PrinterSetup.PrinterName := Impresora;
  FS_MainWebServiceSGA.ppReport1.DeviceType := 'Printer';
  FS_MainWebServiceSGA.ppReport1.PrinterSetup.Copies := 1;
  FS_MainWebServiceSGA.ppReport1.ShowPrintDialog := FALSE;
  FS_MainWebServiceSGA.ppReport1.ShowCancelDialog := FALSE;
  FS_MainWebServiceSGA.ppReport1.ShowAutoSearchDialog := FALSE;

  FS_MainWebServiceSGA.ppReport1.Parameters['IdPreparacion'].AsInteger    := IdPreparacion;
  FS_MainWebServiceSGA.ppReport1.Parameters['IdExpedicion'].AsInteger     := IdExpedicion;
  FS_MainWebServiceSGA.ppReport1.Parameters['NumCaja'].AsInteger          := NumCaja;
  FS_MainWebServiceSGA.ppReport1.Parameters['CodigoEmpresa'].AsInteger    := Q.FieldByName('CodigoEmpresa').AsInteger;
  FS_MainWebServiceSGA.ppReport1.Parameters['EjercicioPedido'].AsInteger  := Q.FieldByName('EjercicioPedido').AsInteger;
  FS_MainWebServiceSGA.ppReport1.Parameters['SeriePedido'].AsString       := Q.FieldByName('SeriePedido').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['NumeroPedido'].AsInteger     := Q.FieldByName('NumeroPedido').AsInteger;
  FS_MainWebServiceSGA.ppReport1.Parameters['CodigoCliente'].AsString     := Q.FieldByName('CodigoCliente').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['RazonSocial'].AsString       := Q.FieldByName('RazonSocial').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['Domicilio'].AsString         := Q.FieldByName('Domicilio').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['Domicilio2'].AsString        := Q.FieldByName('Domicilio2').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['CodigoSigla'].AsString       := Q.FieldByName('CodigoSigla').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['ViaPublica'].AsString        := Q.FieldByName('ViaPublica').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['Numero1'].AsString           := Q.FieldByName('Numero1').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['Numero2'].AsString           := Q.FieldByName('Numero2').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['Escalera'].AsString          := Q.FieldByName('Escalera').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['Piso'].AsString              := Q.FieldByName('Piso').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['Puerta'].AsString            := Q.FieldByName('Puerta').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['Letra'].AsString             := Q.FieldByName('Letra').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['CodigoPostal'].AsString      := Q.FieldByName('CodigoPostal').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['CodigoMunicipio'].AsString   := Q.FieldByName('CodigoMunicipio').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['Municipio'].AsString         := Q.FieldByName('Municipio').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['ColaMunicipio'].AsString     := Q.FieldByName('ColaMunicipio').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['CodigoProvincia'].AsString   := Q.FieldByName('CodigoProvincia').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['Provincia'].AsString         := Q.FieldByName('Provincia').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['CodigoNacion'].AsString      := Q.FieldByName('CodigoNacion').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['Nacion'].AsString            := Q.FieldByName('Nacion').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['RazonSocialE'].AsString      := Q.FieldByName('RazonSocialE').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['RazonSocial2E'].AsString     := Q.FieldByName('RazonSocial2E').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['DomicilioE'].AsString        := Q.FieldByName('DomicilioE').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['CodigoSiglaE'].AsString      := Q.FieldByName('CodigoSiglaE').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['ViaPublicaE'].AsString       := Q.FieldByName('ViaPublicaE').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['Numero1E'].AsString          := Q.FieldByName('Numero1E').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['Numero2E'].AsString          := Q.FieldByName('Numero2E').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['EscaleraE'].AsString         := Q.FieldByName('EscaleraE').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['PisoE'].AsString             := Q.FieldByName('PisoE').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['PuertaE'].AsString           := Q.FieldByName('PuertaE').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['LetraE'].AsString            := Q.FieldByName('LetraE').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['CodigoPostalE'].AsString     := Q.FieldByName('CodigoPostalE').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['CodigoMunicipioE'].AsString  := Q.FieldByName('CodigoMunicipioE').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['MunicipioE'].AsString        := Q.FieldByName('MunicipioE').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['ColaMunicipioE'].AsString    := Q.FieldByName('ColaMunicipioE').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['CodigoProvinciaE'].AsString  := Q.FieldByName('CodigoProvinciaE').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['ProvinciaE'].AsString        := Q.FieldByName('ProvinciaE').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['CodigoNacionE'].AsString     := Q.FieldByName('CodigoNacionE').AsString;
  FS_MainWebServiceSGA.ppReport1.Parameters['NacionE'].AsString           := Q.FieldByName('NacionE').AsString;

  Q.Close;
  FreeAndNil(Q);

  FS_MainWebServiceSGA.tmrTimeout.Enabled := TRUE;
  FS_MainWebServiceSGA.ppReport1.Print;
  FS_MainWebServiceSGA.tmrTimeout.Enabled := FALSE;

  FS_SGA_Audita ( 
    Conn, 
    CodigoEmpresa.EmpresaOrigen, 
    CodigoUsuario, 
    MACAddress, 
    Now(), 
    'Expedición', 
    'Impresión etiqueta cubeta (' + IntToStr(IdPreparacion) + '.' + IntToStr(IdExpedicion) + '.' + IntToStr(NumCaja) + ')' 
  );

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;
  LOG_Add ( Conn, CodigoUsuario, MACAddress, sRemoteAddr, 'PRINT-EXP-LAB', 'Imprimir etiqueta expedición', @LP );

  Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1listTemplatesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  Template: String;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  i: Integer;
  ip: Integer;
  sName: String;
  sTemplate: string;
  SR: TSearchRec;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  Template := AnsiUpperCase(trim(contentfields.Values['Template']));

  sSQL :=
    'SELECT TOP 1 parametro_value FROM FS_SGA_Parametros WITH (NOLOCK) ' +
    'WHERE parametro_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
    '  AND parametro_id = 151 ' +
    'ORDER BY parametro_CodigoEmpresa DESC';
  gsPathRepositorio := Trim(SQL_Execute ( Conn, sSQL ));
  if gsPathRepositorio='' then
    gsPathRepositorio := gsPath + '\labels';
  gsPathRepositorio := ExcludeTrailingBackslash(gsPathRepositorio);

  {$ENDREGION}

  {$REGION 'Retornem les dades'}

  Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[';

  sTemplate := '';
  if FindFirst ( gsPathRepositorio + '\' + Template + '\*.*', faArchive, SR) = 0 then
  begin

    repeat
      if sTemplate<>'' then
        sTemplate := sTemplate + ',';
      sTemplate := sTemplate + '"' + JSON_Str(SR.Name) + '"';
    until FindNext(SR) <> 0;

  end;

  Result := Result + '{' +
    '"Templates":[' + sTemplate + ']' +
  '}';

  Result := Result + ']}';
  {$ENDREGION}

end;


procedure WebModule1impresorasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  i: Integer;
  ip: Integer;
  sName: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  {$ENDREGION}

  {$REGION 'Retornem les dades'}

  Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[';

  Printer.Refresh;
  ip := 1;

  Result := Result + '"<<Impresora por defecto>>"';

  for i := 0 to Printer.Printers.Count-1 do
  begin

    sName := Printer.Printers[i];
    if (Pos('redireccionado)', sName)=0) and (Pos('redirected)', sName)=0) then
    begin
      if ip>0 then
        Result := Result + ',';
      Result := Result + '"' + JSON_Str(sName) + '"';
      ip := ip + 1;
    end;

  end;

  Result := Result + ']}';
  {$ENDREGION}


end;

procedure WebModule1closeInventarioAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdInventario: Integer;
  CodigoUbicacion: String;
  bFound: Boolean;
  OldId: Integer;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];
  
  IdInventario := StrToIntDef(contentfields.values['IdInventario'],0);
  if IdInventario=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de inventario no es correcto","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Actualitzem l'inventari'}

  sSQL :=
    'UPDATE FS_SGA_Inventario ' +
    'SET ' +
    '  Inventario_Finalizado = 1, ' +
    '  Inventario_FechaFin = GETDATE() ' +
    'WHERE ' +
    '  Inventario_Id = ' + IntToStr(IdInventario);
  try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do
    begin
      gaLogFile.Write_DBException(E,sSQL,'Error al cerrar inventario', CONST_LOGID_BBDD );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(E.Message) + '","Data":[]}';
      Exit;
    end;
  end;

  LP := LOG_Clear();
  LP.IdInventario := IdInventario;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'CLOSE-INV', 'Cerrar inventario', @LP );
  
  Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1validateInventarioDetailAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdInventario: Integer;
  CodigoUbicacion: String;
  bFound: Boolean;
  OldId: Integer;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];

  IdInventario := StrToIntDef(contentfields.values['IdInventario'],0);
  if IdInventario=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de inventario no es correcto","Data":[]}';
    Exit;
  end;

  OldId := StrToIntDef(contentfields.Values['InventarioUbicacionId'],0);

  {$ENDREGION}

  {$REGION 'Actualitzem les ubicacions'}

  sSQL :=
    'UPDATE FS_SGA_Inventario_Detalle ' +
    'SET ' +
    '  Verificada = 1, ' +
    '  FechaHoraValidacion = GETDATE(), ' +
    '  UsuarioId = ' + IntToStr(CodigoUsuario) + ' ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND Inventario_Id = ' + IntToStr(IdInventario) + ' ' +
    '  AND Inventario_UbicacionId = ' + IntToStr(OldId);

  try
    SQL_Execute_NoRes(Conn,sSQL);
  except
    on E:Exception do
    begin
      gaLogFile.Write_DBException(E,sSQL,'Error al borrar línea del inventario', CONST_LOGID_BBDD );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '","Data":[]}';
      Exit;
    end;
  end;

  LP := LOG_Clear();
  LP.IdInventario := IdInventario;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'VALIDATE-INV', 'Validar inventario', @LP );

  Result := '{"Result":"OK","Error":"","Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1deleteInventarioDetailAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdInventario: Integer;
  CodigoUbicacion: String;
  bFound: Boolean;
  OldId: Integer;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];
  
  IdInventario := StrToIntDef(contentfields.values['IdInventario'],0);
  if IdInventario=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de inventario no es correcto","Data":[]}';
    Exit;
  end;

  OldId := StrToIntDef(contentfields.Values['InventarioUbicacionId'],0);

  {$ENDREGION}

  {$REGION 'Actualitzem les ubicacions'}

  sSQL :=
    'DELETE FROM FS_SGA_Inventario_Detalle ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND Inventario_Id = ' + IntToStr(IdInventario) + ' ' +
    '  AND Inventario_UbicacionId = ' + IntToStr(OldId);

  try
    SQL_Execute_NoRes(Conn,sSQL);
  except
    on E:Exception do
    begin
      gaLogFile.Write_DBException(E,sSQL,'Error al borrar línea del inventario', CONST_LOGID_BBDD );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '","Data":[]}';
      Exit;
    end;
  end;

  LP := LOG_Clear();
  LP.IdInventario := IdInventario;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'DELETE-INV', 'Borrar inventario de la ubicación ' + CodigoUbicacion, @LP );
  
  Result := '{"Result":"OK","Error":"","Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1updateInventarioDetailAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdInventario: Integer;
  CodigoUbicacion: String;
  bFound: Boolean;
  OldArticulo: String;
  NewArticulo: String;
  JSonObjectNew: TJSONObject;
  JSonValue: TJSONValue;
  OldCodigoArticulo: String;
  sFechaCaduca: string;
  OldId: Integer;
  bVerificada: Boolean;
  sFechaVerificacion: string;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.Values['UUID'];
  
  IdInventario := StrToIntDef(contentfields.values['IdInventario'],0);
  if IdInventario=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de inventario no es correcto","Data":[]}';
    Exit;
  end;

  CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  OldId := StrToIntDef(contentfields.Values['oldArticuloLineId'],0);
  NewArticulo := Trim(contentfields.Values['New']);

  JSonObjectNew := _Parse_JSonObject ( NewArticulo );
  if JSonObjectNew=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El formato JSON del elemento NewArticulo es incorrecto","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Actualitzem les ubicacions'}

  if JSonObjectNew.Get('FechaCaduca').JsonValue.ToString='""' then
    sFechaCaduca := 'NULL'
  else
    sFechaCaduca := SQL_DateToStr(StrToDate(JSonObjectNew.Get('FechaCaduca').JsonValue.ToString));

  if JSonObjectNew.Get('Verificada').JsonValue.ToString='true' then
  begin
    bVerificada := TRUE;
    sFechaVerificacion := 'GETDATE()';
  end else begin
    bVerificada := FALSE;
    sFechaVerificacion := 'NULL';
  end;

  // Fem l'entrada de l'article
  sSQL :=
    'INSERT INTO FS_SGA_Inventario_Detalle ( CodigoEmpresa, Inventario_Id, CodigoUbicacion, CodigoArticulo, Partida, UnidadMedida, ' +
    '  UnidadesSaldo, Verificada, UsuarioId, FechaHoraValidacion, FechaCaduca, UnidadesIniciales, CodigoTalla01_, CodigoColor_, ' +
    '  UnidadesSaldoBase, FactorConversion_, UnidadMedidaBase ) ' +
    'VALUES ( ' +
    IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
    IntToStr(IdInventario) + ', ' +
    '''' + SQL_Str(CodigoUbicacion) + ''', ' +
    '''' + SQL_Str(JSonObjectNew.Get('CodigoArticulo').JsonValue.Value) + ''', ' +
    '''' + SQL_Str(JSonObjectNew.Get('Partida').JsonValue.Value) + ''', ' +
    '''' + SQL_Str(AnsiUpperCase(JSonObjectNew.Get('UnidadMedida').JsonValue.Value)) + ''', ' +
    JSonObjectNew.Get('UnidadesSaldo').JsonValue.Value + ', ' +
    SQL_BooleanToStr(bVerificada) + ', ' +
    IntToStr(CodigoUsuario) + ', ' +
    sFechaVerificacion + ', ' +
    sFechaCaduca + ', ' +
    '0, ' + // Unidades iniciales
    '''' + SQL_Str(JSonObjectNew.Get('CodigoTalla').JsonValue.Value) + ''', ' +
    '''' + SQL_Str(JSonObjectNew.Get('CodigoColor').JsonValue.Value) + ''', ' +
    JSonObjectNew.Get('UnidadesSaldoBase').JsonValue.Value + ', ' +
    JSonObjectNew.Get('FactorConversion').JsonValue.Value + ', ' +
    '''' + SQL_Str(AnsiUpperCase(JSonObjectNew.Get('UnidadMedidaBase').JsonValue.Value)) + ''' ' +
    ')';

  try
    SQL_Execute_NoRes(Conn,sSQL);
  except
    on E:Exception do
    begin
      gaLogFile.Write_DBException(E,sSQL,'Error al añadir línea al inventario', CONST_LOGID_BBDD );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '","Data":[]}';
      Exit;
    end;
  end;

  sSQL :=
    'DELETE FROM FS_SGA_Inventario_Detalle ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND Inventario_Id = ' + IntToStr(IdInventario) + ' ' +
    '  AND Inventario_UbicacionId = ' + IntToStr(OldId);

  try
    SQL_Execute_NoRes(Conn,sSQL);
  except
    on E:Exception do
    begin
      gaLogFile.Write_DBException(E,sSQL,'Error al borrar línea del inventario', CONST_LOGID_BBDD );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '","Data":[]}';
      Exit;
    end;
  end;

  LP := LOG_Clear();
  LP.IdInventario := IdInventario;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-INV', 'Actualizar inventario de la ubicación ' + CodigoUbicacion, @LP );
  
  Result := '{"Result":"OK","Error":"","Data":[]}';

  {$ENDREGION}

end;

procedure WebModule1validarUbicacionInventarioAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdInventario: Integer;
  CodigoUbicacion: String;
  bFound: Boolean;
  sContenido: String;
  CodigoUbicacionAlternativo: string;
  CodigoAlmacen: string;
  CodigoEstanteria: string;
  CodigoPasillo: string;
  Altura: string;
  Fondo: string;
  CodigoAlternativo: string;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];
  
  IdInventario := StrToIntDef(contentfields.values['IdInventario'],0);
  if IdInventario=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de inventario no es correcto","Data":[]}';
    Exit;
  end;

  CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  {$ENDREGION}

  {$REGION 'Actualitzem les ubicacions'}

  sSQL :=
    'UPDATE FS_SGA_Inventario_Detalle ' +
    'SET ' +
    '  Verificada = 1, ' +
    '  UsuarioId = ' + IntToStr(CodigoUsuario) + ', ' +
    '  FechaHoraValidacion = GETDATE() ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND Inventario_Id = ' + IntToStr(IdInventario) + ' ' +
    '  AND CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + ''' ';

  try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do
    begin
      gaLogFile.Write_DBException(E,sSQL,'Error al validar ubicación', CONST_LOGID_BBDD );
      Result := '{"Result":"ERROR","Error":"' + JSON_Str(E.Message) + '","Data":[{"UbicacionCorrecta":false}]}';
      Exit;
    end;
  end;

  LP := LOG_Clear();
  LP.IdInventario := IdInventario;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'VALIDATE-INV-UBI', 'Validar ubicación ' + CodigoUbicacion + ' del inventario', @LP );

  Result := '{"Result":"OK","Error":"","Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1checkUbicacionInventarioAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdInventario: Integer;
  CodigoUbicacion: String;
  bFound: Boolean;
  sContenido: String;
  CodigoUbicacionAlternativo: string;
  CodigoAlmacen: string;
  CodigoEstanteria: string;
  CodigoPasillo: string;
  Altura: string;
  Fondo: string;
  CodigoAlternativo: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  IdInventario := StrToIntDef(contentfields.values['IdInventario'],0);
  if IdInventario=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de inventario no es correcto","Data":[]}';
    Exit;
  end;

  CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  {$ENDREGION}

  {$REGION 'Recuperem les dades'}

  sSQL :=
    'SELECT ' +
    '  CodigoUbicacion ' +
    'FROM ' +
    '  FS_SGA_Inventario_Detalle WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND Inventario_Id = ' + IntToStr(IdInventario) + ' ' +
    '  AND CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + '''';
  CodigoUbicacion := SQL_Execute ( Conn, sSQL, bFound );
  if not bFound then
  begin
    Result := '{"Result":"OK","Error":"","Data":[{"UbicacionCorrecta":false}]}';
  end else begin
    Result := '{"Result":"OK","Error":"","Data":[{"UbicacionCorrecta":true}]}';
  end;

  {$ENDREGION}

end;


procedure WebModule1proximaUbicacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdInventario: Integer;
  CodigoUbicacion: String;
  bFound: Boolean;
  sContenido: String;
  CodigoUbicacionAlternativo: string;
  CodigoAlmacen: string;
  CodigoEstanteria: string;
  CodigoPasillo: string;
  Altura: string;
  Fondo: string;
  CodigoAlternativo: string;
  Direccion: Integer;
  IncluirVerificadas: Boolean;
  Verificada: Boolean;
  iNumUbicaciones: Integer;
  iUbicacionActual: Integer;
  YY: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  IdInventario := StrToIntDef(contentfields.values['IdInventario'],0);
  if IdInventario=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de inventario no es correcto","Data":[]}';
    Exit;
  end;

  IncluirVerificadas := (AnsiUpperCase(contentfields.Values['IncluirVerificadas'])='TRUE');

  CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  Direccion := StrToIntDef(contentfields.Values['Direccion'], 1 );

  {$ENDREGION}

  {$REGION 'Recuperem les dades'}

  sSQL :=
    'SELECT ' +
    '  COUNT(DISTINCT CodigoUbicacion) ' +
    'FROM FS_SGA_Inventario_Detalle WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND Inventario_Id = ' + IntToStr(IdInventario);
  iNumUbicaciones := SQL_Execute ( Conn, sSQL );

  sSQL :=
    'SELECT TOP 1 CodigoUbicacion, Verificada ' +
    'FROM FS_SGA_Inventario_Detalle WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND Inventario_Id = ' + IntToStr(IdInventario) + ' ';

  if not IncluirVerificadas then
  begin
    sSQL := sSQL +
      '  AND Verificada = 0 ';
  end;

  if CodigoUbicacion<>'' then
  begin
    if Direccion<0 then
    begin
      sSQL := sSQL +
        'AND CodigoUbicacion < ''' + SQL_Str(CodigoUbicacion) + ''' ';
    end else begin
      sSQL := sSQL +
        'AND CodigoUbicacion > ''' + SQL_Str(CodigoUbicacion) + ''' ';
    end;
  end;

  sSQL := sSQL +
    'ORDER BY ' +
    '  CodigoUbicacion ';

  if Direccion<0 then
    sSQL := sSQL + ' DESC';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then
  begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Result":"ERROR","Message":"No hay más ubicaciones para inventariar","Data":[]}';
    Exit;
  end;

  if not Q.EOF then
  begin
    CodigoUbicacion := Q.FieldByName('CodigoUbicacion').AsString;
    Verificada      := Q.FieldByName('Verificada').AsBoolean;
  end;

  Q.Close;
  FreeAndNil(Q);

  sSQL :=
    'SELECT ' +
    '  COUNT(DISTINCT CodigoUbicacion) ' +
    'FROM FS_SGA_Inventario_Detalle WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND Inventario_Id = ' + IntToStr(IdInventario) + ' ' +
    '  AND CodigoUbicacion<''' + SQL_Str(CodigoUbicacion) + '''';
  iUbicacionActual := SQL_Execute ( Conn, sSQL ) + 1;

  FS_SGA_UBICACION_Desglosar ( Conn, CodigoEmpresa, CodigoUbicacion, CodigoAlmacen, CodigoPasillo, CodigoEstanteria, Altura, Fondo, CodigoAlternativo );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  sContenido := '[' + FS_SGA_ContenidoUbicacion ( Conn, CodigoEmpresa, YY, IdInventario, CodigoUbicacion ) + ']';

  Result := '{"Result":"OK","Error":"","Data":[';

  Result := Result +
    '{' +
    '"UbicacionActual":' + IntToStr(iUbicacionActual) + ',' +
    '"TotalUbicaciones":' + IntToStr(iNumUbicaciones) + ',' +
    '"Ubicacion":{' +
      '"CodigoUbicacion":"' + JSON_Str(CodigoUbicacion) + '",' +
      '"CodigoAlternativo":"' + JSON_Str(CodigoAlternativo) + '",' +
      '"CodigoUbicacionAlternativo":"' + JSON_Str(CodigoAlternativo) + '",' +
      '"CodigoAlmacen":"' + JSON_Str(CodigoAlmacen) + '",' +
      '"CodigoEstanteria":"' + JSON_Str(CodigoEstanteria) + '",' +
      '"CodigoPasillo":"' + JSON_Str(CodigoPasillo) + '",' +
      '"Verificada":' + SQL_BooleanToStr(Verificada) + ',' +
      '"Altura":"' + JSON_Str(Altura) + '",' +
      '"Fondo":"' + JSON_Str(Fondo) + '"' +
    '},' +
    '"Contenido":' + sContenido +
    '}';

  Result := Result + ']}';

  {$ENDREGION}

end;


procedure WebModule1borrarLineaExpedicionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdPreparacion: Integer;
  PickingId: Integer;
  IdExpedicion: Integer;
  LineasPosicion: String;
  CodigoArticulo: String;
  MACAddress: String;
  Partida: String;
  Cantidad: Double;
  UnidadMedida: String;
  FactorConversion: Double;
  CantidadBase: Double;
  UnidadMedidaBase: String;
  CodigoAgrupacion: Integer;
  UnidadesAgrupacion: Double;
  GrupoTalla: Integer;
  CodigoTalla: String;
  CodigoColor: String;
  CajaId: Integer;
  PaletId: Integer;
  TratamientoPartidas: Boolean;
  IsNew: Boolean;
  Stock: Double;
  StockBase: Double;
  LineaPL: TSGAPAckingListLine;
  PesoBruto: Double;
  PesoNeto: Double;
  Volumen: Double;
  FechaCaducidad: TDate;
  maxCaja: Integer;
  sPROC: String;
  Id: Integer;
  proc: TADOStoredProc;
  LineaPedidoTalla: String;
  OrdenDetalleTalla: Integer;
  Matricula: String;
  CodigoAlmacen: String;
  UbicacionOrigen: TSGAUbicacion;
  UbicacionDestino: TSGAUbicacion;
  DefaultUbi: TDefaultUbicaciones;
  gaMov: TSGAMovimientoStock;
  bErr: Boolean;
  sMsg: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  MACAddress    := contentfields.Values['UUID'];

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de preparación no es correcto","Data":[]}';
    Exit;
  end;

  Id := StrToIntDef(contentfields.values['PackingListId'],0);

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  PickingId := StrToIntDef(contentfields.values['PickingId'],0);
  if PickingId=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El número de línea de la preparación no es correcto","Data":[]}';
    Exit;
  end;
                    
  LineaPedidoTalla  := contentfields.values['LineaPedidoTalla'];
  OrdenDetalleTalla := StrToIntDef(contentfields.values['OrdenDetalleTalla'],0);
  CodigoAlmacen     := contentfields.Values['CodigoAlmacenDefecto'];

  IdExpedicion := StrToIntDef(contentfields.values['IdExpedicion'],0);
  if IdExpedicion=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El identificador de expedición de la preparación no es correcto","Data":[]}';
    Exit;
  end;

  LineasPosicion := SQL_GUID_ToStr(contentfields.values['LineasPosicion']);
  if LineasPosicion=GUID0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El identificador de línea de la preparación no es correcto","Data":[]}';
    Exit;
  end;

  CodigoArticulo := contentfields.values['CodigoArticulo'];

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );
  if CodigoArticulo=''then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;

  TratamientoPartidas := ARTICULO_TratamientoPartida ( Conn, CodigoEmpresa, CodigoArticulo );

  Partida := (contentfields.values['Partida']);
  if (Partida='') and (TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de partida no especificado","Data":[]}';
    Exit;
  end;

  if (Partida<>'') and (not TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no requiere partida","Data":[]}';
    Exit;
  end;

  PaletId := StrToIntDef(Trim(contentfields.values['PaletId']),0);
  if PaletId=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El identificador de palet de la preparación no es correcto","Data":[]}';
    Exit;
  end;

  Matricula := contentfields.values['Matricula'];
  if Matricula<>'' then
  begin
    UbicacionOrigen := SGA_ALMACEN_GetUbicacionMatricula ( Conn, CodigoEmpresa, Matricula );
    FS_SGA_ObtenerUbicacionesAlmacen ( Conn, CodigoEmpresa, CodigoAlmacen, DefaultUbi );
    UbicacionDestino := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, DefaultUbi.UbicacionExpediciones );
  end;

  CajaId := StrToIntDef(Trim(contentfields.values['CajaId']),0);
  if CajaId=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El identificador de caja de la preparación no es correcto","Data":[]}';
    Exit;
  end;

  Cantidad           := FS_StrToFloatDef(Trim(contentfields.values['Cantidad']),0);
  CantidadBase       := FS_StrToFloatDef(Trim(contentfields.values['CantidadBase']),0);
  UnidadMedida       := AnsiUpperCase(contentfields.values['UnidadMedida']);
  FactorConversion   := FS_StrToFloatDef(Trim(contentfields.values['FactorConversion']),1);
  UnidadMedidaBase   := AnsiUpperCase(contentfields.values['UnidadMedidaBase']);
  CodigoAgrupacion   := StrToIntDef(Trim(contentfields.values['CodigoAgrupacion']),0);
  UnidadesAgrupacion := FS_StrToFloatDef(Trim(contentfields.values['UnidadesAgrupacion']),1);
  GrupoTalla         := StrToIntDef(Trim(contentfields.values['GrupoTalla']),0);
  CodigoTalla        := contentfields.values['CodigoTalla'];
  CodigoColor        := contentfields.values['CodigoColor'];
  IsNew              := (Trim(contentfields.values['IsNew'])='true');

  FS_SGA_Check_UnidadMedidaBase ( Conn, CodigoEmpresa, CodigoArticulo, UnidadMedida, UnidadMedidaBase );

  sSQL :=
    'SELECT EjercicioPedido, SeriePedido, NumeroPedido, OrdenLineaPedido, LineaPedidoTalla, OrdenDetalleTalla ' +
    'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND PickingId = ' + IntToStr(PickingId);
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if not Q.EOF then
  begin
    LineaPL.EjercicioPedido   := Q.FieldByName('EjercicioPedido').AsInteger;
    LineaPL.SeriePedido       := Q.FieldByName('SeriePedido').AsString;
    LineaPL.NumeroPedido      := Q.FieldByName('NumeroPedido').AsInteger;
    LineaPL.Orden             := Q.FieldByName('OrdenLineaPedido').AsInteger;
    LineaPL.LineaPedidoTalla  := Q.FieldByName('LineaPedidoTalla').AsString;
    LineaPL.OrdenDetalleTalla := Q.FieldByName('OrdenDetalleTalla').AsInteger;
  end;

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

  {$REGION 'Actualitzem dades'}

  LineaPL.CodigoEmpresa           := CodigoEmpresa.EmpresaOrigen;
  LineaPL.Ejercicio               := YearOf(Now());
  LineaPL.IdPreparacion           := IdPreparacion;
  LineaPL.PickingId               := PickingId;
  LineaPL.IdentificadorExpedicion := IdExpedicion;
  LineaPL.LineasPosicion          := LineasPosicion;
  LineaPL.Fecha                   := Now();
  LineaPL.CodigoUsuario           := CodigoUsuario;
  LineaPL.MACAddress              := MACAddress;
  LineaPL.PaletId                 := PaletId;
  LineaPL.PaletRef                := '';
  LineaPL.Matricula	              := Matricula;
  LineaPL.CajaId                  := CajaId;
  LineaPL.CajaRef                 := '';
  LineaPL.CodigoArticulo          := CodigoArticulo;
  LineaPL.Partida                 := Partida;
  LineaPL.Unidades                := Cantidad;
  LineaPL.UnidadMedida            := AnsiUpperCase(UnidadMedida);
  LineaPL.UnidadesBase            := CantidadBase;
  LineaPL.UnidadMedidaBase        := AnsiUpperCase(UnidadMedidaBase);
  LineaPL.FactorConversion        := FactorConversion;
  LineaPL.PesoBruto               := CantidadBase * PesoBruto;
  LineaPL.PesoNeto                := CantidadBase * PesoNeto;
  LineaPL.Volumen                 := CantidadBase * Volumen;
  LineaPL.CodigoAgrupacion        := CodigoAgrupacion;
  LineaPL.UnidadesAgrupacion      := UnidadesAgrupacion;
  LineaPL.UnidadMedidaAgrupacion  := AnsiUpperCase(UnidadMedida);
  LineaPL.FechaCaducidad          := FechaCaducidad;
  LineaPL.GrupoTalla              := GrupoTalla;
  LineaPL.CodigoTalla             := CodigoTalla;
  LineaPL.CodigoColor             := CodigoColor;
  LineaPL.Id                      := Id;

  // Mirem si existeix la línea del packing list
  FS_SGA_DeleteLineaPackingList ( Conn, LineaPL );
  FS_SGA_DeleteAcumuladoPendiente ( Conn, CodigoEmpresa, LineaPL );
  FS_SGA_TraceExpedicion ( Conn, 'D', LineaPL );

  // Si ho estem posant en una matrícula, movem el material des de
  // la ubicació d'expedició a la ubicació on està el palet
  if (LineaPL.Matricula <> '') then
  begin

    SGA_FS_ALMACEN_PrepareMov ( gaMov );
    gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
    gaMov.EmpresaOrigen          := LineaPL.EmpresaOrigen;
    gaMov.CodigoUsuario          := LineaPL.CodigoUsuario;
    gaMov.Ejercicio              := LineaPL.Ejercicio;
    gaMov.Periodo                := MonthOf(Now);
    gaMov.Fecha                  := Date;
    gaMov.FechaHora              := Now();
    gaMov.CodigoAlmacen          := UbicacionDestino.CodigoAlmacen;
    gaMov.CodigoUbicacion        := UbicacionDestino.CodigoUbicacion;
    gaMov.CodigoAlmacenDestino   := UbicacionOrigen.CodigoAlmacen;
    gaMov.CodigoUbicacionDestino := UbicacionOrigen.CodigoUbicacion;
    gaMov.CodigoArticulo         := LineaPL.CodigoArticulo;
    gaMov.TipoMovimiento         := 1; // Entrada a la ubicació on hi ha el palet
    gaMov.OrigenMovimiento       := 'E';
    gaMov.Partida                := LineaPL.Partida;
    gaMov.Unidades               := LineaPL.Unidades;
    gaMov.UnidadMedida           := LineaPL.UnidadMedida;
    gaMov.UnidadesBase           := LineaPL.UnidadesBase;
    gaMov.UnidadMedidaBase       := LineaPL.UnidadMedidaBase;
    gaMov.FactorConversion       := LineaPL.FactorConversion;
    gaMov.Comentario             := 'Palet a expedición';
    gaMov.FechaCaduca            := LineaPL.FechaCaducidad;
    gaMov.MovOrigen              := SQL_Execute ( Conn, 'SELECT NEWID()' );
    gaMov.PreparacionId          := LineaPL.IdPreparacion;
    gaMov.PickingId              := LineaPL.PickingId;
    gaMov.CodigoColor            := LineaPL.CodigoColor;
    gaMov.GrupoTalla             := LineaPL.GrupoTalla;
    gaMov.CodigoTalla            := LineaPL.CodigoTalla;
    gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );
    gaMov.MovTraspaso            := SQL_Execute ( Conn, 'SELECT NEWID()' );
    gaMov.EjercicioDocumento     := LineaPL.EjercicioPedido;
    gaMov.Matricula              := '';
    gaMov.CodigoAgrupacion       := LineaPL.CodigoAgrupacion;

    if gaMov.Precio=0 then
    begin
      gaMov.Precio :=
        ARTICULO_ConsultarPrecioStock (
          Conn,
          CodigoEmpresa,
          gaMov.CodigoArticulo,
          gaMov.Partida,
          gaMov.CodigoColor,
          gaMov.CodigoTalla,
          gaMov.CodigoAlmacen,
          gaMov.GrupoTalla
        );
    end;

    gaMov.Importe := gaMov.Precio * gaMov.UnidadesBase;

    if UbicacionOrigen.CodigoAlmacen<>UbicacionDestino.CodigoAlmacen then
    begin
      gaMov.TipoMovimientoSAGE := [tmsageMovimientoStock];
    end;

    bErr := FALSE;
    sMsg := '';

    try
      bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message;
      end;
    end;

    if UbicacionOrigen.CodigoAlmacen<>UbicacionDestino.CodigoAlmacen then
    begin
      gaMov.MovPosicion := SQL_Execute ( Conn, 'SELECT NEWID()' );
    end;

    gaMov.TipoMovimiento         := 2; // Entrada a la ubicació on hi ha el palet
    gaMov.OrigenMovimiento       := 'S';
    gaMov.Matricula	             := LineaPl.Matricula;
    gaMov.CodigoAlmacen          := UbicacionOrigen.CodigoAlmacen;
    gaMov.CodigoUbicacion        := UbicacionOrigen.CodigoUbicacion;
    gaMov.CodigoAlmacenDestino   := UbicacionDestino.CodigoAlmacen;
    gaMov.CodigoUbicacionDestino := UbicacionDestino.CodigoUbicacion;

    try
      bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message;
      end;
    end;

  end;

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_UpdatePaletCaja', sPROC ) then
  begin

    sSQL :=
      'EXEC dbo.[' + sPROC + '] ' +
        IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
        IntToStr(IdPreparacion) + ', ' +
        IntToStr(IdExpedicion) + ', ' +
        IntToStr(PickingId) + ', ' +
        '''' + SQL_Str(CodigoArticulo) + ''', ' +
        '''' + SQL_Str(CodigoTalla) + ''', ' +
        '''' + SQL_Str(CodigoColor) + ''', ' +
        '''' + SQL_Str(Partida) + ''', ' +
        IntToStr(CodigoAgrupacion) + ', ' +
        SQL_FloatToStr(UnidadesAgrupacion) + ', ' +
        '''' + SQL_Str(UnidadMedida) + ''', ' +
        '''' + SQL_Str(UnidadMedidaBase) + ''', ' +
        SQL_FloatToStr(FactorConversion) + ', ' +
        IntToStr(PaletId) + ', ' +
        '''' + SQL_Str(Matricula) + ''', ' +
        IntToStr(CajaId);

    proc := TADOStoredProc.Create(nil);
    proc.Connection := Conn;
    proc.ProcedureName := 'dbo.[' + sPROC + ']';
    proc.Parameters.Refresh;

    proc.Parameters.ParamByName('@CodigoEmpresa').Value      := CodigoEmpresa.EmpresaOrigen;
    proc.Parameters.ParamByName('@IdPreparacion').Value      := IdPreparacion;
    proc.Parameters.ParamByName('@IdExpedicion').Value       := IdExpedicion;
    proc.Parameters.ParamByName('@PickingId').Value          := PickingId;
    proc.Parameters.ParamByName('@CodigoArticulo').Value     := CodigoArticulo;
    proc.Parameters.ParamByName('@CodigoTalla01_').Value     := CodigoTalla;
    proc.Parameters.ParamByName('@CodigoColor_').Value       := CodigoColor;
    proc.Parameters.ParamByName('@Partida').Value            := Partida;
    proc.Parameters.ParamByName('@CodigoAgrupacion').Value   := CodigoAgrupacion;
    proc.Parameters.ParamByName('@UnidadesAgrupacion').Value := UnidadesAgrupacion;
    proc.Parameters.ParamByName('@UnidadMedida').Value       := UnidadMedida;
    proc.Parameters.ParamByName('@UnidadMedidaBase').Value   := UnidadMedidaBase;
    proc.Parameters.ParamByName('@FactorConversion').Value   := FactorConversion;
    proc.Parameters.ParamByName('@PaletId').Value            := PaletId;
    proc.Parameters.ParamByName('@Matricula').Value          := Matricula;
    proc.Parameters.ParamByName('@CajaId').Value             := CajaId;
    proc.Parameters.ParamByName('@NuevoPaletID').Value       := 0;
    proc.Parameters.ParamByName('@NuevaMatricula').Value     := '';
    proc.Parameters.ParamByName('@NuevaCajaID').Value        := 0;

    proc.Prepared := TRUE;
    proc.ExecProc;

    PaletId   := proc.Parameters.ParamValues['@NuevoPaletID'];
    CajaId    := proc.Parameters.ParamValues['@NuevaCajaID'];

    FreeAndNil(proc);

  end else begin

    sSQL :=
      'UPDATE FS_SGA_PACKINGLIST ' +
      'SET ' +
      '  cajaId = cajaId - 1 ' +
      'WHERE ' +
      '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND IdentificadorExpedicion = ' + IntToStr(IdExpedicion) + ' ' +
      '  AND PickingId = ' + IntToStr(PickingId) + ' ' +
      '  AND PaletId = ' + IntToStr(PaletId) + ' ' +
      '  AND Matricula = ''' + SQL_Str(Matricula) + ''' ' +
      '  AND CajaId > ' + IntToStr(CajaId);
    SQL_Execute_NoRes ( Conn, sSQL );

    if (CajaId>0) then
    begin
      sSQL :=
        'SELECT ' +
        '  MAX(cajaId) ' +
        'FROM FS_SGA_PACKINGLIST WITH (NOLOCK) ' +
        'WHERE ' +
        '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
        '  AND IdentificadorExpedicion = ' + IntToStr(IdExpedicion) + ' ' +
        '  AND PaletId = ' + IntToStr(PaletId) + ' ' +
        '  AND Matricula = ''' + SQL_Str(Matricula) + '''';
      CajaId := SQL_Execute ( Conn, sSQL ) + 1;
    end;

  end;

  sSQL :=
    'DELETE FROM FS_SGA_PackingList ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND unidades = 0 ' +
    '  AND unidadesbase = 0';
  SQL_Execute_NoRes ( Conn, sSQL );

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;
  LP.MovOrigen := gaMov.MovOrigen;
  LP.Matricula := gaMov.Matricula;

  LOG_Add ( Conn, CodigoUsuario, MACAddress, sRemoteAddr, 'DELETE-EXP-LIN', 'Borrar línea ' + IntToStr(PickingId) + ' de la expedición', @LP );

  sSQL :=
    'UPDATE T1 ' +
    '  SET T1.UnidadesAsignadas = ISNULL(T2.UdExpedidas, 0), ' +
    '  T1.UnidadesAsignadasBase = ISNULL(T2.UdExpedidasBase, 0) ' +
    'FROM FS_SGA_Picking_Pedido_Lineas_Detalle T1 ' +
    'LEFT JOIN ( ' +
    '  SELECT IdPreparacion, CodigoArticulo, Partida, UnidadMedida, CodigoTalla01_, CodigoColor_, SUM(Cantidad) AS UdExpedidas, SUM(CantidadBase) AS UdExpedidasBase ' +
    '  FROM FS_SGA_AcumuladoPendiente ' +
    '  WHERE IdPreparacion = ' + IntToStr(LineaPL.IdPreparacion) + ' ' +
    '  AND LineaPedidoCliente <> ''00000000-0000-0000-0000-000000000000'' ' +
    '  AND PickingId = CASE WHEN ' + IntToStr(LineaPL.PickingId) + '<>0 THEN ' + IntToStr(LineaPL.PickingId) + ' ELSE PickingId END ' +
    '  GROUP BY IdPreparacion, CodigoArticulo, Partida, UnidadMedida, CodigoTalla01_, CodigoColor_ ' +
    ') T2 ' +
    '  ON T1.PreparacionId = T2.IdPreparacion ' +
    '  AND T1.CodigoArticulo = T2.CodigoArticulo ' +
    '  AND T1.Partida = T2.Partida ' +
    '  AND T1.UnidadMedida = T2.UnidadMedida ' +
    '  AND T1.CodigoTalla01_ = T2.CodigoTalla01_ ' +
    '  AND T1.CodigoColor_ = T2.CodigoColor_ ' +
    'WHERE ' +
    '  T1.PreparacionId = ' + IntToStr(LineaPL.IdPreparacion);
  SQL_Execute_NoRes ( Conn, sSQL );

  Result := '{"Result":"OK","Error":"","Data":[';

  Result := Result +
    '{' +
    '"PaletId":' + IntToStr(PaletId) + ',' +
    '"Matricula":"' + JSON_Str(Matricula) + '",' +
    '"CajaId":' + IntToStr(CajaId) +
    '}';

  Result := Result + ']}';

  {$ENDREGION}

end;


procedure WebModule1generarPackingListAutoAction (
  Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdPreparacion: Integer;
  Matricula: String;
  MACAddress: String;
  sPROCCustom: String;
  proc: TADOStoredProc;
  OldCantidad: Double;
  OldCantidadBase: Double;
  CodigoAlmacen: String;
  bErr: Boolean;
  sMsg: String;
  NumPalets: Integer;
  NumCajas: Integer;
  IdPackagingPalets: Integer;
  IdPackagingCajas: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  MACAddress    := contentfields.Values['UUID'];
  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de preparación no es correcto","Data":[]}';
    Exit;
  end;

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  Matricula         := (contentfields.Values['Matricula']);
  NumPalets         := StrToIntDef(Trim(contentfields.values['NumPalets']),1);
  NumCajas          := StrToIntDef(Trim(contentfields.values['NumCajas']),1);
  IdPackagingPalets := StrToIntDef(Trim(contentfields.values['PaletPackagingId']),0);
  IdPackagingCajas  := StrToIntDef(Trim(contentfields.values['CajaPackagingId']),0);

  {$ENDREGION}

  {$REGION 'Actualitzem dades'}

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_PackingList_AUTO', sPROCCustom ) then begin

    sSQL := 'EXEC dbo.[' + sPROCCustom + '] ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(IdPreparacion) + ', ' +
      '''' + SQL_Str(Matricula) + ''', ' +
      IntToStr(NumPalets) + ', ' +
      IntToStr(IdPackagingPalets) + ', ' +
      IntToStr(NumCajas) + ', ' +
      IntToStr(IdPackagingCajas);

    SQL_Execute_NoRes ( Conn, sSQL );

  end;

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;
  LP.Matricula := Matricula;

  LOG_Add ( Conn, CodigoUsuario, MACAddress, sRemoteAddr, 'EXPEDITE-AUTO', 'Expedir preparación AUTO', @LP );

  Result := '{"Result":"OK","Error":"","Data":[';

  Result := Result +
    '{' +
    '}';

  Result := Result + ']}';

  {$ENDREGION}

end;


procedure WebModule1expedirLineaAction (
  Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdPreparacion: Integer;
  PickingId: Integer;
  IdExpedicion: Integer;
  LineasPosicion: String;
  CodigoArticulo: String;
  Partida: String;
  Cantidad: Double;
  UnidadMedida: String;
  FactorConversion: Double;
  CantidadBase: Double;
  UnidadMedidaBase: String;
  CodigoAgrupacion: Integer;
  UnidadesAgrupacion: Double;
  GrupoTalla: Integer;
  CodigoTalla: String;
  CodigoColor: String;
  CajaId: Integer;
  PaletId: Integer;
  Matricula: String;
  CajaIdAnterior: Integer;
  PaletIdAnterior: Integer;
  MatriculaAnterior: String;
  TratamientoPartidas: Boolean;
  IsNew: Boolean;
  Stock: Double;
  StockBase: Double;
  MACAddress: String;
  LineaPL: TSGAPAckingListLine;
  PesoBruto: Double;
  PesoNeto: Double;
  Volumen: Double;
  FechaCaducidad: TDate;
  sPROC: String;
  proc: TADOStoredProc;
  OldCantidad: Double;
  OldCantidadBase: Double;
  LineaPedidoTalla: String;
  OrdenDetalleTalla: Integer;
  gaMov: TSGAMovimientoStock;
  UbicacionDestino: TSGAUbicacion;
  UbicacionOrigen: TSGAUbicacion;
  DefaultUbi: TDefaultUbicaciones;
  CodigoAlmacen: String;
  bErr: Boolean;
  sMsg: String;
  Data: String;
  JSonObject: TJSONObject;
  JSonValue: TJSONValue;
  JSonArray: TJSONArray;
  lJSonValue: TJSonValue;
  Saved: Boolean;
  s: AnsiString;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  MACAddress    := contentfields.Values['UUID'];
  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de preparación no es correcto","Data":[]}';
    Exit;
  end;

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  PickingId := StrToIntDef(contentfields.values['PickingId'],0);
  if PickingId=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El número de línea de la preparación no es correcto","Data":[]}';
    Exit;
  end;

  LineaPedidoTalla  := (contentfields.values['LineaPedidoTalla']);
  OrdenDetalleTalla := StrToIntDef(contentfields.values['OrdenDetalleTalla'],0);
  Matricula         := (contentfields.Values['Matricula']);

  IdExpedicion := StrToIntDef(contentfields.values['IdExpedicion'],0);
  if IdExpedicion=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El identificador de expedición de la preparación no es correcto","Data":[]}';
    Exit;
  end;

  LineasPosicion := SQL_GUID_ToStr(contentfields.values['LineasPosicion']);
  if LineasPosicion=GUID0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El identificador de línea de la preparación no es correcto","Data":[]}';
    Exit;
  end;

  CodigoArticulo := contentfields.values['CodigoArticulo'];

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );
  if CodigoArticulo=''then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;

  TratamientoPartidas := ARTICULO_TratamientoPartida ( Conn, CodigoEmpresa, CodigoArticulo );

  Partida := (contentfields.values['Partida']);
  if AnsiLowerCase(Partida)='undefined' then
    Partida := '';

  if (Partida='') and (TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de partida no especificado","Data":[]}';
    Exit;
  end;

  if (Partida<>'') and (not TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no requiere partida","Data":[]}';
    Exit;
  end;

  PaletId := StrToIntDef(Trim(contentfields.values['PaletId']),0);
  if PaletId=0 then
  begin
    PaletId := 1;
    //Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El identificador de palet de la preparación no es correcto","Data":[]}';
    //Exit;
  end;

  CajaId := StrToIntDef(Trim(contentfields.values['CajaId']),0);
  if CajaId=0 then
  begin
    CajaId := 1;
    //Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El identificador de caja de la preparación no es correcto","Data":[]}';
    //Exit;
  end;

  MatriculaAnterior  := contentfields.Values['MatriculaAnterior'];
  PaletIdAnterior    := StrToIntDef(Trim(contentfields.values['PaletIdAnterior']),0);
  CajaIdAnterior     := StrToIntDef(Trim(contentfields.values['CajaIdAnterior']),0);
  Cantidad           := FS_StrToFloatDef(contentfields.values['Cantidad'],0);
  CantidadBase       := FS_StrToFloatDef(contentfields.values['CantidadBase'],0);
  OldCantidad        := FS_StrToFloatDef(contentfields.values['OldCantidad'],0);
  OldCantidadBase    := FS_StrToFloatDef(contentfields.values['OldCantidadBase'],0);
  UnidadMedida       := AnsiUpperCase(contentfields.values['UnidadMedida']);
  FactorConversion   := FS_StrToFloatDef(contentfields.values['FactorConversion'],1);
  UnidadMedidaBase   := AnsiUpperCase(contentfields.values['UnidadMedidaBase']);
  CodigoAgrupacion   := StrToIntDef(Trim(contentfields.values['CodigoAgrupacion']),0);
  UnidadesAgrupacion := FS_StrToFloatDef(contentfields.values['UnidadesAgrupacion'],1);
  GrupoTalla         := StrToIntDef(Trim(contentfields.values['GrupoTalla']),0);
  CodigoAlmacen      := contentfields.Values['CodigoAlmacenDefecto'];
  CodigoTalla        := contentfields.values['CodigoTalla'];
  CodigoColor        := contentfields.values['CodigoColor'];
  IsNew              := (Trim(contentfields.values['IsNew'])='true');

  Data := (contentfields.values['Scans']);
  if Data='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se han especificado los datos","Data":[]}';
    Exit;
  end;

  JSonObject := _Parse_JSonObject ( Data );
  if JSonObject=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El formato JSON del elemento Data es incorrecto","Data":[]}';
    Exit;
  end;

  JSonValue  := JSonObject.Get('Desglose').JsonValue;
  if JSonValue=nil then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no son válidos","Data":[]}';
    JSonObject.Free;
    Exit;
  end;


  s := JSonValue.ToJSON;

  JSonArray := TJSONArray(JSonValue);
  if JSonArray=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no contienen un array válido","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Verificació de les dades'}
  sSQL :=
    'SELECT ' +
    '  Cantidad, CantidadBase, FechaCaduca ' +
    'FROM FS_SGA_AcumuladoPendiente WITH (NOLOCK) ' +
    'WHERE ' +
    '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND LineaPedidoCliente = ''' + SQL_GUID_ToStr(GUID0) + ''' ' +
    '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
    '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
    '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
    '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
    '  AND LineaPedidoAsignada IN ( ''' + SQL_GUID_ToStr(GUID0) + ''', ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ) ';
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then
  begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Result":"ERROR","Message":"No existe ninguna cantidad preparada para expedir","Data":[]}';
    Exit;
  end;

  Stock          := Q.FieldByName('Cantidad').AsFloat + OldCantidad;
  StockBase      := Q.FieldByName('CantidadBase').AsFloat + OldCantidadBase;
  FechaCaducidad := Q.FieldByName('FechaCaduca').AsDateTime;

  Q.Close;
  FreeAndNil(Q);

  if (Stock<Cantidad) or (StockBase<CantidadBase) then
  begin
    Result := '{"Result":"ERROR","Message":"No hay cantidad suficiente para expedir la línea de la preparación","Data":[]}';
    Exit;
  end;

  // Si ho estem posant en una matrícula, movem el material des de
  // la ubicació d'expedició a la ubicació on està el palet
  if (Matricula <> '') then
  begin

    // Recuperem la ubicació per defecte
    if MatriculaAnterior<>'' then
    begin
      UbicacionOrigen := SGA_ALMACEN_GetUbicacionMatricula ( Conn, CodigoEmpresa, MatriculaAnterior );
    end else begin
      FS_SGA_ObtenerUbicacionesAlmacen ( Conn, CodigoEmpresa, CodigoAlmacen, DefaultUbi );
      UbicacionOrigen := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, DefaultUbi.UbicacionExpediciones );
    end;

    // Recuperem la ubicació de la matrícula
    UbicacionDestino := SGA_ALMACEN_GetUbicacionMatricula ( Conn, CodigoEmpresa, Matricula );
    if UbicacionDestino.CodigoUbicacion='' then
    begin
      Result := '{"Result":"ERROR","Message":"La matrícula ' + Matricula + ' no tiene ubicación","Data":[]}';
      Exit;
    end;

  end;

  //----------------------------------------------
  //-- CALCULEM PESOS I VOLUM
  //---------------------------------------------
  ARTICULO_PesoVolumenUnitario (
    Conn,
    CodigoEmpresa,
    CodigoArticulo,
    PesoBruto,
    PesoNeto,
    Volumen
  );

  sSQL :=
    'SELECT EjercicioPedido, SeriePedido, NumeroPedido, OrdenLineaPedido ' +
    'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND PickingId = ' + IntToStr(PickingId);
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if not Q.EOF then
  begin
    LineaPL.EjercicioPedido := Q.FieldByName('EjercicioPedido').AsInteger;
    LineaPL.SeriePedido     := Q.FieldByName('SeriePedido').AsString;
    LineaPL.NumeroPedido    := Q.FieldByName('NumeroPedido').AsInteger;
    LineaPL.Orden           := Q.FieldByName('OrdenLineaPedido').AsInteger;
  end;

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

  {$REGION 'Actualitzem dades'}

  for lJSonValue in JSonArray do begin

    Saved := StrToIntDef(_Get_JSonValue ( lJSonValue, 'Saved' ),0)<>0;

    if not Saved then
    begin

      Cantidad     := StrToFloatDef((_Get_JSonValue ( lJSonValue, 'Cantidad' )),0);
      CantidadBase := StrToFloatDef((_Get_JSonValue ( lJSonValue, 'CantidadBase' )),0);

      LineaPL.CodigoEmpresa           := CodigoEmpresa.EmpresaOrigen;
      LineaPL.Ejercicio               := YearOf(Now());
      LineaPL.IdPreparacion           := IdPreparacion;
      LineaPL.PickingId               := PickingId;
      LineaPL.IdentificadorExpedicion := IdExpedicion;
      LineaPL.LineasPosicion          := LineasPosicion;
      LineaPL.Fecha                   := Now();
      LineaPL.CodigoUsuario           := CodigoUsuario;
      LineaPL.MACAddress              := MACAddress;
      LineaPL.PaletIdAnterior         := PaletIdAnterior;
      LineaPL.MatriculaAnterior       := MatriculaAnterior;
      LineaPL.PaletId                 := PaletId;
      LineaPL.PaletRef                := '';
      LineaPL.CajaIdAnterior          := CajaIdAnterior;
      LineaPL.CajaId                  := CajaId;
      LineaPL.CajaRef                 := '';
      LineaPL.CodigoArticulo          := CodigoArticulo;
      LineaPL.Partida                 := Partida;
      LineaPL.OldUnidades             := OldCantidad * UnidadesAgrupacion;
      LineaPL.Unidades                := Cantidad * UnidadesAgrupacion;
      LineaPL.UnidadMedida            := AnsiUpperCase(UnidadMedida);
      LineaPL.OldUnidadesBase         := OldCantidadBase;
      LineaPL.UnidadesBase            := CantidadBase;
      LineaPL.UnidadMedidaBase        := AnsiUpperCase(UnidadMedidaBase);
      LineaPL.FactorConversion        := FactorConversion;
      LineaPL.PesoBruto               := CantidadBase * PesoBruto;
      LineaPL.PesoNeto                := CantidadBase * PesoNeto;
      LineaPL.Volumen                 := CantidadBase * Volumen;
      LineaPL.CodigoAgrupacion        := CodigoAgrupacion;
      LineaPL.UnidadesAgrupacion      := UnidadesAgrupacion;
      LineaPL.UnidadMedidaAgrupacion  := AnsiUpperCase(UnidadMedida);
      LineaPL.FechaCaducidad          := FechaCaducidad;
      LineaPL.GrupoTalla              := GrupoTalla;
      LineaPL.CodigoTalla             := CodigoTalla;
      LineaPL.CodigoColor             := CodigoColor;
      LineaPL.Matricula	              := Matricula;
      LineaPL.LineaPedidoTalla        := LineaPedidoTalla;
      LineaPL.OrdenDetalleTalla       := OrdenDetalleTalla;
      LineaPL.IsNew                   := IsNew;

      // Mirem si existeix la línea nova del packing list
      if FS_SGA_ExisteLineaPackingList ( Conn, CodigoEmpresa, LineaPL, True ) then
      begin
        FS_SGA_UpdateLineaPackingList ( Conn, LineaPL, True );
      end else begin
        FS_SGA_InsertLineaPackingList ( Conn, LineaPL, True );
      end;

      // Mirem si existeix la línea antiga del packing list
      if not IsNew then
      begin
        FS_SGA_UpdateLineaPackingList ( Conn, LineaPL, False );
      end;

      if IsNew then
      begin
        FS_SGA_TraceExpedicion ( Conn, 'I', LineaPL );
      end else begin
        FS_SGA_TraceExpedicion ( Conn, 'U', LineaPL );
      end;

      if FS_SGA_ExisteAcumuladoPendiente ( Conn, LineaPL ) then
      begin
        FS_SGA_UpdateAcumuladoPendiente ( Conn, CodigoEmpresa, LineaPL );
      end else begin
        FS_SGA_InsertAcumuladoPendiente ( Conn, CodigoEmpresa, LineaPL );
      end;

      // Si ho estem posant en una matrícula, movem el material des de
      // la ubicació d'expedició a la ubicació on està el palet
      if (LineaPL.Matricula <> '') then
      begin

        SGA_FS_ALMACEN_PrepareMov ( gaMov );
        gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
        gaMov.EmpresaOrigen          := LineaPL.EmpresaOrigen;
        gaMov.CodigoUsuario          := LineaPL.CodigoUsuario;
        gaMov.Ejercicio              := LineaPL.Ejercicio;
        gaMov.Periodo                := MonthOf(Now);
        gaMov.Fecha                  := Date;
        gaMov.FechaHora              := Now();
        gaMov.CodigoAlmacen          := UbicacionDestino.CodigoAlmacen;
        gaMov.CodigoUbicacion        := UbicacionDestino.CodigoUbicacion;
        gaMov.CodigoAlmacenDestino   := UbicacionOrigen.CodigoAlmacen;
        gaMov.CodigoUbicacionDestino := UbicacionOrigen.CodigoUbicacion;
        gaMov.CodigoArticulo         := LineaPL.CodigoArticulo;
        gaMov.TipoMovimiento         := 1; // Entrada a la ubicació on hi ha el palet
        gaMov.OrigenMovimiento       := 'E';
        gaMov.Partida                := LineaPL.Partida;
        gaMov.Unidades               := LineaPL.Unidades;
        gaMov.UnidadMedida           := LineaPL.UnidadMedida;
        gaMov.UnidadesBase           := LineaPL.UnidadesBase;
        gaMov.UnidadMedidaBase       := LineaPL.UnidadMedidaBase;
        gaMov.FactorConversion       := LineaPL.FactorConversion;
        gaMov.Comentario             := 'Expedición a palet';
        gaMov.FechaCaduca            := LineaPL.FechaCaducidad;
        gaMov.MovOrigen              := SQL_Execute ( Conn, 'SELECT NEWID()' );
        gaMov.PreparacionId          := LineaPL.IdPreparacion;
        gaMov.PickingId              := LineaPL.PickingId;
        gaMov.CodigoColor            := LineaPL.CodigoColor;
        gaMov.GrupoTalla             := LineaPL.GrupoTalla;
        gaMov.CodigoTalla            := LineaPL.CodigoTalla;
        gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );
        gaMov.MovTraspaso            := SQL_Execute ( Conn, 'SELECT NEWID()' );
        gaMov.EjercicioDocumento     := LineaPL.EjercicioPedido;
        gaMov.Matricula              := LineaPL.Matricula;
        gaMov.CodigoAgrupacion       := LineaPL.CodigoAgrupacion;

        if gaMov.Precio=0 then
        begin
          gaMov.Precio :=
            ARTICULO_ConsultarPrecioStock (
              Conn,
              CodigoEmpresa,
              gaMov.CodigoArticulo,
              gaMov.Partida,
              gaMov.CodigoColor,
              gaMov.CodigoTalla,
              gaMov.CodigoAlmacen,
              gaMov.GrupoTalla
            );
        end;

        gaMov.Importe := gaMov.Precio * gaMov.UnidadesBase;

        if UbicacionOrigen.CodigoAlmacen<>UbicacionDestino.CodigoAlmacen then
        begin
          gaMov.TipoMovimientoSAGE := [tmsageMovimientoStock];
        end;

        bErr := FALSE;
        sMsg := '';

        try
          bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
        except
          on E:Exception do begin
            bErr := TRUE;
            sMsg := E.Message;
          end;
        end;

        gaMov.TipoMovimiento         := 2; // Entrada a la ubicació on hi ha el palet
        gaMov.OrigenMovimiento       := 'S';
        gaMov.Matricula	             := LineaPl.MatriculaAnterior;
        gaMov.CodigoAlmacen          := UbicacionOrigen.CodigoAlmacen;
        gaMov.CodigoUbicacion        := UbicacionOrigen.CodigoUbicacion;
        gaMov.CodigoAlmacenDestino   := UbicacionDestino.CodigoAlmacen;
        gaMov.CodigoUbicacionDestino := UbicacionDestino.CodigoUbicacion;

        if UbicacionOrigen.CodigoAlmacen<>UbicacionDestino.CodigoAlmacen then
        begin
          gaMov.MovPosicion := SQL_Execute ( Conn, 'SELECT NEWID()' );
        end;

        try
          bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
        except
          on E:Exception do begin
            bErr := TRUE;
            sMsg := E.Message;
          end;
        end;

      end;

    end;

  end;

  sSQL :=
    'UPDATE T1 ' +
    '  SET T1.UnidadesAsignadas = ISNULL(T2.UdExpedidas, 0), ' +
    '  T1.UnidadesAsignadasBase = ISNULL(T2.UdExpedidasBase, 0) ' +
    'FROM FS_SGA_Picking_Pedido_Lineas_Detalle T1 ' +
    'LEFT JOIN ( ' +
    '  SELECT IdPreparacion, CodigoArticulo, Partida, UnidadMedida, CodigoTalla01_, CodigoColor_, SUM(Cantidad) AS UdExpedidas, SUM(CantidadBase) AS UdExpedidasBase ' +
    '  FROM FS_SGA_AcumuladoPendiente ' +
    '  WHERE IdPreparacion = ' + IntToStr(LineaPL.IdPreparacion) + ' ' +
    '  AND LineaPedidoCliente <> ''00000000-0000-0000-0000-000000000000'' ' +
    '  AND PickingId = CASE WHEN ' + IntToStr(LineaPL.PickingId) + '<>0 THEN ' + IntToStr(LineaPL.PickingId) + ' ELSE PickingId END ' +
    '  GROUP BY IdPreparacion, CodigoArticulo, Partida, UnidadMedida, CodigoTalla01_, CodigoColor_ ' +
    ') T2 ' +
    '  ON T1.PreparacionId = T2.IdPreparacion ' +
    '  AND T1.CodigoArticulo = T2.CodigoArticulo ' +
    '  AND T1.Partida = T2.Partida ' +
    '  AND T1.UnidadMedida = T2.UnidadMedida ' +
    '  AND T1.CodigoTalla01_ = T2.CodigoTalla01_ ' +
    '  AND T1.CodigoColor_ = T2.CodigoColor_ ' +
    'WHERE ' +
    '  T1.PreparacionId = ' + IntToStr(LineaPL.IdPreparacion);
  SQL_Execute_NoRes ( Conn, sSQL );

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_UpdatePaletCaja', sPROC ) then
  begin

    sSQL :=
      'EXEC dbo.[' + sPROC + '] ' +
        IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
        IntToStr(IdPreparacion) + ', ' +
        IntToStr(IdExpedicion) + ', ' +
        IntToStr(PickingId) + ', ' +
        '''' + SQL_Str(CodigoArticulo) + ''', ' +
        '''' + SQL_Str(CodigoTalla) + ''', ' +
        '''' + SQL_Str(CodigoColor) + ''', ' +
        '''' + SQL_Str(Partida) + ''', ' +
        IntToStr(CodigoAgrupacion) + ', ' +
        SQL_FloatToStr(UnidadesAgrupacion) + ', ' +
        '''' + SQL_Str(UnidadMedida) + ''', ' +
        '''' + SQL_Str(UnidadMedidaBase) + ''', ' +
        SQL_FloatToStr(FactorConversion) + ', ' +
        IntToStr(PaletId) + ', ' +
        '''' + SQL_Str(Matricula) + ''', ' +
        IntToStr(CajaId) + ', ' +
        '''' + SQL_Str(Matricula) + '''';

    proc := TADOStoredProc.Create(nil);
    proc.Connection := Conn;
    proc.ProcedureName := 'dbo.[' + sPROC + ']';
    proc.Parameters.Refresh;

    proc.Parameters.ParamByName('@CodigoEmpresa').Value      := CodigoEmpresa.EmpresaOrigen;
    proc.Parameters.ParamByName('@IdPreparacion').Value      := IdPreparacion;
    proc.Parameters.ParamByName('@IdExpedicion').Value       := IdExpedicion;
    proc.Parameters.ParamByName('@PickingId').Value          := PickingId;
    proc.Parameters.ParamByName('@CodigoArticulo').Value     := CodigoArticulo;
    proc.Parameters.ParamByName('@CodigoTalla01_').Value     := CodigoTalla;
    proc.Parameters.ParamByName('@CodigoColor_').Value       := CodigoColor;
    proc.Parameters.ParamByName('@Partida').Value            := Partida;
    proc.Parameters.ParamByName('@CodigoAgrupacion').Value   := CodigoAgrupacion;
    proc.Parameters.ParamByName('@UnidadesAgrupacion').Value := UnidadesAgrupacion;
    proc.Parameters.ParamByName('@UnidadMedida').Value       := UnidadMedida;
    proc.Parameters.ParamByName('@UnidadMedidaBase').Value   := UnidadMedidaBase;
    proc.Parameters.ParamByName('@FactorConversion').Value   := FactorConversion;
    proc.Parameters.ParamByName('@PaletId').Value            := PaletId;
    proc.Parameters.ParamByName('@Matricula').Value          := Matricula;
    proc.Parameters.ParamByName('@CajaId').Value             := CajaId;
    proc.Parameters.ParamByName('@NuevoPaletID').Value       := 0;
    proc.Parameters.ParamByName('@NuevaMatricula').Value     := '';
    proc.Parameters.ParamByName('@NuevaCajaID').Value        := 0;

    proc.Prepared := TRUE;
    proc.ExecProc;

    PaletId   := proc.Parameters.ParamValues['@NuevoPaletID'];
    CajaId    := proc.Parameters.ParamValues['@NuevaCajaID'];

    FreeAndNil(proc);

  end else begin

    if CajaId>0 then
    begin
      if CodigoAgrupacion>0 then
      begin
        CajaId := CajaId + 1;
        sSQL :=
          'UPDATE FS_SGA_Picking_Preparaciones ' +
          'SET ' +
          '  CajaActual = ' + IntToStr(CajaId) + ' ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion);
        SQL_Execute_NoRes ( Conn, sSQL );
      end;
    end;

  end;

  // Purguem FS_SGA_AcumuladoPendiente
  if (PickingId<>0) and (Cantidad<0) then
  begin
    sSQL :=
      'DELETE FROM FS_SGA_AcumuladoPendiente ' +
      'WHERE ' +
      '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND Pickingid = ' + IntToStr(PickingId) + ' ' +
      '  AND CantidadBase = 0';
    SQL_Execute_NoRes ( Conn, sSQL) ;
  end;

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;
  LP.MovOrigen := gaMov.MovOrigen;
  LP.Matricula := gaMov.Matricula;

  LOG_Add ( Conn, CodigoUsuario, MACAddress, sRemoteAddr, 'EXPEDITE-LIN', 'Expedir línea ' + IntToStr(PickingId) + ' de la expedición', @LP );

  Result := '{"Result":"OK","Error":"","Data":[';

  Result := Result +
    '{' +
    '"PaletId":' + IntToStr(PaletId) + ',' +
    '"Matricula":"' + SQL_Str(Matricula) + '", ' +
    '"CajaId":' + IntToStr(CajaId) +
    '}';

  Result := Result + ']}';

  {$ENDREGION}

end;


procedure WebModule1expedirTodoAction (
  Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  IdPreparacion: Integer;
  IdExpedicion: Integer;
  PickingId: Integer;
  PaletId: Integer;
  CajaId: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  sPROCCustom: string;
  proc: TADOStoredProc;
  Matricula: String;
  UbicacionOrigen: TSGAUbicacion;
  UbicacionDestino: TSGAUbicacion;
  CodigoAlmacen: String;
  Tipo: String;
  PaletPackagingId: Integer;
  CajaPackagingId: Integer;
  JSonObject: TJSonObject;
  JSonValue: TJSONValue;
  DataArray: TJSONArray;
  Item: TJSONObject;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de preparación no es correcto","Data":[]}';
    Exit;
  end;

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  IdExpedicion     := StrToIntDef(contentfields.values['IdExpedicion'],0);
  PickingId        := StrToIntDef(contentfields.values['PickingId'],0);
  PaletId          := StrToIntDef(contentfields.values['PaletId'],1);
  Matricula        := contentfields.values['Matricula'];
  CajaId           := StrToIntDef(contentfields.values['CajaId'],1);
  CodigoUsuario    := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID             := contentfields.values['UUID'];
  CodigoAlmacen    := contentfields.Values['CodigoAlmacenDefecto'];
  Tipo             := AnsiUpperCase(Trim(contentfields.values['Tipo']));
  PaletPackagingId := StrToIntDef(contentfields.values['PaletPackagingId'],0);
  CajaPackagingId  := StrToIntDef(contentfields.values['CajaPackagingId'],0);

  if Matricula<>'' then
  begin
    UbicacionDestino := SGA_ALMACEN_GetUbicacionMatricula ( Conn, CodigoEmpresa, Matricula );
    if UbicacionDestino.CodigoUbicacion='' then
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La matrícula ' + Matricula + ' no tiene ubicación","Data":[]}';
      Exit;
    end;
  end;

  {$ENDREGION}

  {$REGION 'Retornem tot el material que està en palets i ho posem a la ubicació d´expedició'}

  FS_SGA_DevolverMaterialPaletAExpedicion ( Conn, CodigoEmpresa, CodigoAlmacen, CodigoUsuario, IdPreparacion, PickingId );

  {$ENDREGION}

  {$REGION 'Purguem dades'}

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_Purga_PackingList', sPROCCustom) then
  begin

    sSQL := 'EXEC dbo.[' + sPROCCustom + '] ' +
            IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
            IntToStr(IdPreparacion) + ', ' +
            IntToStr(IdExpedicion) + ', ' +
            IntToStr(PickingId);
    try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E:Exception do
      begin
        gaLogFile.Write_DBException(E,sSQL,'Error al purgar la preparación', CONST_LOGID_BBDD );
        Result := '{"Result":"ERROR","Message":"Error al purgar la preparación","Data":[]}';
        Exit;
      end;
    end;

  end;

  {$ENDREGION}

  {$REGION 'Cridem la funció de matrícules'}

  if Pos('CajaPackagingId', sParams)=0 then
  begin
    sParams := sParams +
      'Tipo=' + Tipo +
      '&PaletPackagingId=' + IntToStr(PaletPackagingId) +
      '&CajaPackagingId=' + IntToStr(CajaPackagingId);
  end;

  WebModule1updatePaletCajaActualAction ( Conn, sParams, sRemoteAddr, statusCode, statusText, Result );

  JSONObject := TJSONObject.ParseJSONValue(TEncoding.UTF8.GetBytes(Result), 0) as TJSONObject;
  try
    // Accedir al camp Data (és un array)
    DataArray := JSONObject.GetValue<TJSONArray>('Data');
    if (DataArray <> nil) and (DataArray.Count > 0) then
    begin
      Item             := DataArray.Items[0] as TJSONObject;
      PaletId          := Item.GetValue<Integer>('PaletActual');
      CajaId           := Item.GetValue<Integer>('CajaActual');
      PaletPackagingId := Item.GetValue<Integer>('PaletPackagingId');
      CajaPackagingId  := Item.GetValue<Integer>('CajaPackagingId');
    end;
  finally
    JSONObject.Free;
  end;

  {$ENDREGION}

  {$REGION 'Fem l`expedició'}

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_Expedir_Todo', sPROCCustom) then
  begin

    sSQL := 'EXEC dbo.[' + sPROCCustom + '] ' +
            IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
            IntToStr(IdPreparacion) + ', ' +
            IntToStr(IdExpedicion) + ', ' +
            IntToStr(PickingId) + ', ' +
            IntToStr(PaletId) + ', ' +
            '''' + SQL_Str(Matricula) + ''', ' +
            IntToStr(CajaId);


    try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E:Exception do
      begin
        gaLogFile.Write_DBException(E,sSQL,'Error al expedir toda la preparación', CONST_LOGID_BBDD );
        Result := '{"Result":"ERROR","Message":"Error al expedir toda la preparación","Data":[]}';
        Exit;
      end;
    end;
  end else begin
    Result := '{"Result":"ERROR","Message":"No existe el procedure para expedir toda la preparación","Data":[]}';
    Exit;
  end;

  if PickingId<>0 then
  begin

    if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_UpdatePaletCaja', sPROCCustom ) then
    begin

      sSQL :=
        'SELECT ' +
        '  IdentificadorExpedicion, CodigoArticulo, CodigoTalla01_, CodigoColor_, Partida, ' +
        '  CodigoAgrupacion, UnidadesAgrupacion, UnidadMedida, UnidadMedidaBase, FactorConversion ' +
        'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
        'WHERE ' +
        '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
        '  AND PickingId = ' + IntToStr(PickingId);

      Q := SQL_PrepareQuery ( Conn, sSQL );
      Q.Open;

      if not Q.EOF then
      begin

        proc := TADOStoredProc.Create(nil);
        proc.Connection := Conn;
        proc.ProcedureName := 'dbo.[' + sPROCCustom + ']';
        proc.Parameters.Refresh;

        proc.Parameters.ParamByName('@CodigoEmpresa').Value      := CodigoEmpresa.EmpresaOrigen;
        proc.Parameters.ParamByName('@IdPreparacion').Value      := IdPreparacion;
        proc.Parameters.ParamByName('@IdExpedicion').Value       := Q.FieldByName('IdentificadorExpedicion').AsString;
        proc.Parameters.ParamByName('@PickingId').Value          := PickingId;
        proc.Parameters.ParamByName('@CodigoArticulo').Value     := Q.FieldByName('CodigoArticulo').AsString;
        proc.Parameters.ParamByName('@CodigoTalla01_').Value     := Q.FieldByName('CodigoTalla01_').AsString;
        proc.Parameters.ParamByName('@CodigoColor_').Value       := Q.FieldByName('CodigoColor_').AsString;
        proc.Parameters.ParamByName('@Partida').Value            := Q.FieldByName('Partida').AsString;
        proc.Parameters.ParamByName('@CodigoAgrupacion').Value   := Q.FieldByName('CodigoAgrupacion').AsInteger;
        proc.Parameters.ParamByName('@UnidadesAgrupacion').Value := Q.FieldByName('UnidadesAgrupacion').AsFloat;
        proc.Parameters.ParamByName('@UnidadMedida').Value       := AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString);
        proc.Parameters.ParamByName('@UnidadMedidaBase').Value   := AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString);
        proc.Parameters.ParamByName('@FactorConversion').Value   := Q.FieldByName('FactorConversion').AsFloat;
        proc.Parameters.ParamByName('@PaletId').Value            := PaletId;
        proc.Parameters.ParamByName('@Matricula').Value          := Matricula;
        proc.Parameters.ParamByName('@CajaId').Value             := CajaId;
        proc.Parameters.ParamByName('@NuevoPaletID').Value       := 0;
        proc.Parameters.ParamByName('@NuevaMatricula').Value     := '';
        proc.Parameters.ParamByName('@NuevaCajaID').Value        := 0;

        proc.Prepared := TRUE;
        proc.ExecProc;

        PaletId   := proc.Parameters.ParamValues['@NuevoPaletID'];
        Matricula := proc.Parameters.ParamValues['@NuevaMatricula'];
        CajaId    := proc.Parameters.ParamValues['@NuevaCajaID'];

        FreeAndNil(proc);

      end;

      Q.Close;
      FreeAndNil(Q);

    end;

  end;

  Result := '{"Result":"OK","Error":"","Data":[';

  Result := Result +
    '{' +
    '"PaletId":' + IntToStr(PaletId) + ',' +
    '"Matricula":"' + JSON_Str(Matricula) + '",' +
    '"CajaId":' + IntToStr(CajaId) +
    '}';

  Result := Result + ']}';

  {$ENDREGION}

  {$REGION 'Movem tot el material que està a la ubicació d´expedició cap a la matrícula'}

  if Matricula<>'' then
  begin

    FS_SGA_MoverMaterialExpedicionAPalet ( Conn, CodigoEmpresa, CodigoAlmacen, CodigoUsuario, IdPreparacion, PickingId, Matricula );

  end;

  {$ENDREGION}

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;
  LP.Matricula := Matricula;

  if PickingId=0 then
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'EXPEDITE-ALL', 'Expedir toda la preparación', @LP )
  else
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'EXPEDITE-LIN', 'Expedir toda la línea ' + IntToStr(PickingId) + ' de la preparación', @LP );

end;


procedure WebModule1updatePaletCajaActualAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  IdPreparacion: Integer;
  PaletActual: Integer;
  PaletPackagingId: Integer;
  PaletPackagingId2: Integer;
  CajaActual: Integer;
  CajaPackagingId: Integer;
  CajaPackagingId2: Integer;
  MatriculaActual: String;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdPalet: Integer;
  IdCaja: Integer;
  iMaxCaja: Integer;
  Tipo: String;
  bMatricula: Boolean;
  bPalet: Boolean;
  bCaixa: Boolean;
  UpdatingMatricula: Boolean;
  UpdatingPalet: Boolean;
  UpdatingCaixa: Boolean;
  UpdatingPaletTipo: Boolean;
  UpdatingCaixaTipo: Boolean;
  sResult: string;
  UUID: string;
  Ejercicio: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de preparación no es correcto","Data":[]}';
    Exit;
  end;

  sSQL := 'SELECT Ejercicio FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  {
  http://192.168.1.16:8082/updatepaletcajaactual?CodigoEmpresa=1&IdPreparacion=8848&Tipo=MATR%C3%8DCULA%20Y%20CAJA&PaletActual=1&PaletPackagingId=1&CajaActual=1&CajaPackagingId=5&MatriculaActual=212345672500000038&CodigoUsuario=0
  }

  // NO;PALET;CAJA;PALET Y CAJA;MATRÍCULA;MATRÍCULA Y CAJA;BOX DE CLIENTE
  Tipo              := AnsiUpperCase(Trim(contentfields.values['Tipo']));
  bMatricula        := ((Tipo = 'MATRÍCULA') or (Tipo='MATRÍCULA Y CAJA'));
  bPalet            := ((Tipo = 'PALET') or (Tipo = 'PALET Y CAJA'));
  bCaixa            := ((Tipo = 'CAJA') or (Tipo = 'PALET Y CAJA') or (Tipo = 'MATRÍCULA Y CAJA'));
  PaletActual       := StrToIntDef(contentfields.values['PaletId'],0);
  PaletPackagingId2 := StrToIntDef(contentfields.values['PaletPackagingId'],0);
  CajaActual        := StrToIntDef(contentfields.values['CajaId'],0);
  CajaPackagingId2  := StrToIntDef(contentfields.values['CajaPackagingId'],0);
  MatriculaActual   := contentfields.values['Matricula'];
  CodigoUsuario     := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID              := contentfields.values['UUID'];

  // TOTES AQUESTES VARIABLES SÓN 'FALSE' SEMPRE
  UpdatingMatricula := (StrToIntDef(contentfields.values['UpdatingMatricula'],0)<>0);
  UpdatingPalet     := (StrToIntDef(contentfields.values['UpdatingPalet'],0)<>0);
  UpdatingCaixa     := (StrToIntDef(contentfields.values['UpdatingCaixa'],0)<>0);
  UpdatingPaletTipo := (StrToIntDef(contentfields.values['UpdatingPaletTipo'],0)<>0);
  UpdatingCaixaTipo := (StrToIntDef(contentfields.values['UpdatingCaixaTipo'],0)<>0);

  {$ENDREGION}

  {$REGION 'Actualitzem dades'}

  if bMatricula then
  begin

    // RECUPEREM EL PACKAGING ID DE LA MATRÍCULA
    sSQL :=
      'SELECT PackagingId ' +
      'FROM FS_SGA_Palet WITH (NOLOCK) ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
      '  AND Matricula = ''' + SQL_Str(MatriculaActual) + '''';
    PaletPackagingId := SQL_Execute ( Conn, sSQL );

    // MIREM SI LA MATRÍCULA PERTANY A UN PALET AMB ALGUNA COSA AL PACKING LIST
    sSQL :=
      'SELECT IdPalet ' +
      'FROM FS_SGA_PackingList_PackagingPalet WITH (NOLOCK) ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND Matricula = ''' + SQL_Str(MatriculaActual) + '''';
    IdPalet := SQL_Execute ( Conn, sSQL );

    if not bCaixa then
    begin
      IdCaja          := 1;
      CajaPackagingId := 0;
    end else begin
      if not UpdatingMatricula then
      begin
        IdCaja          := Abs(CajaActual);
        CajaPackagingId := CajaPackagingId2;
      end;
    end;

    // ESBORREM TOTS ELS PALETS QUE ENCARA NO S'HAN FET SERVIR
    if (IdPalet = 0) or (UpdatingMatricula) then
    begin

      sSQL :=
        'DELETE FROM FS_SGA_PackingList_PackagingPalet ' +
        'WHERE ' +
        '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
        '  AND Matricula NOT IN ( ' +
        '    SELECT Matricula ' +
        '    FROM FS_SGA_PackingList WITH (NOLOCK) ' +
        '    WHERE PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
        '  )';
      SQL_Execute_NoRes ( Conn, sSQL );

      // ESBORREM TOTES LES CAIXES QUE ENCARA NO S'HAN FET SERVIR
      sSQL :=
        'DELETE FROM FS_SGA_PackingList_PackagingCaja ' +
        'WHERE ' +
        '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
        '  AND Matricula NOT IN ( ' +
        '    SELECT Matricula ' +
        '    FROM FS_SGA_PackingList WITH (NOLOCK) ' +
        '    WHERE PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
        '  )';
      SQL_Execute_NoRes ( Conn, sSQL );

    end;

    // ELIMINEM LA MATRÍCULA ACTUAL
    sSQL :=
      'DELETE FROM FS_SGA_PackingList_PackagingPalet ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND Matricula = ''' + SQL_Str(MatriculaActual) + '''';
    SQL_Execute_NoRes ( Conn, sSQL );

    if (IdPalet = 0) then
    begin

      // MIREM QUIN NÚMERO DE PALET CORRESPON A LA MATRÍCULA
      sSQL :=
        'SELECT MAX(IdPalet) ' +
        'FROM FS_SGA_PackingList_PackagingPalet WITH (NOLOCK) ' +
        'WHERE ' +
        '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
        '  AND IdPreparacion = ' + IntToStr(IdPreparacion);
      IdPalet := SQL_Execute ( Conn, sSQL ) + 1;
      IdCaja  := 1;

    end else begin

      // SI LA MATRÍCULA JA EXISTEIX, MIREM SI LA CAIXA TAMBÉ EXISTEIX
      if not UpdatingMatricula then
      begin

        sSQL :=
          'SELECT IdCaja ' +
          'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
          '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND IdPalet = ' + IntToStr(IdPalet) + ' ' +
          '  AND Matricula = ''' + SQL_Str(MatriculaActual) + ''' ' +
          '  AND IdCaja = ' + IntToStr(Abs(CajaActual));
        IdCaja := SQL_Execute ( Conn, sSQL );

        if IdCaja = 0 then
        begin

          IdCaja          := Abs(CajaActual);
          CajaPackagingId := CajaPackagingId2;

        end else begin

          if UpdatingCaixaTipo then
          begin

            CajaPackagingId := CajaPackagingId2;

          end else begin

            sSQL :=
              'SELECT IdPackaging ' +
              'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
              'WHERE ' +
              '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
              '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
              '  AND IdPalet = ' + IntToStr(IdPalet) + ' ' +
              '  AND Matricula = ''' + SQL_Str(MatriculaActual) + ''' ' +
              '  AND IdCaja = ' + IntToStr(Abs(CajaActual));
            CajaPackagingId := SQL_Execute ( Conn, sSQL );

          end;

        end;

      end else begin

        // BUSQUEM L'ÚLTIMA CAIXA DE LA MATRÍCULA
        sSQL :=
          'SELECT MAX(IdCaja) ' +
          'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
          '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND IdPalet = ' + IntToStr(IdPalet) + ' ' +
          '  AND Matricula = ''' + SQL_Str(MatriculaActual) + '''';
        IdCaja := SQL_Execute ( Conn, sSQL );
        if IdCaja=0 then IdCaja := 1;

        sSQL :=
          'SELECT IdPackaging ' +
          'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
          '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND IdPalet = ' + IntToStr(IdPalet) + ' ' +
          '  AND Matricula = ''' + SQL_Str(MatriculaActual) + ''' ' +
          '  AND IdCaja = ' + IntToStr(Abs(IdCaja));
        CajaPackagingId := SQL_Execute ( Conn, sSQL );
        if CajaPackagingId=0 then CajaPackagingId := CajaPackagingId2;

      end;


      (*
      // SI LA MATRÍCULA JA EXISTEIX, BUSQUEM PER QUINA CAIXA ANEM
      sSQL :=
        'SELECT MAX(IdCaja) ' +
        'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
        'WHERE ' +
        '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
        '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
        '  AND Matricula = ''' + SQL_Str(MatriculaActual) + ''' ';
      IdCaja := SQL_Execute ( Conn, sSQL );
      if IdCaja=0 then IdCaja := 1;

      // RECUPEREM EL PACKAGING DE LA CAIXA DE LA MATRÍCULA
      sSQL :=
        'SELECT IdPackaging ' +
        'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
        'WHERE ' +
        '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
        '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
        '  AND IdPalet = ' + IntToStr(IdPalet) + ' ' +
        '  AND Matricula = ''' + SQL_Str(MatriculaActual) + ''' ' +
        '  AND IdCaja = ' + IntToStr(iMaxCaja);
      CajaPackagingId := SQL_Execute ( Conn, sSQL );
      *)

    end;

    // AFEGIM LA MATRÍCULA AL PACKING LIST DE PALETS
    sSQL :=
      'INSERT INTO FS_SGA_PackingList_PackagingPalet ( CodigoEmpresa, IdPreparacion, Ejercicio, IdPalet, Matricula, IdPackaging )' +
      'VALUES ( ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(IdPreparacion) + ', ' +
      IntToStr(Ejercicio) + ', ' +
      IntToStr(IdPalet) + ', ' +
      '''' + SQL_Str(MatriculaActual) + ''', ' +
      IntToStr(PaletPackagingId) + ' ' +
      ')';
    SQL_Execute_NoRes ( Conn, sSQL );

    // ELIMINEM LA CAIXA ACTUAL
    sSQL :=
      'DELETE FROM FS_SGA_PackingList_PackagingCaja ' +
      'WHERE ' +
      '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND IdPalet = ' + IntToStr(IdPalet) + ' ' +
      '  AND Matricula = ''' + SQL_Str(MatriculaActual) + ''' ' +
      '  AND IdCaja = ' + IntToStr(IdCaja);
    SQL_Execute_NoRes ( Conn, sSQL );

    sSQL :=
      'INSERT INTO FS_SGA_PackingList_PackagingCaja ( CodigoEmpresa, IdPreparacion, Ejercicio, IdPalet, Matricula, IdCaja, IdPackaging ) ' +
      'VALUES ( ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(IdPreparacion) + ', ' +
      IntToStr(Ejercicio) + ', ' +
      IntToStr(IdPalet) + ', ' +
      '''' + SQL_Str(MatriculaActual) + ''', ' +
      IntToStr(IdCaja) + ', ' +
      IntToStr(CajaPackagingId) + ' ' +
      ')';
    SQL_Execute_NoRes ( Conn, sSQL );

  end else begin // SENSE TRACTAMENT DE MATRÍCULES

    // MIREM SI EL PALET EL FEM SERVIR AL PACKING LIST
    sSQL :=
      'SELECT IdPalet ' +
      'FROM FS_SGA_PackingList_PackagingPalet WITH (NOLOCK) ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND IdPalet = ' + IntToStr(PaletActual);
    IdPalet := SQL_Execute ( Conn, sSQL );

    if (IdPalet<>0) and (UpdatingPalet) and (not UpdatingPaletTipo) then
    begin

      sSQL :=
        'SELECT IdPackaging ' +
        'FROM FS_SGA_PackingList_PackagingPalet WITH (NOLOCK) ' +
        'WHERE IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
        '  AND IdPalet = ' + IntToStr(IdPalet);

      PaletPackagingId := SQL_Execute ( Conn, sSQL );
      if PaletPackagingId = 0 then
        PaletPackagingId := PaletPackagingId2;

    end else begin

      PaletPackagingId := PaletPackagingId2;

    end;

    if not bCaixa then
    begin
      IdCaja          := 1;
      CajaPackagingId := 0;
    end else begin
      if not UpdatingPalet then
      begin
        IdCaja          := Abs(CajaActual);
        CajaPackagingId := CajaPackagingId2;
      end;
    end;

    // ESBORREM TOTS ELS PALETS QUE ENCARA NO S'HAN FET SERVIR
    if (IdPalet = 0) or (UpdatingPalet) then
    begin

      sSQL :=
        'DELETE FROM FS_SGA_PackingList_PackagingPalet ' +
        'WHERE ' +
        '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
        '  AND IdPalet NOT IN ( ' +
        '    SELECT PaletId ' +
        '    FROM FS_SGA_PackingList WITH (NOLOCK) ' +
        '    WHERE PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
        '  )';
      //SQL_Execute_NoRes ( Conn, sSQL );

      // ESBORREM TOTES LES CAIXES QUE ENCARA NO S'HAN FET SERVIR
      sSQL :=
        'DELETE FROM FS_SGA_PackingList_PackagingCaja ' +
        'WHERE ' +
        '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
        '  AND IdPalet NOT IN ( ' +
        '    SELECT PaletId ' +
        '    FROM FS_SGA_PackingList WITH (NOLOCK) ' +
        '    WHERE PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
        '  )';
      SQL_Execute_NoRes ( Conn, sSQL );

    end;

    // ELIMINEM EL PALET ACTUAL
    sSQL :=
      'DELETE FROM FS_SGA_PackingList_PackagingPalet ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND IdPalet = ' + IntToStr(PaletActual);
    SQL_Execute_NoRes ( Conn, sSQL );

    if (IdPalet = 0) then
    begin

      // MIREM QUIN NÚMERO DE PALET CORRESPON A LA MATRÍCULA
      sSQL :=
        'SELECT MAX(IdPalet) ' +
        'FROM FS_SGA_PackingList_PackagingPalet WITH (NOLOCK) ' +
        'WHERE ' +
        '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
        '  AND IdPreparacion = ' + IntToStr(IdPreparacion);
      IdPalet := SQL_Execute ( Conn, sSQL ) + 1;
      IdCaja  := 1;

    end else begin

      // SI EL PALET JA EXISTEIX, MIREM SI LA CAIXA TAMBÉ EXISTEIX
      if not UpdatingPalet then
      begin

        sSQL :=
          'SELECT IdCaja ' +
          'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
          '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND IdPalet = ' + IntToStr(IdPalet) + ' ' +
          '  AND IdCaja = ' + IntToStr(Abs(CajaActual));
        IdCaja := SQL_Execute ( Conn, sSQL );

        if IdCaja = 0 then
        begin

          IdCaja          := Abs(CajaActual);
          CajaPackagingId := CajaPackagingId2;

        end else begin

          if UpdatingCaixaTipo then
          begin

            CajaPackagingId := CajaPackagingId2;

          end else begin

            sSQL :=
              'SELECT IdPackaging ' +
              'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
              'WHERE ' +
              '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
              '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
              '  AND IdPalet = ' + IntToStr(IdPalet) + ' ' +
              '  AND IdCaja = ' + IntToStr(Abs(CajaActual));
            CajaPackagingId := SQL_Execute ( Conn, sSQL );

          end;

        end;

      end else begin

        // BUSQUEM L'ÚLTIMA CAIXA DEL PALET
        sSQL :=
          'SELECT MAX(IdCaja) ' +
          'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
          '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND IdPalet = ' + IntToStr(IdPalet) + ' ';
        IdCaja := SQL_Execute ( Conn, sSQL );
        if IdCaja=0 then IdCaja := 1;

        sSQL :=
          'SELECT IdPackaging ' +
          'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
          '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND IdPalet = ' + IntToStr(IdPalet) + ' ' +
          '  AND IdCaja = ' + IntToStr(Abs(IdCaja));
        CajaPackagingId := SQL_Execute ( Conn, sSQL );
        if CajaPackagingId=0 then CajaPackagingId := CajaPackagingId2;

      end;


      (*
      // SI LA MATRÍCULA JA EXISTEIX, BUSQUEM PER QUINA CAIXA ANEM
      sSQL :=
        'SELECT MAX(IdCaja) ' +
        'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
        'WHERE ' +
        '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
        '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
        '  AND Matricula = ''' + SQL_Str(MatriculaActual) + ''' ';
      IdCaja := SQL_Execute ( Conn, sSQL );
      if IdCaja=0 then IdCaja := 1;

      // RECUPEREM EL PACKAGING DE LA CAIXA DE LA MATRÍCULA
      sSQL :=
        'SELECT IdPackaging ' +
        'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
        'WHERE ' +
        '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
        '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
        '  AND IdPalet = ' + IntToStr(IdPalet) + ' ' +
        '  AND Matricula = ''' + SQL_Str(MatriculaActual) + ''' ' +
        '  AND IdCaja = ' + IntToStr(iMaxCaja);
      CajaPackagingId := SQL_Execute ( Conn, sSQL );
      *)

    end;

    // AFEGIM LA MATRÍCULA AL PACKING LIST DE PALETS
    sSQL :=
      'INSERT INTO FS_SGA_PackingList_PackagingPalet ( CodigoEmpresa, IdPreparacion, Ejercicio, IdPalet, Matricula, IdPackaging )' +
      'VALUES ( ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(IdPreparacion) + ', ' +
      IntToStr(Ejercicio) + ', ' +
      IntToStr(IdPalet) + ', ' +
      '''' + SQL_Str(MatriculaActual) + ''', ' +
      IntToStr(PaletPackagingId) + ' ' +
      ')';
    SQL_Execute_NoRes ( Conn, sSQL );

    // ELIMINEM LA CAIXA ACTUAL
    sSQL :=
      'DELETE FROM FS_SGA_PackingList_PackagingCaja ' +
      'WHERE ' +
      '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND IdPalet = ' + IntToStr(IdPalet) + ' ' +
      '  AND Matricula = ''' + SQL_Str(MatriculaActual) + ''' ' +
      '  AND IdCaja = ' + IntToStr(IdCaja);
    SQL_Execute_NoRes ( Conn, sSQL );

    sSQL :=
      'INSERT INTO FS_SGA_PackingList_PackagingCaja ( CodigoEmpresa, IdPreparacion, Ejercicio, IdPalet, Matricula, IdCaja, IdPackaging ) ' +
      'VALUES ( ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(IdPreparacion) + ', ' +
      IntToStr(Ejercicio) + ', ' +
      IntToStr(IdPalet) + ', ' +
      '''' + SQL_Str(MatriculaActual) + ''', ' +
      IntToStr(IdCaja) + ', ' +
      IntToStr(CajaPackagingId) + ' ' +
      ')';
    SQL_Execute_NoRes ( Conn, sSQL );
  end;

  sSQL :=
    'UPDATE FS_SGA_Picking_Preparaciones ' +
    'SET ' +
    '  MatriculaActual = ''' + SQL_Str(MatriculaActual) + ''', ' +
    '  PaletActual = ' + IntToStr(IdPalet) + ', ' +
    '  CajaActual = ' + IntToStr(IdCaja * Sign(CajaActual)) + ' ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion);
  SQL_Execute_NoRes ( Conn, sSQL );

  WebModule1listPackagingsPreparacionAction ( Conn, sParams, sRemoteAddr, statusCode, statusText, sResult );

  Result := '{"Result":"OK","Error":"","TotalRecords":0,"NumPages":0,"NumRecords":0,"Data":[' +
    '{' +
    '"MatriculaActual":"' + JSON_Str(MatriculaActual) + '",' +
    '"PaletActual":' + IntToStr(IdPalet) + ',' +
    '"CajaActual":' + IntToStr(IdCaja) + ',' +
    '"PaletPackagingId":' + IntToStr(PaletPackagingId) + ',' +
    '"CajaPackagingId":' + IntToStr(CajaPackagingId) + ',' +
    '"Packaging":[' + sResult + ']' +
    '}' +
  ']}';

  Exit;


  if (IdPalet=0) then // and (MatriculaActual<>'')
  begin

    sSQL :=
      'SELECT MAX(IdPalet) ' +
      'FROM FS_SGA_PackingList_PackagingPalet WITH (NOLOCK) ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND IdPreparacion = ' + IntToStr(IdPreparacion);
    IdPalet := SQL_Execute ( Conn, sSQL ) + 1;

    // BUSQUEM L'ÚLTIMA CAIXA DE LA NOVA MATRÍCULA
    sSQL :=
      'SELECT MAX(IdCaja) ' +
      'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND Matricula = ''' + SQL_Str(MatriculaActual) + ''' ';
    iMaxCaja := SQL_Execute ( Conn, sSQL );

  end else begin

    iMaxCaja := CajaActual;

  end;

  if iMaxCaja=0 then
  begin

    iMaxCaja := 1;

  end else begin

    // RECUPEREM EL PACKAGING DE L'ÚLTIMA CAIXA DE LA MATRÍCULA
    sSQL :=
      'SELECT IdPackaging ' +
      'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND IdPalet = ' + IntToStr(IdPalet) + ' ' +
      '  AND Matricula = ''' + SQL_Str(MatriculaActual) + ''' ' +
      '  AND IdCaja = ' + IntToStr(iMaxCaja);
    CajaPackagingId := SQL_Execute ( Conn, sSQL );
    if (IdPalet<>0) and ((CajaPackagingId = 0) or (CajaPackagingId<>CajaPackagingId2)) then
      CajaPackagingId := CajaPackagingId2;

    end;

  if IdPalet=0 then IdPalet := 1;
  CajaPackagingId := CajaPackagingId2;




  sSQL :=
    'UPDATE FS_SGA_Picking_Preparaciones ' +
    'SET ' +
    '  MatriculaActual = ''' + SQL_Str(MatriculaActual) + ''', ' +
    '  PaletActual = ' + IntToStr(IdPalet) + ', ' +
    '  CajaActual = ' + IntToStr(iMaxCaja) + ' ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion);
  SQL_Execute_NoRes ( Conn, sSQL );

  Result := '{"Result":"OK","Error":"","TotalRecords":0,"NumPages":0,"NumRecords":0,"Data":[' +
    '{' +
    '"actualCaja":' + IntToStr(iMaxCaja) + ',' +
    '"actualPalet":' + IntToStr(iMaxCaja) +
    '}' +
  ']}';

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;

  if UpdatingMatricula then
    LP.Matricula := MatriculaActual;

  if UpdatingPaletTipo then
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-PALLET-TYPE', 'Cambio del tipo del palet ' + IntToStr(IdPalet) + ' a ' + IntToStr(PaletPackagingId), @LP )
  else if UpdatingCaixaTipo then
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-BOX-TYPE', 'Cambio del tipo de la caja ' + IntToStr(IdCaja) + ' a ' + IntToStr(CajaPackagingId) , @LP )
  else if UpdatingPalet then
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-PALLET-NUMBER', 'Cambio del palet a ' + IntToStr(IdPalet), @LP )
  else if UpdatingCaixa then
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-BOX-NUMBER', 'Cambio de la caja a ' + IntToStr(IdPalet), @LP )
  else
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-PALLET-BOX', 'Cambio de palet/caja', @LP );

  Result := '{"Result":"OK","Error":"","Data":[]}';

end;


procedure WebModule1findPaletMatriculaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  IdPreparacion: Integer;
  PaletActual: Integer;
  CajaActual: Integer;
  Matricula: String;
  CodigoUsuario: Integer;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de preparación no es correcto","Data":[]}';
    Exit;
  end;

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  Matricula     := contentfields.values['Matricula'];
  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  if Matricula='' then
  begin
    PaletActual := 0;
    CajaActual  := 0;
    Result :=
    '{"Result":"OK","Error":"","Data":[' +
    '{' +
    '"PaletActual":' + IntToStr(PaletActual) + ',' +
    '"CajaActual":' + IntToStr(CajaActual) +
    '}' +
    ']}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Busquem les dades'}

  sSQL :=
    'SELECT IdPalet ' +
    'FROM FS_SGA_PackingList_PackagingPalet WITH (NOLOCK) ' +
    'WHERE ' +
    '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND Matricula = ''' + SQL_Str(Matricula) + '''';
  PaletActual := SQL_Execute ( Conn, sSQL );

  sSQL :=
    'SELECT MAX(IdCaja) ' +
    'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
    'WHERE ' +
    '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND Matricula = ''' + SQL_Str(Matricula) + '''';
  CajaActual := SQL_Execute ( Conn, sSQL );
  if CajaActual=0 then CajaActual := 1;

  Result :=
    '{"Result":"OK","Error":"","Data":[' +
    '{' +
    '"PaletActual":' + IntToStr(PaletActual) + ',' +
    '"CajaActual":' + IntToStr(CajaActual) +
    '}' +
    ']}';

end;


procedure WebModule1prepareServirPrepAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  IdPreparacion: Integer;
  CodigoUsuario: Integer;
  UnidadesExpedidas: Integer;
  SP: TServirPreparacion;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de preparación no es correcto","Data":[]}';
    Exit;
  end;

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  // Verifiquem que hi hagi quantitats expedides
  (*
  UnidadesExpedidas := FS_SGA_UnidadesExpedidas ( Conn, IdPreparacion );
  if UnidadesExpedidas <= 0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No hay ninguna unidad expedida en la preparación","Data":[' +
      '{"Msg":"No hay ninguna unidad expedida en la preparación"}' +
      ']}';
    Exit;
  end;
  *)                         

  if not FS_SGA_GetServirPrepStats ( Conn, CodigoEmpresa, IdPreparacion, SP ) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se ha podido recuperar la información de la preparación","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  Result := '{"Result":"OK","Error":"","Data":[{' +
    '"Estado":' + IntToStr(SP.Estado) + ',' +
    '"LineasAPreparar":' + IntToStr(SP.LineasAPreparar) + ',' +
    '"LineasPreparadas":' + IntToStr(SP.LineasPreparadas) + ',' +
    '"LineasExpedidas":' + IntToStr(SP.LineasExpedidas) + ',' +
    '"LineasExpedidasTotal":' + IntToStr(SP.LineasExpedidasTotal) + ',' +
    '"LineasExpedidasParcial":' + IntToStr(SP.LineasExpedidasParcial) + ',' +
    '"StockNegativoMsg":"' + JSON_Str(SP.StockNegativoMsg) + '",' +
    '"iStockNegativo":"' + IntToStr(SP.iStockNegativo) + '",' +
    '"bPendienteExpedir":' + SQL_BooleanToStr(SP.bPendienteExpedir) + ',' +
    '"Msg":"' + JSON_Str(SP.Msg) + '",' +
    '"Cajas":' + IntToStr(SP.Cajas) + ',' +
    '"Palets":' + IntToStr(SP.Palets) + '}]}';

end;


procedure WebModule1prepareServirRecAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  IdRecepcion: Integer;
  CodigoUsuario: Integer;
  UnidadesExpedidas: Integer;
  SR: TServirRecepcion;
  contentfields: TStringList;
  sResult: String;
  sMsg: String;
  bTallerExterno: Boolean;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdRecepcion := StrToIntDef(contentfields.values['IdRecepcion'],0);
  if IdRecepcion=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de recepción no es correcto","Data":[]}';
    Exit;
  end;

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  if not FS_SGA_GetServirRecStats ( Conn, CodigoEmpresa, IdRecepcion, SR ) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se ha podido recuperar la información de la recepción","Data":[]}';
    Exit;
  end;

  sResult := 'OK';
  sMsg := '';

  bTallerExterno := FS_SGA_CheckTallerExterno ( Conn, CodigoEmpresa, IdRecepcion, sResult, sMsg );

  {$ENDREGION}

  Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"' + JSON_Str(sResult) + '","Message":"' + JSON_Str(sMsg) + '","Data":[{' +
    '"CodigoEmpresa":' + IntToStr(SR.CodigoEmpresa) + ',' +
    '"EjercicioPedido":' + IntToStr(SR.EjercicioPedido) + ',' +
    '"SeriePedido":"' + JSON_Str(SR.SeriePedido) + '",' +
    '"NumeroPedido":' + IntToStr(SR.NumeroPedido) + ',' +
    '"Articulos":' + IntToStr(SR.Articulos) + ',' +
    '"LineasARecibir":' + IntToStr(SR.LineasARecibir) + ',' +
    '"LineasRecibidas":' + IntToStr(SR.LineasRecibidasTotal) + ',' +
    '"LineasRecibidasParcial":' + IntToStr(SR.LineasRecibidasParcial) + ',' +
    '"UnidadesPendientes":' + SQL_FloatToStr(SR.UnidadesPendientes) + ', ' +
    '"Cajas":' + IntToStr(SR.Cajas) + ',' +
    '"Palets":' + IntToStr(SR.Palets) + '}]}';



end;


procedure WebModule1prepareServirDevAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  IdDevolucion: Integer;
  CodigoUsuario: Integer;
  UnidadesExpedidas: Integer;
  SD: TServirDevolucion;
  contentfields: TStringList;
  sResult: String;
  sMsg: String;
  bTallerExterno: Boolean;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdDevolucion := StrToIntDef(contentfields.values['IdDevolucion'],0);
  if IdDevolucion=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de devolución no es correcto","Data":[]}';
    Exit;
  end;

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  if not FS_SGA_GetServirDevStats ( Conn, CodigoEmpresa, IdDevolucion, SD ) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se ha podido recuperar la información de la devolución","Data":[]}';
    Exit;
  end;

  sResult := 'OK';
  sMsg := '';

  bTallerExterno := FS_SGA_CheckTallerExterno ( Conn, CodigoEmpresa, IdDevolucion, sResult, sMsg );

  {$ENDREGION}

  Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"' + JSON_Str(sResult) + '","Message":"' + JSON_Str(sMsg) + '","Data":[{' +
    '"CodigoEmpresa":' + IntToStr(SD.CodigoEmpresa) + ',' +
    '"EjercicioPedido":' + IntToStr(SD.EjercicioPedido) + ',' +
    '"SeriePedido":"' + JSON_Str(SD.SeriePedido) + '",' +
    '"NumeroPedido":' + IntToStr(SD.NumeroPedido) + ',' +
    '"Articulos":' + IntToStr(SD.Articulos) + ',' +
    '"LineasADevolver":' + IntToStr(SD.LineasADevolver) + ',' +
    '"LineasDevueltas":' + IntToStr(SD.LineasDevueltasTotal) + ',' +
    '"LineasDevueltasParcial":' + IntToStr(SD.LineasDevueltasParcial) + ',' +
    '"UnidadesPendientes":' + SQL_FloatToStr(SD.UnidadesPendientes) + ', ' +
    '"Cajas":' + IntToStr(SD.Cajas) + ',' +
    '"Palets":' + IntToStr(SD.Palets) + '}]}';

end;


procedure WebModule1prepareServirDevProvAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  IdDevolucion: Integer;
  CodigoUsuario: Integer;
  UnidadesExpedidas: Integer;
  SD: TServirDevolucion;
  contentfields: TStringList;
  sResult: String;
  sMsg: String;
  bTallerExterno: Boolean;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdDevolucion := StrToIntDef(contentfields.values['IdDevolucion'],0);
  if IdDevolucion=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de devolución no es correcto","Data":[]}';
    Exit;
  end;

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  if not FS_SGA_GetServirDevProvStats ( Conn, CodigoEmpresa, IdDevolucion, SD ) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se ha podido recuperar la información de la devolución","Data":[]}';
    Exit;
  end;

  sResult := 'OK';
  sMsg := '';

  bTallerExterno := FS_SGA_CheckTallerExterno ( Conn, CodigoEmpresa, IdDevolucion, sResult, sMsg );

  {$ENDREGION}

  Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"' + JSON_Str(sResult) + '","Message":"' + JSON_Str(sMsg) + '","Data":[{' +
    '"CodigoEmpresa":' + IntToStr(SD.CodigoEmpresa) + ',' +
    '"EjercicioPedido":' + IntToStr(SD.EjercicioPedido) + ',' +
    '"SeriePedido":"' + JSON_Str(SD.SeriePedido) + '",' +
    '"NumeroPedido":' + IntToStr(SD.NumeroPedido) + ',' +
    '"Articulos":' + IntToStr(SD.Articulos) + ',' +
    '"LineasADevolver":' + IntToStr(SD.LineasADevolver) + ',' +
    '"LineasDevueltas":' + IntToStr(SD.LineasDevueltasTotal) + ',' +
    '"LineasDevueltasParcial":' + IntToStr(SD.LineasDevueltasParcial) + ',' +
    '"UnidadesPendientes":' + SQL_FloatToStr(SD.UnidadesPendientes) + ', ' +
    '"Cajas":' + IntToStr(SD.Cajas) + ',' +
    '"Palets":' + IntToStr(SD.Palets) + '}]}';

end;


procedure WebModule1generarInformeAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  IdInforme: Integer;
  IdObjeto: Integer;
  CodigoUsuario: Integer;
  sParams2: String;
  Impresora: String;
  contentfields: TStringList;
  bIsCustomReport: Boolean;
  sOperation: String;
  iStatus: Integer;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdInforme := StrToIntDef(contentfields.values['Informe'],0);
  if IdInforme=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de informe no es correcto","Data":[]}';
    Exit;
  end;

  IdObjeto := StrToIntDef(contentfields.values['Objeto'],0);
  if IdObjeto=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de objeto no es correcto","Data":[]}';
    Exit;
  end;

  Impresora := contentfields.Values['Impresora'];
  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];

  {$ENDREGION}

  {$REGION 'Enviem l´operació al LicenseServer'}

  sParams2 := '{' +
    '"CodigoEmpresa":' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ',' +
    '"Informe":' + IntToStr(IdInforme) + ',' +
    '"Objeto":' + IntToStr(IdObjeto) + ',' +
    '"Usuario":' + IntToStr(CodigoUsuario) + ', ' +
    '"Impresora":"' + JSON_Str(Impresora) + '"' +
  '}';

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_ActivarCustomReport, bIsCustomReport, CodigoEmpresa.EmpresaOrigen );

    if bIsCustomReport then
    begin
      sOperation := 'GENERARINFORME_CUSTOM';
      iStatus    := 50;
    end else begin
      sOperation := 'GENERARINFORME';
      iStatus    := 0;
    end;

  // Afegim un 1 a oper_num_retries perquè no intenti generar el document
  // més d'una vegada
  sSQL := 'INSERT INTO ' +
          '  FS_Operations ( oper_product_code, oper_name, oper_status, oper_ip_address, oper_datetime,' +
          '  oper_params, oper_CodigoEmpresa ) ' +
          'VALUES ( ' +
          '''' + SQL_Str(CONST_SGA) + ''', ' +
          '''' + SQL_Str(sOperation) + ''', ' +
          IntToStr(iStatus) + ', ' +
          '''' + SQL_Str(sRemoteAddr) + ''', ' +
          SQL_DateTimeToStr ( Now() ) + ', ' +
          '''' + sParams2 + ''', ' +
          IntToStr(CodigoEmpresa.EmpresaOrigen) + ' )';
  //gaLogFile.Write(sSQL, CONST_LOGID_BBDD, LOG_LEVEL_INFO );

  try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(E.Message) + '","Data":[]}';
      Exit;
    end;
  end;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'GENERATE-REP', 'Generar informe ' + IntToStr(IdInforme), nil );

  {$ENDREGION}

  Result := '{"Result":"OK","Error":"","Data":[]}';


end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LECTURA D'UN CODI DE BARRES GS1-128                                   │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getArticulo128DetailsAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Barcode: String;
  CodigoArticulo, CodigoArticuloAlt: String;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  JSonUnidadesMedida: String;
  contentfields: TStringList;
  Partida: string;
  Caducidad: TDateTime;
  Cantidad: Double;
  parser: TFSBarcodeParser;
  pbc: TFSParsedBarcode;
  DescripcionArticulo: String;
  TratamientoPartidas: Boolean;
  UnidadMedida: string;
  i: Integer;
  sFechaCaduca: string;
  CodigoAgrupacion: Integer;
  UnidadesAgrupacion: Double;
  YY: Integer;
  fSaldo: Double;
  CodigoColor: String;
  CodigoTalla: String;
  GrupoTalla: Integer;
  CantidadBase: Double;
  gsBarcodeFunction: string;
  DescripcionColor: string;
  DescripcionTalla: string;
  Matricula: String;
  sTipo: String;
  sResultUbi: string;
  Save: Boolean;
  UUID: string;
  Id: Integer;
  dFH: TDateTime;
  NumeroSerie: string;
  NumeroSerieFabricante: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  Barcode := contentfields.values['CodigoArticulo'];
  Save    := (StrToIntDef(contentfields.Values['Save'], 0 )<>0);
  UUID    := (contentfields.Values['UUID']);
  Id      := 0;

  gaLogFile.Write('Procesando código de barras: ' + Barcode, CONST_LOGID_GENERAL );

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  // Intentem parsejar el codi amb el parser genèric de GS1
  (*
  try
    parser := TFSBarcodeParser.Create;
    pbc    := parser.ParseBarcode(Barcode);
    FreeAndNil(parser);
  except
    on E:Exception do
    begin
      gaLogFile.Write_DBException(E,'','Error al parsear el código de barras: ' + Barcode, CONST_LOGID_GENERAL );
    end;
  end;

  if pbc.errorCode=0 then begin
    BarCode := '';
    for i := 0 to Length(pbc.parsedCodeItems) - 1 do
    begin
      BarCode := BarCode + '(' + pbc.parsedCodeItems[i].ai + ')' + VarToStr(pbc.parsedCodeItems[i].data);
    end;
  end;
  *)

  // Enviem la petició al procedure del SQL per recuperar la informació
  if SQL_Function_Exists ( Conn, 'FS_SGA_Barcode128_Read', gsBarcodeFunction ) then
    sSQL := 'SELECT * FROM dbo.[' + gsBarcodeFunction + '] ( ' + IntToStr(CodigoEmpresa.Articulos) + ', ''' + SQL_Str(Barcode) + ''' )'
  else
    sSQL := 'SELECT * FROM dbo.FS_SGA_Barcode128_Read ( ' + IntToStr(CodigoEmpresa.Articulos) + ', ''' + SQL_Str(Barcode) + ''' )';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do
    begin
      gaLogFile.Write_DBException(E,sSQL,'Error al recuperar los parámetros del GS1-128 vía procedure', CONST_LOGID_BBDD );
      Result := '{"Result":"ERROR","Message":"' + JSON_Str(E.Message) + '","Data":[]}';
      Exit;
    end;
  end;

  CodigoArticulo := Q.FieldByName('CodigoArticulo').AsString;
  if CodigoArticulo='' then begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Result":"ERROR","Message":"Código de artículo no encontrado","Data":[]}';
    Exit;
  end;

  if Save then
  begin

    dFH := Now();

    sSQL :=
      'INSERT INTO FS_SGA_LecturaCodigosArticulo ( ' +
      '  Fecha, UUID, CodigoArticulo, CodigoAlternativo, CodigoAlternativo2, CodigoAlternativoTC, TratamientoPartidas, TratamientoColores, ' +
      '  DescripcionArticulo, Descripcion2Articulo, Partida, Cantidad, UnidadMedida, UnidadMedida2, FactorConversion, Caducidad, ' +
      '  CodigoAgrupacion, UnidadesAgrupacion, GrupoTalla, CodigoColor, DescripcionColor, CodigoTalla, DescripcionTalla, CantidadBase, ' +
      '  Matricula, TratamientoSeries, NumeroSerie, NumeroSerieFabricante ) ' +
      'VALUES ( ' +
      SQL_DateTimeMSecToStr(dFH) + ', ' +
      '''' + SQL_Str(UUID) + ''', ' +
      '''' + Q.FieldByName('CodigoArticulo').AsString + ''', ' +
      '''' + Q.FieldByName('CodigoAlternativo').AsString + ''', ' +
      '''' + Q.FieldByName('CodigoAlternativo2').AsString + ''', ' +
      '''' + Q.FieldByName('CodigoAlternativoTC').AsString + ''', ' +
      IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) + ', ' +
      IntToStr(Q.FieldByName('TratamientoColores').AsInteger) + ', ' +
      '''' + Q.FieldByName('DescripcionArticulo').AsString + ''', ' +
      '''' + Q.FieldByName('Descripcion2Articulo').AsString + ''', ' +
      '''' + Q.FieldByName('Partida').AsString + ''', ' +
      SQL_FloatToStr(Q.FieldByName('Cantidad').AsFloat) + ', ' +
      '''' + AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString) + ''', ' +
      '''' + AnsiUpperCase(Q.FieldByName('UnidadMedida2').AsString) + ''', ' +
      SQL_FloatToStr(Q.FieldByName('FactorConversion').AsFloat) + ', ' +
      '''' + Q.FieldByName('Caducidad').AsString + ''', ' +
      IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ', ' +
      SQL_FloatToStr(Q.FieldByName('UnidadesAgrupacion').AsFloat) + ', ' +
      IntToStr(Q.FieldByName('GrupoTalla').AsInteger) + ', ' +
      '''' + Q.FieldByName('CodigoColor').AsString + ''', ' +
      '''' + Q.FieldByName('DescripcionColor').AsString + ''', ' +
      '''' + Q.FieldByName('CodigoTalla').AsString + ''', ' +
      '''' + Q.FieldByName('DescripcionTalla').AsString + ''', ' +
      SQL_FloatToStr(Q.FieldByName('CantidadBase').AsFloat) + ', ' +
      '''' + Q.FieldByName('Matricula').AsString + ''', ' +
      IntToStr(Q.FieldByName('TratamientoSeries').AsInteger) + ', ' +
      '''' + Q.FieldByName('NumeroSerie').AsString + ''', ' +
      '''' + Q.FieldByName('NumeroSerieFabricante').AsString + ''' ' +
      ')';

    SQL_Execute_NoRes ( Conn, sSQL );

    Id := SQL_Execute ( Conn, 'SELECT SCOPE_IDENTITY()' );

  end;

  JSonUnidadesMedida := SGA_FS_ARTICULO_Obtener_UnidadesMedida ( Conn, CodigoEmpresa, CodigoArticulo );

  Partida               := Q.FieldByName('Partida').AsString;
  Cantidad              := Q.FieldByName('Cantidad').AsFloat;
  Caducidad             := Q.FieldByName('Caducidad').AsDateTime;
  CodigoAgrupacion      := Q.FieldByName('CodigoAgrupacion').AsInteger;
  UnidadesAgrupacion    := Q.FieldByName('UnidadesAgrupacion').AsFloat;
  CodigoColor           := Q.FieldByName('CodigoColor').AsString;
  DescripcionColor      := Q.FieldByName('DescripcionColor').AsString;
  CodigoTalla           := Q.FieldByName('CodigoTalla').AsString;
  DescripcionTalla      := Q.FieldByName('DescripcionTalla').AsString;
  GrupoTalla            := Q.FieldByName('GrupoTalla').AsInteger;
  CantidadBase          := Q.FieldByName('CantidadBase').AsFloat;
  Matricula             := Q.FieldByName('Matricula').AsString;
  NumeroSerie           := Q.FieldByName('NumeroSerie').AsString;
  NumeroSerieFabricante := Q.FieldByName('NumeroSerieFabricante').AsString;

  sResultUbi := '{"Estado":0}';
  if Matricula<>'' then
  begin
    sParams := sParams + '&Matricula=' + Matricula;
    WebModule1findUbicacionMatriculaAction ( Conn, sParams, sRemoteAddr, statusCode, statusText, sResultUbi );
  end;

  if UnidadesAgrupacion=0 then
  begin
    CodigoAgrupacion   := 0;
    UnidadesAgrupacion := 1;
  end;

  if Caducidad=0 then
    sFechaCaduca := ''
  else
    sFechaCaduca := FormatDateTime('dd/mm/yyyy', Caducidad);

  sSQL := 'SELECT dbo.FS_PERIODOACTIVO ( ' + IntToStr(EmpresaOrigen) + ', ' + SQL_DateToStr(Now()) + ' )';
  YY := SQL_Execute ( conn, sSQL );

  sSQL :=
    'SELECT ' +
    '  UnidadesSaldo ' +
    'FROM FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', ' + IntToStr(YY) + ' ) ' +
    'WHERE ' +
    '  CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
    '  AND UnidadesSaldo>0 ';

  if Partida<>'' then
    sSQL := sSQL + '  AND Partida = ''' + SQL_Str(Partida) + ''' ';

  fSaldo := SQL_Execute ( Conn, sSQL );

  if Matricula<>'' then
    sTipo := '50'
  else
    sTipo := '1';

  Result := '{"Result":"OK","Error":"","Data":[' +
    '{' +
    '"Id":' + IntToStr(Id) + ',' +
    '"FechaHora":"' + FormatDateTime('dd/mm/yyyy hh:nn:ss.zzz', dFH ) + '",' +
    '"UUID":"' + JSON_Str(UUID) + '",' +
    '"Tipo":' + sTipo + ',' +
    '"CodigoArticulo":"' + JSON_Str(CodigoArticulo) + '",' +
    '"CodigoArticuloAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
    '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
    '"CodigoAlternativo2":"' + JSON_Str(Q.FieldByName('CodigoAlternativo2').AsString) + '",' +
    '"CodigoAlternativoTC":"' + JSON_Str(Q.FieldByName('CodigoAlternativoTC').AsString) + '",' +
    '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
    '"TratamientoPartidas":' + IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) + ',' +
    '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TratamientoSeries').AsInteger<>0) + ',' +
    '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('TratamientoColores').AsInteger<>0) + ',' +
    '"GrupoTalla":' + IntToStr(GrupoTalla) + ',' +
    '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
    '"Cantidad":' + SQL_FloatToStr(Cantidad) + ',' +
    '"Saldo":' + SQL_FloatToStr(fSaldo) + ',' +
    '"FechaCaduca":"' + sFechaCaduca + '",' +
    '"CodigoAgrupacion":' + IntToStr(CodigoAgrupacion) + ',' +
    '"UnidadesAgrupacion":' + SQL_FloatToStr(UnidadesAgrupacion) + ',' +
    '"CodigoTalla":"' + JSON_Str(CodigoTalla) + '",' +
    '"DescripcionTalla":"' + JSON_Str(DescripcionTalla) + '",' +
    '"CodigoColor":"' + JSON_Str(CodigoColor) + '",' +
    '"DescripcionColor":"' + JSON_Str(DescripcionColor) + '",' +
    '"CantidadBase":' + SQL_FloatToStr(CantidadBase) + ',' +
    '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion').AsFloat) + ',' +
    '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
    '"Matricula":"' + JSON_Str(Matricula) + '",' +
    '"NumeroSerie":"' + JSON_Str(NumeroSerie) + '",' +
    '"NumeroSerieFabricante":"' + JSON_Str(NumeroSerieFabricante) + '",' +
    '"Ubicacion":' + sResultUbi + ',' +
    JSonUnidadesMedida +
    '}]}';

  SQL_CloseFree(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT D'ARTICLES D'UNA UBICACIÓ DEL MAGATZEM                        │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getArticuloDetailsAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoArticulo: String;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  JSonUnidadesMedida: String;
  contentfields: TStringList;
  sExtraField01: String;
  sFUNCCustom: String;
  sUnidadMedidaAlternativa: String;
  sUnidadMedida2: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoArticulo := contentfields.values['CodigoArticulo'];

  if CodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  // Recuperem les unitats de mesura

  sExtraField01 := '';
  if SQL_Function_Exists ( Conn, 'FS_SGA_Articulo_ExtraInfo', sFUNCCustom ) then
  begin

    sSQL := 'SELECT dbo.[' + sFUNCCustom + '] ( ' +
      IntToStr(CodigoEmpresa.Articulos) + ', ' +
      '''' + SQL_Str(CodigoArticulo) + ''' )';
    sExtraField01 := SQL_Execute ( Conn, sSQL );

  end;

  JSonUnidadesMedida := SGA_FS_ARTICULO_Obtener_UnidadesMedida ( Conn, CodigoEmpresa, CodigoArticulo );

  sSQL := 'SELECT ' +
          '  art.* ' +
          'FROM dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
          'WHERE ' +
          '  (art.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' OR ' +
          '  art.CodigoAlternativo = ''' + SQL_Str(CodigoArticulo) + ''' OR ' +
          '  art.CodigoAlternativo2 = ''' + SQL_Str(CodigoArticulo) + ''') ';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Q.EOF then
  begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo incorrecto","Data":[]}';
    Exit;
  end;

  Result := '{"Result":"OK","Error":"","Data":[';

  if not Q.Eof then begin

    sUnidadMedidaAlternativa := AnsiUpperCase(Q.FieldByName('UnidadMedidaAlternativa_').AsString);
    sUnidadMedida2           := AnsiUpperCase(Q.FieldByName('UnidadMedida2_').AsString);

    if sUnidadMedidaAlternativa='' then
    begin
      sUnidadMedidaAlternativa := sUnidadMedida2;
      sUnidadMedida2           := '';
    end;

    Result := Result +
      '{' +
      '"Tipo":1,' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
      '"CodigoArticuloAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"CodigoAlternativo2":"' + JSON_Str(Q.FieldByName('CodigoAlternativo2').AsString) + '",' +
      '"CodigoAlternativoTC":"",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"Descripcion2Articulo":"' + JSON_Str(Q.FieldByName('Descripcion2Articulo').AsString) + '",' +
      '"TratamientoPartidas":' + IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('Colores_').AsInteger<>0) + ',' +
      '"GrupoTalla":' + Q.FieldByName('GrupoTalla_').AsString + ',' +
      '"CodigoAgrupacion":0,' +
      '"UnidadesAgrupacion":1,' +
      '"Partida":"",' +
      '"FechaCaduca":"",' +
      '"CodigoTalla":"",' +
      '"CodigoColor":"",' +
      '"DescripcionTalla":"",' +
      '"DescripcionColor":"",' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(sUnidadMedidaAlternativa)) + '",' +
      '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(sUnidadMedida2)) + '",' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion_').AsFloat) + ',' +
      '"ExtraField01":"' + JSON_Str(sExtraField01) + '",' +
      '"Cantidad":0,' +
      '"CantidadBase":0,' +
      JSonUnidadesMedida +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT D'ARTICLES D'UNA UBICACIÓ DEL MAGATZEM                        │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listArticulosUbicacionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoAlmacen: String;
  sSQL, sSQL2: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoUbicacion: string;
  Ejercicio: Integer;
  EmpresaOrigen: Integer;
  OrdenarPor: String;
  Desglosar: Boolean;
  CodigoTalla: String;
  CodigoColor: String;
  Partida: String;
  TipoOrden: String;
  sOrderBy: String;
  CodigoArticulo: string;
  sFiltre: string;
  JSonUnidadesMedida: String;
  contentfields: TStringList;
  UUID: String;
  Matricula: String;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  UUID := (contentfields.Values['UUID']);

  Matricula := contentfields.values['Matricula'];
  CodigoAlmacen := contentfields.values['CodigoAlmacen'];
  if CodigoAlmacen='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    Exit;
  end;

  CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);

  // Conversió al codi d'article real
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación no especificado","Data":[]}';
    Exit;
  end;

  Desglosar := (AnsiUpperCase(trim(contentfields.values['Desglosar']))='TRUE');
  CodigoArticulo := (contentfields.values['CodigoArticulo']);
  CodigoTalla := (contentfields.values['CodigoTalla']);
  CodigoColor := (contentfields.values['CodigoColor']);
  Partida := (contentfields.values['Partida']);

  // Conversió al codi d'article real
  if CodigoArticulo<>'' then begin
    CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );
    if CodigoArticulo='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo especificado incorrecto","Data":[]}';
      Exit;
    end;
  end;

  Ejercicio := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  OrdenarPor := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden  := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy   := '';

  if OrdenarPor='FECHAENTRADA' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsas.FechaUltimaEntrada DESC, fsas.CodigoArticulo DESC, fsas.Partida DESC ';
    end else begin
      sOrderBy := 'fsas.FechaUltimaEntrada, fsas.CodigoArticulo, fsas.Partida ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'fsas.CodigoArticulo DESC, fsas.Partida DESC ';
    end else begin
      sOrderBy := 'fsas.CodigoArticulo, fsas.Partida ';
    end;
  end;

  sFiltre := '';
  if CodigoArticulo<>'' then
  begin
    sFiltre := sFiltre + 'AND fsas.CodigoArticulo=''' + SQL_Str(CodigoArticulo) + ''' ';
  end;

  if Partida<>'' then
  begin
    sFiltre := sFiltre + 'AND fsas.Partida=''' + SQL_Str(Partida) + ''' ';
  end;

  if CodigoTalla<>'' then
  begin
    sFiltre := sFiltre + 'AND fsas.CodigoTalla01_=''' + SQL_Str(CodigoTalla) + ''' ';
  end;

  if CodigoColor<>'' then
  begin
    sFiltre := sFiltre + 'AND fsas.CodigoColor_=''' + SQL_Str(CodigoColor) + ''' ';
  end;


  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM dbo.FS_SGA_TABLE_AcumuladoStock ( ' + IntToStr(CodigoEmpresa.Stocks) + ' ) fsas ' +
          'WHERE ' +
          '  CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ' +
          '  AND CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + ''' ' +
          '  AND Matricula = ''' + SQL_Str(Matricula) + ''' ' +
          '  AND Ejercicio = ' + IntToStr(Ejercicio) + ' ' +
          '  AND Periodo = 99 ' +
          '  AND (UnidadesSaldo <> 0 OR UnidadesSaldo <> 0) ' +
          sFiltre;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'a', '' );

  sSQL :=
    'SELECT ' +
    '''' + SQL_Str(UUID) + ''' AS UUID, ' +
    '  fsas.Partida, ' +
    '  fsas.UnidadesSaldo,' +
    '  fsas.UnidadesSaldoBase, ' +
    '  fsas.UnidadesSaldoBase * a.PesoBrutoUnitario_ AS PesoBruto, ' +
    '  fsas.UnidadesSaldoBase * a.PesoNetoUnitario_ AS PesoNeto, ' +
    '  fsas.UnidadesSaldoBase * a.VolumenUnitario_ AS Volumen, ' +
    '  fsas.CodigoColor_, ' +
    '  fsas.CodigoTalla01_, ' +
    '  fsas.CodigoArticulo, ' +
    '  a.DescripcionArticulo, ' +
    '  a.Descripcion2Articulo, ' +
    '  a.CodigoAlternativo, ' +
    '  a.CodigoAlternativo2, ' +
    '  CTC.CodigoAlternativo AS CodigoAlternativoTC, ' +
    '  a.TratamientoPartidas, ' +
    sFieldTratamientoSeries + 'AS TrataNumerosSerieLc, ' +
    '  a.Colores_, ' +
    '  a.FactorConversion_, ' +
    '  a.GrupoTalla_, ' +
    '  fsas.FechaUltimaEntrada, ' +
    '  fsas.UnidadMedida, ' +
    '  fsas.UnidadMedidaBase, ' +
    '  fsas.FechaCaduca, ' +
    '  c.Color_ AS DescripcionColor, ' +
    '  t.DescripcionTalla01_ AS DescripcionTalla ' +
    'FROM dbo.FS_SGA_TABLE_AcumuladoStock ( ' + IntToStr(CodigoEmpresa.Stocks) + ' ) fsas ' +
    'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) a ' +
    'ON ' +
    '  fsas.CodigoArticulo = a.CodigoArticulo ' +
    'LEFT JOIN Colores_ c WITH (NOLOCK) ' +
    'ON ' +
    '  c.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
    '  AND c.CodigoColor_ = fsas.CodigoColor_ ' +
    'LEFT JOIN Vis_VistaTallas t WITH (NOLOCK) ' +
    'ON ' +
    '  t.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
    '  AND t.GrupoTalla_= a.GrupoTalla_ ' +
    '  AND t.CodigoTalla01_ = fsas.CodigoTalla01_ ' +
    'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
    'ON ' +
    '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
    '  AND CTC.CodigoArticulo = fsas.CodigoArticulo ' +
    '  AND CTC.CodigoTalla01_ = fsas.CodigoTalla01_ ' +
    '  AND CTC.CodigoColor_ = fsas.CodigoColor_ ' +
    'WHERE ' +
    '  fsas.CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ' +
    '  AND fsas.CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + ''' ' +
    '  AND fsas.Matricula = ''' + SQL_Str(Matricula) + ''' ' +
    '  AND fsas.Ejercicio = ' + IntToStr(Ejercicio) + ' ' +
    '  AND fsas.Periodo = 99 ' +
    '  AND (fsas.UnidadesSaldo<>0 OR fsas.UnidadesSaldoBase<>0) ' +
    sFiltre +
    'ORDER BY ' +
    sOrderBy +
    'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
    'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  if Desglosar then
  begin

    sSQL2 :=
      'DELETE FROM FS_SGA_TraspasosTemp ' +
      'WHERE ' +
      '  UUID = ''' + SQL_Str(UUID) + '''';
    SQL_Execute_NoRes ( Conn, sSQL2 );

    sSQL2 :=
      'INSERT INTO FS_SGA_TraspasosTemp ( UUID, Partida, UnidadesSaldo, UnidadesSaldoBase, PesoBruto, ' +
      '  PesoNeto, Volumen, CodigoColor_, CodigoTalla01_, CodigoArticulo, DescripcionArticulo, ' +
      '  Descripcion2Articulo, CodigoAlternativo, CodigoAlternativo2, CodigoAlternativoTC, TratamientoPartidas, ' +
      '  Colores_, FactorConversion_, GrupoTalla_, FechaUltimaEntrada, UnidadMedida, UnidadMedidaBase, ' +
      '  FechaCaduca, DescripcionColor, DescripcionTalla ) ' +
    sSQL;
    SQL_Execute_NoRes ( Conn, sSQL2 );

  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    CodigoArticulo := Q.FieldByName('CodigoArticulo').AsString;
    Inc(iNumRegs);

    JSonUnidadesMedida := SGA_FS_ARTICULO_Obtener_UnidadesMedida ( Conn, CodigoEmpresa, CodigoArticulo );

    Result := Result + '{' +
      '"CodigoArticulo":"' + JSON_Str(CodigoArticulo) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"Descripcion2Articulo":"' + JSON_Str(Q.FieldByName('Descripcion2Articulo').AsString) + '",' +
      '"CodigoArticuloAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"CodigoAlternativo2":"' + JSON_Str(Q.FieldByName('CodigoAlternativo2').AsString) + '",' +
      '"CodigoAlternativoTC":"' + JSON_Str(Q.FieldByName('CodigoAlternativoTC').AsString) + '",' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion_').AsFloat) + ',' +
      //'"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '",' +
      '"FechaCaduca":"' + JSON_Str(Q.FieldByName('FechaCaduca').AsString) + '",' +
      '"FechaUltimaEntrada":"' + JSON_Str(Q.FieldByName('FechaUltimaEntrada').AsString) + '",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"GrupoTalla":' + IntToStr(Q.FieldByName('GrupoTalla_').AsInteger) + ',' +
      '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
      '"DescripcionTalla":"' + JSON_Str(Q.FieldByName('DescripcionTalla').AsString) + '",' +
      '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
      '"DescripcionColor":"' + JSON_Str(Q.FieldByName('DescripcionColor').AsString) + '",' +
      '"UnidadesSaldo":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldo').AsFloat) + ',' +
      '"UnidadesSaldoBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldoBase').AsFloat) + ',' +
      '"TratamientoPartidas":' + IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('Colores_').AsInteger<>0) + ',' +
      '"PesoNeto":' + SQL_FloatToStr(Q.FieldByName('PesoNeto').AsFloat) + ',' +
      '"PesoBruto":' + SQL_FloatToStr(Q.FieldByName('PesoBruto').AsFloat) + ',' +
      '"Volumen":' + SQL_FloatToStr(Q.FieldByName('Volumen').AsFloat) + ',' +
      '"Selected":1,' +
      JSonUnidadesMedida +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT DE PASSADISSOS D'UN MAGATZEM                                  │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getPasilloAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoAlmacen: String;
  CodigoZona: String;
  sAndWhere: String;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoAlmacen := contentfields.values['CodigoAlmacen'];
  if CodigoAlmacen='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    Exit;
  end;

  CodigoZona := (contentfields.values['CodigoZona']);

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sAndWhere := '';

  if CodigoZona<>'' then begin
    sAndWhere := sAndWhere + ' AND u.CodigoZona = ''' + SQL_Str(CodigoZona) + ''' ';
  end;

  sSQL := 'SELECT ' +
          '  COUNT(DISTINCT p.CodigoPasillo) '+
          'FROM FS_SGA_TABLE_ESTR_Pasillos ( ' + IntToStr(CodigoEmpresa.Almacenes) + ') p ' +
          'LEFT JOIN dbo.FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) u ' +
          'ON ' +
          '  p.CodigoPasillo = u.CodigoPasillo ' +
          'WHERE ' +
          '  p.CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ' +
          sAndWhere;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  DISTINCT p.CodigoEmpresa, p.CodigoAlmacen, p.CodigoPasillo, p.DescripcionPasillo, p.Tipo '+
          'FROM FS_SGA_TABLE_ESTR_Pasillos ( ' + IntToStr(CodigoEmpresa.Almacenes) + ') p ' +
          'LEFT JOIN dbo.FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) u ' +
          'ON ' +
          '  p.CodigoPasillo = u.CodigoPasillo ' +
          'WHERE ' +
          '  p.CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ' +
          sAndWhere +
          'ORDER BY ' +
          '  CodigoPasillo '; // +
//          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
//          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
      '"CodigoPasillo":"' + JSON_Str(Q.FieldByName('CodigoPasillo').AsString) + '",' +
      '"Tipo":"' + JSON_Str(Q.FieldByName('Tipo').AsString) + '",' +
      '"DescripcionPasillo":"' + JSON_Str(Q.FieldByName('DescripcionPasillo').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT D'UBICACIONS D'UNA ZONA DEL MAGATZEM                          │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getUbicacionesAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoAlmacen: String;
  CodigoZona: String;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoPasillo: String;
  CodigoEstanteria: String;
  andWhere: String;
  Tipo: String;
  CodigoArticulo: String;
  Partida: String;
  EmpresaOrigen: Integer;
  Pasillo: String;
  YY: Integer;
  contentfields: TStringList;
  CodigoTalla: String;
  CodigoColor: String;
  HideAlmacen: String;
  Filtros: boolean;
  sFechaPrimeraEntrada: String;
  sFechaCaduca: String;
  UnidadMedida: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoAlmacen := (contentfields.values['CodigoAlmacen']);
  (*
  if CodigoAlmacen='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    Exit;
  end;
  *)

  Tipo             := AnsiUpperCase((contentfields.values['Tipo']));
  CodigoArticulo   := AnsiUpperCase((contentfields.values['CodigoArticulo']));
  Partida          := AnsiUpperCase((contentfields.values['Partida']));
  CodigoTalla      := contentfields.values['CodigoTalla'];
  CodigoColor      := contentfields.values['CodigoColor'];
  CodigoZona       := (contentfields.values['CodigoZona']);
  CodigoPasillo    := (contentfields.values['CodigoPasillo']);
  CodigoEstanteria := (contentfields.values['CodigoEstanteria']);
  UnidadMedida     := AnsiUpperCase(contentfields.Values['UnidadMedida']);
  HideAlmacen      := trim(contentfields.values['HideAlmacen']);
  Pasillo          := (contentfields.values['Pasillo']);
  Filtros          := (AnsiUpperCase(trim(contentfields.values['Filtros']))<>'0');
  YY               := SGA_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );

  andWhere := '';

  if CodigoZona<>'' then begin
    andWhere := andWhere + ' AND fsu.CodigoZona = ''' + SQL_Str(CodigoZona) + ''' ';
  end;

  if HideAlmacen<>'' then begin
    andWhere := andWhere + ' AND fsu.CodigoAlmacen <> ''' + SQL_Str(HideAlmacen) + ''' ';
  end;

  if CodigoPasillo<>'' then begin
    andWhere := andWhere + ' AND fsu.CodigoPasillo = ''' + SQL_Str(CodigoPasillo) + ''' ';
  end;

  if CodigoEstanteria<>'' then begin
    andWhere := andWhere + ' AND fsu.CodigoEstanteria = ''' + SQL_Str(CodigoEstanteria) + ''' ';
  end;

  if Pasillo<>'' then begin
    andWhere := andWhere + ' AND fsu.CodigoAlternativo LIKE ''' + SQL_Str(Pasillo) + '%'' ';
  end;

  if CodigoArticulo<>'' then
  begin
    andWhere := andWhere + ' AND fsas.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ';
  end;

  if UnidadMedida<>'' then
  begin
    andWhere := andWhere + ' AND fsas.UnidadMedida = ''' + SQL_Str(AnsiUpperCase(UnidadMedida)) + ''' ';
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(DISTINCT fsu.CodigoUbicacion) ' +
          'FROM FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) fsu ' +
          'LEFT JOIN FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', ' + IntToStr(YY) + ' ) fsas ' +
          'ON ' +
          '  fsu.CodigoAlmacen = fsas.CodigoAlmacen AND ' +
          '  fsu.CodigoUbicacion = fsas.CodigoUbicacion ' +
          'WHERE ' +
          '  1 = 1 ';

  if CodigoAlmacen<>'' then
    sSQL := sSQL +
      ' AND fsu.CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ';

  sSQL := sSQL +
    andWhere;

  if Tipo='EMPTY' then
    sSQL := sSQL + ' AND fsas.CodigoArticulo IS NULL'
  else begin

    if CodigoArticulo<>'' then
      sSQL := sSQL + ' AND fsas.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ';

    if Filtros then
    begin
      if Partida<>'' then
        sSQL := sSQL + ' AND fsas.Partida = ''' + SQL_Str(Partida) + ''' ';
      if CodigoTalla<>'' then
        sSQL := sSQL + ' AND fsas.CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ';
      if CodigoColor<>'' then
        sSQL := sSQL + ' AND fsas.CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ';
    end;

  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT DISTINCT ' +
    '  fsu.CodigoAlmacen, fsu.CodigoZona, fsu.CodigoUbicacion, fsu.CodigoPasillo, fsu.CodigoEstanteria, ' +
    '  fsu.Altura, fsu.Fondo, fsu.CodigoAlternativo, fsu.Bloqueada, fsu.MultiRef, fsu.MonoRef, fsu.MultiLote, ' +
    '  fsu.Picking, fsu.Rotacion, ISNULL(fsu.Transito,0) AS Transito, fsu.Inactiva, fsas.CodigoArticulo, ' +
    '  fsas.Partida, fsas.UnidadesSaldo, fsas.UnidadesSaldoBase, fsas.UnidadMedida, fsas.UnidadMedidaBase, ' +
    '  fsas.FactorConversion_, art.GrupoTalla_, fsas.CodigoTalla01_, fsas.CodigoColor_, ' +
    '  T.DescripcionTalla01_ as DescripcionTalla, C.Color_ AS DescripcionColor, ' +
    '  fsas.FechaCaduca, fsas.FechaPrimeraEntrada ' +
    //'  ISNULL(agrup.DescripcionArticulo,''Unidades'') AS Agrupacion ' +
    'FROM FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) fsu ' +
    'INNER JOIN ( ' +
    '  SELECT * ' +
    '  FROM FS_SGA_Almacenes WITH (NOLOCK) ' +
    '  WHERE ' +
    '    CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    '    AND VisiblePDA<>0 ' +
    ') FSA ' +
    'ON FSA.CodigoAlmacen = fsu.CodigoAlmacen ' +
    'LEFT JOIN FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', ' + IntToStr(YY) + ' ) fsas ' +
    'ON ' +
    '  fsu.CodigoAlmacen = fsas.CodigoAlmacen AND ' +
    '  fsu.CodigoUbicacion = fsas.CodigoUbicacion ' +
    'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
    'ON ' +
    '  fsas.CodigoArticulo = art.CodigoArticulo ' +
    //'LEFT JOIN Agrupaciones agrup WITH (NOLOCK) ' +
    //'ON ' +
    //'  agrup.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
    //'  AND agrup.CodigoArticulo = fsas.CodigoArticulo ' +
    //'  AND agrup.CodigoAgrupacion = fsas.CodigoAgrupacion ' +
    'LEFT JOIN Colores_ C WITH (NOLOCK) ' +
    'ON ' +
    '  C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
    '  AND C.CodigoColor_ = fsas.CodigoColor_ ' +
    'LEFT JOIN Vis_VistaTallas T WITH (NOLOCK) ' +
    'ON ' +
    '  T.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
    '  AND T.GrupoTalla_= art.GrupoTalla_ ' +
    '  AND T.CodigoTalla01_ = fsas.CodigoTalla01_ ' +
    'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
    'ON ' +
    '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
    '  AND CTC.CodigoArticulo = fsas.CodigoArticulo ' +
    '  AND CTC.CodigoTalla01_ = fsas.CodigoTalla01_ ' +
    '  AND CTC.CodigoColor_ = fsas.CodigoColor_ ' +
    'WHERE ' +
    '  1 = 1 ';

  if CodigoAlmacen<>'' then
    sSQL := sSQL +
      ' AND fsu.CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ';

  sSQL := sSQL +
    andWhere;

  if Tipo='EMPTY' then
    sSQL := sSQL + ' AND fsas.CodigoArticulo IS NULL '
  else begin

    if CodigoArticulo<>'' then
      sSQL := sSQL + ' AND fsas.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ';

    if Filtros then
    begin
      if Partida<>'' then
        sSQL := sSQL + ' AND fsas.Partida = ''' + SQL_Str(Partida) + ''' ';
      if CodigoTalla<>'' then
        sSQL := sSQL + ' AND fsas.CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ';
      if CodigoColor<>'' then
        sSQL := sSQL + ' AND fsas.CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ';
    end;

  end;

  sSQL := sSQL + 'ORDER BY ' +
                 '  fsu.CodigoAlmacen, fsu.CodigoUbicacion ' +
                 'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
                 'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

(*
  sSQL := 'SELECT ' +
          '  CodigoAlmacen, CodigoZona, CodigoUbicacion, CodigoPasillo, CodigoEstanteria, Altura, Fondo, CodigoAlternativo, Bloqueada, Picking, Inactiva ' +
          'FROM dbo.FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa) + ' ) ' +
          'WHERE ' +
          '  CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ' +
          andWhere +
          'ORDER BY ' +
          '  CodigoUbicacion ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';
*)

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    if Q.FieldByName('FechaPrimeraEntrada').AsDateTime>0 then
    begin
      sFechaPrimeraEntrada := FormatDateTime('dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaPrimeraEntrada').AsDateTime)
    end else begin
      sFechaPrimeraEntrada := '';
    end;

    if Q.FieldByName('FechaCaduca').AsDateTime>0 then
    begin
      sFechaCaduca := FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaCaduca').AsDateTime)
    end else begin
      sFechaCaduca := '';
    end;

    Result := Result + '{' +
      '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
      '"CodigoZona":"' + JSON_Str(Q.FieldByName('CodigoZona').AsString) + '",' +
      '"CodigoUbicacion":"' + JSON_Str(Q.FieldByName('CodigoUbicacion').AsString) + '",' +
      '"CodigoPasillo":"' + JSON_Str(Q.FieldByName('CodigoPasillo').AsString) + '",' +
      '"CodigoEstanteria":"' + JSON_Str(Q.FieldByName('CodigoEstanteria').AsString) + '",' +
      '"Altura":"' + JSON_Str(Q.FieldByName('Altura').AsString) + '",' +
      '"Fondo":"' + JSON_Str(Q.FieldByName('Fondo').AsString) + '",' +
      '"CodigoUbicacionAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"Rotacion":"' + JSON_Str(Q.FieldByName('Rotacion').AsString) + '",' +
      '"MultiRef":' + SQL_BooleanToStr(Q.FieldByName('MultiRef').AsBoolean) + ',' +
      '"MultiLote":' + SQL_BooleanToStr(Q.FieldByName('MultiLote').AsBoolean) + ',' +
      '"Bloqueada":' + SQL_BooleanToStr(Q.FieldByName('Bloqueada').AsBoolean) + ',' +
      '"Picking":' + SQL_BooleanToStr(Q.FieldByName('Picking').AsBoolean) + ',' +
      '"Inactiva":' + SQL_BooleanToStr(Q.FieldByName('Inactiva').AsBoolean) + ',' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"GrupoTalla":' + IntToStr(Q.FieldByName('GrupoTalla_').AsInteger) + ',' +
      '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
      '"DescripcionTalla":"' + JSON_Str(Q.FieldByName('DescripcionTalla').AsString) + '",' +
      '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
      '"DescripcionColor":"' + JSON_Str(Q.FieldByName('DescripcionColor').AsString) + '",' +
      '"FechaPrimeraEntrada":"' + sFechaPrimeraEntrada + '",' +
      '"FechaCaduca":"' + sFechaCaduca + '",' +
      '"Stock":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldo').AsFloat) + ',' +
      '"StockBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldoBase').AsFloat) + ',' +
      '"UnidadesSaldo":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldo').AsFloat) + ',' +
      '"UnidadesSaldoBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldoBase').AsFloat) + ',' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
      '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '",' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion_').AsFloat) +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT DE ZONES D'UN MAGATZEM                                        │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getZonasAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoAlmacen: String;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoAlmacen := contentfields.values['CodigoAlmacen'];
  if CodigoAlmacen='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_ESTR_ZONA WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' AND ' +
          '  CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + '''';

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  CodigoZona, NombreZona ' +
          'FROM FS_SGA_ESTR_ZONA WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' AND ' +
          '  CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ' +
          'ORDER BY ' +
          '  CodigoZona ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
      '"CodigoZona":"' + JSON_Str(Q.FieldByName('CodigoZona').AsString) + '",' +
      '"NombreZona":"' + JSON_Str(Q.FieldByName('NombreZona').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ RETORNA LES UBICACIONS PER DEFECTE D'UN MAGATZEM                      │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getDefaultLocationsAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  CodigoAlmacen: String;
  sUbicacion: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoAlmacen := (contentfields.values['CodigoAlmacen']);
  if CodigoAlmacen='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}


  {$REGION 'Recuperació de totals'}

  sSQL :=
    'SELECT * FROM ( ' +
    'SELECT ' +
    '  1 AS ORDEN, FSA.UbicacionExpedicion as CodigoUbicacion, UBICA.CodigoAlternativo ' +
    'FROM dbo.FS_SGA_TABLE_AlmacenesUbicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ', ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) FSA ' +
    'LEFT JOIN ( ' +
    'SELECT * FROM FS_SGA_ESTR_UBICA ' +
    ') UBICA ' +
    'ON FSA.UbicacionExpedicion = UBICA.CodigoUbicacion ' +
    'WHERE ' +
    '  FSA.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    '  AND FSA.CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ' +
    'UNION ' +
    'SELECT ' +
    '  2 AS ORDEN, FSA.UbicacionRecepcion as CodigoUbicacion, UBICA.CodigoAlternativo ' +
    'FROM dbo.FS_SGA_TABLE_AlmacenesUbicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ', ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) FSA ' +
    'LEFT JOIN ( ' +
    'SELECT * FROM FS_SGA_ESTR_UBICA ' +
    ') UBICA ' +
    'ON FSA.UbicacionRecepcion = UBICA.CodigoUbicacion ' +
    'WHERE ' +
    '  FSA.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    '  AND FSA.CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ' +
    'UNION ' +
    'SELECT ' +
    '  3 AS ORDEN, FSA.UbicacionRecepcionRechazos as CodigoUbicacion, UBICA.CodigoAlternativo ' +
    'FROM dbo.FS_SGA_TABLE_AlmacenesUbicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ', ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) FSA ' +
    'LEFT JOIN ( ' +
    'SELECT * FROM FS_SGA_ESTR_UBICA ' +
    ') UBICA ' +
    'ON FSA.UbicacionRecepcionRechazos = UBICA.CodigoUbicacion ' +
    'WHERE ' +
    '  FSA.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    '  AND FSA.CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ' +
    'UNION ' +
    'SELECT ' +
    '  4 AS ORDEN, FSA.UbicacionDevoluciones as CodigoUbicacion, UBICA.CodigoAlternativo ' +
    'FROM dbo.FS_SGA_TABLE_AlmacenesUbicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ', ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) FSA ' +
    'LEFT JOIN ( ' +
    'SELECT * FROM FS_SGA_ESTR_UBICA ' +
    ') UBICA ' +
    'ON FSA.UbicacionDevoluciones = UBICA.CodigoUbicacion ' +
    'WHERE ' +
    '  FSA.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    '  AND FSA.CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ' +
    'UNION ' +
    'SELECT ' +
    '  5 AS ORDEN, FSA.UbicacionDevolucionesRechazos as CodigoUbicacion, UBICA.CodigoAlternativo ' +
    'FROM dbo.FS_SGA_TABLE_AlmacenesUbicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ', ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) FSA ' +
    'LEFT JOIN ( ' +
    'SELECT * FROM FS_SGA_ESTR_UBICA ' +
    ') UBICA ' +
    'ON FSA.UbicacionDevolucionesRechazos = UBICA.CodigoUbicacion ' +
    'WHERE ' +
    '  FSA.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    '  AND FSA.CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ' +
    ') UBIS ' +
    'ORDER BY ' +
    '  ORDEN';


  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then
  begin

    Result :=
      '{"Result":"OK","Error":"","TotalRecords":0,"NumPages":0,"NumRecords":0,"Data":[';

    Result := Result +
      '{' +
      '"CodigoEmpresa":' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ',' +
      '"CodigoAlmacen":"",' +
      '"UbicacionExpediciones":"",' +
      '"UbicacionRecepciones":"",' +
      '"UbicacionRecepcionesRechazos":"",' +
      '"UbicacionDevoluciones":""' +
      '"UbicacionDevolucionesRechazos":""' +
      '}';

  end else begin

    Result :=
      '{"Result":"OK","Error":"","TotalRecords":1,"NumPages":1,"NumRecords":1,"Data":[{';

    while not Q.EOF do
    begin

      case Q.FieldByName('ORDEN').AsInteger of
        1: sUbicacion := '"UbicacionExpediciones"';
        2: sUbicacion := ',"UbicacionRecepciones"';
        3: sUbicacion := ',"UbicacionRecepcionesRechazos"';
        4: sUbicacion := ',"UbicacionDevoluciones"';
        5: sUbicacion := ',"UbicacionDevolucionesRechazos"';
      end;

      Result := Result +
        sUbicacion + ':{' +
        '"CodigoUbicacion":"' + JSON_Str(Q.FieldByName('CodigoUbicacion').AsString) + '",' +
        '"CodigoUbicacionAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
        '"Matricula":""' +
        '}';

      Q.Next;

    end;

  end;

  Result := Result + '}]}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;



// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ REGULARITZACIÓ D'STOCK D'UNA UBICACIÓ                                 │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1readBarcodeAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  parser: TFSBarcodeParser;
  sSQL: String;
  Q: TADOQuery;
  Tipo: Integer;
  Barcode: String;
  newRequest: TWebRequest;
  s: string;
  t: TStringList;
  iNumPunts: Integer;
  RegExpBarcode: String;
  CodigoAlmacen: String;
  RegExp: TRegEx;
  options: TRegExOptions;
  match: TMatch;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  sIA00, sIA01, sIA02: String;
  i: Integer;
  PBC: TFSParsedBarCode;
  TipoDetectado: Integer;
  Version: String;
  Save: Boolean;
  ByPassLocked: Boolean;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoAlmacen := contentfields.values['CodigoAlmacenDefecto'];
  Version       := contentfields.values['Version'];
  ByPassLocked  := (AnsiLowerCase(contentfields.Values['ByPassLocked'])='true');

  Barcode := contentfields.Values['Barcode'];
  if Barcode='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de barras no especificado","Data":[]}';
    Exit;
  end;

  if (Copy(Barcode,1,1)=']') then
  begin
    BarCode := Copy ( Barcode, 4, Length(Barcode)-3);
  end;

  // 0: Automàtic
  // 1: Articles
  // 2: Ubicacions
  // 3: Identificador d'expedició
  // 4: Barcode128

  Tipo := StrToIntDef(contentfields.Values['Tipo'], 0 );
  Save := (StrToIntDef(contentfields.Values['Save'], 0 )<>0);

  {$ENDREGION}

  {$REGION 'Realitzar operació'}

  TipoDetectado := BARCODE_Tipo ( Conn, CodigoEmpresa, CodigoAlmacen, Barcode );

  gaLogFile.Write('Versión PDA = ' + Version + ', Tipo detectado = ' + IntToStr(TipoDetectado) + ', Barcode = ' + Barcode, CONST_LOGID_GENERAL);

  // Si hem detectat directament un GS1-128, retornem les dades
  if (TipoDetectado=4) or (TipoDetectado=50) then
  begin

    if gsGS1GroupSeparator<>'' then
    begin
      BarCode := StringReplace(BarCode, gsGS1GroupSeparator, '', [rfReplaceAll] );
    end;

    BarCode := StringReplace(BarCode, Chr($1D), '', [rfReplaceAll] );

    sParams := sParams + '&CodigoArticulo=' + Barcode;
    WebModule1getArticulo128DetailsAction ( Conn, sParams, sRemoteAddr, statusCode, statusText, Result );
    Exit;
  end;

  //if Tipo<>0 then TipoDetectado := Tipo;

  if TipoDetectado=0 then begin
    sParams := sParams + '&CodigoArticulo=' + Barcode;
    WebModule1getArticulo128DetailsAction ( Conn, sParams, sRemoteAddr, statusCode, statusText, Result );
    //Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código incorrecto","Data":[]}';
    Exit;
  end;

  (*
  if (Tipo=1) and ((TipoDetectado=40) or (TipoDetectado=2) or (TipoDetectado=3)) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo incorrecto","Data":[]}';
    Exit;
  end;
  *)

  Tipo := TipoDetectado;

  if (Tipo=1) or (TipoDetectado=1) then begin

    sParams := sParams + '&CodigoArticulo=' + Barcode;
    WebModule1getArticuloDetailsAction ( Conn, sParams, sRemoteAddr, statusCode, statusText, Result );
    Exit;

  end else if (Tipo=2) or (TipoDetectado=2) then begin

    sParams := sParams + '&CodigoUbicacion=' + Barcode;
    WebModule1validateUbicacionAction ( Conn, sParams, sRemoteAddr, statusCode, statusText, Result );
    Exit;

  end else if (Tipo=3) or (TipoDetectado=3) then begin

    t := TStringList.Create;
    t.Delimiter := '.';
    t.DelimitedText := Barcode;

    if t.Count=3 then begin

      if (StrToIntDef(t[0],-1)=-1) or (StrToIntDef(t[1],-1)=-1) or (StrToIntDef(t[2],-1)=-1) then
      begin

        Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de barras incorrecto","Data":[]}';
        Exit;

      end else begin

        Result := '{"Result":"OK","Error":"","Data":[{' +
          '"Tipo":3,' +
          '"IdExpedicion":' + t[0] + ',' +
          '"IdentificadorExpedicion":' + t[1] + ',' +
          '"CajaId":' + t[2] +
          '}]}';
        FreeAndNil(t);
        Exit;

      end;

    end else begin

      FreeAndNil(t);
      Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Identificador de expedición no válido","Data":[]}';
      Exit;

    end;

  end else if (Tipo=12) or (TipoDetectado=12) then begin

    sParams := sParams + '&CodigoArticulo=' + Barcode;
    WebModule1getArticuloTallaColor ( Conn, sParams, sRemoteAddr, statusCode, statusText, Result );
    Exit;

  end else if (Tipo=11) or (TipoDetectado=11) then begin

    sParams := sParams + '&CodigoArticulo=' + Barcode;
    WebModule1getArticuloagrupadoAction ( Conn, sParams, sRemoteAddr, statusCode, statusText, Result );
    Exit;

  end else if (Tipo=40) or (TipoDetectado=40) then begin

    sParams := sParams + '&Matricula=' + RightStr(Barcode,18);
    WebModule1getMatriculaAction ( Conn, sParams, sRemoteAddr, statusCode, statusText, Result );
    Exit;

  end;

  Result := '{"Request":"' + JSON_StrWeb(sParams) + '","Result":"ERROR","Message":"Código de barras desconocido","Data":[]}';
  Exit;

  {$ENDREGION}

end;


procedure WebModule1readParamAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  id: Integer;
  Resultat: Variant;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  (*
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  *)

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  id := StrToIntDef(contentfields.Values['id'], 0 );
  if id=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Id no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Realitzar operació'}

  case id of
    71: Resultat := SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GPR', 'NumeroDecimales' );
    89: Resultat := SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'ColoresTallas' );
    90: Resultat := SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'TiposUnidadesSimplificado' );
    98: Resultat := SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'Partidas' );
    155: Resultat := SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'NSeries' );
    156: Resultat := SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'NSeriesDuplicado' );
    157: Resultat := SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'NSeriesFabricante' );
    else PARAM_Read ( Conn, 'FS_SGA_Parametros', id, Resultat, CodigoEmpresa.EmpresaOrigen );
  end;

  if (id in [89,90,98,155,156,157]) or (VarType(Resultat)=varBoolean) then
    begin
      if Resultat<>'0' then Resultat := 'TRUE';
      if Resultat='0' then Resultat := 'FALSE';
    end;

  Result := '{"Result":"OK","Error":"","Data":[';
  Result := Result + '{"Param":"' + VarToStr(Resultat) + '"}';
  Result := Result + ']}';

  {$ENDREGION}

end;


procedure WebModule1readParamsAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  Resultat: Variant;
  id : Integer;
  sParamList: String;
  lParams: TStringList;
  s: string;
  contentfields: TStringList;
  sQuote: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  sParamList := trim(contentfields.Values['params']);
  if sParamList='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Lista de parámetros no especificada","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Realitzar operació'}

  (*
  lParams := TStringList.Create;
  lParams.Delimiter := ',';
  lParams.DelimitedText := sParamList;

  if lParams.Count=0 then
  begin
    FreeAndNil(lParams);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Lista de parámetros no especificada","Data":[]}';
    Exit;
  end;
  *)

  s := '';

  sSQL :=
    'SELECT * ' +
    'FROM FS_SGA_Parametros WITH (NOLOCK) ' +
    'WHERE ' +
    '  parametro_codigoempresa IN ( 0, ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
    '  AND parametro_id IN ( ' + SQL_ListToIN ( sParamList, ',' ) + ' ) ' +
    'ORDER BY ' +
    '  parametro_id, parametro_codigoempresa DESC';

  sSQL :=
    'SELECT * ' +
    'FROM ( ' +
    '  SELECT ROW_NUMBER() OVER (PARTITION BY parametro_id ORDER BY parametro_codigoempresa DESC) AS rn, * ' +
    '  FROM FS_SGA_Parametros WITH (NOLOCK) ' +
    '  WHERE ' +
    '    parametro_codigoempresa IN ( 0, ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
    '    AND parametro_id IN ( ' + SQL_ListToIN ( sParamList, ',' ) + ' ) ' +
    ') A ' +
    'WHERE ' +
    '  rn = 1 ' +
    'ORDER BY ' +
    '  parametro_id, parametro_codigoempresa DESC';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  while not Q.EOF do
  begin

    id := Q.FieldByName('parametro_id').AsInteger;

    if s<>'' then
      s := s + ',';

    case id of
      71: Resultat := SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GPR', 'NumeroDecimales' );
      89: Resultat := SQL_BooleanToStr(SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'ColoresTallas' ));
      90: Resultat := SQL_BooleanToStr(SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'TiposUnidadesSimplificado' ));
      98: Resultat := SQL_BooleanToStr(SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'Partidas' ));
      155: Resultat := SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'NSeries' );
      156: Resultat := SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'NSeriesDuplicado' );
      157: Resultat := SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'NSeriesFabricante' );
      else Resultat := Q.FieldByName('parametro_value').AsVariant;
    end;

    if (id in [89,90,98,155,156,157]) or (VarType(Resultat)=varBoolean) then
    begin
      if Resultat<>'0' then Resultat := 'TRUE';
      if Resultat='0' then Resultat := 'FALSE';
    end;

    if (
      (VarType(Resultat)=varDate) or
      (VarType(Resultat)=varOleStr) or
      (VarType(Resultat)=varAny) or
      (VarType(Resultat)=varArray) or
      (VarType(Resultat)=varByRef) or
      (VarType(Resultat)=varRecord) or
      (VarType(Resultat)=varUString) or
      (VarType(Resultat)=varString)) then
    begin
      s := s + '"' + IntToStr(id) + '":"' + JSON_Str(VarToStr(Resultat)) + '"';
    end else begin
      s := s + '"' + IntToStr(id) + '":' + JSON_Str(VarToStr(Resultat));
    end;

    Q.Next;

  end;

  Q.Close;
  FreeAndNil(Q);

  (*
  while lParams.Count>0 do
  begin

    id := StrToIntDef(lParams[0],-1);
    if id<>-1 then
    begin

      case id of
        71: Resultat := SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GPR', 'NumeroDecimales' );
        89: Resultat := SQL_BooleanToStr(SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'ColoresTallas' ));
        90: Resultat := SQL_BooleanToStr(SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'TiposUnidadesSimplificado' ));
        98: Resultat := SQL_BooleanToStr(SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'Partidas' ));
        155: Resultat := SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'NSeries' );
        156: Resultat := SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'NSeriesDuplicado' );
        157: Resultat := SAGE_ObtenerParametroINI ( Conn, CodigoEmpresa, 'CUESTIONARIO', 'GES', 'NSeriesFabricante' );
        else PARAM_Read ( Conn, 'FS_SGA_Parametros', StrToInt(lParams[0]), Resultat, CodigoEmpresa.EmpresaOrigen );
      end;

      if (id in [89,90,98,155,156,157]) or (VarType(Resultat)=varBoolean) then
      begin
        if Resultat<>'0' then Resultat := 'TRUE';
        if Resultat='0' then Resultat := 'FALSE';
      end;

    end else begin
      PARAM_Read ( Conn, 'FS_SGA_Parametros', lParams[0], Resultat, CodigoEmpresa.EmpresaOrigen );
    end;

    if s<>'' then
      s := s + ',';

    if (
      (VarType(Resultat)=varDate) or
      (VarType(Resultat)=varOleStr) or
      (VarType(Resultat)=varAny) or
      (VarType(Resultat)=varArray) or
      (VarType(Resultat)=varByRef) or
      (VarType(Resultat)=varRecord) or
      (VarType(Resultat)=varUString) or
      (VarType(Resultat)=varString)) then
    begin
      s := s + '"' + lParams[0] + '":"' + JSON_Str(VarToStr(Resultat)) + '"';
    end else begin
      s := s + '"' + lParams[0] + '":' + JSON_Str(VarToStr(Resultat));
    end;

    lParams.Delete(0);

  end;

  FreeAndNil(lParams);
  *)

  Result := '{"Result":"OK","Error":"","Data":';
  Result := Result + '{' + s + '}';
  Result := Result + '}';

  {$ENDREGION}

end;


procedure WebModule1cambiarUnidadMedidaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  CodigoAlmacen: String;
  CodigoUbicacion: String;
  aUbicacion: TSGAUbicacion;
  Unidades: Double;
  UnidadMedida: String;
  UnidadMedidaBase: String;
  UnidadesBase: Double;
  YY, MM, DD, HH, NN, SS, MS: WORD;
  Serie: String;
  Documento: Integer;
  AlmacenContrapartida: string;
  Partida2_: string;
  CodigoColor_: string;
  GrupoTalla_: Integer;
  CodigoTalla01_: string;
  TipoMovimiento: Integer;
  CodigoArticulo: string;
  UnidadesSaldo: Double;
  FactorConversion_: Double;
  Comentario: string;
  CodigoCanal: string;
  CodigoCliente: string;
  CodigoProveedor: string;
  //FechaCaduca: TDate;
  Ubicacion: string;
  OrigenMovimiento: string;
  MovOrigen: string;
  EjercicioDocumento: Word;
  NumeroSerieLc: string;
  StatusTraspasadoIME: Integer;
  TipoImportacionIME: Integer;
  DocumentoUnico: Integer;
  IdDocumento: String;
  FechaRegistro: TDateTime;
  Precio: Double;
  Importe: Double;
  MovPosicion: String;
  MovIdentificadorIME: String;
  fOldFactorConversion: Double;
  fNewFactorConversion: Double;
  Diff: Double;
  bErr: Boolean;
  sMsg: String;
  IdProcesoIME: String;
  iLastID: Integer;
  iStatus: Integer;
  bNuevo: Boolean;
  sStr: String;
  gaMov: TSGAMovimientoStock;
  contentfields: TStringList;
  dFechaCaduca: TDate;
  sTalla: String;
  sColor: String;
  sFechaCaduca: String;
  fOldCantidad, fNewCantidad: Double;
  sOldUnidadMedida, sNewUnidadMedida: String;
  fOldCantidadBase, fNewCantidadBase: Double;
  sUnidadMedidaBase: String;
  sPartida: String;
  Matricula: String;
  RestriccionesUbicacion: TUbicacionRestricciones;
  OcupacionActual: TUbicacionOcupacionActual;
  TieneRestriccion: TResultadoRestriccion;
  DatosArticulosOld: TTotalesDatosArticulos;
  DatosArticulosNew: TTotalesDatosArticulos;
  ArticulosLista: VTArticulosRestriccion;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  sStr := 'Inicio<br>';

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario   := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID            := (contentfields.Values['UUID']);
  Matricula       := (contentfields.Values['Matricula']);
  CodigoUbicacion := contentfields.values['CodigoUbicacion'];

  // Conversió al codi d'article real
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación no especificado","Data":[]}';
    Exit;
  end;

  if Matricula<>'' then
  begin
    if (not FS_SGA_MatriculaEnUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion, Matricula ) ) then
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El palet ya no se encuentra en esta ubicación","Data":[]}';
      Exit;
    end;
  end;

  // Conversió al codi d'article real
  CodigoArticulo := contentfields.values['CodigoArticulo'];
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );

  if CodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;

  GrupoTalla_          := StrToIntDef(contentfields.values['GrupoTalla'],0);
  sFechaCaduca         := Trim(contentfields.values['FechaCaduca']);
  sTalla               := (contentfields.values['CodigoTalla']);
  sColor               := (contentfields.values['CodigoColor']);
  sPartida             := (contentfields.values['Partida']);
  fNewCantidad         := FS_StrToFloatDef ( contentfields.values['newCantidad'], 0 );
  fOldCantidad         := FS_StrToFloatDef ( contentfields.values['oldCantidad'], 0 );
  fOldCantidad         := fNewCantidad;
  sOldUnidadMedida     := (AnsiUpperCase(contentfields.values['oldUnidadMedida']));
  sNewUnidadMedida     := (AnsiUpperCase(contentfields.values['newUnidadMedida']));
  fNewCantidadBase     := FS_StrToFloatDef ( contentfields.values['newCantidadBase'], 0 );
  fOldCantidadBase     := FS_StrToFloatDef ( contentfields.values['oldCantidadBase'], 0 );
  fOldCantidadBase     := fNewCantidadBase;
  sUnidadMedidaBase    := (AnsiUpperCase(contentfields.values['UnidadMedidaBase']));
  foldFactorConversion := FS_StrToFloatDef ( contentfields.values['oldFactorConversion'], 1 );
  fnewFactorConversion := FS_StrToFloatDef ( contentfields.values['newFactorConversion'], 1 );

  FS_SGA_Check_UnidadMedidaBase ( Conn, CodigoEmpresa, CodigoArticulo, sOldUnidadMedida, sUnidadMedidaBase );

  if ARTICULO_TratamientoPartida ( Conn, CodigoEmpresa, CodigoArticulo) then begin
    if sPartida='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se ha especificado la partida para este artículo","Data":[]}';
      Exit;
    end;
  end;

  aUbicacion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );
  if aUbicacion.CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de la ubicación no es válido","Data":[]}';
    Exit;
  end;

  (*
  if (not aUbicacion.MultiRef) or (not aUbicacion.MultiLote) then begin
    if not SGA_ALMACEN_Permitir_Entrada_Ubicacion ( Conn, CodigoEmpresa, aUbicacion, Codigoarticulo, sNewPartida ) then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La ubicación no permite más de un artículo o partida distintos","Data":[]}';
      Exit;
    end;
  end;
  *)

  CodigoAlmacen := aUbicacion.CodigoAlmacen;

  DecodeDateTime ( Now(), YY, MM, DD, HH, NN, SS, MS );
  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  Serie                := '';
  Documento            := 0;
  AlmacenContrapartida := '';
  Partida2_            := '';
  Precio               := 0;
  Importe              := 0;
  Comentario           := 'Cambio unidad de medida';
  CodigoCanal          := '';
  CodigoCliente        := '';
  CodigoProveedor      := '';
  Ubicacion            := '';
  MovOrigen            := '';
  EjercicioDocumento   := YY;
  NumeroSerieLc        := '';
  StatusTraspasadoIME  := 0;
  TipoImportacionIME   := 2;
  DocumentoUnico       := 0;
  IdDocumento          := '';
  FechaRegistro        := Now();

  bErr := FALSE;
  sMsg := '';

  if not bErr then try
    IdProcesoIME := SQL_Execute ( Conn,'select NEWID()');
    IdProcesoIME := StringReplace ( IdProcesoIME, '{', '', [] );
    IdProcesoIME := StringReplace ( IdProcesoIME, '}', '', [] );
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  {$ENDREGION}

  {$REGION 'Realitzar operació'}

  // Fem el moviment d'entrada de l'article nou
  TipoMovimiento   := 1;
  OrigenMovimiento := 'E';

  if (IdDocumento='') or (IdDocumento='0') then begin
    IdDocumento := '00000000-0000-0000-0000-000000000000';
  end;

  MovOrigen := SQL_Execute ( Conn, 'SELECT NEWID()' );

  if (sFechaCaduca='') or (sFechaCaduca='0') then begin
    dFechaCaduca := 0;
    sFechaCaduca := 'NULL';
  end else begin
    dFechaCaduca := StrToDate(sFechaCaduca);
    sFechaCaduca := SQL_DateToStr(dFechaCaduca);
  end;

  iLastID := 0;
  iStatus := 1;

  SGA_FS_ALMACEN_PrepareMov ( gaMov );

  gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
  gaMov.EmpresaOrigen          := CodigoEmpresa.EmpresaOrigen;
  gaMov.Partida                := sPartida;
  gaMov.TipoMovimiento         := 1;
  gaMov.OrigenMovimiento       := 'E';
  gaMov.Unidades               := fNewCantidad;
  gaMov.UnidadesBase           := fNewCantidadBase;
  gaMov.FactorConversion       := fNewFactorConversion;
  gaMov.Comentario             := Comentario + ' (entrada)';
  gaMov.Precio                 := Precio;
  gaMov.MovOrigen              := MovOrigen;
  gaMov.CodigoProveedor        := CodigoProveedor;
  gaMov.FechaCaduca            := dFechaCaduca;
  gaMov.CodigoUsuario          := CodigoUsuario;
  gaMov.Ejercicio              := YY;
  gaMov.Periodo                := MM;
  gaMov.Fecha                  := Date();
  gaMov.FechaHora              := Now();
  gaMov.CodigoAlmacen          := CodigoAlmacen;
  gaMov.CodigoUbicacion        := CodigoUbicacion;
  gaMov.CodigoArticulo         := CodigoArticulo;
  gaMov.IdProcesoIME           := IdProcesoIME;
  gaMov.IdDocumento            := IdDocumento;
  gaMov.Serie                  := Serie;
  gaMov.CodigoColor            := sColor;
  gaMov.CodigoTalla            := sTalla;
  gaMov.GrupoTalla             := GrupoTalla_;
  gaMov.UnidadMedida           := AnsiUpperCase(sNewUnidadMedida);
  gaMov.UnidadMedidaBase       := AnsiUpperCase(sUnidadMedidaBase);
  gaMov.Matricula              := Matricula;
  gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );

  if Precio=0 then
  begin
    gaMov.Precio :=
      ARTICULO_ConsultarPrecioStock (
        Conn,
        CodigoEmpresa,
        gaMov.CodigoArticulo,
        gaMov.Partida,
        gaMov.CodigoColor,
        gaMov.CodigoTalla,
        gaMov.CodigoAlmacen,
        gaMov.GrupoTalla
      );
  end;

  gaMov.Importe := gaMov.Precio * gaMov.UnidadesBase;

  sStr := sStr + 'Movimiento entrada SGA<br>';

  if (fNewCantidad>0) or (fNewCantidadBase>0) then
  begin

    // Entrada del nou stock
    gaLogFile.Write('Cambio formato: Entrada artículo=' + CodigoArticulo + ', Partida=' + sPartida + ', Ubicación=' + aUbicacion.CodigoUbicacion + ' Unidades=' + FormatFloat('#,0', Unidades), sIDCall  );

    if not bErr then try
      bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message + ' - ' + sMsg;
      end;
    end;

    if not bErr then try
      MovIdentificadorIME := SQL_Execute ( Conn,'select NEWID()');
      MovIdentificadorIME := StringReplace ( MovIdentificadorIME, '{', '', [] );
      MovIdentificadorIME := StringReplace ( MovIdentificadorIME, '}', '', [] );
    except
      on E:Exception do begin
        sMsg := E.Message;
        bErr := TRUE;
      end;
    end;

    sSQL := 'INSERT INTO TmpIME_MovimientoStock ( ' +
            '    CodigoEmpresa, Ejercicio, Periodo, Fecha, Serie, Documento, ' +
            '    CodigoArticulo, CodigoAlmacen, AlmacenContrapartida, Partida, ' +
            '    Partida2_, CodigoColor_, GrupoTalla_, CodigoTalla01_, TipoMovimiento, ' +
            '    Unidades, UnidadMedida1_, Precio, Importe, Unidades2_, UnidadMedida2_, ' +
            '    FactorConversion_, Comentario, CodigoCanal, CodigoCliente, CodigoProveedor, ' +
            '    FechaCaduca, Ubicacion, OrigenMovimiento, EmpresaOrigen, MovOrigen, ' +
            '    EjercicioDocumento, NumeroSerieLc, IdProcesoIME, MovIdentificadorIME, ' +
            '    StatusTraspasadoIME, TipoImportacionIME, DocumentoUnico, FechaRegistro, ' +
            '    MovPosicion ' +
            '  ) ' +
            'VALUES ( ' +
            IntToStr(CodigoEmpresa.Stocks) + ', ' +
            IntToStr(YY) + ', ' +
            IntToStr(MM) + ', ' +
            SQL_DateToStr ( Now() ) + ', ' +
            '''' + SQL_Str(Serie) + ''', ' +
            IntToStr(Documento) + ', ' +
            '''' + SQL_Str(gaMov.CodigoArticulo) + ''', ' +
            '''' + SQL_Str(gaMov.CodigoAlmacen) + ''', ' +
            '''' + SQL_Str(AlmacenContrapartida) + ''', ' +
            '''' + SQL_Str(sPartida) + ''', ' +
            ''''', ' +
            '''' + SQL_Str(sColor) + ''', ' +
            IntToStr(gaMov.GrupoTalla) + ', ' +
            '''' + SQL_Str(sTalla) + ''', ' +
            '1, ' +
            SQL_FloatToStr ( fNewCantidad ) + ', '+
            '''' + SQL_Str( sNewUnidadMedida ) + ''', ' +
            SQL_FloatToStr ( gaMov.Precio ) + ', ' +
            SQL_FloatToStr ( fNewCantidadBase * gaMov.Precio ) + ', ' +
            SQL_FloatToStr ( fNewCantidadBase ) + ', '+
            '''' + SQL_Str( sUnidadMedidaBase ) + ''', ' +
            SQL_FloatToStr ( fNewFactorConversion ) + ', '+
            '''' + SQL_Str(gaMov.Comentario) + ''', ' +
            '''' + SQL_Str( CodigoCanal ) + ''', ' +
            '''' + SQL_Str( CodigoCliente ) + ''', ' +
            '''' + SQL_Str( CodigoProveedor ) + ''', ' +
            sFechaCaduca + ', ' +
            '''' + SQL_Str( Ubicacion ) + ''', ' +
            '''E'', ' +
            IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
            '''' + SQL_GUID_ToStr( MovOrigen ) + ''', ' +
            IntToStr(EjercicioDocumento) + ', ' +
            '''' + SQL_Str( NumeroSerieLc ) + ''', ' +
            '''' + SQL_GUID_ToStr( IdProcesoIME ) + ''', ' +
            '''' + SQL_GUID_ToStr( MovIdentificadorIME ) + ''', ' +
            IntToStr(StatusTraspasadoIME) + ', ' +
            IntToStr(TipoImportacionIME) + ', ' +
            IntToStr(DocumentoUnico) + ', ' +
            SQL_DateTimeToStr ( FechaRegistro ) + ', ' +
            '''' + SQL_GUID_ToStr(gaMov.MovPosicion) + ''' ' +
            ')';

    sStr := sStr + 'Movimiento Sage: ' + sSQL + '<br>';

    if not bErr then try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message;
      end;
    end;

  end;

  gaMov.TipoMovimiento         := 2;
  gaMov.OrigenMovimiento       := 'S';
  gaMov.Unidades               := fOldCantidad;
  gaMov.UnidadMedida           := AnsiUpperCase(sOldUnidadMedida);
  gaMov.UnidadesBase           := fOldCantidadBase;
  gaMov.UnidadMedidaBase       := AnsiUpperCase(sUnidadMedidaBase);
  gaMov.CodigoColor            := sColor;
  gaMov.CodigoTalla            := sTalla;
  gaMov.FactorConversion       := fOldFactorConversion;
  gaMov.Comentario             := Comentario + ' (salida)';
  gaMov.Precio                 := Precio;
  gaMov.MovOrigen              := MovOrigen;
  gaMov.CodigoProveedor        := CodigoProveedor;
  gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );

  if Precio=0 then
  begin
    gaMov.Precio :=
      ARTICULO_ConsultarPrecioStock (
        Conn,
        CodigoEmpresa,
        gaMov.CodigoArticulo,
        gaMov.Partida,
        gaMov.CodigoColor,
        gaMov.CodigoTalla,
        gaMov.CodigoAlmacen,
        gaMov.GrupoTalla
      );
  end;

  sStr := sStr + 'Movimiento salida SGA<br>';

  if (fOldCantidad>0) or (fOldCantidadBase>0) then
  begin

    if not bErr then try
      bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message + ' - ' + sMsg;
      end;
    end;

    if not bErr then try
      MovIdentificadorIME := SQL_Execute ( Conn,'select NEWID()');
      MovIdentificadorIME := StringReplace ( MovIdentificadorIME, '{', '', [] );
      MovIdentificadorIME := StringReplace ( MovIdentificadorIME, '}', '', [] );
    except
      on E:Exception do begin
        sMsg := E.Message;
        bErr := TRUE;
      end;
    end;

    FS_SGA_Check_UnidadMedidaBase ( Conn, CodigoEmpresa, gaMov );

    sSQL := 'INSERT INTO TmpIME_MovimientoStock ( ' +
            '    CodigoEmpresa, Ejercicio, Periodo, Fecha, Serie, Documento, ' +
            '    CodigoArticulo, CodigoAlmacen, AlmacenContrapartida, Partida, ' +
            '    Partida2_, CodigoColor_, GrupoTalla_, CodigoTalla01_, TipoMovimiento, ' +
            '    Unidades, UnidadMedida1_, Precio, Importe, Unidades2_, UnidadMedida2_, ' +
            '    FactorConversion_, Comentario, CodigoCanal, CodigoCliente, CodigoProveedor, ' +
            '    FechaCaduca, Ubicacion, OrigenMovimiento, EmpresaOrigen, MovOrigen, ' +
            '    EjercicioDocumento, NumeroSerieLc, IdProcesoIME, MovIdentificadorIME, ' +
            '    StatusTraspasadoIME, TipoImportacionIME, DocumentoUnico, FechaRegistro, ' +
            '    MovPosicion ' +
            '  ) ' +
            'VALUES ( ' +
            IntToStr(CodigoEmpresa.Stocks) + ', ' +
            IntToStr(YY) + ', ' +
            IntToStr(MM) + ', ' +
            SQL_DateToStr ( Now() ) + ', ' +
            '''' + SQL_Str(Serie) + ''', ' +
            IntToStr(Documento) + ', ' +
            '''' + SQL_Str(gaMov.CodigoArticulo) + ''', ' +
            '''' + SQL_Str(gaMov.CodigoAlmacen) + ''', ' +
            '''' + SQL_Str(AlmacenContrapartida) + ''', ' +
            '''' + SQL_Str(sPartida) + ''', ' +
            ''''', ' +
            '''' + SQL_Str(sColor) + ''', ' +
            IntToStr(gaMov.GrupoTalla) + ', ' +
            '''' + SQL_Str(sTalla) + ''', ' +
            '2, ' +
            SQL_FloatToStr ( fOldCantidad ) + ', '+
            '''' + SQL_Str( AnsiUpperCase(sOldUnidadMedida) ) + ''', ' +
            SQL_FloatToStr ( gaMov.Precio ) + ', ' +
            SQL_FloatToStr ( fOldCantidadBase * gaMov.Precio ) + ', ' +
            SQL_FloatToStr ( fOldCantidadBase ) + ', '+
            '''' + SQL_Str( sUnidadMedidaBase ) + ''', ' +
            SQL_FloatToStr ( fOldFactorConversion ) + ', '+
            '''' + SQL_Str(gaMov.Comentario) + ''', ' +
            '''' + SQL_Str( CodigoCanal ) + ''', ' +
            '''' + SQL_Str( CodigoCliente ) + ''', ' +
            '''' + SQL_Str( CodigoProveedor ) + ''', ' +
            sFechaCaduca + ', ' +
            '''' + SQL_Str( Ubicacion ) + ''', ' +
            '''S'', ' +
            IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
            '''' + SQL_Str( MovOrigen ) + ''', ' +
            IntToStr(EjercicioDocumento) + ', ' +
            '''' + SQL_Str( NumeroSerieLc ) + ''', ' +
            '''' + SQL_GUID_ToStr( IdProcesoIME ) + ''', ' +
            '''' + SQL_GUID_ToStr( MovIdentificadorIME ) + ''', ' +
            IntToStr(StatusTraspasadoIME) + ', ' +
            IntToStr(TipoImportacionIME) + ', ' +
            IntToStr(DocumentoUnico) + ', ' +
            SQL_DateTimeToStr ( FechaRegistro + OneSecond ) + ', ' +
            '''' + SQL_GUID_ToStr(gaMov.MovPosicion) + ''' )';

    sStr := sStr + 'Movimiento salida Sage: ' + sSQL + '<br>';

    if not bErr then try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message;
      end;
    end;

  end;

  sSQL := 'INSERT INTO ' +
          '  FS_Operations ( oper_product_code, oper_name, oper_datetime, oper_status, oper_params, oper_CodigoEmpresa ) ' +
          'VALUES ( ' +
          '''E4E8'', ' +
          '''MOVIMIENTOSTOCK'', ' +
          SQL_DateTimeToStr(Now()) + ', ' +
          '0, ' +
          '''{"IdProcesoIME":"' + SQL_GUID_ToStr(IdProcesoIME) + '","MantenerDatos":"1","MantenerErrores":"1","Módulos":"4","CodigoEmpresa":' + IntToStr(CodigoEmpresa.Stocks) + '}'', ' +
          IntToStr(CodigoEmpresa.Stocks) +
          ')';
  //gaLogFile.Write(sSQL, CONST_LOGID_BBDD, LOG_LEVEL_INFO );

  sStr := sStr + 'FS_Operations: ' + sSQL + '<br>';

  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
    sSQL := 'SELECT IDENT_CURRENT(''FS_Operations'')';
    iLastID := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if not bErr then try
    // Conn.CommitTrans;
  except
    on e:exception do begin
      bErr := true;
      sMsg := e.Message;
    end;
  end;

  if bErr then begin
    // Conn.RollbackTrans;
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + sMsg + '","Data":[]}';
    Exit;
  end;

  LP := LOG_Clear();
  LP.MovOrigen := gaMov.MovOrigen;
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'CHANGE-FORMAT', 'Cambio de formato del artículo ' + gaMov.CodigoArticulo, @LP );

  Result := '{"Result":"OK","Error":"","Data":[';
  Result := Result + ']}';

  {$ENDREGION}

end;


procedure WebModule1regularizacionStockAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  CodigoAlmacen: String;
  CodigoUbicacion: String;
  aUbicacion: TSGAUbicacion;
  Unidades: Double;
  UnidadMedida: String;
  UnidadMedidaBase: String;
  UnidadesBase: Double;
  YY, MM, DD, HH, NN, SS, MS: WORD;
  Serie: String;
  Documento: Integer;
  AlmacenContrapartida: string;
  Partida2_: string;
  CodigoColor_: string;
  GrupoTalla_: Integer;
  CodigoTalla01_: string;
  TipoMovimiento: Integer;
  CodigoArticulo: string;
  UnidadesSaldo: Double;
  FactorConversion_: Double;
  Comentario: string;
  CodigoCanal: string;
  CodigoCliente: string;
  CodigoProveedor: string;
  //FechaCaduca: TDate;
  Ubicacion: string;
  OrigenMovimiento: string;
  MovOrigen: string;
  EjercicioDocumento: Word;
  NumeroSerieLc: string;
  StatusTraspasadoIME: Integer;
  TipoImportacionIME: Integer;
  DocumentoUnico: Integer;
  IdDocumento: String;
  FechaRegistro: TDateTime;
  Precio: Double;
  Importe: Double;
  MovPosicion: String;
  MovIdentificadorIME: String;
  fOldFactorConversion: Double;
  fNewFactorConversion: Double;
  Diff: Double;
  bErr: Boolean;
  sMsg: String;
  IdProcesoIME: String;
  iLastID: Integer;
  iStatus: Integer;
  bNuevo: Boolean;
  sStr: String;
  gaMov: TSGAMovimientoStock;
  contentfields: TStringList;
  dFechaCaduca: TDate;
  sOldTalla, sNewTalla: String;
  sOldColor, sNewColor: String;
  sOldFechaCaduca, sNewFechaCaduca: String;
  fOldCantidad, fNewCantidad: Double;
  sOldUnidadMedida, sNewUnidadMedida: String;
  fOldCantidadBase, fNewCantidadBase: Double;
  sOldUnidadMedidaBase, sNewUnidadMedidaBase: String;
  sOldPartida, sNewPartida: String;
  sFechaCaduca: string;
  Matricula: String;
  RestriccionesUbicacion: TUbicacionRestricciones;
  OcupacionActual: TUbicacionOcupacionActual;
  TieneRestriccion: TResultadoRestriccion;
  DatosArticulosOld: TTotalesDatosArticulos;
  DatosArticulosNew: TTotalesDatosArticulos;
  ArticulosLista: VTArticulosRestriccion;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  sStr := 'Inicio<br>';

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario   := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  Matricula       := (contentfields.Values['Matricula']);
  CodigoUbicacion := contentfields.values['CodigoUbicacion'];
  UUID            := contentfields.values['UUID'];

  // Conversió al codi d'article real
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación no especificado","Data":[]}';
    Exit;
  end;

  if Matricula<>'' then
  begin
    if (not FS_SGA_MatriculaEnUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion, Matricula ) ) then
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El palet ya no se encuentra en esta ubicación","Data":[]}';
      Exit;
    end;
  end;

  CodigoArticulo := contentfields.values['CodigoArticulo'];

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );

  if CodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;

  GrupoTalla_          := StrToIntDef(contentfields.values['GrupoTalla'],0);
  sOldFechaCaduca      := Trim(contentfields.values['oldFechaCaduca']);
  sNewFechaCaduca      := Trim(contentfields.values['newFechaCaduca']);
  sOldTalla            := (contentfields.values['oldTalla']);
  sNewTalla            := (contentfields.values['newTalla']);
  sOldColor            := (contentfields.values['oldColor']);
  sNewColor            := (contentfields.values['newColor']);
  sOldPartida          := (contentfields.values['oldPartida']);
  sNewPartida          := (contentfields.values['newPartida']);
  fOldCantidad         := FS_StrToFloatDef ( contentfields.values['oldCantidad'], 0 );
  fNewCantidad         := FS_StrToFloatDef ( contentfields.values['newCantidad'], 0 );
  sOldUnidadMedida     := AnsiUpperCase(contentfields.values['oldUnidadMedida']);
  sNewUnidadMedida     := AnsiUpperCase(contentfields.values['newUnidadMedida']);
  fOldCantidadBase     := FS_StrToFloatDef ( contentfields.values['oldCantidadBase'], 0 );
  fNewCantidadBase     := FS_StrToFloatDef ( contentfields.values['newCantidadBase'], 0 );
  sOldUnidadMedidaBase := AnsiUpperCase(contentfields.values['oldUnidadMedidaBase']);
  sNewUnidadMedidaBase := AnsiUpperCase(contentfields.values['newUnidadMedidaBase']);

  FS_SGA_Check_UnidadMedidaBase ( Conn, CodigoEmpresa, CodigoArticulo, sOldUnidadMedida, sOldUnidadMedidaBase );
  FS_SGA_Check_UnidadMedidaBase ( Conn, CodigoEmpresa, CodigoArticulo, sNewUnidadMedida, sNewUnidadMedidaBase );

  SGA_FS_ARTICULO_ConversionUnidades ( Conn, CodigoEmpresa, CodigoArticulo, fNewCantidad, sNewUnidadMedidaBase, sNewUnidadMedida, fNewFactorConversion );
  SGA_FS_ARTICULO_ConversionUnidades ( Conn, CodigoEmpresa, CodigoArticulo, fOldCantidad, sOldUnidadMedidaBase, sOldUnidadMedida, fOldFactorConversion );

  if ARTICULO_TratamientoPartida ( Conn, CodigoEmpresa, CodigoArticulo) then begin
    if sNewPartida='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se ha especificado la partida para este artículo","Data":[]}';
      Exit;
    end;
  end;

  aUbicacion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );
  if aUbicacion.CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de la ubicación no es válido","Data":[]}';
    Exit;
  end;

  (*
  if (not aUbicacion.MultiRef) or (not aUbicacion.MultiLote) then begin
    if not SGA_ALMACEN_Permitir_Entrada_Ubicacion ( Conn, CodigoEmpresa, aUbicacion, Codigoarticulo, sNewPartida ) then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La ubicación no permite más de un artículo o partida distintos","Data":[]}';
      Exit;
    end;
  end;
  *)

  CodigoAlmacen := aUbicacion.CodigoAlmacen;

  DecodeDateTime ( Now(), YY, MM, DD, HH, NN, SS, MS );
  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  sSQL := 'SELECT ' +
          '  * ' +
          'FROM FS_SGA_TABLE_AcumuladoStock ( ' + IntToStr(CodigoEmpresa.Stocks) + ' ) ' +
          'WHERE ' +
          '  Ejercicio = ' + IntToStr(YY) + ' ' +
          '  AND Periodo = 99 ' +
          '  AND CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + ''' ' +
          '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND Partida = ''' + SQL_Str(sOldPartida) + ''' ' +
          '  AND Matricula = ''' + SQL_Str(Matricula) + ''' ' +
          '  AND UnidadMedida = ''' + SQL_Str(sOldUnidadMedida) + ''' ' +
          '  AND CodigoColor_ = ''' + SQL_Str(sOldColor) + ''' ' +
          '  AND CodigoTalla01_ = ''' + SQL_Str(sOldTalla) + '''';

  sStr := sStr + sSQL + '<br>';
                                     
  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  bNuevo := FALSE;
  if Q.EOF then begin
    bNuevo := TRUE;
    UnidadesSaldo := 0;
  end else begin
    UnidadesSaldo := Q.FieldByName('UnidadesSaldo').AsFloat;
  end;

  sStr := sStr + 'Unidades saldo: ' + FloatToStr(UnidadesSaldo) + '<br>';

  UnidadMedidaBase     := FS_SGA_ARTICULO_UnidadBase ( Conn, CodigoEmpresa, CodigoArticulo );
  CodigoColor_         := Q.FieldByName('CodigoColor_').AsString;
  CodigoTalla01_       := Q.FieldByName('CodigoTalla01_').AsString;
  Serie                := '';
  Documento            := 0;
  AlmacenContrapartida := '';
  Partida2_            := '';
  Precio               := 0;
  Importe              := 0;
  Comentario           := 'Regularización de stock';
  CodigoCanal          := '';
  CodigoCliente        := '';
  CodigoProveedor      := '';
  Ubicacion            := '';
  MovOrigen            := '';
  EjercicioDocumento   := YY;
  NumeroSerieLc        := '';
  StatusTraspasadoIME  := 0;
  TipoImportacionIME   := 2;
  DocumentoUnico       := 0;
  IdDocumento          := '';
  FechaRegistro        := Now();

  bErr := FALSE;
  sMsg := '';

  if not bErr then try
    IdProcesoIME := SQL_Execute ( Conn,'select NEWID()');
    IdProcesoIME := StringReplace ( IdProcesoIME, '{', '', [] );
    IdProcesoIME := StringReplace ( IdProcesoIME, '}', '', [] );
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

  {$REGION 'Validación restricciones'}

  SetLength ( ArticulosLista, 1 );

  ArticulosLista[0].CodigoArticulo := CodigoArticulo;
  ArticulosLista[0].Partida        := sOldPartida;
  ArticulosLista[0].Cantidad       := fOldCantidadBase;
  DatosArticulosOld := FS_SGA_UBICACION_GetDatosArticulos ( Conn, CodigoEmpresa, ArticulosLista );

  ArticulosLista[0].Cantidad       := fNewCantidadBase;
  DatosArticulosNew := FS_SGA_UBICACION_GetDatosArticulos ( Conn, CodigoEmpresa, ArticulosLista );
  SetLength ( ArticulosLista, 0 );

  RestriccionesUbicacion := FS_SGA_UBICACION_Restricciones ( Conn, CodigoEmpresa, CodigoUbicacion );
  OcupacionActual        := FS_SGA_UBICACION_OcupacionActual ( Conn, CodigoEmpresa, CodigoUbicacion );

  OcupacionActual.PesoNeto  := OcupacionActual.PesoNeto - DatosArticulosOld.PesoNeto;
  OcupacionActual.PesoBruto := OcupacionActual.PesoBruto - DatosArticulosOld.PesoBruto;
  OcupacionActual.Volumen   := OcupacionActual.Volumen - DatosArticulosOld.Volumen;

  TieneRestriccion       := FS_SGA_UBICACION_CheckRestriccionesLista ( Conn, CodigoEmpresa,
                            CodigoUbicacion, RestriccionesUbicacion, OcupacionActual, DatosArticulosNew
                          );

  if TieneRestriccion.Error then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Restricción de ubicación: ' + JSON_Str(TieneRestriccion.Mensaje) + '","Data":[]}';
    Exit;
  end;


  {$ENDREGION}

  {$REGION 'Realitzar operació'}

  // Fem el moviment d'entrada de l'article nou
  TipoMovimiento   := 1;
  OrigenMovimiento := 'E';

  // Sortida de stock antic
  gaLogFile.Write('Regularización: Entrada artículo=' + CodigoArticulo + ', Partida=' + sNewPartida + ', Ubicación=' + aUbicacion.CodigoUbicacion + ' Unidades=' + FormatFloat('#,0', UnidadesSaldo), sIDCall  );

  if (IdDocumento='') or (IdDocumento='0') then begin
    IdDocumento := '00000000-0000-0000-0000-000000000000';
  end;

  MovOrigen := SQL_Execute ( Conn, 'SELECT NEWID()' );

  gaLogFile.Write(sNewFechaCaduca);

  if (sNewFechaCaduca='') or (sNewFechaCaduca='0') then begin
    dFechaCaduca := 0;
    sFechaCaduca := 'NULL';
  end else begin
    dFechaCaduca := StrToDate(sNewFechaCaduca);
    sFechaCaduca := SQL_DateToStr(dFechaCaduca);
  end;

  iLastID := 0;
  iStatus := 1;

  SGA_FS_ALMACEN_PrepareMov ( gaMov );

  gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
  gaMov.EmpresaOrigen          := CodigoEmpresa.EmpresaOrigen;
  gaMov.Partida                := sNewPartida;
  gaMov.TipoMovimiento         := 1;
  gaMov.OrigenMovimiento       := 'E';
  gaMov.Unidades               := fNewCantidad;
  gaMov.UnidadesBase           := fNewCantidadBase;
  gaMov.FactorConversion       := fNewFactorConversion;
  gaMov.Comentario             := 'Entrada regularización';
  gaMov.Precio                 := Precio;
  gaMov.MovOrigen              := MovOrigen;
  gaMov.CodigoProveedor        := CodigoProveedor;
  gaMov.FechaCaduca            := dFechaCaduca;
  gaMov.CodigoUsuario          := CodigoUsuario;
  gaMov.Ejercicio              := YY;
  gaMov.Periodo                := MM;
  gaMov.Fecha                  := Date();
  gaMov.FechaHora              := Now();
  gaMov.CodigoAlmacen          := CodigoAlmacen;
  gaMov.CodigoUbicacion        := CodigoUbicacion;
  gaMov.CodigoArticulo         := CodigoArticulo;
  gaMov.IdProcesoIME           := IdProcesoIME;
  gaMov.IdDocumento            := IdDocumento;
  gaMov.Serie                  := Serie;
  gaMov.CodigoColor            := sNewColor;
  gaMov.CodigoTalla            := sNewTalla;
  gaMov.GrupoTalla             := GrupoTalla_;
  gaMov.UnidadMedida           := AnsiUpperCase(sNewUnidadMedida);
  gaMov.UnidadMedidaBase       := AnsiUpperCase(sNewUnidadMedidaBase);
  gaMov.Matricula              := Matricula;
  gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );

  if Precio=0 then
  begin
    gaMov.Precio :=
      ARTICULO_ConsultarPrecioStock (
        Conn,
        CodigoEmpresa,
        gaMov.CodigoArticulo,
        gaMov.Partida,
        gaMov.CodigoColor,
        gaMov.CodigoTalla,
        gaMov.CodigoAlmacen,
        gaMov.GrupoTalla
      );
  end;

  gaMov.Importe := gaMov.Precio * gaMov.UnidadesBase;

  sStr := sStr + 'Movimiento entrada SGA<br>';

  if (fNewCantidad>0) or (fNewCantidadBase>0) then
  begin

    // Entrada del nou stock
    gaLogFile.Write('Regularización: Entrada artículo=' + CodigoArticulo + ', Partida=' + sNewPartida + ', Ubicación=' + aUbicacion.CodigoUbicacion + ' Unidades=' + FormatFloat('#,0', Unidades), sIDCall  );

    if not bErr then try
      bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message + ' - ' + sMsg;
      end;
    end;

    if not bErr then try
      MovIdentificadorIME := SQL_Execute ( Conn,'select NEWID()');
      MovIdentificadorIME := StringReplace ( MovIdentificadorIME, '{', '', [] );
      MovIdentificadorIME := StringReplace ( MovIdentificadorIME, '}', '', [] );
    except
      on E:Exception do begin
        sMsg := E.Message;
        bErr := TRUE;
      end;
    end;

    sSQL := 'INSERT INTO TmpIME_MovimientoStock ( ' +
            '    CodigoEmpresa, Ejercicio, Periodo, Fecha, Serie, Documento, ' +
            '    CodigoArticulo, CodigoAlmacen, AlmacenContrapartida, Partida, ' +
            '    Partida2_, CodigoColor_, GrupoTalla_, CodigoTalla01_, TipoMovimiento, ' +
            '    Unidades, UnidadMedida1_, Precio, Importe, Unidades2_, UnidadMedida2_, ' +
            '    FactorConversion_, Comentario, CodigoCanal, CodigoCliente, CodigoProveedor, ' +
            '    FechaCaduca, Ubicacion, OrigenMovimiento, EmpresaOrigen, MovOrigen, ' +
            '    EjercicioDocumento, NumeroSerieLc, IdProcesoIME, MovIdentificadorIME, ' +
            '    StatusTraspasadoIME, TipoImportacionIME, DocumentoUnico, FechaRegistro, ' +
            '    MovPosicion ' +
            '  ) ' +
            'VALUES ( ' +
            IntToStr(CodigoEmpresa.Stocks) + ', ' +
            IntToStr(YY) + ', ' +
            IntToStr(MM) + ', ' +
            SQL_DateToStr ( Now() ) + ', ' +
            '''' + SQL_Str(Serie) + ''', ' +
            IntToStr(Documento) + ', ' +
            '''' + SQL_Str(gaMov.CodigoArticulo) + ''', ' +
            '''' + SQL_Str(gaMov.CodigoAlmacen) + ''', ' +
            '''' + SQL_Str(AlmacenContrapartida) + ''', ' +
            '''' + SQL_Str(sNewPartida) + ''', ' +
            ''''', ' +
            '''' + SQL_Str(sNewColor) + ''', ' +
            IntToStr(gaMov.GrupoTalla) + ', ' +
            '''' + SQL_Str(sNewTalla) + ''', ' +
            '1, ' +
            SQL_FloatToStr ( fNewCantidad ) + ', '+
            '''' + SQL_Str( sNewUnidadMedida ) + ''', ' +
            SQL_FloatToStr ( gaMov.Precio ) + ', ' +
            SQL_FloatToStr ( fNewCantidad * gaMov.Precio ) + ', ' +
            SQL_FloatToStr ( fNewCantidadBase ) + ', '+
            '''' + SQL_Str( sNewUnidadMedidaBase ) + ''', ' +
            SQL_FloatToStr ( fNewFactorConversion ) + ', '+
            '''Entrada regularización'', ' +
            '''' + SQL_Str( CodigoCanal ) + ''', ' +
            '''' + SQL_Str( CodigoCliente ) + ''', ' +
            '''' + SQL_Str( CodigoProveedor ) + ''', ' +
            sFechaCaduca + ', ' +
            '''' + SQL_Str( Ubicacion ) + ''', ' +
            '''E'', ' +
            IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
            '''' + SQL_GUID_ToStr( MovOrigen ) + ''', ' +
            IntToStr(EjercicioDocumento) + ', ' +
            '''' + SQL_Str( NumeroSerieLc ) + ''', ' +
            '''' + SQL_GUID_ToStr( IdProcesoIME ) + ''', ' +
            '''' + SQL_GUID_ToStr( MovIdentificadorIME ) + ''', ' +
            IntToStr(StatusTraspasadoIME) + ', ' +
            IntToStr(TipoImportacionIME) + ', ' +
            IntToStr(DocumentoUnico) + ', ' +
            SQL_DateTimeToStr ( FechaRegistro ) + ', ' +
            '''' + SQL_GUID_ToStr(gaMov.MovPosicion) + ''' ' +
            ')';

    sStr := sStr + 'Movimiento Sage: ' + sSQL + '<br>';

    if not bErr then try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message;
      end;
    end;

  end;

  gaMov.Partida                := sOldPartida;
  gaMov.TipoMovimiento         := 2;
  gaMov.OrigenMovimiento       := 'S';
  gaMov.Unidades               := fOldCantidad;
  gaMov.UnidadMedida           := AnsiUpperCase(sOldUnidadMedida);
  gaMov.UnidadesBase           := fOldCantidadBase;
  gaMov.UnidadMedidaBase       := AnsiUpperCase(sOldUnidadMedidaBase);
  gaMov.CodigoColor            := sOldColor;
  gaMov.CodigoTalla            := sOldTalla;
  gaMov.FactorConversion       := fOldFactorConversion;
  gaMov.Comentario             := 'Salida regularización';
  gaMov.Precio                 := Precio;
  gaMov.MovOrigen              := MovOrigen;
  gaMov.CodigoProveedor        := CodigoProveedor;
  gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );

  if Precio=0 then
  begin
    gaMov.Precio :=
      ARTICULO_ConsultarPrecioStock (
        Conn,
        CodigoEmpresa,
        gaMov.CodigoArticulo,
        gaMov.Partida,
        gaMov.CodigoColor,
        gaMov.CodigoTalla,
        gaMov.CodigoAlmacen,
        gaMov.GrupoTalla
      );
  end;

  sStr := sStr + 'Movimiento salida SGA<br>';

  if (fOldCantidad>0) or (fOldCantidadBase>0) then
  begin

    if not bErr then try
      bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message + ' - ' + sMsg;
      end;
    end;

    if not bErr then try
      MovIdentificadorIME := SQL_Execute ( Conn,'select NEWID()');
      MovIdentificadorIME := StringReplace ( MovIdentificadorIME, '{', '', [] );
      MovIdentificadorIME := StringReplace ( MovIdentificadorIME, '}', '', [] );
    except
      on E:Exception do begin
        sMsg := E.Message;
        bErr := TRUE;
      end;
    end;

    sSQL := 'INSERT INTO TmpIME_MovimientoStock ( ' +
            '    CodigoEmpresa, Ejercicio, Periodo, Fecha, Serie, Documento, ' +
            '    CodigoArticulo, CodigoAlmacen, AlmacenContrapartida, Partida, ' +
            '    Partida2_, CodigoColor_, GrupoTalla_, CodigoTalla01_, TipoMovimiento, ' +
            '    Unidades, UnidadMedida1_, Precio, Importe, Unidades2_, UnidadMedida2_, ' +
            '    FactorConversion_, Comentario, CodigoCanal, CodigoCliente, CodigoProveedor, ' +
            '    FechaCaduca, Ubicacion, OrigenMovimiento, EmpresaOrigen, MovOrigen, ' +
            '    EjercicioDocumento, NumeroSerieLc, IdProcesoIME, MovIdentificadorIME, ' +
            '    StatusTraspasadoIME, TipoImportacionIME, DocumentoUnico, FechaRegistro, ' +
            '    MovPosicion ' +
            '  ) ' +
            'VALUES ( ' +
            IntToStr(CodigoEmpresa.Stocks) + ', ' +
            IntToStr(YY) + ', ' +
            IntToStr(MM) + ', ' +
            SQL_DateToStr ( Now() ) + ', ' +
            '''' + SQL_Str(Serie) + ''', ' +
            IntToStr(Documento) + ', ' +
            '''' + SQL_Str(gaMov.CodigoArticulo) + ''', ' +
            '''' + SQL_Str(gaMov.CodigoAlmacen) + ''', ' +
            '''' + SQL_Str(AlmacenContrapartida) + ''', ' +
            '''' + SQL_Str(sOldPartida) + ''', ' +
            ''''', ' +
            '''' + SQL_Str(sOldColor) + ''', ' +
            IntToStr(gaMov.GrupoTalla) + ', ' +
            '''' + SQL_Str(sOldTalla) + ''', ' +
            '2, ' +
            SQL_FloatToStr ( fOldCantidad ) + ', '+
            '''' + SQL_Str( AnsiUpperCase(sOldUnidadMedida) ) + ''', ' +
            SQL_FloatToStr ( gaMov.Precio ) + ', ' +
            SQL_FloatToStr ( fOldCantidad * gaMov.Precio ) + ', ' +
            SQL_FloatToStr ( fOldCantidadBase ) + ', '+
            '''' + SQL_Str( AnsiUpperCase(sOldUnidadMedidaBase) ) + ''', ' +
            SQL_FloatToStr ( fOldFactorConversion ) + ', '+
            '''Salida regularización'', ' +
            '''' + SQL_Str( CodigoCanal ) + ''', ' +
            '''' + SQL_Str( CodigoCliente ) + ''', ' +
            '''' + SQL_Str( CodigoProveedor ) + ''', ' +
            sFechaCaduca + ', ' +
            '''' + SQL_Str( Ubicacion ) + ''', ' +
            '''S'', ' +
            IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
            '''' + SQL_Str( MovOrigen ) + ''', ' +
            IntToStr(EjercicioDocumento) + ', ' +
            '''' + SQL_Str( NumeroSerieLc ) + ''', ' +
            '''' + SQL_GUID_ToStr( IdProcesoIME ) + ''', ' +
            '''' + SQL_GUID_ToStr( MovIdentificadorIME ) + ''', ' +
            IntToStr(StatusTraspasadoIME) + ', ' +
            IntToStr(TipoImportacionIME) + ', ' +
            IntToStr(DocumentoUnico) + ', ' +
            SQL_DateTimeToStr ( FechaRegistro + OneSecond ) + ', ' +
            '''' + SQL_GUID_ToStr(gaMov.MovPosicion) + ''' )';

    sStr := sStr + 'Movimiento salida Sage: ' + sSQL + '<br>';

    if not bErr then try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message;
      end;
    end;

  end;

  sSQL := 'INSERT INTO ' +
          '  FS_Operations ( oper_product_code, oper_name, oper_datetime, oper_status, oper_params, oper_CodigoEmpresa ) ' +
          'VALUES ( ' +
          '''E4E8'', ' +
          '''MOVIMIENTOSTOCK'', ' +
          SQL_DateTimeToStr(Now()) + ', ' +
          '0, ' +
          '''{"IdProcesoIME":"' + SQL_GUID_ToStr(IdProcesoIME) + '","MantenerDatos":"1","MantenerErrores":"1","Módulos":"4","CodigoEmpresa":' + IntToStr(CodigoEmpresa.Stocks) + '}'', ' +
          IntToStr(CodigoEmpresa.Stocks) +
          ')';
  //gaLogFile.Write(sSQL, CONST_LOGID_BBDD, LOG_LEVEL_INFO );

  sStr := sStr + 'FS_Operations: ' + sSQL + '<br>';

  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
    sSQL := 'SELECT IDENT_CURRENT(''FS_Operations'')';
    iLastID := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if not bErr then try
    // Conn.CommitTrans;
  except
    on e:exception do begin
      bErr := true;
      sMsg := e.Message;
    end;
  end;

  if bErr then begin
    // Conn.RollbackTrans;
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + sMsg + '","Data":[]}';
    Exit;
  end;

  LP := LOG_Clear();
  LP.MovOrigen := gaMov.MovOrigen;
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'REGULARIZE-STOCK', 'Regularización del artículo ' + gaMov.CodigoArticulo, @LP );

  Result := '{"Result":"OK","Error":"","Data":[';
  Result := Result + ']}';

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ REALITZAR UN MOVIMENT D'ENTRADA D'STOCK                               │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1entradaStockAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  YY, DD, MM, HH, NN, SS, MS: WORD;
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  aUbicacion: TSGAUbicacion;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  CodigoArticulo: String;
  Partida: String;
  Precio: Double;
  CodigoAlmacen: String;
  Comentarios: String;
  Ubicacion: String;
  OrigenMovimiento: String;
  MovOrigen: String;
  Serie: String;
  Documento: Integer;
  NumeroSerieLc: String;
  EjercicioDocumento: Integer;
  FechaCaduca: String;
  CodigoCliente: String;
  CodigoCanal: String;
  CodigoColor_: String;
  GrupoTalla_: Integer;
  CodigoTalla01_: String;
  UnidadMedida1_: String;
  TipoMovimiento: Integer;
  Importe: Double;
  FactorConversion_: Double;
  Comentario: string;
  CodigoProveedor: string;
  IdProcesoIME: string;
  TipoImportacionIME: Integer;
  DocumentoUnico: Integer;
  FechaRegistro: TDateTime;
  MovPosicion: String;
  MovIdentificadorIME: String;
  bResult: Boolean;
  iLastID: Integer;
  Mensaje: String;
  iStatus: Integer;
  CodigoUbicacion: String;
  CodigoUsuario: Integer;
  IdDocumento: String;
  StatusTraspasadoIME: Integer;
  bErr: Boolean;
  sMsg: String;
  TratamientoPartidas: Boolean;
  Unidades: Double;
  UnidadMedida: String;
  UnidadesBase: Double;
  UnidadMedidaBase: String;
  FactorConversion: Double;
  gaMov: TSGAMovimientoStock;
  contentfields: TStringList;
  dFechaCaduca: TDate;
  Matricula: String;
  RestriccionesUbicacion: TUbicacionRestricciones;
  OcupacionActual: TUbicacionOcupacionActual;
  TieneRestriccion: TResultadoRestriccion;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  sMsg := '';
  bErr := FALSE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.Values['UUID'];

  CodigoAlmacen := contentfields.values['CodigoAlmacen'];
  if CodigoAlmacen='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    Exit;
  end;

  Matricula       := contentfields.values['Matricula'];
  CodigoUbicacion := contentfields.values['CodigoUbicacion'];

  // Conversió al codi d'article real
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación no especificado","Data":[]}';
    Exit;
  end;

  if Matricula<>'' then
  begin
    if (not FS_SGA_MatriculaEnUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion, Matricula ) ) then
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El palet ya no se encuentra en esta ubicación","Data":[]}';
      Exit;
    end;
  end;

  aUbicacion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );
  if aUbicacion.CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de la ubicación no es válido","Data":[]}';
    Exit;
  end;

  CodigoArticulo := contentfields.values['CodigoArticulo'];

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );

  if CodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;

  TratamientoPartidas := ARTICULO_TratamientoPartida ( Conn, CodigoEmpresa, CodigoArticulo );

  Partida := (contentfields.values['Partida']);
  if (Partida='') and (TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de partida no especificado","Data":[]}';
    Exit;
  end;

  if (Partida<>'') and (not TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no requiere partida","Data":[]}';
    Exit;
  end;

  (*
  if (not aUbicacion.MultiRef) or (not aUbicacion.MultiLote) then begin
    if not SGA_ALMACEN_Permitir_Entrada_Ubicacion ( Conn, CodigoEmpresa, aUbicacion, Codigoarticulo, Partida ) then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La ubicación no permite más de un artículo o partida distintos","Data":[]}';
      Exit;
    end;
  end;
  *)

  Unidades         := FS_StrToFloatDef ( contentfields.values['Unidades'], 0 );
  UnidadMedida     := ( AnsiUpperCase(contentfields.values['UnidadMedida']) );
  UnidadMedidaBase := ( AnsiUpperCase(contentfields.values['UnidadMedidaBase']) ); //FS_SGA_ARTICULO_UnidadBase ( Conn, CodigoEmpresa.Articulos, CodigoArticulo );

  FS_SGA_Check_UnidadMedidaBase ( Conn, CodigoEmpresa, CodigoArticulo, UnidadMedida, UnidadMedidaBase );

  if (UnidadMedidaBase='') and (gbTratamientoSimplificado) then
    Unidadmedida := '';

  UnidadesBase :=
    SGA_FS_ARTICULO_ConversionUnidades (
      Conn,
      CodigoEmpresa,
      CodigoArticulo,
      Unidades,
      UnidadMedidaBase,
      UnidadMedida,
      FactorConversion
    );

  if FactorConversion=0 then
  begin
    UnidadesBase := FS_StrToFloatDef ( contentfields.values['UnidadesBase'], 0 );
  end;

  if (UnidadMedida<>'') and (UnidadMedidaBase='') then
  begin
    UnidadMedidaBase := UnidadMedida;
    FactorConversion := 1;
  end;

  if (Unidades=0) and (UnidadesBase=0) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Las unidades no pueden ser 0","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Validación restricciones'}

  RestriccionesUbicacion := FS_SGA_UBICACION_Restricciones ( Conn, CodigoEmpresa, CodigoUbicacion );
  OcupacionActual        := FS_SGA_UBICACION_OcupacionActual ( Conn, CodigoEmpresa, CodigoUbicacion );
  TieneRestriccion       := FS_SGA_UBICACION_CheckRestriccionesArticulo (
                              Conn,
                              CodigoEmpresa,
                              CodigoUbicacion,
                              RestriccionesUbicacion,
                              OcupacionActual,
                              CodigoArticulo,
                              Partida,
                              UnidadesBase
                            );

  if TieneRestriccion.Error then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Restricción de ubicación: ' + JSON_Str(TieneRestriccion.Mensaje) + '","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Realitzar operació'}

  DecodeDateTime ( Now(), YY, MM, DD, HH, NN, SS, MS );

  YY             := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );
  Serie          := contentfields.values['Serie'];
  Documento      := StrToIntDef ( contentfields.values['Documento'], 0 );
  CodigoColor_   := contentfields.values['CodigoColor_'];
  GrupoTalla_    := StrToIntDef(contentfields.values['GrupoTalla_'],0);
  CodigoTalla01_ := contentfields.values['CodigoTalla01_'];
  TipoMovimiento := StrToIntDef ( contentfields.values['TipoMovimiento'], 1 );
  Precio         := FS_StrToFloatDef ( contentfields.values['Precio'], 0 );

  if Precio=0 then
  begin
    Precio :=
      ARTICULO_ConsultarPrecioStock (
        Conn,
        CodigoEmpresa,
        CodigoArticulo,
        Partida,
        CodigoColor_,
        CodigoTalla01_,
        aUbicacion.CodigoAlmacen,
        GrupoTalla_
      );
  end;

  Importe              := Unidades * Precio;
  FactorConversion_    := FactorConversion; // FS_StrToFloatDef ( contentfields.values['FactorConversion_'], 1.0 );
  Comentario           := contentfields.values['Comentario'];
  CodigoCanal          := contentfields.values['CodigoCanal'];
  CodigoCliente        := contentfields.values['CodigoCliente'];
  CodigoProveedor      := contentfields.values['CodigoProveedor'];
  FechaCaduca          := contentfields.values['FechaCaduca'];
  Ubicacion            := contentfields.values['Ubicacion'];
  OrigenMovimiento     := contentfields.values['OrigenMovimiento'];
  EjercicioDocumento   := StrToIntDef ( contentfields.values['EjercicioDocumento'], 0 );
  NumeroSerieLc        := contentfields.values['NumeroSerieLc'];
  StatusTraspasadoIME  := 0;
  TipoImportacionIME   := 2;
  DocumentoUnico       := StrToIntDef ( contentfields.values['DocumentoUnico'], 0 );
  IdDocumento          := contentfields.values['IdDocumento'];
  FechaRegistro        := Now();

  if Comentario='' then
  begin
    Comentario := 'Entrada manual PDA';
  end;

  if not bErr then try
    MovPosicion        := SQL_Execute ( Conn,'select NEWID()');
    MovPosicion        := StringReplace ( MovPosicion, '{', '', [] );
    MovPosicion        := StringReplace ( MovPosicion, '}', '', [] );
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  if not bErr then try
    MovIdentificadorIME := SQL_Execute ( Conn,'select NEWID()');
    MovIdentificadorIME := StringReplace ( MovIdentificadorIME, '{', '', [] );
    MovIdentificadorIME := StringReplace ( MovIdentificadorIME, '}', '', [] );
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  if not bErr then try
    IdProcesoIME := SQL_Execute ( Conn,'select NEWID()');
    IdProcesoIME := StringReplace ( IdProcesoIME, '{', '', [] );
    IdProcesoIME := StringReplace ( IdProcesoIME, '}', '', [] );
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  if (IdDocumento='') or (IdDocumento='0') then begin
    IdDocumento := '00000000-0000-0000-0000-000000000000';
  end;

  if OrigenMovimiento='' then begin
    OrigenMovimiento := 'E';
  end;

  MovOrigen := SQL_Execute ( Conn, 'SELECT NEWID()' );

  if (FechaCaduca='') or (FechaCaduca='0') then begin
    dFechaCaduca := 0;
    FechaCaduca := 'NULL';
  end else begin
    dFechaCaduca := StrToDate(FechaCaduca);
    FechaCaduca  := SQL_DateToStr(dFechaCaduca);
  end;

  {$ENDREGION}

  {$REGION 'Realitzar operació'}

  iLastID := 0;
  iStatus := 1;

  SGA_FS_ALMACEN_PrepareMov ( gaMov );
  gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
  gaMov.EmpresaOrigen          := CodigoEmpresa.EmpresaOrigen;
  gaMov.CodigoUsuario          := CodigoUsuario;
  gaMov.Ejercicio              := YY;
  gaMov.Periodo                := MM;
  gaMov.Fecha                  := Date();
  gaMov.FechaHora              := Now();
  gaMov.CodigoAlmacen          := CodigoAlmacen;
  gaMov.CodigoUbicacion        := CodigoUbicacion;
  gaMov.CodigoArticulo         := CodigoArticulo;
  gaMov.Partida                := Partida;
  gaMov.TipoMovimiento         := TipoMovimiento;
  gaMov.OrigenMovimiento       := OrigenMovimiento;
  gaMov.Unidades               := Unidades;
  gaMov.UnidadMedida           := AnsiUpperCase(UnidadMedida);
  gaMov.UnidadesBase           := UnidadesBase;
  gaMov.UnidadMedidaBase       := AnsiUpperCase(UnidadMedidaBase);
  gaMov.FactorConversion       := FactorConversion;
  gaMov.Comentario             := Comentario;
  gaMov.IdProcesoIME           := IdProcesoIME;
  gaMov.IdDocumento            := IdDocumento;
  gaMov.Serie                  := Serie;
  gaMov.FechaCaduca            := dFechaCaduca;
  gaMov.Precio                 := Precio;
  gaMov.MovOrigen              := MovOrigen;
  gaMov.CodigoProveedor        := CodigoProveedor;
  gaMov.CodigoColor            := CodigoColor_;
  gaMov.CodigoTalla            := CodigoTalla01_;
  gaMov.GrupoTalla             := GrupoTalla_;
  gaMov.Matricula              := Matricula;
  gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );

  if not bErr then try
    bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  gaMov.Importe := gaMov.Precio * gaMov.UnidadesBase;

  sSQL := 'INSERT INTO TmpIME_MovimientoStock ( ' +
          '    CodigoEmpresa, Ejercicio, Periodo, Fecha, Serie, Documento, ' +
          '    CodigoArticulo, CodigoAlmacen, Partida, ' +
          '    CodigoColor_, GrupoTalla_, CodigoTalla01_, TipoMovimiento, ' +
          '    Unidades, UnidadMedida1_, Precio, Importe, Unidades2_, UnidadMedida2_, ' +
          '    FactorConversion_, Comentario, CodigoCanal, CodigoCliente, CodigoProveedor, ' +
          '    FechaCaduca, Ubicacion, OrigenMovimiento, EmpresaOrigen, MovOrigen, ' +
          '    EjercicioDocumento, NumeroSerieLc, IdProcesoIME, MovIdentificadorIME, ' +
          '    StatusTraspasadoIME, TipoImportacionIME, DocumentoUnico, FechaRegistro, ' +
          '    MovPosicion ' +
          '  ) ' +
          'VALUES ( ' +
          IntToStr(CodigoEmpresa.Stocks) + ', ' +
          IntToStr(YY) + ', ' +
          IntToStr(MM) + ', ' +
          SQL_DateToStr ( Now() ) + ', ' +
          '''' + SQL_Str(Serie) + ''', ' +
          IntToStr(Documento) + ', ' +
          '''' + SQL_Str(gaMov.CodigoArticulo) + ''', ' +
          '''' + SQL_Str(gaMov.CodigoAlmacen) + ''', ' +
          '''' + SQL_Str(gaMov.Partida) + ''', ' +
          '''' + SQL_Str(gaMov.CodigoColor) + ''', ' +
          IntToStr(gaMov.GrupoTalla) + ', ' +
          '''' + SQL_Str(gaMov.CodigoTalla) + ''', ' +
          IntToStr(gaMov.TipoMovimiento) + ', ' +
          SQL_FloatToStr ( gaMov.Unidades ) + ', '+
          '''' + SQL_Str( gaMov.UnidadMedida ) + ''', ' +
          SQL_FloatToStr ( gaMov.Precio ) + ', ' +
          SQL_FloatToStr ( gaMov.Precio * Unidades ) + ', ' +
          SQL_FloatToStr ( gaMov.UnidadesBase ) + ', '+
          '''' + SQL_Str( gaMov.UnidadMedidaBase ) + ''', ' +
          SQL_FloatToStr ( gaMov.FactorConversion ) + ', '+
          '''' + SQL_Str( gaMov.Comentario ) + ''', ' +
          '''' + SQL_Str( gaMov.CodigoCanal ) + ''', ' +
          '''' + SQL_Str( gaMov.CodigoCliente ) + ''', ' +
          '''' + SQL_Str( gaMov.CodigoProveedor ) + ''', ' +
          FechaCaduca + ', ' +
          '''' + SQL_Str( gaMov.Ubicacion ) + ''', ' +
          '''' + SQL_Str( gaMov.OrigenMovimiento ) + ''', ' +
          IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
          '''' + SQL_GUID_ToStr( gaMov.MovOrigen ) + ''', ' +
          IntToStr(gaMov.EjercicioDocumento) + ', ' +
          '''' + SQL_Str( gaMov.NumeroSerieLc ) + ''', ' +
          '''' + SQL_GUID_ToStr( gaMov.IdProcesoIME ) + ''', ' +
          '''' + SQL_GUID_ToStr( gaMov.MovIdentificadorIME ) + ''', ' +
          IntToStr(StatusTraspasadoIME) + ', ' +
          IntToStr(TipoImportacionIME) + ', ' +
          IntToStr(DocumentoUnico) + ', ' +
          SQL_DateTimeToStr ( gaMov.FechaHora ) + ', ' +
          '''' + SQL_GUID_ToStr(gaMov.MovPosicion) + ''' ' +
          ')';

  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  sSQL := 'INSERT INTO ' +
          '  FS_Operations ( oper_product_code, oper_name, oper_datetime, oper_status, oper_params, oper_CodigoEmpresa ) ' +
          'VALUES ( ' +
          '''E4E8'', ' +
          '''MOVIMIENTOSTOCK'', ' +
          SQL_DateTimeToStr(Now()) + ', ' +
          '0, ' +
          '''{"IdProcesoIME":"' + SQL_GUID_ToStr(IdProcesoIME) + '","MantenerDatos":"1","MantenerErrores":"1","Módulos":"4","CodigoEmpresa":' + IntToStr(CodigoEmpresa.Stocks) + '}'', ' +
          IntToStr(CodigoEmpresa.Stocks) +
          ')';
  //gaLogFile.Write(sSQL, CONST_LOGID_BBDD, LOG_LEVEL_INFO );

  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
    sSQL := 'SELECT IDENT_CURRENT(''FS_Operations'')';
    iLastID := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  (*
  if (iLastID<>0) and (not WaitOperationDone ( Conn, iLastID, Status, Mensaje )) then begin

    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + Mensaje + '","Data":[]}';
    Exit;

  end;

  if iStatus<>1 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Error":"' + Mensaje + '","Data":[';
    Result := Result + ']}';
  end else begin
    Result := '{"Result":"OK","Error":"","Data":[';
    Result := Result + ']}';
  end;
  *)

  if not bErr then try
    // Conn.CommitTrans;
  except
    on e: exception do begin
      bErr := true;
      sMsg := e.Message;
    end;
  end;

  if bErr then begin
    // Conn.RollbackTrans;
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + sMsg + '","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  LP := LOG_Clear();
  LP.MovOrigen := gaMov.MovOrigen;
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'STOCK-IN', 'Entrada del artículo ' + gaMov.CodigoArticulo, @LP );

  Result := '{"Result":"OK","Error":"","Data":[]}';

end;


procedure WebModule1expedicionDisponibleAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  LineasPosicion: string;
  UdNecesarias: Double;
  UdExpedidas: Double;
  UdSaldo: Double;
  Q1: TADOQuery;
  CodigoArticulo: string;
  DescripcionArticulo: string;
  Partida: string;
  UnidadMedida: string;
  CodigoArticuloAlternativo: String;

  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';

    Exit;
  end;

  LineasPosicion := (contentfields.values['LineasPosicion']);
  if LineasPosicion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Posición de línea no especificado","Data":[]}';

    Exit;
  end;

  CodigoArticulo := (contentfields.values['CodigoArticulo']);
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion);

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';

      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  fsppl.CodigoArticulo, fsppl.DescripcionArticulo, fsppl.Partida, fsppl.UnidadMedida, ' +
          '  fsppl.UdNecesarias, fsppl.UdExpedidas, fsppl.UdSaldo, fsa.CodigoAlternativo AS CodigoArticuloAlternativo ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'LEFT JOIN FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) fsa ' +
          'ON ' +
          '  fsppl.CodigoArticulo = fsa.CodigoArticulo ' +
          'WHERE ' +
          '  fsppl.PreparacionId = ' + IntToStr(IdPreparacion) + ' AND ' +
          '  fsppl.LineasPosicion = ''' + SQL_Str(LineasPosicion) + '''';
  Q1 := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q1.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q1);
      FreeAndNil(Q);
      Exit;
    end;
  end;

  if not Q1.Eof then begin
    CodigoArticulo            := Q1.FieldByName('CodigoArticulo').AsString;
    CodigoArticuloAlternativo := Q1.FieldByName('CodigoArticuloAlternativo').AsString;
    DescripcionArticulo       := Q1.FieldByName('DescripcionArticulo').AsString;
    Partida                   := Q1.FieldByName('Partida').AsString;
    UnidadMedida              := AnsiUpperCase(Q1.FieldByName('UnidadMedida').AsString);
    UdNecesarias              := Q1.FieldByName('UdNecesarias').AsFloat;
    UdExpedidas               := Q1.FieldByName('UdExpedidas').AsFloat;
    UdSaldo                   := Q1.FieldByName('UdSaldo').AsFloat;
  end else begin
    CodigoArticulo            := '';
    CodigoArticuloAlternativo := '';
    DescripcionArticulo       := '';
    Partida                   := '';
    UnidadMedida              := '';
    UdNecesarias              := 0;
    UdExpedidas               := 0;
    UdSaldo                   := 0;
  end;

  Q1.Close;
  FreeAndNil(Q1);

  sSQL := 'SELECT ' +
          '  CodigoEmpresa, IdPreparacion, Partida, UnidadMedida, ' +
          '  SUM( Cantidad ) as Cantidad, ' +
          '  SUM(CASE WHEN LineaPedidoCliente<>''00000000-0000-0000-0000-000000000000'' THEN 0 ELSE Cantidad END) AS CantidadDisponible, ' +
          '  SUM(CASE WHEN LineaPedidoCliente=''00000000-0000-0000-0000-000000000000'' THEN 0 ELSE Cantidad END) AS CantidadExpedida ' +
          'FROM FS_SGA_AcumuladoPendiente WITH (NOLOCK) ' +
          'WHERE ' +
          '  IdPreparacion = ' + intToStr( IdPreparacion ) + ' AND ' +
          '  LineaPedidoCliente IN ( ''00000000-0000-0000-0000-000000000000'',''' + SQL_Str ( LineasPosicion ) + ''') AND ' +
          '  CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          'GROUP BY ' +
          '  CodigoEmpresa, IdPreparacion, Partida, UnidadMedida ' +
          'HAVING ' +
          '  SUM (Cantidad) > 0';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":';
  iNumRegs := 0;

  Result := Result + '{' +
                     '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
                     '"IdPreparacion":"' + Q.FieldByName('IdPreparacion').AsString + '",' +
                     '"CodigoArticulo":"' + JSON_Str(CodigoArticulo) + '",' +
                     '"DescripcionArticulo":"' + JSON_Str(DescripcionArticulo) + '",' +
                     '"CodigoArticuloAlternativo":"' + JSON_Str(CodigoArticuloAlternativo) + '",' +
                     '"Partida":"' + JSON_Str(Partida) + '",' +
                     '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(UnidadMedida)) + '",' +
                     '"UdNecesarias":' + SQL_FloatToStr(UdNecesarias) + ',' +
                     '"UdExpedidas":' + SQL_FloatToStr(UdExpedidas) + ',' +
                     '"UdSaldo":' + SQL_FloatToStr(UdSaldo) + ',' +
                     '"Detalles":[';


  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
                       '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
                       '"Cantidad":' + SQL_FloatToStr(Q.FieldByName('Cantidad').AsFloat) + ',' +
                       '"CantidadDisponible":' + SQL_FloatToStr(Q.FieldByName('CantidadDisponible').AsFloat) + ',' +
                       '"CantidadExpedida":' + SQL_FloatToStr(Q.FieldByName('CantidadExpedida').AsFloat) + ',' +
                       '"Limite":' + SQL_FloatToStr(Q.FieldByName('CantidadDisponible').AsFloat + Q.FieldByName('CantidadExpedida').AsFloat) +
                       '}';

    Q.Next;

  end;

  Result := Result + ']}}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ RETORNA LES PARTIDES QUE S'HAN PREPARAT D'UN ARTICLE CONCRET          │ \\
// │ AMB TALLES I COLORS (Bryocan)                                        │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1expedicionPartidasArticuloBryocanTCAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoArticulo: String;
  sFiltro: string;
  IdentificadorExp: string;
  t: TStringList;
  EjercicioPedido: Integer;
  NumeroPedido: Integer;
  SeriePedido: string;
  TratamientoPartidas: Boolean;
  fTotal, fTotalBase: Double;
  contentfields: TStringList;
  CodigoTalla: String;
  CodigoColor: String;
  sFechaCaduca: string;
  PickingId: Integer;
  LineasPosicion: String;
  sPartida: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';

    Exit;
  end;

  (*
  PickingId := StrToIntDef(contentfields.values['PickingId'],0);
  if PickingId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de línea no especificado","Data":[]}';
    Exit;
  end;
  *)

  sFiltro := '';

  CodigoArticulo := (contentfields.values['CodigoArticulo']);
  if CodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';

    Exit;
  end;

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );
  if CodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo inválido","Data":[]}';
    Exit;
  end;

  CodigoTalla := (contentfields.values['CodigoTalla']);
  CodigoColor := (contentfields.values['CodigoColor']);

  TratamientoPartidas := ARTICULO_TratamientoPartida ( Conn, CodigoEmpresa, CodigoArticulo );

  // Mirem si l'article forma part de la preparació o no
  sSQL := 'SELECT COUNT(*) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
          '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + '''';
  if SQL_Execute(Conn, sSQL)=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo inválido","Data":[]}';
    Exit;
  end;

  if not TratamientoPartidas then begin

    sPartida := 'AND Partida = '''' ';

  end else begin

    sPartida := 'AND Partida <> '''' ';

  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL :=
    'SELECT LineasPosicion FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND PickingId = ' + IntToStr(PickingId);
  LineasPosicion := SQL_Execute ( Conn, sSQL );

  sSQL := 'SELECT COUNT(DISTINCT Partida) ' +
          'FROM dbo.FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
          'WHERE ' +
          '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          sPartida +
          '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
          '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
          '  AND Partida IS NOT NULL ' +
          '  AND CantidadBase > 0 ' +
          'GROUP BY LineaPedidoAsignada';
  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT DISTINCT ' +
          '  fsap.Partida, fsap.FechaCaduca, ' +
          '  fsap.Cantidad AS CantidadDisponible, ' +
          '  fsap.CantidadBase AS CantidadDisponibleBase, ' +
          '  ( ' +
          '    SELECT ' +
          '      ISNULL(SUM(Cantidad),0) ' +
          '    FROM dbo.FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fsap2 ' +
          '    WHERE ' +
          '      fsap2.IdPreparacion = fsap.IdPreparacion ' +
          '    	 AND fsap2.CodigoArticulo = fsap.CodigoArticulo ' +
          '      AND fsap2.CodigoTalla01_ = fsap.CodigoTalla01_ ' +
          '      AND fsap2.CodigoColor_ = fsap.CodigoColor_ ' +
          '      AND fsap2.Partida = fsap.Partida ' +
          '      AND fsap2.LineaPedidoCliente <> ''00000000-0000-0000-0000-000000000000'' ' +
          '  ) AS CantidadExpedida, ' +
          '  ( ' +
          '    SELECT ' +
          '      ISNULL(SUM(CantidadBase),0) ' +
          '    FROM dbo.FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fsap2 ' +
          '    WHERE ' +
          '      fsap2.IdPreparacion = fsap.IdPreparacion ' +
          '    	 AND fsap2.CodigoArticulo = fsap.CodigoArticulo ' +
          '      AND fsap2.CodigoTalla01_ = fsap.CodigoTalla01_ ' +
          '      AND fsap2.CodigoColor_ = fsap.CodigoColor_ ' +
          '      AND fsap2.Partida = fsap.Partida ' +
          '      AND fsap2.LineaPedidoCliente <> ''00000000-0000-0000-0000-000000000000'' ' +
          '  ) AS CantidadExpedidaBase ' +
          'FROM dbo.FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fsap ' +
          'WHERE ' +
          '  fsap.IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND fsap.PickingId = 0 ' +
          '  AND fsap.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          //'  AND (fsap.Cantidad>0 OR fsap.CantidadBase>0) ' +
          sPartida +
          '  AND fsap.Partida IS NOT NULL ' +
          '  AND fsap.CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
          '  AND fsap.CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
          '  AND fsap.LineaPedidoAsignada IN ( ''' + SQL_GUID_ToStr(GUID0) + ''', ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ) ' +
          'ORDER BY ' +
          '  fsap.Partida ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  fTotal     := 0;
  fTotalBase := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    fTotal     := Q.FieldByName('CantidadDisponible').AsFloat + Q.FieldByName('CantidadExpedida').AsFloat;
    fTotalBase := Q.FieldByName('CantidadDisponibleBase').AsFloat + Q.FieldByName('CantidadExpedidaBase').AsFloat;

    if Q.FieldByName('FechaCaduca').AsDateTime>0 then
      sFechaCaduca := FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaCaduca').AsDateTime)
    else
      sFechaCaduca := '';

    Result := Result + '{' +
                       '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
                       '"FechaCaduca":"' + JSON_Str(sFechaCaduca) + '",' +
                       '"CantidadDisponible":' + SQL_FloatToStr(Q.FieldByName('CantidadDisponible').AsFloat)  + ',' +
                       '"CantidadDisponibleBase":' + SQL_FloatToStr(Q.FieldByName('CantidadDisponibleBase').AsFloat)  + ',' +
                       '"CantidadExpedida":' + SQL_FloatToStr(Q.FieldByName('CantidadExpedida').AsFloat) + ',' +
                       '"CantidadExpedidaBase":' + SQL_FloatToStr(Q.FieldByName('CantidadExpedidaBase').AsFloat) + ',' +
                       '"Cantidad":' + SQL_FloatToStr(fTotal) + ',' +
                       '"CantidadBase":' + SQL_FloatToStr(fTotalBase) +
                       '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ RETORNA LES PARTIDES QUE S'HAN PREPARAT D'UN ARTICLE CONCRET          │ \\
// │ AMB TALLES I COLORS                                                   │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1expedicionPartidasArticuloTCAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoArticulo: String;
  sFiltro: string;
  IdentificadorExp: string;
  t: TStringList;
  EjercicioPedido: Integer;
  NumeroPedido: Integer;
  SeriePedido: string;
  TratamientoPartidas: Boolean;
  fTotal, fTotalBase: Double;
  contentfields: TStringList;
  CodigoTalla: String;
  CodigoColor: String;
  sFechaCaduca: string;
  PickingId: Integer;
  LineasPosicion: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';

    Exit;
  end;

  PickingId := StrToIntDef(contentfields.values['PickingId'],0);
  (*
  if PickingId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de línea no especificado","Data":[]}';
    Exit;
  end;
  *)

  sFiltro := '';

  CodigoArticulo := (contentfields.values['CodigoArticulo']);
  if CodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';

    Exit;
  end;

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );
  if CodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo inválido","Data":[]}';
    Exit;
  end;

  CodigoTalla := (contentfields.values['CodigoTalla']);
  CodigoColor := (contentfields.values['CodigoColor']);

  TratamientoPartidas := ARTICULO_TratamientoPartida ( Conn, CodigoEmpresa, CodigoArticulo );

  // Mirem si l'article forma part de la preparació o no
  sSQL := 'SELECT COUNT(*) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND PickingId = ' + IntToStr(PickingId) + ' ' +
          '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
          '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + '''';
  if SQL_Execute(Conn, sSQL)=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo inválido","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL :=
    'SELECT LineasPosicion FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND PickingId = ' + IntToStr(PickingId);
  LineasPosicion := SQL_Execute ( Conn, sSQL );

  sSQL := 'SELECT COUNT(DISTINCT Partida) ' +
          'FROM dbo.FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
          'WHERE ' +
          '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
          //'  AND PickingId = ' + IntToStr(PickingId) + ' ' +
          '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND Partida<>'''' ' +
          '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
          '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
          '  AND Partida IS NOT NULL ' +
          '  AND CantidadBase > 0 ' +
          'GROUP BY LineaPedidoAsignada';
  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  if not TratamientoPartidas then begin

    gaLogFile.Write('Sin partidas');
    Result := '{"Result":"OK","Error":"","TotalRecords":0,"NumPages":0,"NumRecords":0,"Data":[]}';
    Exit;

  end;

  sSQL := 'SELECT DISTINCT ' +
          '  fsap.Partida, fsap.FechaCaduca, ' +
          '  fsap.Cantidad AS CantidadDisponible, ' +
          '  fsap.CantidadBase AS CantidadDisponibleBase, ' +
          '  ( ' +
          '    SELECT ' +
          '      ISNULL(SUM(Cantidad),0) ' +
          '    FROM dbo.FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fsap2 ' +
          '    WHERE ' +
          '      fsap2.IdPreparacion = fsap.IdPreparacion ' +
          '    	 AND fsap2.CodigoArticulo = fsap.CodigoArticulo ' +
          '      AND fsap2.CodigoTalla01_ = fsap.CodigoTalla01_ ' +
          '      AND fsap2.CodigoColor_ = fsap.CodigoColor_ ' +
          '      AND fsap2.Partida = fsap.Partida ' +
          '      AND fsap2.LineaPedidoCliente <> ''00000000-0000-0000-0000-000000000000'' ' +
          '  ) AS CantidadExpedida, ' +
          '  ( ' +
          '    SELECT ' +
          '      ISNULL(SUM(CantidadBase),0) ' +
          '    FROM dbo.FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fsap2 ' +
          '    WHERE ' +
          '      fsap2.IdPreparacion = fsap.IdPreparacion ' +
          '    	 AND fsap2.CodigoArticulo = fsap.CodigoArticulo ' +
          '      AND fsap2.CodigoTalla01_ = fsap.CodigoTalla01_ ' +
          '      AND fsap2.CodigoColor_ = fsap.CodigoColor_ ' +
          '      AND fsap2.Partida = fsap.Partida ' +
          '      AND fsap2.LineaPedidoCliente <> ''00000000-0000-0000-0000-000000000000'' ' +
          '  ) AS CantidadExpedidaBase ' +
          'FROM dbo.FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fsap ' +
          'WHERE ' +
          '  fsap.IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
          //'  AND fsap.PickingId = 0 ' +
          '  AND fsap.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND (fsap.Cantidad>0 OR fsap.CantidadBase>0) ' +
          '  AND fsap.Partida<>'''' ' +
          '  AND fsap.Partida IS NOT NULL ' +
          '  AND fsap.CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
          '  AND fsap.CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
          '  AND fsap.LineaPedidoAsignada IN ( ''' + SQL_GUID_ToStr(GUID0) + ''', ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ) ' +
          'ORDER BY ' +
          '  fsap.Partida ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  fTotal     := 0;
  fTotalBase := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    fTotal     := Q.FieldByName('CantidadDisponible').AsFloat + Q.FieldByName('CantidadExpedida').AsFloat;
    fTotalBase := Q.FieldByName('CantidadDisponibleBase').AsFloat + Q.FieldByName('CantidadExpedidaBase').AsFloat;

    if Q.FieldByName('FechaCaduca').AsDateTime>0 then
      sFechaCaduca := FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaCaduca').AsDateTime)
    else
      sFechaCaduca := '';

    Result := Result + '{' +
                       '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
                       '"FechaCaduca":"' + JSON_Str(sFechaCaduca) + '",' +
                       '"CantidadDisponible":' + SQL_FloatToStr(Q.FieldByName('CantidadDisponible').AsFloat)  + ',' +
                       '"CantidadDisponibleBase":' + SQL_FloatToStr(Q.FieldByName('CantidadDisponibleBase').AsFloat)  + ',' +
                       '"CantidadExpedida":' + SQL_FloatToStr(Q.FieldByName('CantidadExpedida').AsFloat) + ',' +
                       '"CantidadExpedidaBase":' + SQL_FloatToStr(Q.FieldByName('CantidadExpedidaBase').AsFloat) + ',' +
                       '"Cantidad":' + SQL_FloatToStr(fTotal) + ',' +
                       '"CantidadBase":' + SQL_FloatToStr(fTotalBase) +
                       '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ RETORNA LES PARTIDES QUE S'HAN PREPARAT D'UN ARTICLE CONCRET          │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1expedicionPartidasArticuloAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoArticulo: String;
  sFiltro: string;
  IdentificadorExp: string;
  t: TStringList;
  EjercicioPedido: Integer;
  NumeroPedido: Integer;
  SeriePedido: string;
  TratamientoPartidas: Boolean;
  fTotal: Double;
  fTotalBase: Double;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';

    Exit;
  end;

  sFiltro := '';

  CodigoArticulo := (contentfields.values['CodigoArticulo']);
  if CodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';

    Exit;
  end;

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );
  if CodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo inválido","Data":[]}';

    Exit;
  end;

  TratamientoPartidas := ARTICULO_TratamientoPartida ( Conn, CodigoEmpresa, CodigoArticulo );

  // Mirem si l'article forma part de la preparació o no
  sSQL := 'SELECT COUNT(*) ' +
          'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' AND ' +
          '  CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + '''';
  if SQL_Execute(Conn, sSQL)=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo inválido","Data":[]}';

    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT COUNT(DISTINCT Partida) ' +
          'FROM dbo.FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
          'WHERE ' +
          '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' AND ' +
          //'  PickingId = 0 AND ' +
          //'  LineaPedidoCliente = ''00000000-0000-0000-0000-000000000000'' AND ' +
          '  CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' AND ' +
          '  Partida<>'''' AND ' +
          '  Cantidad>0 AND ' +
          '  Partida IS NOT NULL';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  if not TratamientoPartidas then begin

    Result := '{"Result":"OK","Error":"","TotalRecords":0,"NumPages":0,"NumRecords":0,"Data":[]}';
    Exit;

  end;

  sSQL := 'SELECT DISTINCT ' +
          '  Partida, Cantidad, CantidadBase ' +
          'FROM dbo.FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
          'WHERE ' +
          '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' AND ' +
          '  PickingId = 0 AND ' +
          '  CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' AND ' +
          '  Partida<>'''' AND ' +
          '  Partida IS NOT NULL ' +
          'ORDER BY ' +
          '  Partida ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  sSQL := 'SELECT DISTINCT ' +
          '  Partida, ' +
          '  ( ' +
          '    SELECT ' +
          '      ISNULL(SUM(Cantidad),0) ' +
          '    FROM dbo.FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fsap1 ' +
          '    WHERE ' +
          '      fsap1.IdPreparacion = fsap.IdPreparacion AND ' +
          '    	 fsap1.CodigoArticulo = fsap.CodigoArticulo AND ' +
          '      fsap1.Partida = fsap.Partida AND ' +
          '      fsap1.LineaPedidoCliente = ''00000000-0000-0000-0000-000000000000'' ' +
          '  ) AS CantidadDisponible, ' +
          '  ( ' +
          '    SELECT ' +
          '      ISNULL(SUM(CantidadBase),0) ' +
          '    FROM dbo.FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fsap1 ' +
          '    WHERE ' +
          '      fsap1.IdPreparacion = fsap.IdPreparacion AND ' +
          '    	 fsap1.CodigoArticulo = fsap.CodigoArticulo AND ' +
          '      fsap1.Partida = fsap.Partida AND ' +
          '      fsap1.LineaPedidoCliente = ''00000000-0000-0000-0000-000000000000'' ' +
          '  ) AS CantidadDisponibleBase, ' +
          '  ( ' +
          '    SELECT ' +
          '      ISNULL(SUM(Cantidad),0) ' +
          '    FROM dbo.FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fsap2 ' +
          '    WHERE ' +
          '      fsap2.IdPreparacion = fsap.IdPreparacion AND ' +
          '    	 fsap2.CodigoArticulo = fsap.CodigoArticulo AND ' +
          '      fsap2.Partida = fsap.Partida AND ' +
          '      fsap2.LineaPedidoCliente <> ''00000000-0000-0000-0000-000000000000'' ' +
          '  ) AS CantidadExpedida, ' +
          '  ( ' +
          '    SELECT ' +
          '      ISNULL(SUM(CantidadBase),0) ' +
          '    FROM dbo.FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fsap2 ' +
          '    WHERE ' +
          '      fsap2.IdPreparacion = fsap.IdPreparacion AND ' +
          '    	 fsap2.CodigoArticulo = fsap.CodigoArticulo AND ' +
          '      fsap2.Partida = fsap.Partida AND ' +
          '      fsap2.LineaPedidoCliente <> ''00000000-0000-0000-0000-000000000000'' ' +
          '  ) AS CantidadExpedidaBase ' +
          'FROM dbo.FS_SGA_TABLE_AcumuladoPendiente ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fsap ' +
          'WHERE ' +
          '  fsap.IdPreparacion = ' + IntToStr(IdPreparacion) + ' AND ' +
          '  fsap.PickingId = 0 AND ' +
          '  fsap.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' AND ' +
          '  fsap.Partida<>'''' AND ' +
          '  fsap.Partida IS NOT NULL ' +
          'ORDER BY ' +
          '  fsap.Partida ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    fTotal     := Q.FieldByName('CantidadDisponible').AsFloat + Q.FieldByName('CantidadExpedida').AsFloat;
    fTotalBase := Q.FieldByName('CantidadDisponibleBase').AsFloat + Q.FieldByName('CantidadExpedidaBase').AsFloat;

    Result := Result + '{' +
                       '"Partida2":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
                       '"CantidadDisponible":' + Q.FieldByName('CantidadDisponible').AsString  + ',' +
                       '"CantidadDisponibleBase":' + Q.FieldByName('CantidadDisponibleBase').AsString  + ',' +
                       '"CantidadExpedida":' + Q.FieldByName('CantidadExpedida').AsString + ',' +
                       '"CantidadExpedidaBase":' + Q.FieldByName('CantidadExpedidaBase').AsString + ',' +
                       '"Cantidad":' + SQL_FloatToStr(fTotal) + ',' +
                       '"CantidadBase":' + SQL_FloatToStr(fTotalBase) + ',' +
                       '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '"' +
                       '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ EXPEDEIX TOTS ELS ARTICLES D'UNA PREPARACIÓ MONOCOMANDA               │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1expedirPedidoAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  IdPreparacion: Integer;
  CodigoUsuario: Integer;
  Q, Q2: TADOQuery;
  sCodigoArticulo, sPartida: String;
  fCantidad, fAsignar: Double;
  bErr: Boolean;
  sMsg: String;
  iEjercicio, iPickingId, iIdExpedicion: Integer;
  sLineaPedidoCliente, sUdMedida: String;
  iMax: Integer;

  contentfields: TStringList;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'], 0 );
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';

    Exit;
  end;

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Realitzar operació'}

  bErr := FALSE;
  sMsg := '';

  sSQL := 'SELECT ' +
          '  * ' +
          'FROM FS_SGA_AcumuladoPendiente WITH (NOLOCK) ' +
          'WHERE ' +
          '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' AND ' +
          '  LineaPedidoCliente=''00000000-0000-0000-0000-000000000000'' ' +
          'ORDER BY ' +
          '  CodigoArticulo';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  if not bErr then try
    Q.Open;
    iMax := Q.RecordCount;
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  while (not bErr) and (not Q.EOF) do
  begin

    sCodigoArticulo := Q.FieldByName('CodigoArticulo').AsString;
    sPartida        := Q.FieldByName('Partida').AsString;
    fCantidad       := Q.FieldByName('Cantidad').AsFloat;
    iEjercicio      := Q.FieldByName('Ejercicio').AsInteger;

    sSQL := 'SELECT ' +
            '  * ' +
            'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
            'WHERE ' +
            '  PreparacionId = ' + IntToStr(IdPreparacion) + ' AND ' +
            '  CodigoArticulo = ''' + SQL_Str(sCodigoArticulo) + ''' AND ' +
            '  UdSaldo > 0 ' +
            'ORDER BY ' +
            '  CodigoEmpresa, EjercicioPedido, SeriePedido, NumeroPedido';
    Q2 := SQL_PrepareQuery ( Conn, sSQL );

    if not bErr then try
      Q2.Open;
    except
      on E:Exception do begin
        sMsg := E.Message;
        bErr := TRUE;
      end;
    end;

    while (not bErr) and (fCantidad>0) and (not Q2.Eof) do begin

      fAsignar := Q2.FieldByName('UdSaldo').AsFloat;

      if (fAsignar > fCantidad) then begin
        fAsignar := fCantidad;
      end;

      iPickingId          := Q2.FieldByName('PickingId').AsInteger;
      sLineaPedidoCliente := Q2.FieldByName('LineasPosicion').AsString;
      sUdMedida           := AnsiUpperCase(Q2.FieldByName('UnidadMedida').AsString);
      iIdExpedicion       := Q2.FieldByName('IdentificadorExpedicion').AsInteger;

      sMsg := SGA_Reservar_stock_pedidoExpedicion(
                Conn,
                CodigoEmpresa,
                iEjercicio,
                sCodigoArticulo,
                sPartida,
                '', // CodigoTalla,
                '', // CodigoColor,
                IdPreparacion,
                iPickingId,
                sLineaPedidoCliente,
                fAsignar,
                sUdMedida,
                fAsignar,
                sUdMedida,
                iIdExpedicion,
                1,
                1,
                '',
                ''
              );

      if (sMsg <> '') then begin
        bErr := TRUE;
      end;

      fCantidad := fCantidad - fAsignar;

      if (not bErr) then try
        Q2.Next;
      except
        on E:Exception do begin
          sMsg := E.Message;
          bErr := TRUE;
        end;
      end;

    end;

    Q2.Close;
    FreeAndNil(Q2);

    if not bErr then try
      Q.Next;
    except
      on E:Exception do begin
        sMsg := E.Message;
        bErr := TRUE;
      end;
    end;

  end;

  Q.Close;
  FreeAndNil(Q);

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Error":"' + sMsg + '","Data":[]}';
  end else begin
    Result := '{"Result":"OK","Error":"","Data":[]}';
  end;

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;

  if iPickingId=0 then
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'EXPEDITE-ALL', 'Expedir toda la preparación', @LP )
  else
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'EXPEDITE-LIN', 'Expedir la línea ' + IntToStr(iPickingId) + ' de la preparación', @LP );

  {$ENDREGION}



end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ REALITZAR UN MOVIMENT DE SORTIDA D'STOCK                              │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1salidaStockAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  fStock: Double;
  YY, DD, MM, HH, NN, SS, MS: WORD;
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  CodigoArticulo: String;
  Partida: String;
  Precio: Double;
  CodigoAlmacen: String;
  AlmacenContrapartida: String;
  Comentarios: String;
  Ubicacion: String;
  OrigenMovimiento: String;
  MovOrigen: String;
  Serie: String;
  Documento: Integer;
  NumeroSerieLc: String;
  EjercicioDocumento: Integer;
  EmpresaOrigen: Integer;
  FechaCaduca: String;
  CodigoCliente: String;
  CodigoCanal: String;
  Partida2_: String;
  TipoMovimiento: Integer;
  Importe: Double;
  FactorConversion_: Double;
  Comentario: string;
  CodigoProveedor: string;
  IdProcesoIME: string;
  StatusTraspasadoIME: Integer;
  TipoImportacionIME: Integer;
  DocumentoUnico: Integer;
  FechaRegistro: TDateTime;
  MovPosicion: String;
  MovIdentificadorIME: String;
  bResult: Boolean;
  iLastID: Integer;
  Mensaje: String;
  iStatus: Integer;
  CodigoUbicacion: String;
  CodigoUsuario: Integer;
  IdDocumento: String;
  aUbicacion: TSGAUbicacion;
  Stock: Double;
  Unidades: Double;
  UnidadMedida: String;
  UnidadMedidaBase: String;
  UnidadesBase: Double;
  FactorConversion: Double;
  gaMov: TSGAMovimientoStock;
  contentfields: TStringList;
  dFechaCaduca: TDate;
  TratamientoPartidas: Boolean;
  CodigoColor: String;
  CodigoTalla: String;
  GrupoTalla: Integer;
  fStockBase: Double;
  Matricula: String;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];

  Matricula     := contentfields.values['Matricula'];
  CodigoAlmacen := contentfields.values['CodigoAlmacen'];
  if CodigoAlmacen='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    Exit;
  end;

  CodigoUbicacion := contentfields.values['CodigoUbicacion'];

  // Conversió al codi d'article real
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación no especificado","Data":[]}';
    Exit;
  end;

  if Matricula<>'' then
  begin
    if (not FS_SGA_MatriculaEnUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion, Matricula ) ) then
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El palet ya no se encuentra en esta ubicación","Data":[]}';
      Exit;
    end;
  end;

  aUbicacion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );
  if aUbicacion.CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación incorrecto","Data":[]}';
    Exit;
  end;

  CodigoArticulo := contentfields.values['CodigoArticulo'];

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );

  if CodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;

  TratamientoPartidas := ARTICULO_TratamientoPartida ( Conn, CodigoEmpresa, CodigoArticulo );

  Partida := (contentfields.values['Partida']);
  if (Partida='') and (TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de partida no especificado","Data":[]}';
    Exit;
  end;

  if (Partida<>'') and (not TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no requiere partida","Data":[]}';
    Exit;
  end;

  Unidades         := FS_StrToFloatDef ( contentfields.values['Unidades'], 0 );
  UnidadesBase     := FS_StrToFloatDef ( contentfields.values['UnidadesBase'], 0 );
  UnidadMedida     := ( AnsiUpperCase(contentfields.values['UnidadMedida']) );
  UnidadMedidaBase := ( AnsiUpperCase(contentfields.values['UnidadMedidaBase']) );
  if UnidadMedida=UnidadMedidaBase then
    FactorConversion := 1;

  FS_SGA_Check_UnidadMedidaBase ( Conn, CodigoEmpresa, CodigoArticulo, UnidadMedida, UnidadMedidaBase );

  if (UnidadMedida<>'') and (UnidadMedidaBase='') then
  begin
    UnidadMedidaBase := UnidadMedida;
    FactorConversion := 1;
  end;

  if (Unidades=0) and (UnidadesBase=0) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Las unidades no pueden ser 0","Data":[]}';
    Exit;
  end;

  CodigoColor := contentfields.values['CodigoColor_'];
  CodigoTalla := contentfields.values['CodigoTalla01_'];
  GrupoTalla  := StrToIntDef(contentfields.values['GrupoTalla_'],0);

  Stock :=
    SGA_ALMACEN_Stock (
      Conn,
      CodigoEmpresa,
      CodigoAlmacen,
      CodigoUbicacion,
      CodigoArticulo,
      Partida,
      CodigoTalla,
      CodigoColor,
      Matricula,
      UnidadMedida,
      UnidadMedidaBase,
      fStockBase,
      gbTratamientoSimplificado
    );

  if (Unidades>Stock) or (UnidadesBase>fStockBase) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No hay stock suficiente para realizar la salida","Data":[]}';
    Exit;
  end;

  DecodeDateTime ( Now(), YY, MM, DD, HH, NN, SS, MS );

  sSQL := 'SELECT ' +
          '  FechaCaduca ' +
          'FROM FS_SGA_AcumuladoStock WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
          '  AND Ejercicio = ' + IntToStr(YY) + ' ' +
          '  AND Periodo = 99 ' +
          '  AND CodigoAlmacen = ''' + SQL_Str ( CodigoAlmacen ) + ''' ' +
          '  AND CodigoUbicacion = ''' + SQL_Str ( CodigoUbicacion ) + ''' ' +
          '  AND CodigoArticulo = ''' + SQL_Str ( CodigoArticulo ) + ''' ' +
          '  AND Partida = ''' + SQL_Str ( Partida ) + ''' ' +
          '  AND CodigoTalla01_ = ''' + SQL_Str ( CodigoTalla ) + ''' ' +
          '  AND CodigoColor_ = ''' + SQL_Str ( CodigoColor ) + ''' ' +
          '  AND Matricula = ''' + SQL_Str(Matricula) + ''' ' +
          '  AND UnidadMedida = ''' + SQL_Str ( UnidadMedida ) + ''' ' +
          '  AND UnidadMedidaBase = ''' + SQL_Str ( UnidadMedidaBase ) + '''';
  try
    dFechaCaduca := SQL_Execute ( Conn, sSQL );
    FechaCaduca := FormatDateTime('dd/mm/yyyy', dFechaCaduca );
  except
    on E:Exception do
    begin
      dFechaCaduca := 0;
      FechaCaduca  := '';
      gaLogFile.Write_DBException(E,sSQL,'Error al recuperar la fecha de caducidad del artículo', CONST_LOGID_BBDD );
    end;
  end;

  YY                   := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );
  Serie                := contentfields.values['Serie'];
  Documento            := StrToIntDef ( contentfields.values['Documento'], 0 );
  AlmacenContrapartida := contentfields.values['AlmacenContrapartida'];
  Partida              := contentfields.values['Partida'];
  Partida2_            := contentfields.values['Partida2_'];
  TipoMovimiento       := StrToIntDef ( contentfields.values['TipoMovimiento'], 2 );
  Precio               := FS_StrToFloatDef ( contentfields.values['Precio'], 0 );
  Importe              := Unidades * Precio;
  FactorConversion_    := FactorConversion; // FS_StrToFloatDef ( contentfields.values['FactorConversion_'], 1.0 );
  Comentario           := contentfields.values['Comentario'];
  CodigoCanal          := contentfields.values['CodigoCanal'];
  CodigoCliente        := contentfields.values['CodigoCliente'];
  CodigoProveedor      := contentfields.values['CodigoProveedor'];
  //FechaCaduca          := contentfields.values['FechaCaduca'];
  Ubicacion            := contentfields.values['Ubicacion'];
  OrigenMovimiento     := contentfields.values['OrigenMovimiento'];
  EjercicioDocumento   := StrToIntDef ( contentfields.values['EjercicioDocumento'], 0 );
  NumeroSerieLc        := contentfields.values['NumeroSerieLc'];
  StatusTraspasadoIME  := 0;
  TipoImportacionIME   := 2;
  DocumentoUnico       := StrToIntDef ( contentfields.values['DocumentoUnico'], 0 );
  FechaRegistro        := Now();
  IdDocumento          := contentfields.values['IdDocumento'];

  if Comentario='' then
  begin
    Comentario := 'Salida manual PDA';
  end;

  try
    MovPosicion        := SQL_Execute ( Conn,'select NEWID()');
    MovPosicion        := StringReplace ( MovPosicion, '{', '', [] );
    MovPosicion        := StringReplace ( MovPosicion, '}', '', [] );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '","Data":[]}';
      Exit;
    end;
  end;

  try
    MovIdentificadorIME := SQL_Execute ( Conn,'select NEWID()');
    MovIdentificadorIME := StringReplace ( MovIdentificadorIME, '{', '', [] );
    MovIdentificadorIME := StringReplace ( MovIdentificadorIME, '}', '', [] );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '","Data":[]}';

      Exit;
    end;
  end;

  try
    IdProcesoIME := SQL_Execute ( Conn,'select NEWID()');
    IdProcesoIME := StringReplace ( IdProcesoIME, '{', '', [] );
    IdProcesoIME := StringReplace ( IdProcesoIME, '}', '', [] );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '","Data":[]}';
      Exit;
    end;
  end;

  if (IdDocumento='') or (IdDocumento='0') then begin
    IdDocumento := '00000000-0000-0000-0000-000000000000';
  end;

  if OrigenMovimiento='' then begin
    OrigenMovimiento := 'S';
  end;

  if (FechaCaduca='') or (FechaCaduca='0') then begin
    dFechaCaduca := 0;
    FechaCaduca := 'NULL';
  end else begin
    dFechaCaduca := StrToDate(FechaCaduca);
    FechaCaduca  := SQL_DateToStr(dFechaCaduca);
  end;

  MovOrigen := SQL_Execute ( Conn, 'SELECT NEWID()' );

  {$ENDREGION}

  {$REGION 'Realitzar operació'}

  iLastID := 0;
  iStatus := 1;

  sSQL := 'SELECT ' +
          '  sysContenidoIni ' +
          'FROM lsysIni WITH (NOLOCK) ' +
          'WHERE ' +
          '  sysGrupo = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' AND ' +
          '  sysFicheroIni = ''CUESTIONARIO'' AND ' +
          '  sysSeccion = ''GES'' AND ' +
          '  sysItem = ''StockNegativo'' ';
  giPermiteStockNegativo := SQL_Execute ( Conn, sSQL );

  if giPermiteStockNegativo=0 then begin

    fStock :=
      SGA_ALMACEN_Stock (
        Conn,
        CodigoEmpresa,
        CodigoAlmacen,
        CodigoUbicacion,
        CodigoArticulo,
        Partida,
        CodigoTalla,
        CodigoColor,
        Matricula,
        UnidadMedida,
        UnidadMedidaBase,
        fStockBase,
        gbTratamientoSimplificado
      );

    if (fStock-Unidades<0) or (fStockBase-UnidadesBase<0) then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se permite stock negativo en SAGE","Data":[]}';
      Exit;
    end;

  end;

  SGA_FS_ALMACEN_PrepareMov ( gaMov );
  gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
  gaMov.EmpresaOrigen          := CodigoEmpresa.EmpresaOrigen;
  gaMov.CodigoUsuario          := CodigoUsuario;
  gaMov.Ejercicio              := YY;
  gaMov.Periodo                := MM;
  gaMov.Fecha                  := Date();
  gaMov.FechaHora              := Now();
  gaMov.CodigoAlmacen          := CodigoAlmacen;
  gaMov.CodigoUbicacion        := CodigoUbicacion;
  gaMov.CodigoArticulo         := CodigoArticulo;
  gaMov.Partida                := Partida;
  gaMov.TipoMovimiento         := TipoMovimiento;
  gaMov.OrigenMovimiento       := OrigenMovimiento;
  gaMov.Unidades               := Unidades;
  gaMov.UnidadMedida           := AnsiUpperCase(UnidadMedida);
  gaMov.UnidadesBase           := UnidadesBase;
  gaMov.UnidadMedidaBase       := AnsiUpperCase(UnidadMedidaBase);
  gaMov.FactorConversion       := FactorConversion;
  gaMov.Comentario             := Comentario;
  gaMov.IdProcesoIME           := IdProcesoIME;
  gaMov.IdDocumento            := IdDocumento;
  gaMov.Serie                  := Serie;
  gaMov.FechaCaduca            := dFechaCaduca;
  gaMov.Precio                 := Precio;
  gaMov.MovOrigen              := MovOrigen;
  gaMov.CodigoProveedor        := CodigoProveedor;
  gaMov.CodigoColor            := CodigoColor;
  gaMov.CodigoTalla            := CodigoTalla;
  gaMov.GrupoTalla             := GrupoTalla;
  gaMov.Matricula	             := Matricula;
  gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );

  if Precio=0 then
  begin
    gaMov.Precio :=
      ARTICULO_ConsultarPrecioStock (
        Conn,
        CodigoEmpresa,
        gaMov.CodigoArticulo,
        gaMov.Partida,
        gaMov.CodigoColor,
        gaMov.CodigoTalla,
        gaMov.CodigoAlmacen,
        gaMov.GrupoTalla
      );
  end;

  // Fem els moviments a les taules del SGA
  if not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, Mensaje ) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' +  Mensaje + '","Data":[]}';
    Exit;
  end;

  sSQL := 'INSERT INTO TmpIME_MovimientoStock ( ' +
          '    CodigoEmpresa, Ejercicio, Periodo, Fecha, Serie, Documento, ' +
          '    CodigoArticulo, CodigoAlmacen, AlmacenContrapartida, Partida, ' +
          '    Partida2_, CodigoColor_, GrupoTalla_, CodigoTalla01_, TipoMovimiento, ' +
          '    Unidades, UnidadMedida1_, Precio, Importe, Unidades2_, UnidadMedida2_, ' +
          '    FactorConversion_, Comentario, CodigoCanal, CodigoCliente, CodigoProveedor, ' +
          '    FechaCaduca, Ubicacion, OrigenMovimiento, EmpresaOrigen, MovOrigen, ' +
          '    EjercicioDocumento, NumeroSerieLc, IdProcesoIME, MovIdentificadorIME, ' +
          '    StatusTraspasadoIME, TipoImportacionIME, DocumentoUnico, FechaRegistro, ' +
          '    MovPosicion ' +
          '  ) ' +
          'VALUES ( ' +
          IntToStr(CodigoEmpresa.Stocks) + ', ' +
          IntToStr(YY) + ', ' +
          IntToStr(MM) + ', ' +
          SQL_DateToStr ( Now() ) + ', ' +
          '''' + SQL_Str(Serie) + ''', ' +
          IntToStr(Documento) + ', ' +
          '''' + SQL_Str(CodigoArticulo) + ''', ' +
          '''' + SQL_Str(CodigoAlmacen) + ''', ' +
          '''' + SQL_Str(AlmacenContrapartida) + ''', ' +
          '''' + SQL_Str(Partida) + ''', ' +
          '''' + SQL_Str(Partida2_) + ''', ' +
          '''' + SQL_Str(CodigoColor) + ''', ' +
          '''' + IntToStr(GrupoTalla) + ''', ' +
          '''' + SQL_Str(CodigoTalla) + ''', ' +
          IntToStr(TipoMovimiento) + ', ' +
          SQL_FloatToStr ( Unidades ) + ', '+
          '''' + SQL_Str( UnidadMedida ) + ''', ' +
          SQL_FloatToStr ( gaMov.Precio ) + ', ' +
          SQL_FloatToStr ( gaMov.Precio * gaMov.Unidades ) + ', ' +
          SQL_FloatToStr ( UnidadesBase ) + ', '+
          '''' + SQL_Str( UnidadMedidaBase ) + ''', ' +
          SQL_FloatToStr ( FactorConversion_ ) + ', '+
          '''' + SQL_Str( Comentario ) + ''', ' +
          '''' + SQL_Str( CodigoCanal ) + ''', ' +
          '''' + SQL_Str( CodigoCliente ) + ''', ' +
          '''' + SQL_Str( CodigoProveedor ) + ''', ' +
          FechaCaduca + ', ' +
          '''' + SQL_Str( Ubicacion ) + ''', ' +
          '''' + SQL_Str( OrigenMovimiento ) + ''', ' +
          IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
          '''' + SQL_GUID_ToStr( MovOrigen ) + ''', ' +
          IntToStr(EjercicioDocumento) + ', ' +
          '''' + SQL_Str( NumeroSerieLc ) + ''', ' +
          '''' + SQL_GUID_ToStr( IdProcesoIME ) + ''', ' +
          '''' + SQL_GUID_ToStr( MovIdentificadorIME ) + ''', ' +
          IntToStr(StatusTraspasadoIME) + ', ' +
          IntToStr(TipoImportacionIME) + ', ' +
          IntToStr(DocumentoUnico) + ', ' +
          SQL_DateTimeToStr ( FechaRegistro ) + ', ' +
          '''' + SQL_GUID_ToStr(gaMov.MovPosicion) + ''' )';

  try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '","Data":[]}';
      Exit;
    end;
  end;

  sSQL := 'INSERT INTO ' +
          '  FS_Operations ( oper_product_code, oper_name, oper_datetime, oper_status, oper_params, oper_CodigoEmpresa ) ' +
          'VALUES ( ' +
          '''E4E8'', ' +
          '''MOVIMIENTOSTOCK'', ' +
          SQL_DateTimeToStr(Now()) + ', ' +
          '0, ' +
          '''{"IdProcesoIME":"' + SQL_GUID_ToStr(IdProcesoIME) + '","MantenerDatos":"1","MantenerErrores":"1","Módulos":"4","CodigoEmpresa":' + IntToStr(CodigoEmpresa.Stocks) + '}'', ' +
          IntToStr(CodigoEmpresa.Stocks) +
          ')';
  //gaLogFile.Write(sSQL, CONST_LOGID_BBDD, LOG_LEVEL_INFO );

  try
    SQL_Execute_NoRes ( Conn, sSQL );
    sSQL := 'SELECT IDENT_CURRENT(''FS_Operations'')';
    iLastID := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '","Data":[]}';

      Exit;
    end;
  end;

  LP := LOG_Clear();
  LP.MovOrigen := gaMov.MovOrigen;
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'STOCK-OUT', 'Salida del artículo ' + gaMov.CodigoArticulo, @LP );

  Result := '{"Result":"OK","Error":"","Data":[]}';

  (*
  if (iLastID<>0) and (not WaitOperationDone ( Conn, iLastID, Status, Mensaje )) then begin

    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + Mensaje + '","Data":[]}';

    Exit;

  end;

  if Status<>1 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Error":"' + Mensaje + '","Data":[]}';
  end else begin
    Result := '{"Result":"OK","Error":"","Data":[]}';
  end;
  *)

  {$ENDREGION}

end;


procedure WebModule1servirDevolucionOldAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  DevolucionId: Integer;
  sSQL: String;
  Q, Q2: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoArticulo: string;
  CodigoUbicacion: string;
  sDesglose: string;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoUsuario: Integer;
  CodigoUbicacionRecepcion: String;
  CodigoUbicacionRechazos: String;
  UnidadesPedidas: Double;
  UnidadesRecibidas: Double;
  UnidadesPendientes: Double;
  bIgnorarPendientes: Boolean;
  sMsg: String;
  bErr: Boolean;
  iNum: Integer;
  sNewGuid: String;
  sNewMovOrigen: String;
  sOrigenMovimiento: String;
  Albaran: String;
  FechaAlbaran: TDate;
  CodigoProveedor: String;
  TratamientoPartidas: Boolean;
  CantidadEntrada: Double;
  CantidadRechazos: Double;
  UnidadMedidaEntrada: String;
  FechaCaduca: TDate;
  Precio: Double;
  UnidadMedida: String;
  Cantidad: Double;
  Rechazos: Double;
  FactorConversion: Double;
  aUbicacion: TSGAUbicacion;
  aUbicacionRechazos: TSGAUbicacion;
  Partida: String;
  sOperparams: String;
  OperId: Integer;
  MascaraAlbaran: String;
  MascaraFactura: String;
  CopiasAlbaran: Integer;
  CopiasFactura: Integer;
  ImprimirAlbaran: Boolean;
  ImprimirFactura: Boolean;
  AlbaranValorado: Boolean;

  gaMov: TSGAMovimientoStock;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

 DevolucionId := StrToIntDef(contentfields.values['DevolucionId'],0);
  if DevolucionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no especificado","Data":[]}';
    Exit;
  end;

  bIgnorarPendientes := StrToBoolDef(contentfields.values['IgnorarPendientes'], false);

  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_MascaraAlbaran,  MascaraAlbaran, '', CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_MascaraFactura,  MascaraFactura, '', CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CopiasAlbaran,   CopiasAlbaran, 1, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CopiasFactura,   CopiasFactura, 1, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_ImprimirAlbaran, ImprimirAlbaran, False, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_ImprimirFactura, ImprimirFactura, False, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_AlbaranValorado, AlbaranValorado, True, CodigoEmpresa.EmpresaOrigen );

  {$ENDREGION}

  {$REGION 'Generar albarà de devolució'}

  sSQL := 'SELECT ' +
          '  Albaran, Fecha, CodigoCliente ' +
          'FROM FS_SGA_Devoluciones WITH (NOLOCK) ' +
          'WHERE ' +
          '  DevolucionId = ' + IntToStr(DevolucionId);

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  if Q.EOF then begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no válido","Data":[]}';
    Exit;
  end;

  Albaran         := Q.FieldByName('Albaran').AsString;
  FechaAlbaran    := Trunc(Q.FieldByName('Fecha').AsDateTime);
  CodigoProveedor := Q.FieldByName('CodigoCliente').AsString;

  Q.Close;
  FreeAndNil(Q);

  sSQL := 'SELECT ' +
          '  SUM(UdPedidas) AS UnidadesPedidas, SUM(UdRecibidas) AS UnidadesRecibidas ' +
          'FROM FS_SGA_Devoluciones_Lineas WITH (NOLOCK) ' +
          'WHERE ' +
          '  DevolucionId = ' + IntToStr(DevolucionId);
  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  if Q.EOF then begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de recepción no válido","Data":[]}';
    Exit;
  end;

  UnidadesPedidas    := Q.FieldByName('UnidadesPedidas').AsFloat;
  UnidadesRecibidas  := Q.FieldByName('UnidadesRecibidas').AsFloat;
  UnidadesPendientes := UnidadesPedidas - UnidadesRecibidas;

  Q.Close;
  FreeAndNil(Q);

  if (UnidadesPedidas=0) or (UnidadesRecibidas=0) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No hay unidades para devolver","Data":[]}';
    Exit;
  end;

  if (UnidadesPendientes>0) and (not bIgnorarPendientes) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Existen unidades pendientes de registrar.","Data":["Confirmar":1]}';
    Exit;
  end;

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  try
    // // Conn.BeginTrans;
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(E.Message) + '" ,"Data":[]}';
      Exit;
    end;
  end;

  sMsg := '';
  bErr := FALSE;

  //...primer borrem totes aquelles linies de la recepción on no s'hagi recepcionat cap Unitat
  sSQL := 'DELETE FROM FS_SGA_Devoluciones_Lineas ' +
          'WHERE ' +
          '  DevolucionId = ' + IntToStr(DevolucionId) + ' AND ' +
          '  UdRecibidas = 0';
  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on e: exception do begin
      bErr := true;
      sMsg := e.Message;
    end;
  end;

  sSQL := 'SELECT ' +
          '  art.TratamientoPartidas, srl.UnidadMedida1_ as UnidadMedidaPedido, srl.CodigoArticulo, srld.* ' +
          'FROM FS_SGA_Devoluciones_Lineas srl WITH (NOLOCK) ' +
          'INNER JOIN FS_COMMON_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
          'ON ' +
          '  srl.CodigoArticulo = art.CodigoArticulo ' +
          'INNER JOIN FS_SGA_Devoluciones_Lineas_Detalle srld WITH (NOLOCK) ' +
          'ON ' +
          '  srl.DevolucionId = srld.DevolucionId AND ' +
          '  srl.DevolucionIdLinea = srld.DevolucionIdLinea ' +
          'WHERE ' +
          '  srl.DevolucionId = ' + IntToStr(DevolucionId) + ' ' +
          'ORDER BY ' +
          '  srld.DevolucionIdLineaDetalle';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  if not bErr then try
    Q.Open;
    iNum := Q.RecordCount;
    if iNum=0 then begin
      sMsg := 'No se ha introducido ninguna cantidad en el detalle.';
      bErr := TRUE;
    end;
  except
    on e: exception do begin
      bErr := true;
      sMsg := e.Message;
    end;
  end;

  if not bErr then try
    sNewGuid           := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sNewMovOrigen      := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sOrigenMovimiento  := 'E';
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  while (not bErr) and (not Q.Eof) do begin

    CodigoArticulo          := Q.FieldByName('CodigoArticulo').AsString;
    TratamientoPartidas     := (Q.FieldByName('TratamientoPartidas').AsInteger<>0);
    CodigoUbicacion         := Q.FieldByName('CodigoUbicacion').AsString;
    CodigoUbicacionRechazos := Q.FieldByName('CodigoUbicacionRechazos').AsString;
    CantidadEntrada         := Q.FieldByName('UnidadesEntrada').AsFloat;
    CantidadRechazos        := Q.FieldByName('CantidadErrorEntrada').AsFloat;
    UnidadMedidaEntrada     := AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString);
    FechaCaduca             := Q.FieldByName('FechaCaducidad').AsDateTime;
    Precio                  := Q.FieldByName('Precio').AsCurrency;
    UnidadMedida            := FS_SGA_ARTICULO_UnidadBase ( Conn, CodigoEmpresa, CodigoArticulo );
    Cantidad                := SGA_FS_ARTICULO_ConversionUnidades ( Conn, CodigoEmpresa, CodigoArticulo,
                                 CantidadEntrada, UnidadMedida, UnidadMedidaEntrada, FactorConversion );
    Rechazos                := SGA_FS_ARTICULO_ConversionUnidades ( Conn, CodigoEmpresa, CodigoArticulo,
                                 CantidadRechazos, UnidadMedida, UnidadMedidaEntrada, FactorConversion );

    aUbicacion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );
    if aUbicacion.CodigoUbicacion='' then begin
      bErr := TRUE;
      sMsg := 'Algún código de ubicación no es correcto. Revise los datos introducidos.';
    end;

    aUbicacionRechazos := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacionRechazos );
    if (CantidadRechazos<>0) and (aUbicacionRechazos.CodigoUbicacion='') then begin
      bErr := TRUE;
      sMsg := 'Algún código de ubicación de rechazos no es correcto. Revise los datos introducidos.';
    end;

    if (TratamientoPartidas) then begin
      Partida := (Q.FieldByName('Partida').AsString);
      if Partida='' then begin
        bErr := TRUE;
        sMsg := 'Alguno de los artículos no tienen especificada la partida';
      end;
    end else begin
      Partida := '';
    end;

    // Fem els moviments d'entrada a les ubicacions del magatzem del SGA
    SGA_FS_ALMACEN_PrepareMov ( gaMov );
    gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
    gaMov.EmpresaOrigen          := CodigoEmpresa.EmpresaOrigen;
    gaMov.CodigoUsuario          := CodigoUsuario;
    gaMov.Ejercicio              := YY;
    gaMov.Periodo                := MonthOf(Date());
    gaMov.Fecha                  := Date();
    gaMov.FechaHora              := Now();
    gaMov.CodigoAlmacen          := aUbicacion.CodigoAlmacen;
    gaMov.CodigoUbicacion        := aUbicacion.CodigoUbicacion;
    gaMov.CodigoArticulo         := CodigoArticulo;
    gaMov.Partida                := Partida;
    gaMov.Unidades               := CantidadEntrada;
    gaMov.UnidadMedida           := AnsiUpperCase(UnidadMedidaEntrada);
    gaMov.UnidadesBase           := Cantidad;
    gaMov.UnidadMedidaBase       := AnsiUpperCase(UnidadMedida);
    gaMov.FactorConversion       := FactorConversion;
    gaMov.TipoMovimiento         := 1;
    gaMov.OrigenMovimiento       := 'E';
    gaMov.Comentario             := 'Entrada de devolución';
    gaMov.IdProcesoIME           := sNewGuid;
    gaMov.FechaCaduca            := FechaCaduca;
    gaMov.Precio                 := Precio;
    gaMov.Albaran                := Albaran;
    gaMov.FechaAlbaran           := FechaAlbaran;
    gaMov.CodigoProveedor        := CodigoProveedor;
    gaMov.DevolucionId           := DevolucionId;

    //...afegim a SGA_Movimiento_Almacen
    if not bErr then try
      bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
    except
      on e: exception do begin
        bErr := true;
        sMsg := e.Message;
      end;
    end;

    // Afegim rebutjos
    if (CantidadRechazos<>0) then begin

      gaMov.CodigoAlmacen          := aUbicacionRechazos.CodigoAlmacen;
      gaMov.CodigoUbicacion        := aUbicacionRechazos.CodigoUbicacion;
      gaMov.Unidades               := CantidadRechazos;
      gaMov.UnidadesBase           := Rechazos;
      gaMov.Comentario             := 'Entrada de rechazo de cliente';

      if not bErr then try
        bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
      except
        on e: exception do begin
          bErr := true;
          sMsg := e.Message;
        end;
      end;

    end;

    if not bErr then begin
      Q.Next;
    end;

  end;

  Q.Close;
  Q.Free;

  // Enviem la instrucció al servei per generar l'albarà
  sOperparams := '{' +
                 '"DevolucionId":' + IntToStr(DevolucionId) + ',' +
                 '"EjercicioDocumento":' + IntToStr(YY)+',' +
                 '"CodigoEmpresa":' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ',' +
                 '"MascaraAlbaran":"' + SQL_Str(MascaraAlbaran) + '",' +
                 '"MascaraFactura":"' + SQL_Str(MascaraFactura) + '",' +
                 '"CopiasAlbaran":' + IntToStr(CopiasAlbaran) + ',' +
                 '"CopiasFactura":' + IntToStr(CopiasFactura) + ',' +
                 '"ImprimirAlbaran":"' + SQL_BooleanToStr(ImprimirAlbaran) + '",' +
                 '"ImprimirFactura":"' + SQL_BooleanToStr(ImprimirFactura) + '",' +
                 '"AlbaranValorado":"' + SQL_BooleanToStr(AlbaranValorado) + '"' +
                 '}';

  sSQL := 'INSERT INTO FS_Operations ( ' +
          '  oper_CodigoEmpresa, oper_name, oper_product_code, oper_mac_address, ' +
          '  oper_ip_address, oper_datetime, oper_status, oper_params ) ' +
          'OUTPUT ' +
          '  inserted.oper_id ' +
          'VALUES ( ' +
          IntToStr(CodigoEmpresa.EmpresaOrigen) + ',' +
          '''CREARDEVOLUCIONCLIENTE'',' +
          '''E4E8'',' +
          '''' + SQL_Str(NETWORK_LocalMAC()) + ''',' +
          '''' + SQL_Str(GetLocalIp) + ''',' +
          SQL_DatetimeToStr(Now()) + ', ' +
          '0,' +
          '''' + SQL_Str(sOperparams) + ''')';
  //gaLogFile.Write(sSQL, CONST_LOGID_BBDD, LOG_LEVEL_INFO );

  if not bErr then try
    OperId := SQL_Insert_Identity ( Conn, sSQL, 'oper_id' );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if OperId=-1 then begin
    bErr := TRUE;
    sMsg := 'Error al enviar la operación a SAGE';
  end;

  sSQL := 'UPDATE ' +
          '  FS_SGA_Devoluciones ' +
          'SET ' +
          '  Estado = 3, ' +
          '  Oper_Id = ' + IntToStr(OperId) + ' ' +
          'WHERE ' +
          '  DevolucionId = ' + IntToStr(DevolucionId);
  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on e: exception do begin
      bErr := true;
      sMsg := e.Message;
    end;
  end;

  if not bErr then try
    // Conn.CommitTrans;
  except
    on E:Exception do begin
      // Conn.RollbackTrans;
      sMsg := 'Se ha producido un error:' + #13 + #10 + E.Message;
      bErr := TRUE;
    end;
  end else begin
    // Conn.RollbackTrans;
  end;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(sMsg) + '","Data":[]}';

    Exit;
  end;

  Result := '{"Result":"OK","Error":"","Data":[]}';

  {$ENDREGION}




end;

procedure WebModule1servirPreparacionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  PreparacionId: Integer;
  sSQL: String;
  Q, Q2: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoArticulo: string;
  CodigoUbicacion: string;
  sDesglose: string;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoUsuario: Integer;
  CodigoUbicacionRecepcion: String;
  CodigoUbicacionRechazos: String;
  UnidadesPedidas: Double;
  UnidadesRecibidas: Double;
  UnidadesPendientes: Double;
  bIgnorarPendientes: Boolean;
  sMsg: String;
  bErr: Boolean;
  iNum: Integer;
  sNewGuid: String;
  sNewMovOrigen: String;
  sOrigenMovimiento: String;
  Albaran: String;
  CodigoProveedor: String;
  TratamientoPartidas: Boolean;
  CantidadEntrada: Double;
  CantidadRechazos: Double;
  UnidadMedidaEntrada: String;
  FechaCaduca: TDate;
  Precio: Double;
  UnidadMedida: String;
  Cantidad: Double;
  Rechazos: Double;
  FactorConversion: Double;
  aUbicacion: TSGAUbicacion;
  aUbicacionRechazos: TSGAUbicacion;
  Partida: String;
  sOperparams: String;
  OperId: Integer;
  MascaraAlbaran: String;
  MascaraFactura: String;
  CopiasAlbaran: Integer;
  CopiasFactura: Integer;
  ImprimirAlbaran: Boolean;
  ImprimirFactura: Boolean;
  AlbaranValorado: Boolean;
  iUltimoPedido: Integer;
  UbicacionExpediciones: String;
  Unidades: Double;
  UnidadMedidaBase: string;
  UnidadesBase: Double;
  gaMov: TSGAMovimientoStock;
  iEjercicio: Integer;
  bMantenerRestos: Boolean;
  contentfields: TStringList;
  CodigoCliente, CodigoClienteOld: String;
  bAgruparAlbaranes: Boolean;
  lstSQL: TStringList;
  iSQLidx: Integer;
  bClientDiferent: Boolean;
  bPedidoServido: Boolean;
  informeAuto: Integer;
  bIsCustomReport: Boolean;
  iStatus: Integer;
  paramFechaAlbaran: String;
  TipoFechaAlbaran: String;
  FechaAlbaran: string;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  sMsg := '';
  bErr := false;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  PreparacionId := StrToIntDef(contentfields.values['PreparacionId'],0);
  if PreparacionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  if FS_SGA_PreparacionServida ( Conn, PreparacionId ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(PreparacionId) + ' ya está servida","Data":[]}';
    Exit;
  end;

  CodigoUsuario      := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID               := contentfields.values['UUID'];
  bIgnorarPendientes := StrToBoolDef(contentfields.values['IgnorarPendientes'], false);
  ImprimirAlbaran    := StrToBoolDef(contentfields.Values['ImprimirAlbaran'], false );
  ImprimirFactura    := StrToBoolDef(contentfields.Values['ImprimirFactura'], false );
  informeAuto        := StrToIntDef(contentfields.Values['InformeAuto'], 0);

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_FechaAlbaran, paramFechaAlbaran, CodigoEmpresa.EmpresaOrigen );
  if paramFechaAlbaran='FECHA DE PROCESO' then
  begin
    TipoFechaAlbaran := '0';
    FechaAlbaran     := '';
  end else if paramFechaAlbaran='FECHA DEL PEDIDO' then
  begin
    TipoFechaAlbaran := '1';
    FechaAlbaran     := '';
  end else if paramFechaAlbaran='FECHA DE ENTREGA' then
  begin
    TipoFechaAlbaran := '2';
    FechaAlbaran     := '';
  end else
  begin
    TipoFechaAlbaran := '99';
    FechaAlbaran     := contentfields.values['FechaAlbaran'];
    if FechaAlbaran='' then
    begin
      TipoFechaAlbaran := '0';
      FechaAlbaran     := '';
    end;
  end;

  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_MascaraAlbaran,  MascaraAlbaran, '', CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_MascaraFactura,  MascaraFactura, '', CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CopiasAlbaran,   CopiasAlbaran, 1, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CopiasFactura,   CopiasFactura, 1, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_AlbaranValorado, AlbaranValorado, True, CodigoEmpresa.EmpresaOrigen );

  iEjercicio := SGA_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now );
                             
  {$ENDREGION}

  {$REGION 'Generar albarans de la preparació'}

  bErr := FALSE;
  sMsg := '';

  // Busquem les diferentes comandes que composen la expedició
  sSQL := 'SELECT DISTINCT ' +
          '  fsppl.CodigoEmpresa, fsppl.EjercicioPedido, fsppl.NumeroPedido, ' +
          '  fsppl.SeriePedido, fsppl.CodigoCliente, c.AgruparAlbaranes, c.BloqueoAlbaran ' +
          'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
          'INNER JOIN Clientes c WITH (NOLOCK) ' +
          'ON ' +
          '  c.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Clientes) + ' ' +
          '  AND c.CodigoCliente = fsppl.CodigoCliente ' +
          'WHERE ' +
          '  fsppl.PreparacionId = ' + IntToStr(PreparacionId) +
          '  AND (fsppl.UdRetiradas>0 OR fsppl.UdRetiradasBase>0)' +
          '  AND (fsppl.UdExpedidas>0 OR fsppl.UdExpedidasBase>0) ' +
          'ORDER BY ' +
          '  fsppl.CodigoCliente';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' +
        '"No se han podido generar los albaranes de la preparación ' + IntToStr(PreparacionId) + '","Data":[]}';
      gaLogFile.Write_DBException(E,sSQL,'ERROR: No se han podido generar los albaranes de la preparación ' +
        IntToStr(PreparacionId), LOG_LEVEL_ERROR );
      Exit;
    end;
  end;

  iNum := 0;
  lstSQL := TStringList.Create;

  CodigoClienteOld := '';
  bPedidoServido := FALSE;

  while not Q.EOF do
  begin

    CodigoCliente     := Q.FieldByName('CodigoCliente').AsString;
    bAgruparAlbaranes := SAGE_AgruparPedidos ( Conn, CodigoEmpresa, CodigoCliente );

    Inc(iNum);

    if (iNum = Q.RecordCount) then
      iUltimoPedido := 1
    else
      iUltimoPedido := 0;

    // Mirem si el client té albarans agrupats
    if (iUltimoPedido=1) or (not bAgruparAlbaranes) or (CodigoCliente<>CodigoClienteOld) then
    begin

      bClientDiferent := (CodigoClienteOld<>CodigoCliente);
      CodigoClienteOld := CodigoCliente;

      // Enviem la instrucció al servei per generar l'albarà
      if bAgruparAlbaranes then
      begin

        sOperParams := '{' +
          '"PreparacionId":' + IntToStr(PreparacionId) + ',' +
          '"CodigoUsuario":' + IntToStr(CodigoUsuario) + ',' +
          '"EjercicioDocumento":' + IntToStr(iEjercicio) + ',' +
          '"CodigoCliente":"' + JSON_Str(CodigoCliente) + '",' +
          '"UltimoPedido":' + intToStr(iUltimoPedido) + ',' +
          '"CodigoEmpresa":' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ',' +
          '"MascaraAlbaran":"' + JSON_Str(MascaraAlbaran) + '",' +
          '"MascaraFactura":"' + JSON_Str(MascaraFactura) + '",' +
          '"CopiasAlbaran":"' + intToStr(CopiasAlbaran) + '",' +
          '"CopiasFactura":"' + intToStr(CopiasFactura) + '",' +
          '"ImprimirAlbaran":"' + SQL_BooleanToStr(ImprimirAlbaran) + '",' +
          '"ImprimirFactura":"' + SQL_BooleanToStr(ImprimirFactura) + '",' +
          '"TipoFechaAlbaran":"' + TipoFechaAlbaran + '",' +
          '"FechaAlbaran":"' + FechaAlbaran + '",' +
          '"AlbaranValorado":"' + SQL_BooleanToStr(AlbaranValorado) + '"' + '}';

      end else begin

        sOperParams := '{' +
          '"PreparacionId":' + IntToStr(PreparacionId) + ',' +
          '"CodigoUsuario":' + IntToStr(CodigoUsuario) + ',' +
          '"EjercicioDocumento":' + IntToStr(iEjercicio) + ',' +
          '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
          '"SeriePedido":"' + JSON_Str(Q.FieldbyName('SeriePedido').asString) + '",' +
          '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
          '"UltimoPedido":' + intToStr(iUltimoPedido) + ',' +
          '"CodigoEmpresa":' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ',' +
          '"MascaraAlbaran":"' + JSON_Str(MascaraAlbaran) + '",' +
          '"MascaraFactura":"' + JSON_Str(MascaraFactura) + '",' +
          '"CopiasAlbaran":' + intToStr(CopiasAlbaran) + ',' +
          '"CopiasFactura":' + intToStr(CopiasFactura) + ',' +
          '"ImprimirAlbaran":"' + SQL_BooleanToStr(ImprimirAlbaran) + '",' +
          '"ImprimirFactura":"' + SQL_BooleanToStr(ImprimirFactura) + '",' +
          '"TipoFechaAlbaran":"' + TipoFechaAlbaran + '",' +
          '"FechaAlbaran":"' + FechaAlbaran + '",' +
          '"AlbaranValorado":"' + SQL_BooleanToStr(AlbaranValorado) + '"' + '}';

      end;

      sSQL := 'INSERT INTO FS_Operations ( ' +
              '  oper_CodigoEmpresa, oper_name, oper_product_code, oper_mac_address, ' +
              '  oper_ip_address, oper_datetime, oper_status, oper_params ) ' +
              'OUTPUT ' +
              '  inserted.oper_id ' +
              'VALUES ( ' +
              IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
              '''CREARALBARANCLIENTE'', ' +
              '''' + CONST_SGA + ''', ' +
              '''' + SQL_Str(NETWORK_LocalMAC()) + ''', ' +
              '''' + SQL_Str(GetLocalIp) + ''', ' +
              SQL_DateTimeToStr(Now) + ', ' +
              '0, ' +
              '''' + SQL_Str(sOperParams) + ''');';
      //gaLogFile.Write(sSQL, CONST_LOGID_BBDD, LOG_LEVEL_INFO );

      if (iSQLidx>0) and (bAgruparAlbaranes) and (not bClientDiferent) then
      begin
        lstSQL[iSQLidx-1] := sSQL;
      end else begin
        lstSQL.Add(sSQL);
        Inc(iSQLidx);
      end;

      bPedidoServido := TRUE;

      {
      try
        OperId := SQL_Insert_Identity ( Conn, sSQL, 'oper_id' );
      except
        on E: Exception do
        begin
          bErr := TRUE;
          sMsg := E.Message;
          gaLogFile.Write_DBException(E,sSQL,'ERROR: No se ha podido enviar la operación de crear albarán', LOG_LEVEL_ERROR);
        end;
      end;
      }

    end;

    Q.Next;

  end;

  if (informeAuto>0) then
  begin

    sOperParams := '{' +
      '"CodigoEmpresa":' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ',' +
      '"Informe":' + IntToStr(InformeAuto) + ',' +
      '"Objeto":' + IntToStr(PreparacionId) + ',' +
      '"Albaran":1,' +
      '"Usuario":' + IntToStr(CodigoUsuario) +
    '}';

    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_ActivarCustomReport, bIsCustomReport, CodigoEmpresa.EmpresaOrigen );

    sOperation := 'GENERARINFORME';
    iStatus    := 0;

    // Afegim un 1 a oper_num_retries perquè no intenti generar el document
    // més d'una vegada
    sSQL := 'INSERT INTO ' +
            '  FS_Operations ( oper_product_code, oper_name, oper_status, oper_ip_address, oper_datetime,' +
            '  oper_params, oper_CodigoEmpresa ) ' +
            'VALUES ( ' +
            '''' + SQL_Str(CONST_SGA) + ''', ' +
            '''' + SQL_Str(sOperation) + ''', ' +
            IntToStr(iStatus) + ', ' +
            '''' + SQL_Str(sRemoteAddr) + ''', ' +
            SQL_DateTimeToStr ( Now() ) + ', ' +
            '''' + sOperParams + ''', ' +
            IntToStr(CodigoEmpresa.EmpresaOrigen) + ' )';
    //gaLogFile.Write(sSQL, CONST_LOGID_BBDD, LOG_LEVEL_INFO );

    lstSQL.Add(sSQL);
    Inc(iSQLidx);

  end;

  if iSQLidx > 0 then try
    OperId := SQL_Insert_Identity ( Conn, lstSQL.Text, 'oper_id' );
  except
    on E:Exception do
    begin
      bPedidoServido := FALSE;
      bErr := true;
      sMsg := 'Error al generar albaranes: ' + E.Message;
      gaLogFile.Write_DBException(E,lstSQL.Text,'Error al generar albaranes', CONST_LOGID_BBDD);
    end;
  end;

  Q.Close;
  FreeAndNil(Q);

  FreeAndNil(lstSQL);

  if (bPedidoServido) and (not bErr) then
  begin

    sSQL := 'UPDATE FS_SGA_Picking_Preparaciones ' +
            'SET ' +
            '  Estado = 3, ' +
            '  Oper_Id = ' + intToStr(OperId) + ' ' +
            'WHERE ' +
            '  PreparacionId = ' + IntToStr(PreparacionId);

    try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E: Exception do
      begin
        bErr := true;
        sMsg := E.Message;
        gaLogFile.Write_DBException(E,sSQL,'ERROR: No se ha podido actualizar la preparación', LOG_LEVEL_ERROR);
      end;
    end;

  end;

  // Update FS_SGA_Picking_Estado_Pedido marcant com a preparació processada
  if (bPedidoServido) and (not bErr) then
  begin

    sSQL := 'UPDATE ' +
            '  FS_SGA_Picking_Estado_Pedido ' +
            'SET ' +
            '  Estado_pedido_InPicking = 3 ' +
            'WHERE ' +
            '  PreparacionId = ' + IntToStr(PreparacionId);

    try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E: Exception do
      begin
        bErr := true;
        sMsg := E.Message;
        gaLogFile.Write_DBException(E,sSQL,'ERROR: No se ha podido actualizar el estado de la preparación', LOG_LEVEL_ERROR);
      end;
    end;

  end;

  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_MantenerRestos, bMantenerRestos, TRUE, CodigoEmpresa.EmpresaOrigen );

  if (not bErr) and (bPedidoServido) and (bMantenerRestos) then
  begin

    // Esborrem les línies que no tenen quantitats preparades
    (*
    sSQL := 'DELETE FROM FS_SGA_Picking_Pedido_Lineas ' +
            'WHERE ' +
            '  PreparacionId = ' + intToStr(PreparacionId) +
            '  AND UdExpedidas <= 0';

    try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E: Exception do
      begin
        bErr := true;
        sMsg := E.Message;
        gaLogFile.Write_DBException(E,sSQL,'ERROR: No se ha podido actualizar el estado de la preparación', LOG_LEVEL_ERROR);
      end;
    end;
    *)

  end;

  // Marquem la preparació en estat 3 (creant albarà)
  if (not bErr) and (bPedidoServido) and (bMantenerRestos) then
  begin

    sSQL := 'UPDATE ' +
            '  FS_SGA_Picking_Preparaciones ' +
            'SET ' +
            '  Estado = 3 ' +
            'WHERE ' +
            '  PreparacionId = ' + intToStr(PreparacionId);
    try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E: Exception do
      begin
        bErr := true;
        sMsg := E.Message;
        gaLogFile.Write_DBException(E,sSQL,'ERROR: No se ha podido actualizar el estado de la preparación', LOG_LEVEL_ERROR);
      end;
    end;

  end;

  LP := LOG_Clear();
  LP.IdPreparacion := PreparacionId;

  if iNum=1 then
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'GENERATE-ALB', 'Generar albarán de venta', @LP )
  else
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'GENERATE-ALB', 'Generar ' + IntToStr(iNum) + 'albaranes de venta', @LP );

  Result := '{"Result":"OK","Error":"","Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1servirDevolucionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  DevolucionId: Integer;
  sSQL: String;
  Q, Q2: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoArticulo: string;
  CodigoUbicacion: string;
  CodigoUbicacionRechazos: string;
  sDesglose: string;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoUsuario: Integer;
  CodigoUbicacionDevolucion: String;
  CodigoUbicacionDevolucionRechazos: String;
  UnidadesPedidas: Double;
  UnidadesRecibidas: Double;
  UnidadesPendientes: Double;
  UnidadesPedidasBase: Double;
  UnidadesRecibidasBase: Double;
  UnidadesPendientesBase: Double;
  bIgnorarPendientes: Boolean;
  sMsg: String;
  bErr: Boolean;
  iNum: Integer;
  sNewGuid: String;
  sNewMovOrigen: String;
  sOrigenMovimiento: String;
  Albaran: String;
  dFechaAlbaran: TDate;
  CodigoCliente: String;
  TratamientoPartidas: Boolean;
  CantidadEntrada: Double;
  CantidadRechazos: Double;
  CantidadEntradaBase: Double;
  CantidadRechazosBase: Double;
  UnidadMedidaEntrada: String;
  UnidadMedidaEntradaBase: String;
  FechaCaduca: TDate;
  Precio: Double;
  UnidadMedida: String;
  Cantidad: Double;
  Rechazos: Double;
  FactorConversion: Double;
  aUbicacion: TSGAUbicacion;
  aUbicacionRechazos: TSGAUbicacion;
  Partida: String;
  sOperparams: String;
  OperId: Integer;
  MascaraAlbaran: String;
  MascaraFactura: String;
  CopiasAlbaran: Integer;
  CopiasFactura: Integer;
  ImprimirAlbaran: Boolean;
  ImprimirFactura: Boolean;
  AlbaranValorado: Boolean;
  TipoArticulo: String;
  gaMov: TSGAMovimientoStock;
  contentfields: TStringList;
  GrupoTalla: Integer;
  CodigoTalla: String;
  CodigoColor: String;
  paramFechaAlbaran: String;
  TipoFechaAlbaran: String;
  FechaAlbaran: string;
  Matricula: string;
  MatriculaRechazos: string;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];                  
  
  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  DevolucionId := StrToIntDef(contentfields.values['DevolucionId'],0);
  if DevolucionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no especificado","Data":[]}';
    Exit;
  end;

  bIgnorarPendientes := true; // StrToBoolDef(contentfields.values['IgnorarPendientes'], false);

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_FechaAlbaranDevolucion, paramFechaAlbaran, CodigoEmpresa.EmpresaOrigen );
  if paramFechaAlbaran='FECHA DE PROCESO' then
  begin
    TipoFechaAlbaran := '0';
    FechaAlbaran     := '';
  end else if paramFechaAlbaran='FECHA DEL PEDIDO' then
  begin
    TipoFechaAlbaran := '1';
    FechaAlbaran     := '';
  end else if paramFechaAlbaran='FECHA DE DEVOLUCIÓN' then
  begin
    TipoFechaAlbaran := '2';
    FechaAlbaran     := '';
  end else
  begin
    TipoFechaAlbaran := '99';
    FechaAlbaran     := contentfields.values['FechaAlbaran'];
    if FechaAlbaran='' then
    begin
      TipoFechaAlbaran := '0';
      FechaAlbaran     := '';
    end;
  end;

  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_MascaraAlbaran,  MascaraAlbaran, '', CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_MascaraFactura,  MascaraFactura, '', CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CopiasAlbaran,   CopiasAlbaran, 1, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CopiasFactura,   CopiasFactura, 1, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_ImprimirAlbaran, ImprimirAlbaran, False, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_ImprimirFactura, ImprimirFactura, False, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_AlbaranValorado, AlbaranValorado, True, CodigoEmpresa.EmpresaOrigen );

  {$ENDREGION}

  {$REGION 'Generar albarà de recepció'}

  sSQL := 'SELECT ' +
          '  Albaran, Fecha, CodigoCliente ' +
          'FROM FS_SGA_Devoluciones WITH (NOLOCK) ' +
          'WHERE ' +
          '  DevolucionId = ' + IntToStr(DevolucionId);

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no válido","Data":[]}';
    Exit;
  end;

  Albaran       := Q.FieldByName('Albaran').AsString;
  dFechaAlbaran := Trunc(Q.FieldByName('Fecha').AsDateTime);
  CodigoCliente := Q.FieldByName('CodigoCliente').AsString;

  Q.Close;
  FreeAndNil(Q);

  sSQL := 'SELECT ' +
          '  SUM(UdPedidas) AS UnidadesPedidas, SUM(UdRecibidas) AS UnidadesRecibidas, ' +
          '  SUM(UdPedidasBase) AS UnidadesPedidasBase, SUM(UdRecibidasBase) AS UnidadesRecibidasBase ' +
          'FROM FS_SGA_Devoluciones_Lineas WITH (NOLOCK) ' +
          'WHERE ' +
          '  DevolucionId = ' + IntToStr(DevolucionId);
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no válido","Data":[]}';

    Exit;
  end;

  UnidadesPedidas        := Q.FieldByName('UnidadesPedidas').AsFloat;
  UnidadesRecibidas      := Q.FieldByName('UnidadesRecibidas').AsFloat;
  UnidadesPendientes     := UnidadesPedidas - UnidadesRecibidas;
  UnidadesPedidasBase    := Q.FieldByName('UnidadesPedidasBase').AsFloat;
  UnidadesRecibidasBase  := Q.FieldByName('UnidadesRecibidasBase').AsFloat;
  UnidadesPendientesBase := UnidadesPedidasBase - UnidadesRecibidasBase;

  Q.Close;
  FreeAndNil(Q);

  if (UnidadesPedidasBase=0) or (UnidadesRecibidasBase=0) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No hay unidades para devolver","Data":[]}';
    Exit;
  end;

  if (UnidadesPendientesBase>0) and (not bIgnorarPendientes) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Existen unidades pendientes de devolver.","Data":[{"Confirmar":1}]}';
    Exit;
  end;

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  try
    // Conn.BeginTrans;
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(E.Message) + '" ,"Data":[]}';
      Exit;
    end;
  end;

  sMsg := '';
  bErr := FALSE;

  //...primer borrem totes aquelles linies de la recepción on no s'hagi tornat cap Unitat
  sSQL :=
    'DELETE fsdl ' +
    'FROM FS_SGA_Devoluciones_Lineas fsdl ' +
    'INNER JOIN Articulos art WITH (NOLOCK) ' +
    'ON art.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
    '  AND art.CodigoArticulo = fsdl.CodigoArticulo ' +
    'WHERE ' +
    '  fsdl.DevolucionId = ' + IntToStr(DevolucionId) + ' ' +
    '  AND fsdl.UdRecibidasBase = 0 ' +
    '  AND art.TipoArticulo = ''M''';
  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on e: exception do begin
      bErr := true;
      sMsg := e.Message;
    end;
  end;

  sSQL := 'SELECT ' +
          '  lpc.TipoArticulo, art.TratamientoPartidas, sdl.UnidadMedida1_ as UnidadMedidaPedido, sdl.CodigoArticulo, sdld.* ' +
          'FROM FS_SGA_Devoluciones_Lineas sdl WITH (NOLOCK) ' +
          'INNER JOIN FS_COMMON_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
          'ON ' +
          '  sdl.CodigoArticulo = art.CodigoArticulo ' +
          'INNER JOIN FS_SGA_Devoluciones_Lineas_Detalle sdld WITH (NOLOCK) ' +
          'ON ' +
          '  sdl.DevolucionId = sdld.DevolucionId AND ' +
          '  sdl.DevolucionIdLinea = sdld.DevolucionIdLinea ' +
          'INNER JOIN LineasPedidoCliente lpc WITH (NOLOCK) ' +
          'ON ' +
          '  lpc.CodigoEmpresa = sdl.CodigoEmpresa ' +
          '  AND lpc.LineasPosicion = sdl.LineasPosicion ' +
          'WHERE ' +
          '  sdl.DevolucionId = ' + IntToStr(DevolucionId) + ' ' +
          'ORDER BY ' +
          '  sdld.DevolucionIdLineaDetalle';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  if not bErr then try
    Q.Open;
    iNum := Q.RecordCount;
    if iNum=0 then begin
      sMsg := 'No se ha introducido ninguna cantidad en el detalle.';
      bErr := TRUE;
    end;
  except
    on e: exception do begin
      bErr := true;
      sMsg := e.Message;
    end;
  end;

  if not bErr then try
    sNewGuid           := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sNewMovOrigen      := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sOrigenMovimiento  := 'E';
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  while (not bErr) and (not Q.Eof) do begin

    CodigoArticulo          := Q.FieldByName('CodigoArticulo').AsString;
    TratamientoPartidas     := (Q.FieldByName('TratamientoPartidas').AsInteger<>0);
    CodigoUbicacion         := Q.FieldByName('CodigoUbicacion').AsString;
    CodigoUbicacionRechazos := Q.FieldByName('CodigoUbicacionRechazos').AsString;
    CantidadEntrada         := Q.FieldByName('UnidadesEntrada').AsFloat;
    CantidadRechazos        := Q.FieldByName('CantidadErrorEntrada').AsFloat;
    CantidadEntradaBase     := Q.FieldByName('UnidadesEntradaBase').AsFloat;
    CantidadRechazosBase    := Q.FieldByName('UnidadesErrorBase').AsFloat;
    FactorConversion        := Q.FieldByName('FactorConversion').AsFloat;
    UnidadMedidaEntrada     := AnsiUpperCase(Q.FieldByName('UnidadMedidaPedido').AsString);
    UnidadMedidaEntradaBase := AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString);
    UnidadMedida            := AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString);
    GrupoTalla              := Q.FieldByName('GrupoTalla_').AsInteger;
    CodigoTalla             := Q.FieldByName('CodigoTalla01_').AsString;
    CodigoColor             := Q.FieldByName('CodigoColor_').AsString;
    FechaCaduca             := Q.FieldByName('FechaCaducidad').AsDateTime;
    Matricula               := Q.FieldByName('Matricula').AsString;
    MatriculaRechazos       := Q.FieldByName('MatriculaRechazos').AsString;
    TipoArticulo            := AnsiUpperCase(Q.FieldByName('TipoArticulo').AsString);
    Precio                  := Q.FieldByName('Precio').AsCurrency;

    aUbicacion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );
    if aUbicacion.CodigoUbicacion='' then begin
      bErr := TRUE;
      sMsg := 'Algún código de ubicación no es correcto. Revise los datos introducidos.';
    end;

    aUbicacionRechazos := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacionRechazos );
    if (CantidadRechazos<>0) and (aUbicacionRechazos.CodigoUbicacion='') then begin
      bErr := TRUE;
      sMsg := 'Algún código de ubicación de rechazos no es correcto. Revise los datos introducidos.';
    end;

    if (TratamientoPartidas) then begin
      Partida := (Q.FieldByName('Partida').AsString);
      if Partida='' then begin
        bErr := TRUE;
        sMsg := 'Alguno de los artículos no tiene especificada la partida';
      end;
    end else begin
      Partida := '';
    end;

    // Fem els moviments d'entrada a les ubicacions del magatzem del SGA
    if TipoArticulo='M' then
    begin
      SGA_FS_ALMACEN_PrepareMov ( gaMov );
      gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
      gaMov.EmpresaOrigen          := CodigoEmpresa.EmpresaOrigen;
      gaMov.CodigoUsuario          := CodigoUsuario;
      gaMov.Ejercicio              := YY;
      gaMov.Periodo                := MonthOf(Date());
      gaMov.Fecha                  := Date();
      gaMov.FechaHora              := Now();
      gaMov.CodigoAlmacen          := aUbicacion.CodigoAlmacen;
      gaMov.CodigoUbicacion        := aUbicacion.CodigoUbicacion;
      gaMov.CodigoArticulo         := CodigoArticulo;
      gaMov.Partida                := Partida;
      gaMov.GrupoTalla             := GrupoTalla;
      gaMov.CodigoTalla            := CodigoTalla;
      gaMov.CodigoColor            := CodigoColor;
      gaMov.Unidades               := abs(CantidadEntrada);
      gaMov.UnidadMedida           := AnsiUpperCase(UnidadMedidaEntrada);
      gaMov.UnidadesBase           := abs(CantidadEntradaBase);
      gaMov.UnidadMedidaBase       := AnsiUpperCase(UnidadMedidaEntradaBase);
      gaMov.FactorConversion       := FactorConversion;
      gaMov.TipoMovimiento         := 1;
      gaMov.OrigenMovimiento       := 'E';
      gaMov.Comentario             := 'Devolución de cliente';
      gaMov.IdProcesoIME           := sNewGuid;
      gaMov.FechaCaduca            := FechaCaduca;
      gaMov.Precio                 := Precio;
      gaMov.Albaran                := Albaran;
      gaMov.FechaAlbaran           := dFechaAlbaran;
      gaMov.CodigoCliente          := CodigoCliente;
      gaMov.DevolucionId           := DevolucionId;
      gaMov.CodigoUsuario          := CodigoUsuario;
      gaMov.Matricula              := Matricula;

      //...afegim a SGA_Movimiento_Almacen
      if not bErr then try
        bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
      except
        on e: exception do begin
          bErr := true;
          sMsg := e.Message;
        end;
      end;

      // Afegim rebutjos
      if (CantidadRechazosBase<>0) then begin

        gaMov.CodigoAlmacen          := aUbicacionRechazos.CodigoAlmacen;
        gaMov.CodigoUbicacion        := aUbicacionRechazos.CodigoUbicacion;
        gaMov.Unidades               := abs(CantidadRechazos);
        gaMov.UnidadesBase           := abs(CantidadRechazosBase);
        gaMov.Comentario             := 'Devolución de cliente (rechazo)';
        gaMov.Matricula              := MatriculaRechazos;

        if not bErr then try
          bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
        except
          on e: exception do begin
            bErr := true;
            sMsg := e.Message;
          end;
        end;

      end;

    end;

    if not bErr then begin
      Q.Next;
    end;

  end;

  Q.Close;
  Q.Free;

  // Enviem la instrucció al servei per generar l'albarà
  sOperparams :=
    '{' +
    '"DevolucionId":' + IntToStr(DevolucionId) + ',' +
    '"EjercicioDocumento":' + IntToStr(YY)+',' +
    '"CodigoEmpresa":' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ',' +
    '"MascaraAlbaran":"' + SQL_Str(MascaraAlbaran) + '",' +
    '"MascaraFactura":"' + SQL_Str(MascaraFactura) + '",' +
    '"CopiasAlbaran":' + IntToStr(CopiasAlbaran) + ',' +
    '"CopiasFactura":' + IntToStr(CopiasFactura) + ',' +
    '"ImprimirAlbaran":"' + SQL_BooleanToStr(ImprimirAlbaran) + '",' +
    '"ImprimirFactura":"' + SQL_BooleanToStr(ImprimirFactura) + '",' +
    '"TipoFechaAlbaran":"' + TipoFechaAlbaran + '",' +
    '"FechaAlbaran":"' + FechaAlbaran + '",' +
    '"AlbaranValorado":"' + SQL_BooleanToStr(AlbaranValorado) + '"' +
    '}';

  sSQL := 'INSERT INTO FS_Operations ( ' +
          '  oper_CodigoEmpresa, oper_name, oper_product_code, oper_mac_address, ' +
          '  oper_ip_address, oper_datetime, oper_status, oper_params ) ' +
          'OUTPUT ' +
          '  inserted.oper_id ' +
          'VALUES ( ' +
          IntToStr(CodigoEmpresa.EmpresaOrigen) + ',' +
          '''CREARDEVOLUCIONCLIENTE'',' +
          '''E4E8'',' +
          '''' + SQL_Str(NETWORK_LocalMAC()) + ''',' +
          '''' + SQL_Str(GetLocalIp) + ''',' +
          SQL_DatetimeToStr(Now()) + ', ' +
          '0,' +
          '''' + SQL_Str(sOperparams) + ''')';
  //gaLogFile.Write(sSQL, CONST_LOGID_BBDD, LOG_LEVEL_INFO );

  if not bErr then try
    OperId := SQL_Insert_Identity ( Conn, sSQL, 'oper_id' );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if OperId=-1 then begin
    bErr := TRUE;
    sMsg := 'Error al enviar la operación a SAGE';
  end;

  sSQL := 'UPDATE ' +
          '  FS_SGA_Devoluciones ' +
          'SET ' +
          '  Estado = 3, ' +
          '  Oper_Id = ' + IntToStr(OperId) + ' ' +
          'WHERE ' +
          '  DevolucionId = ' + IntToStr(DevolucionId);
  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on e: exception do begin
      bErr := true;
      sMsg := e.Message;
    end;
  end;

  if not bErr then try
    // Conn.CommitTrans;
  except
    on E:Exception do begin
      // Conn.RollbackTrans;
      sMsg := 'Se ha producido un error:' + #13 + #10 + E.Message;
      bErr := TRUE;
    end;
  end else begin
    // Conn.RollbackTrans;
  end;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(sMsg) + '","Data":[]}';
    Exit;
  end;

  LP := LOG_Clear();
  LP.IdDevolucion := DevolucionId;
  LP.MovOrigen := gaMov.MovOrigen;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'GENERATE-DEV-ALB', 'Generar albarán de devolución de ventas', @LP );


  Result := '{"Result":"OK","Error":"","Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1servirDevolucionProvAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  DevolucionId: Integer;
  sSQL: String;
  Q, Q2: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoArticulo: string;
  CodigoUbicacion: string;
  CodigoUbicacionRechazos: string;
  sDesglose: string;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoUsuario: Integer;
  CodigoUbicacionDevolucion: String;
  CodigoUbicacionDevolucionRechazos: String;
  UnidadesPedidas: Double;
  UnidadesRecibidas: Double;
  UnidadesPendientes: Double;
  UnidadesPedidasBase: Double;
  UnidadesRecibidasBase: Double;
  UnidadesPendientesBase: Double;
  bIgnorarPendientes: Boolean;
  sMsg: String;
  bErr: Boolean;
  iNum: Integer;
  sNewGuid: String;
  sNewMovOrigen: String;
  sOrigenMovimiento: String;
  Albaran: String;
  dFechaAlbaran: TDate;
  CodigoProveedor: String;
  TratamientoPartidas: Boolean;
  CantidadEntrada: Double;
  CantidadRechazos: Double;
  CantidadEntradaBase: Double;
  CantidadRechazosBase: Double;
  UnidadMedidaEntrada: String;
  UnidadMedidaEntradaBase: String;
  FechaCaduca: TDate;
  Precio: Double;
  UnidadMedida: String;
  Cantidad: Double;
  Rechazos: Double;
  FactorConversion: Double;
  aUbicacion: TSGAUbicacion;
  aUbicacionRechazos: TSGAUbicacion;
  Partida: String;
  sOperparams: String;
  OperId: Integer;
  MascaraAlbaran: String;
  MascaraFactura: String;
  CopiasAlbaran: Integer;
  CopiasFactura: Integer;
  ImprimirAlbaran: Boolean;
  ImprimirFactura: Boolean;
  AlbaranValorado: Boolean;
  TipoArticulo: String;
  gaMov: TSGAMovimientoStock;
  contentfields: TStringList;
  GrupoTalla: Integer;
  CodigoTalla: String;
  CodigoColor: String;
  paramFechaAlbaran: String;
  TipoFechaAlbaran: String;
  FechaAlbaran: string;
  Matricula: string;
  MatriculaRechazos: string;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];
  
  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  DevolucionId := StrToIntDef(contentfields.values['DevolucionId'],0);
  if DevolucionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no especificado","Data":[]}';
    Exit;
  end;

  bIgnorarPendientes := true; // StrToBoolDef(contentfields.values['IgnorarPendientes'], false);

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_FechaAlbaranDevolucionProv, paramFechaAlbaran, CodigoEmpresa.EmpresaOrigen );
  if paramFechaAlbaran='FECHA DE PROCESO' then
  begin
    TipoFechaAlbaran := '0';
    FechaAlbaran     := '';
  end else if paramFechaAlbaran='FECHA DEL PEDIDO' then
  begin
    TipoFechaAlbaran := '1';
    FechaAlbaran     := '';
  end else if paramFechaAlbaran='FECHA DE DEVOLUCIÓN' then
  begin
    TipoFechaAlbaran := '2';
    FechaAlbaran     := '';
  end else
  begin
    TipoFechaAlbaran := '99';
    FechaAlbaran     := contentfields.values['FechaAlbaran'];
    if FechaAlbaran='' then
    begin
      TipoFechaAlbaran := '0';
      FechaAlbaran     := '';
    end;
  end;

  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_MascaraAlbaran,  MascaraAlbaran, '', CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_MascaraFactura,  MascaraFactura, '', CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CopiasAlbaran,   CopiasAlbaran, 1, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CopiasFactura,   CopiasFactura, 1, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_ImprimirAlbaran, ImprimirAlbaran, False, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_ImprimirFactura, ImprimirFactura, False, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_AlbaranValorado, AlbaranValorado, True, CodigoEmpresa.EmpresaOrigen );

  {$ENDREGION}

  {$REGION 'Generar albarà de recepció'}

  sSQL := 'SELECT ' +
          '  Albaran, Fecha, CodigoCliente ' +
          'FROM FS_SGA_DevolucionesP WITH (NOLOCK) ' +
          'WHERE ' +
          '  DevolucionId = ' + IntToStr(DevolucionId);

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no válido","Data":[]}';
    Exit;
  end;

  Albaran         := Q.FieldByName('Albaran').AsString;
  dFechaAlbaran   := Trunc(Q.FieldByName('Fecha').AsDateTime);
  CodigoProveedor := Q.FieldByName('CodigoProveedor').AsString;

  Q.Close;
  FreeAndNil(Q);

  sSQL := 'SELECT ' +
          '  SUM(UdPedidas) AS UnidadesPedidas, SUM(UdRecibidas) AS UnidadesRecibidas, ' +
          '  SUM(UdPedidasBase) AS UnidadesPedidasBase, SUM(UdRecibidasBase) AS UnidadesRecibidasBase ' +
          'FROM FS_SGA_DevolucionesP_Lineas WITH (NOLOCK) ' +
          'WHERE ' +
          '  DevolucionId = ' + IntToStr(DevolucionId);
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no válido","Data":[]}';
    Exit;
  end;

  UnidadesPedidas        := Q.FieldByName('UnidadesPedidas').AsFloat;
  UnidadesRecibidas      := Q.FieldByName('UnidadesRecibidas').AsFloat;
  UnidadesPendientes     := UnidadesPedidas - UnidadesRecibidas;
  UnidadesPedidasBase    := Q.FieldByName('UnidadesPedidasBase').AsFloat;
  UnidadesRecibidasBase  := Q.FieldByName('UnidadesRecibidasBase').AsFloat;
  UnidadesPendientesBase := UnidadesPedidasBase - UnidadesRecibidasBase;

  Q.Close;
  FreeAndNil(Q);

  if (UnidadesPedidasBase=0) or (UnidadesRecibidasBase=0) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No hay unidades para devolver","Data":[]}';
    Exit;
  end;

  if (UnidadesPendientesBase>0) and (not bIgnorarPendientes) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Existen unidades pendientes de devolver.","Data":[{"Confirmar":1}]}';
    Exit;
  end;

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  try
    // Conn.BeginTrans;
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(E.Message) + '" ,"Data":[]}';
      Exit;
    end;
  end;

  sMsg := '';
  bErr := FALSE;

  //...primer borrem totes aquelles linies de la recepción on no s'hagi tornat cap Unitat
  sSQL := 'DELETE FROM FS_SGA_DevolucionesP_Lineas ' +
          'WHERE ' +
          '  DevolucionId = ' + IntToStr(DevolucionId) + ' AND ' +
          '  UdRecibidasBase = 0';
  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on e: exception do begin
      bErr := true;
      sMsg := e.Message;
    end;
  end;

  sSQL := 'SELECT ' +
          '  lpc.TipoArticulo, art.TratamientoPartidas, sdl.UnidadMedida1_ as UnidadMedidaPedido, sdl.CodigoArticulo, sdld.* ' +
          'FROM FS_SGA_DevolucionesP_Lineas sdl WITH (NOLOCK) ' +
          'INNER JOIN FS_COMMON_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
          'ON ' +
          '  sdl.CodigoArticulo = art.CodigoArticulo ' +
          'INNER JOIN FS_SGA_DevolucionesP_Lineas_Detalle sdld WITH (NOLOCK) ' +
          'ON ' +
          '  sdl.DevolucionId = sdld.DevolucionId AND ' +
          '  sdl.DevolucionIdLinea = sdld.DevolucionIdLinea ' +
          'INNER JOIN LineasPedidoProveedor lpp WITH (NOLOCK) ' +
          'ON ' +
          '  lpp.CodigoEmpresa = sdl.CodigoEmpresa ' +
          '  AND lpp.LineasPosicion = sdl.LineasPosicion ' +
          'WHERE ' +
          '  sdl.DevolucionId = ' + IntToStr(DevolucionId) + ' ' +
          'ORDER BY ' +
          '  sdld.DevolucionIdLineaDetalle';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  if not bErr then try
    Q.Open;
    iNum := Q.RecordCount;
    if iNum=0 then begin
      sMsg := 'No se ha introducido ninguna cantidad en el detalle.';
      bErr := TRUE;
    end;
  except
    on e: exception do begin
      bErr := true;
      sMsg := e.Message;
    end;
  end;

  if not bErr then try
    sNewGuid           := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sNewMovOrigen      := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sOrigenMovimiento  := 'E';
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  while (not bErr) and (not Q.Eof) do begin

    CodigoArticulo          := Q.FieldByName('CodigoArticulo').AsString;
    TratamientoPartidas     := (Q.FieldByName('TratamientoPartidas').AsInteger<>0);
    CodigoUbicacion         := Q.FieldByName('CodigoUbicacion').AsString;
    CodigoUbicacionRechazos := Q.FieldByName('CodigoUbicacionRechazos').AsString;
    CantidadEntrada         := Q.FieldByName('UnidadesEntrada').AsFloat;
    CantidadRechazos        := Q.FieldByName('CantidadErrorEntrada').AsFloat;
    CantidadEntradaBase     := Q.FieldByName('UnidadesEntradaBase').AsFloat;
    CantidadRechazosBase    := Q.FieldByName('UnidadesErrorBase').AsFloat;
    FactorConversion        := Q.FieldByName('FactorConversion').AsFloat;
    UnidadMedidaEntrada     := AnsiUpperCase(Q.FieldByName('UnidadMedidaPedido').AsString);
    UnidadMedidaEntradaBase := AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString);
    UnidadMedida            := AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString);
    GrupoTalla              := Q.FieldByName('GrupoTalla_').AsInteger;
    CodigoTalla             := Q.FieldByName('CodigoTalla01_').AsString;
    CodigoColor             := Q.FieldByName('CodigoColor_').AsString;
    FechaCaduca             := Q.FieldByName('FechaCaducidad').AsDateTime;
    Matricula               := Q.FieldByName('Matricula').AsString;
    MatriculaRechazos       := Q.FieldByName('MatriculaRechazos').AsString;
    TipoArticulo            := AnsiUpperCase(Q.FieldByName('TipoArticulo').AsString);
    Precio                  := Q.FieldByName('Precio').AsCurrency;

    aUbicacion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );
    if aUbicacion.CodigoUbicacion='' then begin
      bErr := TRUE;
      sMsg := 'Algún código de ubicación no es correcto. Revise los datos introducidos.';
    end;

    aUbicacionRechazos := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacionRechazos );
    if (CantidadRechazos<>0) and (aUbicacionRechazos.CodigoUbicacion='') then begin
      bErr := TRUE;
      sMsg := 'Algún código de ubicación de rechazos no es correcto. Revise los datos introducidos.';
    end;

    if (TratamientoPartidas) then begin
      Partida := (Q.FieldByName('Partida').AsString);
      if Partida='' then begin
        bErr := TRUE;
        sMsg := 'Alguno de los artículos no tiene especificada la partida';
      end;
    end else begin
      Partida := '';
    end;

    // Fem els moviments d'entrada a les ubicacions del magatzem del SGA
    if TipoArticulo='M' then
    begin
      SGA_FS_ALMACEN_PrepareMov ( gaMov );
      gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
      gaMov.EmpresaOrigen          := CodigoEmpresa.EmpresaOrigen;
      gaMov.CodigoUsuario          := CodigoUsuario;
      gaMov.Ejercicio              := YY;
      gaMov.Periodo                := MonthOf(Date());
      gaMov.Fecha                  := Date();
      gaMov.FechaHora              := Now();
      gaMov.CodigoAlmacen          := aUbicacion.CodigoAlmacen;
      gaMov.CodigoUbicacion        := aUbicacion.CodigoUbicacion;
      gaMov.CodigoArticulo         := CodigoArticulo;
      gaMov.Partida                := Partida;
      gaMov.GrupoTalla             := GrupoTalla;
      gaMov.CodigoTalla            := CodigoTalla;
      gaMov.CodigoColor            := CodigoColor;
      gaMov.Unidades               := abs(CantidadEntrada);
      gaMov.UnidadMedida           := AnsiUpperCase(UnidadMedidaEntrada);
      gaMov.UnidadesBase           := abs(CantidadEntradaBase);
      gaMov.UnidadMedidaBase       := AnsiUpperCase(UnidadMedidaEntradaBase);
      gaMov.FactorConversion       := FactorConversion;
      gaMov.TipoMovimiento         := 1;
      gaMov.OrigenMovimiento       := 'E';
      gaMov.Comentario             := 'Devolución de proveedor';
      gaMov.IdProcesoIME           := sNewGuid;
      gaMov.FechaCaduca            := FechaCaduca;
      gaMov.Precio                 := Precio;
      gaMov.Albaran                := Albaran;
      gaMov.FechaAlbaran           := dFechaAlbaran;
      gaMov.CodigoProveedor        := CodigoProveedor;
      gaMov.DevolucionId           := DevolucionId;
      gaMov.CodigoUsuario          := CodigoUsuario;
      gaMov.Matricula              := Matricula;

      //...afegim a SGA_Movimiento_Almacen
      if not bErr then try
        bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
      except
        on e: exception do begin
          bErr := true;
          sMsg := e.Message;
        end;
      end;

      // Afegim rebutjos
      if (CantidadRechazosBase<>0) then begin

        gaMov.CodigoAlmacen          := aUbicacionRechazos.CodigoAlmacen;
        gaMov.CodigoUbicacion        := aUbicacionRechazos.CodigoUbicacion;
        gaMov.Unidades               := abs(CantidadRechazos);
        gaMov.UnidadesBase           := abs(CantidadRechazosBase);
        gaMov.Comentario             := 'Devolución de proveedor (rechazo)';
        gaMov.Matricula              := MatriculaRechazos;

        if not bErr then try
          bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
        except
          on e: exception do begin
            bErr := true;
            sMsg := e.Message;
          end;
        end;

      end;

    end;

    if not bErr then begin
      Q.Next;
    end;

  end;

  Q.Close;
  Q.Free;

  // Enviem la instrucció al servei per generar l'albarà
  sOperparams :=
    '{' +
    '"DevolucionId":' + IntToStr(DevolucionId) + ',' +
    '"EjercicioDocumento":' + IntToStr(YY)+',' +
    '"CodigoEmpresa":' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ',' +
    '"MascaraAlbaran":"' + SQL_Str(MascaraAlbaran) + '",' +
    '"MascaraFactura":"' + SQL_Str(MascaraFactura) + '",' +
    '"CopiasAlbaran":' + IntToStr(CopiasAlbaran) + ',' +
    '"CopiasFactura":' + IntToStr(CopiasFactura) + ',' +
    '"ImprimirAlbaran":"' + SQL_BooleanToStr(ImprimirAlbaran) + '",' +
    '"ImprimirFactura":"' + SQL_BooleanToStr(ImprimirFactura) + '",' +
    '"TipoFechaAlbaran":"' + TipoFechaAlbaran + '",' +
    '"FechaAlbaran":"' + FechaAlbaran + '",' +
    '"AlbaranValorado":"' + SQL_BooleanToStr(AlbaranValorado) + '"' +
    '}';

  sSQL := 'INSERT INTO FS_Operations ( ' +
          '  oper_CodigoEmpresa, oper_name, oper_product_code, oper_mac_address, ' +
          '  oper_ip_address, oper_datetime, oper_status, oper_params ) ' +
          'OUTPUT ' +
          '  inserted.oper_id ' +
          'VALUES ( ' +
          IntToStr(CodigoEmpresa.EmpresaOrigen) + ',' +
          '''CREARDEVOLUCIONPROVEEDOR'',' +
          '''E4E8'',' +
          '''' + SQL_Str(NETWORK_LocalMAC()) + ''',' +
          '''' + SQL_Str(GetLocalIp) + ''',' +
          SQL_DatetimeToStr(Now()) + ', ' +
          '0,' +
          '''' + SQL_Str(sOperparams) + ''')';
  //gaLogFile.Write(sSQL, CONST_LOGID_BBDD, LOG_LEVEL_INFO );

  if not bErr then try
    OperId := SQL_Insert_Identity ( Conn, sSQL, 'oper_id' );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if OperId=-1 then begin
    bErr := TRUE;
    sMsg := 'Error al enviar la operación a SAGE';
  end;

  sSQL := 'UPDATE ' +
          '  FS_SGA_DevolucionesP ' +
          'SET ' +
          '  Estado = 3, ' +
          '  Oper_Id = ' + IntToStr(OperId) + ' ' +
          'WHERE ' +
          '  DevolucionId = ' + IntToStr(DevolucionId);
  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on e: exception do begin
      bErr := true;
      sMsg := e.Message;
    end;
  end;

  if not bErr then try
    // Conn.CommitTrans;
  except
    on E:Exception do begin
      // Conn.RollbackTrans;
      sMsg := 'Se ha producido un error:' + #13 + #10 + E.Message;
      bErr := TRUE;
    end;
  end else begin
    // Conn.RollbackTrans;
  end;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(sMsg) + '","Data":[]}';
    Exit;
  end;

  LP := LOG_Clear();
  LP.IdDevolucion := DevolucionId;
  LP.MovOrigen := gaMov.MovOrigen;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'GENERATE-DEVP-ALB', 'Generar albarán de devolución de compras', @LP );

  Result := '{"Result":"OK","Error":"","Data":[]}';

  {$ENDREGION}

end;

procedure WebModule1servirRecepcionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  RecepcionId: Integer;
  sSQL: String;
  Q, Q2: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoArticulo: string;
  CodigoUbicacion: string;
  sDesglose: string;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  CodigoUsuario: Integer;
  CodigoUbicacionRecepcion: String;
  CodigoUbicacionRechazos: String;
  UnidadesPedidas: Double;
  UnidadesRecibidas: Double;
  UnidadesPendientes: Double;
  UnidadesPedidasBase: Double;
  UnidadesRecibidasBase: Double;
  UnidadesPendientesBase: Double;
  bIgnorarPendientes: Boolean;
  sMsg: String;
  bErr: Boolean;
  iNum: Integer;
  sNewGuid: String;
  sNewMovOrigen: String;
  sOrigenMovimiento: String;
  Albaran: String;
  CodigoProveedor: String;
  TratamientoPartidas: Boolean;
  CantidadEntrada: Double;
  CantidadRechazos: Double;
  CantidadEntradaBase: Double;
  CantidadRechazosBase: Double;
  UnidadMedidaEntrada: String;
  UnidadMedidaEntradaBase: String;
  FechaCaduca: TDate;
  Precio: Double;
  UnidadMedida: String;
  FactorConversion: Double;
  aUbicacion: TSGAUbicacion;
  aUbicacionRechazos: TSGAUbicacion;
  Partida: String;
  sOperparams: String;
  OperId: Integer;
  MascaraAlbaran: String;
  MascaraFactura: String;
  CopiasAlbaran: Integer;
  CopiasFactura: Integer;
  ImprimirAlbaran: Boolean;
  ImprimirFactura: Boolean;
  AlbaranValorado: Boolean;
  TipoArticulo: String;
  gaMov: TSGAMovimientoStock;
  contentfields: TStringList;
  Matricula: String;
  GrupoTalla: Integer;
  CodigoTalla: string;
  CodigoColor: string;
  MatriculaRechazos: String;
  paramFechaAlbaran: String;
  TipoFechaAlbaran: String;
  FechaAlbaran: string;
  dFechaAlbaran: TDate;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );  
  UUID          := contentfields.values['UUID'];

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  RecepcionId := StrToIntDef(contentfields.values['RecepcionId'],0);
  if RecepcionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de recepción no especificado","Data":[]}';
    Exit;
  end;

  bIgnorarPendientes := true; // StrToBoolDef(contentfields.values['IgnorarPendientes'], false);

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_FechaAlbaranRecepcion, paramFechaAlbaran, CodigoEmpresa.EmpresaOrigen );
  if paramFechaAlbaran='FECHA DE PROCESO' then
  begin
    TipoFechaAlbaran := '0';
    FechaAlbaran     := '';
  end else if paramFechaAlbaran='FECHA DEL PEDIDO' then
  begin
    TipoFechaAlbaran := '1';
    FechaAlbaran     := '';
  end else if paramFechaAlbaran='FECHA DE RECEPCIÓN' then
  begin
    TipoFechaAlbaran := '2';
    FechaAlbaran     := '';
  end else
  begin
    TipoFechaAlbaran := '99';
    FechaAlbaran     := contentfields.values['FechaAlbaran'];
    if FechaAlbaran='' then
    begin
      TipoFechaAlbaran := '0';
      FechaAlbaran     := '';
    end;
  end;

  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_MascaraAlbaran,  MascaraAlbaran, '', CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_MascaraFactura,  MascaraFactura, '', CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CopiasAlbaran,   CopiasAlbaran, 1, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CopiasFactura,   CopiasFactura, 1, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_ImprimirAlbaran, ImprimirAlbaran, False, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_ImprimirFactura, ImprimirFactura, False, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read_Default ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_AlbaranValorado, AlbaranValorado, True, CodigoEmpresa.EmpresaOrigen );

  {$ENDREGION}

  {$REGION 'Generar albarà de recepció'}

  sSQL := 'SELECT ' +
          '  Albaran, Fecha, CodigoProveedor ' +
          'FROM FS_SGA_Recepciones WITH (NOLOCK) ' +
          'WHERE ' +
          '  RecepcionId = ' + IntToStr(RecepcionId) + ' ' +
          '  AND Estado < 2';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de recepción no válido","Data":[]}';
    Exit;
  end;

  Albaran         := Q.FieldByName('Albaran').AsString;
  dFechaAlbaran   := Trunc(Q.FieldByName('Fecha').AsDateTime);
  CodigoProveedor := Q.FieldByName('CodigoProveedor').AsString;

  Q.Close;
  FreeAndNil(Q);

  sSQL := 'SELECT ' +
          '  SUM(UdPedidas) AS UnidadesPedidas, SUM(UdRecibidas) AS UnidadesRecibidas, ' +
          '  SUM(UdPedidasBase) AS UnidadesPedidasBase, SUM(UdRecibidasBase) AS UnidadesRecibidasBase ' +
          'FROM FS_SGA_Recepciones_Lineas WITH (NOLOCK) ' +
          'WHERE ' +
          '  RecepcionId = ' + IntToStr(RecepcionId);
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de recepción no válido","Data":[]}';
    Exit;
  end;

  UnidadesPedidas        := Q.FieldByName('UnidadesPedidas').AsFloat;
  UnidadesRecibidas      := Q.FieldByName('UnidadesRecibidas').AsFloat;
  UnidadesPendientes     := UnidadesPedidas - UnidadesRecibidas;
  UnidadesPedidasBase    := Q.FieldByName('UnidadesPedidasBase').AsFloat;
  UnidadesRecibidasBase  := Q.FieldByName('UnidadesRecibidasBase').AsFloat;
  UnidadesPendientesBase := UnidadesPedidas - UnidadesRecibidas;

  Q.Close;
  FreeAndNil(Q);

  if (UnidadesPedidasBase=0) or (UnidadesRecibidasBase=0) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No hay unidades para recibir","Data":[]}';
    Exit;
  end;

  if (UnidadesPendientesBase>0) and (not bIgnorarPendientes) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Existen unidades pendientes de registrar.","Data":[{"Confirmar":1}]}';
    Exit;
  end;

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  try
    // Conn.BeginTrans;
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(E.Message) + '" ,"Data":[]}';
      Exit;
    end;
  end;

  sMsg := '';
  bErr := FALSE;

  //...primer borrem totes aquelles linies de la recepción on no s'hagi recepcionat cap Unitat
  sSQL := 'DELETE FROM FS_SGA_Recepciones_Lineas ' +
          'WHERE ' +
          '  RecepcionId = ' + IntToStr(RecepcionId) + ' AND ' +
          '  UdRecibidasBase = 0';
  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on e: exception do begin
      bErr := true;
      sMsg := e.Message;
    end;
  end;

  sSQL :=
    'SELECT ' +
    '  lpp.TipoArticulo, art.TratamientoPartidas, srl.UnidadMedida1_ as UnidadMedidaPedido, srl.CodigoArticulo, ' +
    '  srl.GrupoTalla_, srl.CodigoTalla01_, srl.CodigoColor_, ' +
    '  srld.* ' +
    'FROM FS_SGA_Recepciones_Lineas srl WITH (NOLOCK) ' +
    'INNER JOIN FS_COMMON_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
    'ON ' +
    '  srl.CodigoArticulo = art.CodigoArticulo ' +
    'INNER JOIN FS_SGA_Recepciones_Lineas_Detalle srld WITH (NOLOCK) ' +
    'ON ' +
    '  srl.RecepcionId = srld.RecepcionId AND ' +
    '  srl.RecepcionIdLinea = srld.RecepcionIdLinea ' +
    'INNER JOIN LineasPedidoProveedor lpp WITH (NOLOCK) ' +
    'ON ' +
    '  lpp.CodigoEmpresa = srl.CodigoEmpresa ' +
    '  AND lpp.LineasPosicion = srl.LineasPosicion ' +
    'WHERE ' +
    '  srl.RecepcionId = ' + IntToStr(RecepcionId) + ' ' +
    'ORDER BY ' +
    '  srld.RecepcionIdLineaDetalle';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  if not bErr then try
    Q.Open;
    iNum := Q.RecordCount;
    if iNum=0 then begin
      sMsg := 'No se ha introducido ninguna cantidad en el detalle.';
      bErr := TRUE;
    end;
  except
    on e: exception do begin
      bErr := true;
      sMsg := e.Message;
    end;
  end;

  if not bErr then try
    sNewGuid           := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sNewMovOrigen      := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sOrigenMovimiento  := 'E';
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  while (not bErr) and (not Q.Eof) do begin

    CodigoArticulo          := Q.FieldByName('CodigoArticulo').AsString;
    TratamientoPartidas     := (Q.FieldByName('TratamientoPartidas').AsInteger<>0);
    CodigoUbicacion         := Q.FieldByName('CodigoUbicacion').AsString;
    CodigoUbicacionRechazos := Q.FieldByName('CodigoUbicacionRechazos').AsString;
    CantidadEntrada         := Q.FieldByName('UnidadesEntrada').AsFloat;
    CantidadEntradaBase     := Q.FieldByName('UnidadesEntradaBase').AsFloat;
    CantidadRechazos        := Q.FieldByName('CantidadErrorEntrada').AsFloat;
    CantidadRechazosBase    := Q.FieldByName('UnidadesErrorBase').AsFloat;
    FactorConversion        := Q.FieldByName('FactorConversion').AsFloat;
    UnidadMedida            := AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString);
    UnidadMedidaEntrada     := AnsiUpperCase(Q.FieldByName('UnidadMedidaPedido').AsString);
    UnidadMedidaEntradaBase := AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString);
    FechaCaduca             := Q.FieldByName('FechaCaducidad').AsDateTime;
    TipoArticulo            := AnsiUpperCase(Q.FieldByName('TipoArticulo').AsString);
    Precio                  := Q.FieldByName('Precio').AsCurrency;
    UnidadMedida            := FS_SGA_ARTICULO_UnidadBase ( Conn, CodigoEmpresa, CodigoArticulo );
    Matricula               := Q.FieldByName('Matricula').AsString;
    MatriculaRechazos       := Q.FieldByName('MatriculaRechazos').AsString;
    GrupoTalla              := Q.FieldByName('GrupoTalla_').AsInteger;
    CodigoTalla             := Q.FieldByName('CodigoTalla01_').AsString;
    CodigoColor             := Q.FieldByName('CodigoColor_').AsString;

    aUbicacion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );
    if aUbicacion.CodigoUbicacion='' then begin
      bErr := TRUE;
      sMsg := 'Algún código de ubicación no es correcto. Revise los datos introducidos.';
    end;

    aUbicacionRechazos := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacionRechazos );
    if (CantidadRechazosBase<>0) and (aUbicacionRechazos.CodigoUbicacion='') then begin
      bErr := TRUE;
      sMsg := 'Algún código de ubicación de rechazos no es correcto. Revise los datos introducidos.';
    end;

    if (TratamientoPartidas) then begin
      Partida := (Q.FieldByName('Partida').AsString);
      if Partida='' then begin
        bErr := TRUE;
        sMsg := 'Alguno de los artículos no tienen especificada la partida';
      end;
    end else begin
      Partida := '';
    end;

    // Fem els moviments d'entrada a les ubicacions del magatzem del SGA
    if TipoArticulo='M' then
    begin
      SGA_FS_ALMACEN_PrepareMov ( gaMov );
      gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
      gaMov.EmpresaOrigen          := CodigoEmpresa.EmpresaOrigen;
      gaMov.CodigoUsuario          := CodigoUsuario;
      gaMov.Ejercicio              := YY;
      gaMov.Periodo                := MonthOf(Date());
      gaMov.Fecha                  := Date();
      gaMov.FechaHora              := Now();
      gaMov.CodigoAlmacen          := aUbicacion.CodigoAlmacen;
      gaMov.CodigoUbicacion        := aUbicacion.CodigoUbicacion;
      gaMov.CodigoArticulo         := CodigoArticulo;
      gaMov.Partida                := Partida;
      gaMov.Unidades               := CantidadEntrada;
      gaMov.UnidadMedida           := AnsiUpperCase(UnidadMedidaEntrada);
      gaMov.UnidadesBase           := CantidadEntradaBase;
      gaMov.UnidadMedidaBase       := AnsiUpperCase(UnidadMedidaEntradaBase);
      gaMov.FactorConversion       := FactorConversion;
      gaMov.TipoMovimiento         := 1;
      gaMov.OrigenMovimiento       := 'E';
      gaMov.Comentario             := 'Entrada de proveedor';
      gaMov.IdProcesoIME           := sNewGuid;
      gaMov.FechaCaduca            := FechaCaduca;
      gaMov.Precio                 := Precio;
      gaMov.Albaran                := Albaran;
      gaMov.FechaAlbaran           := dFechaAlbaran;
      gaMov.CodigoProveedor        := CodigoProveedor;
      gaMov.RecepcionId            := RecepcionId;
      gaMov.CodigoUsuario          := CodigoUsuario;
      gaMov.Matricula              := Matricula;
      gaMov.GrupoTalla             := GrupoTalla;
      gaMov.CodigoTalla            := CodigoTalla;
      gaMov.CodigoColor            := CodigoColor;

      //...afegim a SGA_Movimiento_Almacen
      if (CantidadEntradaBase<>0) then
      begin
        if not bErr then try
          bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
        except
          on e: exception do begin
            bErr := true;
            sMsg := e.Message;
          end;
        end;
      end;

      // Afegim rebutjos
      if (CantidadRechazosBase<>0) then begin

        gaMov.CodigoAlmacen          := aUbicacionRechazos.CodigoAlmacen;
        gaMov.CodigoUbicacion        := aUbicacionRechazos.CodigoUbicacion;
        gaMov.Unidades               := CantidadRechazos;
        gaMov.UnidadesBase           := CantidadRechazosBase;
        gaMov.Matricula              := MatriculaRechazos;
        gaMov.Comentario             := 'Entrada de rechazo de proveedor';

        if not bErr then try
          bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
        except
          on e: exception do begin
            bErr := true;
            sMsg := e.Message;
          end;
        end;

      end;

    end;

    if not bErr then begin
      Q.Next;
    end;

  end;

  Q.Close;
  Q.Free;

  // Enviem la instrucció al servei per generar l'albarà
  sOperparams :=
    '{' +
    '"RecepcionId":' + IntToStr(RecepcionId) + ',' +
    '"EjercicioDocumento":' + IntToStr(YY)+',' +
    '"CodigoEmpresa":' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ',' +
    '"MascaraAlbaran":"' + SQL_Str(MascaraAlbaran) + '",' +
    '"MascaraFactura":"' + SQL_Str(MascaraFactura) + '",' +
    '"CopiasAlbaran":' + IntToStr(CopiasAlbaran) + ',' +
    '"CopiasFactura":' + IntToStr(CopiasFactura) + ',' +
    '"ImprimirAlbaran":"' + SQL_BooleanToStr(ImprimirAlbaran) + '",' +
    '"ImprimirFactura":"' + SQL_BooleanToStr(ImprimirFactura) + '",' +
    '"TipoFechaAlbaran":"' + TipoFechaAlbaran + '",' +
    '"FechaAlbaran":"' + FechaAlbaran + '",' +
    '"AlbaranValorado":"' + SQL_BooleanToStr(AlbaranValorado) + '"' +
    '}';

  sSQL := 'INSERT INTO FS_Operations ( ' +
          '  oper_CodigoEmpresa, oper_name, oper_product_code, oper_mac_address, ' +
          '  oper_ip_address, oper_datetime, oper_status, oper_params ) ' +
          'OUTPUT ' +
          '  inserted.oper_id ' +
          'VALUES ( ' +
          IntToStr(CodigoEmpresa.EmpresaOrigen) + ',' +
          '''CREARALBARANPROVEEDOR'',' +
          '''E4E8'',' +
          '''' + SQL_Str(NETWORK_LocalMAC()) + ''',' +
          '''' + SQL_Str(GetLocalIp) + ''',' +
          SQL_DatetimeToStr(Now()) + ', ' +
          '0,' +
          '''' + SQL_Str(sOperparams) + ''')';
  //gaLogFile.Write(sSQL, CONST_LOGID_BBDD, LOG_LEVEL_INFO );

  if not bErr then try
    OperId := SQL_Insert_Identity ( Conn, sSQL, 'oper_id' );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if OperId=-1 then begin
    bErr := TRUE;
    sMsg := 'Error al enviar la operación a SAGE';
  end;

  sSQL := 'UPDATE ' +
          '  FS_SGA_Recepciones ' +
          'SET ' +
          '  Estado = 3, ' +
          '  Oper_Id = ' + IntToStr(OperId) + ' ' +
          'WHERE ' +
          '  RecepcionId = ' + IntToStr(RecepcionId);
  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on e: exception do begin
      bErr := true;
      sMsg := e.Message;
    end;
  end;

  if not bErr then try
    // Conn.CommitTrans;
  except
    on E:Exception do begin
      // Conn.RollbackTrans;
      sMsg := 'Se ha producido un error:' + #13 + #10 + E.Message;
      bErr := TRUE;
    end;
  end else begin
    // Conn.RollbackTrans;
  end;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(sMsg) + '","Data":[]}';

    Exit;
  end;

  LP := LOG_Clear();
  LP.IdRecepcion := RecepcionId;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'SERVE-REC', 'Generar albarán de compra', @LP );

  Result := '{"Result":"OK","Error":"","Data":[]}';

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ REALITZA UNA SORTIDA I UNA ENTRADA AL MAGATZEM                        │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1traspasoStockAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  fStock: Double;
  YY, DD, MM, HH, NN, SS, MS: WORD;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  CodigoArticulo: String;
  Partida: String;
  PrecioOrigen, PrecioDestino: Double;
  CodigoAlmacen: String;
  CodigoAlmacenDestino: String;
  Comentarios: String;
  Ubicacion: String;
  UbicacionDestino: String;
  OrigenMovimiento: String;
  CodigoAgrupacion: Integer;
  MovOrigen: String;
  Serie: String;
  Documento: Integer;
  NumeroSerieLc: String;
  EjercicioDocumento: Integer;
  EmpresaOrigen: Integer;
  FechaCaduca: String;
  CodigoCliente: String;
  CodigoCanal: String;
  Partida2_: String;
  CodigoColor_: String;
  GrupoTalla_: Integer;
  CodigoTalla01_: String;
  UnidadMedida1_: String;
  TipoMovimiento: Integer;
  Importe: Double;
  Unidades2_: Double;
  UnidadMedida2_: string;
  Comentario: string;
  CodigoProveedor: string;
  IdProcesoIME: string;
  StatusTraspasadoIME: Integer;
  TipoImportacionIME: Integer;
  DocumentoUnico: Integer;
  FechaRegistro: TDateTime;
  MovPosicion: String;
  MovIdentificadorIME: String;
  bResult: Boolean;
  iLastID: Integer;
  Mensaje: String;
  iStatus: Integer;
  CodigoUbicacion: String;
  CodigoUsuario: Integer;
  CodigoUbicacionDestino: String;
  IdDocumento: String;
  sOrigenMovimiento: string;
  Unidades: Double;
  UnidadMedidaBase: String;
  UnidadesBase: Double;
  UnidadMedida: String;
  FactorConversion: Double;
  IdAprovisionamiento: Integer;
  gaMov: TSGAMovimientoStock;
  contentfields: TStringList;
  dFechaCaduca: TDate;
  EjercicioTrabajo: Integer;
  NumeroTrabajo: Integer;
  Orden: Integer;
  iEstado: Integer;
  fStockBase: Double;
  Matricula: string;
  MatriculaDestino: string;
  RestriccionesUbicacion: TUbicacionRestricciones;
  OcupacionActual: TUbicacionOcupacionActual;
  TieneRestriccion: TResultadoRestriccion;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  PrecioOrigen  := 0;
  PrecioDestino := 0;

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    gaLogFile.Write ( 'ERROR: ' + Result, sIDCall );
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.Values['UUID'];

  IdAprovisionamiento := StrToIntDef(contentfields.Values['IdAprovisionamiento'], 0 );
  if IdAprovisionamiento<>0 then
  begin
    EjercicioTrabajo := StrToIntDef(contentfields.Values['EjercicioTrabajo'], 0 );
    NumeroTrabajo := StrToIntDef(contentfields.Values['NumeroTrabajo'], 0 );
    Orden := StrToIntDef(contentfields.Values['Orden'], 0 );
  end;

  Matricula := (contentfields.values['Matricula']);
  MatriculaDestino := (contentfields.values['MatriculaDestino']);

  CodigoAlmacen := contentfields.values['CodigoAlmacen'];
  if CodigoAlmacen='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    gaLogFile.Write ( 'ERROR: ' + Result, sIDCall );
    Exit;
  end;

  CodigoAlmacenDestino := contentfields.values['CodigoAlmacenDestino'];
  if CodigoAlmacenDestino='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén de destino no especificado","Data":[]}';
    gaLogFile.Write ( 'ERROR: ' + Result, sIDCall );
    Exit;
  end;

  CodigoUbicacion := contentfields.values['CodigoUbicacion'];

  // Conversió al codi d'article real
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación no especificado","Data":[]}';
    gaLogFile.Write ( 'ERROR: ' + Result, sIDCall );
    Exit;
  end;

  if Matricula<>'' then
  begin
    if (not FS_SGA_MatriculaEnUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion, Matricula ) ) then
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El palet de origen ya no se encuentra en esta ubicación","Data":[]}';
      Exit;
    end;
  end;

  CodigoUbicacionDestino := contentfields.values['CodigoUbicacionDestino'];

  // Conversió al codi d'article real
  CodigoUbicacionDestino := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacionDestino );

  if CodigoUbicacionDestino='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación de destino no especificado","Data":[]}';
    gaLogFile.Write ( 'ERROR: ' + Result, sIDCall );
    Exit;
  end;

  if MatriculaDestino<>'' then
  begin
    if (not FS_SGA_MatriculaEnUbicacion ( Conn, CodigoEmpresa, CodigoUbicacionDestino, MatriculaDestino ) ) then
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El palet de destino ya no se encuentra en esta ubicación","Data":[]}';
      Exit;
    end;
  end;

  CodigoArticulo := (contentfields.values['CodigoArticulo']);

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );

  if CodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo de destino no especificado","Data":[]}';
    gaLogFile.Write ( 'ERROR: ' + Result, sIDCall );
    Exit;
  end;

  if CodigoArticulo='-1' then begin

    gaLogFile.Write ( 'TraspasoStock: ' +
      'Origen=' + CodigoUbicacion + ' ' + Matricula +
      ', Destino=' + CodigoUbicacionDestino + ' ' + MatriculaDestino +
      ', Artículo=TODOS' +
      ', Partida=TODAS' +
      ', Cantidad=TODO', sIDCall
    );

    Result := SGA_ReubicarCompleto (
      Conn,
      sParams,
      CodigoEmpresa,
      CodigoAlmacen,
      CodigoUbicacion,
      Matricula,
      CodigoAlmacenDestino,
      CodigoUbicacionDestino,
      MatriculaDestino
    );
    Exit;

  end;

  Unidades     := FS_StrToFloatDef ( contentfields.values['Unidades'], 0 );
  UnidadesBase := FS_StrToFloatDef ( contentfields.values['UnidadesBase'], 0 );
  if (UnidadesBase=0) and (CodigoArticulo<>'-1') then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Las unidades base no pueden ser 0","Data":[]}';
    gaLogFile.Write ( 'ERROR: ' + Result, sIDCall );
    Exit;
  end;

  UnidadMedida     := ( AnsiUpperCase(contentfields.values['UnidadMedida']) );
  UnidadMedidaBase := ( AnsiUpperCase(contentfields.values['UnidadMedidaBase']) );

  FS_SGA_Check_UnidadMedidaBase ( Conn, CodigoEmpresa, CodigoArticulo, UnidadMedida, UnidadMedidaBase );

  {UnidadMedidaBase := FS_SGA_ARTICULO_UnidadBase ( Conn, CodigoEmpresa, CodigoArticulo );

  if (UnidadMedidaBase='') and (gbTratamientoSimplificado) then
    Unidadmedida := '';

  UnidadesBase :=
      SGA_FS_ARTICULO_ConversionUnidades ( Conn, CodigoEmpresa, CodigoArticulo,
        Unidades, UnidadMedidaBase, UnidadMedida, FactorConversion );
  }

  DecodeDateTime ( Now(), YY, MM, DD, HH, NN, SS, MS );

  YY                   := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );
  Serie                := contentfields.values['Serie'];
  Documento            := StrToIntDef ( contentfields.values['Documento'], 0 );
  IdDocumento          := contentfields.values['IdDocumento'];
  Partida              := contentfields.values['Partida'];
  Partida2_            := contentfields.values['Partida2_'];
  CodigoColor_         := contentfields.values['CodigoColor'];
  GrupoTalla_          := StrToIntDef(contentfields.values['GrupoTalla'],0);
  CodigoTalla01_       := contentfields.values['CodigoTalla'];
  FactorConversion     := FS_StrToFloatDef ( contentfields.values['FactorConversion'], 1.0 );
  Comentario           := contentfields.values['Comentario'];
  CodigoCanal          := contentfields.values['CodigoCanal'];
  CodigoCliente        := contentfields.values['CodigoCliente'];
  CodigoProveedor      := contentfields.values['CodigoProveedor'];
  FechaCaduca          := contentfields.values['FechaCaduca'];
  Ubicacion            := contentfields.values['Ubicacion'];
  CodigoAgrupacion     := StrToIntDef(contentfields.values['CodigoAgrupacion'],0);
  sOrigenMovimiento    := contentfields.values['OrigenMovimiento'];
  EjercicioDocumento   := StrToIntDef ( contentfields.values['EjercicioDocumento'], 0 );
  NumeroSerieLc        := contentfields.values['NumeroSerieLc'];
  StatusTraspasadoIME  := StrToIntDef ( contentfields.values['StatusTraspasadoIME'], 0 );
  TipoImportacionIME   := StrToIntDef ( contentfields.values['TipoImportacionIME'], 2 );
  DocumentoUnico       := StrToIntDef ( contentfields.values['DocumentoUnico'], 0 );
  FechaRegistro        := Now();

  if (FechaCaduca='') or (FechaCaduca='0') then begin
    dFechaCaduca := 0;
    FechaCaduca := 'NULL';
  end else begin
    dFechaCaduca := StrToDate(FechaCaduca);
    FechaCaduca  := SQL_DateToStr(dFechaCaduca);
  end;

  try
    MovPosicion := SQL_Execute ( Conn, 'select NEWID()');
    MovPosicion := StringReplace ( MovPosicion, '{', '', [] );
    MovPosicion := StringReplace ( MovPosicion, '}', '', [] );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '","Data":[]}';
      gaLogFile.Write ( 'ERROR: ' + Result, sIDCall );
      Exit;
    end;
  end;

  try
    MovIdentificadorIME := SQL_Execute ( Conn,'select NEWID()');
    MovIdentificadorIME := StringReplace ( MovIdentificadorIME, '{', '', [] );
    MovIdentificadorIME := StringReplace ( MovIdentificadorIME, '}', '', [] );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '","Data":[]}';
      gaLogFile.Write ( 'ERROR: ' + Result, sIDCall );
      Exit;
    end;
  end;

  try
    IdProcesoIME := SQL_Execute ( Conn, 'select NEWID()');
    IdProcesoIME := StringReplace ( IdProcesoIME, '{', '', [] );
    IdProcesoIME := StringReplace ( IdProcesoIME, '}', '', [] );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '","Data":[]}';

      gaLogFile.Write ( 'ERROR: ' + Result, sIDCall );
      Exit;
    end;
  end;

  if (IdDocumento='') or (IdDocumento='0') then begin
    IdDocumento := '00000000-0000-0000-0000-000000000000';
  end;

  MovOrigen := SQL_Execute ( Conn,'select NEWID()');

  gaLogFile.Write ( 'TraspasoStock: ' +
    'Origen=' + CodigoUbicacion + ' ' + Matricula +
    ', Destino=' + CodigoUbicacionDestino + ' ' + MatriculaDestino +
    ', Artículo=' + CodigoArticulo +
    ', Partida=' + Partida +
    ', Cantidad=' + FormatFloat('#,0', Unidades), sIDCall
  );

  {$ENDREGION}

  {$ENDREGION 'Validación restricciones'}

  RestriccionesUbicacion := FS_SGA_UBICACION_Restricciones ( Conn, CodigoEmpresa, CodigoUbicacionDestino );
  OcupacionActual        := FS_SGA_UBICACION_OcupacionActual ( Conn, CodigoEmpresa, CodigoUbicacionDestino );
  TieneRestriccion       := FS_SGA_UBICACION_CheckRestriccionesArticulo (
                              Conn,
                              CodigoEmpresa,
                              CodigoUbicacionDestino,
                              RestriccionesUbicacion,
                              OcupacionActual,
                              CodigoArticulo,
                              Partida,
                              UnidadesBase
                            );

  if TieneRestriccion.Error then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Restricción de ubicación: ' + JSON_Str(TieneRestriccion.Mensaje) + '","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Realitzar operació'}

  iLastID := 0;
  iStatus := 1;

  if (Unidades<>0) or (UnidadesBase<>0) then begin

    sSQL := 'SELECT ' +
            '  sysContenidoIni ' +
            'FROM lsysIni WITH (NOLOCK) ' +
            'WHERE ' +
            '  sysGrupo = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' AND ' +
            '  sysFicheroIni = ''CUESTIONARIO'' AND ' +
            '  sysSeccion = ''GES'' AND ' +
            '  sysItem = ''StockNegativo'' ';
    giPermiteStockNegativo := SQL_Execute ( Conn, sSQL );
    if giPermiteStockNegativo=0 then begin

      fStock :=
        SGA_ALMACEN_Stock (
          Conn,
          CodigoEmpresa,
          CodigoAlmacen,
          CodigoUbicacion,
          CodigoArticulo,
          Partida,
          '',
          '',
          Matricula,
          UnidadMedida,
          UnidadMedidaBase,
          fStockBase,
          gbTratamientoSimplificado
        );

      if (fStock-Unidades<0) or (fStockBase-UnidadesBase<0) then begin
        Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se permite stock negativo en SAGE","Data":[]}';
        gaLogFile.Write ( 'ERROR: ' + Result, sIDCall );
        Exit;
      end;

    end;

    if Comentario='' then begin
      Comentario := 'Traspaso';
    end;

    // Fem el moviment de sortida a les taules del SGA
    TipoMovimiento := 2;
    if sOrigenMovimiento='' then begin
      OrigenMovimiento := 'T';
    end else begin
      OrigenMovimiento := sOrigenMovimiento;
    end;

    SGA_FS_ALMACEN_PrepareMov ( gaMov );
    gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
    gaMov.EmpresaOrigen          := CodigoEmpresa.EmpresaOrigen;
    gaMov.CodigoUsuario          := CodigoUsuario;
    gaMov.Ejercicio              := YY;
    gaMov.Periodo                := MM;
    gaMov.Fecha                  := Date();
    gaMov.FechaHora              := Now();
    gaMov.CodigoAlmacen          := CodigoAlmacen;
    gaMov.CodigoUbicacion        := CodigoUbicacion;
    gaMov.CodigoAlmacenDestino   := CodigoAlmacenDestino;
    gaMov.CodigoUbicacionDestino := CodigoUbicacionDestino;
    gaMov.CodigoArticulo         := CodigoArticulo;
    gaMov.Partida                := Partida;
    gaMov.TipoMovimiento         := 2;
    gaMov.GrupoTalla             := GrupoTalla_;
    gaMov.CodigoTalla            := CodigoTalla01_;
    gaMov.CodigoColor            := CodigoColor_;
    gaMov.OrigenMovimiento       := OrigenMovimiento;
    gaMov.Unidades               := Unidades;
    gaMov.UnidadMedida           := AnsiUpperCase(UnidadMedida);
    gaMov.UnidadesBase           := UnidadesBase;
    gaMov.UnidadMedidaBase       := AnsiUpperCase(UnidadMedidaBase);
    gaMov.FactorConversion       := FactorConversion;
    gaMov.Comentario             := Comentario;
    gaMov.IdProcesoIME           := IdProcesoIME;
    gaMov.IdDocumento            := IdDocumento;
    gaMov.Serie                  := Serie;
    gaMov.FechaCaduca            := dFechaCaduca;
    gaMov.MovOrigen              := MovOrigen;
    gaMov.CodigoAgrupacion       := CodigoAgrupacion;
    gaMov.CodigoProveedor        := CodigoProveedor;
    gaMov.Matricula	             := Matricula;
    gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );

    if PrecioOrigen=0 then
    begin
      gaMov.Precio  :=
        ARTICULO_ConsultarPrecioStock (
          Conn,
          CodigoEmpresa,
          gaMov.CodigoArticulo,
          gaMov.Partida,
          gaMov.CodigoColor,
          gaMov.CodigoTalla,
          gaMov.CodigoAlmacen,
          gaMov.GrupoTalla
        );
      PrecioOrigen  := gaMov.Precio;
    end;

    gaMov.Importe := gaMov.Precio * gaMov.UnidadesBase;

    if not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, Mensaje ) then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' +  Mensaje + '","Data":[]}';
      gaLogFile.Write ( 'ERROR: ' + Result, sIDCall );
      Exit;
    end;

    // Fem el moviment d'entrada a les taules del SGA
    TipoMovimiento := 1;
    if sOrigenMovimiento='' then begin
      OrigenMovimiento := 'T';
    end else begin
      OrigenMovimiento := sOrigenMovimiento;
    end;

    PrecioDestino := PrecioOrigen;
    if PrecioDestino=0 then
    begin
      gaMov.Precio :=
        ARTICULO_ConsultarPrecioStock (
          Conn,
          CodigoEmpresa,
          gaMov.CodigoArticulo,
          gaMov.Partida,
          gaMov.CodigoColor,
          gaMov.CodigoTalla,
          gaMov.CodigoAlmacenDestino,
          gaMov.GrupoTalla,
          gaMov.CodigoAlmacen
        );
      if gaMov.Precio=0 then
      begin
        gaMov.Precio := PrecioOrigen;
        PrecioDestino := PrecioOrigen;
      end;
    end;

    gaMov.CodigoAlmacen          := CodigoAlmacenDestino;
    gaMov.CodigoUbicacion        := CodigoUbicacionDestino;
    gaMov.CodigoAlmacenDestino   := CodigoAlmacen;
    gaMov.CodigoUbicacionDestino := CodigoUbicacion;
    gaMov.Matricula              := MatriculaDestino;
    gaMov.TipoMovimiento         := 1;
    gaMov.Importe	               := gaMov.Precio * gaMov.UnidadesBase;
    gaMov.OrigenMovimiento       := OrigenMovimiento;

    if not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, Mensaje ) then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' +  Mensaje + '","Data":[]}';
      gaLogFile.Write ( 'ERROR: ' + Result, sIDCall );
      Exit;
    end;

    // Si fem canvi de magatzem, fem els moviments a SAGE
    if CodigoAlmacen<>CodigoAlmacenDestino then begin

      sSQL := 'INSERT INTO TmpIME_MovimientoStock ( ' +
              '    CodigoEmpresa, Ejercicio, Periodo, Fecha, Serie, Documento, ' +
              '    CodigoArticulo, CodigoAlmacen, AlmacenContrapartida, Partida, ' +
              '    Partida2_, CodigoColor_, GrupoTalla_, CodigoTalla01_, TipoMovimiento, ' +
              '    Unidades, UnidadMedida1_, Precio, Importe, Unidades2_, UnidadMedida2_, ' +
              '    FactorConversion_, Comentario, CodigoCanal, CodigoCliente, CodigoProveedor, ' +
              '    FechaCaduca, Ubicacion, OrigenMovimiento, EmpresaOrigen, MovOrigen, ' +
              '    EjercicioDocumento, NumeroSerieLc, IdProcesoIME, MovIdentificadorIME, ' +
              '    StatusTraspasadoIME, TipoImportacionIME, DocumentoUnico, FechaRegistro, ' +
              '    MovPosicion ' +
              '  ) ' +
              'VALUES ( ' +
              IntToStr(CodigoEmpresa.Stocks) + ', ' +
              IntToStr(YY) + ', ' +
              IntToStr(MM) + ', ' +
              SQL_DateToStr ( Now() ) + ', ' +
              '''' + SQL_Str(Serie) + ''', ' +
              IntToStr(Documento) + ', ' +
              '''' + SQL_Str(CodigoArticulo) + ''', ' +
              '''' + SQL_Str(CodigoAlmacenDestino) + ''', ' +
              '''' + SQL_Str(CodigoAlmacen) + ''', ' +
              '''' + SQL_Str(Partida) + ''', ' +
              '''' + SQL_Str(Partida) + ''', ' +
              '''' + SQL_Str(CodigoColor_) + ''', ' +
              IntToStr(GrupoTalla_) + ', ' +
              '''' + SQL_Str(CodigoTalla01_) + ''', ' +
              '1, ' +
              SQL_FloatToStr ( Unidades ) + ', '+
              '''' + SQL_Str( UnidadMedida ) + ''', ' +
              SQL_FloatToStr ( PrecioOrigen ) + ', ' +
              SQL_FloatToStr ( Unidades * PrecioOrigen ) + ', ' +
              SQL_FloatToStr ( UnidadesBase ) + ', '+
              '''' + SQL_Str( UnidadMedidaBase ) + ''', ' +
              SQL_FloatToStr ( FactorConversion ) + ', '+
              '''' + SQL_Str( Comentario ) + ''', ' +
              '''' + SQL_Str( CodigoCanal ) + ''', ' +
              '''' + SQL_Str( CodigoCliente ) + ''', ' +
              '''' + SQL_Str( CodigoProveedor ) + ''', ' +
              FechaCaduca + ', ' +
              '''' + SQL_Str( Ubicacion ) + ''', ' +
              '''T'', ' +
              IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
              '''' + SQL_GUID_ToStr(MovOrigen) + ''', ' +
              IntToStr(EjercicioDocumento) + ', ' +
              '''' + SQL_Str( NumeroSerieLc ) + ''', ' +
              '''' + SQL_GUID_ToStr( IdProcesoIME ) + ''', ' +
              '''' + SQL_GUID_ToStr( MovIdentificadorIME ) + ''', ' +
              IntToStr(StatusTraspasadoIME) + ', ' +
              IntToStr(TipoImportacionIME) + ', ' +
              IntToStr(DocumentoUnico) + ', ' +
              SQL_DateTimeToStr ( FechaRegistro ) + ', ' +
              '''' + SQL_GUID_ToStr(gaMov.MovPosicion) + ''' )';

      try
        SQL_Execute_NoRes ( Conn, sSQL );
      except
        on E:Exception do begin
          Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '","Data":[]}';

          gaLogFile.Write ( 'ERROR: ' + Result, sIDCall );
          Exit;
        end;
      end;

      if IdAprovisionamiento<>0 then
      begin

        // MARCAR ELS MOVIMENTS
        sSQL :=
          'UPDATE FS_SGA_Aprovisionamientos_Detalle ' +
          'SET ' +
          '  UnidadesTraspasadas = UnidadesTraspasadas + ' + SQL_FloatToStr(Unidades) + ' ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
          '  AND Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
          '  AND EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
          '  AND NumeroTrabajo = ' + IntToStr(NumeroTrabajo) + ' ' +
          '  AND Orden = ' + IntToStr(Orden) + ' ';
        SQL_Execute_NoRes ( Conn, sSQL );

        sSQL :=
          'UPDATE FS_SGA_Aprovisionamientos_Detalle ' +
          'SET Estado = CASE ' +
          '  WHEN UnidadesTraspasadas = 0 THEN 0 ' +
          '  WHEN UnidadesTraspasadas < UnidadesATraspasar THEN 1 ' +
          '  ELSE 2 END ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
          '  AND Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
          '  AND EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
          '  AND NumeroTrabajo = ' + IntToStr(NumeroTrabajo) + ' ' +
          '  AND Orden = ' + IntToStr(Orden) + ' ';
        SQL_Execute_NoRes ( Conn, sSQL );

        sSQL :=
          'SELECT ' +
          '  ISNULL(MIN(Estado), 0) ' +
          'FROM FS_SGA_Aprovisionamientos_Detalle WITH (NOLOCK) ' +
          'WHERE Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
          '  AND CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
          '  AND Estado<>0';
        iEstado := SQL_Execute ( Conn, sSQL );

        sSQL :=
          'UPDATE FS_SGA_Aprovisionamientos ' +
          'SET Estado = ' + IntToStr(iEstado) + ' ' +
          'WHERE ' +
          '  Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
          '  AND CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen);
        SQL_Execute_NoRes ( Conn, sSQL );

      end;

      sSQL := 'INSERT INTO ' +
              '  FS_Operations ( oper_product_code, oper_name, oper_datetime, oper_status, oper_params, oper_CodigoEmpresa ) ' +
              'VALUES ( ' +
              '''E4E8'', ' +
              '''MOVIMIENTOSTOCK'', ' +
              SQL_DateTimeToStr(Now()) + ', ' +
              '0, ' +
              '''{"IdProcesoIME":"' + SQL_GUID_ToStr(IdProcesoIME) + '","MantenerDatos":"1","MantenerErrores":"1","Módulos":"4","CodigoEmpresa":' + IntToStr(CodigoEmpresa.Stocks) + '}'', ' +
              IntToStr(CodigoEmpresa.Stocks) +
              ')';
      //gaLogFile.Write(sSQL, CONST_LOGID_BBDD, LOG_LEVEL_INFO );

      try
        SQL_Execute_NoRes ( Conn, sSQL );
        sSQL := 'SELECT IDENT_CURRENT(''FS_Operations'')';
        iLastID := SQL_Execute ( Conn, sSQL );
      except
        on E:Exception do begin
          Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '","Data":[]}';

          gaLogFile.Write ( 'ERROR: ' + Result, sIDCall );
          Exit;
        end;
      end;

    end;

  end else begin

    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Las unidades no pueden ser 0","Data":[]}';

    Exit;

  end;

  LP := LOG_Clear();
  LP.MovOrigen := gaMov.MovOrigen;
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'STOCK-TRANSFER', 'Traspaso del artículo ' + gaMov.CodigoArticulo, @LP );

  Result := '{"Result":"OK","Error":"","Data":[]}';

  (*
  if (iLastID<>0) and (not WaitOperationDone ( Conn, iLastID, Status, Mensaje )) then begin

    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + Mensaje + '","Data":[]}';

    Exit;

  end;

  if Status<>1 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Error":"' + Mensaje + '","Data":[]}';
  end else begin
    Result := '{"Result":"OK","Error":"","Data":[]}';
  end;
  *)

  {$ENDREGION}

  gaLogFile.Write ( 'Resultado trapaso: ' + Result + ' enviado a ' + sRemoteAddr, sIDCall );

end;


procedure WebModule1traspasoUbicacionDestinoAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoAlmacen: String;
  CodigoAlmacenDestino: String;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoUbicacion: string;
  CodigoUbicacionDestino: string;
  Ejercicio: Integer;
  EmpresaOrigen: Integer;
  OrdenarPor: String;
  TipoOrden: String;
  sOrderBy: String;
  CodigoArticulo: string;
  sFiltre: string;
  Tipo: string;
  CodUbi: String;
  aUbicacion: TSGAUbicacion;
  aUbicacionDestino: TSGAUbicacion;
  contentfields: TStringList;
  fUnidadesSaldo: Double;
  CodigoTalla: String;
  CodigoColor: String;
  Matricula: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize<=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoArticulo := (contentfields.values['CodigoArticulo']);

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );
  if CodigoArticulo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo especificado incorrecto","Data":[]}';
    Exit;
  end;

  Matricula       := contentfields.values['Matricula'];
  CodigoUbicacion := (contentfields.values['CodigoUbicacion']);
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación no especificado","Data":[]}';
    Exit;
  end;

  CodigoUbicacionDestino := (contentfields.values['CodigoUbicacionDestino']);
  CodigoUbicacionDestino := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacionDestino );
  (*
  if CodigoUbicacionDestino='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación de destino no especificado","Data":[]}';
    Exit;
  end;
  *)

  CodigoAlmacenDestino := contentfields.Values['CodigoAlmacenDestino'];
  CodigoTalla := contentfields.Values['CodigoTalla'];
  CodigoColor := contentfields.Values['CodigoColor'];

  aUbicacion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );
  if aUbicacion.CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de ubicación es incorrecto","Data":[]}';
    Exit;
  end;

  (*
  aUbicacionDestino := SGA_ALMACEN_GetUbicacion ( Conn, EmpresaOrigen, CodigoUbicacionDestino );
  if aUbicacion.CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de ubicación de destino es incorrecto","Data":[]}';
    Exit;
  end;
  *)

  Tipo := (contentfields.values['Tipo']);
  if (Tipo<>'REPOSICION') and (Tipo<>'SALIDASREPOSICION') and (Tipo<>'ARTICULO') and (Tipo<>'SALIDAS') then // and (Tipo<>'VACIAS') then
    Tipo := 'ARTICULO';

  Ejercicio := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  OrdenarPor := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden  := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy   := '';

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  if Tipo='SALIDAS' then
  begin

    sSQL := 'SELECT ' +
            '  COUNT(DISTINCT fstm.CodigoUbicacion) ' +
            'FROM FS_SGA_TABLE_Movimientos ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fstm ' +
            'LEFT JOIN FS_SGA_Palet FSP WITH (NOLOCK) ' +
            'ON ' +
            '  FSP.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
            '  AND FSP.Matricula = fstm.Matricula ' +
            'LEFT JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) u ' +
            'ON ' +
            '  fstm.CodigoAlmacen = u.CodigoAlmacen ' +
            '  AND fstm.CodigoUbicacion = u.CodigoUbicacion ' +
            'WHERE ' +
            '  fstm.CodigoAlmacen = ''' + SQL_Str(CodigoAlmacenDestino) + ''' ' +
            '  AND fstm.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND ( ' +
            '    (fstm.CodigoUbicacion NOT IN ( ''' + SQL_Str(CodigoUbicacion) + ''' ) AND fstm.Matricula = '''' ) ' +
            '    OR ' +
            '    (fstm.Matricula <> ''' + SQL_Str(Matricula) + ''' AND FSP.Estado IN (1,2) ) ' +
            '  ) ' +
            '  AND fstm.TipoMovimiento = 2 ';

  end else if Tipo='SALIDASREPOSICION' then
  begin

    sSQL := 'SELECT ' +
            '  COUNT(DISTINCT fstm.CodigoUbicacion) ' +
            'FROM FS_SGA_TABLE_Movimientos ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fstm ' +
            'LEFT JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) u ' +
            'ON ' +
            '  fstm.CodigoAlmacen = u.CodigoAlmacen ' +
            '  AND fstm.CodigoUbicacion = u.CodigoUbicacion ' +
            'WHERE ' +
            '  fstm.CodigoAlmacen = ''' + SQL_Str(CodigoAlmacenDestino) + ''' ' +
            '  AND fstm.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND fstm.TipoMovimiento = 2 ' +
            '  AND fstm.CodigoUbicacion NOT IN ( ' +
            '    SELECT EXCL_Ubicacion ' +
            '    FROM FS_SGA_UbicacionesExcluidas ' +
            '    WHERE EXCL_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) ' +
            '      AND EXCL_Tipo = 0 ' +
            '  ) ';

  end else if Tipo='ARTICULO' then
  begin

    sSQL := 'SELECT ' +
            '  COUNT(DISTINCT CodigoUbicacion) ' +
            'FROM dbo.FS_SGA_TABLE_AcumuladoStock ( ' + IntToStr(CodigoEmpresa.Stocks) + ' ) fsas ' +
            'LEFT JOIN FS_SGA_Palet FSP WITH (NOLOCK) ' +
            'ON ' +
            '  FSP.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
            '  AND FSP.Matricula = fsas.Matricula ' +
            'WHERE ' +
            '  CodigoAlmacen = ''' + SQL_Str(CodigoAlmacenDestino) + ''' ' +
            '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND Ejercicio = ' + IntToStr(Ejercicio) + ' ' +
            '  AND Periodo = 99 ' +
            '  AND (UnidadesSaldo <> 0 OR UnidadesSaldoBase <> 0) ' +
            '  AND ( ' +
            '    (FSAS.CodigoUbicacion NOT IN ( ''' + SQL_Str(CodigoUbicacion) + ''' ) AND FSAS.Matricula = '''' ) ' +
            '    OR ' +
            '    (FSAS.Matricula <> ''' + SQL_Str(Matricula) + ''' AND FSP.Estado IN (1,2) ) ' +
            '  ) ';

  end else if Tipo='REPOSICION' then
  begin

    sSQL := 'SELECT ' +
            '  COUNT(DISTINCT CodigoUbicacion) ' +
            'FROM dbo.FS_SGA_TABLE_AcumuladoStock ( ' + IntToStr(CodigoEmpresa.Stocks) + ' ) fsas ' +
            'WHERE ' +
            '  CodigoAlmacen = ''' + SQL_Str(CodigoAlmacenDestino) + ''' ' +
            '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND Ejercicio = ' + IntToStr(Ejercicio) + ' ' +
            '  AND Periodo = 99 ' +
            '  AND (UnidadesSaldo <> 0 OR UnidadesSaldoBase <> 0) ';

  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
    if iTotalRegs>iPageSize then
      iTotalRegs := iPageSize;
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  if Tipo='SALIDAS' then
  begin

    sSQL := 'SELECT TOP ' + IntToStr(iPageSize) + ' ' +
            '  fstm.CodigoAlmacen, fstm.CodigoUbicacion, u.CodigoAlternativo, '''' as Partida, ' +
            '  MIN(AC.UnidadesSaldo) AS UnidadesSaldo, MIN(AC.UnidadesSaldoBase) AS UnidadesSaldoBase, ' +
            '  u.CodigoAlternativo AS CodigoUbicacionAlternativo, ' +
            '  MAX(fstm.UnidadMedida) AS UnidadMedida, NULL AS FechaCaduca, ' +
            '  MAX(FechaHora) AS FechaUltimaSalida, fstm.Matricula, FSP.Estado ' +
            'FROM FS_SGA_TABLE_Movimientos ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fstm ' +
            'LEFT JOIN FS_SGA_Palet FSP WITH (NOLOCK) ' +
            'ON ' +
            '  FSP.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
            '  AND FSP.Matricula = fstm.Matricula ' +
            'LEFT JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) u ' +
            'ON ' +
            '  fstm.CodigoAlmacen = u.CodigoAlmacen ' +
            '  AND fstm.CodigoUbicacion = u.CodigoUbicacion ' +
            'LEFT JOIN ( ' +
            '  SELECT ' +
            '    CodigoEmpresa, CodigoUbicacion, Matricula, SUM(UnidadesSaldo) AS UnidadesSaldo, SUM(UnidadesSaldoBase) AS UnidadesSaldoBase ' +
            '  FROM dbo.FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', ' + IntToStr(Ejercicio) + ' ) ' +
            '  WHERE ' +
            '    Periodo = 99 ' +
            '    AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  GROUP BY CodigoEmpresa, CodigoUbicacion, Matricula ' +
            ') AC ' +
            'ON ' +
            '  AC.CodigoEmpresa = fstm.CodigoEmpresa ' +
            '  AND AC.CodigoUbicacion = fstm.CodigoUbicacion ' +
            '  AND AC.Matricula = fstm.Matricula ' +
            'WHERE ' +
            '  fstm.CodigoAlmacen = ''' + SQL_Str(CodigoAlmacenDestino) + ''' ' +
            '  AND fstm.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND ( ' +
            '    (fstm.CodigoUbicacion NOT IN ( ''' + SQL_Str(CodigoUbicacion) + ''' ) AND fstm.Matricula = '''' ) ' +
            '    OR ' +
            '    (fstm.Matricula <> ''' + SQL_Str(Matricula) + ''' AND FSP.Estado IN (1,2) ) ' +
            '  ) ' +
            '  AND fstm.TipoMovimiento = 2 ' +
            'GROUP BY ' +
            '  fstm.CodigoAlmacen, fstm.CodigoUbicacion, u.CodigoAlternativo, fstm.Matricula, FSP.Estado ' +
            'ORDER BY ' +
            '  fstm.Matricula, MAX(FechaHora) DESC';

  end else if Tipo='SALIDASREPOSICION' then
  begin

    sSQL := 'SELECT TOP ' + IntToStr(iPageSize) + ' ' +
            '  fstm.CodigoAlmacen, fstm.CodigoUbicacion, u.CodigoAlternativo, '''' as Partida, ' +
            '  MIN(AC.UnidadesSaldo) AS UnidadesSaldo, MIN(AC.UnidadesSaldoBase) AS UnidadesSaldoBase, ' +
            '  u.CodigoAlternativo AS CodigoUbicacionAlternativo, ' +
            '  MAX(fstm.UnidadMedida) AS UnidadMedida, NULL AS FechaCaduca, ' +
            '  MAX(FechaHora) AS FechaUltimaSalida, fstm.Matricula, FSP.Estado ' +
            'FROM FS_SGA_TABLE_Movimientos ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) fstm ' +
            'LEFT JOIN FS_SGA_Palet FSP WITH (NOLOCK) ' +
            'ON ' +
            '  FSP.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
            '  AND FSP.Matricula = fstm.Matricula ' +
            'LEFT JOIN FS_SGA_TABLE_Ubicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) u ' +
            'ON ' +
            '  fstm.CodigoAlmacen = u.CodigoAlmacen ' +
            '  AND fstm.CodigoUbicacion = u.CodigoUbicacion ' +
            'LEFT JOIN ( ' +
            '  SELECT ' +
            '    CodigoEmpresa, CodigoUbicacion, SUM(UnidadesSaldo) AS UnidadesSaldo, SUM(UnidadesSaldoBase) AS UnidadesSaldoBase ' +
            '  FROM dbo.FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', ' + IntToStr(Ejercicio) + ' ) ' +
            '  WHERE ' +
            '    Periodo = 99 ' +
            '    AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  GROUP BY CodigoEmpresa, CodigoUbicacion ' +
            ') AC ' +
            'ON ' +
            '  AC.CodigoEmpresa = fstm.CodigoEmpresa ' +
            '  AND AC.CodigoUbicacion = fstm.CodigoUbicacion ' +
            'WHERE ' +
            '  fstm.CodigoAlmacen = ''' + SQL_Str(CodigoAlmacenDestino) + ''' ' +
            '  AND fstm.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND fstm.TipoMovimiento = 2 ' +
            '  AND fstm.CodigoUbicacion NOT IN ( ' +
            '    SELECT EXCL_Ubicacion ' +
            '    FROM FS_SGA_UbicacionesExcluidas ' +
            '    WHERE EXCL_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) ' +
            '      AND EXCL_Tipo = 0 ' +
            '  ) ' +
            'GROUP BY ' +
            '  fstm.CodigoAlmacen, fstm.CodigoUbicacion, u.CodigoAlternativo, fstm.Matricula, FSP.Estado ' +
            'ORDER BY ' +
            '  fstm.Matricula, MAX(fstm.FechaHora) DESC';

  end else if Tipo='ARTICULO' then
  begin

    sSQL := 'SELECT TOP ' + IntToStr(iPageSize) + ' ' +
            '  FSAS.CodigoAlmacen, FSAS.CodigoUbicacion, FSAS.CodigoUbicacionAlternativo, FSAS.Partida, FSAS.UnidadesSaldo, FSAS.UnidadesSaldoBase, ' +
            '  FSAS.FechaUltimaSalida, FSAS.CodigoAlternativo, FSAS.UnidadMedida, FSAS.FechaCaduca, FSAS.Matricula, FSP.Estado ' +
            'FROM dbo.FS_SGA_TABLE_AcumuladoStock ( ' + IntToStr(CodigoEmpresa.Stocks) + ' ) FSAS ' +
            'LEFT JOIN FS_SGA_Palet FSP WITH (NOLOCK) ' +
            'ON ' +
            '  FSP.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
            '  AND FSP.Matricula = FSAS.Matricula ' +
            'WHERE ' +
            '  FSAS.CodigoAlmacen IN (''' + SQL_Str(CodigoAlmacenDestino) + ''', ''' + SQL_Str(aUbicacion.CodigoAlmacen) + ''' ) ' +
            '  AND FSAS.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND FSAS.Ejercicio = ' + IntToStr(Ejercicio) + ' ' +
            '  AND FSAS.Periodo = 99 ' +
            '  AND (FSAS.UnidadesSaldo <> 0 OR FSAS.UnidadesSaldoBase <> 0) ' +
            '  AND ( ' +
            '    (FSAS.CodigoUbicacion NOT IN ( ''' + SQL_Str(CodigoUbicacion) + ''' ) AND FSAS.Matricula = '''' ) ' +
            '    OR ' +
            '    (FSAS.Matricula <> ''' + SQL_Str(Matricula) + ''' AND FSP.Estado IN (1,2) ) ' +
            '  ) ' +
            'ORDER BY ' +
            '  CASE WHEN FSAS.CodigoAlmacen<>''' + SQL_Str(aUbicacion.CodigoAlmacen) + ''' THEN ''zzzzzzzzzz'' ELSE FSAS.CodigoAlmacen END, ' +
            '  FSAS.Matricula, FSAS.Partida ';

  end else if Tipo='REPOSICION' then
  begin

    sSQL := 'SELECT TOP ' + IntToStr(iPageSize) + ' ' +
            '  FSAS.CodigoAlmacen, FSAS.CodigoUbicacion, FSAS.CodigoUbicacionAlternativo, FSAS.Partida, FSAS.UnidadesSaldo, FSAS.UnidadesSaldoBase, ' +
            '  FSAS.FechaUltimaSalida, FSAS.CodigoAlternativo, FSAS.UnidadMedida, FSAS.FechaCaduca, FSAS.Matricula, FSP.Estado ' +
            'FROM dbo.FS_SGA_TABLE_AcumuladoStock ( ' + IntToStr(CodigoEmpresa.Stocks) + ' ) FSAS ' +
            'LEFT JOIN FS_SGA_Palet FSP WITH (NOLOCK) ' +
            'ON ' +
            '  FSP.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
            '  AND FSP.Matricula = FSAS.Matricula ' +
            'WHERE ' +
            '  FSAS.CodigoAlmacen IN (''' + SQL_Str(CodigoAlmacenDestino) + ''', ''' + SQL_Str(aUbicacion.CodigoAlmacen) + ''' ) ' +
            '  AND FSAS.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND FSAS.CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
            '  AND FSAS.CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
            '  AND FSAS.Ejercicio = ' + IntToStr(Ejercicio) + ' ' +
            '  AND FSAS.Periodo = 99 ' +
            '  AND (FSAS.UnidadesSaldo <> 0 OR FSAS.UnidadesSaldoBase <> 0) ' +
            'ORDER BY ' +
            '  CASE WHEN FSAS.CodigoAlmacen<>''' + SQL_Str(aUbicacion.CodigoAlmacen) + ''' THEN ''zzzzzzzzzz'' ELSE FSAS.CodigoAlmacen END, ' +
            '  FSAS.Matricula, FSAS.Partida ';

  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if (Q.FieldByName('Matricula').AsString='') or (Q.FieldByName('Estado').AsInteger=1) then
    begin

      if iNumRegs<>0 then
        Result := Result + ',';

      Inc(iNumRegs);

      Result := Result + '{' +
        '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
        '"CodigoUbicacion":"' + JSON_Str(Q.FieldByName('CodigoUbicacion').AsString) + '",' +
        '"Matricula":"' + JSON_Str(Q.FieldByName('Matricula').AsString) + '",' +
        '"Estado":' + IntToStr(Q.FieldByName('Estado').AsInteger) + ',' +
        '"CodigoUbicacionAlternativo":"' + JSON_Str(Q.FieldByName('CodigoUbicacionAlternativo').AsString) + '",' +
        '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
        '"FechaCaduca":"' + JSON_Str(Q.FieldByName('FechaCaduca').AsString) + '",' +
        '"FechaUltimaSalida":"' + JSON_Str(Q.FieldByName('FechaUltimaSalida').AsString) + '",' +
        '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
        '"UnidadesSaldo":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldo').AsFloat) + ',' +
        '"UnidadesSaldoBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldoBase').AsFloat) +
        '}';

    end;

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


procedure WebModule1ubicacionesDevolucionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  CodigoUbicacionDevolucion: String;
  CodigoUbicacionDevolucionRechazos: String;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucion,         CodigoUbicacionDevolucion, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucionRechazos, CodigoUbicacionDevolucionRechazos, CodigoEmpresa.EmpresaOrigen );

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  Result := '{"Result":"OK","Error":"","TotalRecords":0,"NumPages":0,"NumRecords":0,"Data":[';

  Result := Result + '{' +
                     '"CodigoUbicacionRecepcion":"' + JSON_Str(CodigoUbicacionDevolucion) + '",' +
                     '"CodigoUbicacionRecepcionRechazos":"' + JSON_Str(CodigoUbicacionDevolucionRechazos) + '"' +
                     '}';

  Result := Result + ']}';

  {$ENDREGION}

end;


procedure WebModule1ubicacionesDevolucionProvAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  CodigoUbicacionDevolucion: String;
  CodigoUbicacionDevolucionRechazos: String;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucion,         CodigoUbicacionDevolucion, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucionRechazos, CodigoUbicacionDevolucionRechazos, CodigoEmpresa.EmpresaOrigen );

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  Result := '{"Result":"OK","Error":"","TotalRecords":0,"NumPages":0,"NumRecords":0,"Data":[';

  Result := Result + '{' +
                     '"CodigoUbicacionRecepcion":"' + JSON_Str(CodigoUbicacionDevolucion) + '",' +
                     '"CodigoUbicacionRecepcionRechazos":"' + JSON_Str(CodigoUbicacionDevolucionRechazos) + '"' +
                     '}';

  Result := Result + ']}';

  {$ENDREGION}

end;


procedure WebModule1ubicacionesRecepcionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  CodigoUbicacionRecepcion: String;
  CodigoUbicacionRecepcionRechazos: String;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionRecepcion,         CodigoUbicacionRecepcion, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionRecepcionRechazos, CodigoUbicacionRecepcionRechazos, CodigoEmpresa.EmpresaOrigen );

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  Result := '{"Result":"OK","Error":"","TotalRecords":0,"NumPages":0,"NumRecords":0,"Data":[';

  Result := Result + '{' +
                     '"CodigoUbicacionRecepcion":"' + JSON_Str(CodigoUbicacionRecepcion) + '",' +
                     '"CodigoUbicacionRecepcionRechazos":"' + JSON_Str(CodigoUbicacionRecepcionRechazos) + '"' +
                     '}';

  Result := Result + ']}';

  {$ENDREGION}



end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │                                                                       │  \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1updateCabeceraRecepcionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  IdRecepcion: Integer;
  sSQL: String;
  Data: String;
  bErr: Boolean;
  sMsg: string;
  Bultos: Integer;
  Cajas: Integer;
  Palets: Integer;
  Transportista: Integer;
  RefAlbaran: String;
  FechaAlbaran: TDate;
  contentfields: TStringList;
  Observaciones: String;
  UUID: string;

{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];

  IdRecepcion := StrToIntDef(contentfields.values['IdRecepcion'],0);
  if IdRecepcion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de recepción no especificado","Data":[]}';

    Exit;
  end;

  Bultos := StrToIntDef(contentfields.values['Bultos'],0);
  Cajas  := StrToIntDef(contentfields.values['Cajas'],0);
  Palets := StrToIntDef(contentfields.values['Palets'],0);

  Transportista := StrToIntDef(contentfields.values['Transportista'],0);
  RefAlbaran    := (contentfields.values['RefAlbaran']);
  FechaAlbaran  := StrToDateDef ( contentfields.values['RefFechaAlbaran'], Date() );

  Observaciones := Trim(contentfields.values['Observaciones']);

  {$ENDREGION}

  {$REGION 'Guardar les dades'}

  sMsg := '';
  bErr := FALSE;

  try
    // Conn.BeginTrans;
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  sSQL := 'UPDATE ' +
          '  FS_SGA_Recepciones ' +
          'SET ' +
          '  Bultos = ' + IntToStr(Bultos) + ', ' +
          '  Cajas = ' + IntToStr(Cajas) + ', ' +
          '  Palets = ' + IntToStr(Palets) + ', ' +
          '  RefNumeroAlbaran = ''' + SQL_Str(RefAlbaran) + ''', ' +
          '  RefFechaAlbaran = ' + SQL_DateToStr(FechaAlbaran) + ', ' +
          '  Observaciones = ''' + SQL_Str(Observaciones) + ''' ' +
          'WHERE ' +
          '  RecepcionId = ' + IntToStr(IdRecepcion);
  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if not bErr then try
    // Conn.CommitTrans;
  except
    on E:Exception do begin
      // Conn.RollbackTrans;
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Error":"' + JSON_Str(sMsg) + '"}';
  end else begin
    Result := '{"Result":"OK","Error":""}';
  end;

  LP := LOG_Clear();
  LP.IdRecepcion := IdRecepcion;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-REC-HEADER', 'Actualizar cabecera de recepción', @LP );

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │                                                                       │  \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1updateCabeceraDevolucionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  IdDevolucion: Integer;
  sSQL: String;
  Data: String;
  bErr: Boolean;
  sMsg: string;
  Bultos: Integer;
  Cajas: Integer;
  Palets: Integer;
  Transportista: Integer;
  RefAlbaran: String;
  FechaAlbaran: TDate;
  contentfields: TStringList;
  Observaciones: String;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];

  IdDevolucion := StrToIntDef(contentfields.values['IdDevolucion'],0);
  if IdDevolucion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no especificado","Data":[]}';
    Exit;
  end;

  Bultos := StrToIntDef(contentfields.values['Bultos'],0);
  Cajas  := StrToIntDef(contentfields.values['Cajas'],0);
  Palets := StrToIntDef(contentfields.values['Palets'],0);

  Transportista := StrToIntDef(contentfields.values['Transportista'],0);
  RefAlbaran    := (contentfields.values['RefAlbaran']);
  FechaAlbaran  := StrToDateDef ( contentfields.values['RefFechaAlbaran'], Date() );

  Observaciones := Trim(contentfields.values['Observaciones']);

  {$ENDREGION}

  {$REGION 'Guardar les dades'}

  sMsg := '';
  bErr := FALSE;

  try
    // Conn.BeginTrans;
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  sSQL :=
    'UPDATE ' +
    '  FS_SGA_Devoluciones ' +
    'SET ' +
    '  Bultos = ' + IntToStr(Bultos) + ', ' +
    '  Cajas = ' + IntToStr(Cajas) + ', ' +
    '  Palets = ' + IntToStr(Palets) + ', ' +
    '  Observaciones = ''' + SQL_Str(Observaciones) + ''' ' +
    'WHERE ' +
    '  DevolucionId = ' + IntToStr(IdDevolucion);
  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if not bErr then try
    // Conn.CommitTrans;
  except
    on E:Exception do begin
      // Conn.RollbackTrans;
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Error":"' + JSON_Str(sMsg) + '"}';
  end else begin
    Result := '{"Result":"OK","Error":""}';
  end;

  LP := LOG_Clear();
  LP.IdDevolucion := IdDevolucion;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-DEV-HEADER', 'Actualizar cabecera de devolución', @LP );

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │                                                                       │  \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1updateCabeceraDevolucionProvAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  IdDevolucion: Integer;
  sSQL: String;
  Data: String;
  bErr: Boolean;
  sMsg: string;
  Bultos: Integer;
  Cajas: Integer;
  Palets: Integer;
  Transportista: Integer;
  RefAlbaran: String;
  FechaAlbaran: TDate;
  contentfields: TStringList;
  Observaciones: String;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];

  IdDevolucion := StrToIntDef(contentfields.values['IdDevolucion'],0);
  if IdDevolucion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no especificado","Data":[]}';
    Exit;
  end;

  Bultos := StrToIntDef(contentfields.values['Bultos'],0);
  Cajas  := StrToIntDef(contentfields.values['Cajas'],0);
  Palets := StrToIntDef(contentfields.values['Palets'],0);

  Transportista := StrToIntDef(contentfields.values['Transportista'],0);
  RefAlbaran    := (contentfields.values['RefAlbaran']);
  FechaAlbaran  := StrToDateDef ( contentfields.values['RefFechaAlbaran'], Date() );

  Observaciones := Trim(contentfields.values['Observaciones']);

  {$ENDREGION}

  {$REGION 'Guardar les dades'}

  sMsg := '';
  bErr := FALSE;

  try
    // Conn.BeginTrans;
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  sSQL :=
    'UPDATE ' +
    '  FS_SGA_DevolucionesP ' +
    'SET ' +
    '  Bultos = ' + IntToStr(Bultos) + ', ' +
    '  Cajas = ' + IntToStr(Cajas) + ', ' +
    '  Palets = ' + IntToStr(Palets) + ', ' +
    '  Observaciones = ''' + SQL_Str(Observaciones) + ''' ' +
    'WHERE ' +
    '  DevolucionId = ' + IntToStr(IdDevolucion);
  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if not bErr then try
    // Conn.CommitTrans;
  except
    on E:Exception do begin
      // Conn.RollbackTrans;
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Error":"' + JSON_Str(sMsg) + '"}';
  end else begin
    Result := '{"Result":"OK","Error":""}';
  end;

  LP := LOG_Clear();
  LP.IdDevolucion := IdDevolucion;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-DEVP-HEADER', 'Actualizar cabecera de devolución de compras', @LP );

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │                                                                       │  \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1updateReservaPaletAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  CodigoUbicacion: String;
  Matricula: String;
  Tipo: String;
  CodigoCliente: String;
  CodigoCadena: String;
  IdPreparacion: Integer;
  EjercicioPedido: Integer;
  SeriePedido: String;
  NumeroPedido: Integer;
  Orden: Integer;
  LineasPosicion: String;
  sSQL: String;
  bErr: Boolean;
  sMsg: string;
  contentfields: TStringList;
  CodigoUsuario: Integer;
  UUID: string;
  sIdPreparacion: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID          := contentfields.values['UUID'];

  CodigoUbicacion := contentfields.values['CodigoUbicacion'];
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
  Matricula       := contentfields.values['Matricula'];
  Tipo            := AnsiUpperCase(contentfields.values['Tipo']);

  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de ubicación no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  if Matricula<>'' then
  begin
    if (not FS_SGA_MatriculaEnUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion, Matricula ) ) then
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El palet ya no se encuentra en esta ubicación","Data":[]}';
      Exit;
    end;
  end;

  if Tipo='CLIENTE' then
  begin
    CodigoCliente := contentfields.values['CodigoCliente'];
  end else if Tipo='CADENA' then
  begin
    CodigoCadena := contentfields.values['CodigoCadena'];
  end else if Tipo='PREPARACION' then
  begin
    IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'], 0);
  end else if Tipo='PEDIDO' then
  begin
    EjercicioPedido := StrToIntDef(contentfields.values['EjercicioPedido'], 0);
    SeriePedido     := contentfields.values['SeriePedido'];
    NumeroPedido    := StrToIntDef(contentfields.values['NumeroPedido'], 0);
    Orden           := 0;
    LineasPosicion  := GUID0;
  end else if Tipo='LINEAPEDIDO' then
  begin
    EjercicioPedido := StrToIntDef(contentfields.values['EjercicioPedido'], 0);
    SeriePedido     := contentfields.values['SeriePedido'];
    NumeroPedido    := StrToIntDef(contentfields.values['NumeroPedido'], 0);
    Orden           := StrToIntDef(contentfields.values['Orden'], 0);
    LineasPosicion  := SQL_GUID_ToStr(contentfields.values['LineasPosicion']);
  end else begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Se ha producido un error al reservar el palet","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Guardar les dades'}

  sMsg := '';
  bErr := FALSE;

  if Tipo='CLIENTE' then
  begin

    if CodigoCliente = '' then
      CodigoCliente := 'NULL'
    else
      CodigoCliente := '''' + SQL_Str(CodigoCliente) + '''';

    sSQL :=
      'UPDATE FS_SGA_Palet ' +
      'SET ' +
      '  CodigoCliente = ' + CodigoCliente + ' ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
      '  AND Matricula = ''' + SQL_Str(Matricula) + '''';

  end else if Tipo='CADENA' then
  begin

    if CodigoCadena = '' then
      CodigoCadena := 'NULL'
    else
      CodigoCadena := '''' + SQL_Str(CodigoCadena) + '''';

    sSQL :=
      'UPDATE FS_SGA_Palet ' +
      'SET ' +
      '  CodigoCadena = ' + CodigoCadena + ' ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
      '  AND Matricula = ''' + SQL_Str(Matricula) + '''';

  end else if Tipo='PREPARACION' then
  begin

    if IdPreparacion = 0 then
      sIdPreparacion := 'NULL'
    else
      sIdPreparacion := IntToStr(IdPreparacion);

    sSQL :=
      'UPDATE FS_SGA_Palet ' +
      'SET ' +
      '  IdPreparacion = ' + sIdPreparacion + ' ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
      '  AND Matricula = ''' + SQL_Str(Matricula) + '''';

  end;

  try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do
    begin
      bErr := TRUE;
      sMsg := E.Message;
      gaLogFile.Write_DBException(E, sSQL, 'Error al reservar palet', CONST_LOGID_BBDD);
    end;
  end;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Error":"' + JSON_Str(sMsg) + '"}';
  end else begin
    Result := '{"Result":"OK","Error":""}';
  end;

  LP := LOG_Clear();
  LP.Matricula := Matricula;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-PALLET-RESERV', 'Cambiar reserva de palet a ' + Tipo, @LP );
   
  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │                                                                       │  \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1updateCajasPaletsAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  IdPreparacion: Integer;
  PickingId: Integer;
  sSQL: String;
  Data: String;
  Desglose: String;
  lJSonValue: TJSonValue;
  AutoId: Integer;
  Caja: string;
  Palet: string;
  Unidades: Double;
  UnidadesBase: Double;
  bErr: Boolean;
  sMsg: string;
  Partida: string;
  JSonObject: TJSONObject;
  JSonValue: TJSONValue;
  JSonArray: TJSONArray;
  contentfields: TStringList;
  Ejercicio: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  sSQL := 'SELECT Ejercicio FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  PickingId := StrToIntDef(contentfields.values['PickingId'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de línea de preparación no especificado","Data":[]}';
    Exit;
  end;

  Data := (contentfields.values['Data']);
  if Data='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se han especificado los datos","Data":[]}';
    Exit;
  end;

  JSonObject := _Parse_JSonObject ( Data );
  if JSonObject=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El formato JSON del elemento Data es incorrecto","Data":[]}';
    Exit;
  end;

  JSonValue  := JSonObject.Get('Desglose').JsonValue;
  if JSonValue=nil then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no son válidos","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  JSonArray := TJSONArray(JSonValue);
  if JSonArray=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no contienen un array válido","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Guardar les dades'}

  sMsg := '';
  bErr := FALSE;

  try
    // Conn.BeginTrans;
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  sSQL := 'DELETE FROM FS_SGA_Picking_Pedido_Lineas_Detalle ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' AND ' +
          '  PickingId = ' + IntToStr(PickingId);
  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if not bErr then begin

    for lJSonValue in JSonArray do begin

      AutoId       := StrToIntDef(_Get_JSonValue ( lJSonValue, 'AutoId' ),0);
      Caja         := Trim(_Get_JSonValue ( lJSonValue, 'Caja' ));
      Palet        := Trim(_Get_JSonValue ( lJSonValue, 'Palet' ));
      Partida      := (_Get_JSonValue ( lJSonValue, 'Partida' ));
      Unidades     := FS_StrToFloatDef( _Get_JSonValue ( lJSonValue, 'Unidades' ),0);
      UnidadesBase := FS_StrToFloatDef( _Get_JSonValue ( lJSonValue, 'UnidadesBase' ),0);

      sSQL := 'INSERT INTO FS_SGA_Picking_Pedido_Lineas_Detalle ( ' +
              '  PreparacionId, PickingId, Ejercicio, Partida, Caja, Palet, Unidades, UnidadesBase ) ' +
              'VALUES ( ' +
              IntToStr(IdPreparacion) + ', ' +
              IntToStr(PickingId) + ', ' +
              IntToStr(Ejercicio) + ', ' +
              '''' + SQL_Str(Partida) + ''', ' +
              '''' + SQL_Str(Caja) + ''', ' +
              '''' + SQL_Str(Palet) + ''', ' +
              SQL_FloatToStr(Unidades) + ', ' +
              SQL_FloatToStr(UnidadesBase) + ' ' +
              ' )';
      if not bErr then try
        SQL_Execute_NoRes ( Conn, sSQL );
      except
        on E:Exception do begin
          bErr := TRUE;
          sMsg := E.Message;
        end;
      end;

    end;

  end;

  if not bErr then try
    // Conn.CommitTrans;
  except
    on E:Exception do begin
      // Conn.RollbackTrans;
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  JSonObject.Free;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Error":"' + JSON_Str(sMsg) + '"}';
  end else begin
    Result := '{"Result":"OK","Error":""}';
  end;

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ ACTUALITZA LA QUANTITAT UTILITZADA EN UNA LÍNIA DE PREPARACIÓ         │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1updateUnidadesPreparacionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  IdPreparacion: Integer;
  PickingId: Integer;
  sSQL: String;
  Data: String;
  Desglose: String;
  lJSonValue: TJSonValue;
  CodigoUbicacion: String;
  CodigoArticulo: String;
  Partida: String;
  LineasPosicion: String;
  Q: TADOQuery;
  aUbicacion: TSGAUbicacion;
  Stock: Double;
  UnidadesPendientes: Double;
  bErr: Boolean;
  sMsg: String;
  sNewGuid: String;
  sNewMovOrigen: String;
  sOrigenMovimiento: String;
  YY: Integer;
  CodigoUsuario: Integer;
  iNum: Integer;
  Unidades: Double;
  UnidadMedida: String;
  UnidadesBase: Double;
  UnidadMedidaBase: String;
  FactorConversion: Double;
  TratamientoPartidas: Boolean;
  CodigoUbicacionExpedicion: String;
  aUbicacionExpedicion: TSGAUbicacion;
  CodigoAlmacenUbicacion: String;
  PartidaPedido: String;
  sStr: string;
  TipoEntrada, TipoSalida: String;
  DescripcionEntrada, DescripcionSalida: String;
  sOperparams: String;
  bRecalcularRuta: Boolean;
  bResult: Boolean;
  iUnidadesNecesarias: Double;
  iUnidadesRetiradas: Double;
  iIntents: Integer;
  gaMov: TSGAMovimientoStock;
  bAutoExpedicion: Boolean;
  iNumPedidos: Integer;
  bIsBuilding: Boolean;
  contentfields: TStringList;
  CodigoAgrupacion: Integer;
  fUnidadesAgrupacion: Double;
  sUnidadMedidaAgrupacion: string;
  fCantPrep: Double;
  bSepararPorLinea: Boolean;
  PaletActual, CajaActual: Integer;
  MatriculaActual: String;
  sFechaCaduca: String;
  dFechaCaduca: TDateTime;
  sModoPackingList: String;
  iTotalPreparado: Double;
  iTotalPreparadoBase: Double;
  fQtatARestar, fQtatDetalle, fQtat: Double;
  fQtatARestarBase, fQtatDetalleBase, fQtatBase: Double;
  bFinal: Boolean;
  iAutoID: Integer;
  fStockBase: Double;
  CodigoAlmacenDefecto: string;
  CodigoAlmacen: String;
  DefaultUbi: TDefaultUbicaciones;
  CodigoTalla: String;
  CodigoColor: String;
  sPROCCustom: String;
  UUID: string;
  Ejercicio: Integer;
  sConsiderarReservas: String;
  sSoloReservas: String;
  sIgnorarPartidaSolicitada: String;
  sIgnorarUbicacionSolicitada: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  bRecalcularRuta := FALSE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID          := contentfields.values['UUID'];

  sConsiderarReservas         := contentfields.Values['ConsiderarReservas'];
  sSoloReservas               := contentfields.Values['SoloReservas'];
  sIgnorarPartidaSolicitada   := contentfields.Values['IgnorarPartidaSolicitada'];
  sIgnorarUbicacionSolicitada := contentfields.Values['IgnorarUbicacionSolicitada'];

  if sConsiderarReservas='' then sConsiderarReservas := '1';
  if sSoloReservas='' then sSoloReservas := '0';
  if sIgnorarPartidaSolicitada='' then sIgnorarPartidaSolicitada := '0';
  if sIgnorarUbicacionSolicitada='' then sIgnorarUbicacionSolicitada := '0';

  CodigoAlmacenDefecto := (contentfields.Values['CodigoAlmacenDefecto']);
  if CodigoAlmacenDefecto='' then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_ModoPackingList, sModoPackingList, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_DesglosarPreparacionesPorLinea, bSepararPorLinea, CodigoEmpresa.EmpresaOrigen );

  YY := SGA_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  sSQL := 'SELECT Ejercicio FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  CodigoArticulo := (contentfields.values['CodigoArticulo']);
  LineasPosicion := SQL_GUID_ToStr((contentfields.values['LineasPosicion']));
  sFechaCaduca   := Trim(contentfields.values['FechaCaducidad']);

  if sFechaCaduca<>'' then
  begin
    dFechaCaduca := StrToDate(sFechaCaduca);
  end else begin
    dFechaCaduca := 0;
  end;

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );

  if CodigoArticulo=''then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  TratamientoPartidas := ARTICULO_TratamientoPartida ( Conn, CodigoEmpresa, CodigoArticulo );

  PartidaPedido := (contentfields.values['PartidaPedido']);

  PaletActual     := StrToIntDef(Trim(contentfields.values['PaletActual']),1);
  CajaActual      := StrToIntDef(Trim(contentfields.values['CajaActual']),1);
  MatriculaActual := contentfields.values['MatriculaActual'];

  (*
  if (PartidaPedido='') and (TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de partida del pedido no especificado","Data":[]}';

    Exit;
  end;

  if (PartidaPedido<>'') and (not TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo del pedido no requiere partida","Data":[]}';

    Exit;
  end;
  *)

  Partida := (contentfields.values['Partida']);
  if (Partida='') and (TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de partida no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  if (Partida<>'') and (not TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no requiere partida","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  CodigoAgrupacion := StrToIntDef(contentfields.Values['CodigoAgrupacion'], 0);
  CodigoUbicacion  := (contentfields.Values['CodigoUbicacion']);

  FS_SGA_ObtenerAgrupacion ( Conn, CodigoEmpresa, CodigoArticulo, CodigoAgrupacion,
    fUnidadesAgrupacion, sUnidadMedidaAgrupacion );

  // Conversió al codi d'article real
  CodigoUbicacion        := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
  CodigoAlmacenUbicacion := FS_SGA_CodigoAlmacen ( CodigoUbicacion );

  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de ubicación no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  sSQL :=
      'SELECT AlmacenPreparacion ' +
      'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
      'WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  CodigoAlmacen := SQL_Execute ( Conn, sSQL );

  if (CodigoAlmacen='') or (CodigoAlmacen='0') then
  begin
    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacion, CodigoEmpresa.EmpresaOrigen );
    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacion );
  end;

  FS_SGA_ObtenerUbicacionesAlmacen ( Conn, CodigoEmpresa, CodigoAlmacen, DefaultUbi );
  CodigoUbicacionExpedicion := DefaultUbi.UbicacionExpediciones;

  //PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacionExpedicion, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_TipoMovimientoEntradaExpedicion, TipoEntrada, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_TipoMovimientoSalidaExpedicion, TipoSalida, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_DescripcionEntradaExpedicion, DescripcionEntrada, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_DescripcionSalidaExpedicion, DescripcionSalida, CodigoEmpresa.EmpresaOrigen );

  aUbicacionExpedicion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacionExpedicion );
  if aUbicacionExpedicion.CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de ubicación de expedición no definido en parámetros","Data":[]}';
    Exit;
  end;

  Unidades := FS_StrToFloatDef ( Trim(contentfields.values['Cantidad']), 0 );
  if Unidades=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Cantidad no especificada","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  aUbicacion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );
  if aUbicacion.CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de ubicación es incorrecto","Data":[]}';
    Exit;
  end;

  UnidadMedida     := ( AnsiUpperCase(contentfields.values['UnidadMedida']) );
  UnidadMedidaBase := FS_SGA_ARTICULO_UnidadBase ( Conn, CodigoEmpresa, CodigoArticulo );

  FS_SGA_Check_UnidadMedidaBase ( Conn, CodigoEmpresa, CodigoArticulo, UnidadMedida, UnidadMedidaBase );

  if (UnidadMedidaBase='') and (gbTratamientoSimplificado) then
    Unidadmedida := '';

  UnidadesBase := SGA_FS_ARTICULO_ConversionUnidades ( Conn, CodigoEmpresa, CodigoArticulo,
                    Unidades, UnidadMedidaBase, UnidadMedida, FactorConversion );

  if UnidadesBase=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Las unidades de medida son incorrectas","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  Stock :=
    SGA_ALMACEN_Stock (
      Conn,
      CodigoEmpresa,
      aUbicacion.
      CodigoAlmacen,
      CodigoUbicacion,
      CodigoArticulo,
      Partida,
      '',
      '',
      MatriculaActual,
      UnidadMedida,
      UnidadMedidaBase,
      fStockBase,
      gbTratamientoSimplificado
    );

  if (Unidades>0) and ((Unidades>Stock) or (UnidadesBase>fStockBase)) then begin
    Result := '{"Almacen":"' + JSON_Str(aUbicacion.CodigoAlmacen) + '","Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La cantidad es superior al stock de la ubicación del almacén","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  sSQL := 'SELECT SUM(UdNecesarias) - MAX(UdRetiradas) ' +
          'FROM   FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
          'WHERE PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          'AND CodigoArticulo=''' + SQL_Str(CodigoArticulo) + ''' ' +
          'AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion) + ' ';
  if LineasPosicion<>'00000000-0000-0000-0000-000000000000' then
  begin
    sSQL := sSQL + 'AND LineasPosicion=''' + SQL_GUID_ToStr(LineasPosicion) + ''' ';
  end;

  UnidadesPendientes := SQL_Execute ( Conn, sSQL );

  gaLogFile.Write ( 'Unidades pendientes = ' + FloatToStr(UnidadesPendientes) + ', Unidades = ' + FloatToStr(Unidades) + ', Stock = ' + FloatToStr(Stock), sIDCall  );
  if Unidades=Stock then begin
    // Mirar si en quedaran de pendents
    if (UnidadesPendientes-Unidades)>0 then begin
      PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_RecalcularRutaAlVaciarUbicacion, bRecalcularRuta, CodigoEmpresa.EmpresaOrigen );
      if bRecalcularRuta then
      begin
        gaLogFile.Write ( 'Recalcular ruta = true' , sIDCall );
      end;
    end;
  end;

  // Si estem fent una sortida negativa, mirem si la quantitat que treiem
  // d'una partida concreta no queda negatiu
  if Unidades<0 then
  begin

    sSQL := 'SELECT ' +
            '  ISNULL(SUM(Cantidad),0) ' +
            'FROM FS_SGA_AcumuladoPendiente WITH (NOLOCK) ' +
            'WHERE ' +
            '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
            '  AND LineaPedidoCliente = ''00000000-0000-0000-0000-000000000000'' ' +
            '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
            '  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion) + ' ' +
            '  AND UnidadMedida = ''' + UnidadMedida + ''' ';

    fCantPrep := SQL_Execute ( Conn, sSQL );

    if Abs(Unidades) > fCantPrep then
    begin
      Result := '{"Almacen":"' + JSON_Str(aUbicacion.CodigoAlmacen) + '","Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La cantidad es superior a la preparada","Data":[]}';
      gaLogFile.Write ( Result, sIDCall  );
      Exit;
    end;

    PickingId := 0;
    if LineasPosicion<>'00000000-0000-0000-0000-000000000000' then
    begin
      sSQL := 'SELECT ' +
              '  PickingId ' +
              'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
              'WHERE ' +
              '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
              '  AND LineasPosicion = ''' + SQL_GUID_ToStr ( LineasPosicion ) + '''';
      try
        PickingId := SQL_Execute ( Conn, sSQL );
      except
        on E:Exception do
        begin
          PickingId := 0;
          gaLogFile.Write_DBException(E,sSQL,'Error al recuperar el pickinid de la línea', CONST_LOGID_BBDD );
        end;
      end;
    end;

    // EN MODO AUTOMÀTIC, MIRAR SI PODEM RESTAR UNITATS D'UNA CAIXA/PALET
    if ((sModoPackingList='AUTOMÁTICO') and (Unidades<0)) then
    begin

      if MatriculaActual<>'' then
      begin
        sSQL :=
          'SELECT ' +
          '  SUM(Unidades) AS Unidades, SUM(Unidades) AS UnidadesBase ' +
          'FROM FS_SGA_Picking_Pedido_Lineas_Detalle WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND LineaPedidoAsignada = ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ' +
          '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
          '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
          '  AND CajaId = ' + IntToStr(CajaActual) + ' ' +
          '  AND Matricula = ''' + SQL_Str(MatriculaActual) + '''';
      end else begin
        sSQL :=
          'SELECT ' +
          '  SUM(Unidades) AS Unidades, SUM(Unidades) AS UnidadesBase ' +
          'FROM FS_SGA_Picking_Pedido_Lineas_Detalle WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND LineaPedidoAsignada = ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ' +
          '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
          '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
          '  AND CajaId = ' + IntToStr(CajaActual) + ' ' +
          '  AND PaletId = ' + IntToStr(PaletActual);
      end;

      Q := SQL_PrepareQuery ( Conn, sSQL );
      Q.Open;

      if not Q.EOF then
      begin
        iTotalPreparado     := Q.FieldByName('Unidades').AsFloat;
        iTotalPreparadoBase := Q.FieldByName('UnidadesBase').AsFloat;
      end else begin
        iTotalPreparado     := 0;
        iTotalPreparadoBase := 0;
      end;

      Q.Close;
      FreeAndNil(Q);

      if Abs(Unidades)>iTotalPreparado then
      begin
        if MatriculaActual<>'' then
        begin
          Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '",' +
            '"Result":"ERROR","Message":"No pueden quitarse tantas unidades de la caja ' + IntToStr(CajaActual) + ' y palet ' + MatriculaActual + '","Data":[]}';
        end else begin
          Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '",' +
            '"Result":"ERROR","Message":"No pueden quitarse tantas unidades de la caja ' + IntToStr(CajaActual) + ' y palet ' + IntToStr(PaletActual) + '","Data":[]}';
        end;
        Exit;
      end;

    end;

  end;

  // Mirem si fem expedició automàtica quan només tenim un pedido
  (*
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_AutoExpedicion, bAutoExpedicion, CodigoEmpresa.EmpresaOrigen );

  // Ens assegurem que només tinguem una sola comanda si tenim AutoExpedició
  if bAutoExpedicion then
  begin

    sSQL := 'SELECT COUNT ( * ) ' +
            'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
            'WHERE ' +
            '  PreparacionId = ' + IntToStr(IdPreparacion);
    iNumPedidos := SQL_Execute ( Conn, sSQL );

    if iNumPedidos>1 then
    begin
      bAutoExpedicion := FALSE;
      gaLogFile.Write ( 'Se han seleccionado más de un pedido y no se puede realizar la autoexpedición', sIDCall );
    end;

  end;
  *)

  {$ENDREGION}

  sStr := '  Preparacion    : ' + IntToStr(IdPreparacion) + #13 + #10 +
          '                       CodigoArticulo : ' + CodigoArticulo + #13 + #10 +
          '                       Partida        : ' + Partida + #13 + #10 +
          '                       CodigoUbicacion: ' + CodigoUbicacion + #13 + #10 +
          '                       Destino        : ' + CodigoUbicacionExpedicion + #13 + #10 +
          '                       Cantidad       : ' + FloatToStr(Unidades) + #13 + #10 +
          '                       CantidadBase   : ' + FloatToStr(UnidadesBase) + #13 + #10 +
          '                       Caducidad      : ' + sFechaCaduca + #13 + #10 +
          '                       Autoexpedicion : ' + BoolToStr(bAutoExpedicion) + #13 + #10;
  gaLogFile.Write ( sStr, sIDCall  );

  {$REGION 'Guardar les dades'}

  bErr := FALSE;
  sMsg := '';

  // Preprocesa UPDATE
  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_UpdateCantidadPreparacion_BEFORE', sPROCCustom) then
  begin

    sSQL := 'EXEC dbo.[' + sPROCCustom + '] ' +
            IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
            IntToStr(IdPreparacion);
    try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E:Exception do
      begin
        gaLogFile.Write_DBException(E,sSQL,'Error al preprocesar la cantidad de preparación', CONST_LOGID_BBDD );
      end;
    end;
  end;

  if not bErr then try
    sNewGuid           := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sNewMovOrigen      := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sOrigenMovimiento  := 'S';
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if not bErr then
  begin

    gaLogFile.Write ( 'SGA_Reservar_stock_pedido', sIDCall  );

    iIntents := 1;

    while (iIntents<=3) do begin

      bErr := not SGA_Reservar_stock_pedido (
        Conn,
        CodigoEmpresa,
        YY,
        '',
        '',
        CodigoArticulo,
        Partida,
        IdPreparacion,
        0,
        LineasPosicion,
        Unidades,
        UnidadMedida,
        UnidadesBase,
        UnidadMedidaBase,
        CodigoAgrupacion,
        dFechaCaduca,
        sMsg
      );

      if bErr then
        gaLogFile.Write ( 'After SGA_Reservar_stock_pedido: ERROR (intent ' + inttostr(iIntents) + ')', sIDCall  )
      else
        gaLogFile.Write ( 'After SGA_Reservar_stock_pedido: OK', sIDCall );

      if bErr then begin
        Inc(iIntents);
        Sleep(1000);
      end else begin
        iIntents := 999;
      end;

    end;

  end;

  if bErr then
    gaLogFile.Write ( 'ERROR: ' + sMsg, sIDCall );

  SGA_FS_ALMACEN_PrepareMov ( gaMov );
  gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
  gaMov.EmpresaOrigen          := CodigoEmpresa.EmpresaOrigen;
  gaMov.CodigoUsuario          := CodigoUsuario;
  gaMov.Ejercicio              := YY;
  gaMov.Periodo                := MonthOf(Date());
  gaMov.Fecha                  := Date();
  gaMov.FechaHora              := Now();
  gaMov.CodigoAlmacen          := aUbicacion.CodigoAlmacen;
  gaMov.CodigoUbicacion        := CodigoUbicacion;
  gaMov.CodigoArticulo         := CodigoArticulo;
  gaMov.Partida                := Partida;
  gaMov.Partida2               := PartidaPedido;
  gaMov.TipoMovimiento         := 2;
  gaMov.OrigenMovimiento       := TipoSalida;
  gaMov.Unidades               := Unidades;
  gaMov.UnidadMedida           := AnsiUpperCase(UnidadMedida);
  gaMov.UnidadesBase           := UnidadesBase;
  gaMov.UnidadMedidaBase       := AnsiUpperCase(UnidadMedidaBase);
  gaMov.FactorConversion       := FactorConversion;
  gaMov.FechaCaduca            := dFechaCaduca;
  gaMov.IdProcesoIME           := sNewGuid;
  gaMov.Comentario             := 'SGAMobile: ' + DescripcionSalida;
  gaMov.PreparacionId          := IdPreparacion;
  gaMov.MovOrigen              := sNewMovOrigen;
  gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );
  gaMov.Matricula              := MatriculaActual;

  gaMov.Precio :=
    ARTICULO_ConsultarPrecioStock (
      Conn,
      CodigoEmpresa,
      gaMov.CodigoArticulo,
      gaMov.Partida,
      gaMov.CodigoColor,
      gaMov.CodigoTalla,
      gaMov.CodigoAlmacen,
      gaMov.GrupoTalla
    );

  if aUbicacion.CodigoAlmacen<>aUbicacionExpedicion.CodigoAlmacen then begin
    gaMov.CodigoAlmacenDestino   := aUbicacionExpedicion.CodigoAlmacen;
    gaMov.CodigoUbicacionDestino := aUbicacionExpedicion.CodigoUbicacion;
  end;

  if not bErr then try
    gaLogFile.Write ( 'SGA_FS_ALMACEN_MovimientoStock salida', sIDCall );
    bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if aUbicacion.CodigoAlmacen<>aUbicacionExpedicion.CodigoAlmacen then begin
    gaLogFile.Write ( 'SGA_FS_ALMACEN_MovimientoStock traspaso', sIDCall  );
    gaMov.CodigoAlmacenDestino   := aUbicacion.CodigoAlmacen;
    gaMov.CodigoUbicacionDestino := aUbicacion.CodigoUbicacion;
  end;

  gaMov.FechaHora              := Now();
  gaMov.CodigoAlmacen          := aUbicacionExpedicion.CodigoAlmacen;
  gaMov.CodigoUbicacion        := CodigoUbicacionExpedicion;
  gaMov.CodigoArticulo         := CodigoArticulo;
  gaMov.TipoMovimiento         := 1;
  gaMov.OrigenMovimiento       := TipoEntrada;
  gaMov.Comentario             := 'SGAMobile: ' + DescripcionEntrada;
  gaMov.Precio :=
    ARTICULO_ConsultarPrecioStock (
      Conn,
      CodigoEmpresa,
      gaMov.CodigoArticulo,
      gaMov.Partida,
      gaMov.CodigoColor,
      gaMov.CodigoTalla,
      gaMov.CodigoAlmacen,
      gaMov.GrupoTalla,
      gaMov.CodigoAlmacenDestino
    );

  if not bErr then try
    gaLogFile.Write ( 'SGA_FS_ALMACEN_MovimientoStock entrada', sIDCall  );
    bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg, sIDCall );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  // Fem els moviments a Sage si els magatzems són diferents
  if (not bErr) and (aUbicacion.CodigoAlmacen <> aUbicacionExpedicion.CodigoAlmacen) then begin

    gaLogFile.Write ( 'Movimiento de traspaso en Sage, IdProcesoIME = ' + gaMov.IdProcesoIME, sIDCall  );

    // Inserir línia a TmpIME_MovimientoStock
    sSQL := 'INSERT INTO TmpIME_MovimientoStock ( CodigoEmpresa, EmpresaOrigen, Ejercicio, Periodo, Fecha, FechaRegistro, Serie, '+
            '  CodigoArticulo, CodigoAlmacen, AlmacenContrapartida, Partida, Partida2_, TipoMovimiento, Unidades, ' +
            '  UnidadMedida1_, Unidades2_, UnidadMedida2_, FactorConversion_, Comentario, Ubicacion, ' +
            '  idProcesoIME, MovOrigen, Precio, Importe, FechaCaduca, OrigenMovimiento, MovPosicion, CodigoTalla01_, CodigoColor_ ) '+
            'VALUES (' +
            IntToStr(gaMov.CodigoEmpresa) + ', ' +
            IntToStr(gaMov.EmpresaOrigen) + ', ' +
            IntToStr(gaMov.Ejercicio) + ', ' +
            IntToStr(gaMov.Periodo) + ', ' +
            SQL_DateTimeToStr(gaMov.Fecha) + ', ' +
            SQL_DateTimeToStr(gaMov.FechaHora) + ', ' +
            '''' + SQL_Str(gaMov.Serie) + ''', ' +
            '''' + SQL_Str(gaMov.CodigoArticulo) + ''', ' +
            '''' + SQL_Str(gaMov.CodigoAlmacenDestino) + ''', ' +
            '''' + SQL_Str(gaMov.CodigoAlmacen) + ''', ' +
            '''' + SQL_Str(gaMov.Partida) + ''', ' +
            '''' + SQL_Str(gaMov.Partida) + ''', ' +
            '2, ' +
            SQL_FloatToStr(gaMov.Unidades) + ', ' +
            '''' + SQL_Str(gaMov.UnidadMedida) + ''', ' +
            SQL_FloatToStr(gaMov.UnidadesBase) + ', ' +
            '''' + SQL_Str(gaMov.UnidadMedidaBase) + ''', ' +
            SQL_FloatToStr(gaMov.FactorConversion) + ', ' +
            '''' + SQL_Str(gaMov.Comentario) + ''', ' +
            ''''', ' +
            '''' + SQL_GUID_ToStr(gaMov.IdProcesoIME) + ''',' +
            '''' + SQL_GUID_ToStr(gaMov.MovOrigen) + ''', ' +
            SQL_FloatToStr(gaMov.Precio) + ', ' +
            SQL_FloatToStr(gaMov.Precio * gaMov.Unidades) + ', ' +
            SQL_DateToStr(gaMov.FechaCaduca) + ', ' +
            '''T'', ' +
            '''' + SQL_GUID_ToStr(gaMov.MovPosicion) + ''', ' +
            '''' + SQL_Str(gaMov.CodigoTalla) + ''', ' +
            '''' + SQL_Str(gaMov.CodigoColor) + ''' ' +
            ')';

    if not bErr then try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on e: exception do begin
        bErr := bErr or true;
        sMsg := e.Message;
      end;
    end;

    sOperparams := '{"IdProcesoIME":"' + SQL_GUID_ToStr(gaMov.IdProcesoIME) + '","MantenerDatos":"1","MantenerErrores":"1","Módulos":"4","CodigoEmpresa":' + IntToStr(CodigoEmpresa.Stocks) + '}';
    sSQL := 'INSERT INTO ' +
            '  FS_Operations ( oper_CodigoEmpresa, oper_name, oper_product_code, oper_mac_address, oper_ip_address, ' +
            '  oper_datetime, oper_status, oper_params ) ' +
            'VALUES ( ' +
            IntToStr(CodigoEmpresa.Stocks) + ', ' +
            '''MOVIMIENTOSTOCK'', ' +
            '''E4E8'',' +
            '''' + SQL_Str(NETWORK_LocalMAC()) + ''', ' +
            '''' + SQL_Str(GetLocalIp()) + ''', ' +
            SQL_DateTimeToStr(Now()) + ', ' +
            '0, ' +
            '''' + SQL_Str(sOperparams) + ''' )';
    //gaLogFile.Write(sSQL, CONST_LOGID_BBDD, LOG_LEVEL_INFO );

    if not bErr then try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on e: exception do begin
        bErr := true;
        sMsg := e.Message;
      end;
    end;

  end;

  if dFechaCaduca=0 then
  begin
    sFechaCaduca := 'NULL';
  end else begin
    sFechaCaduca := SQL_DateToStr(dFechaCaduca);
  end;

  // GUARDEM EL DETALL DEL MOVIMENT A LA TAULA DE DETALL
  if (Unidades>0) or (UnidadesBase>0) then
  begin
    if MatriculaActual<>'' then
    begin
      sSQL :=
        'INSERT INTO FS_SGA_Picking_Pedido_Lineas_Detalle ( ' +
        '  PreparacionId, PickingId, Ejercicio, CodigoArticulo, Partida, UnidadMedida, FechaCaduca, CajaId, Matricula, Unidades, UnidadesBase, ' +
        '  CodigoAgrupacion, UnidadesAgrupacion, LineaPedidoAsignada, CodigoTalla01_, CodigoColor_ ) ' +
        'VALUES ( ' +
        IntToStr(IdPreparacion) + ', ' +
        IntToStr(PickingId) + ', ' +
        IntToStr(Ejercicio) + ',' +
        '''' + SQL_Str(CodigoArticulo) + ''', ' +
        '''' + SQL_Str(Partida) + ''', ' +
        '''' + SQL_Str(UnidadMedida) + ''', ' +
        sFechaCaduca + ', ' +
        IntToStr(CajaActual) + ', ' +
        '''' + SQL_Str(MatriculaActual) + ''', ' +
        SQL_FloatToStr(Unidades) + ', ' +
        SQL_FloatToStr(UnidadesBase) + ', ' +
        IntToStr(CodigoAgrupacion) + ', ' +
        SQL_FloatToStr(fUnidadesAgrupacion) + ', ' +
        '''' + SQL_GUID_ToStr(LineasPosicion) + ''', ' +
        '''' + SQL_Str(gaMov.CodigoTalla) + ''', ' +
        '''' + SQL_Str(gaMov.CodigoColor) + ''' ' +
        ')';

    end else begin
      sSQL :=
        'INSERT INTO FS_SGA_Picking_Pedido_Lineas_Detalle ( ' +
        '  PreparacionId, PickingId, Ejercicio, CodigoArticulo, Partida, UnidadMedida, FechaCaduca, CajaId, PaletId, Unidades, UnidadesBase ' +
        '  CodigoAgrupacion, UnidadesAgrupacion, LineaPedidoAsignada, CodigoTalla01_, CodigoColor_ ) ' +
        'VALUES ( ' +
        IntToStr(IdPreparacion) + ', ' +
        IntToStr(PickingId) + ', ' +
        IntToStr(Ejercicio) + ', ' +
        '''' + SQL_Str(CodigoArticulo) + ''', ' +
        '''' + SQL_Str(Partida) + ''', ' +
        '''' + SQL_Str(UnidadMedida) + ''', ' +
        sFechaCaduca + ', ' +
        IntToStr(CajaActual) + ', ' +
        IntToStr(PaletActual) + ', ' +
        SQL_FloatToStr(Unidades) + ', ' +
        SQL_FloatToStr(UnidadesBase) + ', ' +
        IntToStr(CodigoAgrupacion) + ', ' +
        SQL_FloatToStr(fUnidadesAgrupacion) + ', ' +
        '''' + SQL_GUID_ToStr(LineasPosicion) + ''', ' +
        '''' + SQL_Str(gaMov.CodigoTalla) + ''', ' +
        '''' + SQL_Str(gaMov.CodigoColor) + ''' ' +
        ')';
    end;
    try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E:Exception do
      begin
        gaLogFile.Write_DBException(E,sSQL,'Error al guardar del detalle de caja/palet', CONST_LOGID_BBDD);
      end;
    end;
  end else begin

    // RESTEM UNITATS AL DETALL
    fQtat := abs(Unidades);
    fQtatBase := abs(UnidadesBase);
    bFinal := FALSE;
    while not bFinal do
    begin

      sSQL := 'SELECT TOP 1 ' +
              '  AutoId, Unidades, UnidadesBase ' +
              'FROM FS_SGA_Picking_Pedido_Lineas_Detalle WITH (NOLOCK) ' +
              'WHERE ' +
              '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
              '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
              '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
              '  AND CodigoTalla01 = ''' + SQL_Str(gaMov.CodigoTalla) + ''' ' +
              '  AND CodigoColor_ = ''' + SQL_Str(gaMov.CodigoColor) + ''' ' +
              '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
              '  AND LineaPedidoAsignada = ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ' +
              '  AND Unidades > 0 ' +
              '  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion) + ' ';

      if sModoPackingList='AUTOMÁTICO' then
      begin
        // MODE AUTOMÀTIC
        if MatriculaActual<>'' then
        begin
          sSQL := sSQL +
            '  AND CajaId = ' + IntToStr(CajaActual) + ' ' +
            '  AND Matricula = ''' + SQL_Str(MatriculaActual) + ''' ';
        end else begin
          sSQL := sSQL +
            '  AND CajaId = ' + IntToStr(CajaActual) + ' ' +
            '  AND PaletId = ' + IntToStr(PaletActual) + ' ';
        end;
      end;

      sSQL := sSQL +
        'ORDER BY ' +
        '  AutoId DESC';

      Q := SQL_PrepareQuery ( Conn, sSQL );
      Q.Open;

      fQtatDetalle     := 0;
      fQtatDetalleBase := 0;
      if not Q.EOF then
      begin
        iAutoID          := Q.FieldByName('AutoId').AsInteger;
        fQtatDetalle     := Q.FieldByName('Unidades').AsFloat;
        fQtatDetalleBase := Q.FieldByName('UnidadesBase').AsFloat;
      end;

      Q.Close;
      FreeAndNil(Q);

      bFinal := (fQtatDetalle=0) and (fQtatDetalleBase=0);

      if not bFinal then
      begin

        if fQtatDetalle>fQtat then
        begin
          fQtatARestar := fQtat;
          fQtatARestarBase := fQtatBase;
        end else begin
          fQtatARestar := fQtatDetalle;
          fQtatARestarBase := fQtatDetalleBase;
        end;

        sSQL := 'UPDATE ' +
                '  FS_SGA_Picking_Pedido_Lineas_Detalle ' +
                'SET ' +
                '  Unidades = Unidades - ' + SQL_FloatToStr(fQtatARestar) + ', ' +
                '  UnidadesBase = UnidadesBase - ' + SQL_FloatToStr(fQtatARestarBase) + ' ' +
                'WHERE ' +
                '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
                '  AND AutoId = ' + IntToStr(iAutoID);
        SQL_Execute_NoRes ( Conn, sSQL );

        fQtat := fQtat - fQtatARestar;
        fQtatBase := fQtatBase - fQtatARestarBase;
        bFinal := (fQtat<=0)

      end;

    end;

  end;

  // GUARDAMOS EL PALET Y LA CAJA
  sSQL :=
    'UPDATE ' +
    '  FS_SGA_Picking_Preparaciones ' +
    'SET ' +
    '  PaletActual = ' + IntToStr(PaletActual) + ', ' +
    '  CajaActual = ' + IntToStr(CajaActual) + ', ' +
    '  MatriculaActual = ''' + SQL_Str(MatriculaActual) + ''' ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion);

  try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do
    begin
      gaLogFile.Write_DBException(E,sSQL,'No se ha podido actualizar el nº de palet y caja actuales de la preparación', CONST_LOGID_BBDD );
    end;
  end;

  sSQL := 'UPDATE FS_SGA_Picking_Pedido_Lineas ' +
          'SET ' +
          '  UdRetiradas = UdRetiradas + ' + SQL_FloatToStr(Unidades) + ', ' +
          '  UdRetiradasBase = UdRetiradasBase + ' + SQL_FloatToStr(UnidadesBase) + ' ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND CodigoArticulo=''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND Partida=''' + SQL_Str(PartidaPedido) + ''' ' +
          '  AND CodigoTalla01=''' + SQL_Str(CodigoTalla) + ''' ' +
          '  AND CodigoColor=''' + SQL_Str(CodigoColor) + ''' ' +
          '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
          '  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion) + ' ';
  if (LineasPosicion<>'') and (LineasPosicion<>'00000000-0000-0000-0000-000000000000') then
  begin
    sSQL := sSQL + 'AND LineasPosicion = ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ';
  end;

  if not bErr then try
    gaLogFile.Write ( 'Actualizar unidades retiradas', sIDCall  );
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  // ACTUALITZEM LES QUANTITATS A LA RUTA
  sSQL :=
    'UPDATE FS_SGA_PreparacionOrdenada ' +
    'SET ' +
    '  UdRetiradas = UdRetiradas + ' + SQL_FloatToStr(Unidades) + ', ' +
    '  UdRetiradasBase = UdRetiradasBase + ' + SQL_FloatToStr(UnidadesBase) + ' ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND CodigoArticulo=''' + SQL_Str(CodigoArticulo) + ''' ' +
    '  AND Partida=''' + SQL_Str(PartidaPedido) + ''' ' +
    '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
    '  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion);
  SQL_Execute_NoRes ( Conn, sSQL );

  if (not bErr) and (bRecalcularRuta) then begin

    gaLogFile.Write ( 'Recalculamos ruta', sIDCall );

    sSQL := 'SELECT ' +
            '  SUM(UdNecesarias) AS Necesarias, MIN(UdRetiradas) AS Retiradas ' +
            'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
            'WHERE ' +
            '  PreparacionId = ' + IntToStr(IdPreparacion) + ' AND ' +
            '  CodigoArticulo=''' + SQL_Str(CodigoArticulo) + ''' AND ' +
            '  Partida=''' + SQL_Str(PartidaPedido) + ''' AND ' +
            '  UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' AND ' +
            '  CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion);
    Q := SQL_PrepareQuery ( Conn, sSQL );

    if not bErr then try
      Q.Open;
    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message;
      end;
    end;

    if (not bErr) and (not Q.EOF) then begin
      iUnidadesNecesarias := Q.FieldByName('Necesarias').AsFloat;
      iUnidadesRetiradas := Q.FieldByName('Retiradas').AsFloat;
      gaLogFile.Write ( 'Unidades necesarias = ' + FloatToStr(iUnidadesNecesarias) + ', Unidades retiradas = ' + FloatToStr(iUnidadesRetiradas), sIDCall  );
    end else begin
      iUnidadesNecesarias := 0;
      iUnidadesRetiradas := 0;
    end;

    if iUnidadesNecesarias<=iUnidadesRetiradas then begin
      gaLogFile.Write ( 'Recalcular ruta = false', sIDCall  );
      bRecalcularRuta := FALSE;
    end;

    Q.Close;
    FreeAndNil(Q);

  end;

  if (not bErr) and (bRecalcularRuta) then try
    gaLogFile.Write ( 'Recalcular ruta', sIDCall  );
    bErr := not SGA_Check_PreparacionOrdenada (
      gsPath,
      Conn,
      CodigoEmpresa,
      CodigoUsuario,
      YY,
      IdPreparacion,
      aUbicacion.CodigoAlmacen,
      CodigoUbicacionExpedicion,
      sConsiderarReservas,
      sSoloReservas,
      sIgnorarPartidaSolicitada,
      sIgnorarUbicacionSolicitada,
      sMsg,
      TRUE,
      bIsBuilding
    );
    gaLogFile.Write ( 'Recalcular ruta OK', sIDCall  );
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  sSQL := 'DELETE FROM FS_SGA_Picking_Pedido_Lineas_Detalle ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' AND ' +
          '  Unidades=0 and UnidadesBase=0';
  if not bErr then try
    gaLogFile.Write ( 'Purgar líneas completadas', sIDCall  );
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if bErr then begin
    gaLogFile.Write ( 'ERROR: ' + sMsg, sIDCall  );
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(sMsg) + '","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  // Postprocesa UPDATE
  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_UpdateCantidadPreparacion_AFTER', sPROCCustom) then
  begin

    sSQL := 'EXEC dbo.[' + sPROCCustom + '] ' +
            IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
            IntToStr(IdPreparacion);
    try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E:Exception do
      begin
        gaLogFile.Write_DBException(E,sSQL,'Error al preprocesar la cantidad de preparación', CONST_LOGID_BBDD );
      end;
    end;
  end;

  
  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;
  LP.MovOrigen := sNewMovOrigen;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'PREPARE-PROD', 'Mover producto (' + gaMov.CodigoArticulo + ') a la zona de expedición', @LP );

  Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[]}';

  (*
  Request.QueryFields.AddPair('CodigoAlmacen', aUbicacion.CodigoAlmacen );
  contentfields.AddPair('CodigoAlmacen', aUbicacion.CodigoAlmacen );
  Request.QueryFields.AddPair('Partida', Partida );
  contentfields.AddPair('Partida', Partida );
  WebModule1preparacionUbicacionesAction ( Sender, Request, Response, Handled );
  *)

end;


procedure WebModule1updateDevolucionOldAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  DevolucionId: Integer;
  DevolucionIdLinea: Integer;
  sSQL: String;
  Data: String;
  Desglose: String;
  lJSonValue: TJSonValue;
  AutoId: Integer;
  Caja: string;
  Palet: string;
  Unidades: Double;
  bErr: Boolean;
  sMsg: string;
  Partida: string;
  CodigoAlmacen: String;
  CodigoUbicacion: String;
  CodigoAlmacenRechazos: String;
  CodigoUbicacionRechazos: String;
  FechaCaduca: String;
  dFechaCaduca: TDate;
  Verificacion: String;
  AnomaliaId: Integer;
  UnidadMedida1_: String;
  UnidadesEntrada: Double;
  CantidadErrorEntrada: Double;
  CantidadError: Double;
  TotalEntrada: Double;
  Total: Double;
  JSonPair: TJSONPair;
  YY, MM, DD: WORD;
  EmpresaOrigen: Integer;

  JSonObject: TJSONObject;
  JSonValue: TJSONValue;
  JSonArray: TJSONArray;
  contentfields: TStringList;
  Precio: Double;
  CodigoArticulo: String;
  GrupoTalla_: Integer;
  CodigoTalla01_: string;
  CodigoColor_: string;
  Ejercicio: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoArticulo := (contentfields.values['CodigoArticulo']);

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );
  if CodigoArticulo=''then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;

  DevolucionId := StrToIntDef(contentfields.values['DevolucionId'],0);
  if DevolucionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no especificado","Data":[]}';
    Exit;
  end;

  sSQL := 'SELECT Ejercicio FROM FS_SGA_Devoluciones WITH (NOLOCK) WHERE DevolucionId = ' + IntToStr(DevolucionId);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  DevolucionIdLinea := StrToIntDef(contentfields.values['DevolucionIdLinea'],0);
  if DevolucionIdLinea=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de línea de devolución no especificado","Data":[]}';
    Exit;
  end;

  if DevolucionIdLinea=-1 then begin

    CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);

    // Conversió al codi d'article real
    CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

    if CodigoUbicacion='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación no especificado","Data":[]}';
      Exit;
    end;

    CodigoUbicacionRechazos := (contentfields.values['CodigoUbicacionRechazos']);
    if CodigoUbicacionRechazos='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación de rechazos no especificado","Data":[]}';
      Exit;
    end;

    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacion );
    if CodigoAlmacen='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación incorrecto","Data":[]}';

      Exit;
    end;

    CodigoAlmacenRechazos := FS_SGA_CodigoAlmacen ( CodigoUbicacionRechazos );
    if CodigoAlmacen='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación de rechazos incorrecto","Data":[]}';
      Exit;
    end;

    Verificacion := AnsiUpperCase(Trim(contentfields.values['Verificacion']));
    if Verificacion='' then
      Verificacion := 'PENDIENTE';

    if (Verificacion<>'PENDIENTE') and (Verificacion<>'CORRECTA') and (Verificacion<>'INCIDENCIA') then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El tipo de verificación no es correcto","Data":[]}';
      Exit;
    end;

  end;

  Data := (contentfields.values['Data']);
  if Data='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se han especificado los datos","Data":[]}';
    Exit;
  end;

  JSonObject := _Parse_JSonObject ( Data );
  if JSonObject=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El formato JSON del elemento Data es incorrecto","Data":[]}';
    Exit;
  end;

  JSonValue  := JSonObject.Get('Desglose').JsonValue;
  if JSonValue=nil then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no son válidos","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  JSonArray := TJSONArray(JSonValue);
  if JSonArray=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no contienen un array válido","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Guardar les dades'}

  sMsg := '';
  bErr := FALSE;

  try
    // Conn.BeginTrans;
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  if DevolucionIdLinea<>-1 then begin

    sSQL := 'DELETE FROM FS_SGA_Devoluciones_Lineas_Detalle ' +
            'WHERE ' +
            '  DevolucionId = ' + IntToStr(DevolucionId) + ' AND ' +
            '  DevolucionIdLinea = ' + IntToStr(DevolucionIdLinea);
  end else begin

    sSQL := 'INSERT INTO ' +
            '  FS_SGA_Devoluciones_Lineas_Detalle ( DevolucionId, DevolucionIdLinea, CodigoAlmacen, ' +
            '  CodigoUbicacion, CodigoAlmacenRechazos, CodigoUbicacionRechazos, Caja, Palet, Partida, ' +
            '  FechaCaducidad, Verificacion, Precio, UnidadMedida1_, UnidadesEntrada, Unidades, ' +
            '  CantidadErrorEntrada, CantidadError, TotalEntrada, Total ) ' +
            'SELECT ' +
            '  DevolucionId, DevolucionIdLinea, ' +
            '''' + SQL_Str(CodigoAlmacen) + ''', ' +
            '''' + SQL_Str(CodigoUbicacion) + ''', ' +
            '''' + SQL_Str(CodigoAlmacenRechazos) + ''', ' +
            '''' + SQL_Str(CodigoUbicacionRechazos) + ''', ' +
            ''''', ' +
            ''''', Partida, NULL, ' +
            '''' + SQL_Str(Verificacion) + ''', Precio, UnidadMedida1_, ' +
            'UdPedidas - UdRecibidas, UdPedidas - UdRecibidas, 0, '+
            '0, UdPedidas - UdRecibidas, UdPedidas - UdRecibidas ' +
            'FROM FS_SGA_Devoluciones_Lineas WITH (NOLOCK) ' +
            'WHERE ' +
            '  UdPedidas > UdRecibidas AND ' +
            '  DevolucionId = ' + IntToStr(DevolucionId);

  end;

  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if (DevolucionIdLinea<>-1) and (not bErr) then begin

    for lJSonValue in JSonArray do begin

      CodigoUbicacion         := (_Get_JSonValue ( lJSonValue, 'CodigoUbicacion' ));

      // Conversió al codi d'article real
      CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

      CodigoAlmacen           := FS_SGA_CodigoAlmacen ( CodigoUbicacion );
      CodigoUbicacionRechazos := (_Get_JSonValue ( lJSonValue, 'CodigoUbicacionRechazos' ));
      CodigoAlmacenRechazos   := FS_SGA_CodigoAlmacen ( CodigoUbicacionRechazos );
      Caja                    := Trim(_Get_JSonValue ( lJSonValue, 'Caja' ));
      Palet                   := Trim(_Get_JSonValue ( lJSonValue, 'Palet' ));
      Partida                 := (_Get_JSonValue ( lJSonValue, 'Partida' ));
      FechaCaduca             := Trim(_Get_JSonValue ( lJSonValue, 'FechaCaduca' ));
      Verificacion            := AnsiUpperCase((_Get_JSonValue ( lJSonValue, 'Verificacion' )));
      AnomaliaId              := StrToIntDef(_Get_JSonValue ( lJSonValue, 'AnomaliaId' ),0);
      GrupoTalla_             := StrToIntDef(_Get_JSonValue ( lJSonValue, 'AnomaliaId' ),0);
      CodigoTalla01_          := (_Get_JSonValue ( lJSonValue, 'CodigoTalla' ));
      CodigoColor_            := (_Get_JSonValue ( lJSonValue, 'CodigoColor' ));
      UnidadMedida1_          := AnsiUpperCase(_Get_JSonValue ( lJSonValue, 'UnidadMedida' ));
      UnidadesEntrada         := FS_StrToFloatDef(_Get_JSonValue ( lJSonValue, 'UnidadesEntrada' ),0);
      Unidades                := FS_StrToFloatDef(_Get_JSonValue ( lJSonValue, 'Unidades' ),0);
      CantidadErrorEntrada    := FS_StrToFloatDef(_Get_JSonValue ( lJSonValue, 'CantidadErrorEntrada' ),0);
      CantidadError           := FS_StrToFloatDef(_Get_JSonValue ( lJSonValue, 'CantidadError' ),0);
      TotalEntrada            := FS_StrToFloatDef(_Get_JSonValue ( lJSonValue, 'TotalEntrada' ),0);
      Total                   := UnidadesEntrada + CantidadErrorEntrada;
      Precio                  := FS_StrToFloatDef(_Get_JSonValue ( lJSonValue, 'Precio' ),0);

      if Precio=0 then
      begin
        Precio :=
          ARTICULO_ConsultarPrecioStock (
            Conn,
            CodigoEmpresa,
            CodigoArticulo,
            Partida,
            CodigoTalla01_,
            CodigoColor_,
            CodigoAlmacen,
            GrupoTalla_
          );
      end;

      if FechaCaduca='' then begin
        dFechaCaduca := 0;
      end else begin
        YY := StrToInt ( Copy ( FechaCaduca, 7, 4 ) );
        MM := StrToInt ( Copy ( FechaCaduca, 4, 2 ) );
        DD := StrToInt ( Copy ( FechaCaduca, 1, 2 ) );
        dFechaCaduca := EncodeDate ( YY, MM, DD );
      end;

      sSQL := 'INSERT INTO FS_SGA_Devoluciones_Lineas_Detalle ( ' +
              '  DevolucionId, DevolucionIdLinea, Ejercicio, CodigoAlmacen, CodigoUbicacion, CodigoAlmacenRechazos, ' +
              '  CodigoUbicacionRechazos, Caja, Palet, Partida, FechaCaducidad, Verificacion, ' +
              '  AnomaliaId, UnidadMedida1_, UnidadesEntrada, Unidades, CantidadErrorEntrada, ' +
              '  CantidadError, TotalEntrada, Total ) ' +
              'VALUES ( ' +
              IntToStr(DevolucionId) + ', ' +
              IntToStr(DevolucionIdLinea) + ', ' +
              IntToStr(Ejercicio) + ', ' +
              '''' + SQL_Str(CodigoAlmacen) + ''', ' +
              '''' + SQL_Str(CodigoUbicacion) + ''', ' +
              '''' + SQL_Str(CodigoAlmacenRechazos) + ''', ' +
              '''' + SQL_Str(CodigoUbicacionRechazos) + ''', ' +
              '''' + SQL_Str(Caja) + ''', ' +
              '''' + SQL_Str(Palet) + ''', ' +
              '''' + SQL_Str(Partida) + ''', ' +
              SQL_DateToStr(dFechaCaduca) + ', ' +
              '''' + SQL_Str(Verificacion) + ''', ' +
              IntToStr(AnomaliaId) + ', ' +
              '''' + SQL_Str(UnidadMedida1_) + ''', ' +
              SQL_FloatToStr(UnidadesEntrada) + ', ' +
              SQL_FloatToStr(Unidades) + ', ' +
              SQL_FloatToStr(CantidadErrorEntrada) + ', ' +
              SQL_FloatToStr(CantidadError) + ', ' +
              SQL_FloatToStr(Total) + ', ' +
              SQL_FloatToStr(Total) + ')';

      if not bErr then try
        SQL_Execute_NoRes ( Conn, sSQL );
      except
        on E:Exception do begin
          bErr := TRUE;
          sMsg := E.Message;
        end;
      end;

    end;

  end;

  if not bErr then try
    // Conn.CommitTrans;
  except
    on E:Exception do begin
      // Conn.RollbackTrans;
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  JSonObject.Free;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Error":"' + JSON_Str(sMsg) + '"}';
  end else begin
    Result := '{"Result":"OK","Error":""}';
  end;

  {$ENDREGION}




end;

procedure WebModule1updateInventarioUbicacionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q, Q2: TADOQuery;
  EmpresaOrigen: Integer;
  InventarioId: Integer;
  sFechaCaduca: String;
  CodigoUbicacion: String;
  CodigoAlmacen: String;
  CodigoPasillo: String;
  CodigoEstanteria: String;
  Altura: String;
  Fondo: String;
  TipoUbicacion: String;
  Data, Articulos: String;
  Desglose: String;
  lJSonValue: TJSonValue;
  sMsg: String;
  bErr: Boolean;
  CodigoArticulo: String;
  Partida: String;
  UnidadMedida: String;
  UnidadesSaldo: Double;
  dFechaCaduca: TDate;
  FechaCaduca: String;
  CodigoUsuario: Integer;
  bAdded: Boolean;
  TipoUbicaciones: String;
  iNum: Integer;

  JSonObject: TJSONObject;
  JSonValue: TJSONValue;
  JSonArray: TJSONArray;
  contentfields: TStringList;
  CodigoAltenativo: string;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];
  
  InventarioId := StrToIntDef(contentfields.Values['InventarioId'], 0 );
  if InventarioId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de inventario no especificado","Data":[]}';
    Exit;
  end;

  sSQL := 'SELECT ' +
          '  Inventario_TipoUbicaciones ' +
          'FROM FS_SGA_Inventario WITH (NOLOCK) ' +
          'WHERE ' +
          '  Inventario_Id = ' + IntToStr(InventarioId);
  TipoUbicaciones := SQL_Execute ( Conn, sSQL );

  // Tipus d'ubicació (TODAS,PENDIENTES,VERIFICADAS)
  CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);

  // Conversió al codi d'article real
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de ubicación no especificado","Data":[]}';
    Exit;
  end;

  // Verifiquem que la ubicació pertany a l'inventari
  if TipoUbicaciones<>'LIBRE' then begin

    sSQL := 'SELECT ' +
            '  COUNT(*) ' +
            'FROM FS_SGA_Inventario_Detalle WITH (NOLOCK) ' +
            'WHERE ' +
            '  Inventario_Id = ' + IntToStr(InventarioId) + ' AND ' +
            '  CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + ''' ';
    iNum := SQL_Execute ( Conn, sSQL );
    if iNum=0 then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La ubicación no está incluida en este inventario","Data":[]}';
      Exit;
    end;

  end;

  // Verifiquem que la ubicació pertany al magatzem
  FS_SGA_UBICACION_Desglosar ( Conn, CodigoEmpresa, CodigoUbicacion, CodigoAlmacen, CodigoPasillo, CodigoEstanteria, Altura, Fondo, CodigoAltenativo );
  sSQL := 'SELECT ' +
          '  Inventario_CodigoAlmacen ' +
          'FROM FS_SGA_Inventario WITH (NOLOCK) ' +
          'WHERE ' +
          '  Inventario_Id = ' + IntToStr(InventarioId);
  if CodigoAlmacen<>SQL_Execute(Conn,sSQL) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La ubicación del almacén no está incluida en este inventario","Data":[]}';
    Exit;
  end;

  Data := (contentfields.values['Data']);
  if Data='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se han especificado los datos","Data":[]}';

    Exit;
  end;

  JSonObject := _Parse_JSonObject ( Data );
  if JSonObject=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El formato JSON del elemento Data es incorrecto","Data":[]}';
    Exit;
  end;

  JSonValue := JSonObject.Get('Articulos').JsonValue;
  if JSonValue=nil then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no son válidos","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  JSonArray := TJSONArray(JSonValue);
  if JSonArray=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no contienen un array válido","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Guardar les dades'}

  sMsg := '';
  bErr := FALSE;

  try
    // Conn.BeginTrans;
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  bAdded := FALSE;

  sSQL := 'DELETE FROM FS_SGA_Inventario_Detalle ' +
          'WHERE ' +
          '  Inventario_Id = ' + IntToStr(InventarioId) + ' AND ' +
          '  CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + '''';
  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if not bErr then begin

    for lJSonValue in JSonArray do begin

      CodigoArticulo := (_Get_JSonValue ( lJSonValue, 'CodigoArticulo' ) );
      Partida        := (_Get_JSonValue ( lJSonValue, 'Partida' ) );
      UnidadMedida   := AnsiUpperCase(_Get_JSonValue ( lJSonValue, 'UnidadMedida' ) );
      UnidadesSaldo  := FS_StrToFloatDef (_Get_JSonValue ( lJSonValue, 'UnidadesSaldo' ), 0 );
      sFechaCaduca   := _Get_JSonValue ( lJSonValue, 'FechaCaduca' );
      dFechaCaduca   := StrToDateDef ( Trim ( sFechaCaduca ), 0 );

      // Conversió al codi d'article real
      CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );

      if dFechaCaduca<>0 then begin
        FechaCaduca := SQL_DateToStr ( dFechaCaduca );
      end else begin
        FechaCaduca := 'NULL';
      end;

      if UnidadesSaldo>0 then begin

        bAdded := TRUE;

        sSQL := 'INSERT INTO FS_SGA_Inventario_Detalle ( ' +
                '  CodigoEmpresa, Inventario_Id, CodigoUbicacion, CodigoArticulo, ' +
                '  Partida, UnidadMedida, UnidadesSaldo, FechaCaduca, Verificada, UsuarioId, ' +
                '  FechaHoraValidacion ) ' +
                'VALUES ( ' +
                IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
                IntToStr(InventarioId) + ', ' +
                '''' + SQL_Str(CodigoUbicacion) + ''', ' +
                '''' + SQL_Str(CodigoArticulo) + ''', ' +
                '''' + SQL_Str(Partida) + ''', ' +
                '''' + SQL_Str(UnidadMedida) + ''', ' +
                SQL_FloatToStr(UnidadesSaldo) + ', ' +
                FechaCaduca + ', ' +
                '1, ' +
                IntToStr(CodigoUsuario) + ', ' +
                SQL_DateTimeToStr(Now()) + ' )';
        if not bErr then try
          SQL_Execute_NoRes ( Conn, sSQL );
        except
          on E:Exception do begin
            bErr := TRUE;
            sMsg := E.Message;
          end;
        end;

      end;

    end;

    if not bAdded then begin

      sSQL := 'INSERT INTO FS_SGA_Inventario_Detalle ( ' +
                '  CodigoEmpresa, Inventario_Id, CodigoUbicacion, CodigoArticulo, ' +
                '  Partida, UnidadMedida, UnidadesSaldo, FechaCaduca, Verificada, UsuarioId, ' +
                '  FechaHoraValidacion ) ' +
                'VALUES ( ' +
                IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
                IntToStr(InventarioId) + ', ' +
                '''' + SQL_Str(CodigoUbicacion) + ''', ' +
                ''''', ' +
                ''''', ' +
                ''''', ' +
                '0, ' +
                'NULL, ' +
                '1, ' +
                IntToStr(CodigoUsuario) + ', ' +
                SQL_DateTimeToStr(Now()) + ' )';
        if not bErr then try
          SQL_Execute_NoRes ( Conn, sSQL );
        except
          on E:Exception do begin
            bErr := TRUE;
            sMsg := E.Message;
          end;
        end;

    end;

  end;

  if not bErr then try
    // Conn.CommitTrans;
  except
    on E:Exception do begin
      // Conn.RollbackTrans;
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Error":"' + JSON_Str(sMsg) + '"}';
  end else begin
    Result := '{"Result":"OK","Error":""}';
  end;

  LP := LOG_Clear();
  LP.IdInventario := InventarioId;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-INV-UBI', 'Actualizar ubicación ' + CodigoUbicacion + ' del inventario', @LP );
  
  {$ENDREGION}

  JSonObject.Free;



end;


procedure WebModule1updateRecepcionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  RecepcionId: Integer;
  RecepcionIdLinea: Integer;
  sSQL: String;
  Data:Utf8String;
  Desglose: String;
  AutoId: Integer;
  Caja: Integer;
  Palet: Integer;
  Unidades: Double;
  bErr: Boolean;
  sMsg: string;
  Partida: string;
  CodigoAlmacen: String;
  CodigoUbicacion: String;
  CodigoAlmacenRechazos: String;
  CodigoUbicacionRechazos: String;
  FechaCaduca: String;
  dFechaCaduca: TDate;
  Verificacion: String;
  AnomaliaId: Integer;
  UnidadMedida1_: String;
  UnidadesEntrada: Double;
  CantidadErrorEntrada: Double;
  CantidadError: Double;
  TotalEntrada: Double;
  Total: Double;
  JSonPair: TJSONPair;
  YY, MM, DD: WORD;
  EmpresaOrigen: Integer;
  JSonObject: TJSONObject;
  JSonValueD: TJSONValue;
  JSonArrayD: TJSONArray;
  JSonValueS: TJSONValue;
  JSonArrayS: TJSONArray;
  JSonValueSR: TJSONValue;
  JSonArraySR: TJSONArray;
  lJSonValue: TJSonValue;
  Precio: Double;
  contentfields: TStringList;
  CodigoArticulo: string;
  UnidadesEntradaBase: Double;
  FactorConversion: Double;
  UnidadMedida: string;
  UnidadMedidaBase: string;
  UnidadesRechazo: Double;
  UnidadesRechazoBase: Double;
  FactorConversionRechazo: Double;
  CodigoAgrupacion: Integer;
  UnidadesAgrupacion: Double;
  UnidadMedidaRechazo: string;
  UnidadMedidaBaseRechazo: string;
  CodigoAgrupacionRechazo: Integer;
  UnidadesAgrupacionRechazo: Double;
  IsNew: Boolean;
  RecepcionIdLineaDetalle: Integer;
  aIdURI: TIdURI;
  GrupoTalla: Integer;
  CodigoTalla: String;
  CodigoColor: String;
  Matricula: String;
  MatriculaRechazos: String;
  LEncoding: IIdTextEncoding;
  CodigoUsuario: Integer;
  UUID: string;
  Ejercicio: Integer;
  NumeroSerie: String;
  NumeroSerieFabricante: String;
  CantidadSerie: Integer;

{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario  := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID           := contentfields.values['UUID'];
  CodigoArticulo := (contentfields.values['CodigoArticulo']);

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );
  if CodigoArticulo=''then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;

  RecepcionId := StrToIntDef(contentfields.values['IdRecepcion'],0);
  if RecepcionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de recepción no especificado","Data":[]}';
    Exit;
  end;

  sSQL := 'SELECT Ejercicio FROM FS_SGA_Recepciones WITH (NOLOCK) WHERE RecepcionId = ' + IntToStr(RecepcionId);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  RecepcionIdLinea := StrToIntDef(contentfields.values['RecepcionIdLinea'],0);
  if RecepcionIdLinea=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de línea de recepción no especificado","Data":[]}';
    Exit;
  end;

  RecepcionIdLineaDetalle := StrToIntDef(contentfields.Values['RecepcionIdLineaDetalle'],-1);

  CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación no especificado","Data":[]}';
    Exit;
  end;

  CodigoUbicacionRechazos := (contentfields.values['CodigoUbicacionRechazos']);
  CodigoUbicacionRechazos := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacionRechazos );
  if CodigoUbicacionRechazos='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación de rechazos no especificado","Data":[]}';
    Exit;
  end;

  GrupoTalla  := StrToIntDef(contentfields.values['GrupoTalla'],0);
  CodigoTalla := contentfields.values['CodigoTalla'];
  CodigoColor := contentfields.values['CodigoColor'];

  Matricula         := (contentfields.Values['Matricula']);
  MatriculaRechazos := (contentfields.values['MatriculaRechazos']);
  (*
  if RecepcionIdLinea=-1 then begin

    CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);

    // Conversió al codi d'article real
    CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

    if CodigoUbicacion='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación no especificado","Data":[]}';
      Exit;
    end;

    CodigoUbicacionRechazos := (contentfields.values['CodigoUbicacionRechazos']);
    if CodigoUbicacionRechazos='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación de rechazos no especificado","Data":[]}';
      Exit;
    end;

    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacion );
    if CodigoAlmacen='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación incorrecto","Data":[]}';
      Exit;
    end;

    CodigoAlmacenRechazos   := FS_SGA_CodigoAlmacen ( CodigoUbicacionRechazos );
    if CodigoAlmacen='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación de rechazos incorrecto","Data":[]}';
      Exit;
    end;

    Verificacion := AnsiUpperCase((contentfields.values['Verificacion']));
    if Verificacion='' then
      Verificacion := 'PENDIENTE';

    if (Verificacion<>'PENDIENTE') and (Verificacion<>'CORRECTA') and (Verificacion<>'INCIDENCIA') then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El tipo de verificación no es correcto","Data":[]}';
      Exit;
    end;

  end;
  *)

  Data := (contentfields.values['Data']);
  if Data='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se han especificado los datos","Data":[]}';
    Exit;
  end;

  JSonObject := _Parse_JSonObject ( Data );
  if JSonObject=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El formato JSON del elemento Data es incorrecto","Data":[]}';
    Exit;
  end;

  JSonValueD  := JSonObject.Get('Desglose').JsonValue;
  if JSonValueD=nil then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no son válidos","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  JSonValueS  := JSonObject.Get('NumerosSerie').JsonValue;
  if JSonValueS=nil then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados de números de serie no son válidos","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  JSonValueSR := JSonObject.Get('NumerosSerieRechazos').JsonValue;
  if JSonValueSR=nil then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados números de serie de rechazo no son válidos","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  JSonArrayD := TJSONArray(JSonValueD);
  if JSonArrayD=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no contienen un array válido","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  JSonArrayS := TJSONArray(JSonValueS);
  if JSonArrayS=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no contienen un array de numeros de serie válido","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  JSonArraySR := TJSONArray(JSonValueSR);
  if JSonArraySR=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no contienen un array de numeros de serie de rechazos válido","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Guardar les dades'}

  sMsg := '';
  bErr := FALSE;

  try
    // Conn.BeginTrans;
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  if CodigoUbicacion='' then
  begin
    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionRecepcion, CodigoUbicacion, CodigoEmpresa.EmpresaOrigen );
  end;

  if CodigoUbicacionRechazos='' then
  begin
    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionRecepcionRechazos, CodigoUbicacionRechazos, CodigoEmpresa.EmpresaOrigen );
  end;

  CodigoUbicacion         := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
  CodigoAlmacen           := FS_SGA_CodigoAlmacen ( CodigoUbicacion );

  CodigoUbicacionRechazos := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacionRechazos );
  CodigoAlmacenRechazos   := FS_SGA_CodigoAlmacen ( CodigoUbicacionRechazos );

  {if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;}

  if (not bErr) then begin

    gaLogFile.Write(JSonArrayD.ToString);
    gaLogFile.Write(JSonArrayS.ToString);
    gaLogFile.Write(JSonArraySR.ToString);

    // Conversió al codi d'article real
    Caja                      := StrToIntDef(_Get_JSonValue ( JSonArrayD, 'Caja' ),1);
    Palet                     := StrToIntDef(_Get_JSonValue ( JSonArrayD, 'Palet' ),1);
    Partida                   := (_Get_JSonValue ( JSonArrayD, 'Partida' ));
    FechaCaduca               := Trim(_Get_JSonValue ( JSonArrayD, 'FechaCaduca' ));
    Verificacion              := AnsiUpperCase((_Get_JSonValue ( JSonArrayD, 'Verificacion' )));
    AnomaliaId                := StrToIntDef(_Get_JSonValue ( JSonArrayD, 'AnomaliaId' ),0);
    UnidadMedida              := AnsiUpperCase(_Get_JSonValue ( JSonArrayD, 'UnidadMedida' ));
    UnidadMedidaBase          := AnsiUpperCase(_Get_JSonValue ( JSonArrayD, 'UnidadMedidaBase' ));
    UnidadesEntrada           := FS_StrToFloatDef(_Get_JSonValue ( JSonArrayD, 'UnidadesEntrada' ),0);
    UnidadesEntradaBase       := FS_StrToFloatDef(_Get_JSonValue ( JSonArrayD, 'UnidadesEntradaBase' ),0);
    FactorConversion          := FS_StrToFloatDef(_Get_JSonValue ( JSonArrayD, 'FactorConversion' ),0);
    CodigoAgrupacion          := StrToIntDef(_Get_JSonValue ( JSonArrayD, 'CodigoAgrupacion' ),1);
    UnidadesAgrupacion        := FS_StrToFloatDef(_Get_JSonValue ( JSonArrayD, 'UnidadesAgrupacion' ),0);
    UnidadMedidaRechazo       := AnsiUpperCase(_Get_JSonValue ( JSonArrayD, 'UnidadMedidaRechazo' ));
    UnidadMedidaBaseRechazo   := AnsiUpperCase(_Get_JSonValue ( JSonArrayD, 'UnidadMedidaBaseRechazo' ));
    UnidadesRechazo           := FS_StrToFloatDef(_Get_JSonValue ( JSonArrayD, 'UnidadesRechazo' ),0);
    UnidadesRechazoBase       := FS_StrToFloatDef(_Get_JSonValue ( JSonArrayD, 'UnidadesRechazoBase' ),0);
    FactorConversionRechazo   := FS_StrToFloatDef(_Get_JSonValue ( JSonArrayD, 'FactorConversionRechazo' ),0);
    CodigoAgrupacionRechazo   := StrToIntDef(_Get_JSonValue ( JSonArrayD, 'CodigoAgrupacionRechazo' ),1);
    UnidadesAgrupacionRechazo := FS_StrToFloatDef(_Get_JSonValue ( JSonArrayD, 'UnidadesAgrupacionRechazo' ),0);
    Precio                    := FS_StrToFloatDef(_Get_JSonValue ( JSonArrayD, 'Precio' ),0);

    if FechaCaduca='' then begin
      dFechaCaduca := 0;
    end else begin
      YY := StrToInt ( Copy ( FechaCaduca, 7, 4 ) );
      MM := StrToInt ( Copy ( FechaCaduca, 4, 2 ) );
      DD := StrToInt ( Copy ( FechaCaduca, 1, 2 ) );
      dFechaCaduca := EncodeDate ( YY, MM, DD );
    end;

  end;

  if (RecepcionIdLinea<>-1) and (RecepcionIdLineaDetalle<>-1) then begin

    sSQL :=
      'UPDATE FS_SGA_Recepciones_Lineas_Detalle ' +
      'SET ' +
      '  CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''', ' +
      '  CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + ''', ' +
      '  Matricula = ''' + SQL_Str(Matricula) + ''', ' +
      '  CodigoAlmacenRechazos = ''' + SQL_Str(CodigoAlmacenRechazos) + ''', ' +
      '  CodigoUbicacionRechazos = ''' + SQL_Str(CodigoUbicacionRechazos) + ''', ' +
      '  MatriculaRechazos = ''' + SQL_Str(MatriculaRechazos) + ''', ' +
      '  Caja = ' + IntToStr(Caja) + ', ' +
      '  Palet = ' + IntToStr(Palet) + ', ' +
      '  Partida = ''' + SQL_Str(Partida) + ''', ' +
      '  FechaCaducidad = ' + SQL_DateToStr(dFechaCaduca) + ', ' +
      '  Verificacion = ''' + SQL_Str(Verificacion) + ''', ' +
      '  AnomaliaId = ' + IntToStr(AnomaliaId) + ', ' +
      '  Precio = ' + SQL_FloatToStr(Precio) + ', ' +
      '  UnidadMedida1_ = ''' + SQL_Str(UnidadMedida) + ''', ' +
      '  UnidadesEntrada = ' + SQL_FloatToStr(UnidadesEntrada * UnidadesAgrupacion) + ', ' +
      '  CantidadErrorEntrada = ' + SQL_FloatToStr(UnidadesRechazo * UnidadesAgrupacionRechazo) + ', ' +
      '  FechaRegistro = ' + SQL_DateTimeToStr(Now()) + ', ' +
      '  UnidadMedidaBase = ''' + SQL_Str(UnidadMedidaBase) + ''', ' +
      '  UnidadesEntradaBase = ' + SQL_FloatToStr(UnidadesEntradaBase) + ', ' +
      '  UnidadesErrorBase = ' + SQL_FloatToStr(UnidadesRechazoBase) + ', ' +
      '  CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion) + ', ' +
      '  UnidadesAgrupacion = ' + SQL_FloatToStr(UnidadesAgrupacion) + ', ' +
      '  CodigoAgrupacionRechazos = ' + IntToStr(CodigoAgrupacionRechazo) + ', ' +
      '  UnidadesAgrupacionRechazos = ' + SQL_FloatToStr(UnidadesAgrupacionRechazo) + ', ' +
      '  FactorConversion = ' + SQL_FloatToStr(FactorConversion) + ', ' +
      '  FactorConversionRechazos = ' + SQL_FloatToStr(FactorConversionRechazo) + ' ' +
      'WHERE ' +
      '  RecepcionId = ' + IntToStr(RecepcionId) + ' ' +
      '  AND RecepcionIdLinea = ' + IntToStr(RecepcionIdLinea) + ' ' +
      '  AND RecepcionIdLineaDetalle = ' + IntToStr(RecepcionIdLineaDetalle) + ' ';

  end else begin

    sSQL :=
      'INSERT INTO FS_SGA_Recepciones_Lineas_Detalle ( ' +
      '  RecepcionId, RecepcionIdLinea, Ejercicio, CodigoAlmacen, CodigoUbicacion, CodigoAlmacenRechazos, ' +
      '  CodigoUbicacionRechazos, Matricula, MatriculaRechazos, Caja, Palet, Partida, FechaCaducidad, Verificacion, AnomaliaId, ' +
      '  Precio, UnidadMedida1_, UnidadesEntrada, CantidadErrorEntrada, FechaRegistro, UnidadMedidaBase, ' +
      '  UnidadesEntradaBase, UnidadesErrorBase, CodigoAgrupacion, UnidadesAgrupacion, ' +
      '  CodigoAgrupacionRechazos,  UnidadesAgrupacionRechazos, FactorConversion, FactorConversionRechazos, ' +
      '  Unidades, CantidadError, TotalEntrada, Total, TotalEntradaBase, GrupoTalla_, CodigoTalla01_, CodigoColor_ ) ' +
      'VALUES ( ' +
      IntToStr(RecepcionId) + ', ' +
      IntToStr(RecepcionIdLinea) + ', ' +
      IntToStr(Ejercicio) + ', ' +
      '''' + SQL_Str(CodigoAlmacen) + ''', ' +
      '''' + SQL_Str(CodigoUbicacion) + ''', ' +
      '''' + SQL_Str(CodigoAlmacenRechazos) + ''', ' +
      '''' + SQL_Str(CodigoUbicacionRechazos) + ''', ' +
      '''' + SQL_Str(Matricula) + ''', ' +
      '''' + SQL_Str(MatriculaRechazos) + ''', ' +
      IntToStr(Caja) + ', ' +
      IntToStr(Palet) + ', ' +
      '''' + SQL_Str(Partida) + ''', ' +
      SQL_DateToStr(dFechaCaduca) + ', ' +
      '''' + SQL_Str(Verificacion) + ''', ' +
      IntToStr(AnomaliaId) + ', ' +
      SQL_FloatToStr(Precio) + ', ' +
      '''' + SQL_Str(UnidadMedida) + ''', ' +
      SQL_FloatToStr(UnidadesEntrada * UnidadesAgrupacion) + ', ' +
      SQL_FloatToStr(UnidadesRechazo * UnidadesAgrupacionRechazo) + ', ' +
      SQL_DateTimeToStr(Now()) + ', ' +
      '''' + SQL_Str(UnidadMedidaBase) + ''', ' +
      SQL_FloatToStr(UnidadesEntradaBase) + ', ' +
      SQL_FloatToStr(UnidadesRechazoBase) + ', ' +
      IntToStr(CodigoAgrupacion) + ', ' +
      SQL_FloatToStr(UnidadesAgrupacion) + ', ' +
      IntToStr(CodigoAgrupacionRechazo) + ', ' +
      SQL_FloatToStr(UnidadesAgrupacionRechazo) + ', ' +
      SQL_FloatToStr(FactorConversion) + ', ' +
      SQL_FloatToStr(FactorConversionRechazo) + ', ' +
      SQL_FloatToStr(UnidadesEntrada) + ', ' +
      SQL_FloatToStr(UnidadesRechazo) + ', ' +
      SQL_FloatToStr(UnidadesEntrada+UnidadesRechazo) + ', ' +
      SQL_FloatToStr(UnidadesEntrada+UnidadesRechazo) + ', ' +
      SQL_FloatToStr(UnidadesEntradaBase+UnidadesRechazoBase) + ', ' +
      IntToStr(GrupoTalla) + ', ' +
      '''' + SQL_Str(CodigoTalla) + ''', ' +
      '''' + SQL_Str(CodigoColor) + ''' ' +
      ')';

  end;

  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
    if RecepcionIdLineaDetalle=-1 then
    begin
      RecepcionIdLineaDetalle := SQL_Execute ( Conn, 'SELECT SCOPE_IDENTITY()' );
    end;

  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  sSQL :=
    'DELETE FROM FS_SGA_Recepciones_Lineas_Detalle_NumerosSerie ' +
    'WHERE ' +
      '  RecepcionId = ' + IntToStr(RecepcionId) + ' ' +
      '  AND RecepcionIdLinea = ' + IntToStr(RecepcionIdLinea) + ' ' +
      '  AND RecepcionIdLineaDetalle = ' + IntToStr(RecepcionIdLineaDetalle);
  SQL_Execute_NoRes ( Conn, sSQL );

  // Afegim els números de sèrie
  for lJSonValue in JSonArrayS do begin

    NumeroSerie           := _Get_JSonValue ( lJSonValue, 'NumeroSerie' );
    NumeroSerieFabricante := _Get_JSonValue ( lJSonValue, 'NumeroSerieFabricante' );
    CantidadSerie         := StrToIntDef(_Get_JSonValue ( lJSonValue, 'Cantidad' ),1);

    sSQL :=
      'INSERT INTO FS_SGA_Recepciones_Lineas_Detalle_NumerosSerie ( CodigoEmpresa, RecepcionId, RecepcionIdLinea, ' +
      '  RecepcionIdLineaDetalle, Tipo, NumeroSerie, NumeroSerieFabricante, Cantidad ) ' +
      'VALUES ( ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(RecepcionId) + ', ' +
      IntToStr(RecepcionIdLinea) + ', ' +
      IntToStr(RecepcionIdLineaDetalle) + ', ' +
      '0, ' +
      '''' + SQL_Str(NumeroSerie) + ''', ' +
      '''' + SQL_Str(NumeroSerieFabricante) + ''', ' +
      IntToStr(CantidadSerie) + ' ' +
      ') ';

    SQL_Execute_NoRes ( Conn, sSQL );

  end;

  // Afegim els números de sèrie de rebuig
  for lJSonValue in JSonArraySR do begin

    NumeroSerie           := _Get_JSonValue ( lJSonValue, 'NumeroSerie' );
    NumeroSerieFabricante := _Get_JSonValue ( lJSonValue, 'NumeroSerieFabricante' );
    CantidadSerie         := StrToIntDef(_Get_JSonValue ( lJSonValue, 'Cantidad' ),1);

    sSQL :=
      'INSERT INTO FS_SGA_Recepciones_Lineas_Detalle_NumerosSerie ( CodigoEmpresa, RecepcionId, RecepcionIdLinea, ' +
      '  RecepcionIdLineaDetalle, Tipo, NumeroSerie, NumeroSerieFabricante, Cantidad ) ' +
      'VALUES ( ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(RecepcionId) + ', ' +
      IntToStr(RecepcionIdLinea) + ', ' +
      IntToStr(RecepcionIdLineaDetalle) + ', ' +
      '1, ' +
      '''' + SQL_Str(NumeroSerie) + ''', ' +
      '''' + SQL_Str(NumeroSerieFabricante) + ''', ' +
      IntToStr(CantidadSerie) + ' ' +
      ') ';

    SQL_Execute_NoRes ( Conn, sSQL );

  end;

  sSQL :=
    'UPDATE FS_SGA_Recepciones_Lineas_Detalle ' +
    'SET ' +
    '  TotalEntrada = UnidadesEntrada + CantidadErrorEntrada, ' +
    '  TotalEntradaBase = UnidadesEntradaBase + UnidadesErrorBase ' +
    'WHERE ' +
    '  RecepcionId = ' + IntToStr(RecepcionId) + ' AND ' +
    '  RecepcionIdLinea = ' + IntToStr(RecepcionIdLinea) + ' AND ' +
    '  RecepcionIdLineaDetalle = ' + IntToStr(RecepcionIdLineaDetalle);

  if not bErr then
  try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Error":"' + JSON_Str(sMsg) + '"}';
  end else begin
    Result := '{"Result":"OK","Error":""}';
  end;

  LP := LOG_Clear();
  LP.IdRecepcion := RecepcionId;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-REC', 'Actualiza recepción en la ubicación ' + CodigoUbicacion, @LP );
  
  {$ENDREGION}

  JSonObject.Free;

end;


procedure WebModule1updateDevolucionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  DevolucionId: Integer;
  DevolucionIdLinea: Integer;
  sSQL: String;
  Data:Utf8String;
  Desglose: String;
  AutoId: Integer;
  Caja: Integer;
  Palet: Integer;
  Unidades: Double;
  bErr: Boolean;
  sMsg: string;
  Partida: string;
  CodigoAlmacen: String;
  CodigoUbicacion: String;
  CodigoAlmacenRechazos: String;
  CodigoUbicacionRechazos: String;
  FechaCaduca: String;
  dFechaCaduca: TDate;
  Verificacion: String;
  AnomaliaId: Integer;
  UnidadMedida1_: String;
  UnidadesEntrada: Double;
  CantidadErrorEntrada: Double;
  CantidadError: Double;
  TotalEntrada: Double;
  Total: Double;
  JSonPair: TJSONPair;
  YY, MM, DD: WORD;
  EmpresaOrigen: Integer;
  JSonObject: TJSONObject;
  JSonValue: TJSONValue;
  JSonArray: TJSONArray;
  lJSonValue: TJSonValue;
  Precio: Double;
  contentfields: TStringList;
  CodigoArticulo: string;
  UnidadesEntradaBase: Double;
  FactorConversion: Double;
  UnidadMedida: string;
  UnidadMedidaBase: string;
  UnidadesRechazo: Double;
  UnidadesRechazoBase: Double;
  FactorConversionRechazo: Double;
  CodigoAgrupacion: Integer;
  UnidadesAgrupacion: Double;
  UnidadMedidaRechazo: string;
  UnidadMedidaBaseRechazo: string;
  CodigoAgrupacionRechazo: Integer;
  UnidadesAgrupacionRechazo: Double;
  IsNew: Boolean;
  DevolucionIdLineaDetalle: Integer;
  CodigoTalla: String;
  CodigoColor: String;
  GrupoTalla: Integer;
  Q: TADOQuery;
  Matricula: String;
  MatriculaRechazos: String;
  CodigoUsuario: Integer;
  UUID: string;
  Ejercicio: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario  := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID           := contentfields.values['UUID'];
  CodigoArticulo := (contentfields.values['CodigoArticulo']);
  
  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );
  if CodigoArticulo=''then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;

  DevolucionId := StrToIntDef(contentfields.values['IdDevolucion'],0);
  if DevolucionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no especificado","Data":[]}';
    Exit;
  end;

  sSQL := 'SELECT Ejercicio FROM FS_SGA_Devoluciones WITH (NOLOCK) WHERE DevolucionId = ' + IntToStr(DevolucionId);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  DevolucionIdLinea := StrToIntDef(contentfields.values['DevolucionIdLinea'],0);
  if DevolucionIdLinea=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de línea de devolución no especificado","Data":[]}';
    Exit;
  end;

  DevolucionIdLineaDetalle := StrToIntDef(contentfields.Values['DevolucionIdLineaDetalle'],-1);

  CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación no especificado","Data":[]}';
    Exit;
  end;

  CodigoUbicacionRechazos := (contentfields.values['CodigoUbicacionRechazos']);
  CodigoUbicacionRechazos := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacionRechazos );
  if CodigoUbicacionRechazos='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación de rechazos no especificado","Data":[]}';
    Exit;
  end;

  sSQL :=
    'SELECT art.GrupoTalla_, fsdl.CodigoTalla01_, fsdl.CodigoColor_ ' +
    'FROM FS_SGA_Devoluciones_Lineas fsdl WITH (NOLOCK) ' +
    'INNER JOIN Articulos art WITH (NOLOCK) ' +
    'ON ' +
    '  art.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
    '  AND art.CodigoArticulo = fsdl.CodigoArticulo ' +
    'WHERE ' +
    '  fsdl.DevolucionId = ' + IntToStr(DevolucionId) + ' ' +
    '  AND fsdl.DevolucionIdLinea = ' + IntToStr(DevolucionIdLinea);
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if not Q.Eof then
  begin
    GrupoTalla  := Q.FieldByName('GrupoTalla_').AsInteger;
    CodigoTalla := Q.FieldByName('CodigoTalla01_').AsString;
    CodigoColor := Q.FieldByName('CodigoColor_').AsString;
  end else begin
    GrupoTalla  := 0;
    CodigoTalla := '';
    CodigoColor := '';
  end;

  Q.Close;
  FreeAndNil(Q);

  (*
  if RecepcionIdLinea=-1 then begin

    CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);

    // Conversió al codi d'article real
    CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

    if CodigoUbicacion='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación no especificado","Data":[]}';
      Exit;
    end;

    CodigoUbicacionRechazos := (contentfields.values['CodigoUbicacionRechazos']);
    if CodigoUbicacionRechazos='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación de rechazos no especificado","Data":[]}';
      Exit;
    end;

    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacion );
    if CodigoAlmacen='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación incorrecto","Data":[]}';
      Exit;
    end;

    CodigoAlmacenRechazos   := FS_SGA_CodigoAlmacen ( CodigoUbicacionRechazos );
    if CodigoAlmacen='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación de rechazos incorrecto","Data":[]}';
      Exit;
    end;

    Verificacion := AnsiUpperCase((contentfields.values['Verificacion']));
    if Verificacion='' then
      Verificacion := 'PENDIENTE';

    if (Verificacion<>'PENDIENTE') and (Verificacion<>'CORRECTA') and (Verificacion<>'INCIDENCIA') then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El tipo de verificación no es correcto","Data":[]}';
      Exit;
    end;

  end;
  *)

  Data := (contentfields.values['Data']);
  if Data='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se han especificado los datos","Data":[]}';
    Exit;
  end;

  JSonObject := _Parse_JSonObject ( Data );
  if JSonObject=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El formato JSON del elemento Data es incorrecto","Data":[]}';
    Exit;
  end;

  JSonValue  := JSonObject.Get('Desglose').JsonValue;
  if JSonValue=nil then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no son válidos","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  JSonArray := TJSONArray(JSonValue);
  if JSonArray=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no contienen un array válido","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Guardar les dades'}

  sMsg := '';
  bErr := FALSE;

  try
    // Conn.BeginTrans;
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  if CodigoUbicacion='' then
  begin
    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucion, CodigoUbicacion, CodigoEmpresa.EmpresaOrigen );
  end;

  if CodigoUbicacionRechazos='' then
  begin
    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucionRechazos, CodigoUbicacionRechazos, CodigoEmpresa.EmpresaOrigen );
  end;

  CodigoUbicacion         := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
  CodigoAlmacen           := FS_SGA_CodigoAlmacen ( CodigoUbicacion );

  CodigoUbicacionRechazos := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacionRechazos );
  CodigoAlmacenRechazos   := FS_SGA_CodigoAlmacen ( CodigoUbicacionRechazos );

  {if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;}

  if (not bErr) then begin

    gaLogFile.Write(JSonArray.ToString);

    // Conversió al codi d'article real
    Caja                      := StrToIntDef(_Get_JSonValue ( JSonArray, 'Caja' ),1);
    Palet                     := StrToIntDef(_Get_JSonValue ( JSonArray, 'Palet' ),1);
    Partida                   := (_Get_JSonValue ( JSonArray, 'Partida' ));
    FechaCaduca               := Trim(_Get_JSonValue ( JSonArray, 'FechaCaduca' ));
    Verificacion              := AnsiUpperCase((_Get_JSonValue ( JSonArray, 'Verificacion' )));
    AnomaliaId                := StrToIntDef(_Get_JSonValue ( JSonArray, 'AnomaliaId' ),0);
    UnidadMedida              := AnsiUpperCase(_Get_JSonValue ( JSonArray, 'UnidadMedida' ));
    UnidadMedidaBase          := AnsiUpperCase(_Get_JSonValue ( JSonArray, 'UnidadMedidaBase' ));
    UnidadesEntrada           := -FS_StrToFloatDef(_Get_JSonValue ( JSonArray, 'UnidadesEntrada' ),0);
    UnidadesEntradaBase       := -FS_StrToFloatDef(_Get_JSonValue ( JSonArray, 'UnidadesEntradaBase' ),0);
    FactorConversion          := FS_StrToFloatDef(_Get_JSonValue ( JSonArray, 'FactorConversion' ),0);
    CodigoAgrupacion          := StrToIntDef(_Get_JSonValue ( JSonArray, 'CodigoAgrupacion' ),1);
    UnidadesAgrupacion        := FS_StrToFloatDef(_Get_JSonValue ( JSonArray, 'UnidadesAgrupacion' ),0);
    UnidadMedidaRechazo       := AnsiUpperCase(_Get_JSonValue ( JSonArray, 'UnidadMedidaRechazo' ));
    UnidadMedidaBaseRechazo   := AnsiUpperCase(_Get_JSonValue ( JSonArray, 'UnidadMedidaBaseRechazo' ));
    UnidadesRechazo           := -FS_StrToFloatDef(_Get_JSonValue ( JSonArray, 'UnidadesRechazo' ),0);
    UnidadesRechazoBase       := -FS_StrToFloatDef(_Get_JSonValue ( JSonArray, 'UnidadesRechazoBase' ),0);
    FactorConversionRechazo   := FS_StrToFloatDef(_Get_JSonValue ( JSonArray, 'FactorConversionRechazo' ),0);
    CodigoAgrupacionRechazo   := CodigoAgrupacion;
    UnidadesAgrupacionRechazo := UnidadesAgrupacion;
    Precio                    := FS_StrToFloatDef(_Get_JSonValue ( JSonArray, 'Precio' ),0);
    Matricula                 := (_Get_JSonValue ( JSonArray, 'Matricula' ));
    MatriculaRechazos         := (_Get_JSonValue ( JSonArray, 'MatriculaRechazos' ));

    if FechaCaduca='' then begin
      dFechaCaduca := 0;
    end else begin
      YY := StrToInt ( Copy ( FechaCaduca, 7, 4 ) );
      MM := StrToInt ( Copy ( FechaCaduca, 4, 2 ) );
      DD := StrToInt ( Copy ( FechaCaduca, 1, 2 ) );
      dFechaCaduca := EncodeDate ( YY, MM, DD );
    end;

  end;

  if (DevolucionIdLinea<>-1) and (DevolucionIdLineaDetalle<>-1) then begin

    sSQL :=
      'UPDATE FS_SGA_Devoluciones_Lineas_Detalle ' +
      'SET ' +
      '  CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''', ' +
      '  CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + ''', ' +
      '  CodigoAlmacenRechazos = ''' + SQL_Str(CodigoAlmacenRechazos) + ''', ' +
      '  CodigoUbicacionRechazos = ''' + SQL_Str(CodigoUbicacionRechazos) + ''', ' +
      '  Caja = ' + IntToStr(Caja) + ', ' +
      '  Palet = ' + IntToStr(Palet) + ', ' +
      '  Partida = ''' + SQL_Str(Partida) + ''', ' +
      '  FechaCaducidad = ' + SQL_DateToStr(dFechaCaduca) + ', ' +
      '  Verificacion = ''' + SQL_Str(Verificacion) + ''', ' +
      '  AnomaliaId = ' + IntToStr(AnomaliaId) + ', ' +
      '  Precio = ' + SQL_FloatToStr(Precio) + ', ' +
      '  GrupoTalla_ = ' + IntToStr(GrupoTalla) + ', ' +
      '  CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''', ' +
      '  CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''', ' +
      '  UnidadMedida1_ = ''' + SQL_Str(UnidadMedida) + ''', ' +
      '  UnidadesEntrada = ' + SQL_FloatToStr(UnidadesEntrada * UnidadesAgrupacion) + ', ' +
      '  CantidadErrorEntrada = ' + SQL_FloatToStr(UnidadesRechazo * UnidadesAgrupacionRechazo) + ', ' +
      '  FechaRegistro = ' + SQL_DateTimeToStr(Now()) + ', ' +
      '  UnidadMedidaBase = ''' + SQL_Str(UnidadMedidaBase) + ''', ' +
      '  UnidadesEntradaBase = ' + SQL_FloatToStr(UnidadesEntradaBase) + ', ' +
      '  UnidadesErrorBase = ' + SQL_FloatToStr(UnidadesRechazoBase) + ', ' +
      '  CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion) + ', ' +
      '  UnidadesAgrupacion = ' + SQL_FloatToStr(UnidadesAgrupacion) + ', ' +
      '  CodigoAgrupacionRechazos = ' + IntToStr(CodigoAgrupacionRechazo) + ', ' +
      '  UnidadesAgrupacionRechazos = ' + SQL_FloatToStr(UnidadesAgrupacionRechazo) + ', ' +
      '  FactorConversion = ' + SQL_FloatToStr(FactorConversion) + ', ' +
      '  FactorConversionRechazos = ' + SQL_FloatToStr(FactorConversionRechazo) + ', ' +
      '  Matricula = ''' + SQL_Str(Matricula) + ''', ' +
      '  MatriculaRechazos = ''' + SQL_Str(MatriculaRechazos) + ''' ' +
      'WHERE ' +
      '  DevolucionId = ' + IntToStr(DevolucionId) + ' AND ' +
      '  DevolucionIdLinea = ' + IntToStr(DevolucionIdLinea) + ' AND ' +
      '  DevolucionIdLineaDetalle = ' + IntToStr(DevolucionIdLineaDetalle);

  end else begin

    sSQL :=
      'INSERT INTO FS_SGA_Devoluciones_Lineas_Detalle ( ' +
      '  DevolucionId, DevolucionIdLinea, Ejercicio, CodigoAlmacen, CodigoUbicacion, CodigoAlmacenRechazos, ' +
      '  CodigoUbicacionRechazos, Caja, Palet, Partida, FechaCaducidad, Verificacion, AnomaliaId, ' +
      '  Precio, UnidadMedida1_, UnidadesEntrada, CantidadErrorEntrada, FechaRegistro, UnidadMedidaBase, ' +
      '  UnidadesEntradaBase, UnidadesErrorBase, CodigoAgrupacion, UnidadesAgrupacion, ' +
      '  GrupoTalla_, CodigoTalla01_, CodigoColor_, Matricula, MatriculaRechazos, ' +
      '  CodigoAgrupacionRechazos,  UnidadesAgrupacionRechazos, FactorConversion, FactorConversionRechazos ) ' +
      'VALUES ( ' +
      IntToStr(DevolucionId) + ', ' +
      IntToStr(DevolucionIdLinea) + ', ' +
      IntToStr(Ejercicio) + ', ' +
      '''' + SQL_Str(CodigoAlmacen) + ''', ' +
      '''' + SQL_Str(CodigoUbicacion) + ''', ' +
      '''' + SQL_Str(CodigoAlmacenRechazos) + ''', ' +
      '''' + SQL_Str(CodigoUbicacionRechazos) + ''', ' +
      IntToStr(Caja) + ', ' +
      IntToStr(Palet) + ', ' +
      '''' + SQL_Str(Partida) + ''', ' +
      SQL_DateToStr(dFechaCaduca) + ', ' +
      '''' + SQL_Str(Verificacion) + ''', ' +
      IntToStr(AnomaliaId) + ', ' +
      SQL_FloatToStr(Precio) + ', ' +
      '''' + SQL_Str(UnidadMedida) + ''', ' +
      SQL_FloatToStr(UnidadesEntrada * UnidadesAgrupacion) + ', ' +
      SQL_FloatToStr(UnidadesRechazo * UnidadesAgrupacionRechazo) + ', ' +
      SQL_DateTimeToStr(Now()) + ', ' +
      '''' + SQL_Str(UnidadMedidaBase) + ''', ' +
      SQL_FloatToStr(UnidadesEntradaBase) + ', ' +
      SQL_FloatToStr(UnidadesRechazoBase) + ', ' +
      IntToStr(CodigoAgrupacion) + ', ' +
      SQL_FloatToStr(UnidadesAgrupacion) + ', ' +
      IntToStr(GrupoTalla) + ', ' +
      '''' + SQL_Str(CodigoTalla) + ''', ' +
      '''' + SQL_Str(CodigoColor) + ''', ' +
      '''' + SQL_Str(Matricula) + ''', ' +
      '''' + SQL_Str(MatriculaRechazos) + ''', ' +
      IntToStr(CodigoAgrupacionRechazo) + ', ' +
      SQL_FloatToStr(UnidadesAgrupacionRechazo) + ', ' +
      SQL_FloatToStr(FactorConversion) + ', ' +
      SQL_FloatToStr(FactorConversionRechazo) + ' ' +
      ')';

  end;

  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  sSQL :=
    'UPDATE FS_SGA_Devoluciones_Lineas_Detalle ' +
    'SET ' +
    '  TotalEntrada = UnidadesEntrada + CantidadErrorEntrada, ' +
    '  TotalEntradaBase = UnidadesEntradaBase + UnidadesErrorBase ' +
    'WHERE ' +
    '  DevolucionId = ' + IntToStr(DevolucionId) + ' AND ' +
    '  DevolucionIdLinea = ' + IntToStr(DevolucionIdLinea) + ' AND ' +
    '  DevolucionIdLineaDetalle = ' + IntToStr(DevolucionIdLineaDetalle);

  if not bErr then
  try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Error":"' + JSON_Str(sMsg) + '"}';
  end else begin
    Result := '{"Result":"OK","Error":""}';
  end;

  LP := LOG_Clear();
  LP.IdDevolucion := DevolucionId;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-DEV', 'Actualizar artículo (' + CodigoArticulo + ') de la devolución', @LP );
  
  {$ENDREGION}

  JSonObject.Free;

end;


procedure WebModule1updateDevolucionProvAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  DevolucionId: Integer;
  DevolucionIdLinea: Integer;
  sSQL: String;
  Data:Utf8String;
  Desglose: String;
  AutoId: Integer;
  Caja: Integer;
  Palet: Integer;
  Unidades: Double;
  bErr: Boolean;
  sMsg: string;
  Partida: string;
  CodigoAlmacen: String;
  CodigoUbicacion: String;
  CodigoAlmacenRechazos: String;
  CodigoUbicacionRechazos: String;
  FechaCaduca: String;
  dFechaCaduca: TDate;
  Verificacion: String;
  AnomaliaId: Integer;
  UnidadMedida1_: String;
  UnidadesEntrada: Double;
  CantidadErrorEntrada: Double;
  CantidadError: Double;
  TotalEntrada: Double;
  Total: Double;
  JSonPair: TJSONPair;
  YY, MM, DD: WORD;
  EmpresaOrigen: Integer;
  JSonObject: TJSONObject;
  JSonValue: TJSONValue;
  JSonArray: TJSONArray;
  lJSonValue: TJSonValue;
  Precio: Double;
  contentfields: TStringList;
  CodigoArticulo: string;
  UnidadesEntradaBase: Double;
  FactorConversion: Double;
  UnidadMedida: string;
  UnidadMedidaBase: string;
  UnidadesRechazo: Double;
  UnidadesRechazoBase: Double;
  FactorConversionRechazo: Double;
  CodigoAgrupacion: Integer;
  UnidadesAgrupacion: Double;
  UnidadMedidaRechazo: string;
  UnidadMedidaBaseRechazo: string;
  CodigoAgrupacionRechazo: Integer;
  UnidadesAgrupacionRechazo: Double;
  IsNew: Boolean;
  DevolucionIdLineaDetalle: Integer;
  CodigoTalla: String;
  CodigoColor: String;
  GrupoTalla: Integer;
  Q: TADOQuery;
  Matricula: String;
  MatriculaRechazos: String;
  CodigoUsuario: Integer;
  UUID: string;
  Ejercicio: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario  := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID           := contentfields.values['UUID'];
  CodigoArticulo := (contentfields.values['CodigoArticulo']);

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );
  if CodigoArticulo=''then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    Exit;
  end;

  DevolucionId := StrToIntDef(contentfields.values['IdDevolucion'],0);
  if DevolucionId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de devolución no especificado","Data":[]}';
    Exit;
  end;

  sSQL := 'SELECT Ejercicio FROM FS_SGA_DevolucionesP WITH (NOLOCK) WHERE DevolucionId = ' + IntToStr(DevolucionId);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  DevolucionIdLinea := StrToIntDef(contentfields.values['DevolucionIdLinea'],0);
  if DevolucionIdLinea=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de línea de devolución no especificado","Data":[]}';
    Exit;
  end;

  DevolucionIdLineaDetalle := StrToIntDef(contentfields.Values['DevolucionIdLineaDetalle'],-1);

  CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación no especificado","Data":[]}';
    Exit;
  end;

  CodigoUbicacionRechazos := (contentfields.values['CodigoUbicacionRechazos']);
  CodigoUbicacionRechazos := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacionRechazos );
  if CodigoUbicacionRechazos='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación de rechazos no especificado","Data":[]}';
    Exit;
  end;

  sSQL :=
    'SELECT art.GrupoTalla_, fsdl.CodigoTalla01_, fsdl.CodigoColor_ ' +
    'FROM FS_SGA_DevolucionesP_Lineas fsdl WITH (NOLOCK) ' +
    'INNER JOIN Articulos art WITH (NOLOCK) ' +
    'ON ' +
    '  art.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
    '  AND art.CodigoArticulo = fsdl.CodigoArticulo ' +
    'WHERE ' +
    '  fsdl.DevolucionId = ' + IntToStr(DevolucionId) + ' ' +
    '  AND fsdl.DevolucionIdLinea = ' + IntToStr(DevolucionIdLinea);
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if not Q.Eof then
  begin
    GrupoTalla  := Q.FieldByName('GrupoTalla_').AsInteger;
    CodigoTalla := Q.FieldByName('CodigoTalla01_').AsString;
    CodigoColor := Q.FieldByName('CodigoColor_').AsString;
  end else begin
    GrupoTalla  := 0;
    CodigoTalla := '';
    CodigoColor := '';
  end;

  Q.Close;
  FreeAndNil(Q);

  (*
  if RecepcionIdLinea=-1 then begin

    CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);

    // Conversió al codi d'article real
    CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

    if CodigoUbicacion='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación no especificado","Data":[]}';
      Exit;
    end;

    CodigoUbicacionRechazos := (contentfields.values['CodigoUbicacionRechazos']);
    if CodigoUbicacionRechazos='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación de rechazos no especificado","Data":[]}';
      Exit;
    end;

    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacion );
    if CodigoAlmacen='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación incorrecto","Data":[]}';
      Exit;
    end;

    CodigoAlmacenRechazos   := FS_SGA_CodigoAlmacen ( CodigoUbicacionRechazos );
    if CodigoAlmacen='' then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación de rechazos incorrecto","Data":[]}';
      Exit;
    end;

    Verificacion := AnsiUpperCase((contentfields.values['Verificacion']));
    if Verificacion='' then
      Verificacion := 'PENDIENTE';

    if (Verificacion<>'PENDIENTE') and (Verificacion<>'CORRECTA') and (Verificacion<>'INCIDENCIA') then begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El tipo de verificación no es correcto","Data":[]}';
      Exit;
    end;

  end;
  *)

  Data := (contentfields.values['Data']);
  if Data='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se han especificado los datos","Data":[]}';
    Exit;
  end;

  JSonObject := _Parse_JSonObject ( Data );
  if JSonObject=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El formato JSON del elemento Data es incorrecto","Data":[]}';
    Exit;
  end;

  JSonValue  := JSonObject.Get('Desglose').JsonValue;
  if JSonValue=nil then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no son válidos","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  JSonArray := TJSONArray(JSonValue);
  if JSonArray=nil then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Los datos especificados no contienen un array válido","Data":[]}';
    JSonObject.Free;
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Guardar les dades'}

  sMsg := '';
  bErr := FALSE;

  try
    // Conn.BeginTrans;
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  if CodigoUbicacion='' then
  begin
    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucion, CodigoUbicacion, CodigoEmpresa.EmpresaOrigen );
  end;

  if CodigoUbicacionRechazos='' then
  begin
    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_CodigoUbicacionDevolucionRechazos, CodigoUbicacionRechazos, CodigoEmpresa.EmpresaOrigen );
  end;

  CodigoUbicacion         := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
  CodigoAlmacen           := FS_SGA_CodigoAlmacen ( CodigoUbicacion );

  CodigoUbicacionRechazos := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacionRechazos );
  CodigoAlmacenRechazos   := FS_SGA_CodigoAlmacen ( CodigoUbicacionRechazos );

  {if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;}

  if (not bErr) then begin

    gaLogFile.Write(JSonArray.ToString);

    // Conversió al codi d'article real
    Caja                      := StrToIntDef(_Get_JSonValue ( JSonArray, 'Caja' ),1);
    Palet                     := StrToIntDef(_Get_JSonValue ( JSonArray, 'Palet' ),1);
    Partida                   := (_Get_JSonValue ( JSonArray, 'Partida' ));
    FechaCaduca               := Trim(_Get_JSonValue ( JSonArray, 'FechaCaduca' ));
    Verificacion              := AnsiUpperCase((_Get_JSonValue ( JSonArray, 'Verificacion' )));
    AnomaliaId                := StrToIntDef(_Get_JSonValue ( JSonArray, 'AnomaliaId' ),0);
    UnidadMedida              := AnsiUpperCase(_Get_JSonValue ( JSonArray, 'UnidadMedida' ));
    UnidadMedidaBase          := AnsiUpperCase(_Get_JSonValue ( JSonArray, 'UnidadMedidaBase' ));
    UnidadesEntrada           := -FS_StrToFloatDef(_Get_JSonValue ( JSonArray, 'UnidadesEntrada' ),0);
    UnidadesEntradaBase       := -FS_StrToFloatDef(_Get_JSonValue ( JSonArray, 'UnidadesEntradaBase' ),0);
    FactorConversion          := FS_StrToFloatDef(_Get_JSonValue ( JSonArray, 'FactorConversion' ),0);
    CodigoAgrupacion          := StrToIntDef(_Get_JSonValue ( JSonArray, 'CodigoAgrupacion' ),1);
    UnidadesAgrupacion        := FS_StrToFloatDef(_Get_JSonValue ( JSonArray, 'UnidadesAgrupacion' ),0);
    UnidadMedidaRechazo       := AnsiUpperCase(_Get_JSonValue ( JSonArray, 'UnidadMedidaRechazo' ));
    UnidadMedidaBaseRechazo   := AnsiUpperCase(_Get_JSonValue ( JSonArray, 'UnidadMedidaBaseRechazo' ));
    UnidadesRechazo           := -FS_StrToFloatDef(_Get_JSonValue ( JSonArray, 'UnidadesRechazo' ),0);
    UnidadesRechazoBase       := -FS_StrToFloatDef(_Get_JSonValue ( JSonArray, 'UnidadesRechazoBase' ),0);
    FactorConversionRechazo   := FS_StrToFloatDef(_Get_JSonValue ( JSonArray, 'FactorConversionRechazo' ),0);
    CodigoAgrupacionRechazo   := StrToIntDef(_Get_JSonValue ( JSonArray, 'CodigoAgrupacionRechazo' ),1);
    UnidadesAgrupacionRechazo := FS_StrToFloatDef(_Get_JSonValue ( JSonArray, 'UnidadesAgrupacionRechazo' ),0);
    Precio                    := FS_StrToFloatDef(_Get_JSonValue ( JSonArray, 'Precio' ),0);
    Matricula                 := (_Get_JSonValue ( JSonArray, 'Matricula' ));
    MatriculaRechazos         := (_Get_JSonValue ( JSonArray, 'MatriculaRechazos' ));

    if FechaCaduca='' then begin
      dFechaCaduca := 0;
    end else begin
      YY := StrToInt ( Copy ( FechaCaduca, 7, 4 ) );
      MM := StrToInt ( Copy ( FechaCaduca, 4, 2 ) );
      DD := StrToInt ( Copy ( FechaCaduca, 1, 2 ) );
      dFechaCaduca := EncodeDate ( YY, MM, DD );
    end;

  end;

  if (DevolucionIdLinea<>-1) and (DevolucionIdLineaDetalle<>-1) then begin

    sSQL :=
      'UPDATE FS_SGA_DevolucionesP_Lineas_Detalle ' +
      'SET ' +
      '  CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''', ' +
      '  CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + ''', ' +
      '  CodigoAlmacenRechazos = ''' + SQL_Str(CodigoAlmacenRechazos) + ''', ' +
      '  CodigoUbicacionRechazos = ''' + SQL_Str(CodigoUbicacionRechazos) + ''', ' +
      '  Caja = ' + IntToStr(Caja) + ', ' +
      '  Palet = ' + IntToStr(Palet) + ', ' +
      '  Partida = ''' + SQL_Str(Partida) + ''', ' +
      '  FechaCaducidad = ' + SQL_DateToStr(dFechaCaduca) + ', ' +
      '  Verificacion = ''' + SQL_Str(Verificacion) + ''', ' +
      '  AnomaliaId = ' + IntToStr(AnomaliaId) + ', ' +
      '  Precio = ' + SQL_FloatToStr(Precio) + ', ' +
      '  GrupoTalla_ = ' + IntToStr(GrupoTalla) + ', ' +
      '  CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''', ' +
      '  CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''', ' +
      '  UnidadMedida1_ = ''' + SQL_Str(UnidadMedida) + ''', ' +
      '  UnidadesEntrada = ' + SQL_FloatToStr(UnidadesEntrada * UnidadesAgrupacion) + ', ' +
      '  CantidadErrorEntrada = ' + SQL_FloatToStr(UnidadesRechazo * UnidadesAgrupacionRechazo) + ', ' +
      '  FechaRegistro = ' + SQL_DateTimeToStr(Now()) + ', ' +
      '  UnidadMedidaBase = ''' + SQL_Str(UnidadMedidaBase) + ''', ' +
      '  UnidadesEntradaBase = ' + SQL_FloatToStr(UnidadesEntradaBase) + ', ' +
      '  UnidadesErrorBase = ' + SQL_FloatToStr(UnidadesRechazoBase) + ', ' +
      '  CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion) + ', ' +
      '  UnidadesAgrupacion = ' + SQL_FloatToStr(UnidadesAgrupacion) + ', ' +
      '  CodigoAgrupacionRechazos = ' + IntToStr(CodigoAgrupacionRechazo) + ', ' +
      '  UnidadesAgrupacionRechazos = ' + SQL_FloatToStr(UnidadesAgrupacionRechazo) + ', ' +
      '  FactorConversion = ' + SQL_FloatToStr(FactorConversion) + ', ' +
      '  FactorConversionRechazos = ' + SQL_FloatToStr(FactorConversionRechazo) + ', ' +
      '  Matricula = ''' + SQL_Str(Matricula) + ''', ' +
      '  MatriculaRechazos = ''' + SQL_Str(MatriculaRechazos) + ''' ' +
      'WHERE ' +
      '  DevolucionId = ' + IntToStr(DevolucionId) + ' AND ' +
      '  DevolucionIdLinea = ' + IntToStr(DevolucionIdLinea) + ' AND ' +
      '  DevolucionIdLineaDetalle = ' + IntToStr(DevolucionIdLineaDetalle);

  end else begin

    sSQL :=
      'INSERT INTO FS_SGA_DevolucionesP_Lineas_Detalle ( ' +
      '  DevolucionId, DevolucionIdLinea, Ejercicio, CodigoAlmacen, CodigoUbicacion, CodigoAlmacenRechazos, ' +
      '  CodigoUbicacionRechazos, Caja, Palet, Partida, FechaCaducidad, Verificacion, AnomaliaId, ' +
      '  Precio, UnidadMedida1_, UnidadesEntrada, CantidadErrorEntrada, FechaRegistro, UnidadMedidaBase, ' +
      '  UnidadesEntradaBase, UnidadesErrorBase, CodigoAgrupacion, UnidadesAgrupacion, ' +
      '  GrupoTalla_, CodigoTalla01_, CodigoColor_, Matricula, MatriculaRechazos, ' +
      '  CodigoAgrupacionRechazos,  UnidadesAgrupacionRechazos, FactorConversion, FactorConversionRechazos ) ' +
      'VALUES ( ' +
      IntToStr(DevolucionId) + ', ' +
      IntToStr(DevolucionIdLinea) + ', ' +
      IntToStr(Ejercicio) + ', ' +
      '''' + SQL_Str(CodigoAlmacen) + ''', ' +
      '''' + SQL_Str(CodigoUbicacion) + ''', ' +
      '''' + SQL_Str(CodigoAlmacenRechazos) + ''', ' +
      '''' + SQL_Str(CodigoUbicacionRechazos) + ''', ' +
      IntToStr(Caja) + ', ' +
      IntToStr(Palet) + ', ' +
      '''' + SQL_Str(Partida) + ''', ' +
      SQL_DateToStr(dFechaCaduca) + ', ' +
      '''' + SQL_Str(Verificacion) + ''', ' +
      IntToStr(AnomaliaId) + ', ' +
      SQL_FloatToStr(Precio) + ', ' +
      '''' + SQL_Str(UnidadMedida) + ''', ' +
      SQL_FloatToStr(UnidadesEntrada * UnidadesAgrupacion) + ', ' +
      SQL_FloatToStr(UnidadesRechazo * UnidadesAgrupacionRechazo) + ', ' +
      SQL_DateTimeToStr(Now()) + ', ' +
      '''' + SQL_Str(UnidadMedidaBase) + ''', ' +
      SQL_FloatToStr(UnidadesEntradaBase) + ', ' +
      SQL_FloatToStr(UnidadesRechazoBase) + ', ' +
      IntToStr(CodigoAgrupacion) + ', ' +
      SQL_FloatToStr(UnidadesAgrupacion) + ', ' +
      IntToStr(GrupoTalla) + ', ' +
      '''' + SQL_Str(CodigoTalla) + ''', ' +
      '''' + SQL_Str(CodigoColor) + ''', ' +
      '''' + SQL_Str(Matricula) + ''', ' +
      '''' + SQL_Str(MatriculaRechazos) + ''', ' +
      IntToStr(CodigoAgrupacionRechazo) + ', ' +
      SQL_FloatToStr(UnidadesAgrupacionRechazo) + ', ' +
      SQL_FloatToStr(FactorConversion) + ', ' +
      SQL_FloatToStr(FactorConversionRechazo) + ' ' +
      ')';

  end;

  if not bErr then try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  sSQL :=
    'UPDATE FS_SGA_DevolucionesP_Lineas_Detalle ' +
    'SET ' +
    '  TotalEntrada = UnidadesEntrada + CantidadErrorEntrada, ' +
    '  TotalEntradaBase = UnidadesEntradaBase + UnidadesErrorBase ' +
    'WHERE ' +
    '  DevolucionId = ' + IntToStr(DevolucionId) + ' AND ' +
    '  DevolucionIdLinea = ' + IntToStr(DevolucionIdLinea) + ' AND ' +
    '  DevolucionIdLineaDetalle = ' + IntToStr(DevolucionIdLineaDetalle);

  if not bErr then
  try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if bErr then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Error":"' + JSON_Str(sMsg) + '"}';
  end else begin
    Result := '{"Result":"OK","Error":""}';
  end;

  LP := LOG_Clear();
  LP.IdDevolucionP := DevolucionId;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-DEVP', 'Actualizar artículo (' + CodigoArticulo + ') de la devolución de compra', @LP );
  
  
  {$ENDREGION}

  JSonObject.Free;

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ RETORNA EL LLISTAT D'USUARIS                                          │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1userListAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var

  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  contentfields: TStringList;
  bPin: Boolean;

{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM dbo.FS_SGA_Usuarios WITH (NOLOCK) ' +
          'WHERE ' +
          //'  CodigoEmpresa = 9999 AND ' +
          '  EsBaja = 0';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  u.*, r.RolNombre ' +
          'FROM FS_SGA_Usuarios u WITH (NOLOCK) ' +
          'LEFT JOIN FS_SGA_Roles r WITH (NOLOCK) ' +
          'ON ' +
          '  u.RolId = r.RolID ' +
          'WHERE ' +
          //'  CodigoEmpresa = 9999 AND ' +
          '  EsBaja = 0 ' +
          'ORDER BY ' +
          '  NombreCompletoUsuario, NombreUsuario, CodigoUsuario ';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    if (Q.FieldByName('Pin').IsNull) or (Q.FieldByName('Pin').AsString='') then
      bPin := FALSE
    else
      bPin := TRUE;

    Result := Result + '{' +
      '"CodigoUsuario":"' + JSON_Str(Q.FieldByName('CodigoUsuario').AsString) + '",' +
      '"NombreUsuario":"' + JSON_Str(Q.FieldByName('NombreUsuario').AsString) + '",' +
      '"NombreCompletoUsuario":"' + JSON_Str(Q.FieldByName('NombreCompletoUsuario').AsString) + '",' +
      '"RolId": ' + IntToStr(Q.FieldByName('RolId').AsInteger) + ',' +
      '"RolNombre":"' + JSON_Str(Q.FieldByName('RolNombre').AsString) + '",' +
      '"HasPin":' + SQL_BooleanToStr(bPin) +
      '}';

    Q.Next;
  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ VALIDA USUARI I PASSWORD                                              │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1validateUbicacionAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  CodigoUsuario: Integer;
  Q: TADOQuery;
  CodigoUbicacion: String;
  CodigoAlternativo: String;
  CodigoAlmacen: String;
  CodigoPasillo: String;
  CodigoEstanteria: String;
  Altura: String;
  Fondo: String;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  Bloqueada: Boolean;
  sPackagings: String;
  fPesoMaximo: Double;
  bTransito: Boolean;
  ByPassLocked: Boolean;

{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUbicacion := (contentfields.Values['CodigoUbicacion'] );

  if Pos('.$',CodigoUbicacion)>0 then
  begin

    FS_SGA_UBICACION_Desglosar ( Conn, CodigoEmpresa, CodigoUbicacion, CodigoAlmacen, CodigoPasillo, CodigoEstanteria, Altura, Fondo, CodigoAlternativo );

    Result := '{"Result":"OK","Error":"","Data":[';
    Result := Result + '{' +
      '"Tipo":2,' +
      '"CodigoAlmacen":"' + JSON_Str(CodigoAlmacen) + '",' +
      '"CodigoPasillo":"' + JSON_Str(CodigoPasillo) + '",' +
      '"CodigoEstanteria":"' + JSON_Str(CodigoEstanteria) + '",' +
      '"Altura":"' + JSON_Str(Altura) + '",' +
      '"Fondo":"' + JSON_Str(Fondo) + '",' +
      '"CodigoUbicacion":"' + JSON_Str(CodigoUbicacion) + '",' +
      '"CodigoUbicacionAlternativo":""' +
      '}]}';
    Exit;

  end;

  // Conversió al codi d'article real
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se ha especificado la ubicación","Data":[]}';
    Exit;
  end;

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  ByPassLocked  := (AnsiLowerCase(contentfields.Values['ByPassLocked'])='true');

  {$ENDREGION}

  {$REGION 'Validem la ubicació'}

  sSQL := 'SELECT TOP 1 ' +
          '  CodigoUbicacion, CodigoAlternativo, Bloqueada, Transito, PesoMaxPermitido ' +
          'FROM FS_SGA_ESTR_UBICA WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' AND ' +
          '  (CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + ''' OR ' +
          '  CodigoAlternativo = ''' + SQL_Str(CodigoUbicacion) + ''' )';
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if not Q.EOF then begin
    CodigoUbicacion   := Q.FieldByName('CodigoUbicacion').AsString;
    CodigoAlternativo := Q.FieldByName('CodigoAlternativo').AsString;
    Bloqueada         := Q.FieldByName('Bloqueada').AsBoolean;
    bTransito         := Q.FieldByName('Transito').AsBoolean;
    fPesoMaximo       := Q.FieldByName('PesoMaxPermitido').AsFloat;
  end else begin
    CodigoUbicacion   := '';
    CodigoAlternativo := '';
    Bloqueada         := FALSE;
    bTransito         := FALSE;
    fPesoMaximo       := 0;
  end;

  if (Bloqueada and not ByPassLocked) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La ubicación está bloqueada","Data":[]}';
    Exit;
  end;

  FS_SGA_UBICACION_Desglosar ( Conn, CodigoEmpresa, CodigoUbicacion, CodigoAlmacen, CodigoPasillo, CodigoEstanteria, Altura, Fondo, CodigoAlternativo );

  Q.Close;
  FreeAndNil(Q);

  sPackagings := FS_SGA_PackagingsUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );

  if (CodigoUbicacion='') then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Error":"Código de ubicación incorrecto"}';
  end else begin
    Result := '{"Result":"OK","Error":"","Data":[';
    Result := Result + '{' +
      '"Tipo":2,' +
      '"CodigoAlmacen":"' + JSON_Str(CodigoAlmacen) + '",' +
      '"CodigoPasillo":"' + JSON_Str(CodigoPasillo) + '",' +
      '"CodigoEstanteria":"' + JSON_Str(CodigoEstanteria) + '",' +
      '"Altura":"' + JSON_Str(Altura) + '",' +
      '"Fondo":"' + JSON_Str(Fondo) + '",' +
      '"Matricula":"",' +
      '"Bloqueada":' + SQL_BooleanToStr(Bloqueada) + ',' +
      '"CodigoUbicacion":"' + JSON_Str(CodigoUbicacion) + '",' +
      '"CodigoUbicacionAlternativo":"' + JSON_Str(CodigoAlternativo) + '",' +
      '"Transito":' + SQL_BooleanToStr(bTransito) + ',' +
      '"PesoMaximo":' + SQL_FloatToStr(fPesoMaximo) + ',' +
      '"Packagings":[' + sPackagings + ']' +
      '}]}';
  end;

  {$ENDREGION}

end;


procedure WebModule1readFormPermsAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; Port: Integer; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  Usuario: String;
  Password: String;
  sSQL: String;
  CodigoUsuario: Integer;
  Q: TADOQuery;
  sPass: String;
  sPermissions: string;
  RoleId: Integer;
  contentfields: TStringList;
  EmpresaOrigen: Integer;
  CodigoEmpresa: TOrigenCodigoEmpresa;
  MAC: String;
  Username: String;
  IP: String;
  Res: Word;
  license_code: AnsiString;
  grace_period: Integer;
  bPaletizacion: Boolean;
  iPerm: Integer;
  iPermId: Integer;
  bProduccion: Boolean;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  MAC           := contentfields.Values['UUID'];
  Username      := contentfields.Values['Username'];
  IP            := sRemoteAddr;
  bPaletizacion := TRUE;
  bProduccion   := TRUE;

  Res := LICENSE_Check ( Conn, 'PDA', MAC, IP, Username, Port, gsCustomerCode, CONST_SGA_PALETIZACION, license_code, grace_period);
  case Res of

    CONST_LICERR_INVALID_LICENSE,
    CONST_LICERR_NOT_ENOUGHT_LICENSES,
    CONST_LICERR_EXPIRED_LICENSE,
    CONST_LICENSE_DATABASE_ERROR:
    begin
      bPaletizacion := FALSE;
    end;

  end;

  Res := LICENSE_Check ( Conn, 'PDA', MAC, IP, Username, Port, gsCustomerCode, CONST_SGA_PRODUCCION, license_code, grace_period);
  case Res of

    CONST_LICERR_INVALID_LICENSE,
    CONST_LICERR_NOT_ENOUGHT_LICENSES,
    CONST_LICERR_EXPIRED_LICENSE,
    CONST_LICENSE_DATABASE_ERROR:
    begin
      bProduccion := FALSE;
    end;

  end;

  {$ENDREGION}

  {$REGION 'Recuperem els permisos de l´usuari'}

  sSQL :=
    'SELECT RolId ' +
    'FROM FS_SGA_Usuarios ' +
    'WHERE ' +
    '  CodigoUsuario = ' + IntToStr(CodigoUsuario) + ' ';
  RoleId := SQL_Execute ( Conn, sSQL );

  sSQL :=
    'SELECT ' +
    '  fsfp.FormId, fsf.FormNombre, fsfp.Permiso ' +
    'FROM FS_SGA_Forms_Permisos fsfp WITH (NOLOCK) ' +
    'LEFT JOIN  ' +
    '  FS_SGA_Forms fsf WITH (NOLOCK) ' +
    'ON  ' +
    '  fsf.FormID = fsfp.FormId ' +
    'WHERE ' +
    '  fsfp.RolId = ' + IntToStr(RoleId) + ' AND ' +
    '  fsfp.Permiso<>0 ' +
    'ORDER BY ' +
    '  fsfp.FormId';
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  sPermissions := '';
  while not Q.EOF do begin

     iPermId := Q.FieldByName('FormId').AsInteger;
     iPerm   := Q.FieldByName('Permiso').AsInteger;

     if (iPermId=55) and (not bPaletizacion) then
     begin
       iPerm := 0;
     end;

     if (iPermId=46) and (not bProduccion) then
     begin
       iPerm := 0;
     end;

     if (iPerm<>0) then
     begin

       if sPermissions<>'' then
         sPermissions := sPermissions + ',';

       sPermissions := sPermissions +
         '{' +
         '"FormId":' + IntToStr(iPermId) + ',' +
         '"FormName":"' + AnsiUpperCase(JSON_Str(Q.FieldByName('FormNombre').AsString)) + '",' +
         '"Perm":' + IntToStr(iPerm) +
         '}';

     end;

     Q.Next;

  end;

  Q.Close;
  FreeAndNil(Q);

  Result := '{"Result":"OK","Error":"","Data":[';
  Result := Result + '{' +
    '"CodigoUsuario":"' + IntToStr(CodigoUsuario) + '",' +
    '"Permisos":[' + sPermissions + ']' +
    '}]}';

  {$ENDREGION}

end;


procedure WebModule1logoutAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  Usuario: String;
  Password: String;
  CodigoUsuario: Integer;
  Pin: String;
  sSQL: String;
  Q: TADOQuery;
  sPass: String;
  sPermissions: string;
  RoleId: Integer;
  contentfields: TStringList;
  iPermId: Integer;
  iPerm: Integer;
  bPaletizacion: Boolean;
  IP: String;
  Res: Word;
  license_code: AnsiString;
  grace_period: Integer;
  sPin: String;
  bProduccion: Boolean;
  UUID: string;
  inactividad: Boolean;

{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  Usuario := contentfields.Values['Usuario'];
  CodigoUsuario := StrToIntDef(contentfields.values['CodigoUsuario'], 0);
  if CodigoUsuario=0 then begin
    LOG_Add ( Conn, CodigoUsuario, UUID, IP, 'LOGOUT-ERROR', 'Nombre de usuario no especificado' );
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se ha especificado el nombre de usuario","Data":[]}';
    Exit;
  end;

  inactividad := (AnsiLowerCase(contentfields.Values['inactividad']) = 'true');
  UUID        := contentfields.Values['UUID'];
  IP          := sRemoteAddr;

  if inactividad then
    LOG_Add ( Conn, CodigoUsuario, UUID, IP, 'LOGOUT-OK', 'Logout por inactividad del usuario "' + Usuario + '"' )
  else
    LOG_Add ( Conn, CodigoUsuario, UUID, IP, 'LOGOUT-OK', 'Logout correcto del usuario "' + Usuario + '"' );

  {$ENDREGION}

end;


procedure WebModule1validateUserAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; Port: Integer; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  Usuario: String;
  Password: String;
  Pin: String;
  sSQL: String;
  CodigoUsuario: Integer;
  Q: TADOQuery;
  sPass: String;
  sPermissions: string;
  RoleId: Integer;
  contentfields: TStringList;
  iPermId: Integer;
  iPerm: Integer;
  bPaletizacion: Boolean;
  IP: String;
  Res: Word;
  license_code: AnsiString;
  grace_period: Integer;
  sPin: String;
  bProduccion: Boolean;
  UUID: string;
  sUsuario: string;
  iUsuario: Integer;

{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  Usuario := Trim(contentfields.values['Usuario']);
  if Usuario='' then begin
    LOG_Add ( Conn, 0, UUID, IP, 'LOGIN-ERROR', 'Nombre de usuario no especificado' );
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se ha especificado el nombre de usuario","Data":[]}';
    Exit;
  end;

  iUsuario := StrToIntDef(Usuario, 0);

  sSQL :=
    'SELECT NombreUsuario FROM FS_SGA_Usuarios WITH (NOLOCK) ' +
    'WHERE CodigoUsuario = ' + Usuario;
  sUsuario := SQL_Execute ( Conn, sSQL );

  UUID     := contentfields.Values['UUID'];
  IP       := sRemoteAddr;
  Password := (contentfields.values['Password']);
  Pin      := (contentfields.values['Pin']);
  if (Password='') and (Pin='') then begin
    LOG_Add ( Conn, iUsuario, UUID, IP, 'LOGIN-ERROR', 'Login incorrecto del usuario "' + sUsuario + '"' );
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"No se ha especificado la contraseña o el PIN","Data":[]}';
    Exit;
  end;

  bPaletizacion := TRUE;
  bProduccion   := TRUE;

  Res := LICENSE_Check ( Conn, 'PDA', UUID, IP, Usuario, Port, gsCustomerCode, CONST_SGA_PALETIZACION, license_code, grace_period);

  case Res of

    CONST_LICERR_INVALID_LICENSE,
    CONST_LICERR_NOT_ENOUGHT_LICENSES,
    CONST_LICERR_EXPIRED_LICENSE,
    CONST_LICENSE_DATABASE_ERROR:
    begin
      bPaletizacion := FALSE;
    end;

  end;

  Res := LICENSE_Check ( Conn, 'PDA', UUID, IP, Usuario, Port, gsCustomerCode, CONST_SGA_PRODUCCION, license_code, grace_period);

  case Res of

    CONST_LICERR_INVALID_LICENSE,
    CONST_LICERR_NOT_ENOUGHT_LICENSES,
    CONST_LICERR_EXPIRED_LICENSE,
    CONST_LICENSE_DATABASE_ERROR:
    begin
      bProduccion := FALSE;
    end;

  end;

  {$ENDREGION}

  {$REGION 'Validem l´usuari'}

  sSQL := 'SELECT ' +
          '  CodigoUsuario, PasswordUsuario, Pin, RolId ' +
          'FROM FS_SGA_Usuarios WITH (NOLOCK) ' +
          'WHERE ' +
          '  EsBaja = 0 AND ' +
          '  CodigoUsuario = ' + SQL_Str(Usuario) + ' ';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      LOG_Add ( Conn, iUsuario, UUID, IP, 'LOGIN-ERROR', 'Login incorrecto del usuario "' + sUsuario + '"' );
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
    end;
  end;

  sPin := '';

  if not Q.EOF then begin

    if Pin='' then
    begin

      try
        sPass := LICENSE_TwoFish_DEC ( Q.FieldByName('PasswordUsuario').AsString );
      except
        on E:Exception do begin
          sPass := '';
          gaLogFile.Write ( E.Message );
        end;
      end;
      CodigoUsuario := Q.FieldByName('CodigoUsuario').AsInteger;
      RoleId := Q.FieldByName('RolId').AsInteger;

    end else begin

      CodigoUsuario := Q.FieldByName('CodigoUsuario').AsInteger;
      RoleId := Q.FieldByName('RolId').AsInteger;

      try
        sPin := LICENSE_TwoFish_DEC ( Q.FieldByName('Pin').AsString );
      except
        on E:Exception do begin
          sPass := '';
          gaLogFile.Write ( E.Message );
        end;
      end;

    end;

  end else begin

    LOG_Add ( Conn, iUsuario, UUID, IP, 'LOGIN-ERROR', 'Login incorrecto del usuario "' + sUsuario + '"' );
    gaLogFile.Write ( 'ERROR: Password no descifrado', CONST_LOGID_GENERAL, LOG_LEVEL_INFO );
    sPass := '';
    CodigoUsuario := 0;

  end;

  Q.Close;
  FreeAndNil(Q);

  if (CodigoUsuario=0) or
    ((sPin='') and (sPass<>Password)) or
    ((sPin<>'') and (sPin<>Pin)) then
  begin

    LOG_Add ( Conn, iUsuario, UUID, IP, 'LOGIN-ERROR', 'Login incorrecto del usuario "' + sUsuario + '"' );
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Error":"Usuario incorrecto"}';

  end else begin

    sSQL := 'SELECT ' +
            '  fsfp.FormId, fsf.FormNombre, fsfp.Permiso ' +
            'FROM FS_SGA_Forms_Permisos fsfp WITH (NOLOCK) ' +
            'LEFT JOIN  ' +
            '  FS_SGA_Forms fsf WITH (NOLOCK) ' +
            'ON  ' +
            '  fsf.FormID = fsfp.FormId ' +
            'WHERE ' +
            '  fsfp.RolId = ' + IntToStr(RoleId) + ' AND ' +
            '  fsfp.Permiso<>0 ' +
            'ORDER BY ' +
            '  fsfp.FormId';
    Q := SQL_PrepareQuery ( Conn, sSQL );
    Q.Open;

    sPermissions := '';
    while not Q.EOF do begin

       iPermId := Q.FieldByName('FormId').AsInteger;
       iPerm   := Q.FieldByName('Permiso').AsInteger;

       if (iPermId=55) and (not bPaletizacion) then
       begin
         iPerm := 0;
       end;

       if (iPermId=46) and (not bProduccion) then
       begin
         iPerm := 0;
       end;

       if (iPerm<>0) then
       begin

         if sPermissions<>'' then
           sPermissions := sPermissions + ',';

         sPermissions := sPermissions +
           '{' +
           '"FormId":' + IntToStr(iPermId) + ',' +
           '"FormName":"' + AnsiUpperCase(JSON_Str(Q.FieldByName('FormNombre').AsString)) + '",' +
           '"Perm":' + IntToStr(iPerm) +
           '}';

       end;

       Q.Next;

    end;

    Q.Close;
    FreeAndNil(Q);

    LOG_Add ( Conn, iUsuario, UUID, IP, 'LOGIN-OK', 'Login correcto del usuario "' + sUsuario + '"' );

    Result := '{"Result":"OK","Error":"","Data":[';
    Result := Result + '{' +
      '"CodigoUsuario":"' + IntToStr(CodigoUsuario) + '",' +
      '"Permisos":[' + sPermissions + ']' +
      '}]}';
  end;

  {$ENDREGION}

end;


{$ENDREGION}


{$REGION '--- FUNCIONS DE COMANDES I ALBARANS DE CLIENT'}

// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAR COMANDES DE CLIENTS                                           │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1cabeceraPedidoVentaAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoCliente: String;
  sAndWhere: String;
  EjercicioPedido: Integer;
  OrdenarPor: String;
  TipoOrden: String;
  sOrderBy: String;
  EmpresaOrigen: Integer;
  contentfields: TStringList;

{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoCliente   := (contentfields.values['CodigoCliente']);
  EjercicioPedido := StrToIntDef(contentfields.Values['EjercicioPedido'], 0 );

  OrdenarPor := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden  := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy   := '';

  if OrdenarPor='PEDIDO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'EjercicioPedido DESC, NumeroPedido DESC, SeriePedido DESC ';
    end else begin
      sOrderBy := 'EjercicioPedido DESC, NumeroPedido, SeriePedido ';
    end;
  end else if OrdenarPor='CLIENTE' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'EjercicioPedido DESC, RazonSocial DESC, NumeroPedido DESC, SeriePedido DESC ';
    end else begin
      sOrderBy := 'EjercicioPedido, RazonSocial, NumeroPedido, SeriePedido ';
    end;
  end else if OrdenarPor='FECHA' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'EjercicioPedido DESC, FechaPedido DESC, NumeroPedido DESC, SeriePedido DESC ';
    end else begin
      sOrderBy := 'EjercicioPedido DESC, FechaPedido, NumeroPedido, SeriePedido ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'EjercicioPedido DESC, SeriePedido DESC, NumeroPedido DESC ';
    end else begin
      sOrderBy := 'EjercicioPedido DESC, NumeroPedido, SeriePedido ';
    end;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sAndWhere := '';

  if CodigoCliente<>'' then begin
    sAndWhere := sAndWhere + 'AND CodigoCliente=''' + SQL_Str(CodigoCliente) + ''' ';
  end;

  if EjercicioPedido<>0 then begin
    sAndWhere := sAndWhere + 'AND EjercicioPedido=' + IntToStr(EjercicioPedido) + ' ';
  end;

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM CabeceraPedidoCliente WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' AND ' +
          //'  FechaPedido >= DATEADD(day,-30,GETDATE()) AND ' +
          '  Estado<>2 ' +
          sAndWhere;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  * ' +
          'FROM CabeceraPedidoCliente WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' AND ' +
          //'  FechaPedido >= DATEADD(day,-30,GETDATE()) AND ' +
          '  Estado <> 2 ' +
          sAndWhere + ' ' +
          'ORDER BY ' +
          sOrderBy + ' ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
      '"SeriePedido":"' + Q.FieldByName('SeriePedido').AsString + '",' +
      '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
      '"SuPedido":"' + Q.FieldByName('SuPedido').AsString + '",' +
      '"FechaPedido":"' + FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaPedido').AsDateTime ) + '",' +
      '"FechaEntrega":"' + FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaEntrega').AsDateTime ) + '",' +
      '"FechaTope":"' + FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaTope').AsDateTime ) + '",' +
      '"FechaNecesaria":"' + FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaNecesaria').AsDateTime ) + '",' +
      '"NumeroLineas":' + Q.FieldByName('NumeroLineas').AsString + ',' +
      '"PesoBruto":' + SQL_FloatToStr(Q.FieldByName('PesoBruto_').AsFloat) + ',' +
      '"PesoNeto":' + SQL_FloatToStr(Q.FieldByName('PesoNeto_').AsFloat) + ',' +
      '"Volumen":' + SQL_FloatToStr(Q.FieldByName('Volumen_').AsFloat) + ',' +
      '"CodigoCliente":"' + JSON_Str(Q.FieldByName('CodigoCliente').AsString) + '",' +
      '"Nombre":"' + JSON_Str(Q.FieldByName('Nombre').AsString) + '",' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"Domicilio":"' + JSON_Str(Q.FieldByName('Domicilio').AsString) + '",' +
      '"CodigoPostal":"' + JSON_Str(Q.FieldByName('CodigoPostal').AsString) + '",' +
      '"Municipio":"' + JSON_Str(Q.FieldByName('Municipio').AsString) + '",' +
      '"Provincia":"' + JSON_Str(Q.FieldByName('Provincia').AsString) + '",' +
      '"Nacion":"' + JSON_Str(Q.FieldByName('Nacion').AsString) + '",' +
      '"Estado":' + Q.FieldByName('Estado').AsString + '' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


procedure WebModule1doAprovisionamientoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdAprovisionamiento: Integer;
  EjercicioTrabajo: Integer;
  NumeroTrabajo: Integer;
  Orden: Integer;
  UbicacionOrigen: String;
  UbicacionDestino: String;
  Cantidad: Double;
  CantidadBase: Double;
  FactorConversion: Double;
  UnidadMedida: String;
  UnidadMedidaBase: String;
  GrupoTalla: Integer;
  CodigoTalla: String;
  CodigoColor: String;
  CodigoAgrupacion: Integer;
  UnidadesAgrupacion: Double;
  gaMov: TSGAMovimientoStock;
  YY: WORD;
  aUbicacionDestino: TSGAUbicacion;
  aUbicacionOrigen: TSGAUbicacion;
  CodigoArticulo: String;
  Partida: String;
  sNewGuid: String;
  sNewMovOrigen: String;
  bErr: Boolean;
  sMsg: String;
  AutoId: Integer;
  bTransitoOrigen: Boolean;
  bTransitoDestino: Boolean;
  UbicacionOrigenFinal: String;
  UbicacionDestinoFinal: String;
  iNum: Integer;
  bEnd: Boolean;
  iAutoID: Integer;
  fSaldo: Double;
  fSaldoBase: Double;
  fUsar: Double;
  fUsarBase: Double;
  FechaCaduca: TDateTime;
  sFechaCaduca: String;
  sComentario: string;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario        := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID                 := contentfields.values['UUID'];
  IdAprovisionamiento  := StrToIntDef(contentfields.values['IdAprovisionamiento'],0);
  EjercicioTrabajo     := StrToIntDef(contentfields.values['EjercicioTrabajo'],0);
  NumeroTrabajo        := StrToIntDef(contentfields.values['NumeroTrabajo'],0);
  Orden                := StrToIntDef(contentfields.values['Orden'],0);
  CodigoArticulo       := contentfields.values['CodigoArticulo'];
  UbicacionOrigen      := (contentfields.values['UbicacionOrigen']);
  aUbicacionOrigen     := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, UbicacionOrigen );
  UbicacionDestino     := (contentfields.values['UbicacionDestino']);
  aUbicacionDestino    := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, UbicacionDestino );
  YY                   := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );
  Cantidad             := FS_StrToFloatDef(contentfields.values['Cantidad'],0);
  CantidadBase         := FS_StrToFloatDef(contentfields.values['CantidadBase'],0);
  CodigoAgrupacion     := StrToIntDef(contentfields.values['CodigoAgrupacion'],0);
  UnidadesAgrupacion   := FS_StrToFloatDef(contentfields.values['UnidadesAgrupacion'],1);
  Partida              := contentfields.values['Partida'];
  UnidadMedida         := AnsiUpperCase(contentfields.values['UnidadMedida']);
  UnidadMedidaBase     := AnsiUpperCase(contentfields.values['UnidadMedidaBase']);
  FactorConversion     := FS_StrToFloatDef(contentfields.values['FactorConversion'],1);
  GrupoTalla           := StrToIntDef(contentfields.values['GrupoTalla'],0);
  CodigoTalla          := contentfields.values['CodigoTalla'];
  CodigoColor          := contentfields.values['CodigoColor'];
  AutoId               := StrToIntDef(contentfields.values['AutoId'],0);
  sFechaCaduca         := contentfields.Values['FechaCaduca'];

  FS_SGA_Check_UnidadMedidaBase ( Conn, CodigoEmpresa, CodigoArticulo, UnidadMedida, UnidadMedidaBase );

  if (aUbicacionOrigen.CodigoUbicacion='') then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La ubicación de origen es incorrecta","Data":[]}';
    Exit;
  end;

  if (aUbicacionDestino.CodigoUbicacion='') then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La ubicación de destino es incorrecta","Data":[]}';
    Exit;
  end;

  if sFechaCaduca<>'' then
    FechaCaduca := StrToDate(sFechaCaduca)
  else
    FechaCaduca := 0;

  if FechaCaduca=0 then
        sFechaCaduca := 'NULL'
      else
        sFechaCaduca := SQL_DateToStr(FechaCaduca);



  // Calculem el AutoID
  (*
  if AutoId<>0 then
  begin

    sSQL :=
      'SELECT AutoId ' +
      'FROM FS_SGA_Aprovisionamientos_Transito WITH (NOLOCK) ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
      '  AND EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
      '  AND NumeroTrabajo = ' + IntToStr(NumeroTrabajo) + ' ' +
      '  AND Orden = ' + IntToStr(Orden) + ' ' +
      '  AND UbicacionDestino = ''' + SQL_Str(UbicacionOrigen) + ''' ' +
      '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
      '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ';

    AutoID := SQL_Execute ( Conn, sSQL );

    if AutoID=0 then
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Error inesperado al recuperar el movimiento de origen","Data":[]}';
      Exit;
    end;

  end;
  *)

  {$ENDREGION}

  {$REGION 'Recuperació d´informació'}

  sSQL :=
    'SELECT CodigoUbicacionOrigen, CodigoUbicacion ' +
    'FROM FS_SGA_Aprovisionamientos_Detalle WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
    '  AND NumeroTrabajo = ' + IntToStr(NumeroTrabajo) + ' ' +
    '  AND Orden = ' + IntToStr(Orden);
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then
  begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Detalle del aprovisionamiento no encontrado","Data":[]}';
    Exit;
  end;

  UbicacionOrigenFinal  := Q.FieldByName('CodigoUbicacionOrigen').AsString;
  UbicacionDestinoFinal := Q.FieldByName('CodigoUbicacion').AsString;

  Q.Close;
  FreeAndNil(Q);

  sSQL :=
    'SELECT Transito ' +
    'FROM FS_SGA_ESTR_Ubica WITH (NOLOCK) ' +
    'WHERE CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    'AND CodigoUbicacion = ''' + SQL_Str(UbicacionDestino) + '''';
  bTransitoDestino := SQL_Execute ( Conn, sSQL );

  sSQL :=
    'SELECT Transito ' +
    'FROM FS_SGA_ESTR_Ubica WITH (NOLOCK) ' +
    'WHERE CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    'AND CodigoUbicacion = ''' + SQL_Str(UbicacionOrigen) + '''';
  bTransitoOrigen := SQL_Execute ( Conn, sSQL );

  sComentario := '';
  if bTransitoDestino then
    sComentario := 'Aprov. a ubicación de tránsito'
  else if UbicacionDestino=UbicacionDestinoFinal then
    sComentario := 'Aprovisionamiento a ubicación final'
  else begin
    if UbicacionOrigen = UbicacionDestinoFinal then
      sComentario := 'Retirar aprov. de ubicación final'
    else if bTransitoOrigen then
      sComentario := 'Retirar aprov. de ubic. de tránsito';
  end;

  if sComentario='' then
    sComentario := 'Movimiento de aprovisionamiento';

  //bTransitoOrigen  := ( SQL_Execute ( Conn, sSQL ) > 0 );
  //bTransitoDestino := (UbicacionDestino <> UbicacionDestinoFinal);



  {$ENDREGION}

  {$REGION 'Moviments a FS SGA i/o a SAGE'}

  sNewGuid           := SQL_Execute ( Conn, 'SELECT NEWID()' );
  sNewMovOrigen      := SQL_Execute ( Conn, 'SELECT NEWID()' );

  SGA_FS_ALMACEN_PrepareMov ( gaMov );
  gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
  gaMov.EmpresaOrigen          := CodigoEmpresa.EmpresaOrigen;
  gaMov.CodigoUsuario          := CodigoUsuario;
  gaMov.Ejercicio              := YY;
  gaMov.Periodo                := MonthOf(Date());
  gaMov.Fecha                  := Date();
  gaMov.FechaHora              := Now();
  gaMov.CodigoAlmacen          := aUbicacionOrigen.CodigoAlmacen;
  gaMov.CodigoUbicacion        := UbicacionOrigen;
  gaMov.CodigoArticulo         := CodigoArticulo;
  gaMov.Partida                := Partida;
  gaMov.Partida2               := '';
  gaMov.CodigoTalla            := CodigoTalla;
  gaMov.CodigoColor            := CodigoColor;
  gaMov.TipoMovimiento         := 2;
  gaMov.OrigenMovimiento       := 'T';
  gaMov.Unidades               := Cantidad;
  gaMov.UnidadMedida           := AnsiUpperCase(UnidadMedida);
  gaMov.UnidadesBase           := CantidadBase;
  gaMov.UnidadMedidaBase       := AnsiUpperCase(UnidadMedidaBase);
  gaMov.FactorConversion       := FactorConversion;
  gaMov.FechaCaduca            := 0; // dFechaCaduca;
  gaMov.IdProcesoIME           := sNewGuid;
  gaMov.Comentario             := sComentario;
  gaMov.AprovisionamientoId    := IdAprovisionamiento;
  gaMov.MovOrigen              := sNewMovOrigen;
  gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );
  gaMov.FechaCaduca            := FechaCaduca;
  gaMov.TipoMovimientoSGA      := [tmsgaMovimientoStock];
  gaMov.TipoMovimientoSAGE     := [];

  gaMov.Precio :=
    ARTICULO_ConsultarPrecioStock (
      Conn,
      CodigoEmpresa,
      gaMov.CodigoArticulo,
      gaMov.Partida,
      gaMov.CodigoColor,
      gaMov.CodigoTalla,
      gaMov.CodigoAlmacen,
      gaMov.GrupoTalla
    );

  if aUbicacionOrigen.CodigoAlmacen<>aUbicacionDestino.CodigoAlmacen then begin
    gaMov.CodigoAlmacenDestino   := aUbicacionDestino.CodigoAlmacen;
    gaMov.CodigoUbicacionDestino := aUbicacionDestino.CodigoUbicacion;
    gaMov.TipoMovimientoSAGE     := [tmsageMovimientoStock];
  end;

  try
    bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  gaMov.CodigoAlmacen          := aUbicacionDestino.CodigoAlmacen;
  gaMov.CodigoUbicacion        := UbicacionDestino;
  gaMov.TipoMovimiento         := 1;
  gaMov.OrigenMovimiento       := 'T';
  gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );

  gaMov.Precio :=
    ARTICULO_ConsultarPrecioStock (
      Conn,
      CodigoEmpresa,
      gaMov.CodigoArticulo,
      gaMov.Partida,
      gaMov.CodigoColor,
      gaMov.CodigoTalla,
      gaMov.CodigoAlmacen,
      gaMov.GrupoTalla
    );

  if aUbicacionOrigen.CodigoAlmacen<>aUbicacionDestino.CodigoAlmacen then begin
    gaMov.CodigoAlmacenDestino   := aUbicacionOrigen.CodigoAlmacen;
    gaMov.CodigoUbicacionDestino := aUbicacionOrigen.CodigoUbicacion;
    gaMov.TipoMovimientoSAGE     := [];
  end;

  try
    bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  {$ENDREGION}

  {$REGION 'Moviments d´aprovisionament'}

  // Moviment nou. Primer mirem si ja hem fet el mateix moviment amb anterioritat
  sSQL :=
    'SELECT COUNT(*) ' +
    'FROM FS_SGA_Aprovisionamientos_Transito WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
    '  AND EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
    '  AND NumeroTrabajo = ' + IntToStr(NumeroTrabajo) + ' ' +
    '  AND Orden = ' + IntToStr(Orden) + ' ' +
    '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
    '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
    '  AND UbicacionOrigen = ''' + SQL_Str(UbicacionOrigen) + ''' ' +
    '  AND UbicacionDestino = ''' + SQL_Str(UbicacionDestino) + ''' ';

  if SQL_Execute ( Conn, sSQL ) > 0 then
  begin

    // Actualitzem la quantitat d'entrada del registre que hem trobat
    sSQL :=
      'UPDATE FS_SGA_Aprovisionamientos_Transito ' +
      'SET ' +
      '  CantidadEntrada = CantidadEntrada + ' + SQL_FloatToStr(Cantidad) + ', ' +
      '  CantidadEntradaBase = CantidadEntradaBase + ' + SQL_FloatToStr(CantidadBase) + ' ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
      '  AND EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
      '  AND NumeroTrabajo = ' + IntToStr(NumeroTrabajo) + ' ' +
      '  AND Orden = ' + IntToStr(Orden) + ' ' +
      '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
      '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
      '  AND UbicacionOrigen = ''' + SQL_Str(UbicacionOrigen) + ''' ' +
      '  AND UbicacionDestino = ''' + SQL_Str(UbicacionDestino) + ''' ';

    SQL_Execute_NoRes ( Conn, sSQL );

  end else begin

    if FechaCaduca=0 then
      sFechaCaduca := 'NULL'
    else
      sFechaCaduca := SQL_DateToStr(FechaCaduca);

    sSQL :=
      'INSERT INTO FS_SGA_Aprovisionamientos_Transito ( Id, CodigoEmpresa, EjercicioTrabajo, NumeroTrabajo, Orden, ' +
      '  Partida, UnidadMedida, UbicacionOrigen, OrigenTransito, UbicacionDestino, DestinoTransito, UnidadMedidaBase, ' +
      '  FactorConversion, CantidadEntrada, CantidadEntradaBase, CantidadSalida, CantidadSalidaBase, CodigoAgrupacion, ' +
      '  UnidadesAgrupacion, FechaCaduca ) ' +
      'VALUES ( ' +
      IntToStr(IdAprovisionamiento) + ', ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(EjercicioTrabajo) + ', ' +
      IntToStr(NumeroTrabajo) + ', ' +
      IntToStr(Orden) + ', ' +
      '''' + SQL_Str(Partida) + ''', ' +
      '''' + SQL_Str(UnidadMedida) + ''', ' +
      '''' + SQL_Str(UbicacionOrigen) + ''', ' +
      SQL_BooleanToStr(bTransitoOrigen) + ', ' +
      '''' + SQL_Str(UbicacionDestino) + ''', ' +
      SQL_BooleanToStr(bTransitoDestino) + ', ' +
      '''' + SQL_Str(UnidadMedidaBase) + ''', ' +
      SQL_FloatToStr(FactorConversion) + ', ' +
      SQL_FloatToStr(Cantidad) + ', ' +
      SQL_FloatToStr(CantidadBase) + ', ' +
      '0, ' +
      '0, ' +
      IntToStr(CodigoAgrupacion) + ', ' +
      SQL_FloatToStr(UnidadesAgrupacion) + ', ' +
      sFechaCaduca + ' ' +
      ')';

    SQL_Execute_NoRes ( Conn, sSQL );

  end;

  sSQL :=
    'SELECT * ' +
    'FROM FS_SGA_Aprovisionamientos_Transito WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
    '  AND EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
    '  AND NumeroTrabajo = ' + IntToStr(NumeroTrabajo) + ' ' +
    '  AND Orden = ' + IntToStr(Orden) + ' ' +
    '  AND UbicacionDestino = ''' + SQL_Str(UbicacionOrigen) + ''' ' +
    '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
    '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
    '  AND CantidadSaldoBase > 0 ' +
    'ORDER BY ' +
    '  AutoId DESC';
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  bEnd := Q.EOF;

  while not bEnd do
  begin

    iAutoID    := Q.FieldByName('AutoID').AsInteger;
    fSaldo     := Q.FieldByName('CantidadSaldo').AsFloat;
    fSaldoBase := Q.FieldByName('CantidadSaldoBase').AsFloat;

    if fSaldo >= Cantidad then
      fUsar := Cantidad
    else
      fUsar := fSaldo;

    if fSaldoBase >= CantidadBase then
      fUsarBase := CantidadBase
    else
      fUsarBase := fSaldoBase;

    sSQL :=
      'UPDATE FS_SGA_Aprovisionamientos_Transito ' +
      'SET ' +
      '  CantidadSalida = CantidadSalida + ' + SQL_FloatToStr(fUsar) + ', ' +
      '  CantidadSalidaBase = CantidadSalidaBase + ' + SQL_FloatToStr(fUsarBase) + ' ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
      '  AND EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
      '  AND NumeroTrabajo = ' + IntToStr(NumeroTrabajo) + ' ' +
      '  AND Orden = ' + IntToStr(Orden) + ' ' +
      '  AND AutoId = ' + IntToStr(iAutoId);
    SQL_Execute_NoRes ( Conn, sSQL );

    Cantidad := Cantidad - fUsar;
    CantidadBase := CantidadBase - fUsarBase;

    Q.Next;

    bEnd := (Q.Eof) or ((Cantidad=0) and (CantidadBase=0));

  end;

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

  LP := LOG_Clear();
  LP.IdAprovisionamiento := IdAprovisionamiento;
  LP.MovOrigen := gaMov.MovOrigen;
  LP.Matricula := gaMov.Matricula;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'APROV-MOVE', 'Realizar aprovisionamiento en la ubicación ' + gaMov.CodigoUbicacion, @LP );

  Result := '{"Result":"OK","Error":"","Data":[]}';

end;


procedure WebModule1finishTransitosAprovisionamientoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdAprovisionamiento: Integer;
  EjercicioTrabajo: Integer;
  NumeroTrabajo: Integer;
  Orden: Integer;
  AutoId: Integer;
  UbicacionOrigen: String;
  UbicacionDestino: String;
  Cantidad: Double;
  CantidadBase: Double;
  FactorConversion: Double;
  UnidadMedida: String;
  UnidadMedidaBase: String;
  GrupoTalla: Integer;
  CodigoTalla: String;
  CodigoColor: String;
  CodigoAgrupacion: Integer;
  UnidadesAgrupacion: Double;
  gaMov: TSGAMovimientoStock;
  YY: WORD;
  aUbicacionDestino: TSGAUbicacion;
  aUbicacionOrigen: TSGAUbicacion;
  CodigoArticulo: String;
  Partida: String;
  sNewGuid: String;
  sNewMovOrigen: String;
  bErr: Boolean;
  sMsg: String;
  sCustomProc: string;
  UbicacionFinal: String;
  UbicacionTransito: String;
  sFechaCaduca: String;
  FechaCaduca: TDateTime;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario       := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID                := contentfields.values['UUID'];
  IdAprovisionamiento := StrToIntDef(contentfields.values['IdAprovisionamiento'],0);
  EjercicioTrabajo    := StrToIntDef(contentfields.values['EjercicioTrabajo'],0);
  NumeroTrabajo       := StrToIntDef(contentfields.values['NumeroTrabajo'],0);
  Orden               := StrToIntDef(contentfields.values['Orden'],0);
  Partida             := contentfields.Values['Partida'];
  UnidadMedida        := AnsiUpperCase(contentfields.Values['UnidadMedida']);
  UbicacionOrigen     := contentfields.Values['UbicacionDestino'];
  YY                  := SGA_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  {$ENDREGION}

  {$REGION 'Finalitzem tots els articles que estan en trànsit de l´aprovisionament'}

  sSQL :=
    'SELECT ' +
    '  FSAT.*, FSAD.CodigoUbicacion AS UbicacionFinal, ' +
    '  FSAD.ArticuloComponente, ART.GrupoTalla_, FSAD.CodigoTalla01_, ' +
    '  FSAD.CodigoColor_ ' +
    'FROM FS_SGA_Aprovisionamientos_Transito FSAT WITH (NOLOCK) ' +
    'INNER JOIN FS_SGA_Aprovisionamientos_Detalle FSAD WITH (NOLOCK) ' +
    'ON ' +
    '  FSAT.Id = FSAD.Id ' +
    '  AND FSAT.EjercicioTrabajo = FSAD.EjercicioTrabajo ' +
    '  AND FSAT.NumeroTrabajo = FSAD.NumeroTrabajo ' +
    '  AND FSAT.Orden = FSAD.Orden ' +
    'INNER JOIN Articulos ART WITH (NOLOCK) ' +
    'ON ' +
    '  ART.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '  AND ART.CodigoArticulo = FSAD.ArticuloComponente ' +
    'WHERE ' +
    '  FSAT.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND FSAT.Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
    '  AND (FSAT.CantidadSaldo<>0 OR FSAT.CantidadSaldoBase<>0) ' +
    '  AND FSAT.UbicacionDestino <> FSAD.CodigoUbicacion ' +
    '  AND FSAT.DestinoTransito <> 0 ';

  if EjercicioTrabajo<>0 then
  begin
    sSQL := sSQL +
      '  AND FSAT.EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
      '  AND FSAT.NumeroTrabajo = ' + IntToStr(NumeroTrabajo) + ' ' +
      '  AND FSAT.Orden = ' + IntToStr(Orden) + ' ';
  end;

  if UbicacionOrigen <> '' then
  begin
    sSQL := sSQL +
      '  AND FSAT.Partida = ''' + SQL_Str(Partida) + ''' ' +
      '  AND FSAT.UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
      '  AND FSAT.UbicacionDestino = ''' + SQL_Str(UbicacionOrigen) + ''' ';
  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  while not Q.EOF do
  begin

    AutoId            := Q.FieldByName('AutoId').AsInteger;
    UbicacionTransito := Q.FieldByName('UbicacionDestino').AsString;
    UbicacionFinal    := Q.FieldByName('UbicacionFinal').AsString;
    Cantidad          := Q.FieldByName('CantidadSaldo').AsFloat;
    CantidadBase      := Q.FieldByName('CantidadSaldoBase').AsFloat;
    Partida           := Q.FieldByName('Partida').AsString;
    UnidadMedida      := AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString);
    UnidadMedidaBase  := AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString);
    FactorConversion  := Q.FieldByName('FactorConversion').AsFloat;
    EjercicioTrabajo  := Q.FieldByName('EjercicioTrabajo').AsInteger;
    NumeroTrabajo     := Q.FieldByName('NumeroTrabajo').AsInteger;
    Orden             := Q.FieldByName('Orden').AsInteger;
    GrupoTalla        := Q.FieldByName('GrupoTalla_').AsInteger;
    CodigoTalla       := Q.FieldByName('CodigoTalla01_').AsString;
    CodigoColor       := Q.FieldByName('CodigoColor_').AsString;
    CodigoArticulo    := Q.FieldByName('ArticuloComponente').AsString;
    FechaCaduca       := Q.FieldByName('FechaCaduca').AsDateTime;

    aUbicacionOrigen  := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, UbicacionTransito );
    aUbicacionDestino := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, UbicacionFinal );

    {$REGION '--- Fem moviments d´stock'}

    sNewGuid           := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sNewMovOrigen      := SQL_Execute ( Conn, 'SELECT NEWID()' );

    SGA_FS_ALMACEN_PrepareMov ( gaMov );
    gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
    gaMov.EmpresaOrigen          := CodigoEmpresa.EmpresaOrigen;
    gaMov.CodigoUsuario          := CodigoUsuario;
    gaMov.Ejercicio              := YY;
    gaMov.Periodo                := MonthOf(Date());
    gaMov.Fecha                  := Date();
    gaMov.FechaHora              := Now();
    gaMov.CodigoAlmacen          := aUbicacionOrigen.CodigoAlmacen;
    gaMov.CodigoUbicacion        := aUbicacionOrigen.CodigoUbicacion;
    gaMov.CodigoArticulo         := CodigoArticulo;
    gaMov.Partida                := Partida;
    gaMov.Partida2               := '';
    gaMov.CodigoTalla            := CodigoTalla;
    gaMov.CodigoColor            := CodigoColor;
    gaMov.TipoMovimiento         := 2;
    gaMov.OrigenMovimiento       := 'T';
    gaMov.Unidades               := Cantidad;
    gaMov.UnidadMedida           := AnsiUpperCase(UnidadMedida);
    gaMov.UnidadesBase           := CantidadBase;
    gaMov.UnidadMedidaBase       := AnsiUpperCase(UnidadMedidaBase);
    gaMov.FactorConversion       := FactorConversion;
    gaMov.FechaCaduca            := FechaCaduca;
    gaMov.IdProcesoIME           := sNewGuid;
    gaMov.Comentario             := 'Aprovisionamiento a ubicación final';
    gaMov.AprovisionamientoId    := IdAprovisionamiento;
    gaMov.MovOrigen              := sNewMovOrigen;
    gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );
    gaMov.TipoMovimientoSGA      := [tmsgaMovimientoStock];
    gaMov.TipoMovimientoSAGE     := [];

    gaMov.Precio :=
      ARTICULO_ConsultarPrecioStock (
        Conn,
        CodigoEmpresa,
        gaMov.CodigoArticulo,
        gaMov.Partida,
        gaMov.CodigoColor,
        gaMov.CodigoTalla,
        gaMov.CodigoAlmacen,
        gaMov.GrupoTalla
      );

    if aUbicacionOrigen.CodigoAlmacen<>aUbicacionDestino.CodigoAlmacen then begin
      gaMov.CodigoAlmacenDestino   := aUbicacionDestino.CodigoAlmacen;
      gaMov.CodigoUbicacionDestino := aUbicacionDestino.CodigoUbicacion;
      gaMov.TipoMovimientoSAGE     := [tmsageMovimientoStock];
    end;

    try
      bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message;
      end;
    end;

    gaMov.CodigoAlmacen          := aUbicacionDestino.CodigoAlmacen;
    gaMov.CodigoUbicacion        := aUbicacionDestino.CodigoUbicacion;
    gaMov.TipoMovimiento         := 1;
    gaMov.OrigenMovimiento       := 'T';
    gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );

    gaMov.Precio :=
      ARTICULO_ConsultarPrecioStock (
        Conn,
        CodigoEmpresa,
        gaMov.CodigoArticulo,
        gaMov.Partida,
        gaMov.CodigoColor,
        gaMov.CodigoTalla,
        gaMov.CodigoAlmacen,
        gaMov.GrupoTalla
      );

    if aUbicacionOrigen.CodigoAlmacen<>aUbicacionDestino.CodigoAlmacen then begin
      gaMov.CodigoAlmacenDestino   := aUbicacionOrigen.CodigoAlmacen;
      gaMov.CodigoUbicacionDestino := aUbicacionOrigen.CodigoUbicacion;
      gaMov.TipoMovimientoSAGE     := [];
    end;

    try
      bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message;
      end;
    end;

    {$ENDREGION}

    sSQL :=
      'UPDATE FS_SGA_Aprovisionamientos_Transito ' +
      'SET ' +
      '  CantidadSalida = CantidadSalida + ' + SQL_FloatToStr(Cantidad) + ', ' +
      '  CantidadSalidaBase = CantidadSalidaBase + ' + SQL_FloatToStr(Cantidad) + ' ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
      '  AND AutoId = ' + IntToStr(AutoId);
    SQL_Execute_NoRes ( Conn, sSQL );

    sSQL :=
      'SELECT COUNT(*) ' +
      'FROM FS_SGA_Aprovisionamientos_Transito WITH (NOLOCK) ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
      '  AND NumeroTrabajo = ' + IntToStr(NumeroTrabajo) + ' ' +
      '  AND Orden = ' + IntToStr(Orden) + ' ' +
      '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
      '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
      '  AND UbicacionOrigen = ''' + SQL_Str(UbicacionTransito) + ''' ' +
      '  AND UbicacionDestino = ''' + SQL_Str(UbicacionFinal) + ''' ';

    if SQL_Execute ( Conn, sSQL ) > 0 then
    begin

      sSQL :=
        'UPDATE FS_SGA_Aprovisionamientos_Transito ' +
        'SET ' +
        '  CantidadEntrada = CantidadEntrada + ' + SQL_FloatToStr(Cantidad) + ', ' +
        '  CantidadEntradaBase = CantidadEntradaBase + ' + SQL_FloatToStr(Cantidad) + ' ' +
        'WHERE ' +
        '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
        '  AND EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
        '  AND NumeroTrabajo = ' + IntToStr(NumeroTrabajo) + ' ' +
        '  AND Orden = ' + IntToStr(Orden) + ' ' +
        '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
        '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
        '  AND UbicacionOrigen = ''' + SQL_Str(UbicacionTransito) + ''' ' +
        '  AND UbicacionDestino = ''' + SQL_Str(UbicacionFinal) + ''' ';
      SQL_Execute_NoRes ( Conn, sSQL );

    end else begin

      if FechaCaduca=0 then
        sFechaCaduca := 'NULL'
      else
        sFechaCaduca := SQL_DateToStr(FechaCaduca);

      sSQL :=
        'INSERT INTO FS_SGA_Aprovisionamientos_Transito ( Id, CodigoEmpresa, EjercicioTrabajo, NumeroTrabajo, Orden, ' +
        '  Partida, UnidadMedida, UbicacionOrigen, OrigenTransito, UbicacionDestino, DestinoTransito, UnidadMedidaBase, ' +
        '  FactorConversion, CantidadEntrada, CantidadEntradaBase, CantidadSalida, CantidadSalidaBase, CodigoAgrupacion, ' +
        '  UnidadesAgrupacion, FechaCaduca ) ' +
        'VALUES ( ' +
        IntToStr(IdAprovisionamiento) + ', ' +
        IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
        IntToStr(EjercicioTrabajo) + ', ' +
        IntToStr(NumeroTrabajo) + ', ' +
        IntToStr(Orden) + ', ' +
        '''' + SQL_Str(Partida) + ''', ' +
        '''' + SQL_Str(UnidadMedida) + ''', ' +
        '''' + SQL_Str(UbicacionTransito) + ''', ' +
        SQL_BooleanToStr(True) + ', ' +
        '''' + SQL_Str(UbicacionFinal) + ''', ' +
        SQL_BooleanToStr(False) + ', ' +
        '''' + SQL_Str(UnidadMedidaBase) + ''', ' +
        SQL_FloatToStr(FactorConversion) + ', ' +
        SQL_FloatToStr(Cantidad) + ', ' +
        SQL_FloatToStr(CantidadBase) + ', ' +
        '0, ' +
        '0, ' +
        IntToStr(0) + ', ' +
        SQL_FloatToStr(1) + ', ' +
        sFechaCaduca + ' ' +
        ')';
      SQL_Execute_NoRes ( Conn, sSQL );

    end;

    Q.Next;

  end;

  Q.Close;
  FreeAndNil(Q);

  LP := LOG_Clear();
  LP.IdAprovisionamiento := IdAprovisionamiento;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'FINIS-ALL-APROV', 'Finalizar todos los artículos en tránsito del aprovisionamiento', @LP );

  Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1refreshRutaAprovisionamientoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdAprovisionamiento: Integer;
  EjercicioTrabajo: Integer;
  NumeroTrabajo: Integer;
  Orden: Integer;
  AutoId: Integer;
  UbicacionOrigen: String;
  UbicacionDestino: String;
  Cantidad: Double;
  CantidadBase: Double;
  FactorConversion: Double;
  UnidadMedida: String;
  UnidadMedidaBase: String;
  GrupoTalla: Integer;
  CodigoTalla: String;
  CodigoColor: String;
  CodigoAgrupacion: Integer;
  UnidadesAgrupacion: Double;
  gaMov: TSGAMovimientoStock;
  YY: WORD;
  aUbicacionDestino: TSGAUbicacion;
  aUbicacionOrigen: TSGAUbicacion;
  CodigoArticulo: String;
  Partida: String;
  sNewGuid: String;
  sNewMovOrigen: String;
  bErr: Boolean;
  sMsg: String;
  sCustomProc: string;
  CodigoAlmacen: String;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario       := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID                 := contentfields.values['UUID'];
  IdAprovisionamiento := StrToIntDef(contentfields.values['IdAprovisionamiento'],0);
  YY                  := SAGE_Fecha_AnoActivo ( Conn, CodigoEmpresa, Now() );
  CodigoAlmacen       := contentfields.Values['CodigoAlmacen'];

  {$ENDREGION}

  {$REGION 'Recalcular ruta de l´aprovisionament'}

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_RecalcularRutaAprovisionamiento', sCustomProc ) then
  begin

    sSQL :=
      'EXEC dbo.[' + sCustomProc + '] ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(IdAprovisionamiento) + ', ' +
      IntToStr(YY) + ', ' +
      '''' + SQL_Str(CodigoAlmacen) + '''';

    try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E:Exception do
      begin
        Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '","Data":[]}';
        Exit;
      end;
    end;

  end;

  LP := LOG_Clear();
  LP.IdAprovisionamiento := IdAprovisionamiento;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'REFRESH-APROV-ROUTE', 'Recalcular ruta del aprovisionamiento', @LP );

  Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1moveAprovisionamientoToEndAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdAprovisionamiento: Integer;
  EjercicioTrabajo: Integer;
  NumeroTrabajo: Integer;
  Orden: Integer;
  AutoId: Integer;
  UbicacionOrigen: String;
  UbicacionDestino: String;
  Cantidad: Double;
  CantidadBase: Double;
  FactorConversion: Double;
  UnidadMedida: String;
  UnidadMedidaBase: String;
  GrupoTalla: Integer;
  CodigoTalla: String;
  CodigoColor: String;
  CodigoAgrupacion: Integer;
  UnidadesAgrupacion: Double;
  gaMov: TSGAMovimientoStock;
  YY: WORD;
  aUbicacionDestino: TSGAUbicacion;
  aUbicacionOrigen: TSGAUbicacion;
  CodigoArticulo: String;
  Partida: String;
  sNewGuid: String;
  sNewMovOrigen: String;
  bErr: Boolean;
  sMsg: String;
  FechaCaduca: TDateTime;
  sFechaCaduca: String;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario        := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID                 := contentfields.values['UUID'];
  IdAprovisionamiento  := StrToIntDef(contentfields.values['IdAprovisionamiento'],0);
  EjercicioTrabajo     := StrToIntDef(contentfields.values['EjercicioTrabajo'],0);
  NumeroTrabajo        := StrToIntDef(contentfields.values['NumeroTrabajo'],0);
  Orden                := StrToIntDef(contentfields.values['Orden'],0);
  AutoId               := StrToIntDef(contentfields.values['AutoId'],0);
  UbicacionDestino     := (contentfields.values['UbicacionDestino']);
  aUbicacionDestino    := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, UbicacionDestino );
  YY                   := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  {$ENDREGION}

  {$REGION 'Recuperació d´informació'}

  sSQL :=
    'SELECT ' +
    '  FSAT.*, FSAD.ArticuloComponente, FSAD.GrupoTalla_, FSAD.CodigoTalla01_, FSAD.CodigoColor_ ' +
    'FROM FS_SGA_Aprovisionamientos_Transito FSAT WITH (NOLOCK) ' +
    'INNER JOIN FS_SGA_Aprovisionamientos_Detalle FSAD WITH (NOLOCK) ' +
    'ON ' +
    '  FSAT.CodigoEmpresa = FSAT.CodigoEmpresa ' +
    '  AND FSAT.Id = FSAD.Id ' +
    '  AND FSAT.EjercicioTrabajo = FSAD.EjercicioTrabajo ' +
    '  AND FSAT.NumeroTrabajo = FSAD.NumeroTrabajo ' +
    '  AND FSAT.Orden = FSAD.Orden ' +
    'WHERE ' +
    '  FSAT.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND FSAT.Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
    '  AND FSAT.EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
    '  AND FSAT.NumeroTrabajo = ' + IntToStr(NumeroTrabajo) + ' ' +
    '  AND FSAT.Orden = ' + IntToStr(Orden) + ' ' +
    '  AND FSAT.AutoId = ' + IntToStr(AutoId);

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Q.EOF then
  begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Error en los datos para realizar el aprovisionamiento","Data":[]}';
    Exit;
  end;

  Cantidad           := Q.FieldByName('CantidadSaldo').AsFloat;
  CantidadBase       := Q.FieldByName('CantidadSaldoBase').AsFloat;
  CodigoAgrupacion   := Q.FieldByName('CodigoAgrupacion').AsInteger;
  UnidadesAgrupacion := Q.FieldByName('UnidadesAgrupacion').AsFloat;
  UnidadMedida       := AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString);
  UnidadMedidaBase   := AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString);
  UbicacionOrigen    := Q.FieldByName('UbicacionDestino').AsString;
  CodigoArticulo     := Q.FieldByName('ArticuloComponente').AsString;
  GrupoTalla         := Q.FieldByName('GrupoTalla_').AsInteger;
  CodigoTalla        := Q.FieldByName('CodigoTalla01_').AsString;
  CodigoColor        := Q.FieldByName('CodigoColor_').AsString;
  Partida            := Q.FieldByName('Partida').AsString;
  FechaCaduca        := Q.FieldByName('FechaCaduca').AsDateTime;
  aUbicacionOrigen   := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, UbicacionOrigen );
  sNewGuid           := SQL_Execute ( Conn, 'SELECT NEWID()' );
  sNewMovOrigen      := SQL_Execute ( Conn, 'SELECT NEWID()' );

  Q.Close;
  FreeAndNil(Q);

  SGA_FS_ALMACEN_PrepareMov ( gaMov );
  gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
  gaMov.EmpresaOrigen          := CodigoEmpresa.EmpresaOrigen;
  gaMov.CodigoUsuario          := CodigoUsuario;
  gaMov.Ejercicio              := YY;
  gaMov.Periodo                := MonthOf(Date());
  gaMov.Fecha                  := Date();
  gaMov.FechaHora              := Now();
  gaMov.CodigoAlmacen          := aUbicacionOrigen.CodigoAlmacen;
  gaMov.CodigoUbicacion        := UbicacionOrigen;
  gaMov.CodigoArticulo         := CodigoArticulo;
  gaMov.Partida                := Partida;
  gaMov.Partida2               := '';
  gaMov.GrupoTalla             := GrupoTalla;
  gaMov.CodigoTalla            := CodigoTalla;
  gaMov.CodigoColor            := CodigoColor;
  gaMov.TipoMovimiento         := 2;
  gaMov.OrigenMovimiento       := 'T';
  gaMov.Unidades               := Cantidad;
  gaMov.UnidadMedida           := AnsiUpperCase(UnidadMedida);
  gaMov.UnidadesBase           := CantidadBase;
  gaMov.UnidadMedidaBase       := AnsiUpperCase(UnidadMedidaBase);
  gaMov.FactorConversion       := FactorConversion;
  gaMov.FechaCaduca            := 0; // dFechaCaduca;
  gaMov.IdProcesoIME           := sNewGuid;
  gaMov.Comentario             := 'Aprovisionamiento a ubicación final';
  gaMov.AprovisionamientoId    := IdAprovisionamiento;
  gaMov.MovOrigen              := sNewMovOrigen;
  gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );
  gaMov.TipoMovimientoSGA      := [tmsgaMovimientoStock];
  gaMov.TipoMovimientoSAGE     := [];

  gaMov.Precio :=
    ARTICULO_ConsultarPrecioStock (
      Conn,
      CodigoEmpresa,
      gaMov.CodigoArticulo,
      gaMov.Partida,
      gaMov.CodigoColor,
      gaMov.CodigoTalla,
      gaMov.CodigoAlmacen,
      gaMov.GrupoTalla
    );

  if aUbicacionOrigen.CodigoAlmacen<>aUbicacionDestino.CodigoAlmacen then begin
    gaMov.CodigoAlmacenDestino   := aUbicacionDestino.CodigoAlmacen;
    gaMov.CodigoUbicacionDestino := aUbicacionDestino.CodigoUbicacion;
    gaMov.TipoMovimientoSAGE     := [tmsageMovimientoStock];
  end;

  try
    bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  gaMov.CodigoAlmacen          := aUbicacionDestino.CodigoAlmacen;
  gaMov.CodigoUbicacion        := UbicacionDestino;
  gaMov.TipoMovimiento         := 1;
  gaMov.OrigenMovimiento       := 'T';
  gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );

  gaMov.Precio :=
    ARTICULO_ConsultarPrecioStock (
      Conn,
      CodigoEmpresa,
      gaMov.CodigoArticulo,
      gaMov.Partida,
      gaMov.CodigoColor,
      gaMov.CodigoTalla,
      gaMov.CodigoAlmacen,
      gaMov.GrupoTalla
    );

  if aUbicacionOrigen.CodigoAlmacen<>aUbicacionDestino.CodigoAlmacen then begin
    gaMov.CodigoAlmacenDestino   := aUbicacionOrigen.CodigoAlmacen;
    gaMov.CodigoUbicacionDestino := aUbicacionOrigen.CodigoUbicacion;
    gaMov.TipoMovimientoSAGE     := [];
  end;

  try
    bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  sSQL :=
    'UPDATE FS_SGA_Aprovisionamientos_Transito ' +
    'SET ' +
    '  CantidadSalida = CantidadSalida + ' + SQL_FloatToStr(Cantidad) + ', ' +
    '  CantidadSalidaBase = CantidadSalidaBase + ' + SQL_FloatToStr(CantidadBase) + ' ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
    '  AND EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
    '  AND NumeroTrabajo = ' + IntToStr(NumeroTrabajo) + ' ' +
    '  AND Orden = ' + IntToStr(Orden) + ' ' +
    '  AND AutoId = ' + IntToStr(AutoId);

  SQL_Execute_NoRes ( Conn, sSQL );

  sSQL :=
    'SELECT COUNT(*) ' +
    'FROM FS_SGA_Aprovisionamientos_Transito FSAT WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
    '  AND EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
    '  AND NumeroTrabajo = ' + IntToStr(NumeroTrabajo) + ' ' +
    '  AND Orden = ' + IntToStr(Orden) + ' ' +
    '  AND UbicacionOrigen = ''' + SQL_Str(UbicacionOrigen) + ''' ' +
    '  AND UbicacionDestino = ''' + SQL_Str(UbicacionDestino) + ''' ' +
    '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
    '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + '''';

  if SQL_Execute ( Conn, sSQL ) > 0 then
  begin
    sSQL :=
      'UPDATE FS_SGA_Aprovisionamientos_Transito ' +
      'SET ' +
      '  CantidadEntrada = CantidadEntrada + ' + SQL_FloatToStr(Cantidad) + ', ' +
      '  CantidadEntradaBase = CantidadEntradaBase + ' + SQL_FloatToStr(CantidadBase) + ' ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
      '  AND EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
      '  AND NumeroTrabajo = ' + IntToStr(NumeroTrabajo) + ' ' +
      '  AND Orden = ' + IntToStr(Orden) + ' ' +
      '  AND UbicacionOrigen = ''' + SQL_Str(UbicacionOrigen) + ''' ' +
      '  AND UbicacionDestino = ''' + SQL_Str(UbicacionDestino) + ''' ' +
      '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
      '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + '''';
  end else begin

    if FechaCaduca=0 then
      sFechaCaduca := 'NULL'
    else
      sFechaCaduca := SQL_DateToStr(FechaCaduca);

    sSQL :=
      'INSERT INTO FS_SGA_Aprovisionamientos_Transito ( Id, CodigoEmpresa, EjercicioTrabajo, NumeroTrabajo, Orden, ' +
      '  Partida, UnidadMedida, UbicacionOrigen, OrigenTransito, UbicacionDestino, DestinoTransito, UnidadMedidaBase, ' +
      '  FactorConversion, CantidadEntrada, CantidadEntradaBase, CantidadSalida, CantidadSalidaBase, CodigoAgrupacion, ' +
      '  UnidadesAgrupacion ) ' +
      'VALUES ( ' +
      IntToStr(IdAprovisionamiento) + ', ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(EjercicioTrabajo) + ', ' +
      IntToStr(NumeroTrabajo) + ', ' +
      IntToStr(Orden) + ', ' +
      '''' + SQL_Str(Partida) + ''', ' +
      '''' + SQL_Str(UnidadMedida) + ''', ' +
      '''' + SQL_Str(UbicacionOrigen) + ''', ' +
      '1, ' +
      '''' + SQL_Str(UbicacionDestino) + ''', ' +
      '0, ' +
      '''' + SQL_Str(UnidadMedidaBase) + ''', ' +
      SQL_FloatToStr(FactorConversion) + ', ' +
      SQL_FloatToStr(Cantidad) + ', ' +
      SQL_FloatToStr(CantidadBase) + ', ' +
      '0, ' +
      '0, ' +
      IntToStr(CodigoAgrupacion) + ', ' +
      SQL_FloatToStr(UnidadesAgrupacion) + ', ' +
      sFechaCaduca + ' ' +
      ')';
  end;

  SQL_Execute_NoRes ( Conn, sSQL );

  LP := LOG_Clear();
  LP.IdAprovisionamiento := IdAprovisionamiento;
  LP.MovOrigen := gaMov.MovOrigen;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'MOVE-APROV-END', 'Mover aprovisionamiento a la ubicación ' + gaMov.CodigoUbicacion + ' de destino', @LP );

  Result := '{"Result":"OK","Error":"","Data":[]}';

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAR APROVISIONAMENT                                               │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listAprovisionamientoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Tipo: Integer;
  Estado: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Filter: String;
  sAndWhere: String;
  sSort: String;
  sSortType: String;
  EmpresaOrigen: Integer;
  ProvisId: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  sFechaInicioPreparacion, sFechaFinPreparacion: string;
  sPROCCustom: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}
  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  Tipo          := StrToIntDef(contentfields.values['Tipo'],-1);
  ProvisId      := StrToIntDef(contentfields.values['Id'],0);

  sSort := AnsiLowerCase((contentfields.Values['OrdenarPor']));
  sSortType := AnsiLowerCase((contentfields.Values['TipoOrden']));

  if (sSort='fecha') then
    sSort := ' p.fechacreacion '
  else if (sSort='prioridad') then
    sSort := ' p.prioridad '
  else
    sSort := ' p.Id ';

  if sSortType='desc' then
    sSort := sSort + ' DESC ';

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_ListAprovisionamientos', sPROCCustom) then
  begin

    sSQL := 'EXEC dbo.[' + sPROCCustom + '] ' +
      IntToStr(EmpresaOrigen) + ', ' +
      IntToStr(CodigoUsuario) + ', ' +
      IntToStr(Tipo) + ', ' +
      '0, ' +
      '99999, ' +
      IntToStr(ProvisId);

    Q := SQL_PrepareQuery ( Conn, sSQL );
    try
      Q.Open;
      iTotalRegs := Q.RecordCount;
    except
      iTotalRegs := 0;
    end;
    Q.Close;
    FreeAndNil(Q);

  end else begin

    sAndWhere := '';

    if ProvisId<>0 then begin
      sAndWhere := sAndWhere + 'AND p.Id = ' + IntToStr(ProvisId) + ' ';
    end;

    if Tipo<>-1 then begin
      sAndWhere := sAndWhere + 'AND p.Estado = ' + IntToStr(Tipo) + ' ';
    end;

    sSQL := 'SELECT ' +
            '  COUNT(DISTINCT p.Id) ' +
            'FROM FS_SGA_Aprovisionamientos p WITH (NOLOCK) ' +
            'LEFT JOIN FS_SGA_Operarios_Aprovisionamiento fsop WITH (NOLOCK) ' +
            'ON ' +
            '  fsop.CodigoEmpresa = p.CodigoEmpresa ' +
            '  AND fsop.AprovisionamientoId = p.Id ' +
            'WHERE ' +
            '  p.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ';

    if (CodigoUsuario>1) then
      sSQL := sSQL + 'AND fsop.OperarioId = ' + IntToStr(CodigoUsuario) + ' ';

    sSQL := sSQL + sAndWhere;

    try
      iTotalRegs := SQL_Execute ( Conn, sSQL );
    except
      on E:Exception do begin
        Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
        Exit;
      end;
    end;

  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_ListAprovisionamientos', sPROCCustom) then
  begin

    sSQL := 'EXEC dbo.[' + sPROCCustom + '] ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(CodigoUsuario) + ', ' +
      IntToStr(Tipo) + ', ' +
      IntToStr(iPage*iPageSize) + ', ' +
      IntToStr(iPageSize) + ', ' +
      IntToStr(ProvisId);

  end else begin

    sSQL := 'SELECT DISTINCT ' +
            '  p.*, fsop.OperarioId ' +
            'FROM FS_SGA_Aprovisionamientos p WITH ( NOLOCK ) ' +
            'LEFT JOIN FS_SGA_Operarios_Aprovisionamiento fsop WITH (NOLOCK) ' +
            'ON ' +
            '  fsop.CodigoEmpresa = p.CodigoEmpresa ' +
            '  AND fsop.AprovisionamientoId = p.Id ';

    sSQL := sSQL + 'WHERE ' +
            '  p.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
            sAndWhere + ' ';

    if (CodigoUsuario>1) then
      sSQL := sSQL + 'AND fsop.OperarioId = ' + IntToStr(CodigoUsuario) + ' ';

    sSQL := sSQL + 'ORDER BY ' +
            sSort +
            'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
            'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"Estado":' + Q.FieldByName('Estado').AsString + ',' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"Id":' + Q.FieldByName('Id').AsString + ',' +
      '"EjercicioFabricacion":' + IntToStr(Q.FieldByName('EjercicioFabricacion').AsInteger) + ',' +
      '"SerieFabricacion":"' + JSON_Str(Q.FieldByName('SerieFabricacion').AsString) + '",' +
      '"NumeroFabricacion":' + IntToStr(Q.FieldByName('NumeroFabricacion').AsInteger) + ',' +
      '"EjercicioTrabajo":' + IntToStr(Q.FieldByName('EjercicioTrabajo').AsInteger) + ',' +
      '"NumeroTrabajo":' + IntToStr(Q.FieldByName('NumeroTrabajo').AsInteger) + ', ' +
      '"Prioridad":' + IntToStr(Q.FieldByName('prioridad').AsInteger) + ',' +
      '"Observaciones":"' + JSON_Str(Q.FieldByName('Observaciones').AsString) + '",' +
      '"CentroTrabajo":"' + JSON_Str(Q.FieldByName('CentroTrabajo').AsString) + '",' +
      '"FechaCreacion":"' + FormatDateTime ( 'dd/mm/yyyy', Q.FieldByName('fechacreacion').AsDateTime) + '",' +
      '"Ejercicio":' + IntToStr(Q.FieldByName('Ejercicio').AsInteger) +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;




procedure WebModule1detalleAprovisionamientoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdAprovisionamiento: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  contentfields: TStringList;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  IdAprovisionamiento := StrToIntDef(contentfields.values['Id'],0);
  if IdAprovisionamiento=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de aprovisionamiento no especificado","Data":[]}';
    Exit;
  end;

  OrdenarPor := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden  := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy   := '';

  if OrdenarPor='ARTICULO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'ArticuloComponente DESC, Partida DESC ';
    end else begin
      sOrderBy := 'ArticuloComponente, Partida ';
    end;
  end else if OrdenarPor='CENTROTRABAJO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'CentroTrabajo DESC, ArticuloComponente DESC, Partida DESC ';
    end else begin
      sOrderBy := 'CentroTrabajo, ArticuloComponente, Partida ';
    end;
  end else if OrdenarPor='CODIGOUBICACION' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'CodigoUbicacion DESC ';
    end else begin
      sOrderBy := 'CodigoUbicacion ';
    end;
  end else if OrdenarPor='CODIGOUBICACIONALTERNATIVO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'CodigoUbicacionAlternativo DESC ';
    end else begin
      sOrderBy := 'CodigoUbicacionAlternativo ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'ArticuloComponente DESC, Partida DESC ';
    end else begin
      sOrderBy := 'ArticuloComponente, Partida ';
    end;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM FS_SGA_Aprovisionamientos_Detalle WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(EmpresaOrigen) + ' AND ' +
          '  Id = ' + IntToStr(IdAprovisionamiento);

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', CONST_LOGID_SGA, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'ART', '' );

  sSQL := 'SELECT fsad.*, ' +
          '  OT.EjercicioFabricacion, OT.SerieFabricacion, OT.NumeroFabricacion, ' +
          '  ART.DescripcionArticulo, ART.TratamientoPartidas, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc, ' +
          '  fssu.CodigoAlternativo AS CodigoUbicacionAlternativo ' +
          'FROM FS_SGA_Aprovisionamientos_Detalle fsad WITH (NOLOCK) ' +
          'LEFT JOIN OrdenesTrabajo OT WITH (NOLOCK) ' +
          'ON ' +
          '  OT.CodigoEmpresa = fsad.CodigoEmpresa ' +
          '  AND OT.EjercicioTrabajo = fsad.EjercicioTrabajo ' +
          '  AND OT.NumeroTrabajo = fsad.NumeroTrabajo ' +
          'LEFT JOIN FS_SGA_ESTR_UBICA fssu WITH (NOLOCK) ' +
          'ON ' +
          '  fsad.CodigoUbicacion = fssu.CodigoUbicacion ' +
          'INNER JOIN Articulos ART WITH (NOLOCK) ' +
          'ON ART.CodigoEmpresa = fsad.CodigoEmpresa ' +
          'AND ART.CodigoArticulo = fsad.ArticuloComponente ' +
          'WHERE ' +
          '  fsad.CodigoEmpresa = ' + IntToStr(EmpresaOrigen) + ' AND ' +
          '  fsad.Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
          'ORDER BY ' +
          sOrderBy +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', CONST_LOGID_SGA, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"Id":' + Q.FieldByName('Id').AsString + ',' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"EjercicioFabricacion":' + IntToStr(Q.FieldByName('EjercicioFabricacion').AsInteger) + ',' +
      '"SerieFabricacion":"' + JSON_Str(Q.FieldByName('SerieFabricacion').AsString) + '",' +
      '"NumeroFabricacion":' + IntToStr(Q.FieldByName('NumeroFabricacion').AsInteger) + ',' +
      '"EjercicioTrabajo":' + IntToStr(Q.FieldByName('EjercicioTrabajo').AsInteger) + ',' +
      '"NumeroTrabajo":' + IntToStr(Q.FieldByName('NumeroTrabajo').AsInteger) + ',' +
      '"Orden":' + IntToStr(Q.FieldByName('Orden').AsInteger) + ',' +
      '"Estado":' + IntToStr(Q.FieldByName('Estado').AsInteger) + ',' +
      '"CentroTrabajo":"' + JSON_Str(Q.FieldByName('CentroTrabajo').AsString) + '",' +
      '"ArticuloComponente":"' + JSON_Str(Q.FieldByName('ArticuloComponente').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"TratamientoPartidas":' + IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"CodigoUbicacion":"' + JSON_Str(Q.FieldByName('CodigoUbicacion').AsString) + '",' +
      '"CodigoUbicacionAlternativo":"' + JSON_Str(Q.FieldByName('CodigoUbicacionAlternativo').AsString) + '",' +
      '"UnidadesATraspasar":' + SQL_FloatToStr(Q.FieldByName('UnidadesATraspasar').AsFloat) + ',' +
      '"UnidadesTraspasadas":' + SQL_FloatToStr(Q.FieldByName('UnidadesTraspasadas').AsFloat) + ',' +
      '"GrupoTalla":' + IntToStr(Q.FieldByName('GrupoTalla_').AsInteger) + '",' +
      '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
      '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
      '"CodigoUbicacion":"' + JSON_Str(Q.FieldByName('CodigoUbicacion').AsString) + '",' +
      '"CodigoUbicacionAlternativo":"' + JSON_Str(Q.FieldByName('CodigoUbicacionAlternativo').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;
{
procedure WebModule1updateAprovisionamientoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );
}


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ TANCAR APROVISIONAMENT                                                │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1cerrarAprovisionamientoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  IdAprovisionamiento: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario       := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID                := contentfields.Values['UUID'];
  IdAprovisionamiento := StrToIntDef(contentfields.values['IdAprovisionamiento'],0);

  if IdAprovisionamiento=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de aprovisionamiento no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Tanquem l´aprovisionament'}

  sSQL :=
    'UPDATE FS_SGA_Aprovisionamientos ' +
    'SET ' +
    '  Estado = 2, ' +
    '  FechaFin = GETDATE() ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND Id = ' + IntToStr(IdAprovisionamiento);

  SQL_Execute_NoRes ( Conn, sSQL );

  LP := LOG_Clear();
  LP.IdAprovisionamiento := IdAprovisionamiento;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'CLOSE-APROV', 'Cerrar aprovisionamiento', @LP );

  Result := '{"Result":"OK","Error":"","TotalRecords":0,"NumPages":0,"NumRecords":0,"Data":[]}';

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ DETALL D'APROVISIONAMENT                                              │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getAprovisionamientoMovimientosAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Segment: String;
  Tipo: Integer;
  Estado: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Filter: String;
  sAndWhere: String;
  sSort: String;
  sSortType: String;
  EmpresaOrigen: Integer;
  IdAprovisionamiento: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  sFechaInicioAprovisionamiento, sFechaFinAprovisionamiento: string;
  sPROCCustom: String;
  sPedidos: string;
  sTrabajos: String;
  EjercicioTrabajo: Integer;
  NumeroTrabajo: Integer;
  Orden: Integer;
  YY: Integer;
  bEnTransito: boolean;
  FechaCaduca: TDateTime;
  sFechaCaduca: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario       := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  IdAprovisionamiento := StrToIntDef(contentfields.values['IdAprovisionamiento'],0);
  EjercicioTrabajo    := StrToIntDef(contentfields.Values['EjercicioTrabajo'], 0);
  NumeroTrabajo       := StrToIntDef(contentfields.Values['NumeroTrabajo'], 0);
  Orden               := StrToIntDef(contentfields.Values['Orden'], 0);
  YY                  := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Date() );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL :=
    'SELECT COUNT(*) ' +
    'FROM FS_SGA_Aprovisionamientos_Transito FSAT WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
    '  AND EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
    '  AND NumeroTrabajo = ' + IntTostr(NumeroTrabajo) + ' ' +
    '  AND Orden = ' + IntToStr(Orden);
  iTotalRegs := SQL_Execute ( Conn, sSQL );

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT ' +
    '  FSAT.Id, ' +
    '  FSAT.CodigoEmpresa, ' +
    '  FSAT.EjercicioTrabajo, ' +
    '  FSAT.NumeroTrabajo, ' +
    '  FSAT.Orden, ' +
    '  FSAT.AutoId, ' +
    '  FSAT.Partida, ' +
    '  FSAT.FechaCaduca, ' +
    '  FSAT.UnidadMedida, ' +
    '  FSAT.UbicacionOrigen, ' +
    '  FSAT.OrigenTransito, ' +
    '  FSAT.UbicacionDestino, ' +
    '  FSAT.DestinoTransito, ' +
    '  FSAT.UnidadMedidaBase, ' +
    '  FSAT.FactorConversion, ' +
    '  FSAT.CantidadEntrada, ' +
    '  FSAT.CantidadEntradaBase, ' +
    '  FSAT.CantidadSalida, ' +
    '  FSAT.CantidadSalidaBase, ' +
    '  FSAT.CodigoAgrupacion, ' +
    '  FSAT.UnidadesAgrupacion, ' +
    '  FSAT.CantidadSaldo, ' +
    '  FSAT.CantidadSaldoBase, ' +
    '  FSAT.FechaRegistro, ' +
    '  FSEUO.CodigoAlternativo AS UbicacionOrigenAlternativo, ' +
    '  FSEUD.CodigoAlternativo AS UbicacionDestinoAlternativo ' +
    'FROM FS_SGA_Aprovisionamientos_Transito FSAT WITH (NOLOCK) ' +
    'LEFT JOIN FS_SGA_ESTR_Ubica FSEUO WITH (NOLOCK) ' +
    'ON ' +
    '  FSEUO.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    '  AND FSEUO.CodigoUbicacion = FSAT.UbicacionOrigen ' +
    'LEFT JOIN FS_SGA_ESTR_Ubica FSEUD WITH (NOLOCK) ' +
    'ON ' +
    '  FSEUD.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    '  AND FSEUD.CodigoUbicacion = FSAT.UbicacionDestino ' +
    'WHERE ' +
    '  FSAT.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND FSAT.Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
    '  AND FSAT.EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
    '  AND FSAT.NumeroTrabajo = ' + IntTostr(NumeroTrabajo) + ' ' +
    '  AND FSAT.Orden = ' + IntToStr(Orden) + ' ' +
    '  AND FSAT.CantidadSaldoBase > 0 ' +
    '  AND FSAT.DestinoTransito = 1 ' +

    'UNION ALL ' +

    'SELECT FSAT.Id, ' +
    '  FSAT.CodigoEmpresa, ' +
    '  FSAT.EjercicioTrabajo, ' +
    '  FSAT.NumeroTrabajo, ' +
    '  FSAT.Orden, ' +
    '  0 AS AutoId, ' +
    '  FSAT.Partida, ' +
    '  FSAT.UnidadMedida, ' +
    '  FSAT.UbicacionDestino, ' +
    '  CAST(1 AS BIT) AS OrigenTransito, ' +
    '  FSAT.UbicacionDestino, ' +
    '  FSAT.DestinoTransito, ' +
    '  FSAT.UnidadMedidaBase, ' +
    '  FSAT.FactorConversion, ' +
    '  SUM(FSAT.CantidadEntrada) AS CantidadEntrada, ' +
    '  SUM(FSAT.CantidadEntradaBase) AS CantidadEntradaBase, ' +
    '  SUM(FSAT.CantidadSalida) AS CantidadSalida, ' +
    '  SUM(FSAT.CantidadSalidaBase) AS CantidadSalidaBase, ' +
    '  FSAT.CodigoAgrupacion, ' +
    '  FSAT.UnidadesAgrupacion, ' +
    '  SUM(FSAT.CantidadSaldo) AS CantidadSaldo, ' +
    '  SUM(FSAT.CantidadSaldoBase) AS CantidadSaldoBase, ' +
    '  MAX(FSAT.FechaRegistro) AS FechaRegistro, ' +
    '  FSEUD.CodigoAlternativo AS UbicacionOrigenAlternativo, ' +
    '  FSEUD.CodigoAlternativo AS UbicacionDestinoAlternativo ' +
    'FROM FS_SGA_Aprovisionamientos_Transito FSAT WITH (NOLOCK) ' +
    'LEFT JOIN FS_SGA_ESTR_Ubica FSEUO WITH (NOLOCK) ' +
    'ON ' +
    '  FSEUO.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    '  AND FSEUO.CodigoUbicacion = FSAT.UbicacionOrigen ' +
    'LEFT JOIN FS_SGA_ESTR_Ubica FSEUD WITH (NOLOCK) ' +
    'ON ' +
    '  FSEUD.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    '  AND FSEUD.CodigoUbicacion = FSAT.UbicacionDestino ' +
    'WHERE ' +
    '  FSAT.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND FSAT.Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
    '  AND FSAT.EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
    '  AND FSAT.NumeroTrabajo = ' + IntTostr(NumeroTrabajo) + ' ' +
    '  AND FSAT.Orden = ' + IntToStr(Orden) + ' ' +
    '  AND FSAT.CantidadSaldoBase > 0 ' +
    '  AND FSAT.DestinoTransito = 0 ' +
    'GROUP BY ' +
    '  FSAT.Id, FSAT.CodigoEmpresa, FSAT.EjercicioTrabajo, FSAT.NumeroTrabajo, FSAT.Orden, FSAT.Partida, ' +
    '  FSAT.UnidadMedida, FSAT.UbicacionDestino, FSAT.UbicacionDestino, FSAT.DestinoTransito, ' +
    '  FSAT.UnidadMedidaBase, FSAT.FactorConversion, FSAT.CodigoAgrupacion, FSAT.UnidadesAgrupacion, FSEUD.CodigoAlternativo, ' +
    '  FSEUD.CodigoAlternativo ' +
    'ORDER BY ' +
    '  FSAT.DestinoTransito DESC, FSAT.AutoId';

  sSQL :=
    'SELECT ' +
    '  FSAT.Id, ' +
    '  FSAT.CodigoEmpresa, ' +
    '  FSAT.EjercicioTrabajo, ' +
    '  FSAT.NumeroTrabajo, ' +
    '  FSAT.Orden, ' +
    '  0 AS AutoId, ' +
    '  FSAT.Partida, ' +
    '  FSAT.FechaCaduca, ' +
    '  '''' AS UbicacionOrigen, ' +
    '  FSAT.UnidadMedida, ' +
    '  FSAT.UbicacionDestino, ' +
    '  CAST(1 AS BIT) AS OrigenTransito, ' +
    '  FSAT.UbicacionDestino, ' +
    '  FSAT.DestinoTransito, ' +
    '  FSAT.UnidadMedidaBase, ' +
    '  FSAT.FactorConversion, ' +
    '  SUM(FSAT.CantidadEntrada) AS CantidadEntrada, ' +
    '  SUM(FSAT.CantidadEntradaBase) AS CantidadEntradaBase, ' +
    '  SUM(FSAT.CantidadSalida) AS CantidadSalida, ' +
    '  SUM(FSAT.CantidadSalidaBase) AS CantidadSalidaBase, ' +
    '  FSAT.CodigoAgrupacion, ' +
    '  FSAT.UnidadesAgrupacion, ' +
    '  SUM(FSAT.CantidadSaldo) AS CantidadSaldo, ' +
    '  SUM(FSAT.CantidadSaldoBase) AS CantidadSaldoBase, ' +
    '  MAX(FSAT.FechaRegistro) AS FechaRegistro, ' +
    '  FSEUD.CodigoAlternativo AS UbicacionOrigenAlternativo, ' +
    '  FSEUD.CodigoAlternativo AS UbicacionDestinoAlternativo ' +
    'FROM FS_SGA_Aprovisionamientos_Transito FSAT WITH (NOLOCK) ' +
    'INNER JOIN FS_SGA_Aprovisionamientos_Detalle FSAD WITH (NOLOCK) ' +
    'ON ' +
    '  FSAT.Id = FSAD.Id ' +
    '  AND FSAT.CodigoEmpresa = FSAD.codigoempresa ' +
    '  AND FSAT.EjercicioTrabajo = FSAD.EjercicioTrabajo ' +
    '  AND FSAT.NumeroTrabajo = FSAD.NumeroTrabajo ' +
    '  AND FSAT.Orden = FSAD.Orden ' +
    'LEFT JOIN FS_SGA_ESTR_Ubica FSEUO WITH (NOLOCK) ' +
    'ON ' +
    '  FSEUO.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    '  AND FSEUO.CodigoUbicacion = FSAT.UbicacionOrigen ' +
    'LEFT JOIN FS_SGA_ESTR_Ubica FSEUD WITH (NOLOCK) ' +
    'ON ' +
    '  FSEUD.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    '  AND FSEUD.CodigoUbicacion = FSAT.UbicacionDestino ' +
    'WHERE ' +
    '  FSAT.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND FSAT.Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
    '  AND FSAT.EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
    '  AND FSAT.NumeroTrabajo = ' + IntTostr(NumeroTrabajo) + ' ' +
    '  AND FSAT.Orden = ' + IntToStr(Orden) + ' ' +
    '  AND FSAT.CantidadSaldoBase > 0 ' +
    '  AND ( ' +
    '    FSAT.DestinoTransito = 1 ' +
    '    OR UbicacionDestino = FSAD.CodigoUbicacion ' +
    '  ) ' +
    'GROUP BY ' +
    '  FSAT.Id, FSAT.CodigoEmpresa, FSAT.EjercicioTrabajo, FSAT.NumeroTrabajo, FSAT.Orden, FSAT.Partida, FSAT.FechaCaduca,' +
    '  FSAT.UnidadMedida, FSAT.UbicacionDestino, FSAT.UbicacionDestino, FSAT.DestinoTransito, ' +
    '  FSAT.UnidadMedidaBase, FSAT.FactorConversion, FSAT.CodigoAgrupacion, FSAT.UnidadesAgrupacion, FSEUD.CodigoAlternativo, ' +
    '  FSEUD.CodigoAlternativo ' +
    'ORDER BY ' +
    '  FSAT.DestinoTransito DESC, MAX(FSAT.FechaRegistro) ';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  bEnTransito := FALSE;

  while not Q.Eof do begin

    bEnTransito := bEnTransito or ((Q.FieldByName('DestinoTransito').AsBoolean) and (Q.FieldByName('CantidadSaldoBase').AsFloat>0));

    if (iNumRegs>0) then
      Result := Result + ',';

    FechaCaduca := Q.FieldByName('FechaCaduca').AsDateTime;
    if FechaCaduca>0 then
      sFechaCaduca := FormatDateTime('dd/mm/yyyy', FechaCaduca)
    else
      sFechaCaduca := '';

    Result := Result +
      '{' +
      '"Id":' + IntToStr(Q.FieldByName('Id').AsInteger) + ',' +
      '"AutoId":' + IntToStr(Q.FieldByName('AutoId').AsInteger) + ',' +
      '"CodigoEmpresa":' + IntToStr(Q.FieldByName('CodigoEmpresa').AsInteger) + ',' +
      '"EjercicioTrabajo":' + IntToStr(Q.FieldByName('EjercicioTrabajo').AsInteger) + ',' +
      '"NumeroTrabajo":' + IntToStr(Q.FieldByName('NumeroTrabajo').AsInteger) + ',' +
      '"Orden":' + IntToStr(Q.FieldByName('Orden').AsInteger) + ',' +
      '"UbicacionOrigen":"' + JSON_Str(Q.FieldByName('UbicacionOrigen').AsString) + '",' +
      '"UbicacionOrigenAlternativo":"' + JSON_Str(Q.FieldByName('UbicacionOrigenAlternativo').AsString) + '",' +
      '"UbicacionOrigenTransito":' + SQL_BooleanToStr(Q.FieldByName('OrigenTransito').AsBoolean) + ',' +
      '"UbicacionDestino":"' + JSON_Str(Q.FieldByName('UbicacionDestino').AsString) + '",' +
      '"UbicacionDestinoAlternativo":"' + JSON_Str(Q.FieldByName('UbicacionDestinoAlternativo').AsString) + '",' +
      '"UbicacionDestinoTransito":' + SQL_BooleanToStr(Q.FieldByName('DestinoTransito').AsBoolean) + ',' +
      '"Partida":{ ' +
        '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
        '"FechaCaduca":"' + JSON_Str(sFechaCaduca) + '"' +
      '},' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
      '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '",' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion').AsFloat) + ',' +
      '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
      '"UnidadesAgrupacion":' + SQL_FloatToStr(Q.FieldByName('UnidadesAgrupacion').AsFloat) + ',' +
      '"CantidadEntrada":' + SQL_FloatToStr(Q.FieldByName('CantidadEntrada').AsFloat) + ',' +
      '"CantidadEntradaBase":' + SQL_FloatToStr(Q.FieldByName('CantidadEntradaBase').AsFloat) + ',' +
      '"CantidadSalida":' + SQL_FloatToStr(Q.FieldByName('CantidadSalida').AsFloat) + ',' +
      '"CantidadSalidaBase":' + SQL_FloatToStr(Q.FieldByName('CantidadSalidaBase').AsFloat) + ',' +
      '"CantidadSaldo":' + SQL_FloatToStr(Q.FieldByName('CantidadSaldo').AsFloat) + ',' +
      '"CantidadSaldoBase":' + SQL_FloatToStr(Q.FieldByName('CantidadSaldoBase').AsFloat) + ',' +
      '"FechaRegistro":"' + FormatDateTime('dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaRegistro').AsDateTime) + '"' +
      '}';

    iNumRegs := iNumRegs + 1;
    Q.Next;

  end;

  Result := Result + '], ' +
    '"Transito":' + SQL_BooleanToStr(bEnTransito) +
    '}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ REFRESCAR DETALL D'APROVISIONAMENT                                    │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1refreshAprovisionamientoDetailAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  Filter: String;
  sAndWhere: String;
  sSort: String;
  sSortType: String;
  EmpresaOrigen: Integer;
  IdAprovisionamiento: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  sFechaInicioAprovisionamiento, sFechaFinAprovisionamiento: string;
  sPROCCustom: String;
  sPedidos: string;
  sTrabajos: String;
  SoloPendientes: boolean;
  YY: Integer;
  EjercicioTrabajo: Integer;
  NumeroTrabajo: Integer;
  Orden: Integer;
  bEnTransito: Boolean;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario       := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  IdAprovisionamiento := StrToIntDef(contentfields.values['IdAprovisionamiento'],0);
  EjercicioTrabajo    := StrToIntDef(contentfields.values['EjercicioTrabajo'],0);
  NumeroTrabajo       := StrToIntDef(contentfields.values['NumeroTrabajo'],0);
  Orden               := StrToIntDef(contentfields.values['Orden'],0);
  YY                  := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Date() );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL :=
    'SELECT COUNT(*) ' +
    'FROM FS_SGA_Aprovisionamientos_Detalle WITH (NOLOCK) ' +
    'WHERE ' +
    '  Id = ' + IntToStr(IdAprovisionamiento) + ' ';

  iTotalRegs := 1;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'ART', '' );

  sSQL :=
    'SELECT ' +
    '  UBIDESTINO.CodigoAlternativo AS CodigoUbicacionAlternativo, UBIORIGEN.CodigoAlternativo AS CodigoUbicacionAlternativoOrigen, ' +
    '  FSAD.*, ISNULL(FSAT.NumTransito,0) AS NumTransito, ART.DescripcionArticulo, ART.Descripcion2Articulo, ART.CodigoAlternativo, ART.CodigoAlternativo2, ' +
    '  ART.GrupoTalla_, OTRAB.EjercicioFabricacion AS EF, OTRAB.SerieFabricacion AS SF, OTRAB.NumeroFabricacion AS NF, ' +
    '  CTC.CodigoAlternativo AS CodigoAlternativoTC, ART.TratamientoPartidas, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc, ART.Colores_ AS TratamientoColores, ' +
    '  ART.UnidadMedida2_ AS UnidadMedidaBase, T.DescripcionTalla01_ as DescripcionTalla, C.Color_ AS DescripcionColor, ' +
    '  ART.FactorConversion_, ISNULL(FSAS.UnidadesSaldo,0) AS UnidadesSaldo, ISNULL(FSAS.UnidadesSaldoBase,0) AS UnidadesSaldoBase, ' +
    '  ISNULL(FSASDestino.UnidadesSaldo,0) AS UnidadesSaldoDestino, ISNULL(FSASDestino.UnidadesSaldoBase,0) AS UnidadesSaldoBaseDestino ' +
    'FROM FS_SGA_Aprovisionamientos_Detalle FSAD WITH (NOLOCK) ' +
    'LEFT JOIN ( ' +
    '  SELECT CodigoEmpresa, Id, EjercicioTrabajo, NumeroTrabajo, Orden, COUNT(*) AS NumTransito ' +
    '  FROM FS_SGA_Aprovisionamientos_Transito WITH (NOLOCK) ' +
    '  GROUP BY CodigoEmpresa, Id, EjercicioTrabajo, NumeroTrabajo, Orden ' +
    ') FSAT ' +
    'ON ' +
    '  FSAD.CodigoEmpresa = FSAT.CodigoEmpresa ' +
    '  AND FSAD.Id = FSAT.Id ' +
    '  AND FSAD.EjercicioTrabajo = FSAT.EjercicioTrabajo ' +
    '  AND FSAD.NumeroTrabajo = FSAT.NumeroTrabajo ' +
    '  AND FSAD.Orden = FSAT.Orden ' +
    'LEFT JOIN ( ' +
    '  SELECT ' +
    '    CodigoUbicacion, CodigoArticulo, UnidadMedida, UnidadMedidaBase, CodigoTalla01_, CodigoColor_, ' +
    '    SUM(UnidadesSaldo) AS UnidadesSaldo, SUM(UnidadesSaldoBase) AS UnidadesSaldoBase ' +
    '  FROM FS_SGA_AcumuladoStock FSAS WITH (NOLOCK) ' +
    '  WHERE CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '    AND Ejercicio = ' + IntToStr(YY) + ' ' +
    '    AND Periodo = 99 ' +
    '  GROUP BY ' +
    '    CodigoUbicacion, CodigoArticulo, UnidadMedida, UnidadMedidaBase, CodigoTalla01_, CodigoColor_' +
    ') FSAS ' +
    'ON ' +
    '  FSAS.CodigoArticulo = FSAD.ArticuloComponente ' +
    '  AND FSAS.CodigoTalla01_ = FSAD.CodigoTalla01_ ' +
    '  AND FSAS.CodigoColor_ = FSAD.CodigoColor_ ' +
    '  AND FSAS.UnidadMedida = FSAD.UnidadMedida ' +
    '  AND FSAS.CodigoUbicacion = FSAD.CodigoUbicacionOrigen ' +
    'LEFT JOIN ( ' +
    '  SELECT ' +
    '    CodigoUbicacion, CodigoArticulo, UnidadMedida, UnidadMedidaBase, CodigoTalla01_, CodigoColor_, ' +
    '    SUM(UnidadesSaldo) AS UnidadesSaldo, SUM(UnidadesSaldoBase) AS UnidadesSaldoBase ' +
    '  FROM FS_SGA_AcumuladoStock FSAS WITH (NOLOCK) ' +
    '  WHERE CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '    AND Ejercicio = ' + IntToStr(YY) + ' ' +
    '    AND Periodo = 99 ' +
    '  GROUP BY ' +
    '    CodigoUbicacion, CodigoArticulo, UnidadMedida, UnidadMedidaBase, CodigoTalla01_, CodigoColor_' +
    ') FSASDestino ' +
    'ON ' +
    '  FSASDestino.CodigoArticulo = FSAD.ArticuloComponente ' +
    '  AND FSASDestino.CodigoTalla01_ = FSAD.CodigoTalla01_ ' +
    '  AND FSASDestino.CodigoColor_ = FSAD.CodigoColor_ ' +
    '  AND FSASDestino.UnidadMedida = FSAD.UnidadMedida ' +
    '  AND FSASDestino.CodigoUbicacion = FSAD.CodigoUbicacion ' +
    'INNER JOIN OrdenesTrabajo OTRAB WITH (NOLOCK) ' +
    'ON ' +
    '  OTRAB.CodigoEmpresa = FSAD.CodigoEmpresa ' +
    '  AND OTRAB.EjercicioTrabajo = FSAD.EjercicioTrabajo ' +
    '  AND OTRAB.NumeroTrabajo = FSAD.NumeroTrabajo ' +
    'INNER JOIN Articulos ART WITH (NOLOCK) ' +
    'ON ' +
    '  ART.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
    '  AND ART.CodigoArticulo = FSAD.ArticuloComponente ' +
    'LEFT JOIN Colores_ C WITH (NOLOCK) ' +
    'ON ' +
    '  C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
    '  AND C.CodigoColor_ = FSAD.CodigoColor_ ' +
    'LEFT JOIN Vis_VistaTallas T WITH (NOLOCK) ' +
    'ON ' +
    '  T.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
    '  AND T.GrupoTalla_= ART.GrupoTalla_ ' +
    '  AND T.CodigoTalla01_ = FSAD.CodigoTalla01_ ' +
    'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
    'ON ' +
    '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
    '  AND CTC.CodigoArticulo = FSAD.ArticuloComponente ' +
    '  AND CTC.CodigoTalla01_ = FSAD.CodigoTalla01_ ' +
    '  AND CTC.CodigoColor_ = FSAD.CodigoColor_ ' +
    'LEFT JOIN ( ' +
    '  SELECT CodigoEmpresa, CodigoAlmacen, CodigoUbicacion, CodigoAlternativo ' +
    '  FROM FS_SGA_ESTR_UBICA WITH (NOLOCK) ' +
    '  WHERE CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    ') UBIDESTINO ' +
    'ON ' +
    '  UBIDESTINO.CodigoEmpresa = FSAD.codigoempresa ' +
    '  AND UBIDESTINO.CodigoUbicacion = FSAD.CodigoUbicacion ' +
    'LEFT JOIN ( ' +
    '  SELECT CodigoEmpresa, CodigoAlmacen, CodigoUbicacion, CodigoAlternativo ' +
    '  FROM FS_SGA_ESTR_UBICA WITH (NOLOCK) ' +
    '  WHERE CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    ') UBIORIGEN ' +
    'ON ' +
    '  UBIORIGEN.CodigoEmpresa = FSAD.codigoempresa ' +
    '  AND UBIORIGEN.CodigoUbicacion = FSAD.CodigoUbicacionOrigen ' +
    'WHERE ' +
    '  FSAD.Id = ' + IntToStr(IdAprovisionamiento) + ' ' +
    '  AND FSAD.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND FSAD.EjercicioTrabajo = ' + IntToStr(EjercicioTrabajo) + ' ' +
    '  AND FSAD.NumeroTrabajo = ' + IntToStr(NumeroTrabajo) + ' ' +
    '  AND FSAD.Orden = ' + IntToStr(Orden);

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":1,"NumRecords":1,"Data":[';
  iNumRegs := 0;

  bEnTransito := FALSE;

  if not Q.Eof then
  begin

    bEnTransito := bEnTransito or (Q.FieldByName('UnidadesTransitoBase').AsInteger>0);

    Result := Result +
      '{' +
      '"Id":' + IntToStr(Q.FieldByName('Id').AsInteger) + ',' +
      '"EjercicioFabricacion":' + IntToStr(Q.FieldByName('EF').AsInteger) + ',' +
      '"SerieFabricacion":"' + JSON_Str(Q.FieldByName('SF').AsString) + '",' +
      '"NumeroFabricacion":' + IntToStr(Q.FieldByName('NF').AsInteger) + ',' +
      '"EjercicioTrabajo":' + IntToStr(Q.FieldByName('EjercicioTrabajo').AsInteger) + ',' +
      '"NumeroTrabajo":' + IntToStr(Q.FieldByName('NumeroTrabajo').AsInteger) + ',' +
      '"Orden":' + IntToStr(Q.FieldByName('Orden').AsInteger) + ',' +
      '"Estado":' + IntToStr(Q.FieldByName('Estado').AsInteger) + ',' +
      '"CentroTrabajo":"' + JSON_Str(Q.FieldByName('CentroTrabajo').AsString) + '",' +
      '"CodigoUbicacion":"' + JSON_Str(Q.FieldByName('CodigoUbicacion').AsString) + '",' +
      '"CodigoUbicacionAlternativo":"' + JSON_Str(Q.FieldByName('CodigoUbicacionAlternativo').AsString) + '",' +
      '"CodigoUbicacionOrigen":"' + JSON_Str(Q.FieldByName('CodigoUbicacionOrigen').AsString) + '",' +
      '"CodigoUbicacionAlternativoOrigen":"' + JSON_Str(Q.FieldByName('CodigoUbicacionAlternativoOrigen').AsString) + '",' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('ArticuloComponente').AsString) + '",' +
      '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"CodigoAlternativo2":"' + JSON_Str(Q.FieldByName('CodigoAlternativo2').AsString) + '",' +
      '"CodigoAlternativoTC":"' + JSON_Str(Q.FieldByName('CodigoAlternativoTC').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"Descripcion2Articulo":"' + JSON_Str(Q.FieldByName('Descripcion2Articulo').AsString) + '",' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
      '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '",' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion_').AsFloat) + ',' +
      '"TratamientoPartidas":' + SQL_BooleanToStr(Q.FieldByName('TratamientoPartidas').AsInteger<>0) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('TratamientoColores').AsInteger<>0) + ',' +
      '"GrupoTalla":' + IntToStr(Q.FieldByName('GrupoTalla_').AsInteger) + ',' +
      '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
      '"DescripcionTalla":"' + JSON_Str(Q.FieldByName('DescripcionTalla').AsString) + '",' +
      '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
      '"DescripcionColor":"' + JSON_Str(Q.FieldByName('DescripcionColor').AsString) + '",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"UnidadesATraspasar":' + SQL_FloatToStr(Q.FieldByName('UnidadesATraspasar').AsFloat) + ',' +
      '"UnidadesTraspasadas":' + SQL_FloatToStr(Q.FieldByName('UnidadesTraspasadas').AsFloat) + ',' +
      '"UnidadesATraspasarBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesATraspasar').AsFloat) + ',' +
      '"UnidadesTraspasadasBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesTraspasadas').AsFloat) + ',' +
      '"UnidadesSaldo":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldo').AsFloat) + ',' +
      '"UnidadesSaldoBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldoBase').AsFloat) + ',' +
      '"UnidadesSaldoDestino":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldoDestino').AsFloat) + ',' +
      '"UnidadesSaldoBaseDestino":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldoBaseDestino').AsFloat) + ',' +
      '"UnidadesTransito":' + SQL_FloatToStr(Q.FieldByName('UnidadesTransito').AsFloat) + ',' +
      '"UnidadesTransitoBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesTransitoBase').AsFloat) + ',' +
      '"EnTransito":' + IntToStr(Q.FieldByName('NumTransito').AsInteger) +
      '}';

  end;

  Result := Result + '], ' +
    '"Transito":' + SQL_BooleanToStr(bEnTransito) +
    '}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ DETALL D'APROVISIONAMENT                                              │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getAprovisionamientoDetailAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Segment: String;
  Tipo: Integer;
  Estado: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Filter: String;
  sAndWhere: String;
  sSort: String;
  sSortType: String;
  EmpresaOrigen: Integer;
  IdAprovisionamiento: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  sFechaInicioAprovisionamiento, sFechaFinAprovisionamiento: string;
  sPROCCustom: String;
  sPedidos: string;
  sTrabajos: String;
  SoloPendientes: boolean;
  YY: Integer;
  bEnTransito: Boolean;
  bCompletado: Boolean;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario       := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  IdAprovisionamiento := StrToIntDef(contentfields.values['IdAprovisionamiento'],0);
  Segment             := AnsiLowerCase(contentfields.Values['Tipo']);
  YY                  := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Date() );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL :=
    'SELECT COUNT(*) ' +
    'FROM FS_SGA_Aprovisionamientos_Detalle WITH (NOLOCK) ' +
    'WHERE ' +
    '  Id = ' + IntToStr(IdAprovisionamiento) + ' ';

  if Segment='pendientes' then
  begin
    sSQL := sSQL +
      'AND UnidadesTraspasadas < UnidadesATraspasar';
  end else if Segment='transito' then
  begin
    //sSQL := sSQL +
    //  'AND CantidadSaldoBase > 0';
  end;

  iTotalRegs := SQL_Execute ( Conn, sSQL );

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'ART', '' );

  sSQL :=
    'SELECT ' +
    '  UBIDESTINO.CodigoAlternativo AS CodigoUbicacionAlternativo, UBIORIGEN.CodigoAlternativo AS CodigoUbicacionAlternativoOrigen, ' +
    '  FSAD.*, ISNULL(FSAT.NumTransito,0) AS NumTransito, ART.DescripcionArticulo, ART.Descripcion2Articulo, ART.CodigoAlternativo, ART.CodigoAlternativo2, ' +
    '  ART.GrupoTalla_ AS GrupoTallaArticulo, OTRAB.EjercicioFabricacion AS EF, OTRAB.SerieFabricacion AS SF, OTRAB.NumeroFabricacion AS NF, ' +
    '  CTC.CodigoAlternativo AS CodigoAlternativoTC, ART.TratamientoPartidas, ART.Colores_ AS TratamientoColores, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc, ' +
    '  ART.UnidadMedida2_ AS UnidadMedidaBase, T.DescripcionTalla01_ as DescripcionTalla, C.Color_ AS DescripcionColor, ' +
    '  ART.FactorConversion_, ISNULL(FSAS.UnidadesSaldo,0) AS UnidadesSaldo, ISNULL(FSAS.UnidadesSaldoBase,0) AS UnidadesSaldoBase, ' +
    '  ISNULL(FSASDestino.UnidadesSaldo,0) AS UnidadesSaldoDestino, ISNULL(FSASDestino.UnidadesSaldoBase,0) AS UnidadesSaldoBaseDestino ' +
    'FROM FS_SGA_Aprovisionamientos_Detalle FSAD WITH (NOLOCK) ' +
    'LEFT JOIN ( ' +
    '  SELECT CodigoEmpresa, Id, EjercicioTrabajo, NumeroTrabajo, Orden, COUNT(*) AS NumTransito ' +
    '  FROM FS_SGA_Aprovisionamientos_Transito WITH (NOLOCK) ' +
    '  GROUP BY CodigoEmpresa, Id, EjercicioTrabajo, NumeroTrabajo, Orden ' +
    ') FSAT ' +
    'ON ' +
    '  FSAD.CodigoEmpresa = FSAT.CodigoEmpresa ' +
    '  AND FSAD.Id = FSAT.Id ' +
    '  AND FSAD.EjercicioTrabajo = FSAT.EjercicioTrabajo ' +
    '  AND FSAD.NumeroTrabajo = FSAT.NumeroTrabajo ' +
    '  AND FSAD.Orden = FSAT.Orden ' +
    'LEFT JOIN ( ' +
    '  SELECT ' +
    '    CodigoUbicacion, CodigoArticulo, UnidadMedida, UnidadMedidaBase, CodigoTalla01_, CodigoColor_, ' +
    '    SUM(UnidadesSaldo) AS UnidadesSaldo, SUM(UnidadesSaldoBase) AS UnidadesSaldoBase ' +
    '  FROM FS_SGA_AcumuladoStock FSAS WITH (NOLOCK) ' +
    '  WHERE CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '    AND Ejercicio = ' + IntToStr(YY) + ' ' +
    '    AND Periodo = 99 ' +
    '  GROUP BY ' +
    '    CodigoUbicacion, CodigoArticulo, UnidadMedida, UnidadMedidaBase, CodigoTalla01_, CodigoColor_' +
    ') FSAS ' +
    'ON ' +
    '  FSAS.CodigoArticulo = FSAD.ArticuloComponente ' +
    '  AND FSAS.CodigoTalla01_ = FSAD.CodigoTalla01_ ' +
    '  AND FSAS.CodigoColor_ = FSAD.CodigoColor_ ' +
    '  AND FSAS.UnidadMedida = FSAD.UnidadMedida ' +
    '  AND FSAS.CodigoUbicacion = FSAD.CodigoUbicacionOrigen ' +
    'LEFT JOIN ( ' +
    '  SELECT ' +
    '    CodigoUbicacion, CodigoArticulo, UnidadMedida, UnidadMedidaBase, CodigoTalla01_, CodigoColor_, ' +
    '    SUM(UnidadesSaldo) AS UnidadesSaldo, SUM(UnidadesSaldoBase) AS UnidadesSaldoBase ' +
    '  FROM FS_SGA_AcumuladoStock FSAS WITH (NOLOCK) ' +
    '  WHERE CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '    AND Ejercicio = ' + IntToStr(YY) + ' ' +
    '    AND Periodo = 99 ' +
    '  GROUP BY ' +
    '    CodigoUbicacion, CodigoArticulo, UnidadMedida, UnidadMedidaBase, CodigoTalla01_, CodigoColor_' +
    ') FSASDestino ' +
    'ON ' +
    '  FSASDestino.CodigoArticulo = FSAD.ArticuloComponente ' +
    '  AND FSASDestino.CodigoTalla01_ = FSAD.CodigoTalla01_ ' +
    '  AND FSASDestino.CodigoColor_ = FSAD.CodigoColor_ ' +
    '  AND FSASDestino.UnidadMedida = FSAD.UnidadMedida ' +
    '  AND FSASDestino.CodigoUbicacion = FSAD.CodigoUbicacion ' +
    'LEFT JOIN OrdenesTrabajo OTRAB WITH (NOLOCK) ' +
    'ON ' +
    '  OTRAB.CodigoEmpresa = FSAD.CodigoEmpresa ' +
    '  AND OTRAB.EjercicioTrabajo = FSAD.EjercicioTrabajo ' +
    '  AND OTRAB.NumeroTrabajo = FSAD.NumeroTrabajo ' +
    'INNER JOIN Articulos ART WITH (NOLOCK) ' +
    'ON ' +
    '  ART.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Articulos) + ' ' +
    '  AND ART.CodigoArticulo = FSAD.ArticuloComponente ' +
    'LEFT JOIN Colores_ C WITH (NOLOCK) ' +
    'ON ' +
    '  C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Colores) + ' ' +
    '  AND C.CodigoColor_ = FSAD.CodigoColor_ ' +
    'LEFT JOIN Vis_VistaTallas T WITH (NOLOCK) ' +
    'ON ' +
    '  T.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
    '  AND T.GrupoTalla_= ART.GrupoTalla_ ' +
    '  AND T.CodigoTalla01_ = FSAD.CodigoTalla01_ ' +
    'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
    'ON ' +
    '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
    '  AND CTC.CodigoArticulo = FSAD.ArticuloComponente ' +
    '  AND CTC.CodigoTalla01_ = FSAD.CodigoTalla01_ ' +
    '  AND CTC.CodigoColor_ = FSAD.CodigoColor_ ' +
    'LEFT JOIN ( ' +
    '  SELECT CodigoEmpresa, CodigoAlmacen, CodigoUbicacion, CodigoAlternativo ' +
    '  FROM FS_SGA_ESTR_UBICA WITH (NOLOCK) ' +
    '  WHERE CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    ') UBIDESTINO ' +
    'ON ' +
    '  UBIDESTINO.CodigoEmpresa = FSAD.codigoempresa ' +
    '  AND UBIDESTINO.CodigoUbicacion = FSAD.CodigoUbicacion ' +
    'LEFT JOIN ( ' +
    '  SELECT CodigoEmpresa, CodigoAlmacen, CodigoUbicacion, CodigoAlternativo ' +
    '  FROM FS_SGA_ESTR_UBICA WITH (NOLOCK) ' +
    '  WHERE CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
    ') UBIORIGEN ' +
    'ON ' +
    '  UBIORIGEN.CodigoEmpresa = FSAD.codigoempresa ' +
    '  AND UBIORIGEN.CodigoUbicacion = FSAD.CodigoUbicacionOrigen ' +
    'WHERE ' +
    '  FSAD.Id = ' + IntToStr(IdAprovisionamiento) + ' ';

  if Segment='pendientes' then
  begin
    sSQL := sSQL +
      'AND UnidadesTraspasadas < UnidadesATraspasar';
  end else if Segment='transito' then
  begin

  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  bEnTransito := FALSE;
  bCompletado := TRUE;

  while not Q.Eof do begin

    bEnTransito := bEnTransito or (Q.FieldByName('UnidadesTransitoBase').AsInteger>0);

    bCompletado :=
      bCompletado
      and (not bEnTransito)
      and (Q.FieldByName('UnidadesTraspasadasBase').AsFloat >= Q.FieldByName('UnidadesATraspasarBase').AsFloat);

    if (iNumRegs>0) then
      Result := Result + ',';

    Result := Result +
      '{' +
      '"Id":' + IntToStr(Q.FieldByName('Id').AsInteger) + ',' +
      '"EjercicioFabricacion":' + IntToStr(Q.FieldByName('EF').AsInteger) + ',' +
      '"SerieFabricacion":"' + JSON_Str(Q.FieldByName('SF').AsString) + '",' +
      '"NumeroFabricacion":' + IntToStr(Q.FieldByName('NF').AsInteger) + ',' +
      '"EjercicioTrabajo":' + IntToStr(Q.FieldByName('EjercicioTrabajo').AsInteger) + ',' +
      '"NumeroTrabajo":' + IntToStr(Q.FieldByName('NumeroTrabajo').AsInteger) + ',' +
      '"Orden":' + IntToStr(Q.FieldByName('Orden').AsInteger) + ',' +
      '"Estado":' + IntToStr(Q.FieldByName('Estado').AsInteger) + ',' +
      '"CentroTrabajo":"' + JSON_Str(Q.FieldByName('CentroTrabajo').AsString) + '",' +
      '"CodigoUbicacion":"' + JSON_Str(Q.FieldByName('CodigoUbicacion').AsString) + '",' +
      '"CodigoUbicacionAlternativo":"' + JSON_Str(Q.FieldByName('CodigoUbicacionAlternativo').AsString) + '",' +
      '"CodigoUbicacionOrigen":"' + JSON_Str(Q.FieldByName('CodigoUbicacionOrigen').AsString) + '",' +
      '"CodigoUbicacionAlternativoOrigen":"' + JSON_Str(Q.FieldByName('CodigoUbicacionAlternativoOrigen').AsString) + '",' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('ArticuloComponente').AsString) + '",' +
      '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"CodigoAlternativo2":"' + JSON_Str(Q.FieldByName('CodigoAlternativo2').AsString) + '",' +
      '"CodigoAlternativoTC":"' + JSON_Str(Q.FieldByName('CodigoAlternativoTC').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"Descripcion2Articulo":"' + JSON_Str(Q.FieldByName('Descripcion2Articulo').AsString) + '",' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
      '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '",' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion_').AsFloat) + ',' +
      '"TratamientoPartidas":' + SQL_BooleanToStr(Q.FieldByName('TratamientoPartidas').AsInteger<>0) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('TratamientoColores').AsInteger<>0) + ',' +
      '"GrupoTalla":' + IntToStr(Q.FieldByName('GrupoTallaArticulo').AsInteger) + ',' +
      '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
      '"DescripcionTalla":"' + JSON_Str(Q.FieldByName('DescripcionTalla').AsString) + '",' +
      '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
      '"DescripcionColor":"' + JSON_Str(Q.FieldByName('DescripcionColor').AsString) + '",' +
      '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
      '"UnidadesATraspasar":' + SQL_FloatToStr(Q.FieldByName('UnidadesATraspasar').AsFloat) + ',' +
      '"UnidadesTraspasadas":' + SQL_FloatToStr(Q.FieldByName('UnidadesTraspasadas').AsFloat) + ',' +
      '"UnidadesATraspasarBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesATraspasar').AsFloat) + ',' +
      '"UnidadesTraspasadasBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesTraspasadas').AsFloat) + ',' +
      '"UnidadesSaldo":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldo').AsFloat) + ',' +
      '"UnidadesSaldoBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldoBase').AsFloat) + ',' +
      '"UnidadesSaldoDestino":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldoDestino').AsFloat) + ',' +
      '"UnidadesSaldoBaseDestino":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldoBaseDestino').AsFloat) + ',' +
      '"UnidadesTransito":' + SQL_FloatToStr(Q.FieldByName('UnidadesTransito').AsFloat) + ',' +
      '"UnidadesTransitoBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesTransitoBase').AsFloat) + ',' +
      '"EnTransito":' + IntToStr(Q.FieldByName('NumTransito').AsInteger) +
      '}';

    iNumRegs := iNumRegs + 1;
    Q.Next;

  end;

  Result := Result + '], ' +
    '"Transito":' + SQL_BooleanToStr(bEnTransito) + ',' +
    '"Completado":' + SQL_BooleanToStr(bCompletado) +
    '}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAR APROVISIONAMENTS DE FABRICACIÓ                                │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listAprovisionamientosAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Tipo: Integer;
  Estado: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Filter: String;
  sAndWhere: String;
  sSort: String;
  sSortType: String;
  EmpresaOrigen: Integer;
  IdAprovisionamiento: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  sFechaInicioAprovisionamiento, sFechaFinAprovisionamiento: string;
  sPROCCustom: String;
  sPedidos: string;
  sTrabajos: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  Tipo                := StrToIntDef(contentfields.values['Tipo'],-1);
  IdAprovisionamiento := StrToIntDef(contentfields.values['IdAprovisionamiento'],0);
  sSort               := AnsiLowerCase((contentfields.Values['OrdenarPor']));
  sSortType           := AnsiLowerCase((contentfields.Values['TipoOrden']));

  if (sSort='fecha') then
    sSort := ' FechaCreacion '
  else if (sSort='lineas') then
    sSort := ' NumLineasTotales '
  else if (sSort='trabajo') then
    sSort := ' CASE WHEN NumOT=1 THEN CAST(EjercicioTrabajo AS varchar) ELSE FechaCreacion END, NumeroTrabajo '
  else if (sSort='aprovisionamiento') then
    sSort := ' Id '
  else if (sSort='progreso') then
    sSort := ' Progreso '
  else
    sSort := ' Id ';

  if sSortType='desc' then
    sSort := sSort + ' DESC ';

  //if (Pos('IdAprovisionamiento', ansilowercase(sSort))<=0) then
  //  sSort := sSort + ', fsa.Id ';

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_ListAprovisionamientos', sPROCCustom) then
  begin

    sSQL := 'EXEC dbo.[' + sPROCCustom + '] ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(CodigoUsuario) + ', ' +
      IntToStr(Tipo) + ', ' +
      '0, ' +
      '99999, ' +
      IntToStr(IdAprovisionamiento) + ', ' +
      '''' + SQL_Str(sSort) + '''';

    Q := SQL_PrepareQuery ( Conn, sSQL );
    try
      Q.Open;
      iTotalRegs := Q.RecordCount;
    except
      iTotalRegs := 0;
    end;
    Q.Close;
    FreeAndNil(Q);

  end else begin

    sAndWhere := '';

    if IdAprovisionamiento<>0 then begin
      sAndWhere := sAndWhere + 'AND fsa.Id = ' + IntToStr(IdAprovisionamiento) + ' ';
    end;

    if Tipo<>-1 then begin
      sAndWhere := sAndWhere + 'AND fsa.Estado = ' + IntToStr(Tipo) + ' ';
    end;

    if Tipo=2 then
    begin
      sAndWhere := sAndWhere + 'AND CONVERT(DATE,FechaFin,120)=CONVERT(DATE,GETDATE(),120) ';
    end;

    (*
    sSQL := 'SELECT ' +
            '  COUNT ( * ) ' +
            'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
            'WHERE ' +
            '  CodigoEmpresa = ' + IntToStr(EmpresaOrigen) +
            sAndWhere;
    *)

    sSQL := 'SELECT ' +
            '  COUNT(DISTINCT fsa.Id) ' +
            'FROM FS_SGA_Aprovisionamientos fsa WITH (NOLOCK) ' +
            'LEFT JOIN FS_SGA_Operarios_Aprovisionamiento fsoa WITH (NOLOCK) ' +
            'ON ' +
            '  fsoa.CodigoEmpresa = fsa.CodigoEmpresa ' +
            '  AND fsoa.AprovisionamientoId = fsa.Id ' +
            'WHERE ' +
            '  fsa.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ';

    if (CodigoUsuario>1) then
      sSQL := sSQL + 'AND fsoa.OperarioId = ' + IntToStr(CodigoUsuario) + ' ';

    sSQL := sSQL + sAndWhere;

    try
      iTotalRegs := SQL_Execute ( Conn, sSQL );
    except
      on E:Exception do begin
        Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
        Exit;
      end;
    end;

  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_ListAprovisionamientos', sPROCCustom) then
  begin

    sSQL := 'EXEC dbo.[' + sPROCCustom + '] ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(CodigoUsuario) + ', ' +
      IntToStr(Tipo) + ', ' +
      IntToStr(iPage*iPageSize) + ', ' +
      IntToStr(iPageSize) + ', ' +
      IntToStr(IdAprovisionamiento) + ', ' +
      '''' + SQL_Str(sSort) + '''';

  end else begin

    sSQL := 'SELECT DISTINCT ' +
            '  fsa.UbicacionExpedicion, ISNULL(Comptadors.NumPedidos, 0) AS NumPedidos, ' +
            '  CASE WHEN Comptadors.NumPedidos=1 THEN CAST(EjercicioPedido AS varchar) ELSE ''-'' END as EjercicioPedido, ' +
            '  CASE WHEN Comptadors.NumPedidos=1 THEN SeriePedido ELSE ''-'' END as SeriePedido, ' +
            '  CASE WHEN Comptadors.NumPedidos=1 THEN CAST(NumeroPedido AS varchar) ELSE ''-'' END as NumeroPedido, ' +
            '  ISNULL(NumLineasTotales,0) AS NumLineasTotales, ' +
            '  ISNULL(NumLineasPendientesExpedir,0) AS NumLineasPendientesExpedir, ' +
            '  ISNULL(NumArticulosTotales, 0) AS NumArticulosTotales, ' +
            '  ISNULL(NumArticuloPendientesPreparar,0) AS NumArticuloPendientesPreparar, ' +
            '  p.* ' +
            'FROM FS_SGA_Picking_Preparaciones p WITH ( NOLOCK ) ' +
            'LEFT JOIN dbo.FS_SGA_TABLE_AlmacenesUbicaciones ( ' + IntToStr(CodigoEmpresa.Almacenes) + ', ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) FSA ' +
            'ON fsa.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Almacenes) + ' ' +
            'AND fsa.CodigoAlmacen = fsa.AlmacenPreparacion ' +
            'LEFT JOIN FS_SGA_Operarios_Preparacion fsop WITH (NOLOCK) ' +
            'ON ' +
            '  fsop.CodigoEmpresa = p.CodigoEmpresa ' +
            '  AND fsop.PreparacionId = p.PreparacionId ' +
            'LEFT JOIN ( ' +
            '  SELECT ' +
            '    CodigoEmpresa, PreparacionId, ' +
            '    MIN(EjercicioPedido) AS EjercicioPedido, ' +
            '    MIN(NumeroPedido) AS NumeroPedido, ' +
            '    MIN(SeriePedido) AS SeriePedido, ' +
            '    COUNT ( DISTINCT CONCAT ( EjercicioPedido, SeriePedido, NumeroPedido ) ) as NumPedidos, ' +
            '    COUNT ( PickingId ) AS NumLineasTotales, ' +
            '    SUM ( CASE WHEN UdSaldo>0 THEN 1 ELSE 0 END ) as NumLineasPendientesExpedir, ' +
            '    COUNT ( DISTINCT CONCAT ( CodigoArticulo, Partida ) ) as NumArticulosTotales ' +
            '  FROM FS_SGA_Picking_Pedido_Lineas pl WITH ( NOLOCK ) ' +
            '  GROUP BY ' +
            '    CodigoEmpresa, PreparacionId ' +
            ') Comptadors ' +
            'ON ' +
            '  Comptadors.CodigoEmpresa = p.CodigoEmpresa ' +
            '  AND Comptadors.PreparacionId = p.PreparacionId ' +
            'LEFT JOIN ( ' +
            '  SELECT ' +
            '    CodigoEmpresa, PreparacionId, ' +
            '    COUNT(*) AS NumArticuloPendientesPreparar ' +
            '  FROM ( ' +
            '    SELECT ' +
            '      CodigoEmpresa, PreparacionId, CodigoArticulo, Partida, ' +
            '      SUM ( UdNecesarias ) AS Necesarias, MAX ( UdRetiradas ) AS Preparadas ' +
            '    FROM FS_SGA_Picking_Pedido_Lineas WITH ( NOLOCK ) ' +
            '    GROUP BY ' +
            '      CodigoEmpresa, PreparacionId, CodigoArticulo, Partida ' +
            '    HAVING ( ' +
            '      SUM ( UdNecesarias ) > MAX ( UdRetiradas ) ' +
            '      OR SUM ( UdNecesariasBase ) > MAX ( UdRetiradasBase ) ' +
            '    ) ' +
            '  ) B ' +
            '  GROUP BY ' +
            '    CodigoEmpresa, PreparacionId ' +
            ') Pendientes ' +
            'ON ' +
            '  Pendientes.CodigoEmpresa = p.CodigoEmpresa ' +
            '  AND Pendientes.PreparacionId = p.PreparacionId ';

    sSQL := sSQL + 'WHERE ' +
            '  p.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' AND ' +
            '  ISNULL(Comptadors.NumPedidos,0)>0 ' +
            sAndWhere + ' ';

    if (CodigoUsuario>1) then
      sSQL := sSQL + 'AND fsop.OperarioId = ' + IntToStr(CodigoUsuario) + ' ';

    sSQL := sSQL + 'ORDER BY ' +
            sSort +
            'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
            'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  end;


  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  //Result := '{"SQL":"' + JSON_Str(sSQL) + '","Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    //sTrabajos := FS_SGA_GetTrabajos ( Conn, Q.FieldByName('Id').AsInteger );
    sTrabajos := '';

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    if (Q.FieldByName('FechaInicio').AsDateTime=0) or (Q.FieldByName('FechaInicio').IsNull) then
      sFechaInicioAprovisionamiento := ''
    else
      sFechaInicioAprovisionamiento := FormatDateTime('dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaInicio').AsDateTime);

    if (Q.FieldByName('FechaFin').AsDateTime=0) or (Q.FieldByName('FechaFin').IsNull) then
      sFechaFinAprovisionamiento := ''
    else
      sFechaFinAprovisionamiento := FormatDateTime('dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaFin').AsDateTime);

    Result := Result +
      '{' +
      '"Estado":' + Q.FieldByName('Estado').AsString + ',' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"Id":' + Q.FieldByName('Id').AsString + ',' +
      '"NumOT":' + Q.FieldByName('NumOT').AsString + ',' +
      '"EjercicioFabricacion":' + IntToStr(Q.FieldByName('EjercicioFabricacion').AsInteger) + ', ' +
      '"SerieFabricacion":"' + JSON_Str(Q.FieldByName('SerieFabricacion').AsString) + '", ' +
      '"NumeroFabricacion":' + IntToStr(Q.FieldByName('NumeroFabricacion').AsInteger) + ', ' +
      '"EjercicioTrabajo":' + IntToStr(Q.FieldByName('EjercicioTrabajo').AsInteger) + ', ' +
      '"NumeroTrabajo":' + IntToStr(Q.FieldByName('NumeroTrabajo').AsInteger) + ', ' +
      '"Ejercicio":' + IntToStr(Q.FieldByName('Ejercicio').AsInteger) + ',' +
      '"FechaCreacion":"' + FormatDateTime ( 'dd/mm/yyyy', Q.FieldByName('FechaCreacion').AsDateTime) + '",' +
      '"FechaInicio":"' + sFechaInicioAprovisionamiento + '",' +
      '"FechaFin":"' + sFechaFinAprovisionamiento + '",' +
      '"NumLineasTotales":' + IntToStr(Q.FieldByName('NumLineasTotales').AsInteger) + ',' +
      '"NumLineasPendientes":' + IntToStr(Q.FieldByName('NumLineasPendientes').AsInteger) + ',' +
      '"NumArticulosTotales":' + IntToStr(Q.FieldByName('NumArticulosTotales').AsInteger) + ',' +
      '"EnTransito":' + IntToStr(Q.FieldByName('EnTransito').AsInteger) + ',' +
      '"Trabajos":[' + sTrabajos + ']' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;



// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAR PROVEÏDORS D'UNA EMPRESA                                      │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listPreparacionesAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Tipo: Integer;
  Estado: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Filter: String;
  sAndWhere: String;
  sSort: String;
  sSortType: String;
  EmpresaOrigen: Integer;
  PreparacionId: Integer;
  CodigoUsuario: Integer;
  UUID: String;
  contentfields: TStringList;
  sFechaInicioPreparacion, sFechaFinPreparacion: string;
  sPROCCustom: String;
  sPedidos: string;
  FiltroZona: String;
  FiltroTransportista: String;
  FiltroRuta: String;
  FiltroComisionista: String;
  lSortItems: TStringList;
  sortItem: String;
  sAscDesc: String;
  sFechaEntrega: String;
  ObservacionesAlbaran: String;
  ObservacionesFactura: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];

  Tipo          := StrToIntDef(contentfields.values['Tipo'],-1);
  PreparacionId := StrToIntDef(contentfields.values['PreparacionId'],0);
  sSort         := AnsiLowerCase((contentfields.Values['OrdenarPor']));
  //sSortType     := AnsiLowerCase((contentfields.Values['TipoOrden']));

  FiltroZona          := contentfields.Values['CodigoZona'];
  FiltroTransportista := contentfields.Values['CodigoTransportista'];
  FiltroRuta          := contentfields.Values['CodigoRuta'];
  FiltroComisionista  := contentfields.Values['CodigoComisionista'];

  lSortItems := TStringList.Create;
  lSortItems.Delimiter := '|';
  lSortItems.StrictDelimiter := TRUE;
  lSortItems.DelimitedText := sSort;

  sSort := '';

  while lSortItems.Count>0 do
  begin

    if sSort<>'' then
      sSort := sSort + ', ';

    sortItem := AnsiUpperCase(lSortItems[0]);
    sAscDesc := '';

    if LeftStr(sortItem,1)='-' then
    begin
      sAscDesc := ' DESC';
      Delete(sortItem,1,1);
    end;

    if sortItem = 'FECHA' then
    begin
      if Tipo = 0 then sSort := sSort + 'p.Fecha' + sAscDesc
      else if Tipo = 1 then sSort := sSort + 'p.FechaInicioPreparacion' + sAscDesc
      else sSort := sSort + 'p.FechaFinPreparacion' + sAscDesc;
    end else if (sortItem='FECHAE') then
      sSort := sSort + 'FechaEntrega' + sAscDesc
    else if (sortItem='CLIENTE') then
      sSort := sSort + 'p.CodigoCliente' + sAscDesc
    else if (sortItem='LINEAS') then
      sSort := sSort + 'NumLineasTotales' + sAscDesc
    else if (sortItem='PEDIDO') then
      sSort := sSort + 'Pedido' + sAscDesc
    else if (sortItem='PREPARACION') then
      sSort := sSort + 'p.PreparacionId' + sAscDesc
    else if (sortItem='PROGRESO') then
      sSort := sSort + 'Progreso' + sAscDesc
    else if (sortItem='PRIORIDAD') then
      sSort := sSort + 'Prioridad' + sAscDesc
    else if (sortItem='ORDEN') then
      sSort := sSort + 'p.PrepOrder' + sAscDesc;

    lSortItems.Delete(0);

  end;

  lSortItems.Free;

  if sSort='' then
  begin
    sSort := 'p.PreparacionId';
  end;

  if (Pos('preparacionid', ansilowercase(sSort))<=0) then
    sSort := sSort + ', p.PreparacionId ';

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  SQL_Procedure_Exists ( Conn, 'FS_SGA_ListPreparaciones', sPROCCustom);

  sSQL := 'EXEC dbo.[' + sPROCCustom + '] ' +
    IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
    IntToStr(CodigoUsuario) + ', ' +
    IntToStr(Tipo) + ', ' +
    '''' + SQL_Str(FiltroZona) + ''', ' +
    '''' + SQL_Str(FiltroTransportista) + ''', ' +
    '''' + SQL_Str(FiltroRuta) + ''', ' +
    '''' + SQL_Str(FiltroComisionista) + ''', ' +
    '0, ' +
    '99999, ' +
    IntToStr(PreparacionId) + ', ' +
    '''' + SQL_Str(sSort) + '''';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
    iTotalRegs := Q.RecordCount;
  except
    iTotalRegs := 0;
  end;

  Q.Close;
  FreeAndNil(Q);

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'EXEC dbo.[' + sPROCCustom + '] ' +
    IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
    IntToStr(CodigoUsuario) + ', ' +
    IntToStr(Tipo) + ', ' +
    '''' + SQL_Str(FiltroZona) + ''', ' +
    '''' + SQL_Str(FiltroTransportista) + ''', ' +
    '''' + SQL_Str(FiltroRuta) + ''', ' +
    '''' + SQL_Str(FiltroComisionista) + ''', ' +
    IntToStr(iPage*iPageSize) + ', ' +
    IntToStr(iPageSize) + ', ' +
    IntToStr(PreparacionId) + ', ' +
    '''' + SQL_Str(sSort) + '''';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  //"Sort":"' + JSON_Str(sSort) + '",
  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    sPedidos := FS_SGA_GetPedidos ( Conn, Q.FieldByName('PreparacionId').AsInteger );

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);
    
    if (Q.FieldByName('FechaEntrega').AsDateTime=0) or (Q.FieldByName('FechaEntrega').IsNull) then
      sFechaEntrega := ''
    else
      sFechaEntrega := FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaEntrega').AsDateTime);

    if (Q.FieldByName('FechaInicioPreparacion').AsDateTime=0) or (Q.FieldByName('FechaInicioPreparacion').IsNull) then
      sFechaInicioPreparacion := ''
    else
      sFechaInicioPreparacion := FormatDateTime('dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaInicioPreparacion').AsDateTime);

    if (Q.FieldByName('FechaFinPreparacion').AsDateTime=0) or (Q.FieldByName('FechaFinPreparacion').IsNull) then
      sFechaFinPreparacion := ''
    else
      sFechaFinPreparacion := FormatDateTime('dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaFinPreparacion').AsDateTime);

    ObservacionesAlbaran := Q.FieldByName('ObservacionesAlbaran').AsString;
    ObservacionesAlbaran := StringReplace(ObservacionesAlbaran, #13+#10, '\n', [rfReplaceAll]);
    ObservacionesFactura := Q.FieldByName('ObservacionesFactura').AsString;
    ObservacionesFactura := StringReplace(ObservacionesFactura, #13+#10, '\n', [rfReplaceAll]);

    Result := Result +
      '{' +
      '"Estado":' + Q.FieldByName('Estado').AsString + ',' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"PreparacionId":' + Q.FieldByName('PreparacionId').AsString + ',' +
      '"NumPedidos":' + Q.FieldByName('NumPedidos').AsString + ',' +
      '"EjercicioPedido":"' + JSON_Str(Q.FieldByName('EjercicioPedido').AsString) + '", ' +
      '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '", ' +
      '"NumeroPedido":"' + JSON_Str(Q.FieldByName('NumeroPedido').AsString) + '", ' +
      '"Ejercicio":' + Q.FieldByName('Ejercicio').AsString + ',' +
      '"Fecha":"' + FormatDateTime ( 'dd/mm/yyyy', Q.FieldByName('Fecha').AsDateTime) + '",' +
      '"CodigoCliente":"' + JSON_Str(Q.FieldByName('CodigoCliente').AsString) + '",' +
      '"AlmacenPreparacion":"' + JSON_Str(Q.FieldByName('AlmacenPreparacion').AsString) + '",' +
      '"UbicacionExpedicion":"' + JSON_Str(Q.FieldByName('UbicacionExpedicion').AsString) + '",' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"FechaEntrega":"' + sFechaEntrega + '",' +
      '"FechaInicioPreparacion":"' + sFechaInicioPreparacion + '",' +
      '"FechaFinPreparacion":"' + sFechaFinPreparacion + '",' +
      '"NumLineasTotales":' + Q.FieldByName('NumLineasTotales').AsString + ',' +
      '"NumLineasPendientesPreparar":' + Q.FieldByName('NumLineasPendientesPreparar').AsString + ',' +
      '"NumLineasPendientesExpedir":' + Q.FieldByName('NumLineasPendientesExpedir').AsString + ',' +
      '"NumArticulosTotales":' + Q.FieldByName('NumArticulosTotales').AsString + ',' +
      '"NumArticuloPendientesPreparar":' + Q.FieldByName('NumArticuloPendientesPreparar').AsString + ',' +
      '"Prioridad":' + IntToStr(Q.FieldByName('Prioridad').AsInteger) + ',' +
      '"NumLineasExpedidas":' + IntToStr(Q.FieldByName('NumLineasTotales').AsInteger-Q.FieldByName('NumLineasPendientesExpedir').AsInteger) + ',' +
      '"PaletActual":' + IntToStr(StrToIntDef(Q.FieldByName('PaletActual').AsString,1)) + ',' +
      '"CajaActual":' + IntToStr(StrToIntDef(Q.FieldByName('CajaActual').AsString,1)) + ',' +
      '"MatriculaActual":"' + JSON_Str(Q.FieldByName('MatriculaActual').AsString) + '", ' +
      '"CodigoZona":"' + JSON_Str(Q.FieldByName('CodigoZona').AsString) + '",' +
      '"Zona":"' + JSON_Str(Q.FieldByName('Zona').AsString) + '",' +
      '"CodigoTransportista":"' + JSON_Str(Q.FieldByName('CodigoTransportista').AsString) + '",' +
      '"Transportista":"' + JSON_Str(Q.FieldByName('Transportista').AsString) + '",' +
      '"CodigoRuta":"' + JSON_Str(Q.FieldByName('CodigoRuta').AsString) + '",' +
      '"CodigoComisionista":"' + JSON_Str(Q.FieldByName('CodigoComisionista').AsString) + '",' +
      '"Comisionista":"' + JSON_Str(Q.FieldByName('Comisionista').AsString) + '",' +
      '"ObservacionesAlbaran":"' + JSON_Str(ObservacionesAlbaran) + '",' +
      '"ObservacionesFactura":"' + JSON_Str(ObservacionesFactura) + '",' +
      '"Ruta":"' + JSON_Str(Q.FieldByName('Ruta').AsString) + '",' +
      '"CalculoRuta":{' +
        '"MetodoCalculo":"' + JSON_Str(Q.FieldByName('MetodoCalculo').AsString) + '",' +
        '"OrdenCalculo":"' + JSON_Str(Q.FieldByName('OrdenCalculo').AsString) + '",' +
        '"PermitirCaducados":"' + JSON_Str(Q.FieldByName('PermitirCaducados').AsString) + '",' +
        '"VidaUtil":' + IntToStr(StrToIntDef(Q.FieldByName('VidaUtil').AsString,0)) + ',' +
        '"UnidadVidaUtil":"' + JSON_Str(Q.FieldByName('UnidadVidaUtil').AsString) + '",' +
        '"IncluirReservas":' + SQL_BooleanToStr(Q.FieldByName('IncluirReservas').AsBoolean) + ',' +
        '"SoloReservas":' + SQL_BooleanToStr(Q.FieldByName('SoloReservas').AsBoolean) + ',' +
        '"IgnorarPartida":' + SQL_BooleanToStr(Q.FieldByName('IgnorarPartidas').AsBoolean) + ',' +
        '"IgnorarUbicacion":' + SQL_BooleanToStr(Q.FieldByName('IgnorarUbicaciones').AsBoolean) +
      '},' +
      '"Extra01":"' + JSON_Str(Q.FieldByName('Extra01').AsString) + '",' +
      '"Extra02":"' + JSON_Str(Q.FieldByName('Extra02').AsString) + '",' +
      '"Extra03":"' + JSON_Str(Q.FieldByName('Extra03').AsString) + '",' +
      '"Pedidos":[' + sPedidos + ']' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {if PreparacionId<>0 then
  begin

    LP := LOG_Clear();
    LP.IdPreparacion := PreparacionId;

    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'START-PREP', 'Preparación seleccionada para trabajar', @LP );

  end; }

  {$ENDREGION}

end;


procedure WebModule1listPreparacionOrdenadaAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  sSQL: String;
  sSQL1: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  EmpresaOrigen: Integer;
  YY: Integer;
  MostrarPartidas: Integer;
  sTable: string;
  CodigoAlmacen: String;
  LineasPosicion: String;
  CodigoArticulo: String;
  sUbicaciones: String;
  Partida: String;
  PartidaSugerida: String;
  bError: Boolean;
  Pendientes: Boolean;
  SoloConStock: Integer;
  iStockTotal: Double;
  CodigoUbicacionExpedicion: String;
  CodigoUbicacionesExcluidas: String;
  sMsg: String;
  bIsBuilding: Boolean;
  contentfields: TStringList;
  fUnidadesAgrupacion: Double;
  fUnidadesNecesariasAgrupadas: Double;
  UnidadesRetiradasAgrupadas: Double;
  UnidadesExpedidasAgrupadas: Double;
  Estado: Integer;
  PaletActual, CajaActual: Integer;
  MatriculaActual: String;
  tmpCodigoAlmacen: String;
  tmpCodigoPasillo: String;
  tmpCodigoEstanteria: String;
  tmpAltura: String;
  tmpFondo: String;
  JSonUnidadesMedida: string;
  sMovimientosRealizados: string;
  CodigoAlmacenDefecto: string;
  DefaultUbi: TDefaultUbicaciones;
  CodigoUbicacion: String;
  tmpCodigoAlternativo: string;
  sConsiderarReservas: String;
  sSoloReservas: String;
  sIgnorarPartidaSolicitada: String;
  sIgnorarUbicacionSolicitada: String;
  FechaCaducaMin: TDate;
  sFechaCaducaMin: string;
  CodigoUsuario: Integer;
  sFieldTratamientoSeries: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  if contentfields.Values['LogID']<>'' then
    sIDCall := contentfields.Values['LogID'];

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  gaLogFile.Write ( 'EmpresaOrigen = ' + IntToStr(EmpresaOrigen), sIDCall  );

  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
// CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario               := StrToIntDef(contentfields.Values['CodigoUsuario'],0);
  sConsiderarReservas         := contentfields.Values['ConsiderarReservas'];
  sSoloReservas               := contentfields.Values['SoloReservas'];
  sIgnorarPartidaSolicitada   := contentfields.Values['IgnorarPartidaSolicitada'];
  sIgnorarUbicacionSolicitada := contentfields.Values['IgnorarUbicacionSolicitada'];

  if sConsiderarReservas='' then sConsiderarReservas := '1';
  if sSoloReservas='' then sSoloReservas := '0';
  if sIgnorarPartidaSolicitada='' then sIgnorarPartidaSolicitada := '0';
  if sIgnorarUbicacionSolicitada='' then sIgnorarUbicacionSolicitada := '0';

  CodigoAlmacenDefecto := (contentfields.Values['CodigoAlmacenDefecto']);
  if CodigoAlmacenDefecto='' then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );
  gaLogFile.Write ( 'YY = ' + IntToStr(YY), sIDCall  );

  MostrarPartidas := 1; //StrToIntDef(contentfields.values['MostrarPartidas'],0);
  Pendientes      := (AnsiLowerCase(trim(contentfields.values['Pendientes']))='true');
  SoloConStock    := StrToIntDef(contentfields.values['SoloConStock'],0);
  CodigoAlmacen   := (contentfields.values['CodigoAlmacen']);

  SoloConStock := 0;

  //LineasPosicion  := (contentfields.values['LineasPosicion']);

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;
  gaLogFile.Write ( 'IdPreparacion = ' + IntToStr(IdPreparacion), sIDCall  );

  PaletActual     := 1;
  CajaActual      := 1;
  MatriculaActual := '';

  sSQL :=
    'SELECT PaletActual, CajaActual, MatriculaActual ' +
    'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
    'WHERE ' +
    '  PreparacionId=' + IntToStr(IdPreparacion);
  Q := SQL_PrepareQuery(Conn,sSQL);
  Q.Open;
  if not Q.EOF then
  begin
    PaletActual     := Q.FieldByName('PaletActual').AsInteger;
    CajaActual      := Q.FieldByName('CajaActual').AsInteger;
    MatriculaActual := Q.FieldByName('MatriculaActual').AsString;
  end;
  Q.Close;
  FreeAndNil(Q);

  OrdenarPor := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden  := AnsiUpperCase((contentfields.values['TipoOrden']));

  sOrderBy   := '';
  sOperation := '>';

  if OrdenarPor='ARTICULO' then begin
    sOrderBy := 'fspo.CodigoArticulo ' + TipoOrden + ', fspo.Partida ' + TipoOrden + ' ';
  end else if OrdenarPor='CODIGOUBICACION' then begin
    sOrderBy := 'fspo.CodigoUbicacion ' + TipoOrden + ', fspo.rn ' + TipoOrden + ' ';
  end else if OrdenarPor='CODIGOUBICACIONALTERNATIVO' then begin
    sOrderBy := 'fspo.rn ' + TipoOrden + ' ';
  end else begin
    sOrderBy := 'fspo.rn ' + TipoOrden + ' ';
  end;

  sOrderBy := 'ISNULL(fspo.CodigoUbicacion,''zzzzz'') DESC, ' + sOrderBy;

  sSQL :=
      'SELECT AlmacenPreparacion ' +
      'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
      'WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  CodigoAlmacen := SQL_Execute ( Conn, sSQL );

  if (CodigoAlmacen='') or (CodigoAlmacen='0') then
  begin
    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacion, CodigoEmpresa.EmpresaOrigen );
    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacion );
  end;

  FS_SGA_ObtenerUbicacionesAlmacen ( Conn, CodigoEmpresa, CodigoAlmacen, DefaultUbi );
  CodigoUbicacionExpedicion := DefaultUbi.UbicacionExpediciones;

  //PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacionExpedicion, CodigoEmpresa.EmpresaOrigen );

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionesExcluidasExpedicion, CodigoUbicacionesExcluidas, CodigoEmpresa.EmpresaOrigen );

  if (CodigoUbicacionesExcluidas='') or (CodigoUbicacionesExcluidas='0') then
    CodigoUbicacionesExcluidas := '''''';

  if CodigoAlmacen='' then begin
    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacionExpedicion );
  end;

  gaLogFile.Write ( 'CodigoAlmacen = ' + CodigoAlmacen, sIDCall  );

  {$ENDREGION}

  {$REGION 'Ens assegurem que tenim creada la taula amb l´ordenació creada'}
  sSQL := 'SELECT COUNT(*) FROM FS_SGA_ActualizarRuta WITH (NOLOCK) WHERE PreparacionId=' + IntToStr(IdPreparacion);
  if SQL_Execute(Conn,sSQL)>0 then
  begin
    gaLogFile.Write ( 'Before SGA_Check_PreparacionOrdenada Manual', sIDCall  );
    SGA_Check_PreparacionOrdenada (
      gsPath,
      Conn,
      CodigoEmpresa,
      CodigoUsuario,
      YY,
      IdPreparacion,
      CodigoAlmacen,
      CodigoUbicacionExpedicion,
      sConsiderarReservas,
      sSoloReservas,
      sIgnorarPartidaSolicitada,
      sIgnorarUbicacionSolicitada,
      sMsg,
      TRUE,
      bIsBuilding
    );
    gaLogFile.Write ( 'After SGA_Check_PreparacionOrdenada Manual: ' + sMsg, sIDCall  );
  end else begin
    gaLogFile.Write ( 'Before SGA_Check_PreparacionOrdenada', sIDCall  );
    SGA_Check_PreparacionOrdenada (
      gsPath,
      Conn,
      CodigoEmpresa,
      CodigoUsuario,
      YY,
      IdPreparacion,
      CodigoAlmacen,
      CodigoUbicacionExpedicion,
      sConsiderarReservas,
      sSoloReservas,
      sIgnorarPartidaSolicitada,
      sIgnorarUbicacionSolicitada,
      sMsg,
      FALSE,
      bIsBuilding
    );
    gaLogFile.Write ( 'After SGA_Check_PreparacionOrdenada: ' + sMsg, sIDCall  );
  end;

  if bIsBuilding then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Se está calculando la ruta. Volver a intentar en unos segundos","Data":[]}';
    Exit;
  end;
  {$ENDREGION}

  {$REGION 'Recuperació de dades'}
  sTable := 'FS_SGA_TABLE_PreparacionDetallesPeriodo';

  sFieldTratamientoSeries := FS_SGA_TratamientoSeries ( Conn, CodigoEmpresa, gsCustomerCode, 'ART', '' );

  sSQL := 'SELECT ' +
          '  ISNULL(fssa.UnidadesSaldo,0) AS UnidadesSaldo, fspo.*, agrup.Agrupacion as Agrupacion, ' +
          '  C.Color_ AS DescripcionColor, T.DescripcionTalla01_ AS DescripcionTalla, ' +
          '  ART.CodigoAlternativo, ART.CodigoAlternativo2, CTC.CodigoAlternativo AS CodigoAlternativoTC, ' +
          '  ART.GrupoTalla_ AS TratamientoTallas, ART.Colores_ AS TratamientoColores, ' + sFieldTratamientoSeries + ' AS TrataNumerosSerieLc ' +
          'FROM FS_SGA_PreparacionOrdenada fspo WITH (NOLOCK) ' +
          'LEFT JOIN dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
          'ON ' +
          '  fspo.CodigoArticulo = art.CodigoArticulo ' +
          'LEFT JOIN Agrupaciones agrup WITH (NOLOCK) ' +
          'ON ' +
          '  agrup.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
          '  AND agrup.CodigoArticulo = fspo.CodigoArticulo ' +
          '  AND agrup.CodigoAgrupacion = fspo.CodigoAgrupacion ' +
          'LEFT JOIN Colores_ C WITH (NOLOCK) ' +
          'ON ' +
          '  C.CodigoEmpresa = ' + IntTostr(CodigoEmpresa.Colores) + ' ' +
          '  AND C.CodigoColor_ = fspo.CodigoColor_ ' +
          'LEFT JOIN Vis_VistaTallas T WITH (NOLOCK) ' +
          'ON ' +
          '  T.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.GrupoTallas) + ' ' +
          '  AND T.GrupoTalla_ = art.GrupoTalla_ ' +
          '  AND T.CodigoTalla01_ = fspo.CodigoTalla01_ ' +
          'LEFT JOIN CodigosTallaColor CTC WITH (NOLOCK) ' +
          'ON ' +
          '  CTC.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
          '  AND CTC.CodigoArticulo = fspo.CodigoArticulo ' +
          '  AND CTC.CodigoTalla01_ = fspo.CodigoTalla01_ ' +
          '  AND CTC.CodigoColor_ = fspo.CodigoColor_ ' +
          'LEFT JOIN ( ' +
          '  SELECT ' +
          '    CodigoUbicacion, CodigoArticulo, SUM(UnidadesSaldo) AS UnidadesSaldo  ' +
          '  FROM FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', ' + IntToStr(YY) + ' ) ' +
          '  WHERE CodigoUbicacion NOT IN ( ' +
          '    SELECT EXCL_Ubicacion ' +
          '    FROM FS_SGA_UbicacionesExcluidas WITH (NOLOCK) ' +
          '    WHERE EXCL_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) ' +
          '      AND EXCL_Tipo = 0 ' +
          '  ) ' +
          '  GROUP BY ' +
          '    CodigoUbicacion, CodigoArticulo ' +
          ') fssa ' +
          'ON ' +
          '  fssa.CodigoUbicacion = fspo.CodigoUbicacion ' +
          '  AND fssa.CodigoArticulo = fspo.CodigoArticulo ' +
          '  AND fssa.CodigoUbicacion NOT IN ( ''' + SQL_Str(CodigoUbicacionExpedicion) + ''' ) ' +
          'WHERE ' +
          '  fspo.PreparacionId = ' + IntToStr(IdPreparacion) + ' ';
          //'  AND fspo.LineasPosicion = ''' + SQL_Guid_ToStr(LineasPosicion) + ''' ' +
          //'  AND fspo.CodigoUbicacion NOT IN ( ''' + SQL_Str(CodigoUbicacionExpedicion) + ''' ) ' +
          //'  AND ISNULL(fspo.CodigoUbicacion,'''') NOT IN ( ' + CodigoUbicacionesExcluidas + ' ) ';

  if Pendientes then
     sSQL := sSQL + 'AND (fspo.UdNecesarias > fspo.Udretiradas) '; // OR fspo.UdNecesariasBase > fspo.UdRetiradasBase) ';

  if SoloConStock=1 then
     sSQL := sSQL + 'AND fspo.CodigoUbicacion IS NOT NULL ';

  sSQL := sSQL +
    'ORDER BY ' +
    '  CASE ' +
    '    WHEN fspo.CodigoAlmacen IS NULL THEN ''zzzzzzzzzz'' ' +
    '    WHEN fspo.CodigoAlmacen = ''' + SQL_Str(CodigoAlmacenDefecto) + ''' THEN '''' ' +
    '    ELSE fspo.CodigoAlmacen ' +
    '  END, ' + sOrderBy;

  Q := SQL_PrepareQuery ( Conn, sSQL );
  gaLogFile.Write('---------------------------------------------', sIDCall );
  gaLogFile.Write(sSQL, sIDCall );
  gaLogFile.Write('---------------------------------------------', sIDCall );


  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write ( 'ERROR: ' + E.Message, sIDCall  );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":1,"NumPages":1,"NumRecords":' + IntToStr(iNumRegs) + ',';

  Result := Result +
    '"PaletActual":' + IntToStr(PaletActual) + ',' +
    '"CajaActual":' + IntToStr(CajaActual) + ',' +
    '"MatriculaActual":"' + JSON_Str(MatriculaActual) + '",';

  Result := Result + '"Data":[';

  iNumRegs := 0;

  Estado := SGA_GetEstadoPreparacion ( Conn, IdPreparacion );

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    CodigoAlmacen       := FS_SGA_CodigoAlmacen ( Q.FieldByName('CodigoUbicacion').AsString );
    CodigoArticulo      := Q.FieldByName('CodigoArticulo').AsString;
    Partida             := Q.FieldByName('Partida').AsString;
    PartidaSugerida     := Q.FieldByName('PartidaSugerida').AsString;
    fUnidadesAgrupacion := Q.FieldByName('UnidadesAgrupacion').AsFloat;
    FechaCaducaMin      := Q.FieldByName('FechaCaducaMin').AsDateTime;
    if FechaCaducaMin>0 then
      sFechaCaducaMin := FormatDateTime('dd/mm/yyyy', FechaCaducaMin)
    else
      sFechaCaducaMin := '';

    if fUnidadesAgrupacion = 0 then
    begin
      fUnidadesAgrupacion := 1;
    end;

    fUnidadesNecesariasAgrupadas := Q.FieldByName('UdNecesarias').AsFloat / fUnidadesAgrupacion;
    UnidadesRetiradasAgrupadas   := Q.FieldByName('UdRetiradas').AsFloat / fUnidadesAgrupacion;
    UnidadesExpedidasAgrupadas   := Q.FieldByName('UdExpedidas').AsFloat / fUnidadesAgrupacion;

    FS_SGA_UBICACION_Desglosar ( Conn, CodigoEmpresa, Q.FieldByName('CodigoUbicacion').AsString,
      tmpCodigoAlmacen,
      tmpCodigoPasillo,
      tmpCodigoEstanteria,
      tmpAltura,
      tmpFondo,
      tmpCodigoAlternativo
    );

    Result := Result +
      '{' +
      '"Indice":' + Q.FieldByName('rn').AsString + ',' +
      '"Estado":' + IntToStr(Estado) + ',' +
      '"CodigoEmpresa":' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ',' +
      '"UdNecesarias":' + SQL_FloatToStr(Q.FieldByName('UdNecesarias').AsFloat) + ',' +
      '"UdRetiradas":' + SQL_FloatToStr(Q.FieldByName('UdRetiradas').AsFloat) + ',' +
      '"UdExpedidas":' + SQL_FloatToStr(Q.FieldByName('UdExpedidas').AsFloat) + ',' +
      '"Agrupacion":"' + JSON_Str(Q.FieldByName('Agrupacion').AsString) + '",' +
      '"UdNecesariasBase":' + SQL_FloatToStr(Q.FieldByName('UdNecesariasBase').AsFloat) + ',' +
      '"UdRetiradasBase":' + SQL_FloatToStr(Q.FieldByName('UdRetiradasBase').AsFloat) + ',' +
      '"UdExpedidasBase":' + SQL_FloatToStr(Q.FieldByName('UdExpedidasBase').AsFloat) + ',' +
      '"CodigoArticulo":"' + JSON_Str(CodigoArticulo) + '",' +
      '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoArticuloAlternativo').AsString) + '",' +
      '"CodigoAlternativo2":"' + JSON_Str(Q.FieldByName('CodigoAlternativo2').AsString) + '",' +
      '"CodigoAlternativoTC":"' + JSON_Str(Q.FieldByName('CodigoAlternativoTC').AsString) + '",' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion').AsFloat) + ',' +
      '"GrupoTalla":' + IntToStr(Q.FieldByName('TratamientoTallas').AsInteger) + ',' +
      '"CodigoTalla":"' + JSON_Str(Q.FieldByName('CodigoTalla01_').AsString) + '",' +
      '"CodigoColor":"' + JSON_Str(Q.FieldByName('CodigoColor_').AsString) + '",' +
      '"DescripcionTalla":"' + JSON_Str(Q.FieldByName('DescripcionTalla').AsString) + '",' +
      '"DescripcionColor":"' + JSON_Str(Q.FieldByName('DescripcionColor').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"Descripcion2Articulo":"' + JSON_Str(Q.FieldByName('Descripcion2Articulo').AsString) + '",' +
      '"Partida":"' + JSON_Str(PartidaSugerida) + '",' +
      '"PartidaPedido":"' + JSON_Str(Partida) + '",' +
      '"PartidaSugerida":"' + JSON_Str(PartidaSugerida) + '",' +
      '"CodigoAlmacen":"' + JSON_Str(CodigoAlmacen) + '",' +
      '"PreparacionId":' + Q.FieldByName('PreparacionId').AsString + ',' +
      '"PickingId":' + IntToStr(Q.FieldByName('PickingId').AsInteger) + ',' +
      '"Orden":' + Q.FieldByName('Orden').AsString + ',' +
      '"TratamientoPartidas":' + IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('TratamientoColores').AsInteger<>0) + ',' +
      '"UnidadesStock":' + SQL_FloatToStr(Q.FieldByName('UnidadesStock').AsFloat) + ',' +
      '"UnidadesStockBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesStockBase').AsFloat) + ',' +
      //'"UnidadesStock":' + SQL_FloatToStr(iStockTotal) + ',' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
      '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '",' +
      '"CodigoUbicacion":"' + JSON_Str(Q.FieldByName('CodigoUbicacion').AsString) + '",' +
      '"CodigoUbicacionAlternativo":"' + JSON_Str(Q.FieldByName('CodigoUbicacionAlternativo').AsString) + '",' +
      '"Altura":"' + JSON_Str(tmpAltura) + '",' +
      '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
      '"UnidadesAgrupacion":' + SQL_FloatToStr(fUnidadesAgrupacion) + ',' +
      '"UnidadesNecesariasAgrupadas":' + SQL_FloatToStr(fUnidadesNecesariasAgrupadas) + ',' +
      '"UnidadesRetiradasAgrupadas":' + SQL_FloatToStr(UnidadesRetiradasAgrupadas) + ',' +
      '"UnidadesExpedidasAgrupadas":' + SQL_FloatToStr(UnidadesExpedidasAgrupadas) + ',' +
      '"LineasPosicion":"' + JSON_Str(SQL_GUID_ToStr(Q.FieldByName('LineasPosicion').AsString)) + '",' +
      '"DescripcionAgrupacion":"' + JSON_Str(Q.FieldByName('Agrupacion').AsString) + '",' +
      '"UdReservadas":' + SQL_FloatToStr(Q.FieldByName('UdReservadasExternas').AsFloat) + ',' +
      '"UdReservadasBase":' + SQL_FloatToStr(Q.FieldByName('UdReservadasExternasBase').AsFloat) + ',' +
      '"UdPickable":' + SQL_FloatToStr(Q.FieldByName('UdPickable').AsFloat) + ',' +
      '"UdPickableBase":' + SQL_FloatToStr(Q.FieldByName('UdPickableBase').AsFloat) + ',' +
      '"FechaCaducaMin":"' + sFechaCaducaMin + '"' +
      '}';

    Q.Next;

  end;

  if not bError then
    Result := Result + ']}'
  else
    Result := sUbicaciones;

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}


end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAR COMISSIONISTES DE COMANDES                                    │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getComisionistasPreparacionesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Filter: String;
  sAndWhere: String;
  sSort: String;
  sSortType: String;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  sPedidos: string;
  Tipo: Integer;
  Estado: Integer;
  sCUSTOMFunc: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  Tipo          := StrToIntDef(contentfields.values['Tipo'],-1);

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT * ' +
    'FROM ( ' +
    '  SELECT DISTINCT ' +
    '    ISNULL(t.CodigoComisionista, ''0'') AS CodigoComisionista, ISNULL(t.Comisionista, ''Sin comisionista'') AS Comisionista ' +
    'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
    'INNER JOIN FS_SGA_Picking_Preparaciones fspp WITH (NOLOCK) ' +
    'ON ' +
    '  fspp.CodigoEmpresa = fsppl.CodigoEmpresa ' +
    '  AND fspp.PreparacionId = fsppl.PreparacionId ' +
    'LEFT JOIN FS_SGA_Operarios_Preparacion fsop WITH (NOLOCK) ' +
    'ON ' +
    '  fsop.CodigoEmpresa = fspp.CodigoEmpresa ' +
    '  AND fsop.PreparacionId = fspp.PreparacionId ' +
    'INNER JOIN CabeceraPedidoCliente cpc WITH (NOLOCK) ' +
    'ON ' +
    '  fsppl.CodigoEmpresa = cpc.CodigoEmpresa ' +
    '  AND fsppl.EjercicioPedido = cpc.EjercicioPedido ' +
    '  AND fsppl.SeriePedido = cpc.SeriePedido ' +
    '  AND fsppl.NumeroPedido = cpc.NumeroPedido ' +
    'INNER JOIN LineasPedidoCliente lpc WITH (NOLOCK) ' +
    'ON ' +
    '  lpc.CodigoEmpresa = cpc.CodigoEmpresa ' +
    '  AND lpc.EjercicioPedido = cpc.EjercicioPedido ' +
    '  AND lpc.SeriePedido = cpc.SeriePedido ' +
    '  AND lpc.NumeroPedido = cpc.NumeroPedido ' +
    'INNER JOIN Transportistas t WITH (NOLOCK) ' +
    'ON ' +
    '  t.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Transportistas) + ' ' +
    '  AND t.CodigoComisionista = cpc.CodigoComisionista ' +
    'WHERE ' +
    '  fspp.Estado = ' + IntToStr(Tipo) + ' ' +
    '  AND cpc.Estado = 0 ' +
    '  AND lpc.Estado = 0 ';

  if (CodigoUsuario>1) then
    sSQL := sSQL + 'AND fsop.OperarioId = ' + IntToStr(CodigoUsuario) + ' ';

  sSQL := sSQL +
    ') AS sub ' +
    'ORDER BY ' +
    '  CASE WHEN sub.CodigoComisionista = 0 THEN 0 ELSE 1 END, sub.Comisionista';

  sSQL :=
    'SELECT * ' +
    'FROM ( ' +
    '  SELECT CodigoComisionista, Comisionista ' +
    '  FROM Comisionistas WITH (NOLOCK) ' +
    '  WHERE ' +
    '    CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Comisionistas) + ' ' +
    '    AND BajaEmpresaLc = 0 ' +
    ') sub ' +
    'ORDER BY ' +
    '  CASE WHEN sub.CodigoComisionista = 0 THEN 0 ELSE 1 END, sub.Comisionista';

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_ListComisionistas', sCUSTOMFunc ) then
  begin

    sSQL :=
      'EXEC dbo.[' + sCUSTOMFunc + '] ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(Tipo) + ', ' +
      IntToStr(CodigoUsuario);

  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoComisionista":' + IntToStr(Q.FieldByName('CodigoComisionista').AsInteger) + ',' +
      '"Comisionista":"' + JSON_Str(Q.FieldByName('Comisionista').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}


end;
// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAR TRANSPORTISTES DE COMANDES                                    │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getTransportistasPreparacionesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Filter: String;
  sAndWhere: String;
  sSort: String;
  sSortType: String;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  sPedidos: string;
  Tipo: Integer;
  Estado: Integer;
  sCUSTOMFunc: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  Tipo          := StrToIntDef(contentfields.values['Tipo'],-1);

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT * ' +
    'FROM ( ' +
    '  SELECT DISTINCT ' +
    '    ISNULL(t.CodigoTransportista, ''0'') AS CodigoTransportista, ISNULL(t.Transportista, ''Sin transportista'') AS Transportista ' +
    'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
    'INNER JOIN FS_SGA_Picking_Preparaciones fspp WITH (NOLOCK) ' +
    'ON ' +
    '  fspp.CodigoEmpresa = fsppl.CodigoEmpresa ' +
    '  AND fspp.PreparacionId = fsppl.PreparacionId ' +
    'LEFT JOIN FS_SGA_Operarios_Preparacion fsop WITH (NOLOCK) ' +
    'ON ' +
    '  fsop.CodigoEmpresa = fspp.CodigoEmpresa ' +
    '  AND fsop.PreparacionId = fspp.PreparacionId ' +
    'INNER JOIN CabeceraPedidoCliente cpc WITH (NOLOCK) ' +
    'ON ' +
    '  fsppl.CodigoEmpresa = cpc.CodigoEmpresa ' +
    '  AND fsppl.EjercicioPedido = cpc.EjercicioPedido ' +
    '  AND fsppl.SeriePedido = cpc.SeriePedido ' +
    '  AND fsppl.NumeroPedido = cpc.NumeroPedido ' +
    'INNER JOIN LineasPedidoCliente lpc WITH (NOLOCK) ' +
    'ON ' +
    '  lpc.CodigoEmpresa = cpc.CodigoEmpresa ' +
    '  AND lpc.EjercicioPedido = cpc.EjercicioPedido ' +
    '  AND lpc.SeriePedido = cpc.SeriePedido ' +
    '  AND lpc.NumeroPedido = cpc.NumeroPedido ' +
    'INNER JOIN Transportistas t WITH (NOLOCK) ' +
    'ON ' +
    '  t.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Transportistas) + ' ' +
    '  AND t.CodigoTransportista = cpc.CodigoTransportistaEnvios ' +
    'WHERE ' +
    '  fspp.Estado = ' + IntToStr(Tipo) + ' ' +
    '  AND cpc.Estado = 0 ' +
    '  AND lpc.Estado = 0 ';

  if (CodigoUsuario>1) then
    sSQL := sSQL + 'AND fsop.OperarioId = ' + IntToStr(CodigoUsuario) + ' ';

  sSQL := sSQL +
    ') AS sub ' +
    'ORDER BY ' +
    '  CASE WHEN sub.CodigoTransportista = 0 THEN 0 ELSE 1 END, sub.Transportista';

  sSQL :=
    'SELECT * ' +
    'FROM ( ' +
    '  SELECT CodigoTransportista, Transportista ' +
    '  FROM Transportistas WITH (NOLOCK) ' +
    '  WHERE ' +
    '    CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Transportistas) + ' ' +
    '    AND BajaEmpresaLc = 0 ' +
    ') sub ' +
    'ORDER BY ' +
    '  CASE WHEN sub.CodigoTransportista = 0 THEN 0 ELSE 1 END, sub.Transportista';

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_ListTransportistas', sCUSTOMFunc ) then
  begin

    sSQL :=
      'EXEC dbo.[' + sCUSTOMFunc + '] ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(Tipo) + ', ' +
      IntToStr(CodigoUsuario);

  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoTransportista":' + IntToStr(Q.FieldByName('CodigoTransportista').AsInteger) + ',' +
      '"Transportista":"' + JSON_Str(Q.FieldByName('Transportista').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}


end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAR RUTES DE COMANDES                                             │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getRutasPreparacionesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Filter: String;
  sAndWhere: String;
  sSort: String;
  sSortType: String;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  sPedidos: string;
  Tipo: Integer;
  Estado: Integer;
  sCUSTOMFunc: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  Tipo          := StrToIntDef(contentfields.values['Tipo'],-1);

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT * ' +
    'FROM ( ' +
    '  SELECT DISTINCT ' +
    '    ISNULL(r.CodigoRuta_, '''') AS CodigoRuta, ISNULL(r.Ruta_, ''Sin ruta'') AS Ruta ' +
    'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
    'INNER JOIN FS_SGA_Picking_Preparaciones fspp WITH (NOLOCK) ' +
    'ON ' +
    '  fspp.CodigoEmpresa = fsppl.CodigoEmpresa ' +
    '  AND fspp.PreparacionId = fsppl.PreparacionId ' +
    'LEFT JOIN FS_SGA_Operarios_Preparacion fsop WITH (NOLOCK) ' +
    'ON ' +
    '  fsop.CodigoEmpresa = fspp.CodigoEmpresa ' +
    '  AND fsop.PreparacionId = fspp.PreparacionId ' +
    'INNER JOIN CabeceraPedidoCliente cpc WITH (NOLOCK) ' +
    'ON ' +
    '  fsppl.CodigoEmpresa = cpc.CodigoEmpresa ' +
    '  AND fsppl.EjercicioPedido = cpc.EjercicioPedido ' +
    '  AND fsppl.SeriePedido = cpc.SeriePedido ' +
    '  AND fsppl.NumeroPedido = cpc.NumeroPedido ' +
    'INNER JOIN LineasPedidoCliente lpc WITH (NOLOCK) ' +
    'ON ' +
    '  lpc.CodigoEmpresa = cpc.CodigoEmpresa ' +
    '  AND lpc.EjercicioPedido = cpc.EjercicioPedido ' +
    '  AND lpc.SeriePedido = cpc.SeriePedido ' +
    '  AND lpc.NumeroPedido = cpc.NumeroPedido ' +
    'INNER JOIN Rutas_ r WITH (NOLOCK) ' +
    'ON ' +
    '  r.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Rutas) + ' ' +
    '  AND r.CodigoRuta_ = cpc.CodigoRuta_ ' +
    'WHERE ' +
    '  fspp.Estado = ' + IntToStr(Tipo) + ' ' +
    '  AND cpc.Estado = 0 ' +
    '  AND lpc.Estado = 0 ';

  if (CodigoUsuario>1) then
    sSQL := sSQL + 'AND fsop.OperarioId = ' + IntToStr(CodigoUsuario) + ' ';

  sSQL := sSQL +
    ') AS sub ' +
    'ORDER BY ' +
    '  CASE WHEN sub.CodigoRuta = 0 THEN 0 ELSE 1 END, sub.Ruta';

  sSQL :=
    'SELECT * ' +
    'FROM ( ' +
    '  SELECT CodigoRuta_ AS CodigoRuta, Ruta_ AS Ruta ' +
    '  FROM Rutas_ WITH (NOLOCK) ' +
    '  WHERE CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Rutas) + ' ' +
    ') AS sub ' +
    'ORDER BY ' +
    '  CASE WHEN sub.CodigoRuta = '''' THEN 0 ELSE 1 END, sub.Ruta';

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_ListRutas', sCUSTOMFunc ) then
  begin

    sSQL :=
      'EXEC dbo.[' + sCUSTOMFunc + '] ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(Tipo) + ', ' +
      IntToStr(CodigoUsuario);

  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoRuta":"' + JSON_Str(Q.FieldByName('CodigoRuta').AsString) + '",' +
      '"Ruta":"' + JSON_Str(Q.FieldByName('Ruta').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAR ZONES DE COMANDES                                             │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1getZonasPreparacionesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Filter: String;
  sAndWhere: String;
  sSort: String;
  sSortType: String;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  sPedidos: string;
  Tipo: Integer;
  Estado: Integer;
  sPROCCustom: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  Tipo          := StrToIntDef(contentfields.values['Tipo'],-1);

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT * ' +
    'FROM ( ' +
    '  SELECT DISTINCT ' +
    '    ISNULL(z.CodigoZona, 0) AS CodigoZona, ISNULL(z.Zona, ''Sin zona'') AS Zona ' +
    'FROM FS_SGA_Picking_Pedido_Lineas fsppl WITH (NOLOCK) ' +
    'INNER JOIN FS_SGA_Picking_Preparaciones fspp WITH (NOLOCK) ' +
    'ON ' +
    '  fspp.CodigoEmpresa = fsppl.CodigoEmpresa ' +
    '  AND fspp.PreparacionId = fsppl.PreparacionId ' +
    'LEFT JOIN FS_SGA_Operarios_Preparacion fsop WITH (NOLOCK) ' +
    'ON ' +
    '  fsop.CodigoEmpresa = fspp.CodigoEmpresa ' +
    '  AND fsop.PreparacionId = fspp.PreparacionId ' +
    'INNER JOIN CabeceraPedidoCliente cpc WITH (NOLOCK) ' +
    'ON ' +
    '  fsppl.CodigoEmpresa = cpc.CodigoEmpresa ' +
    '  AND fsppl.EjercicioPedido = cpc.EjercicioPedido ' +
    '  AND fsppl.SeriePedido = cpc.SeriePedido ' +
    '  AND fsppl.NumeroPedido = cpc.NumeroPedido ' +
    'INNER JOIN LineasPedidoCliente lpc WITH (NOLOCK) ' +
    'ON ' +
    '  lpc.CodigoEmpresa = cpc.CodigoEmpresa ' +
    '  AND lpc.EjercicioPedido = cpc.EjercicioPedido ' +
    '  AND lpc.SeriePedido = cpc.SeriePedido ' +
    '  AND lpc.NumeroPedido = cpc.NumeroPedido ' +
    'INNER JOIN Zonas z WITH (NOLOCK) ' +
    'ON ' +
    '  z.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Zonas) + ' ' +
    '  AND cpc.CodigoZona = z.CodigoZona ' +
    'WHERE ' +
    '  fspp.Estado = ' + IntToStr(Tipo) + ' ' +
    '  AND cpc.Estado = 0 ' +
    '  AND lpc.Estado = 0 ';

  if (CodigoUsuario>1) then
    sSQL := sSQL + 'AND fsop.OperarioId = ' + IntToStr(CodigoUsuario) + ' ';

  sSQL := sSQL +
    ') AS sub ' +
    'ORDER BY ' +
    '  CASE WHEN sub.CodigoZona = 0 THEN 0 ELSE 1 END, sub.Zona';

  sSQL :=
    'SELECT * ' +
    'FROM ( ' +
    '  SELECT CodigoZona, Zona ' +
    '  FROM Zonas WITH (NOLOCK) ' +
    '  WHERE ' +
    '    CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Zonas) + ' ' +
    ') sub ' +
    'ORDER BY ' +
    '  CASE WHEN sub.CodigoZona = 0 THEN 0 ELSE 1 END, sub.Zona';

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_ListZonas', sPROCCustom ) then
  begin

    sSQL :=
      'EXEC dbo.[' + sPROCCustom + '] ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(Tipo) + ', ' +
      IntToStr(CodigoUsuario);

  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoZona":' + IntToStr(Q.FieldByName('CodigoZona').AsInteger) + ',' +
      '"Zona":"' + JSON_Str(Q.FieldByName('Zona').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAR PROVEÏDORS D'UNA EMPRESA                                      │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listProveedoresAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Filter: String;
  sAndWhere: String;
  EmpresaOrigen: Integer;
  contentfields: TStringList;

{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := 9999; //DEFAULT_PAGE_SIZE;

  iPageSize := 9999;
  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  Filter := (contentfields.Values['Filtro']);

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sAndWhere := '';

  if Filter<>'' then begin
    sAndWhere := sAndWhere + 'AND ( ' +
                             '  p.Nombre LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  p.RazonSocial LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  p.Domicilio LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  p.CodigoProveedor LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  p.CodigoPostal LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  p.Municipio LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  p.Provincia LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  p.Telefono LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  p.Telefono2 LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  p.Telefono3 LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  p.Email1 LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  p.Email2 LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  p.CifDni LIKE ''%' + SQL_Str(Filter) + '%'' OR ' +
                             '  p.CifEuropeo LIKE ''%' + SQL_Str(Filter) + '%'' ' +
                             ')';
  end;

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM Proveedores p WITH (NOLOCK) ' +
          'WHERE ' +
          '  p.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Proveedores) + ' AND ' +
          '  p.FechaBajaLc IS NULL ' +
          sAndWhere;


  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  p.* ' +
          'FROM Proveedores p WITH (NOLOCK) ' +
          'WHERE ' +
          '  p.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Proveedores) + ' AND ' +
          '  p.FechaBajaLc IS NULL ' +
          sAndWhere +
          'ORDER BY ' +
          '  p.CodigoEmpresa, p.RazonSocial ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"CodigoProveedor":"' + Q.FieldByName('CodigoProveedor').AsString + '",' +
      '"CifEuropeo":"' + JSON_Str(Q.FieldByName('CifEuropeo').AsString) + '",' +
      '"Nombre":"' + JSON_Str(Q.FieldByName('Nombre').AsString) + '",' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"Domicilio":"' + JSON_Str(Q.FieldByName('Domicilio').AsString) + '",' +
      '"CodigoPostal":"' + JSON_Str(Q.FieldByName('CodigoPostal').AsString) + '",' +
      '"Municipio":"' + JSON_Str(Q.FieldByName('Municipio').AsString) + '",' +
      '"Provincia":"' + JSON_Str(Q.FieldByName('Provincia').AsString) + '",' +
      '"Nacion":"' + JSON_Str(Q.FieldByName('Nacion').AsString) + '",' +
      '"Telefono":"' + JSON_Str(Q.FieldByName('Telefono').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAR CAPÇALERA DE PREPARACIONS                                     │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listRecepcionesAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Tipo: Integer;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  Filter: String;
  sAndWhere: String;
  sSort: String;
  CodigoUsuario: Integer;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  sFechaAlbaranRef: string;
  sFecha: string;
  sFechaInicioRecepcion: string;
  sFechaFinRecepcion: string;
  lSortItems: TStringList;
  sortItem: String;
  sAscDesc: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],MAXINT);
  if iPageSize=0 then iPageSize := MAXINT;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  Tipo := StrToIntDef(contentfields.values['Tipo'],0);

  sSort := AnsiLowerCase((contentfields.Values['OrdenarPor']));

  lSortItems := TStringList.Create;
  lSortItems.Delimiter := '|';
  lSortItems.StrictDelimiter := TRUE;
  lSortItems.DelimitedText := sSort;

  sSort := '';

  while lSortItems.Count>0 do
  begin

    if sSort<>'' then
      sSort := sSort + ', ';

    sortItem := AnsiUpperCase(lSortItems[0]);
    sAscDesc := '';

    if LeftStr(sortItem,1)='-' then
    begin
      sAscDesc := ' DESC';
      Delete(sortItem,1,1);
    end;

    if sortItem = 'FECHA' then
    begin
      if Tipo = 0 then sSort := sSort + 'r.Fecha' + sAscDesc
      else if Tipo = 1 then sSort := sSort + 'r.FechaInicioRecepcion' + sAscDesc
      else sSort := sSort + 'r.FechaFinRecepcion' + sAscDesc;
    end else if (sortItem='RECEPCION') then
      sSort := sSort + 'r.RecepcionId' + sAscDesc
    else if (sortItem='PEDIDO') then
      sSort := sSort + 'r.EjercicioPedido' + sAscDesc + ', r.SeriePedido' + sAscDesc + ', r.NumeroPedido' + sAscDesc
    else if (sortItem='PROVEEDOR') then
      sSort := sSort + 'r.CodigoProveedor' + sAscDesc
    else
      sSort := sSort + 'r.RecepcionId' + sAscDesc;

    lSortItems.Delete(0);

  end;

  lSortItems.Free;

  if sSort='' then
  begin
    sSort := 'r.RecepcionId';
  end;

  if (Pos('recepcionid', ansilowercase(sSort))<=0) then
    sSort := sSort + ', r.RecepcionId';

  sAndWhere := '';
  sAndWhere := sAndWhere + 'AND r.Estado = ' + IntToStr(Tipo) + ' ';

  if Tipo=2 then
  begin
    sAndWhere := sAndWhere + ' AND DATEADD(day, -2, GETDATE())<=r.FechaFinRecepcion ';
  end;
  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL := 'SELECT ' +
          '  COUNT(DISTINCT r.RecepcionId) ' +
          'FROM FS_SGA_Recepciones r WITH (NOLOCK) ' +
          'INNER JOIN CabeceraPedidoProveedor cpp WITH (NOLOCK) ' +
          'ON ' +
          '  r.CodigoEmpresa = cpp.CodigoEmpresa AND ' +
          '  r.EjercicioPedido = cpp.EjercicioPedido AND ' +
          '  r.SeriePedido = cpp.SeriePedido AND ' +
          '  r.NumeroPedido = cpp.NumeroPedido ' +
          'INNER JOIN FS_SGA_Recepciones_Lineas rl WITH (NOLOCK) ' +
          'ON ' +
          '  r.CodigoEmpresa = rl.CodigoEmpresa ' +
          '  AND r.RecepcionId = rl.RecepcionId ' +
          'INNER JOIN LineasPedidoProveedor LPP WITH (NOLOCK) ' +
          'ON rl.CodigoEmpresa = LPP.CodigoEmpresa ' +
          'AND rl.EjercicioPedido = LPP.EjercicioPedido ' +
          'AND rl.SeriePedido = LPP.SeriePedido ' +
          'AND rl.NumeroPedido = LPP.NumeroPedido ' +
          'AND rl.OrdenLineaPedido = LPP.Orden ' +
          'AND rl.LineasPosicion = LPP.LineasPosicion ' +
          'WHERE ' +
          '  r.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
          //'  AND cpp.Estado = ' + IntToStr(Tipo) + ' ' +
          sAndWhere;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT DISTINCT ' +
          '  ( ' +
          '    SELECT ' +
          '      COUNT(*) ' +
          '    FROM FS_SGA_Recepciones_Lineas rl WITH (NOLOCK) ' +
          '    INNER JOIN LineasPedidoProveedor lpp WITH (NOLOCK) ' +
          '    ON ' +
          '      rl.CodigoEmpresa = lpp.CodigoEmpresa ' +
          '      AND rl.EjercicioPedido = lpp.EjercicioPedido ' +
          '      AND rl.SeriePedido = lpp.SeriePedido ' +
          '      AND rl.NumeroPedido = lpp.NumeroPedido ' +
          '      AND rl.OrdenLineaPedido = lpp.Orden ' +
          '      AND rl.LineasPosicion = lpp.LineasPosicion ' +
          '    WHERE ' +
          '      r.CodigoEmpresa = rl.CodigoEmpresa ' +
          '      AND r.RecepcionId = rl.RecepcionId ' +
          '      /*AND lpp.Estado = 0*/ ' +
          '  ) AS NumLineasTotales, ' +
          '  ( ' +
          '    SELECT ' +
          '      COUNT(*) ' +
          '    FROM FS_SGA_Recepciones_Lineas rl WITH (NOLOCK) ' +
          '    INNER JOIN LineasPedidoProveedor lpp WITH (NOLOCK) ' +
          '    ON ' +
          '      rl.CodigoEmpresa = lpp.CodigoEmpresa ' +
          '      AND rl.EjercicioPedido = lpp.EjercicioPedido ' +
          '      AND rl.SeriePedido = lpp.SeriePedido ' +
          '      AND rl.NumeroPedido = lpp.NumeroPedido ' +
          '      AND rl.OrdenLineaPedido = lpp.Orden ' +
          '      AND rl.LineasPosicion = lpp.LineasPosicion ' +
          '    WHERE ' +
          '      r.CodigoEmpresa = rl.CodigoEmpresa ' +
          '      AND r.RecepcionId = rl.RecepcionId ' +
          '      AND lpp.Estado = 0 ' +
          '      AND (rl.UdSaldo>0 OR rl.UdSaldoBase>0) ' +
          '  ) AS NumLineasPendientes, ' +
          '  r.* ' +
          'FROM FS_SGA_Recepciones r WITH (NOLOCK) ' +
          'INNER JOIN CabeceraPedidoProveedor cpp WITH (NOLOCK) ' +
          'ON ' +
          '  r.CodigoEmpresa = cpp.CodigoEmpresa AND ' +
          '  r.EjercicioPedido = cpp.EjercicioPedido AND ' +
          '  r.SeriePedido = cpp.SeriePedido AND ' +
          '  r.NumeroPedido = cpp.NumeroPedido ' +
          'INNER JOIN FS_SGA_Recepciones_Lineas rl WITH (NOLOCK) ' +
          'ON ' +
          '  r.CodigoEmpresa = rl.CodigoEmpresa ' +
          '  AND r.RecepcionId = rl.RecepcionId ' +
          'INNER JOIN LineasPedidoProveedor LPP WITH (NOLOCK) ' +
          'ON rl.CodigoEmpresa = LPP.CodigoEmpresa ' +
          'AND rl.EjercicioPedido = LPP.EjercicioPedido ' +
          'AND rl.SeriePedido = LPP.SeriePedido ' +
          'AND rl.NumeroPedido = LPP.NumeroPedido ' +
          'AND rl.OrdenLineaPedido = LPP.Orden ' +
          'AND rl.LineasPosicion = LPP.LineasPosicion ' +
          'WHERE ' +
          '  r.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
          //'  AND cpp.Estado = ' + IntToStr(Tipo) + ' ' +
          sAndWhere +
          'ORDER BY ' +
          sSort + ' ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    if (Q.FieldByName('RefFechaAlbaran').IsNull) or (Q.FieldByName('RefFechaAlbaran').AsDateTime=0) then
      sFechaAlbaranRef := FormatDateTime ( 'dd/mm/yyyy', Now)
    else
      sFechaAlbaranRef := FormatDateTime ( 'dd/mm/yyyy', Q.FieldByName('RefFechaAlbaran').AsDateTime);

    if (Q.FieldByName('Fecha').IsNull) or (Q.FieldByName('Fecha').AsDateTime=0) then
      sFecha := FormatDateTime ( 'dd/mm/yyyy', Now)
    else
      sFecha := FormatDateTime ( 'dd/mm/yyyy', Q.FieldByName('Fecha').AsDateTime);

    if (Q.FieldByName('FechaInicioRecepcion').IsNull) or (Q.FieldByName('FechaInicioRecepcion').AsDateTime=0) then
      sFechaInicioRecepcion := ''
    else
      sFechaInicioRecepcion := FormatDateTime ( 'dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaInicioRecepcion').AsDateTime);

    if (Q.FieldByName('FechaFinRecepcion').IsNull) or (Q.FieldByName('FechaFinRecepcion').AsDateTime=0) then
      sFechaFinRecepcion := ''
    else
      sFechaFinRecepcion := FormatDateTime ( 'dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaFinRecepcion').AsDateTime);

    Result := Result +
      '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"RecepcionId":' + Q.FieldByName('RecepcionId').AsString + ',' +
      '"Fecha":"' + JSON_Str(sFecha) + '",' +
      '"FechaInicioRecepcion":"' + JSON_Str(sFechaInicioRecepcion) + '",' +
      '"FechaFinRecepcion":"' + JSON_Str(sFechaFinRecepcion) + '",' +
      '"CodigoProveedor":"' + JSON_Str(Q.FieldByName('CodigoProveedor').AsString) + '",' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"IdAlbaranPro":"' + JSON_Str(Q.FieldByName('IdAlbaranPro').AsString) + '",' +
      '"Albaran":"' + JSON_Str(Q.FieldByName('Albaran').AsString) + '",' +
      '"Observaciones":"' + JSON_Str(Q.FieldByName('Observaciones').AsString) + '",' +
      '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
      '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
      '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
      '"Estado":' + Q.FieldByName('Estado').AsString + ',' +
      '"NumLineasTotales":' + Q.FieldByName('NumLineasTotales').AsString + ',' +
      '"NumLineasPendientes":' + Q.FieldByName('NumLineasPendientes').AsString + ',' +
      '"NumLineasRealizadas":' + IntToStr(Q.FieldByName('NumLineasTotales').AsInteger-Q.FieldByName('NumLineasPendientes').AsInteger) + ',' +
      '"Bultos":' + IntToStr(Q.FieldByName('Bultos').AsInteger) + ',' +
      '"Cajas":' + IntToStr(Q.FieldByName('Cajas').AsInteger) + ',' +
      '"Palets":' + IntToStr(Q.FieldByName('Palets').AsInteger) + ',' +
      '"RefAlbaran":"' + JSON_Str(Q.FieldByName('RefNumeroAlbaran').AsString) + '",' +
      '"RefFechaAlbaran":"' + JSON_Str(sFechaAlbaranRef) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT DE SUBFAMÍLIES D'UNA FAMÍLIA D'ARTICLES                       │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1listSubfamiliasAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoFamilia: String;
  Filtro: String;
  sAndWhere: String;
  EmpresaOrigen: Integer;
  contentfields: TStringList;

{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';

    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Familias' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoFamilia := (contentfields.values['CodigoFamilia']);
  if CodigoFamilia='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de familia no especificado","Data":[]}';

    Exit;
  end;

  Filtro := (contentfields.values['Filtro']);

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sAndWhere := '';

  if Filtro<>'' then begin
    sAndWhere := sAndWhere + 'AND ( ' +
      'CodigoSubfamilia LIKE ''%' + SQL_Str(Filtro) + '%'' OR ' +
      'Descripcion LIKE ''%' + SQL_Str(Filtro) + '%'' ' +
      ' ) ';
  end;

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM dbo.FS_SGA_TABLE_Familias ( ' + IntToStr(CodigoEmpresa.Familias) + ' ) ' +
          'WHERE ' +
          '  CodigoFamilia = ''' + SQL_Str(CodigoFamilia) + ''' AND ' +
          '  CodigoSubfamilia <> ''**********'' ' +
          sAndWhere;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  * ' +
          'FROM dbo.FS_SGA_TABLE_Familias ( ' + IntToStr(CodigoEmpresa.Familias) + ' ) ' +
          'WHERE ' +
          '  CodigoFamilia = ''' + SQL_Str(CodigoFamilia) + ''' AND ' +
          '  CodigoSubfamilia <> ''**********'' ' +
          sAndWhere +
          'ORDER BY ' +
          '  CodigoSubfamilia ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result + '{' +
      '"CodigoSubfamilia":"' + JSON_Str(Q.FieldByName('CodigoSubfamilia').AsString) + '",' +
      '"Descripcion":"' + JSON_Str(Q.FieldByName('Descripcion').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}




end;

{$ENDREGION}


{$REGION '--- FUNCIONS DE COMANDES I ALBARANS DE PROVEÏDOR'}

// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ LLISTAT DE COMANDES A PROVEÏDOR                                       │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1cabeceraPedidoCompraAction
 ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoProveedor: String;
  sAndWhere: String;
  EjercicioPedido: Integer;
  OrdenarPor: String;
  TipoOrden: String;
  sOrderBy: String;
  EmpresaOrigen: Integer;
  contentfields: TStringList;

{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoProveedor := (contentfields.values['CodigoProveedor']);
  EjercicioPedido := StrToIntDef(contentfields.Values['EjercicioPedido'], 0 );

  OrdenarPor := AnsiUpperCase((contentfields.values['OrdenarPor']));
  TipoOrden  := AnsiUpperCase((contentfields.values['TipoOrden']));
  sOrderBy   := '';

  if OrdenarPor='PEDIDO' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'EjercicioPedido DESC, NumeroPedido DESC, SeriePedido DESC ';
    end else begin
      sOrderBy := 'EjercicioPedido DESC, NumeroPedido, SeriePedido ';
    end;
  end else if OrdenarPor='CLIENTE' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'EjercicioPedido DESC, RazonSocial DESC, NumeroPedido DESC, SeriePedido DESC ';
    end else begin
      sOrderBy := 'EjercicioPedido, RazonSocial, NumeroPedido, SeriePedido ';
    end;
  end else if OrdenarPor='FECHA' then begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'EjercicioPedido DESC, FechaPedido DESC, NumeroPedido DESC, SeriePedido DESC ';
    end else begin
      sOrderBy := 'EjercicioPedido DESC, FechaPedido, NumeroPedido, SeriePedido ';
    end;
  end else begin
    if TipoOrden='DESC' then begin
      sOrderBy := 'EjercicioPedido DESC, SeriePedido DESC, NumeroPedido DESC ';
    end else begin
      sOrderBy := 'EjercicioPedido DESC, NumeroPedido, SeriePedido ';
    end;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sAndWhere := '';

  if CodigoProveedor<>'' then begin
    sAndWhere := sAndWhere + 'AND CodigoProveedor=''' + SQL_Str(CodigoProveedor) + ''' ';
  end;

  if EjercicioPedido<>0 then begin
    sAndWhere := sAndWhere + 'AND EjercicioPedido=' + IntToStr(EjercicioPedido) + ' ';
  end;

  sSQL := 'SELECT ' +
          '  COUNT(*) ' +
          'FROM CabeceraPedidoProveedor WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' AND ' +
          //'  FechaPedido >= DATEADD(day,-30,GETDATE()) AND ' +
          '  Estado <> 2 ' +
          sAndWhere;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL := 'SELECT ' +
          '  * ' +
          'FROM CabeceraPedidoProveedor WITH (NOLOCK) ' +
          'WHERE ' +
          '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' AND ' +
          //'  FechaPedido >= DATEADD(day,-30,GETDATE()) AND ' +
          '  Estado <> 2 ' +
          sAndWhere +
          'ORDER BY ' +
          sOrderBy + ' ' +
          'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
          'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoEmpresa":' + Q.FieldByName('CodigoEmpresa').AsString + ',' +
      '"IdDelegacion":"' + Q.FieldByName('IdDelegacion').AsString + '",' +
      '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
      '"SeriePedido":"' + Q.FieldByName('SeriePedido').AsString + '",' +
      '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ', ' +
      '"CodigoProveedor":"' + Q.FieldByName('CodigoProveedor').AsString + '",' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"Nombre":"' + JSON_Str(Q.FieldByName('Nombre').AsString) + '",' +
      '"Domicilio":"' + JSON_Str(Q.FieldByName('Domicilio').AsString) + '",' +
      '"CodigoPostal":"' + JSON_Str(Q.FieldByName('CodigoPostal').AsString) + '",' +
      '"Municipio":"' + JSON_Str(Q.FieldByName('Municipio').AsString) + '",' +
      '"Provincia":"' + JSON_Str(Q.FieldByName('Provincia').AsString) + '",' +
      '"Nacion":"' + JSON_Str(Q.FieldByName('Nacion').AsString) + '",' +
      '"FechaPedido":"' + FormatDateTime('dd/mm/yyyy', Q.FieldByName('FechaPedido').AsDateTime) + '",' +
      '"NumeroLineas":' + Q.FieldByName('NumeroLineas').AsString + ',' +
      '"Municipio":"' + JSON_Str(Q.FieldByName('Municipio').AsString) + '",' +
      '"Provincia":"' + JSON_Str(Q.FieldByName('Provincia').AsString) + '",' +
      '"Nacion":"' + JSON_Str(Q.FieldByName('Nacion').AsString) + '",' +
      '"Estado":' + Q.FieldByName('Estado').AsString + '' +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}



end;

{$ENDREGION}


{$REGION '--- FUNCIONS D´ETIQUETES'}

{$ENDREGION}


{$REGION '--- FUNCIONS DE COMANDES I ALBARANS DE PROVEÏDOR'}

{$ENDREGION}



function FS_SGA_ObtenerMovimientosPreparacion ( Conn: TADOConnection; IdPreparacion: Integer; CodigoEmpresa: TOrigenCodigoEmpresa;
  LineasPosicion, CodigoArticulo, Partida, CodigoTalla, CodigoColor, CodigoAlmacen: String; MostrarPartidas: Integer;
  var Error: Boolean; var iStockTotal: Double ): String;

{$REGION 'Declaració de variables'}
var
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoUbicacion: string;
  sDesglose: string;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  PickingId: Integer;
  sMostrarPartidas: String;
  YY: WORD;
  sFechaUltimaEntrada: string;
  FechaUltimaEntrada: TDateTime;
  FechaCaduca: TDateTime;
  sFechaCaduca: string;
  TratamientoPartidas: Boolean;
  sMostrarAlmacenes: string;
  CodigoUbicacionExpedicion: String;
  fUnidadesAgrupacion: Double;
  DefaultUbi: TDefaultUbicaciones;
  sFUNCCustom: string;
{$ENDREGION}

begin

  Error := FALSE;

  iStockTotal := 0;

  {$REGION 'Preparació de paràmetres'}

  gaLogFile.Write('empresa origen=' + Inttostr(Codigoempresa.EmpresaOrigen));
  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  sMostrarPartidas := '';

  if MostrarPartidas<>1 then begin
    //sOrderBy := 'MIN(CASE WHEN FechaCaduca IS NULL THEN ' +
    //  SQL_DateToStr(EncodeDate(9999,12,31)) + ' ELSE FechaCaduca END), Partida, CodigoUbicacion ';
    sMostrarPartidas := 'AND fsap.Partida=''' + SQL_Str(Partida) + ''' ';
  end else begin
    //sOrderBy := 'MIN(CASE WHEN FechaCaduca IS NULL THEN ' +
    //  SQL_DateToStr(EncodeDate(9999,12,31)) + ' ELSE FechaCaduca END), CodigoUbicacion, Partida ';
  end;

  sOrderBy := '';
  if SQL_Function_Exists ( Conn, 'FS_SGA_TABLE_OrderUbicaciones', sFUNCCustom ) then
  begin
    sSQL := 'SELECT dbo.[' + sFUNCCustom + '] ( ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(IdPreparacion) +
    ' )';

    sOrderBy := SQL_Execute ( Conn,  sSQL );
  end;

  if (sOrderBy='') or (sOrderBy='0') then
    sOrderBy := 'CASE WHEN FechaCaduca IS NULL THEN CONVERT(DATETIME,''31/12/1999'',103) ELSE FechaCaduca END, Partida, CodigoUbicacion';

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
      'SELECT AlmacenPreparacion ' +
      'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
      'WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  CodigoAlmacen := SQL_Execute ( Conn, sSQL );

  if (CodigoAlmacen='') or (CodigoAlmacen='0') then
  begin
    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacion, CodigoEmpresa.EmpresaOrigen );
    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacion );
  end;

  FS_SGA_ObtenerUbicacionesAlmacen ( Conn, CodigoEmpresa, CodigoAlmacen, DefaultUbi );
  CodigoUbicacionExpedicion := DefaultUbi.UbicacionExpediciones;

  //PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacionExpedicion, CodigoEmpresa.EmpresaOrigen );

  sSQL :=
    'SELECT ' +
    '  DISTINCT fsap.CodigoEmpresa, fsap.IdPreparacion, fsap.CodigoArticulo, fsap.Partida, fsap.CodigoTalla01_, ' +
    '  fsap.CodigoColor_, fsap.Cantidad, fsap.UnidadMedida, fsap.CantidadBase, fsap.UnidadMedidaBase, ' +
    '  fsap.CodigoAgrupacion, fsap.UnidadesAgrupacion, ISNULL(agrup.Agrupacion,''UNIDADES'') AS Agrupacion, ' +
    '  ISNULL(agrup.DescripcionArticulo,'''') AS DescripcionAgrupacion ' +
    'FROM FS_SGA_AcumuladoPendiente fsap WITH (NOLOCK) ' +
    'LEFT JOIN Agrupaciones agrup WITH (NOLOCK) ' +
    'ON agrup.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
    'AND agrup.CodigoArticulo = fsap.CodigoArticulo ' +
    'AND agrup.CodigoAgrupacion = fsap.CodigoAgrupacion ' +
    'AND agrup.UnidadMedida1_ = fsap.UnidadMedida ' +
    'WHERE ' +
    '  fsap.IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND fsap.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
    '  AND fsap.CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
    '  AND fsap.CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
    '  AND fsap.PickingId = 0 ' +
    '  AND (fsap.LineaPedidoAsignada IN ( ''' + SQL_GUID_ToStr(GUID0) + ''', ''' + SQL_GUID_ToStr(LineasPosicion) + ''')) ' +
    '  AND (fsap.Cantidad<>0 OR fsap.CantidadBase<>0) ' +
    sMostrarPartidas + ' ' +
    'ORDER BY ' +
    '  fsap.UnidadesAgrupacion DESC';

  //galogfile.Write('FS_SGA_ObtenerMovimientosPreparacion: ' + sSQL);

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.SQL.Text := sSQL;
  try
    Q.Open;
  except
    on E:Exception do
    begin
      Q.Close;
      FreeAndNil(Q);
      Result := '"Ubicaciones":[]';
      gaLogFile.Write_DBException(E,sSQL,'Error al recuperar la ubicación para la preparación', CONST_LOGID_BBDD );
      Exit;
    end;
  end;

  Result := '"Preparaciones":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    iStockTotal := iStockTotal + Q.FieldByName('CantidadBase').AsFloat;
    fUnidadesAgrupacion := Q.FieldByName('UnidadesAgrupacion').AsFloat;

    Result := Result + '{' +
                       '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
                       '"CodigoAgrupacion":' + IntToStr(Q.FieldByName('CodigoAgrupacion').AsInteger) + ',' +
                       '"Agrupacion":"' + JSON_Str(Q.FieldByName('Agrupacion').AsString) + '",' +
                       '"DescripcionAgrupacion":"' + JSON_Str(Q.FieldByName('DescripcionAgrupacion').AsString) + '",' +
                       '"DescripcionAgrupacion":"' + JSON_Str(Q.FieldByName('DescripcionAgrupacion').AsString) + '",' +
                       '"UnidadesAgrupacion":' + SQL_FloatToStr(Q.FieldByName('UnidadesAgrupacion').AsFloat) + ',' +
                       '"Cantidad":' + SQL_FloatToStr(Q.FieldByName('Cantidad').AsFloat / fUnidadesAgrupacion) + ',' +
                       '"CantidadBase":' + SQL_FloatToStr(Q.FieldByName('CantidadBase').AsFloat) + ',' +
                       '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
                       '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '"' +
                       '}';

    Q.Next;

  end;

  Result := Result + ']';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;

function FS_SGA_ObtenerUbicaciones ( Conn: TADOConnection; IdPreparacion: Integer; CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoArticulo, UnidadMedida, Partida, CodigoTalla, CodigoColor, CodigoAlmacen, CodigoCliente: String;
  PermitirCaducados: String; MostrarPartidas: Integer; SoloConStock: Boolean;
  var Error: Boolean; var iStockTotal: Double ): String;

{$REGION 'Declaració de variables'}
var
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  CodigoUbicacion: string;
  sDesglose: string;
  OrdenarPor: String;
  sOrderBy: String;
  TipoOrden: String;
  PickingId: Integer;
  sMostrarPartidas: String;
  YY: WORD;
  sFechaUltimaEntrada: string;
  FechaUltimaEntrada: TDateTime;
  FechaCaduca: TDateTime;
  sFechaCaduca: string;
  TratamientoPartidas: Boolean;
  sMostrarAlmacenes: string;
  CodigoUbicacionExpedicion: String;
  DefaultUbi: TDefaultUbicaciones;
  sFUNCCustom: string;
  sCaducados: string;
  sSoloConStock: string;
{$ENDREGION}

begin

  Error := FALSE;

  iStockTotal := 0;

  {$REGION 'Preparació de paràmetres'}

  gaLogFile.Write('empresa origen=' + Inttostr(Codigoempresa.EmpresaOrigen));
  YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  sMostrarAlmacenes := 'AND CodigoAlmacen=''' + SQL_Str(CodigoAlmacen) + ''' ';

  sCaducados := '';
  if PermitirCaducados='NO PERMITIR' then
  begin
    sCaducados := 'AND ISNULL(FechaCaduca,''99991231'') >= ' + SQL_DateToStr(Date()) + ' ';
  end;

  sSoloConStock := '';
  if SoloConStock then
  begin
    sSoloConStock := 'AND ((Tipo=0 AND (UnidadesSaldoBase>0 OR UnidadesUsadasBase>0)) OR (Tipo=1)) ';
  end;

  if MostrarPartidas<>1 then begin
    //sOrderBy := 'MIN(CASE WHEN FechaCaduca IS NULL THEN ' +
    //  SQL_DateToStr(EncodeDate(9999,12,31)) + ' ELSE FechaCaduca END), Partida, CodigoUbicacion ';
    sMostrarPartidas := 'AND Partida=''' + SQL_Str(Partida) + ''' ';
  end else begin
    //sOrderBy := 'MIN(CASE WHEN FechaCaduca IS NULL THEN ' +
    //  SQL_DateToStr(EncodeDate(9999,12,31)) + ' ELSE FechaCaduca END), CodigoUbicacion, Partida ';
  end;

  sOrderBy := '';
  if SQL_Function_Exists ( Conn, 'FS_SGA_TABLE_OrderUbicaciones', sFUNCCustom ) then
  begin
    sSQL := 'SELECT dbo.[' + sFUNCCustom + '] ( ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(IdPreparacion) +
    ' )';

    sOrderBy := SQL_Execute ( Conn,  sSQL );
  end;

  if (sOrderBy='') or (sOrderBy='0') then
    sOrderBy := 'CASE WHEN FechaCaduca IS NULL THEN CONVERT(DATETIME,''31/12/9999'',103) ELSE FechaCaduca END, Partida, CodigoUbicacion';

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
      'SELECT AlmacenPreparacion ' +
      'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
      'WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  //CodigoAlmacen := SQL_Execute ( Conn, sSQL );

  if (CodigoAlmacen='') or (CodigoAlmacen='0') then
  begin
    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacion, CodigoEmpresa.EmpresaOrigen );
    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacion );
  end;

  FS_SGA_ObtenerUbicacionesAlmacen ( Conn, CodigoEmpresa, CodigoAlmacen, DefaultUbi );
  CodigoUbicacionExpedicion := DefaultUbi.UbicacionExpediciones;

  //PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacionExpedicion, CodigoEmpresa.EmpresaOrigen );

  sSQL := 'SELECT ' +
          '  CodigoAlmacen, Almacen, CodigoZona, NombreZona, CodigoUbicacion, CodigoPasillo, ' +
          '  DescripcionPasillo, CodigoEstanteria, Altura, Fondo, Picking, Bloqueada, Inactiva, ' +
          '  MultiRef, MultiLote, Rotacion, CodigoArticulo, Partida, ' +
          '  CodigoFamilia, CodigoSubfamilia, CodigoAlternativo, codigoUbicacionAlternativo, ' +
          '  CodigoAlternativo2, TratamientoPartidas, ' +
          '  SUM(UnidadesSaldo) AS UnidadesSaldo, SUM(UnidadesUsadas) AS UnidadesUsadas, ' +
          '  MIN(FechaPrimeraEntrada) AS FechaPrimeraEntrada, MIN(FechaUltimaEntrada) AS FechaUltimaEntrada, ' +
          '  MAX(FechaUltimaSalida) AS FechaUltimaSalida, MIN(CASE WHEN FechaCaduca IS NULL THEN ' +
          SQL_DateToStr(EncodeDate(9999,12,31)) + ' ELSE FechaCaduca END) AS FechaCaduca ' +
          'FROM FS_SGA_TABLE_UbicacionsPickingPedidos ( ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
          'WHERE ' +
          '  Ejercicio = ' + IntToStr ( YY ) + ' ' +
          '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
          '  AND CodigoUbicacion <> ''' + SQL_Str(CodigoUbicacionExpedicion) + ''' ' +
          '  AND CodigoUbicacion NOT IN ( ' +
          '    SELECT EXCL_Ubicacion ' +
          '    FROM FS_SGA_UbicacionesExcluidas WITH (NOLOCK) ' +
          '    WHERE EXCL_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.Almacenes) + ' ) ' +
          '      AND EXCL_Tipo = 0 ' +
          '  ) ' +
          sMostrarAlmacenes +
          sMostrarPartidas +
          sCaducados +
          sSoloConStock +
          'GROUP BY ' +
          '  CodigoAlmacen, Almacen, CodigoZona, NombreZona, CodigoUbicacion, CodigoPasillo, ' +
          '  DescripcionPasillo, CodigoEstanteria, Altura, Fondo, Picking, Bloqueada, Inactiva, ' +
          '  MultiRef, MultiLote, Rotacion, CodigoArticulo, UnidadMedida, Partida, ' +
          '  CodigoFamilia, CodigoSubfamilia, CodigoAlternativo, codigoUbicacionAlternativo, ' +
          '  CodigoAlternativo2, TratamientoPartidas ' +
          'ORDER BY ' +
          sOrderBy;

  if SQL_Function_Exists ( Conn, 'FS_SGA_TABLE_DetalleUbicacionesOrderCompleto', sFUNCCustom ) then
  begin

    sSQL :=
      'SELECT ' +
      '  * ' +
      'FROM dbo.[' + sFUNCCustom + '] ( ' +
      IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
      IntToStr(YY) + ', ' +
      '''' + SQL_Str(CodigoArticulo) + ''', ' +
      '''' + SQL_Str(UnidadMedida) + ''', ' +
      '''' + SQL_Str(CodigoUbicacionExpedicion) + ''', ' +
      '''' + SQL_Str(CodigoAlmacen) + ''', ' +
      '''' + SQL_Str(CodigoCliente) + ''', ' +
      '''' + SQL_Str(Partida) + ''', ' +
      '''' + SQL_Str(CodigoTalla) + ''', ' +
      '''' + SQL_Str(CodigoColor) + ''', ' +
      IntToStr(IdPreparacion) + ' ' +
      ') ' +
      'WHERE 1 = 1 ' + sCaducados + ' ' + sSoloConStock + ' ' +
      'ORDER BY CASE WHEN CodigoAlmacen=''' + SQL_Str(CodigoAlmacen) + ''' THEN '''' ELSE CodigoAlmacen END, Tipo, ' +
      sOrderBy;

  end;

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.SQL.Text := sSQL;
  try
    Q.Open;
  except
    on E:Exception do
    begin
      Q.Close;
      FreeAndNil(Q);
      Result := '"Ubicaciones":[]';
      gaLogFile.Write_DBException(E,sSQL,'Error al recuperar la ubicación para la preparación', CONST_LOGID_BBDD );
      Exit;
    end;
  end;

  Result := '"Ubicaciones":[';
  iNumRegs := 0;

  while not Q.Eof do begin

    if iNumRegs<>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    FechaUltimaEntrada := Q.FieldByName('FechaUltimaEntrada').AsDateTime;
    if FechaUltimaEntrada=0 then
      FechaUltimaEntrada := Q.FieldByName('FechaPrimeraEntrada').AsDateTime;
    if FechaUltimaEntrada=0 then
      sFechaUltimaEntrada := ''
    else
      sFechaUltimaEntrada := FormatDateTime('dd/mm/yyyy',FechaUltimaEntrada);

    FechaCaduca := Q.FieldByName('FechaCaduca').AsDateTime;
    if FechaCaduca=0 then
      sFechaCaduca := ''
    else
      sFechaCaduca := FormatDateTime('dd/mm/yyyy',FechaCaduca);

    iStockTotal := iStockTotal + Q.FieldByName('UnidadesSaldo').AsFloat;

    Result := Result + '{' +
                       '"CodigoAlmacen":"' + JSON_Str(Q.FieldByName('CodigoAlmacen').AsString) + '",' +
                       '"Tipo":' + IntToStr(Q.FieldByName('Tipo').AsInteger) + ',' +
                       '"Almacen":"' + JSON_Str(Q.FieldByName('Almacen').AsString) + '",' +
                       '"CodigoZona":"' + JSON_Str(Q.FieldByName('CodigoZona').AsString) + '",' +
                       '"NombreZona":"' + JSON_Str(Q.FieldByName('NombreZona').AsString) + '",' +
                       '"CodigoUbicacion":"' + JSON_Str(Q.FieldByName('CodigoUbicacion').AsString) + '",' +
                       '"CodigoUbicacionAlternativo":"' + JSON_Str(Q.FieldByName('CodigoUbicacionAlternativo').AsString) + '",' +
                       '"CodigoPasillo":"' + JSON_Str(Q.FieldByName('CodigoPasillo').AsString) + '",' +
                       '"DescripcionPasillo":"' + JSON_Str(Q.FieldByName('DescripcionPasillo').AsString) + '",' +
                       '"CodigoEstanteria":"' + JSON_Str(Q.FieldByName('CodigoEstanteria').AsString) + '",' +
                       '"Altura":"' + JSON_Str(Q.FieldByName('Altura').AsString) + '",' +
                       '"Fondo":"' + JSON_Str(Q.FieldByName('Fondo').AsString) + '",' +
                       '"Picking":' + SQL_BooleanToStr(Q.FieldByName('Picking').AsBoolean) + ',' +
                       '"Bloqueada":' + SQL_BooleanToStr(Q.FieldByName('Bloqueada').AsBoolean) + ',' +
                       '"Inactiva":' + SQL_BooleanToStr(Q.FieldByName('Inactiva').AsBoolean) + ',' +
                       '"Partida":"' + JSON_Str(Q.FieldByName('Partida').AsString) + '",' +
                       '"UnidadesSaldo":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldo').AsFloat) + ',' +
                       '"UnidadesSaldoBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesSaldoBase').AsFloat) + ',' +
                       '"FechaUltimaEntrada":"' + sFechaUltimaEntrada + '",' +
                       '"FechaCaduca":"' + sFechaCaduca + '",' +
                       '"UnidadesUsadas":' + SQL_FloatToStr(Q.FieldByName('UnidadesUsadas').AsFloat) + ',' +
                       '"UnidadesUsadasBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesUsadasBase').AsFloat) + ',' +
                       '"UnidadesReservadas":' + SQL_FloatToStr(Q.FieldByName('UnidadesReservadas').AsFloat) + ',' +
                       '"UnidadesReservadasBase":' + SQL_FloatToStr(Q.FieldByName('UnidadesReservadasBase').AsFloat) + ',' +
                       '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString)) + '",' +
                       '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString)) + '"' +
                       '}';

    Q.Next;

  end;

  Result := Result + ']';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


function BARCODE_Tipo ( Conn: TADOConnection; CodigoEmpresa: TOrigenCodigoEmpresa; CodigoAlmacen: String; var Barcode: String ): Integer;
var
  sSQL: String;
  Q: TADOQuery;
  t: TStringList;
  parser: TFSBarcodeParser;
  pbc: TFSParsedBarCode;
  i: Integer;
  sBC: String;
begin

  Result := 0;

  if LeftStr(Barcode,1)=']' then
    Delete(Barcode,1,3);

 //if (LeftStr(BarCode,4)='(00)') and (Length(BarCode)=22) or (LeftStr(BarCode,2)='00') and (Length(BarCode)=20) or (Length(BarCode)=18) then
  if (LeftStr(BarCode,4)='(00)') or (LeftStr(BarCode,2)='00') or (Length(BarCode)=18) then
  begin
    sSQL := 'SELECT COUNT(Matricula) ' +
            'FROM FS_SGA_Palet WITH (NOLOCK) ' +
            'WHERE ' +
            '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
            '  AND Matricula = ''' + SQL_Str(RightStr(BarCode,18)) + ''' ';
    if SQL_Execute ( Conn, sSQL )>0 then
    begin
      Result := 50;
      if (LeftStr(BarCode,4)='(00)') and (Length(BarCode)=22) or (LeftStr(BarCode,2)='00') and (Length(BarCode)=20) or (Length(BarCode)=18) then
        Result := 40;
      Exit;
    end;
  end;

  if LeftStr(BarCode,1)='(' then
  begin
    Result := 4;
    Exit;
  end;

  sSQL := 'SELECT COUNT(CodigoUbicacion) ' +
          'FROM FS_SGA_ESTR_UBICA WITH (NOLOCK) ' +
          'WHERE CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ' +
          'AND (CodigoUbicacion = ''' + SQL_Str(BarCode) + ''' ' +
          'OR CodigoAlternativo = ''' + SQL_Str(BarCode) + ''')';
  if SQL_Execute ( Conn, sSQL )>0 then
  begin
    sSQL := 'SELECT CodigoUbicacion ' +
            'FROM FS_SGA_ESTR_UBICA WITH (NOLOCK) ' +
            'WHERE CodigoAlmacen = ''' + SQL_Str(CodigoAlmacen) + ''' ' +
            'AND (CodigoUbicacion = ''' + SQL_Str(BarCode) + ''' ' +
            'OR CodigoAlternativo = ''' + SQL_Str(BarCode) + ''')';
    Barcode := SQL_Execute ( Conn, sSQL );
    Result := 2;
    Exit;
  end;


  sSQL := 'SELECT COUNT(CodigoArticulo) ' +
          'FROM Agrupaciones WITH (NOLOCK) ' +
          'WHERE CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
          'AND CodigoAlternativo=''' + SQL_Str(BarCode) + ''' ';
  if SQL_Execute ( Conn, sSQL )>0 then
  begin
    Result := 11;
    Exit;
  end;

  sSQL := 'SELECT COUNT(CodigoColor_) ' +
          'FROM CodigosTallaColor WITH (NOLOCK) ' +
          'WHERE CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
          'AND CodigoAlternativo = ''' + SQL_Str(BarCode) + '''';
  if SQL_Execute ( Conn, sSQL )>0 then
  begin
    Result := 12;
    Exit;
  end;

  sSQL := 'SELECT COUNT(CodigoArticulo) ' +
          'FROM FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) ' +
          'WHERE CodigoArticulo = ''' + SQL_Str(BarCode) + ''' ' +
          'OR CodigoAlternativo = ''' + SQL_Str(BarCode) + ''' ' +
          'OR CodigoAlternativo2 = ''' + SQL_Str(BarCode) + '''';
  if SQL_Execute ( Conn, sSQL )>0 then
  begin
    Result := 1;
    Exit;
  end;


  (*
  sSQL := 'SELECT * FROM FS_SGA_Barcode128_Read ( ' + IntToStr(CodigoEmpresa) + ', ''' + SQL_Str(Barcode) + ''' )';
  Q := SQL_PrepareQuery ( Conn, sSQL );

  try
    Q.Open;
  except
    on E:Exception do
    begin
      gaLogFile.Write_DBException(E,sSQL,'Error al recuperar los parámetros del GS1-128 vía procedure', CONST_LOGID_BBDD );
      Q.Close;
      FreeAndNil(Q);
      Result := 0;
      Exit;
    end;
  end;

  if ((not Q.EOF) and (q.FieldByName('CodigoArticulo').AsString<>'')) then
  begin
    Result := 4; // BARCODE128
    Q.Close;
    FreeAndNil(Q);
    Exit;
  end;
  *)

  t := TStringList.Create;
  t.Delimiter := '.';
  t.StrictDelimiter := true;
  t.DelimitedText := Barcode;

  if t.Count=5 then
  begin
    Result := 2;
    FreeAndNil(t);
    Exit;
  end;

  if t.Count=3 then begin
    Result := 3;
    Exit;
  end;
  (*

    sSQL := 'SELECT COUNT ( * ) FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
            'WHERE preparacionId = ' + t[0] + ' ' +
            'AND identificadorExpedicion = ' + t[1];
    try
      if SQL_Execute ( Conn, sSQL )>0 then
      begin
        Result := 3;
        FreeAndNil(t);
        Exit;
      end;
    except
    end;
  end;        *)

  try
    parser := TFSBarcodeParser.Create(gsGS1GroupSeparator);
    parser.SetFNCChars(gsGS1GroupSeparator);
    sBC := Barcode;
    while (sBC<>'') and (sBC[1]=chr($1D)) do
      Delete(sBC,1,1);
    pbc    := parser.ParseBarcode(sBC);
    if (pbc.errorCode=0) then
    begin
      Barcode := parser.ReadHumanCode();
      if (pbc.parsedCodeItems[0].ai='00') then
      begin
        if Length(pbc.parsedCodeItems)=1 then
        begin
          Result := 40;
        end else begin
          Result := 50;
        end;
      end else
        Result := 4;
      FreeAndNil(parser);
      Exit;
    end;
    FreeAndNil(parser);
  except
    on E:Exception do
    begin
      gaLogFile.Write_DBException(E,'','Error al parsear el código de barras: ' + Barcode, CONST_LOGID_GENERAL );
    end;
  end;


  // Intentem parsejar el codi amb el parser genèric de GS1
  (*
  try
    parser := TFSBarcodeParser.Create(gsGS1GroupSeparator);
    parser.SetFNCChars(gsGS1GroupSeparator);
    pbc    := parser.ParseBarcode(Barcode);
    FreeAndNil(parser);
  except
    on E:Exception do
    begin
      gaLogFile.Write_DBException(E,'','Error al parsear el código de barras: ' + Barcode, CONST_LOGID_GENERAL );
    end;
  end;
  *)

  (*if pbc.errorCode=0 then begin
    if pbc.errorCode=0 then begin
      BarCode := '';
      for i := 0 to Length(pbc.parsedCodeItems) - 1 do
      begin
        BarCode := BarCode + VarToStr(pbc.parsedCodeItems[i].codestring);
      end;
    end;
    Result := 4; // BARCODE128
    Exit;
  end;*)

end;


procedure WebModule1paletsEnUbicacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoUbicacion: String;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  sPalets: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUbicacion := contentfields.values['CodigoUbicacion'];
  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación no especificado","Data":[]}';
    Exit;
  end;

  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de ubicación incorrecto","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  // Recuperem les unitats de mesura

  sSQL :=
    'SELECT ' +
    '  * ' +
    'FROM FS_SGA_Palet WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '  AND CodigoUbicacionActual = ''' + SQL_Str(CodigoUbicacion) + ''' ' +
    '  AND Estado IN ( 1, 2 ) ' + // palets normals o bloquejats, els inactius i donats de baixa no es poden moure
    'ORDER BY ' +
    '  Matricula';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  Result := '{"Result":"OK","Error":"","Data":[{"Palets":[';

  sPalets := '';

  while not Q.Eof do
  begin

    if sPalets<>'' then
      sPalets := sPalets + ',';

    sPalets := sPalets +
      '{' +
      '"Matricula":"' + JSON_StR(Q.FieldByName('Matricula').AsString) + '",' +
      '"Estado":' + IntToStr(Q.FieldByName('Estado').AsInteger) +
      '}';

    Q.Next;

  end;

  Result := Result + sPalets + ']}]}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


procedure WebModule1checkUbicacionPaletAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoUbicacion: String;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  CodigoUsuario: Integer;
  Matricula: String;
  sPalets: string;
  Estados: String;
  sReserva: string;
  sPackagings: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario   := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  CodigoUbicacion := contentfields.values['CodigoUbicacion'];
  Matricula       := contentfields.values['Matricula'];
  Estados         := contentfields.values['Estados'];

  if Estados='' then
  begin
    Estados := '1,2';
  end;

  {$ENDREGION}

  {$REGION 'Mirem si hi ha palets a la ubicació'}

  sSQL :=
    'SELECT FSP.*, FSPD.Dt_Nombre, C.RazonSocial, CAD.Cadena_ AS RazonSocialCadena, FSPMB.DescripcionMotivo ' +
    'FROM FS_SGA_Palet FSP WITH (NOLOCK) ' +
    'LEFT JOIN FS_SGA_PackagingDetalle FSPD WITH (NOLOCK) ' +
    'ON ' +
    '  FSPD.Dt_Id = FSP.PackagingId ' +
    'LEFT JOIN Clientes C WITH (NOLOCK) ' +
    'ON ' +
    '  C.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Clientes) + ' ' +
    '  AND C.CodigoCliente = FSP.CodigoCliente ' +
    'LEFT JOIN Cadenas_ CAD WITH (NOLOCK) ' +
    'ON ' +
    '  CAD.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Clientes) + ' ' +
    '  AND CAD.CodigoCadena_ = FSP.CodigoCadena ' +
    'LEFT JOIN FS_SGA_Palet_MotivosBloqueo FSPMB WITH (NOLOCK) ' +
    'ON ' +
    '  FSPMB.CodigoMotivo = FSP.CodigoMotivoBloqueo ' +
    'WHERE ' +
    '  FSP.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '  AND FSP.CodigoUbicacionActual = ''' + SQL_Str(CodigoUbicacion) + ''' ' +
    '  AND FSP.Estado IN ( ' + Estados + ' ) ' +
    'ORDER BY ' +
    '  FSP.Matricula';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  sPackagings := FS_SGA_PackagingsUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );

  Result := '{"Result":"OK","Error":"","Data":[';
  sPalets := '';
  while not Q.EOF do
  begin

    if sPalets<>'' then
      sPalets := sPalets + ',';

    sPalets := sPalets +
      '{' +
      '"Matricula":"' + JSON_Str(Q.FieldByName('Matricula').AsString) + '",' +
      '"FechaCreacion":"' + FormatDateTime('dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaCreacion').AsDateTime) + '",' +
      '"PesoNetoTotal":' + SQL_FloatToStr(Q.FieldByName('PesoNetoTotal').AsFloat) + ',' +
      '"PesoBrutoTotal":' + SQL_FloatToStr(Q.FieldByName('PesoBrutoTotal').AsFloat) + ',' +
      '"VolumenTotal":' + SQL_FloatToStr(Q.FieldByName('VolumenTotal').AsFloat) + ',' +
      '"PackagingId":' + IntToStr(Q.FieldByName('PackagingId').AsInteger) + ',' +
      '"PackagingName":"' + JSON_Str(Q.FieldByName('Dt_Nombre').AsString) + '",' +
      '"Estado":' + IntToStr(Q.FieldByName('Estado').AsInteger) + ',' +
      '"CodigoMotivoBloqueo":' + IntToStr(Q.FieldByName('CodigoMotivoBloqueo').AsInteger) + ',' +
      '"DescripcionMotivoBloqueo":"' + JSON_Str(Q.FieldByName('DescripcionMotivo').AsString) + '",' +
      '"TipoReserva":' + IntToStr(Q.FieldByName('TipoReserva').AsInteger) + ',' +
      '"CodigoCliente":"' + JSON_Str(Q.FieldByName('CodigoCliente').AsString) + '",' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"CodigoCadena":"' + JSON_Str(Q.FieldByName('CodigoCadena').AsString) + '",' +
      '"RazonSocialCadena":"' + JSON_Str(Q.FieldByName('RazonSocialCadena').AsString) + '",' +
      '"EjercicioPedido":' + IntToStr(Q.FieldByName('EjercicioPedido').AsInteger) + ',' +
      '"SeriePedido":"' + JSON_Str(Q.FieldByName('SeriePedido').AsString) + '",' +
      '"NumeroPedido":' + IntToStr(Q.FieldByName('NumeroPedido').AsInteger) + ',' +
      '"Orden":' + IntToStr(Q.FieldByName('Orden').AsInteger) + ',' +
      '"LineasPosicion":"' + SQL_GUID_ToStr(Q.FieldByName('LineasPosicion').AsString) + '",' +
      '"IdPreparacion":' + IntToStr(Q.FieldByName('IdPreparacion').AsInteger) +
      '}';

    Q.Next;

  end;

  Q.Close;
  FreeAndNil(Q);

  Result := Result +
    sPalets + '], ' +
    '"Packagings":[' + sPackagings + ']' +
    '}';

  {$ENDREGION}

end;


procedure WebModule1clientesAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoUbicacion: String;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  CodigoUsuario: Integer;
  Filtro: string;
  iPage, iPageSize, iTotalRegs, iNumRegs, iPages: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  Filtro        := (contentfields.Values['Filtro']);

  {$ENDREGION}

  {$REGION 'Recuperar número total de clients'}

  sSQL :=
    'SELECT COUNT(*) ' +
    'FROM Clientes WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Clientes) + ' ';

  if Filtro<>'' then
  begin

    sSQL := sSQL +
      'AND ( ' +
      '  CodigoCliente LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      '  OR RazonSocial LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      '  OR Telefono LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      '  OR CifDni LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      ') ';

  end;

  iTotalRegs := SQL_Execute ( Conn, sSQL );

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperar informació del palet'}

  sSQL :=
    'SELECT * ' +
    'FROM Clientes WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Clientes) + ' ';

  if Filtro<>'' then
  begin

    sSQL := sSQL +
      'AND ( ' +
      '  CodigoCliente LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      '  OR RazonSocial LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      '  OR Telefono LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      '  OR CifDni LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      ') ';

  end;

  sSQL := sSQL +
    'ORDER BY ' +
    '  RazonSocial ' +
    'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
    'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.EOF do
  begin

    if iNumRegs>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoCliente":"' + JSON_Str(Q.FieldByName('CodigoCliente').AsString) + '",' +
      '"RazonSocial":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"Domicilio":"' + JSON_Str(Q.FieldByName('Domicilio').AsString) + '",' +
      '"CodigoPostal":"' + JSON_Str(Q.FieldByName('CodigoPostal').AsString) + '",' +
      '"Municipio":"' + JSON_Str(Q.FieldByName('Municipio').AsString) + '",' +
      '"Provincia":"' + JSON_Str(Q.FieldByName('Provincia').AsString) + '",' +
      '"Nacion":"' + JSON_Str(Q.FieldByName('Nacion').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Q.Close;
  FreeAndNil(Q);

  Result := Result +
    ']}';

  {$ENDREGION}

end;


procedure WebModule1cadenasAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoUbicacion: String;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  CodigoUsuario: Integer;
  Filtro: string;
  iPage, iPageSize, iTotalRegs, iNumRegs, iPages: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  Filtro        := (contentfields.Values['Filtro']);

  {$ENDREGION}

  {$REGION 'Recuperar número total de clients'}

  sSQL :=
    'SELECT COUNT(*) ' +
    'FROM Cadenas_ WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Clientes) + ' ';

  if Filtro<>'' then
  begin

    sSQL := sSQL +
      'AND ( ' +
      '  CodigoCadena_ LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      '  Cadena_ LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      '  OR RazonSocial LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      '  OR Telefono LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      '  OR CifDni LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      ') ';

  end;

  iTotalRegs := SQL_Execute ( Conn, sSQL );

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperar informació del palet'}

  sSQL :=
    'SELECT * ' +
    'FROM Cadenas_ WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Clientes) + ' ';

  if Filtro<>'' then
  begin

    sSQL := sSQL +
      'AND ( ' +
      '  CodigoCadena_ LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      '  Cadena_ LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      '  OR RazonSocial LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      '  OR Telefono LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      '  OR CifDni LIKE ''%' + JSON_Str(Filtro) + '%'' ' +
      ') ';

  end;

  sSQL := sSQL +
    'ORDER BY ' +
    '  RazonSocial ' +
    'OFFSET ' + IntToStr(iPage*iPageSize) + ' ROWS ' +
    'FETCH NEXT ' + IntToStr(iPageSize) + ' ROWS ONLY';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;

  while not Q.EOF do
  begin

    if iNumRegs>0 then
      Result := Result + ',';

    Inc(iNumRegs);

    Result := Result +
      '{' +
      '"CodigoCadena":"' + JSON_Str(Q.FieldByName('CodigoCadena_').AsString) + '",' +
      '"RazonSocialCadena":"' + JSON_Str(Q.FieldByName('RazonSocial').AsString) + '",' +
      '"DomicilioCadena":"' + JSON_Str(Q.FieldByName('Domicilio').AsString) + '",' +
      '"CodigoPostalCadena":"' + JSON_Str(Q.FieldByName('CodigoPostal').AsString) + '",' +
      '"MunicipioCadena":"' + JSON_Str(Q.FieldByName('Municipio').AsString) + '",' +
      '"ProvinciaCadena":"' + JSON_Str(Q.FieldByName('Provincia').AsString) + '",' +
      '"NacionCadena":"' + JSON_Str(Q.FieldByName('Nacion').AsString) + '"' +
      '}';

    Q.Next;

  end;

  Q.Close;
  FreeAndNil(Q);

  Result := Result +
    ']}';

  {$ENDREGION}

end;


procedure WebModule1recuperarInfoPaletAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoUbicacion: String;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  CodigoUsuario: Integer;
  Matricula: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario   := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  Matricula       := contentfields.values['Matricula'];

  {$ENDREGION}

  {$REGION 'Recuperar informació del palet'}

  sSQL :=
    'SELECT FSP.*, FSPD.*, FSPMB.DescripcionMotivo ' +
    'FROM FS_SGA_Palet FSP WITH (NOLOCK) ' +
    'LEFT JOIN FS_SGA_PackagingDetalle FSPD WITH (NOLOCK) ' +
    'ON ' +
    '  FSP.PackagingId = FSPD.Dt_Id ' +
    '  AND FSPD.CodigoEmpresa = 0 ' +
    'LEFT JOIN FS_SGA_Palet_MotivosBloqueo FSPMB WITH (NOLOCK) ' +
    'ON ' +
    '  FSPMB.CodigoMotivo = FSP.CodigoMotivoBloqueo ' +
    'WHERE ' +
    '  FSP.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '  AND FSP.Matricula = ''' + SQL_Str(Matricula) + '''';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  Result := '{"Result":"OK","Error":"","Data":[';
  if not Q.EOF then
  begin

    Result := Result +
      '{' +
      '"Matricula":"' + JSON_Str(Q.FieldByName('Matricula').AsString) + '",' +
      '"FechaCreacion":"' + FormatDateTime('dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaCreacion').AsDateTime) + '",' +
      '"CodigoMotivoBloqueo":' + IntToStr(Q.FieldByName('CodigoMotivoBloqueo').AsInteger) + ',' +
      '"DescripcionMotivoBloqueo":"' + JSON_Str(Q.FieldByName('DescripcionMotivo').AsString) + '",' +
      '"TipoReserva":' + IntToStr(Q.FieldByName('TipoReserva').AsInteger) + ',' +
      '"PesoNetoTotal":' + SQL_FloatToStr(Q.FieldByName('PesoNetoTotal').AsFloat) + ',' +
      '"PesoBrutoTotal":' + SQL_FloatToStr(Q.FieldByName('PesoBrutoTotal').AsFloat) + ',' +
      '"VolumenTotal":' + SQL_FloatToStr(Q.FieldByName('VolumenTotal').AsFloat) + ',' +
      '"PackagingId":' + IntToStr(Q.FieldByName('PackagingId').AsInteger) + ',' +
      '"Estado":"' + IntToStr(Q.FieldByName('Estado').AsInteger) + '",' +
      '"Info":{' +
        '"Dt_Id":' + IntToStr(Q.FieldByName('Dt_Id').AsInteger) + ',' +
        '"Dt_Nombre":"' + JSON_Str(Q.FieldByName('Dt_Nombre').AsString) + '",' +
        '"Dt_Descripcion":"' + JSON_Str(Q.FieldByName('Dt_Descripcion').AsString) + '",' +
        '"Dt_Peso":' + SQL_FloatToStr(Q.FieldByName('Dt_Peso').AsFloat) + ',' +
        '"Dt_Volumen":' + SQL_FloatToStr(Q.FieldByName('Dt_Volumen').AsFloat) + ',' +
        '"Dt_Carga":' + SQL_FloatToStr(Q.FieldByName('Dt_Carga').AsFloat) + ',' +
        '"Dt_Longitud":' + SQL_FloatToStr(Q.FieldByName('Dt_Longitud').AsFloat) + ',' +
        '"Dt_Anchura":' + SQL_FloatToStr(Q.FieldByName('Dt_Anchura').AsFloat) + ',' +
        '"Dt_Altura":' + SQL_FloatToStr(Q.FieldByName('Dt_Altura').AsFloat) + ',' +
        '"Dt_Material":"' + JSON_Str(Q.FieldByName('Dt_Material').AsString) + '",' +
        '"Dt_ISO":"' + JSON_Str(Q.FieldByName('Dt_ISO').AsString) + '",' +
        '"Dt_Tipo":"' + JSON_Str(Q.FieldByName('Dt_Tipo').AsString) + '",' +
        '"Dt_CodigoSAGE":"' + JSON_Str(Q.FieldByName('Dt_CodigoSAGE').AsString) + '",' +
        '"Dt_CodigoSAGE_EDI":"' + JSON_Str(Q.FieldByName('Dt_CodigoSAGE_EDI').AsString) + '",' +
        '"Dt_CodigoArticulo":"' + JSON_Str(Q.FieldByName('Dt_CodigoArticulo').AsString) + '",' +
        '"Dt_Anchura":' + SQL_FloatToStr(Q.FieldByName('Dt_Anchura').AsFloat) + ',' +
        '"Dt_DigitoMatricula":' + IntToStr(Q.FieldByName('Dt_DigitoMatricula').AsInteger) +
      '}' +
      '}';

  end;

  Q.Close;
  FreeAndNil(Q);

  Result := Result +
    ']}';

  {$ENDREGION}

end;


procedure WebModule1recuperarMotivosBloqueoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  CodigoUsuario: Integer;
  iNumRecords: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario   := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  {$ENDREGION}

  {$REGION 'Recuperar motius de bloqueig de palet'}

  sSQL :=
    'SELECT * ' +
    'FROM FS_SGA_Palet_MotivosBloqueo WITH (NOLOCK) ' +
    'ORDER BY ' +
    '  CodigoMotivo';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  iNumRecords := 0;

  Result := '{"Result":"OK","Error":"","Data":[';
  while not Q.EOF do
  begin

    if iNumRecords>0 then
      Result := Result + ',';

    Result := Result +
      '{' +
      '"CodigoMotivo":"' + JSON_Str(Q.FieldByName('CodigoMotivo').AsString) + '",' +
      '"DescripcionMotivo":"' + JSON_Str(Q.FieldByName('DescripcionMotivo').AsString) + '"' +
      '}';

    Inc(iNumRecords);

    Q.Next;

  end;

  Q.Close;
  FreeAndNil(Q);

  Result := Result +
    ']}';

  {$ENDREGION}

end;


procedure WebModule1cambiarTipoReservaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  CodigoUsuario: Integer;
  CodigoUbicacion: String;
  Matricula: String;
  Estado: Integer;
  TipoReserva: Integer;
  UUID: string;
  sEstado: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario   := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID            := contentfields.values['UUID'];
  CodigoUbicacion := contentfields.values['CodigoUbicacion'];
  Matricula       := contentfields.values['Matricula'];
  TipoReserva     := StrToIntDef(contentfields.Values['TipoReserva'], 0 );

  {$ENDREGION}

  {$REGION 'Actualitzem l´estat del palet'}

  sSQL :=
    'UPDATE FS_SGA_Palet ' +
    'SET TipoReserva = ' + IntToStr(TipoReserva) + ' ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '  AND Matricula = ''' + SQL_Str(Matricula) + '''';

  SQL_Execute_NoRes ( Conn, sSQL );

  LP := LOG_Clear();
  LP.Matricula := Matricula;

  case TipoReserva of
    0: sEstado := 'SIN RESERVAR';
    1: sEstado := 'CLIENTE';
    2: sEstado := 'CADENA COMERCIAL';
    3: sEstado := 'PEDIDO';
    4: sEstado := 'LÍNEA DE PEDIDO';
    5: sEstado := 'PREPARACIÓN';
    6: sEstado := 'FABRICACIÓN';
  end;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-PALLET-RESERV-TYPE', 'Cambiar tipo de reserva a ' + sEstado, @LP );
  
  Result := '{"Result":"OK","Error":"","Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1cambiarMotivoBloqueoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  CodigoUsuario: Integer;
  CodigoUbicacion: String;
  Matricula: String;
  Estado: Integer;
  CodigoMotivo: Integer;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario   := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID            := contentfields.values['UUID'];
  CodigoUbicacion := contentfields.values['CodigoUbicacion'];
  Matricula       := contentfields.values['Matricula'];
  CodigoMotivo    := StrToIntDef(contentfields.Values['CodigoMotivo'], 0 );

  {$ENDREGION}

  {$REGION 'Actualitzem l´estat del palet'}

  sSQL :=
    'UPDATE FS_SGA_Palet ' +
    'SET CodigoMotivoBloqueo = ' + IntToStr(CodigoMotivo) + ' ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '  AND Matricula = ''' + SQL_Str(Matricula) + '''';

  SQL_Execute_NoRes ( Conn, sSQL );

  LP := LOG_Clear();
  LP.Matricula := Matricula;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-PALLET-LOCK-REASON', 'Actualizar motivo de bloqueo a ' + IntToStr(CodigoMotivo), @LP );

  Result := '{"Result":"OK","Error":"","Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1updateEstadoPaletAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoUbicacion: String;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  CodigoUsuario: Integer;
  Matricula: String;
  Estado: Integer;
  UUID: string;
  sEstado: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );   
  UUID          := contentfields.values['UUID'];
  Matricula     := contentfields.values['Matricula'];
  Estado        := StrToIntDef(contentfields.Values['Estado'], 0 );

  {$ENDREGION}

  {$REGION 'Verificacions prèvies'}

  if Estado=4 then
  begin
    if FS_SGA_PaletContieneArticulos ( Conn, CodigoEmpresa, Matricula ) then
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El palet no está vacío y no puede darse de baja","Data":[]}';
    Exit;
    end;

  end;


  {$ENDREGION}

  {$REGION 'Actualitzem l´estat del palet'}

  sSQL :=
    'UPDATE FS_SGA_Palet ' +
    'SET Estado = ' + IntToStr(Estado) + ' ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '  AND Matricula = ''' + SQL_Str(Matricula) + '''';

  SQL_Execute_NoRes ( Conn, sSQL );

  LP := LOG_Clear();
  LP.Matricula := Matricula;

  case Estado of
    0: sEstado := 'INACTIVO';
    1: sEstado := 'ACTIVO';
    2: sEstado := 'BLOQUEADO';
    3: sEstado := 'RESERVADO';
    4: sEstado := 'DADO DE BAJA';
  end;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-PALLET-STATUS', 'Cambiar estado de palet a ' + sEstado, @LP );
  
  Result := '{"Result":"OK","Error":"","Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1moverPaletAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  UbicacionOrigen: String;
  Matricula: String;
  UbicacionDestino: String;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  gaMov: TSGAMovimientoStock;
  YY: Integer;
  CodigoUsuario: Integer;
  dtFechaHora: TDateTime;
  CodigoAlmacen: string;
  CodigoPasillo: string;
  CodigoEstanteria: string;
  Altura: string;
  Fondo: string;
  CodigoAlternativo: string;
  CodigoAlmacen2: string;
  CodigoPasillo2: string;
  CodigoEstanteria2: string;
  Altura2: string;
  Fondo2: string;
  CodigoAlternativo2: string;
  sMovOrigen: String;
  bErr: Boolean;
  sMsg: string;
  MatriculaDestino: string;
  UUID: string;
  i, j: Integer;
  idPackaging: Integer;
  MaxPackagings: Integer;
  iNumPackagings: Integer;
  RestriccionesUbicacion: TUbicacionRestricciones;
  OcupacionActual: TUbicacionOcupacionActual;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID := contentfields.Values['UUID'];
  UbicacionOrigen := contentfields.values['UbicacionOrigen'];

  Matricula        := contentfields.values['Matricula'];
  MatriculaDestino := Matricula;
  if Matricula='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de matrícula no especificado","Data":[]}';
    Exit;
  end;

  UbicacionDestino := contentfields.values['UbicacionDestino'];
  UbicacionDestino := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, UbicacionDestino );

  sSQL :=
    'SELECT  PackagingId ' +
    'FROM FS_SGA_Palet WITH (NOLOCK) ' +
    'WHERE ' +
    '  Matricula = ''' + SQL_Str(Matricula) + '''';
  idPackaging := SQL_Execute ( Conn, sSQL );

  {$ENDREGION}

  {$REGION 'Validem el moviment'}

  RestriccionesUbicacion := FS_SGA_UBICACION_Restricciones ( Conn, CodigoEmpresa, UbicacionDestino );
  OcupacionActual        := FS_SGA_UBICACION_OcupacionActual ( Conn, CodigoEmpresa, UbicacionDestino );

  i := 0;
  while (i<Length(RestriccionesUbicacion.Packagings)) do
  begin

    if RestriccionesUbicacion.Packagings[i] = idPackaging then
    begin

      MaxPackagings := RestriccionesUbicacion.PackagingsMax[i];

      if MaxPackagings>0 then
      begin

        j := 0;
        iNumPackagings := 0;

        while j<Length(OcupacionActual.Packagings) do
        begin

          if OcupacionActual.Packagings[j] = idPackaging then
          begin

            iNumPackagings := OcupacionActual.NumPackagings[j];
            if (iNumPackagings + 1 > MaxPackagings) then
            begin
              Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Una restricción impide ubicar más de ' + IntToStr(MaxPackagings) + ' palets en esta ubicación","Data":[]}';
              Exit;
            end;

          end;

          j := j + 1;

        end;

      end;

    end;

    i := i + 1;

  end;

  {$ENDREGION}

  {$REGION 'Fem el moviment'}

  sSQL :=
    'UPDATE FS_SGA_Palet ' +
    'SET CodigoUbicacionActual = ''' + SQL_Str(UbicacionDestino) + ''' ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '  AND Matricula = ''' + SQL_Str(Matricula) + '''';
  SQL_Execute_NoRes ( Conn, sSQL );

  if UbicacionDestino='' then
  begin
    UbicacionDestino := UbicacionOrigen;
    MatriculaDestino := '';
  end;

  // Movem els stocks que pugui tenir a la nova ubicació
  if UbicacionOrigen<>'' then
  begin

    YY := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Date() );

    sSQL :=
      'SELECT * ' +
      'FROM FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', ' + IntToStr(YY) + ' ) ' +
      'WHERE ' +
      '  CodigoUbicacion = ''' + SQL_Str(UbicacionOrigen) + ''' ' +
      '  AND Matricula = ''' + SQL_Str(Matricula) + '''';
    Q := SQL_PrepareQuery ( Conn, sSQL );
    Q.Open;

    dtFechaHora := Now();
    sMovOrigen := SQL_Execute ( Conn, 'SELECT NEWID()' );

    if Q.EOF then
      sMovOrigen := '';

    while not Q.EOF do
    begin

      FS_SGA_UBICACION_Desglosar ( Conn, CodigoEmpresa, UbicacionOrigen, CodigoAlmacen, CodigoPasillo, CodigoEstanteria, Altura, Fondo, CodigoAlternativo );
      FS_SGA_UBICACION_Desglosar ( Conn, CodigoEmpresa, UbicacionDestino, CodigoAlmacen2, CodigoPasillo2, CodigoEstanteria2, Altura2, Fondo2, CodigoAlternativo2 );

      SGA_FS_ALMACEN_PrepareMov ( gaMov );

      gaMov.TipoMovimiento         := 2; // SORTIDA
      gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
      gaMov.EmpresaOrigen          := CodigoEmpresa.EmpresaOrigen;
      gaMov.CodigoUsuario          := CodigoUsuario;
      gaMov.Ejercicio              := YY;
      gaMov.Periodo                := MonthOf(Date());
      gaMov.Fecha                  := Date();
      gaMov.FechaHora              := dtFechaHora;
      gaMov.CodigoAlmacen          := CodigoAlmacen;
      gaMov.CodigoUbicacion        := UbicacionOrigen;
      gaMov.CodigoArticulo         := Q.FieldByName('CodigoArticulo').AsString;
      gaMov.Partida                := Q.FieldByName('Partida').AsString;
      gaMov.OrigenMovimiento       := 'T';
      gaMov.Unidades               := Q.FieldByName('UnidadesSaldo').AsFloat;
      gaMov.UnidadMedida           := AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString);
      gaMov.UnidadesBase           := Q.FieldByName('UnidadesSaldoBase').AsFloat;
      gaMov.UnidadMedidaBase       := AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString);
      gaMov.FactorConversion       := Q.FieldByName('FactorConversion_').AsFloat;
      gaMov.Comentario             := 'Cambio ubicación palet';
      gaMov.FechaCaduca            := Q.FieldByName('FechaCaduca').AsDateTime;
      gaMov.Precio                 := Q.FieldByName('PrecioMedio').AsFloat;
      gaMov.Importe                := Q.FieldByName('UnidadesSaldoBase').AsFloat * Q.FieldByName('PrecioMedio').AsFloat;
      gaMov.MovOrigen              := sMovOrigen;
      gaMov.CodigoColor            := Q.FieldByName('CodigoColor_').AsString;
      gaMov.CodigoTalla            := Q.FieldByName('CodigoTalla01_').AsString;
      gaMov.GrupoTalla             := Q.FieldByName('GrupoTalla_').AsInteger;
      gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );
      gaMov.MovTraspaso            := SQL_Execute ( Conn, 'SELECT NEWID()' );
      gaMov.EjercicioDocumento     := YY;
      gaMov.Matricula              := Matricula;
      gaMov.TipoMovimientoSGA      := [tmsgaMovimientoStock];
      gaMov.TipoMovimientoSAGE     := [];

      if CodigoAlmacen<>CodigoAlmacen2 then
      begin
        gaMov.Partida2               := gaMov.Partida;
        gaMov.CodigoAlmacenDestino   := CodigoAlmacen2;
        gaMov.CodigoUbicacionDestino := UbicacionDestino;
        gaMov.TipoMovimientoSAGE     := [tmsageMovimientoStock];
      end;

      bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );

      gaMov.TipoMovimiento         := 1; // ENTRADA
      gaMov.CodigoAlmacen          := CodigoAlmacen2;
      gaMov.CodigoUbicacion        := UbicacionDestino;
      gaMov.Matricula              := MatriculaDestino;
      gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );

      if CodigoAlmacen<>CodigoAlmacen2 then
      begin
        gaMov.CodigoAlmacenDestino   := CodigoAlmacen;
        gaMov.CodigoUbicacionDestino := UbicacionOrigen;
        gaMov.TipoMovimientoSAGE     := [];
      end;

      bErr := SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );

      Q.Next;

    end;

    Q.Close;
    FreeAndNil(Q);

  end;

  LP := LOG_Clear();
  LP.MovOrigen := sMovOrigen;
  LP.Matricula := Matricula;

  if sMovOrigen<>'' then
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'MOVE-PALLET', 'Mover palet de ' + UbicacionOrigen + ' a ' + UbicacionDestino, @LP )
  else
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'MOVE-PALLET', 'Mover palet de ' + UbicacionOrigen + ' a ' + UbicacionDestino, nil );

  Result := '{"Result":"OK","Error":"","Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1getMatriculaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  Matricula: String;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  CodigoUbicacion: String;
  CodigoAlmacen: string;
  CodigoPasillo: string;
  CodigoEstanteria: string;
  Altura: string;
  Fondo: string;
  CodigoAlternativo: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  Matricula := contentfields.values['Matricula'];
  if Matricula='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de matrícula no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  // Recuperem les unitats de mesura

  sSQL :=
    'SELECT ' +
    '  * ' +
    'FROM FS_SGA_Palet WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '  AND Matricula = ''' + SQL_Str(Matricula) + '''';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Q.EOF then
  begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de matrícula incorrecto","Data":[]}';
    Exit;
  end;

  CodigoUbicacion := Q.FieldByName('CodigoUbicacionActual').AsString;

  FS_SGA_UBICACION_Desglosar ( Conn, CodigoEmpresa, CodigoUbicacion, CodigoAlmacen, CodigoPasillo, CodigoEstanteria, Altura, Fondo, CodigoAlternativo );

  Result := '{"Result":"OK","Error":"","Data":[';


  if not Q.Eof then begin

    Result := Result +
      '{' +
      '"Tipo":40,' +
      '"Matricula":"' + JSON_Str(Matricula) + '",' +
      '"Ubicacion":{' +
        '"CodigoAlmacen":"' + JSON_Str(CodigoAlmacen) + '",' +
        '"CodigoUbicacion":"' + JSON_Str(CodigoUbicacion) + '",' +
        '"CodigoAlternativo":"' + JSON_Str(CodigoAlternativo) + '",' +
        '"CodigoPasillo":"' + JSON_Str(CodigoPasillo) + '",' +
        '"CodigoEstanteria":"' + JSON_Str(CodigoEstanteria) + '",' +
        '"Altura":"' + JSON_Str(Altura) + '",' +
        '"Fondo":"' + JSON_Str(Fondo) + '"' +
      '},' +
      '"CodigoUbicacion":"' + JSON_Str(CodigoUbicacion) + '",' +
      '"CodigoUbicacionAlternativo":"' + JSON_Str(CodigoAlternativo) + '",' +
      '"CodigoAlmacen":"' + JSON_Str(CodigoAlmacen) + '",' +
      '"CodigoPasillo":"' + JSON_Str(CodigoPasillo) + '",' +
      '"CodigoEstanteria":"' + JSON_Str(CodigoEstanteria) + '",' +
      '"Altura":"' + JSON_Str(Altura) + '",' +
      '"Fondo":"' + JSON_Str(Fondo) + '",' +
      '"Estado":' + IntToStr(Q.FieldByName('Estado').AsInteger) + ',' +
      '"FechaCreacion":"' + FormatDateTime('dd/mm/yyyy hh:nn:ss', Q.FieldByName('FechaCreacion').AsDateTime) + '",' +
      '"PesoNetoTotal":' + SQL_FloatToStr(Q.FieldByName('PesoNetoTotal').AsFloat) + ',' +
      '"PesoBrutoTotal":' + SQL_FloatToStr(Q.FieldByName('PesoBrutoTotal').AsFloat) + ',' +
      '"VolumenTotal":' + SQL_FloatToStr(Q.FieldByName('VolumenTotal').AsFloat) + ',' +
      '"PackagingId":' + IntToStr(Q.FieldByName('PackagingId').AsInteger) +
      '}';

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


procedure WebModule1getArticuloTallaColor ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoArticulo: String;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  JSonUnidadesMedida: String;
  contentfields: TStringList;
  CodigoAlternativo: String;
  CodigoAgrupacion: Integer;
  UnidadesAgrupacion: Double;
  UnidadMedidaAgrup: String;
  CodigoTalla: String;
  CodigoColor: String;
  sExtraField01: String;
  sFUNCCustom: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoAlternativo := contentfields.values['CodigoArticulo'];

  if CodigoAlternativo='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de agrupación no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  // Recuperem les unitats de mesura

  sSQL :=
    'SELECT ' +
    '  * ' +
    'FROM CodigosTallaColor WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.CodigosTallaColor) + ' ' +
    '  AND CodigoAlternativo = ''' + SQL_Str(CodigoAlternativo) + '''';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Q.EOF then
  begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de talla/color incorrecto","Data":[]}';
    Exit;
  end;

  CodigoArticulo     := Q.FieldByName('CodigoArticulo').AsString;
  CodigoTalla        := Q.FieldByName('CodigoTalla01_').AsString;
  CodigoColor        := Q.FieldByName('CodigoColor_').AsString;

  sExtraField01 := '';
  if SQL_Function_Exists ( Conn, 'FS_SGA_Articulo_ExtraInfo', sFUNCCustom ) then
  begin

    sSQL := 'SELECT dbo.[' + sFUNCCustom + '] ( ' +
      IntToStr(CodigoEmpresa.Articulos) + ', ' +
      '''' + SQL_Str(CodigoArticulo) + ''' )';
    sExtraField01 := SQL_Execute ( Conn, sSQL );

  end;

  JSonUnidadesMedida := SGA_FS_ARTICULO_Obtener_UnidadesMedida ( Conn, CodigoEmpresa, CodigoArticulo );

  Q.Close;
  FreeAndNil(Q);

  sSQL := 'SELECT ' +
          '  art.* ' +
          'FROM dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
          'WHERE ' +
          '  art.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + '''';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Q.EOF then
  begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo incorrecto","Data":[]}';
    Exit;
  end;

  Result := '{"Result":"OK","Error":"","Data":[';

  if not Q.Eof then begin

    (*
    Result := Result +
      '{' +
      '"Tipo":1,' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
      '"CodigoArticuloAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"TratamientoPartidas":' + IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('Colores_').AsInteger<>0) + ',' +
      '"GrupoTalla":' + Q.FieldByName('GrupoTalla_').AsString + ',' +
      '"Partida":"",' +
      '"CodigoTalla":"' + JSON_Str(CodigoTalla) + '",' +
      '"CodigoColor":"' + JSON_Str(CodigoColor) + '",' +
      JSonUnidadesMedida +
      '}';
    *)

    Result := Result +
      '{' +
      '"Tipo":1,' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
      '"CodigoArticuloAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"CodigoAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"CodigoAlternativo2":"' + JSON_Str(Q.FieldByName('CodigoAlternativo2').AsString) + '",' +
      '"CodigoAlternativoTC":"' + JSON_Str(CodigoAlternativo) + '",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"Descripcion2Articulo":"' + JSON_Str(Q.FieldByName('Descripcion2Articulo').AsString) + '",' +
      '"TratamientoPartidas":' + IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"TratamientoColores":' + SQL_BooleanToStr(Q.FieldByName('Colores_').AsInteger<>0) + ',' +
      '"GrupoTalla":' + Q.FieldByName('GrupoTalla_').AsString + ',' +
      '"CodigoTalla":"' + JSON_Str(CodigoTalla) + '",' +
      '"CodigoColor":"' + JSON_Str(CodigoColor) + '",' +
      '"CodigoAgrupacion":0,' +
      '"UnidadesAgrupacion":1,' +
      '"Partida":"",' +
      '"FechaCaduca":"",' +
      '"UnidadMedida":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedidaAlternativa_').AsString) )+ '",' +
      '"UnidadMedidaBase":"' + JSON_Str(AnsiUpperCase(Q.FieldByName('UnidadMedida2_').AsString)) + '",' +
      '"FactorConversion":' + SQL_FloatToStr(Q.FieldByName('FactorConversion_').AsFloat) + ',' +
      '"ExtraField01":"' + JSON_Str(sExtraField01) + '",' +
      '"Cantidad":0,' +
      '"CantidadBase":0,' +
      JSonUnidadesMedida +
      '}';

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}


end;


procedure WebModule1getArticuloagrupadoAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  CodigoArticulo: String;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  JSonUnidadesMedida: String;
  contentfields: TStringList;
  CodigoArticuloAgrupacion: String;
  CodigoAgrupacion: Integer;
  UnidadesAgrupacion: Double;
  UnidadMedidaAgrup: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );
  CodigoArticuloAgrupacion := contentfields.values['CodigoArticulo'];

  if CodigoArticuloAgrupacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de agrupación no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  // Recuperem les unitats de mesura

  sSQL :=
    'SELECT ' +
    '  AGRUP.*, ART.GrupoTalla_ ' +
    'FROM Agrupaciones AGRUP WITH (NOLOCK) ' +
    'INNER JOIN FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) ART ' +
    'ON AGRUP.CodigoEmpresa = ART.CodigoEmpresa ' +
    'AND AGRUP.CodigoArticulo = ART.CodigoArticulo ' +
    'WHERE ' +
    '  AGRUP.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Agrupaciones) + ' ' +
    '  AND AGRUP.CodigoAlternativo = ''' + SQL_Str(CodigoArticuloAgrupacion) + '''';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Q.EOF then
  begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de agrupación incorrecto","Data":[]}';
    Exit;
  end;

  CodigoArticulo     := Q.FieldByName('CodigoArticulo').AsString;
  CodigoAgrupacion   := Q.FieldByName('CodigoAgrupacion').AsInteger;
  UnidadesAgrupacion := Q.FieldByName('UnidadesAgrupacion').AsFloat;
  UnidadMedidaAgrup  := AnsiUpperCase(Q.FieldByName('UnidadMedida1_').AsString);
  JSonUnidadesMedida := SGA_FS_ARTICULO_Obtener_UnidadesMedida ( Conn, CodigoEmpresa, CodigoArticulo );

  Q.Close;
  FreeAndNil(Q);

  sSQL := 'SELECT ' +
          '  art.* ' +
          'FROM dbo.FS_SGA_TABLE_Articulos ( ' + IntToStr(CodigoEmpresa.Articulos) + ' ) art ' +
          'WHERE ' +
          '  art.CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + '''';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      Q.Close;
      FreeAndNil(Q);
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Q.EOF then
  begin
    Q.Close;
    FreeAndNil(Q);
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo incorrecto","Data":[]}';
    Exit;
  end;

  Result := '{"Result":"OK","Error":"","Data":[';

  if not Q.Eof then begin

    Result := Result +
      '{' +
      '"Tipo":1,' +
      '"CodigoArticulo":"' + JSON_Str(Q.FieldByName('CodigoArticulo').AsString) + '",' +
      '"CodigoArticuloAlternativo":"' + JSON_Str(Q.FieldByName('CodigoAlternativo').AsString) + '",' +
      '"GrupoTalla":' + IntToStr(Q.FieldByName('GrupoTalla_').AsInteger) + ', ' +
      '"CodigoTalla":"",' +
      '"CodigoColor":"",' +
      '"Partida":"",' +
      '"DescripcionArticulo":"' + JSON_Str(Q.FieldByName('DescripcionArticulo').AsString) + '",' +
      '"TratamientoPartidas":' + IntToStr(Q.FieldByName('TratamientoPartidas').AsInteger) + ',' +
      '"TratamientoSeries":' + SQL_BooleanToStr(Q.FieldByName('TrataNumerosSerieLc').AsInteger<>0) + ',' +
      '"CodigoAgrupacion":' + IntToStr(CodigoAgrupacion) + ',' +
      '"UnidadesAgrupacion":' + SQL_FloatToStr(UnidadesAgrupacion) + ',' +
      '"UnidadMedidaAgrupacion":"' + JSON_Str(AnsiUpperCase(UnidadMedidaAgrup)) + '",' +
      JSonUnidadesMedida +
      '}';

    Q.Next;

  end;

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}


end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ ESBORRA TOT EL DETALL D'UNA LÍNEA EXPEDIDA                            │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1deleteExpedicionDetalleAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  IdPreparacion: Integer;
  PickingId: Integer;
  IdentificadorExpedicion: Integer;
  sSQL: String;
  Q: TADOQuery;
  bErr: Boolean;
  sMsg: String;
  contentfields: TStringList;
  CodigoUsuario: Integer;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID          := contentfields.values['UUID'];

  IdPreparacion := StrToIntDef(contentfields.Values['IdPreparacion'], 0);
  if IdPreparacion=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  PickingId := StrToIntDef(contentfields.Values['PickingId'], 0);
  if PickingId=0 then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de línea no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  IdentificadorExpedicion := StrToIntDef(contentfields.Values['IdentificadorExpedicion'], 1);

  {$ENDREGION}

  {$REGION 'Guardar les dades'}

  bErr := FALSE;
  sMsg := '';

  sSQL :=
    'DELETE FROM FS_SGA_PACKINGLIST ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND PickingId = ' + IntToStr(PickingId) + ' ' +
    '  AND IdentificadorExpedicion = ' + IntToStr(IdentificadorExpedicion);

  try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do
    begin
      sMsg := E.Message;
      gaLogFile.Write_DBException(E,sSQL,'Error al borrar el detalle de expedición', CONST_LOGID_BBDD );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(sMsg) + '","Data":[]}';
      Exit;
    end;
  end;

  {$ENDREGION}

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'DELETE-EXP-DET', 'Borrar detalle expedición', @LP );

  Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[]}';

end;


procedure WebModule1clearExpedicionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  IdPreparacion: Integer;
  IdExpedicion: Integer;
  PickingId: Integer;
  sSQL: String;
  Data: String;
  Q: TADOQuery;
  bErr: Boolean;
  sMsg: String;
  contentfields: TStringList;
  sPedidos: String;
  sPROCCustom: String;
  proc: TADOStoredProc;
  PaletId: Integer;
  CajaId: Integer;
  bCajaNeg: Boolean;
  CodigoAlmacen: String;
  Matricula: String;
  CodigoUsuario: Integer;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  IdExpedicion  := StrToIntDef(contentfields.values['IdExpedicion'],0);
  PickingId     := StrToIntDef(contentfields.values['PickingId'],0);
  PaletId       := StrToIntDef(contentfields.values['PaletId'],0);
  Matricula     := contentfields.values['Matricula'];
  CajaId        := StrToIntDef(contentfields.values['CajaId'],0);
  bCajaNeg      := (CajaId<0);
  CodigoAlmacen := contentfields.Values['CodigoAlmacenDefecto'];
  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'],0);
  UUID          := contentfields.values['UUID'];
  
  {$ENDREGION}

  {$REGION 'Retornem a expedició els materials que estiguin en un palet'}

  FS_SGA_DevolverMaterialPaletAExpedicion ( Conn, CodigoEmpresa, CodigoAlmacen, CodigoUsuario, IdPreparacion, PickingId );

  {$ENDREGION}

  {$REGION 'Esborrem les expedicions'}

  sSQL := 'EXEC dbo.FS_SGA_PROC_Purga_PackingList ' +
    IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
    IntToStr(IdPreparacion) + ', ' +
    IntToStr(IdExpedicion) + ', ' +
    IntToStr(PickingId);

  try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(E.Message) + '","Data":[]}';
      gaLogFile.Write ( Result, sIDCall );
      Exit;
    end;
  end;

  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_UpdatePaletCaja', sPROCCustom ) then
  begin

    sSQL :=
      'SELECT ' +
      '  IdentificadorExpedicion, CodigoArticulo, CodigoTalla01_, CodigoColor_, Partida, ' +
      '  CodigoAgrupacion, UnidadesAgrupacion, UnidadMedida, UnidadMedidaBase, FactorConversion ' +
      'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
      'WHERE ' +
      '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND PickingId = ' + IntToStr(PickingId);

    Q := SQL_PrepareQuery ( Conn, sSQL );
    Q.Open;

    if not Q.EOF then
    begin

      proc := TADOStoredProc.Create(nil);
      proc.Connection := Conn;
      proc.ProcedureName := 'dbo.[' + sPROCCustom + ']';
      proc.Parameters.Refresh;

      proc.Parameters.ParamByName('@CodigoEmpresa').Value      := CodigoEmpresa.EmpresaOrigen;
      proc.Parameters.ParamByName('@IdPreparacion').Value      := IdPreparacion;
      proc.Parameters.ParamByName('@IdExpedicion').Value       := Q.FieldByName('IdentificadorExpedicion').AsString;
      proc.Parameters.ParamByName('@PickingId').Value          := PickingId;
      proc.Parameters.ParamByName('@CodigoArticulo').Value     := Q.FieldByName('CodigoArticulo').AsString;
      proc.Parameters.ParamByName('@CodigoTalla01_').Value     := Q.FieldByName('CodigoTalla01_').AsString;
      proc.Parameters.ParamByName('@CodigoColor_').Value       := Q.FieldByName('CodigoColor_').AsString;
      proc.Parameters.ParamByName('@Partida').Value            := Q.FieldByName('Partida').AsString;
      proc.Parameters.ParamByName('@CodigoAgrupacion').Value   := Q.FieldByName('CodigoAgrupacion').AsInteger;
      proc.Parameters.ParamByName('@UnidadesAgrupacion').Value := Q.FieldByName('UnidadesAgrupacion').AsFloat;
      proc.Parameters.ParamByName('@UnidadMedida').Value       := AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString);
      proc.Parameters.ParamByName('@UnidadMedidaBase').Value   := AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString);
      proc.Parameters.ParamByName('@FactorConversion').Value   := Q.FieldByName('FactorConversion').AsFloat;
      proc.Parameters.ParamByName('@PaletId').Value            := PaletId;
      proc.Parameters.ParamByName('@Matricula').Value          := Matricula;
      proc.Parameters.ParamByName('@CajaId').Value             := CajaId;
      proc.Parameters.ParamByName('@NuevoPaletID').Value       := 0;
      proc.Parameters.ParamByName('@NuevaMatricula').Value     := '';
      proc.Parameters.ParamByName('@NuevaCajaID').Value        := 0;

      proc.Prepared := TRUE;
      proc.ExecProc;

      PaletId   := proc.Parameters.ParamValues['@NuevoPaletID'];
      Matricula := proc.Parameters.ParamValues['@NuevaMatricula'];
      CajaId    := proc.Parameters.ParamValues['@NuevaCajaID'];

      FreeAndNil(proc);

      if (not bCajaNeg) and (CajaId<=0) then
      begin
        CajaId := 1;
      end;

    end;

    Q.Close;
    FreeAndNil(Q);

  end;

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;
 
  if PickingId=0 then
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'CLEAR-EXP', 'Limpiar expedición', @LP )
  else
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'CLEAR-EXP', 'Limpiar línea ' + IntToStr(PickingId) + ' de la expedición', @LP );

  Result := '{"Result":"OK","Error":"","Data":[';

  Result := Result +
    '{' +
    '"PaletId":' + IntToStr(PaletId) + ',' +
    '"Matricula":"' + JSON_Str(Matricula) + '",' +
    '"CajaId":' + IntToStr(CajaId) +
    '}';

  Result := Result + ']}';

end;


procedure WebModule1checkEmptyTargetAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  YY: WORD;
  CodigoUbicacion: String;
  Matricula: String;
  sSQL: String;
  contentfields: TStringList;
  iNum: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY              := SAGE_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );
  Matricula       := (contentfields.Values['Matricula']);
  CodigoUbicacion := contentfields.values['CodigoUbicacion'];
  CodigoUbicacion := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );

  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de ubicación no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Buscar contingut ubicació'}

  sSQL :=
    'SELECT COUNT(*) ' +
    'FROM FS_SGA_TABLE_AcumuladoStockActual ( ' + IntToStr(CodigoEmpresa.Stocks) + ', ' + IntToStr(YY) + ' )' +
    'WHERE ' +
    '  CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + ''' ' +
    '  AND Matricula = ''' + SQL_Str(Matricula) + ''' ' +
    '  AND (UnidadesSaldo > 0 OR UnidadesSaldoBase > 0 )';
  iNum := SQL_Execute ( Conn, sSQL );

  {$ENDREGION}

  if iNum>0 then
  begin
    Result := '{"Result":"OK","Error":"","Data":[{"Empty":0}]}';
  end else begin
    Result := '{"Result":"OK","Error":"","Data":[{"Empty":1}]}';
  end;

end;


procedure WebModule1traspasarListaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  YY: WORD;
  UUID: String;
  sSQL: String;
  Q: TADOQuery;
  UbicacionOrigen: string;
  UbicacionDestino: string;
  contentfields: TStringList;
  gaMov: TSGAMovimientoStock;
  aUbicacionOrigen: TSGAUbicacion;
  aUbicacionDestino: TSGAUbicacion;
  sMovOrigen: String;
  bErr: Boolean;
  sMsg: String;
  Matricula: String;
  MatriculaDestino: String;
  RestriccionesUbicacion: TUbicacionRestricciones;
  OcupacionActual: TUbicacionOcupacionActual;
  TieneRestriccion: TResultadoRestriccion;
  ArticulosLista: VTArticulosRestriccion;
  i: Integer;
  Comentario: String;
  DatosArticulos: TTotalesDatosArticulos;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  YY := SGA_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  CodigoUsuario    := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID             := contentfields.values['UUID'];
  UbicacionOrigen  := contentfields.Values['UbicacionOrigen'];
  UbicacionDestino := contentfields.Values['UbicacionDestino'];

  Matricula        := contentfields.Values['Matricula'];
  MatriculaDestino := contentfields.Values['MatriculaDestino'];

  UbicacionOrigen := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, UbicacionOrigen );
  if UbicacionOrigen='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de ubicación origen no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  UbicacionDestino := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, UbicacionDestino );
  if UbicacionDestino='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de ubicación destino no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  if Matricula<>'' then
  begin
    if (not FS_SGA_MatriculaEnUbicacion ( Conn, CodigoEmpresa, UbicacionOrigen, Matricula ) ) then
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El palet de origen ya no se encuentra en esta ubicación","Data":[]}';
      Exit;
    end;
  end;

  if MatriculaDestino<>'' then
  begin
    if (not FS_SGA_MatriculaEnUbicacion ( Conn, CodigoEmpresa, UbicacionDestino, MatriculaDestino ) ) then
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El palet de destino ya no se encuentra en esta ubicación","Data":[]}';
      Exit;
    end;
  end;

  aUbicacionOrigen  := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, UbicacionOrigen );
  aUbicacionDestino := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, UbicacionDestino );
  Comentario        := contentfields.values['Comentario'];

  {$ENDREGION}

  {$ENDREGION 'Validación restricciones'}

  sSQL :=
    'SELECT * ' +
    'FROM FS_SGA_TraspasosTemp WITH (NOLOCK) ' +
    'WHERE ' +
    '  UUID = ''' + SQL_Str(UUID) + ''' ' +
    '  AND Selected <> 0';
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  SetLength ( ArticulosLista, Q.RecordCount );

  i := 0;
  while not Q.EOF do
  begin
    ArticulosLista[i].CodigoArticulo := Q.FieldByName('CodigoArticulo').AsString;
    ArticulosLista[i].Partida        := Q.FieldByName('Partida').AsString;
    ArticulosLista[i].Cantidad       := Q.FieldByName('UnidadesSaldoBase').AsFloat;
    i := i + 1;
    Q.Next;
  end;

  DatosArticulos := FS_SGA_UBICACION_GetDatosArticulos ( Conn, CodigoEmpresa, ArticulosLista );
  SetLength ( ArticulosLista, 0 );

  RestriccionesUbicacion := FS_SGA_UBICACION_Restricciones ( Conn, CodigoEmpresa, UbicacionDestino );
  OcupacionActual        := FS_SGA_UBICACION_OcupacionActual ( Conn, CodigoEmpresa, UbicacionDestino );
  TieneRestriccion       := FS_SGA_UBICACION_CheckRestriccionesLista (
                              Conn, CodigoEmpresa, UbicacionDestino, RestriccionesUbicacion,
                              OcupacionActual, DatosArticulos
                            );

  if TieneRestriccion.Error then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Restricción de ubicación: ' + JSON_Str(TieneRestriccion.Mensaje) + '","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Fem els traspassos'}

  (*
  sSQL :=
    'SELECT * ' +
    'FROM FS_SGA_TraspasosTemp WITH (NOLOCK) ' +
    'WHERE ' +
    '  UUID = ''' + SQL_Str(UUID) + ''' ' +
    '  AND Selected <> 0';
  Q := SQL_PrepareQuery ( Conn, sSQL );
  *)

  Q.First;

  sMovOrigen := SQL_Execute ( Conn, 'SELECT NEWID()' );
  bErr := FALSE;
  sMsg := '';

  if Comentario='' then
  begin
    Comentario := 'Traspaso múltiple';
  end;

  while (not bErr) and (not Q.EOF) do
  begin

    SGA_FS_ALMACEN_PrepareMov ( gaMov );
    gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
    gaMov.EmpresaOrigen          := CodigoEmpresa.EmpresaOrigen;
    gaMov.CodigoUsuario          := CodigoUsuario;
    gaMov.Ejercicio              := YY;
    gaMov.Periodo                := MonthOf(Date());
    gaMov.Fecha                  := Date();
    gaMov.FechaHora              := Now();
    gaMov.CodigoAlmacen          := aUbicacionOrigen.CodigoAlmacen;
    gaMov.CodigoUbicacion        := aUbicacionOrigen.CodigoUbicacion;
    gaMov.CodigoArticulo         := Q.FieldByName('CodigoArticulo').AsString;
    gaMov.Partida                := Q.FieldByName('Partida').AsString;
    gaMov.Partida2               := '';
    gaMov.CodigoTalla            := Q.FieldByName('CodigoTalla01_').AsString;
    gaMov.CodigoColor            := Q.FieldByName('CodigoColor_').AsString;
    gaMov.TipoMovimiento         := 2;
    gaMov.OrigenMovimiento       := 'T';
    gaMov.Unidades               := Q.FieldByName('UnidadesSaldo').AsFloat;
    gaMov.UnidadMedida           := AnsiUpperCase(Q.FieldByName('UnidadMedida').AsString);
    gaMov.UnidadesBase           := Q.FieldByName('UnidadesSaldoBase').AsFloat;
    gaMov.UnidadMedidaBase       := AnsiUpperCase(Q.FieldByName('UnidadMedidaBase').AsString);
    gaMov.FactorConversion       := Q.FieldByName('FactorConversion_').AsFloat;
    gaMov.FechaCaduca            := Q.FieldByName('FechaCaduca').AsDateTime;
    gaMov.IdProcesoIME           := SQL_Execute ( Conn, 'SELECT NEWID()' );
    gaMov.Comentario             := Comentario;
    gaMov.PreparacionId          := 0;
    gaMov.MovOrigen              := sMovOrigen;
    gaMov.Matricula              := Matricula;
    gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );

    gaMov.Precio :=
      ARTICULO_ConsultarPrecioStock (
        Conn,
        CodigoEmpresa,
        gaMov.CodigoArticulo,
        gaMov.Partida,
        gaMov.CodigoColor,
        gaMov.CodigoTalla,
        gaMov.CodigoAlmacen,
        gaMov.GrupoTalla
      );

    if aUbicacionOrigen.CodigoAlmacen<>aUbicacionDestino.CodigoAlmacen then begin
      gaMov.CodigoAlmacenDestino   := aUbicacionDestino.CodigoAlmacen;
      gaMov.CodigoUbicacionDestino := aUbicacionDestino.CodigoUbicacion;
      gaMov.TipoMovimientoSAGE     := [tmsageMovimientoStock];
    end;

    if not bErr then try
      gaLogFile.Write ( 'SGA_FS_ALMACEN_MovimientoStock salida', sIDCall );
      bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message;
      end;
    end;

    if aUbicacionOrigen.CodigoAlmacen<>aUbicacionDestino.CodigoAlmacen then begin
      gaMov.CodigoAlmacenDestino   := aUbicacionOrigen.CodigoAlmacen;
      gaMov.CodigoUbicacionDestino := aUbicacionOrigen.CodigoUbicacion;
      gaMov.TipoMovimientoSAGE     := [];
    end;

    gaMov.FechaHora              := Now();
    gaMov.CodigoAlmacen          := aUbicacionDestino.CodigoAlmacen;
    gaMov.CodigoUbicacion        := aUbicacionDestino.CodigoUbicacion;
    gaMov.TipoMovimiento         := 1;
    gaMov.Matricula              := MatriculaDestino;
    gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );

    gaMov.Precio :=
      ARTICULO_ConsultarPrecioStock (
        Conn,
        CodigoEmpresa,
        gaMov.CodigoArticulo,
        gaMov.Partida,
        gaMov.CodigoColor,
        gaMov.CodigoTalla,
        gaMov.CodigoAlmacen,
        gaMov.GrupoTalla,
        gaMov.CodigoAlmacenDestino
      );

    if not bErr then try
      bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg, sIDCall );
    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message;
      end;
    end;

    Q.Next;

  end;

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

  LP := LOG_Clear();
  LP.MovOrigen := sMovOrigen;
  LP.Matricula := Matricula;
 
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'TRANSFER-LIST', 'Traspasar lista de artículos de ' + aUbicacionOrigen.CodigoUbicacion +
    ' a ' + aUbicacionDestino.CodigoUbicacion, @LP );

  Result := '{"Result":"OK","Error":"","Data":[]}';

end;


procedure WebModule1updateTraspasosSelectedAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  UUID: String;
  sSQL: String;
  CodigoArticulo: String;
  Partida: String;
  UnidadMedida: String;
  CodigoTalla: String;
  CodigoColor: String;
  Selected: boolean;
  contentfields: TStringList;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoArticulo := contentfields.values['CodigoArticulo'];
  UUID           := contentfields.values['UUID'];
  Partida        := contentfields.values['Partida'];
  UnidadMedida   := AnsiUpperCase(contentfields.values['UnidadMedida']);
  CodigoTalla    := contentfields.values['CodigoTalla'];
  CodigoColor    := contentfields.values['CodigoColor'];
  Selected       := (AnsiUpperCase(Trim(contentfields.values['Selected']))='TRUE');

  {$ENDREGION}

  {$REGION 'Actualització de la selecció'}

  if CodigoArticulo = '' then
  begin

    sSQL :=
      'UPDATE FS_SGA_TraspasosTemp ' +
      'SET ' +
      '  Selected = ' + SQL_BooleanToStr(Selected) + ' ' +
      'WHERE ' +
      '  UUID = ''' + SQL_Str(UUID) + ''' ';
    SQL_Execute_NoRes ( Conn, sSQL );

  end else begin

    sSQL :=
      'UPDATE FS_SGA_TraspasosTemp ' +
      'SET ' +
      '  Selected = ' + SQL_BooleanToStr(Selected) + ' ' +
      'WHERE ' +
      '  UUID = ''' + SQL_Str(UUID) + ''' ' +
      '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
      '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
      '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
      '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
      '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ';
    SQL_Execute_NoRes ( Conn, sSQL );

  end;

  Result := '{"Result":"OK","Error":"","Data":[]}';

end;


procedure WebModule1startPreparacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  IdPreparacion: Integer;
  CodigoUsuario: Integer;
  Expedicion   : Integer;
  contentfields: TStringList;
  UUID         : String;
  sSQL         : String;
  iNumCanvis: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef ( contentfields.values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];
  Expedicion    := StrToIntDef ( contentfields.values['Expedicion'], 0 );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Verifiquem si hi ha algun canvi'}

  iNumCanvis := 0;

  if Expedicion=0 then
  begin

    sSQL :=
      'EXEC dbo.FS_SGA_ActualizarPreparacion ' +
        IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
        IntToStr(IdPreparacion);
    SQL_Execute_NoRes ( Conn, sSQL );

    sSQL :=
      'SELECT COUNT(*) ' +
      'FROM FS_SGA_CambiosPreparacion WITH (NOLOCK) ' +
      'WHERE ' +
      '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND Cambio <> ''=''';
    iNumCanvis := SQL_Execute ( Conn, sSQL );

  end;

  {$ENDREGION}

  {$REGION 'GUARDEM EL LOG'}

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;

  if Expedicion<>0 then
  begin
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'PREPARE-EXPED-START', 'Inicio de trabajo en la expedición', @LP )
  end else begin
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'PREPARE-START', 'Inicio de trabajo en la preparación', @LP )
  end;

  Result :=
    '{"Result":"OK","Error":"","Data":[' +
    '{"Cambios":' + IntToStr(iNumCanvis) + '}' +
    ']}';

  {$ENDREGION}

end;


procedure WebModule1stopPreparacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  IdPreparacion: Integer;
  CodigoUsuario: Integer;
  Expedicion   : Integer;
  contentfields: TStringList;
  UUID         : String;
  sSQL         : String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef ( contentfields.values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];
  Expedicion    := StrToIntDef ( contentfields.values['Expedicion'], 0 );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'GUARDEM EL LOG'}

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;

  if Expedicion<>0 then
  begin
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'PREPARE-EXPED-STOP', 'Fin de trabajo en la expedición', @LP );
  end else begin
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'PREPARE-STOP', 'Fin de trabajo en la preparación', @LP );
  end;

  Result := '{"Result":"OK","Error":"","Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1updatePedidosListAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  IdPreparacion: Integer;
  sSQL: String;
  Data: String;
  Q: TADOQuery;
  bErr: Boolean;
  sMsg: String;
  contentfields: TStringList;
  sPedidos: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sPedidos := FS_SGA_GetPedidos ( Conn, IdPreparacion );

  Result := '{"Result":"OK","Error":"","Data":[';

  Result := Result +
    '{' +
      '"Pedidos":[' + sPedidos + ']' +
    '}';

  Result := Result + ']}';

  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ ESBORRA UNA QUANTITAT D'UNITATS PREPARADES                            │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1deletePreparacionDetailTCAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  IdPreparacion: Integer;
  PickingId: Integer;
  sSQL: String;
  Data: String;
  Desglose: String;
  lJSonValue: TJSonValue;
  CodigoUbicacion: String;
  CodigoArticulo: String;
  Partida: String;
  LineasPosicion: String;
  Q: TADOQuery;
  aUbicacion: TSGAUbicacion;
  Stock: Double;
  UnidadesPendientes: Double;
  bErr: Boolean;
  sMsg: String;
  sNewGuid: String;
  sNewMovOrigen: String;
  sOrigenMovimiento: String;
  YY: Integer;
  CodigoUsuario: Integer;
  iNum: Integer;
  Unidades: Double;
  UnidadMedida: String;
  UnidadesBase: Double;
  UnidadMedidaBase: String;
  FactorConversion: Double;
  TratamientoPartidas: Boolean;
  CodigoUbicacionExpedicion: String;
  aUbicacionExpedicion: TSGAUbicacion;
  CodigoAlmacenUbicacion: String;
  PartidaPedido: String;
  sStr: string;
  TipoEntrada, TipoSalida: String;
  DescripcionEntrada, DescripcionSalida: String;
  sOperparams: String;
  bRecalcularRuta: Boolean;
  bResult: Boolean;
  iUnidadesNecesarias: Double;
  iUnidadesRetiradas: Double;
  iIntents: Integer;
  gaMov: TSGAMovimientoStock;
  bAutoExpedicion: Boolean;
  iNumPedidos: Integer;
  bIsBuilding: Boolean;
  contentfields: TStringList;
  CodigoAgrupacion: Integer;
  CodigoAgrupacionPedido: Integer;
  fUnidadesAgrupacion: Double;
  sUnidadMedidaAgrupacion: string;
  fCantPrep: Double;
  bSepararPorLinea: Boolean;
  PaletActual, CajaActual: Integer;
  MatriculaActual: String;
  sFechaCaduca: String;
  dFechaCaduca: TDateTime;
  sModoPackingList: String;
  iTotalPreparado: Double;
  iTotalPreparadoBase: Double;
  fQtatARestar, fQtatDetalle, fQtat: Double;
  fQtatARestarBase, fQtatDetalleBase, fQtatBase: Double;
  bFinal: Boolean;
  iAutoID: Integer;
  fStockBase: Double;
  CodigoTalla: String;
  CodigoColor: String;
  UnidadesAgrupacion: Double;
  CodigoAlmacenDefecto: String;
  CodigoAlmacen: String;
  DefaultUbi: TDefaultUbicaciones;
  sPROCCustom: string;
  Matricula: string;
  UUID: string;
  Ejercicio: Integer;
  sConsiderarReservas: String;
  sSoloReservas: String;
  sIgnorarPartidaSolicitada: String;
  sIgnorarUbicacionSolicitada: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  bRecalcularRuta := FALSE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  sConsiderarReservas         := contentfields.Values['ConsiderarReservas'];
  sSoloReservas               := contentfields.Values['SoloReservas'];
  sIgnorarPartidaSolicitada   := contentfields.Values['IgnorarPartidaSolicitada'];
  sIgnorarUbicacionSolicitada := contentfields.Values['IgnorarUbicacionSolicitada'];

  if sConsiderarReservas='' then sConsiderarReservas := '1';
  if sSoloReservas='' then sSoloReservas := '0';
  if sIgnorarPartidaSolicitada='' then sIgnorarPartidaSolicitada := '0';
  if sIgnorarUbicacionSolicitada='' then sIgnorarUbicacionSolicitada := '0';

  CodigoAlmacenDefecto := (contentfields.Values['CodigoAlmacenDefecto']);
  if CodigoAlmacenDefecto='' then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_ModoPackingList, sModoPackingList, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_DesglosarPreparacionesPorLinea, bSepararPorLinea, CodigoEmpresa.EmpresaOrigen );

  YY := SGA_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.values['UUID'];
  
  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  sSQL := 'SELECT Ejercicio FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  FormatSettings.DecimalSeparator  := '.';
  FormatSettings.ThousandSeparator := ',';

  PaletActual            := StrToIntDef(Trim(contentfields.values['Palet']),1);
  CajaActual             := StrToIntDef(Trim(contentfields.values['Caja']),1);
  MatriculaActual        := contentfields.Values['Matricula'];
  CodigoUbicacion        := (contentfields.Values['CodigoUbicacion']);
  LineasPosicion         := SQL_GUID_ToStr((contentfields.values['LineasPosicion']));

  if not bSepararPorLinea then
    LineasPosicion := GUID0;

  CodigoArticulo         := (contentfields.values['CodigoArticulo']);
  Partida                := (contentfields.values['Partida']);
  PartidaPedido          := (contentfields.values['PartidaPedido']);
  sFechaCaduca           := Trim(contentfields.values['FechaCaducidad']);
  CodigoTalla            := (contentfields.values['CodigoTalla']);
  CodigoColor            := (contentfields.values['CodigoColor']);
  UnidadMedida           := AnsiUpperCase(contentfields.values['UnidadMedida']);
  UnidadMedidaBase       := AnsiUpperCase(contentfields.values['UnidadMedidaBase']);
  FactorConversion       := FS_StrToFloatDef(Trim(contentfields.values['FactorConversion']),1);
  Unidades               := FS_StrToFloatDef(Trim(contentfields.values['Cantidad']),1);
  UnidadesBase           := FS_StrToFloatDef(Trim(contentfields.values['CantidadBase']),1);
  CodigoAgrupacion       := StrToIntDef(Trim(contentfields.values['CodigoAgrupacion']),0);
  CodigoAgrupacionPedido := StrToIntDef(Trim(contentfields.values['CodigoAgrupacionPedido']),0);
  UnidadesAgrupacion     := FS_StrToFloatDef(Trim(contentfields.values['UnidadesAgrupacion']),1);

  FS_SGA_Check_UnidadMedidaBase ( Conn, CodigoEmpresa, CodigoArticulo, UnidadMedida, UnidadMedidaBase );

  FormatSettings.DecimalSeparator  := ',';
  FormatSettings.ThousandSeparator := '.';

  if sFechaCaduca<>'' then
  begin
    dFechaCaduca := StrToDate(sFechaCaduca);
  end else begin
    dFechaCaduca := 0;
  end;

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );

  if CodigoArticulo=''then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  TratamientoPartidas := ARTICULO_TratamientoPartida ( Conn, CodigoEmpresa, CodigoArticulo );

  if (Partida='') and (TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de partida no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  if (Partida<>'') and (not TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no requiere partida","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  FS_SGA_ObtenerAgrupacion ( Conn, CodigoEmpresa, CodigoArticulo, CodigoAgrupacion,
    fUnidadesAgrupacion, sUnidadMedidaAgrupacion );

  // Conversió al codi d'article real
  CodigoUbicacion        := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
  CodigoAlmacenUbicacion := FS_SGA_CodigoAlmacen ( CodigoUbicacion );
  Matricula := (contentfields.Values['Matricula']);

  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de ubicación no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  sSQL :=
      'SELECT AlmacenPreparacion ' +
      'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
      'WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  CodigoAlmacen := CodigoAlmacenDefecto; //SQL_Execute ( Conn, sSQL );

  if (CodigoAlmacen='') or (CodigoAlmacen='0') then
  begin
    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacion, CodigoEmpresa.EmpresaOrigen );
    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacion );
  end;

  FS_SGA_ObtenerUbicacionesAlmacen ( Conn, CodigoEmpresa, CodigoAlmacen, DefaultUbi );
  CodigoUbicacionExpedicion := DefaultUbi.UbicacionExpediciones;

  gaLogFile.write('CodigoUbicacionExpedicion=' + CodigoUbicacionExpedicion);

  //PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacionExpedicion, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_TipoMovimientoEntradaExpedicion, TipoEntrada, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_TipoMovimientoSalidaExpedicion, TipoSalida, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_DescripcionEntradaExpedicion, DescripcionEntrada, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_DescripcionSalidaExpedicion, DescripcionSalida, CodigoEmpresa.EmpresaOrigen );

  aUbicacionExpedicion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacionExpedicion );
  if aUbicacionExpedicion.CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de ubicación de expedición no definido en parámetros","Data":[]}';
    Exit;
  end;

  (* AIXÒ NO HAURIA DE PODER PASSAR MAI
  if Unidades=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Cantidad no especificada","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;
  *)

  aUbicacion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );
  if aUbicacion.CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de ubicación es incorrecto","Data":[]}';
    Exit;
  end;

  if (UnidadMedidaBase='') and (gbTratamientoSimplificado) then
    Unidadmedida := '';

  (*
  UnidadesBase := SGA_FS_ARTICULO_ConversionUnidades ( Conn, CodigoEmpresa.UnidadesMedida, CodigoArticulo,
                    Unidades, UnidadMedidaBase, UnidadMedida, FactorConversion );
  *)

  if UnidadesBase=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Las unidades de medida son incorrectas","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  Stock :=
    SGA_ALMACEN_Stock (
      Conn,
      CodigoEmpresa,
      aUbicacion.
      CodigoAlmacen,
      CodigoUbicacion,
      CodigoArticulo,
      Partida,
      CodigoTalla,
      CodigoColor,
      Matricula,
      UnidadMedida,
      UnidadMedidaBase,
      fStockBase,
      gbTratamientoSimplificado
    );

  if (Unidades>0) and ((Unidades>Stock) or (UnidadesBase>fStockBase)) then begin
    Result := '{"Almacen":"' + JSON_Str(aUbicacion.CodigoAlmacen) + '","Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La cantidad es superior al stock de la ubicación del almacén","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  sSQL := 'SELECT SUM(UdNecesarias) - MAX(UdRetiradas) ' +
          'FROM   FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
          'WHERE PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          'AND CodigoArticulo=''' + SQL_Str(CodigoArticulo) + ''' ' +
          'AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacionPedido) + ' ';
  if LineasPosicion<>'00000000-0000-0000-0000-000000000000' then
  begin
    sSQL := sSQL + 'AND LineasPosicion=''' + SQL_GUID_ToStr(LineasPosicion) + ''' ';
  end;

  UnidadesPendientes := SQL_Execute ( Conn, sSQL );

  gaLogFile.Write ( 'Unidades pendientes = ' + FloatToStr(UnidadesPendientes) + ', Unidades = ' + FloatToStr(Unidades) + ', Stock = ' + FloatToStr(Stock), sIDCall  );
  if Unidades=Stock then begin
    // Mirar si en quedaran de pendents
    if (UnidadesPendientes-Unidades)>0 then begin
      PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_RecalcularRutaAlVaciarUbicacion, bRecalcularRuta, CodigoEmpresa.EmpresaOrigen );
      if bRecalcularRuta then
      begin
        gaLogFile.Write ( 'Recalcular ruta = true' , sIDCall );
      end;
    end;
  end;

  // Si estem fent una sortida negativa, mirem si la quantitat que treiem
  // d'una partida concreta no queda negatiu
  if Unidades<0 then
  begin

    sSQL := 'SELECT ' +
            '  ISNULL(SUM(Cantidad),0) ' +
            'FROM FS_SGA_AcumuladoPendiente WITH (NOLOCK) ' +
            'WHERE ' +
            '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
            '  AND LineaPedidoCliente = ''00000000-0000-0000-0000-000000000000'' ' +
            '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
            '  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion) + ' ' +
            '  AND UnidadMedida = ''' + UnidadMedida + ''' ';

    fCantPrep := SQL_Execute ( Conn, sSQL );

    if Abs(Unidades) > fCantPrep then
    begin
      Result := '{"Almacen":"' + JSON_Str(aUbicacion.CodigoAlmacen) + '","Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La cantidad es superior a la preparada","Data":[]}';
      gaLogFile.Write ( Result, sIDCall  );
      Exit;
    end;

    PickingId := 0;
    if LineasPosicion<>'00000000-0000-0000-0000-000000000000' then
    begin
      sSQL := 'SELECT ' +
              '  PickingId ' +
              'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
              'WHERE ' +
              '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
              '  AND LineasPosicion = ''' + SQL_GUID_ToStr ( LineasPosicion ) + '''';
      try
        PickingId := SQL_Execute ( Conn, sSQL );
      except
        on E:Exception do
        begin
          PickingId := 0;
          gaLogFile.Write_DBException(E,sSQL,'Error al recuperar el pickinid de la línea', CONST_LOGID_BBDD );
        end;
      end;
    end;

    // EN MODO AUTOMÀTIC, MIRAR SI PODEM RESTAR UNITATS D'UNA CAIXA/PALET
    if ((sModoPackingList='AUTOMÁTICO') and (Unidades<0)) then
    begin

      if MatriculaActual <> '' then
      begin

        sSQL :=
          'SELECT ' +
          '  SUM(Unidades) AS Unidades, SUM(UnidadesBase) AS UnidadesBase ' +
          'FROM FS_SGA_Picking_Pedido_Lineas_Detalle WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND LineaPedidoAsignada = ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ' +
          '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
          '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
          '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
          '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
          '  AND CajaId = ' + IntToStr(CajaActual) + ' ' +
          '  AND Matricula = ''' + SQL_Str(MatriculaActual) + '''';

      end else begin

        sSQL :=
          'SELECT ' +
          '  SUM(Unidades) AS Unidades, SUM(UnidadesBase) AS UnidadesBase ' +
          'FROM FS_SGA_Picking_Pedido_Lineas_Detalle WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND LineaPedidoAsignada = ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ' +
          '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
          '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
          '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
          '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
          '  AND CajaId = ' + IntToStr(CajaActual) + ' ' +
          '  AND PaletId = ' + IntToStr(PaletActual);

      end;

      Q := SQL_PrepareQuery ( Conn, sSQL );
      Q.Open;

      iTotalPreparado     := 0;
      iTotalPreparadoBase := 0;
      if not Q.EOF then
      begin
        iTotalPreparado     := Q.FieldByName('Unidades').AsFloat;
        iTotalPreparadoBase := Q.FieldByName('UnidadesBase').AsFloat;
      end;

      Q.Close;
      FreeAndNil(Q);

      if Abs(Unidades)>iTotalPreparado then
      begin
        if MatriculaActual<>'' then
        begin
          Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '",' +
            '"Result":"ERROR","Message":"No pueden quitarse tantas unidades de la caja ' + IntToStr(CajaActual) + ' y palet ' + MatriculaActual + '","Data":[]}';
        end else begin
          Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '",' +
            '"Result":"ERROR","Message":"No pueden quitarse tantas unidades de la caja ' + IntToStr(CajaActual) + ' y palet ' + IntToStr(PaletActual) + '","Data":[]}';
        end;
        Exit;
      end;

    end;

  end;

  // Mirem si fem expedició automàtica quan només tenim un pedido
  (*
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_AutoExpedicion, bAutoExpedicion, CodigoEmpresa.EmpresaOrigen );

  // Ens assegurem que només tinguem una sola comanda si tenim AutoExpedició
  if bAutoExpedicion then
  begin

    sSQL := 'SELECT COUNT ( * ) ' +
            'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
            'WHERE ' +
            '  PreparacionId = ' + IntToStr(IdPreparacion);
    iNumPedidos := SQL_Execute ( Conn, sSQL );

    if iNumPedidos>1 then
    begin
      bAutoExpedicion := FALSE;
      gaLogFile.Write ( 'Se han seleccionado más de un pedido y no se puede realizar la autoexpedición', sIDCall );
    end;

  end;
  *)

  {$ENDREGION}

  sStr := '  Preparacion    : ' + IntToStr(IdPreparacion) + #13 + #10 +
          '                       CodigoArticulo : ' + CodigoArticulo + #13 + #10 +
          '                       Partida        : ' + Partida + #13 + #10 +
          '                       CodigoTalla    : ' + CodigoTalla + #13 + #10 +
          '                       CodigoColor    : ' + CodigoColor + #13 + #10 +
          '                       CodigoUbicacion: ' + CodigoUbicacion + #13 + #10 +
          '                       Destino        : ' + CodigoUbicacionExpedicion + #13 + #10 +
          '                       Cantidad       : ' + FloatToStr(Unidades) + #13 + #10 +
          '                       CantidadBase   : ' + FloatToStr(UnidadesBase) + #13 + #10 +
          '                       Caducidad      : ' + sFechaCaduca + #13 + #10 +
          '                       Autoexpedicion : ' + BoolToStr(bAutoExpedicion) + #13 + #10;
  gaLogFile.Write ( sStr, sIDCall  );

  {$REGION 'Guardar les dades'}

  bErr := FALSE;
  sMsg := '';

  // Preprocesa UPDATE
  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_UpdateCantidadPreparacion_BEFORE', sPROCCustom) then
  begin

    sSQL := 'EXEC dbo.[' + sPROCCustom + '] ' +
            IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
            IntToStr(IdPreparacion);
    try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E:Exception do
      begin
        gaLogFile.Write_DBException(E,sSQL,'Error al preprocesar la cantidad de preparación', CONST_LOGID_BBDD );
      end;
    end;
  end;

  if not bErr then try
    sNewGuid           := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sNewMovOrigen      := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sOrigenMovimiento  := 'S';
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if not bErr then
  begin

    gaLogFile.Write ( 'SGA_Reservar_stock_pedido', sIDCall  );

    iIntents := 1;

    while (iIntents<=3) do begin

      bErr := not SGA_Reservar_stock_pedido_TC (
        Conn,
        CodigoEmpresa,
        YY,
        '',
        '',
        CodigoArticulo,
        Partida,
        CodigoTalla,
        CodigoColor,
        IdPreparacion,
        0,
        LineasPosicion,
        Unidades,
        UnidadMedida,
        UnidadesBase,
        UnidadMedidaBase,
        0, //CodigoAgrupacion, // NO AGRUPAREM MAI A L'ACUMULADO PENDIENTE
        dFechaCaduca,
        sMsg
      );

      if bErr then
        gaLogFile.Write ( 'After SGA_Reservar_stock_pedido: ERROR (intent ' + inttostr(iIntents) + ')', sIDCall  )
      else
        gaLogFile.Write ( 'After SGA_Reservar_stock_pedido: OK', sIDCall );

      if bErr then begin
        Inc(iIntents);
        Sleep(1000);
      end else begin
        iIntents := 999;
      end;

    end;

  end;

  if bErr then
    gaLogFile.Write ( 'ERROR: ' + sMsg, sIDCall );

  SGA_FS_ALMACEN_PrepareMov ( gaMov );
  gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
  gaMov.EmpresaOrigen          := CodigoEmpresa.EmpresaOrigen;
  gaMov.CodigoUsuario          := CodigoUsuario;
  gaMov.Ejercicio              := YY;
  gaMov.Periodo                := MonthOf(Date());
  gaMov.Fecha                  := Date();
  gaMov.FechaHora              := Now();
  gaMov.CodigoAlmacen          := aUbicacion.CodigoAlmacen;
  gaMov.CodigoUbicacion        := CodigoUbicacion;
  gaMov.CodigoArticulo         := CodigoArticulo;
  gaMov.Partida                := Partida;
  gaMov.Partida2               := PartidaPedido;
  gaMov.CodigoTalla            := CodigoTalla;
  gaMov.CodigoColor            := CodigoColor;
  gaMov.TipoMovimiento         := 2;
  gaMov.OrigenMovimiento       := TipoSalida;
  gaMov.Unidades               := Unidades;
  gaMov.UnidadMedida           := AnsiUpperCase(UnidadMedida);
  gaMov.UnidadesBase           := UnidadesBase;
  gaMov.UnidadMedidaBase       := AnsiUpperCase(UnidadMedidaBase);
  gaMov.FactorConversion       := FactorConversion;
  gaMov.FechaCaduca            := dFechaCaduca;
  gaMov.IdProcesoIME           := sNewGuid;
  gaMov.Comentario             := 'SGAMobile: ' + DescripcionSalida;
  gaMov.PreparacionId          := IdPreparacion;
  gaMov.MovOrigen              := sNewMovOrigen;
  gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );

  gaMov.Precio :=
    ARTICULO_ConsultarPrecioStock (
      Conn,
      CodigoEmpresa,
      gaMov.CodigoArticulo,
      gaMov.Partida,
      gaMov.CodigoColor,
      gaMov.CodigoTalla,
      gaMov.CodigoAlmacen,
      gaMov.GrupoTalla
    );

  if aUbicacion.CodigoAlmacen<>aUbicacionExpedicion.CodigoAlmacen then begin
    gaMov.CodigoAlmacenDestino   := aUbicacionExpedicion.CodigoAlmacen;
    gaMov.CodigoUbicacionDestino := aUbicacionExpedicion.CodigoUbicacion;
  end;

  if not bErr then try
    gaLogFile.Write ( 'SGA_FS_ALMACEN_MovimientoStock salida', sIDCall );
    bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if aUbicacion.CodigoAlmacen<>aUbicacionExpedicion.CodigoAlmacen then begin
    gaLogFile.Write ( 'SGA_FS_ALMACEN_MovimientoStock traspaso', sIDCall  );
    gaMov.CodigoAlmacenDestino   := aUbicacion.CodigoAlmacen;
    gaMov.CodigoUbicacionDestino := aUbicacion.CodigoUbicacion;
  end;

  gaMov.FechaHora              := Now();
  gaMov.CodigoAlmacen          := aUbicacionExpedicion.CodigoAlmacen;
  gaMov.CodigoUbicacion        := CodigoUbicacionExpedicion;
  gaMov.CodigoArticulo         := CodigoArticulo;
  gaMov.TipoMovimiento         := 1;
  gaMov.OrigenMovimiento       := TipoEntrada;
  gaMov.Comentario             := 'SGAMobile: ' + DescripcionEntrada;
  gaMov.Precio :=
    ARTICULO_ConsultarPrecioStock (
      Conn,
      CodigoEmpresa,
      gaMov.CodigoArticulo,
      gaMov.Partida,
      gaMov.CodigoColor,
      gaMov.CodigoTalla,
      gaMov.CodigoAlmacen,
      gaMov.GrupoTalla,
      gaMov.CodigoAlmacenDestino
    );

  if not bErr then try
    gaLogFile.Write ( 'SGA_FS_ALMACEN_MovimientoStock entrada', sIDCall  );
    bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg, sIDCall );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  // Fem els moviments a Sage si els magatzems són diferents
  if (not bErr) and (aUbicacion.CodigoAlmacen <> aUbicacionExpedicion.CodigoAlmacen) then begin

    gaLogFile.Write ( 'Movimiento de traspaso en Sage, IdProcesoIME = ' + gaMov.IdProcesoIME, sIDCall  );

    // Inserir línia a TmpIME_MovimientoStock
    sSQL := 'INSERT INTO TmpIME_MovimientoStock ( CodigoEmpresa, EmpresaOrigen, Ejercicio, Periodo, Fecha, FechaRegistro, Serie, '+
            '  CodigoArticulo, CodigoAlmacen, AlmacenContrapartida, Partida, Partida2_, TipoMovimiento, Unidades, ' +
            '  UnidadMedida1_, Unidades2_, UnidadMedida2_, FactorConversion_, Comentario, Ubicacion, ' +
            '  idProcesoIME, MovOrigen, Precio, Importe, FechaCaduca, OrigenMovimiento, MovPosicion, CodigoTalla01_, CodigoColor_ ) '+
            'VALUES (' +
            IntToStr(gaMov.CodigoEmpresa) + ', ' +
            IntToStr(gaMov.EmpresaOrigen) + ', ' +
            IntToStr(gaMov.Ejercicio) + ', ' +
            IntToStr(gaMov.Periodo) + ', ' +
            SQL_DateTimeToStr(gaMov.Fecha) + ', ' +
            SQL_DateTimeToStr(gaMov.FechaHora) + ', ' +
            '''' + SQL_Str(gaMov.Serie) + ''', ' +
            '''' + SQL_Str(gaMov.CodigoArticulo) + ''', ' +
            '''' + SQL_Str(gaMov.CodigoAlmacenDestino) + ''', ' +
            '''' + SQL_Str(gaMov.CodigoAlmacen) + ''', ' +
            '''' + SQL_Str(gaMov.Partida) + ''', ' +
            '''' + SQL_Str(gaMov.Partida) + ''', ' +
            '2, ' +
            SQL_FloatToStr(gaMov.Unidades) + ', ' +
            '''' + SQL_Str(gaMov.UnidadMedida) + ''', ' +
            SQL_FloatToStr(gaMov.UnidadesBase) + ', ' +
            '''' + SQL_Str(gaMov.UnidadMedidaBase) + ''', ' +
            SQL_FloatToStr(gaMov.FactorConversion) + ', ' +
            '''' + SQL_Str(gaMov.Comentario) + ''', ' +
            ''''', ' +
            '''' + SQL_GUID_ToStr(gaMov.IdProcesoIME) + ''',' +
            '''' + SQL_GUID_ToStr(gaMov.MovOrigen) + ''', ' +
            SQL_FloatToStr(gaMov.Precio) + ', ' +
            SQL_FloatToStr(gaMov.Precio * gaMov.Unidades) + ', ' +
            SQL_DateToStr(gaMov.FechaCaduca) + ', ' +
            '''T'', ' +
            '''' + SQL_GUID_ToStr(gaMov.MovPosicion) + ''', ' +
            '''' + SQL_Str(gaMov.CodigoTalla) + ''', ' +
            '''' + SQL_Str(gaMov.CodigoColor) + ''' ' +
            ' )';

    if not bErr then try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on e: exception do begin
        bErr := bErr or true;
        sMsg := e.Message;
      end;
    end;

    sOperparams := '{"IdProcesoIME":"' + SQL_GUID_ToStr(gaMov.IdProcesoIME) + '","MantenerDatos":"1","MantenerErrores":"1","Módulos":"4","CodigoEmpresa":' + IntToStr(CodigoEmpresa.Stocks) + '}';
    sSQL := 'INSERT INTO ' +
            '  FS_Operations ( oper_CodigoEmpresa, oper_name, oper_product_code, oper_mac_address, oper_ip_address, ' +
            '  oper_datetime, oper_status, oper_params ) ' +
            'VALUES ( ' +
            IntToStr(CodigoEmpresa.Stocks) + ', ' +
            '''MOVIMIENTOSTOCK'', ' +
            '''E4E8'',' +
            '''' + SQL_Str(NETWORK_LocalMAC()) + ''', ' +
            '''' + SQL_Str(GetLocalIp()) + ''', ' +
            SQL_DateTimeToStr(Now()) + ', ' +
            '0, ' +
            '''' + SQL_Str(sOperparams) + ''' )';
    //gaLogFile.Write(sSQL, CONST_LOGID_BBDD, LOG_LEVEL_INFO );

    if not bErr then try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on e: exception do begin
        bErr := true;
        sMsg := e.Message;
      end;
    end;

  end;

  if dFechaCaduca=0 then
  begin
    sFechaCaduca := 'NULL';
  end else begin
    sFechaCaduca := SQL_DateToStr(dFechaCaduca);
  end;

  // GUARDEM EL DETALL DEL MOVIMENT A LA TAULA DE DETALL
  if (Unidades>0) or (UnidadesBase>0) then
  begin
    if Matricula<>'' then
    begin

      sSQL :=
        'INSERT INTO FS_SGA_Picking_Pedido_Lineas_Detalle ( ' +
        '  PreparacionId, PickingId, Ejercicio, CodigoArticulo, Partida, UnidadMedida, FechaCaduca, CajaId, Matricula, Unidades, UnidadesBase, ' +
        '  CodigoAgrupacion, UnidadesAgrupacion, LineaPedidoAsignada, CodigoTalla01_, CodigoColor_ ) ' +
        'VALUES ( ' +
        IntToStr(IdPreparacion) + ', ' +
        IntToStr(PickingId) + ', ' +
        IntToStr(Ejercicio) + ', ' +
        '''' + SQL_Str(CodigoArticulo) + ''', ' +
        '''' + SQL_Str(Partida) + ''', ' +
        '''' + SQL_Str(UnidadMedida) + ''', ' +
        sFechaCaduca + ', ' +
        IntToStr(CajaActual) + ', ' +
        '''' + SQL_Str(MatriculaActual) + ''', ' +
        SQL_FloatToStr(Unidades) + ', ' +
        SQL_FloatToStr(UnidadesBase) + ', ' +
        IntToStr(CodigoAgrupacion) + ', ' +
        SQL_FloatToStr(fUnidadesAgrupacion) + ', ' +
        '''' + SQL_GUID_ToStr(LineasPosicion) + ''', ' +
        '''' + SQL_Str(CodigoTalla) + ''', ' +
        '''' + SQL_Str(CodigoColor) + ''' ' +
        ')';

    end else begin

      sSQL :=
        'INSERT INTO FS_SGA_Picking_Pedido_Lineas_Detalle ( ' +
        '  PreparacionId, PickingId, Ejercicio, CodigoArticulo, Partida, UnidadMedida, FechaCaduca, CajaId, PaletId, Unidades, UnidadesBase, ' +
        '  CodigoAgrupacion, UnidadesAgrupacion, LineaPedidoAsignada, CodigoTalla01_, CodigoColor_ ) ' +
        'VALUES ( ' +
        IntToStr(IdPreparacion) + ', ' +
        IntToStr(PickingId) + ', ' +
        IntToStr(Ejercicio) + ', ' +
        '''' + SQL_Str(CodigoArticulo) + ''', ' +
        '''' + SQL_Str(Partida) + ''', ' +
        '''' + SQL_Str(UnidadMedida) + ''', ' +
        sFechaCaduca + ', ' +
        IntToStr(CajaActual) + ', ' +
        IntToStr(PaletActual) + ', ' +
        SQL_FloatToStr(Unidades) + ', ' +
        SQL_FloatToStr(UnidadesBase) + ', ' +
        IntToStr(CodigoAgrupacion) + ', ' +
        SQL_FloatToStr(fUnidadesAgrupacion) + ', ' +
        '''' + SQL_GUID_ToStr(LineasPosicion) + ''', ' +
        '''' + SQL_Str(CodigoTalla) + ''', ' +
        '''' + SQL_Str(CodigoColor) + ''' ' +
        ')';

    end;

    try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E:Exception do
      begin
        gaLogFile.Write_DBException(E,sSQL,'Error al guardar del detalle de caja/palet', CONST_LOGID_BBDD);
      end;
    end;
  end else begin

    // RESTEM UNITATS AL DETALL
    fQtat := abs(Unidades);
    fQtatBase := abs(UnidadesBase);

    bFinal := FALSE;
    while not bFinal do
    begin

      sSQL := 'SELECT TOP 1 ' +
              '  AutoId, Unidades, UnidadesBase ' +
              'FROM FS_SGA_Picking_Pedido_Lineas_Detalle WITH (NOLOCK) ' +
              'WHERE ' +
              '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
              '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
              '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
              '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
              '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
              '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
              '  AND LineaPedidoAsignada = ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ' +
              '  AND Unidades > 0 ' +
              '  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion) + ' ';

      if sModoPackingList='AUTOMÁTICO' then
      begin
        // MODE AUTOMÀTIC
        if MatriculaActual<>'' then
        begin
          sSQL := sSQL +
            '  AND CajaId = ' + IntToStr(CajaActual) + ' ' +
            '  AND Matricula = ''' + SQL_Str(MatriculaActual) + ''' ';
        end else begin
          sSQL := sSQL +
            '  AND CajaId = ' + IntToStr(CajaActual) + ' ' +
            '  AND PaletId = ' + IntToStr(PaletActual) + ' ';
        end;
      end;

      sSQL := sSQL +
        'ORDER BY ' +
        '  AutoId DESC';

      Q := SQL_PrepareQuery ( Conn, sSQL );
      Q.Open;

      if not Q.EOF then
      begin
        iAutoID          := Q.FieldByName('AutoId').AsInteger;
        fQtatDetalle     := Q.FieldByName('Unidades').AsFloat;
        fQtatDetalleBase := Q.FieldByName('UnidadesBase').AsFloat;
      end;

      Q.Close;
      FreeAndNil(Q);

      bFinal := (fQtatDetalle=0) and (fQtatDetalleBase=0);

      if not bFinal then
      begin

        if fQtatDetalle>fQtat then
        begin
          fQtatARestar     := fQtat;
          fQtatARestarBase := fQtatBase;
        end else begin
          fQtatARestar     := fQtatDetalle;
          fQtatARestarBase := fQtatDetalleBase;
        end;

        sSQL := 'UPDATE ' +
                '  FS_SGA_Picking_Pedido_Lineas_Detalle ' +
                'SET ' +
                '  Unidades = Unidades - ' + SQL_FloatToStr(fQtatARestar) + ', ' +
                '  UnidadesBase = UnidadesBase - ' + SQL_FloatToStr(fQtatARestarBase) + ' ' +
                'WHERE ' +
                '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
                '  AND AutoId = ' + IntToStr(iAutoID);
        SQL_Execute_NoRes ( Conn, sSQL );

        fQtat := fQtat - fQtatARestar;
        fQtatBase := fQtatBase - fQtatARestarBase;
        bFinal := (fQtat<=0)

      end;

    end;

  end;

  // GUARDAMOS EL PALET Y LA CAJA
  sSQL :=
    'UPDATE FS_SGA_Picking_Preparaciones ' +
    'SET ' +
    '  PaletActual = ' + IntToStr(PaletActual) + ', ' +
    '  CajaActual = ' + IntToStr(CajaActual) + ', ' +
    '  MatriculaActual = ''' + SQL_Str(MatriculaActual) + ''' ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion);
  try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do
    begin
      gaLogFile.Write_DBException(E,sSQL,'No se ha podido actualizar el nº de palet y caja actuales de la preparación', CONST_LOGID_BBDD );
    end;
  end;

  sSQL :=
    'UPDATE FS_SGA_Picking_Pedido_Lineas ' +
    'SET ' +
    '  UdRetiradas = UdRetiradas + ' + SQL_FloatToStr(Unidades) + ', ' +
    '  UdRetiradasBase = UdRetiradasBase + ' + SQL_FloatToStr(UnidadesBase) + ' ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND CodigoArticulo=''' + SQL_Str(CodigoArticulo) + ''' ' +
    '  AND Partida=''' + SQL_Str(PartidaPedido) + ''' ' +
    '  AND CodigoTalla01_=''' + SQL_Str(CodigoTalla) + ''' ' +
    '  AND CodigoColor_=''' + SQL_Str(CodigoColor) + ''' ' +
    '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
    '  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacionPedido) + ' ';
  if (LineasPosicion<>'') and (LineasPosicion<>'00000000-0000-0000-0000-000000000000') then
  begin
    sSQL := sSQL + 'AND LineasPosicion = ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ';
  end;

  if not bErr then try
    gaLogFile.Write ( 'Actualizar unidades retiradas', sIDCall  );
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  // ACTUALITZEM LES QUANTITATS A LA RUTA
  sSQL :=
    'UPDATE FS_SGA_PreparacionOrdenada ' +
    'SET ' +
    '  UdRetiradas = UdRetiradas + ' + SQL_FloatToStr(Unidades) + ', ' +
    '  UdRetiradasBase = UdRetiradasBase + ' + SQL_FloatToStr(UnidadesBase) + ' ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND CodigoArticulo=''' + SQL_Str(CodigoArticulo) + ''' ' +
    '  AND Partida=''' + SQL_Str(PartidaPedido) + ''' ' +
    '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
    '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
    '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
    '  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacionPedido);
  SQL_Execute_NoRes ( Conn, sSQL );

  if (not bErr) and (bRecalcularRuta) then begin

    gaLogFile.Write ( 'Recalculamos ruta', sIDCall );

    sSQL := 'SELECT ' +
            '  SUM(UdNecesarias) AS Necesarias, MIN(UdRetiradas) AS Retiradas ' +
            'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
            'WHERE ' +
            '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
            '  AND CodigoArticulo=''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND Partida=''' + SQL_Str(PartidaPedido) + ''' ' +
            '  AND CodigoTalla01_=''' + SQL_Str(CodigoTalla) + ''' ' +
            '  AND CodigoColor_=''' + SQL_Str(CodigoColor) + ''' ' +
            '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
            '  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion);
    Q := SQL_PrepareQuery ( Conn, sSQL );

    if not bErr then try
      Q.Open;
    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message;
      end;
    end;

    if (not bErr) and (not Q.EOF) then begin
      iUnidadesNecesarias := Q.FieldByName('Necesarias').AsFloat;
      iUnidadesRetiradas := Q.FieldByName('Retiradas').AsFloat;
      gaLogFile.Write ( 'Unidades necesarias = ' + FloatToStr(iUnidadesNecesarias) + ', Unidades retiradas = ' + FloatToStr(iUnidadesRetiradas), sIDCall  );
    end else begin
      iUnidadesNecesarias := 0;
      iUnidadesRetiradas := 0;
    end;

    if iUnidadesNecesarias<=iUnidadesRetiradas then begin
      gaLogFile.Write ( 'Recalcular ruta = false', sIDCall  );
      bRecalcularRuta := FALSE;
    end;

    Q.Close;
    FreeAndNil(Q);

  end;

  if (not bErr) and (bRecalcularRuta) then try
    gaLogFile.Write ( 'Recalcular ruta', sIDCall  );
    bErr := not SGA_Check_PreparacionOrdenada (
      gsPath,
      Conn,
      CodigoEmpresa,
      CodigoUsuario,
      YY,
      IdPreparacion,
      aUbicacion.CodigoAlmacen,
      CodigoUbicacionExpedicion,
      sConsiderarReservas,
      sSoloReservas,
      sIgnorarPartidaSolicitada,
      sIgnorarUbicacionSolicitada,
      sMsg,
      TRUE,
      bIsBuilding
    );
    gaLogFile.Write ( 'Recalcular ruta OK', sIDCall  );
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  sSQL := 'DELETE FROM FS_SGA_Picking_Pedido_Lineas_Detalle ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' AND ' +
          '  Unidades=0 and UnidadesBase=0';
  if not bErr then try
    gaLogFile.Write ( 'Purgar líneas completadas', sIDCall  );
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if bErr then begin
    gaLogFile.Write ( 'ERROR: ' + sMsg, sIDCall  );
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(sMsg) + '","Data":[]}';
    Exit;
  end;

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;
  LP.MovOrigen := gaMov.MovOrigen;
  LP.Matricula := gaMov.Matricula;
   
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'DELETE-PREP-PROD', 'Borrar producto de la preparación', @LP );
  
  {$ENDREGION}

end;


// ┌───────────────────────────────────────────────────────────────────────┐ \\
// │ ACTUALITZA LA QUANTITAT UTILITZADA EN UNA LÍNIA DE PREPARACIÓ         │ \\
// │ INCLOU TALLES, COLORS I FACTORCONVERSIÓ=0                             │ \\
// └───────────────────────────────────────────────────────────────────────┘ \\
procedure WebModule1updateUnidadesPreparacionTCAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  IdPreparacion: Integer;
  PickingId: Integer;
  sSQL: String;
  Data: String;
  Desglose: String;
  lJSonValue: TJSonValue;
  CodigoUbicacion: String;
  CodigoArticulo: String;
  Partida: String;
  LineasPosicion: String;
  Q: TADOQuery;
  aUbicacion: TSGAUbicacion;
  Stock: Double;
  UnidadesPendientes: Double;
  bErr: Boolean;
  sMsg: String;
  sNewGuid: String;
  sNewMovOrigen: String;
  sOrigenMovimiento: String;
  YY: Integer;
  CodigoUsuario: Integer;
  iNum: Integer;
  Unidades: Double;
  UnidadMedida: String;
  UnidadesBase: Double;
  UnidadMedidaBase: String;
  FactorConversion: Double;
  TratamientoPartidas: Boolean;
  CodigoUbicacionExpedicion: String;
  aUbicacionExpedicion: TSGAUbicacion;
  CodigoAlmacenUbicacion: String;
  PartidaPedido: String;
  sStr: string;
  TipoEntrada, TipoSalida: String;
  DescripcionEntrada, DescripcionSalida: String;
  sOperparams: String;
  bRecalcularRuta: Boolean;
  bResult: Boolean;
  iUnidadesNecesarias: Double;
  iUnidadesRetiradas: Double;
  iIntents: Integer;
  gaMov: TSGAMovimientoStock;
  bAutoExpedicion: Boolean;
  iNumPedidos: Integer;
  bIsBuilding: Boolean;
  contentfields: TStringList;
  CodigoAgrupacion: Integer;
  CodigoAgrupacionPedido: Integer;
  fUnidadesAgrupacion: Double;
  sUnidadMedidaAgrupacion: string;
  fCantPrep: Double;
  bSepararPorLinea: Boolean;
  PaletActual, CajaActual: Integer;
  MatriculaActual: String;
  sFechaCaduca: String;
  dFechaCaduca: TDateTime;
  sModoPackingList: String;
  iTotalPreparado: Double;
  iTotalPreparadoBase: Double;
  fQtatARestar, fQtatDetalle, fQtat: Double;
  fQtatARestarBase, fQtatDetalleBase, fQtatBase: Double;
  bFinal: Boolean;
  iAutoID: Integer;
  fStockBase: Double;
  CodigoTalla: String;
  CodigoColor: String;
  UnidadesAgrupacion: Double;
  CodigoAlmacenDefecto: String;
  CodigoAlmacen: String;
  DefaultUbi: TDefaultUbicaciones;
  sPROCCustom: string;
  Matricula: string;
  UUID: string;
  Ejercicio: Integer;
  sConsiderarReservas: String;
  sSoloReservas: String;
  sIgnorarPartidaSolicitada: String;
  sIgnorarUbicacionSolicitada: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  bRecalcularRuta := FALSE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  sConsiderarReservas         := contentfields.Values['ConsiderarReservas'];
  sSoloReservas               := contentfields.Values['SoloReservas'];
  sIgnorarPartidaSolicitada   := contentfields.Values['IgnorarPartidaSolicitada'];
  sIgnorarUbicacionSolicitada := contentfields.Values['IgnorarUbicacionSolicitada'];

  if sConsiderarReservas='' then sConsiderarReservas := '1';
  if sSoloReservas='' then sSoloReservas := '0';
  if sIgnorarPartidaSolicitada='' then sIgnorarPartidaSolicitada := '0';
  if sIgnorarUbicacionSolicitada='' then sIgnorarUbicacionSolicitada := '0';

  CodigoUsuario := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID          := contentfields.values['UUID'];

  CodigoAlmacenDefecto := (contentfields.Values['CodigoAlmacenDefecto']);
  if CodigoAlmacenDefecto='' then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de almacén no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_ModoPackingList, sModoPackingList, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_DesglosarPreparacionesPorLinea, bSepararPorLinea, CodigoEmpresa.EmpresaOrigen );

  YY := SGA_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  sSQL := 'SELECT Ejercicio FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  if FS_SGA_PreparacionServida ( Conn, IdPreparacion ) then
  begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La preparación ' + IntToStr(IdPreparacion) + ' ya está servida","Data":[]}';
    Exit;
  end;

  FormatSettings.DecimalSeparator  := '.';
  FormatSettings.ThousandSeparator := ',';

  PaletActual     := StrToIntDef(Trim(contentfields.values['Palet']),1);
  CajaActual      := StrToIntDef(Trim(contentfields.values['Caja']),1);
  MatriculaActual := contentfields.values['Matricula'];
  CodigoUbicacion := (contentfields.Values['CodigoUbicacion']);
  LineasPosicion  := SQL_GUID_ToStr((contentfields.values['LineasPosicion']));
  PickingId       := StrToIntDef(contentfields.values['PickingId'],0);

  if not bSepararPorLinea then
    LineasPosicion := GUID0;

  CodigoArticulo         := (contentfields.values['CodigoArticulo']);
  Partida                := (contentfields.values['Partida']);
  PartidaPedido          := (contentfields.values['PartidaPedido']);
  sFechaCaduca           := Trim(contentfields.values['FechaCaducidad']);
  CodigoTalla            := (contentfields.values['CodigoTalla']);
  CodigoColor            := (contentfields.values['CodigoColor']);
  UnidadMedida           := AnsiUpperCase(contentfields.values['UnidadMedida']);
  UnidadMedidaBase       := AnsiUpperCase(contentfields.values['UnidadMedidaBase']);
  FactorConversion       := FS_StrToFloatDef(Trim(contentfields.values['FactorConversion']),1);
  Unidades               := FS_StrToFloatDef(Trim(contentfields.values['Cantidad']),1);
  CodigoAgrupacion       := StrToIntDef(Trim(contentfields.values['CodigoAgrupacion']),0);
  CodigoAgrupacionPedido := StrToIntDef(Trim(contentfields.values['CodigoAgrupacionPedido']),0);
  UnidadesAgrupacion     := FS_StrToFloatDef(Trim(contentfields.values['UnidadesAgrupacion']),1);

  FS_SGA_Check_UnidadMedidaBase ( Conn, CodigoEmpresa, CodigoArticulo, UnidadMedida, UnidadMedidaBase );

  if FactorConversion<>0 then
    UnidadesBase := Unidades * FactorConversion
  else
    UnidadesBase := FS_StrToFloatDef(Trim(contentfields.values['CantidadBase']),1);

  FormatSettings.DecimalSeparator  := ',';
  FormatSettings.ThousandSeparator := '.';

  if sFechaCaduca<>'' then
  begin
    dFechaCaduca := StrToDate(sFechaCaduca);
  end else begin
    dFechaCaduca := 0;
  end;

  // Conversió al codi d'article real
  CodigoArticulo := ARTICULO_CodigoFromAlternativo ( Conn, CodigoEmpresa, CodigoArticulo );

  if CodigoArticulo=''then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  TratamientoPartidas := ARTICULO_TratamientoPartida ( Conn, CodigoEmpresa, CodigoArticulo );

  if (Partida='') and (TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de partida no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  if (Partida<>'') and (not TratamientoPartidas) then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de artículo no requiere partida","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  FS_SGA_ObtenerAgrupacion ( Conn, CodigoEmpresa, CodigoArticulo, CodigoAgrupacion,
    fUnidadesAgrupacion, sUnidadMedidaAgrupacion );

  // Conversió al codi d'article real
  CodigoUbicacion        := FS_SGA_CodigoUbicacion_FromAlternativo ( Conn, CodigoEmpresa, CodigoUbicacion );
  CodigoAlmacenUbicacion := FS_SGA_CodigoAlmacen ( CodigoUbicacion );
  Matricula := (contentfields.Values['Matricula']);

  if CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de ubicación no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  sSQL :=
      'SELECT AlmacenPreparacion ' +
      'FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) ' +
      'WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  CodigoAlmacen := CodigoAlmacenDefecto; //SQL_Execute ( Conn, sSQL );

  if (CodigoAlmacen='') or (CodigoAlmacen='0') then
  begin
    PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacion, CodigoEmpresa.EmpresaOrigen );
    CodigoAlmacen := FS_SGA_CodigoAlmacen ( CodigoUbicacion );
  end;

  FS_SGA_ObtenerUbicacionesAlmacen ( Conn, CodigoEmpresa, CodigoAlmacen, DefaultUbi );
  CodigoUbicacionExpedicion := DefaultUbi.UbicacionExpediciones;

  gaLogFile.write('CodigoUbicacionExpedicion=' + CodigoUbicacionExpedicion);

  //PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_UbicacionDefectoExpedicion, CodigoUbicacionExpedicion, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_TipoMovimientoEntradaExpedicion, TipoEntrada, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_TipoMovimientoSalidaExpedicion, TipoSalida, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_DescripcionEntradaExpedicion, DescripcionEntrada, CodigoEmpresa.EmpresaOrigen );
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_DescripcionSalidaExpedicion, DescripcionSalida, CodigoEmpresa.EmpresaOrigen );

  aUbicacionExpedicion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacionExpedicion );
  if aUbicacionExpedicion.CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de ubicación de expedición no definido en parámetros","Data":[]}';
    Exit;
  end;

  (* AIXÒ NO HAURIA DE PODER PASSAR MAI
  if Unidades=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Cantidad no especificada","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;
  *)

  aUbicacion := SGA_ALMACEN_GetUbicacion ( Conn, CodigoEmpresa, CodigoUbicacion );
  if aUbicacion.CodigoUbicacion='' then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"El código de ubicación es incorrecto","Data":[]}';
    Exit;
  end;

  if (UnidadMedidaBase='') and (gbTratamientoSimplificado) then
    Unidadmedida := '';

  (*
  UnidadesBase := SGA_FS_ARTICULO_ConversionUnidades ( Conn, CodigoEmpresa.UnidadesMedida, CodigoArticulo,
                    Unidades, UnidadMedidaBase, UnidadMedida, FactorConversion );
  *)

  if UnidadesBase=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Las unidades de medida son incorrectas","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  Stock :=
    SGA_ALMACEN_Stock (
      Conn,
      CodigoEmpresa,
      aUbicacion.
      CodigoAlmacen,
      CodigoUbicacion,
      CodigoArticulo,
      Partida,
      CodigoTalla,
      CodigoColor,
      Matricula,
      UnidadMedida,
      UnidadMedidaBase,
      fStockBase,
      gbTratamientoSimplificado
    );

  if (Unidades>0) and ((Unidades>Stock) or (UnidadesBase>fStockBase)) then begin
    Result := '{"Almacen":"' + JSON_Str(aUbicacion.CodigoAlmacen) + '","Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La cantidad es superior al stock de la ubicación del almacén","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  sSQL := 'SELECT SUM(UdNecesarias) - MAX(UdRetiradas) ' +
          'FROM   FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
          'WHERE PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          'AND CodigoArticulo=''' + SQL_Str(CodigoArticulo) + ''' ' +
          'AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacionPedido) + ' ';
  if LineasPosicion<>'00000000-0000-0000-0000-000000000000' then
  begin
    sSQL := sSQL + 'AND LineasPosicion=''' + SQL_GUID_ToStr(LineasPosicion) + ''' ';
  end;

  UnidadesPendientes := SQL_Execute ( Conn, sSQL );

  gaLogFile.Write ( 'Unidades pendientes = ' + FloatToStr(UnidadesPendientes) + ', Unidades = ' + FloatToStr(Unidades) + ', Stock = ' + FloatToStr(Stock), sIDCall  );
  if Unidades=Stock then begin
    // Mirar si en quedaran de pendents
    if (UnidadesPendientes-Unidades)>0 then begin
      PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_RecalcularRutaAlVaciarUbicacion, bRecalcularRuta, CodigoEmpresa.EmpresaOrigen );
      if bRecalcularRuta then
      begin
        gaLogFile.Write ( 'Recalcular ruta = true' , sIDCall );
      end;
    end;
  end;

  // Si estem fent una sortida negativa, mirem si la quantitat que treiem
  // d'una partida concreta no queda negatiu
  if (Unidades<0) or (UnidadesBase<0) then
  begin

    sSQL := 'SELECT ' +
            '  ISNULL(SUM(Cantidad),0) ' +
            'FROM FS_SGA_AcumuladoPendiente WITH (NOLOCK) ' +
            'WHERE ' +
            '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
            '  AND LineaPedidoCliente = ''00000000-0000-0000-0000-000000000000'' ' +
            '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
            '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
            '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
            '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
            //'  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion) + ' ' +
            '  AND UnidadMedida = ''' + UnidadMedida + ''' ';

    fCantPrep := SQL_Execute ( Conn, sSQL );

    if Abs(Unidades) > fCantPrep then
    begin
      Result := '{"Almacen":"' + JSON_Str(aUbicacion.CodigoAlmacen) + '","Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"La cantidad es superior a la preparada","Data":[]}';
      gaLogFile.Write ( Result, sIDCall  );
      Exit;
    end;

    PickingId := 0;
    if LineasPosicion<>'00000000-0000-0000-0000-000000000000' then
    begin
      sSQL := 'SELECT ' +
              '  PickingId ' +
              'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
              'WHERE ' +
              '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
              '  AND LineasPosicion = ''' + SQL_GUID_ToStr ( LineasPosicion ) + '''';
      try
        PickingId := SQL_Execute ( Conn, sSQL );
      except
        on E:Exception do
        begin
          PickingId := 0;
          gaLogFile.Write_DBException(E,sSQL,'Error al recuperar el pickinid de la línea', CONST_LOGID_BBDD );
        end;
      end;
    end;

    // EN MODO AUTOMÀTIC, MIRAR SI PODEM RESTAR UNITATS D'UNA CAIXA/PALET
    if ((sModoPackingList='AUTOMÁTICO') and (Unidades<0)) then
    begin

      if MatriculaActual<>'' then
      begin
        sSQL :=
          'SELECT ' +
          '  SUM(Unidades) AS Unidades, SUM(UnidadesBase) AS UnidadesBase ' +
          'FROM FS_SGA_Picking_Pedido_Lineas_Detalle WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND LineaPedidoAsignada = ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ' +
          '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
          '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
          '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
          '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
          '  AND CajaId = ' + IntToStr(CajaActual) + ' ' +
          '  AND Matricula = ''' + SQL_Str(MatriculaActual) + '''';
      end else begin
        sSQL :=
          'SELECT ' +
          '  SUM(Unidades) AS Unidades, SUM(UnidadesBase) AS UnidadesBase ' +
          'FROM FS_SGA_Picking_Pedido_Lineas_Detalle WITH (NOLOCK) ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND LineaPedidoAsignada = ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ' +
          '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
          '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
          '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
          '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
          '  AND CajaId = ' + IntToStr(CajaActual) + ' ' +
          '  AND PaletId = ' + IntToStr(PaletActual);
      end;

      Q := SQL_PrepareQuery ( Conn, sSQL );
      Q.Open;

      iTotalPreparado     := 0;
      iTotalPreparadoBase := 0;
      if not Q.EOF then
      begin
        iTotalPreparado     := Q.FieldByName('Unidades').AsFloat;
        iTotalPreparadoBase := Q.FieldByName('UnidadesBase').AsFloat;
      end;

      Q.Close;
      FreeAndNil(Q);

      if Abs(Unidades)>iTotalPreparado then
      begin
        if MatriculaActual<>'' then
        begin
          Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '",' +
            '"Result":"ERROR","Message":"No pueden quitarse tantas unidades de la caja ' + IntToStr(CajaActual) + ' y palet ' + MatriculaActual + '","Data":[]}';
        end else begin
          Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '",' +
            '"Result":"ERROR","Message":"No pueden quitarse tantas unidades de la caja ' + IntToStr(CajaActual) + ' y palet ' + IntToStr(PaletActual) + '","Data":[]}';
        end;
        Exit;
      end;

    end;

  end;

  // Mirem si fem expedició automàtica quan només tenim un pedido
  (*
  PARAM_Read ( Conn, 'FS_SGA_Parametros', FS_PARAMS_SGA_AutoExpedicion, bAutoExpedicion, CodigoEmpresa.EmpresaOrigen );

  // Ens assegurem que només tinguem una sola comanda si tenim AutoExpedició
  if bAutoExpedicion then
  begin

    sSQL := 'SELECT COUNT ( * ) ' +
            'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
            'WHERE ' +
            '  PreparacionId = ' + IntToStr(IdPreparacion);
    iNumPedidos := SQL_Execute ( Conn, sSQL );

    if iNumPedidos>1 then
    begin
      bAutoExpedicion := FALSE;
      gaLogFile.Write ( 'Se han seleccionado más de un pedido y no se puede realizar la autoexpedición', sIDCall );
    end;

  end;
  *)

  {$ENDREGION}

  sStr := '  Preparacion    : ' + IntToStr(IdPreparacion) + #13 + #10 +
          '                       CodigoArticulo : ' + CodigoArticulo + #13 + #10 +
          '                       Partida        : ' + Partida + #13 + #10 +
          '                       CodigoUbicacion: ' + CodigoUbicacion + #13 + #10 +
          '                       Destino        : ' + CodigoUbicacionExpedicion + #13 + #10 +
          '                       Cantidad       : ' + FloatToStr(Unidades) + #13 + #10 +
          '                       CantidadBase   : ' + FloatToStr(UnidadesBase) + #13 + #10 +
          '                       Caducidad      : ' + sFechaCaduca + #13 + #10 +
          '                       Autoexpedicion : ' + BoolToStr(bAutoExpedicion) + #13 + #10;
  gaLogFile.Write ( sStr, sIDCall  );

  {$REGION 'Guardar les dades'}

  bErr := FALSE;
  sMsg := '';

  // Preprocesa UPDATE
  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_UpdateCantidadPreparacion_BEFORE', sPROCCustom) then
  begin

    sSQL := 'EXEC dbo.[' + sPROCCustom + '] ' +
            IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
            IntToStr(IdPreparacion);
    try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E:Exception do
      begin
        gaLogFile.Write_DBException(E,sSQL,'Error al preprocesar la cantidad de preparación', CONST_LOGID_BBDD );
      end;
    end;
  end;

  if not bErr then try
    sNewGuid           := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sNewMovOrigen      := SQL_Execute ( Conn, 'SELECT NEWID()' );
    sOrigenMovimiento  := 'S';
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if not bErr then
  begin

    gaLogFile.Write ( 'SGA_Reservar_stock_pedido', sIDCall  );

    iIntents := 1;

    while (iIntents<=3) do begin

      bErr := not SGA_Reservar_stock_pedido_TC (
        Conn,
        CodigoEmpresa,
        YY,
        '',
        '',
        CodigoArticulo,
        Partida,
        CodigoTalla,
        CodigoColor,
        IdPreparacion,
        PickingId,
        LineasPosicion,
        Unidades,
        UnidadMedida,
        UnidadesBase,
        UnidadMedidaBase,
        0, // CodigoAgrupacion, // NO AGRUPAREM MAI A L'ACUMULADO PENDIENTE
        dFechaCaduca,
        sMsg
      );

      if bErr then
        gaLogFile.Write ( 'After SGA_Reservar_stock_pedido: ERROR (intent ' + inttostr(iIntents) + ')', sIDCall  )
      else
        gaLogFile.Write ( 'After SGA_Reservar_stock_pedido: OK', sIDCall );

      if bErr then begin
        Inc(iIntents);
        Sleep(1000);
      end else begin
        iIntents := 999;
      end;

    end;

  end;

  if not bErr then
  begin

    bErr := FS_SGA_Repartir_Preparacion (
      Conn,
      CodigoEmpresa.EmpresaOrigen,
      YY,
      CodigoArticulo,
      PartidaPedido, // Partida,
      IdPreparacion,
      Unidades,
      UnidadMedida,
      UnidadesBase,
      UnidadMedidaBase,
      CodigoTalla,
      CodigoColor,
      CodigoAgrupacion,
      sMsg
    );

  end;

  if bErr then
    gaLogFile.Write ( 'ERROR: ' + sMsg, sIDCall );

  SGA_FS_ALMACEN_PrepareMov ( gaMov );
  gaMov.CodigoEmpresa          := CodigoEmpresa.Stocks;
  gaMov.EmpresaOrigen          := CodigoEmpresa.EmpresaOrigen;
  gaMov.CodigoUsuario          := CodigoUsuario;
  gaMov.Ejercicio              := YY;
  gaMov.Periodo                := MonthOf(Date());
  gaMov.Fecha                  := Date();
  gaMov.FechaHora              := Now();
  gaMov.CodigoAlmacen          := aUbicacion.CodigoAlmacen;
  gaMov.CodigoUbicacion        := CodigoUbicacion;
  gaMov.CodigoArticulo         := CodigoArticulo;
  gaMov.Partida                := Partida;
  gaMov.Partida2               := PartidaPedido;
  gaMov.CodigoTalla            := CodigoTalla;
  gaMov.CodigoColor            := CodigoColor;
  gaMov.TipoMovimiento         := 2;
  gaMov.OrigenMovimiento       := TipoSalida;
  gaMov.Unidades               := Unidades;
  gaMov.UnidadMedida           := AnsiUpperCase(UnidadMedida);
  gaMov.UnidadesBase           := UnidadesBase;
  gaMov.UnidadMedidaBase       := AnsiUpperCase(UnidadMedidaBase);
  gaMov.FactorConversion       := FactorConversion;
  gaMov.FechaCaduca            := dFechaCaduca;
  gaMov.IdProcesoIME           := sNewGuid;
  gaMov.Comentario             := 'SGAMobile: ' + DescripcionSalida;
  gaMov.PreparacionId          := IdPreparacion;
  gaMov.MovOrigen              := sNewMovOrigen;
  gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );

  gaMov.Precio :=
    ARTICULO_ConsultarPrecioStock (
      Conn,
      CodigoEmpresa,
      gaMov.CodigoArticulo,
      gaMov.Partida,
      gaMov.CodigoColor,
      gaMov.CodigoTalla,
      gaMov.CodigoAlmacen,
      gaMov.GrupoTalla
    );

  if aUbicacion.CodigoAlmacen<>aUbicacionExpedicion.CodigoAlmacen then begin
    gaMov.CodigoAlmacenDestino   := aUbicacionExpedicion.CodigoAlmacen;
    gaMov.CodigoUbicacionDestino := aUbicacionExpedicion.CodigoUbicacion;
    gaMov.MovTraspaso            := SQL_Execute ( Conn, 'SELECT NEWID()' );
  end;

  if not bErr then try
    gaLogFile.Write ( 'SGA_FS_ALMACEN_MovimientoStock salida', sIDCall );
    bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if aUbicacion.CodigoAlmacen<>aUbicacionExpedicion.CodigoAlmacen then begin
    gaLogFile.Write ( 'SGA_FS_ALMACEN_MovimientoStock traspaso', sIDCall  );
    gaMov.CodigoAlmacenDestino   := aUbicacion.CodigoAlmacen;
    gaMov.CodigoUbicacionDestino := aUbicacion.CodigoUbicacion;
  end;

  gaMov.FechaHora              := Now();
  gaMov.CodigoAlmacen          := aUbicacionExpedicion.CodigoAlmacen;
  gaMov.CodigoUbicacion        := CodigoUbicacionExpedicion;
  gaMov.CodigoArticulo         := CodigoArticulo;
  gaMov.TipoMovimiento         := 1;
  gaMov.OrigenMovimiento       := TipoEntrada;
  gaMov.Comentario             := 'SGAMobile: ' + DescripcionEntrada;
  gaMov.MovPosicion            := SQL_Execute ( Conn, 'SELECT NEWID()' );

  gaMov.Precio :=
    ARTICULO_ConsultarPrecioStock (
      Conn,
      CodigoEmpresa,
      gaMov.CodigoArticulo,
      gaMov.Partida,
      gaMov.CodigoColor,
      gaMov.CodigoTalla,
      gaMov.CodigoAlmacen,
      gaMov.GrupoTalla,
      gaMov.CodigoAlmacenDestino
    );

  if not bErr then try
    gaLogFile.Write ( 'SGA_FS_ALMACEN_MovimientoStock entrada', sIDCall  );
    bErr := not SGA_FS_ALMACEN_MovimientoStock ( Conn, CodigoEmpresa, gaMov, sMsg, sIDCall );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  // Fem els moviments a Sage si els magatzems són diferents
  if (not bErr) and (aUbicacion.CodigoAlmacen <> aUbicacionExpedicion.CodigoAlmacen) then begin

    gaLogFile.Write ( 'Movimiento de traspaso en Sage, IdProcesoIME = ' + gaMov.IdProcesoIME, sIDCall  );

    // Inserir línia a TmpIME_MovimientoStock
    sSQL := 'INSERT INTO TmpIME_MovimientoStock ( CodigoEmpresa, EmpresaOrigen, Ejercicio, Periodo, Fecha, FechaRegistro, Serie, '+
            '  CodigoArticulo, CodigoAlmacen, AlmacenContrapartida, Partida, Partida2_, TipoMovimiento, Unidades, ' +
            '  UnidadMedida1_, Unidades2_, UnidadMedida2_, FactorConversion_, Comentario, Ubicacion, ' +
            '  idProcesoIME, MovOrigen, Precio, Importe, FechaCaduca, OrigenMovimiento, MovPosicion ) '+
            'VALUES (' +
            IntToStr(gaMov.CodigoEmpresa) + ', ' +
            IntToStr(gaMov.EmpresaOrigen) + ', ' +
            IntToStr(gaMov.Ejercicio) + ', ' +
            IntToStr(gaMov.Periodo) + ', ' +
            SQL_DateTimeToStr(gaMov.Fecha) + ', ' +
            SQL_DateTimeToStr(gaMov.FechaHora) + ', ' +
            '''' + SQL_Str(gaMov.Serie) + ''', ' +
            '''' + SQL_Str(gaMov.CodigoArticulo) + ''', ' +
            '''' + SQL_Str(gaMov.CodigoAlmacenDestino) + ''', ' +
            '''' + SQL_Str(gaMov.CodigoAlmacen) + ''', ' +
            '''' + SQL_Str(gaMov.Partida) + ''', ' +
            '''' + SQL_Str(gaMov.Partida) + ''', ' +
            '2, ' +
            SQL_FloatToStr(gaMov.Unidades) + ', ' +
            '''' + SQL_Str(gaMov.UnidadMedida) + ''', ' +
            SQL_FloatToStr(gaMov.UnidadesBase) + ', ' +
            '''' + SQL_Str(gaMov.UnidadMedidaBase) + ''', ' +
            SQL_FloatToStr(gaMov.FactorConversion) + ', ' +
            '''' + SQL_Str(gaMov.Comentario) + ''', ' +
            ''''', ' +
            '''' + SQL_GUID_ToStr(gaMov.IdProcesoIME) + ''',' +
            '''' + SQL_GUID_ToStr(gaMov.MovOrigen) + ''', ' +
            SQL_FloatToStr(gaMov.Precio) + ', ' +
            SQL_FloatToStr(gaMov.Precio * gaMov.Unidades) + ', ' +
            SQL_DateToStr(gaMov.FechaCaduca) + ', ' +
            '''T'', ' +
            '''' + SQL_GUID_ToStr(gaMov.MovPosicion) + ''' )';

    if not bErr then try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on e: exception do begin
        bErr := bErr or true;
        sMsg := e.Message;
      end;
    end;

    sOperparams := '{"IdProcesoIME":"' + SQL_GUID_ToStr(gaMov.IdProcesoIME) + '","MantenerDatos":"1","MantenerErrores":"1","Módulos":"4","CodigoEmpresa":' + IntToStr(CodigoEmpresa.Stocks) + '}';
    sSQL := 'INSERT INTO ' +
            '  FS_Operations ( oper_CodigoEmpresa, oper_name, oper_product_code, oper_mac_address, oper_ip_address, ' +
            '  oper_datetime, oper_status, oper_params ) ' +
            'VALUES ( ' +
            IntToStr(CodigoEmpresa.Stocks) + ', ' +
            '''MOVIMIENTOSTOCK'', ' +
            '''E4E8'',' +
            '''' + SQL_Str(NETWORK_LocalMAC()) + ''', ' +
            '''' + SQL_Str(GetLocalIp()) + ''', ' +
            SQL_DateTimeToStr(Now()) + ', ' +
            '0, ' +
            '''' + SQL_Str(sOperparams) + ''' )';
    //gaLogFile.Write(sSQL, CONST_LOGID_BBDD, LOG_LEVEL_INFO );

    if not bErr then try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on e: exception do begin
        bErr := true;
        sMsg := e.Message;
      end;
    end;

  end;

  if dFechaCaduca=0 then
  begin
    sFechaCaduca := 'NULL';
  end else begin
    sFechaCaduca := SQL_DateToStr(dFechaCaduca);
  end;

  // GUARDEM EL DETALL DEL MOVIMENT A LA TAULA DE DETALL
  if (Unidades>0) or (UnidadesBase>0) then
  begin

    sSQL :=
      'SELECT AutoId ' +
      'FROM FS_SGA_Picking_Pedido_Lineas_Detalle WITH (NOLOCK) ' +
      'WHERE ' +
      '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
      '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
      '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
      '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
      '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
      '  AND LineaPedidoAsignada = ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ' +
      '  AND (Unidades > 0 OR UnidadesBase > 0) ' +
      '  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion) + ' ';

    iAutoID := SQL_Execute ( Conn, sSQL );

    if iAutoID=0 then
    begin

      sSQL :=
        'INSERT INTO FS_SGA_Picking_Pedido_Lineas_Detalle ( ' +
        '  PreparacionId, PickingId, Ejercicio, CodigoArticulo, Partida, UnidadMedida, FechaCaduca, CajaId, Unidades, UnidadesBase, ' +
        '  CodigoAgrupacion, UnidadesAgrupacion, LineaPedidoAsignada, CodigoTalla01_, CodigoColor_ ) ' +
        'VALUES ( ' +
        IntToStr(IdPreparacion) + ', ' +
        IntToStr(PickingId) + ', ' +
        IntToStr(Ejercicio) + ', ' +
        '''' + SQL_Str(CodigoArticulo) + ''', ' +
        '''' + SQL_Str(Partida) + ''', ' +
        '''' + SQL_Str(UnidadMedida) + ''', ' +
        sFechaCaduca + ', ' +
        IntToStr(CajaActual) + ', ' +
        SQL_FloatToStr(Unidades) + ', ' +
        SQL_FloatToStr(UnidadesBase) + ', ' +
        IntToStr(CodigoAgrupacion) + ', ' +
        SQL_FloatToStr(fUnidadesAgrupacion) + ', ' +
        '''' + SQL_GUID_ToStr(LineasPosicion) + ''', ' +
        '''' + SQL_Str(CodigoTalla) + ''', ' +
        '''' + SQL_Str(CodigoColor) + ''' ' +
        ')';

      try
        SQL_Execute_NoRes ( Conn, sSQL );
      except
        on E:Exception do
        begin
          gaLogFile.Write_DBException(E,sSQL,'Error al guardar del detalle de caja/palet', CONST_LOGID_BBDD);
        end;
      end;

      sSQL :=
        'SELECT TOP 1 ' +
        '  AutoId ' +
        'FROM FS_SGA_Picking_Pedido_Lineas_Detalle WITH (NOLOCK) ' +
        'WHERE ' +
        '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
        '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
        '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
        '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
        '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
        '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
        '  AND LineaPedidoAsignada = ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ' +
        '  AND (Unidades > 0 OR UnidadesBase > 0) ' +
        '  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion) + ' ';

      if sModoPackingList='AUTOMÁTICO' then
      begin
        // MODE AUTOMÀTIC
        if MatriculaActual<>'' then
        begin
          sSQL := sSQL +
            '  AND CajaId = ' + IntToStr(CajaActual) + ' ' +
            '  AND Matricula = ''' + SQL_Str(MatriculaActual) + ''' ';
        end else begin
          sSQL := sSQL +
            '  AND CajaId = ' + IntToStr(CajaActual) + ' ' +
            '  AND PaletId = ' + IntToStr(PaletActual) + ' ';
        end;
      end;

      sSQL := sSQL +
        'ORDER BY ' +
        '  AutoId DESC';

      iAutoID := SQL_Execute ( Conn, sSQL );

    end else begin

      sSQL :=
        'UPDATE FS_SGA_Picking_Pedido_Lineas_Detalle ' +
        '  SET ' +
        '    Unidades = Unidades + ' + SQL_FloatToStr(Unidades) + ', ' +
        '    UnidadesBase = UnidadesBase + ' + SQL_FloatToStr(UnidadesBase) + ' ' +
        'WHERE ' +
        '  AutoID = ' + IntToStr(iAutoId);

      try
        SQL_Execute_NoRes ( Conn, sSQL );
      except
        on E:Exception do
        begin
          gaLogFile.Write_DBException(E,sSQL,'Error al guardar del detalle de caja/palet', CONST_LOGID_BBDD);
        end;
      end;

    end;

  end else begin

    // RESTEM UNITATS AL DETALL
    fQtat := abs(Unidades);
    fQtatBase := abs(UnidadesBase);
    bFinal := FALSE;
    while not bFinal do
    begin

      sSQL := 'SELECT TOP 1 ' +
              '  AutoId, Unidades, UnidadesBase ' +
              'FROM FS_SGA_Picking_Pedido_Lineas_Detalle WITH (NOLOCK) ' +
              'WHERE ' +
              '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
              '  AND CodigoArticulo = ''' + SQL_Str(CodigoArticulo) + ''' ' +
              '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
              '  AND Partida = ''' + SQL_Str(Partida) + ''' ' +
              '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
              '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
              '  AND LineaPedidoAsignada = ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ' +
              '  AND (Unidades > 0 OR UnidadesBase > 0) ' +
              '  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion) + ' ';

      if sModoPackingList='AUTOMÁTICO' then
      begin
        // MODE AUTOMÀTIC
        if MatriculaActual<>'' then
        begin
          sSQL := sSQL +
            '  AND CajaId = ' + IntToStr(CajaActual) + ' ' +
            '  AND Matricula = ''' + SQL_Str(MatriculaActual) + ''' ';
        end else begin
          sSQL := sSQL +
            '  AND CajaId = ' + IntToStr(CajaActual) + ' ' +
            '  AND PaletId = ' + IntToStr(PaletActual) + ' ';
        end;
      end;

      sSQL := sSQL +
        'ORDER BY ' +
        '  AutoId DESC';

      Q := SQL_PrepareQuery ( Conn, sSQL );
      Q.Open;

      fQtatDetalle     := 0;
      fQtatDetalleBase := 0;

      if not Q.EOF then
      begin
        iAutoID          := Q.FieldByName('AutoId').AsInteger;
        fQtatDetalle     := Q.FieldByName('Unidades').AsFloat;
        fQtatDetalleBase := Q.FieldByName('UnidadesBase').AsFloat;
      end;

      Q.Close;
      FreeAndNil(Q);

      bFinal := (fQtatDetalle=0) and (fQtatDetalleBase=0);

      if not bFinal then
      begin

        if fQtatDetalle>fQtat then
        begin
          fQtatARestar     := fQtat;
          fQtatARestarBase := fQtatBase;
        end else begin
          fQtatARestar     := fQtatDetalle;
          fQtatARestarBase := fQtatDetalleBase;
        end;

        sSQL := 'UPDATE ' +
                '  FS_SGA_Picking_Pedido_Lineas_Detalle ' +
                'SET ' +
                '  Unidades = Unidades - ' + SQL_FloatToStr(fQtatARestar) + ', ' +
                '  UnidadesBase = UnidadesBase - ' + SQL_FloatToStr(fQtatARestarBase) + ' ' +
                'WHERE ' +
                '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
                '  AND AutoId = ' + IntToStr(iAutoID);
        SQL_Execute_NoRes ( Conn, sSQL );

        fQtat     := fQtat - fQtatARestar;
        fQtatBase := fQtatBase - fQtatARestarBase;
        bFinal := (fQtat<=0)

      end;

    end;

  end;

  // GUARDAMOS EL PALET Y LA CAJA
  sSQL :=
    'UPDATE FS_SGA_Picking_Preparaciones ' +
    'SET ' +
    '  PaletActual = ' + IntToStr(PaletActual) + ', ' +
    '  CajaActual = ' + IntToStr(CajaActual) + ', ' +
    '  MatriculaActual = ''' + SQL_Str(MatriculaActual) + ''' ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion);
  try
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do
    begin
      gaLogFile.Write_DBException(E,sSQL,'No se ha podido actualizar el nº de palet y caja actuales de la preparación', CONST_LOGID_BBDD );
    end;
  end;

  sSQL := 'UPDATE FS_SGA_Picking_Pedido_Lineas ' +
          'SET ' +
          '  UdRetiradas = UdRetiradas + ' + SQL_FloatToStr(Unidades) + ', ' +
          '  UdRetiradasBase = UdRetiradasBase + ' + SQL_FloatToStr(UnidadesBase) + ' ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
          '  AND CodigoArticulo=''' + SQL_Str(CodigoArticulo) + ''' ' +
          '  AND Partida=''' + SQL_Str(PartidaPedido) + ''' ' +
          '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ' +
          '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
          '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
          '  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacionPedido) + ' ';
  if (LineasPosicion<>'') and (LineasPosicion<>'00000000-0000-0000-0000-000000000000') then
  begin
    sSQL := sSQL + 'AND LineasPosicion = ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ';
  end;

  if not bErr then try
    gaLogFile.Write ( 'Actualizar unidades retiradas', sIDCall  );
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  // ACTUALITZEM LES QUANTITATS A LA RUTA
  sSQL :=
    'UPDATE FS_SGA_PreparacionOrdenada ' +
    'SET ' +
    '  UdRetiradas = UdRetiradas + ' + SQL_FloatToStr(Unidades) + ', ' +
    '  UdRetiradasBase = UdRetiradasBase + ' + SQL_FloatToStr(UnidadesBase) + ' ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND CodigoArticulo=''' + SQL_Str(CodigoArticulo) + ''' ' +
    '  AND Partida=''' + SQL_Str(PartidaPedido) + ''' ' +
    '  AND CodigoTalla01_ = ''' + SQL_Str(CodigoTalla) + ''' ' +
    '  AND CodigoColor_ = ''' + SQL_Str(CodigoColor) + ''' ' +
    '  AND UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' ';
    //'  AND CodigoAgrupacion = ' + IntToStr(CodigoAgrupacionPedido)
  if (LineasPosicion<>'') and (LineasPosicion<>'00000000-0000-0000-0000-000000000000') then
  begin
    sSQL := sSQL + 'AND LineasPosicion = ''' + SQL_GUID_ToStr(LineasPosicion) + ''' ';
  end;
  SQL_Execute_NoRes ( Conn, sSQL );

  if (not bErr) and (bRecalcularRuta) then begin

    gaLogFile.Write ( 'Recalculamos ruta', sIDCall );

    sSQL := 'SELECT ' +
            '  SUM(UdNecesarias) AS Necesarias, MIN(UdRetiradas) AS Retiradas ' +
            'FROM FS_SGA_Picking_Pedido_Lineas WITH (NOLOCK) ' +
            'WHERE ' +
            '  PreparacionId = ' + IntToStr(IdPreparacion) + ' AND ' +
            '  CodigoArticulo=''' + SQL_Str(CodigoArticulo) + ''' AND ' +
            '  Partida=''' + SQL_Str(PartidaPedido) + ''' AND ' +
            '  UnidadMedida = ''' + SQL_Str(UnidadMedida) + ''' AND ' +
            '  CodigoAgrupacion = ' + IntToStr(CodigoAgrupacion);
    Q := SQL_PrepareQuery ( Conn, sSQL );

    if not bErr then try
      Q.Open;
    except
      on E:Exception do begin
        bErr := TRUE;
        sMsg := E.Message;
      end;
    end;

    if (not bErr) and (not Q.EOF) then begin
      iUnidadesNecesarias := Q.FieldByName('Necesarias').AsFloat;
      iUnidadesRetiradas := Q.FieldByName('Retiradas').AsFloat;
      gaLogFile.Write ( 'Unidades necesarias = ' + FloatToStr(iUnidadesNecesarias) + ', Unidades retiradas = ' + FloatToStr(iUnidadesRetiradas), sIDCall  );
    end else begin
      iUnidadesNecesarias := 0;
      iUnidadesRetiradas := 0;
    end;

    if iUnidadesNecesarias<=iUnidadesRetiradas then begin
      gaLogFile.Write ( 'Recalcular ruta = false', sIDCall  );
      bRecalcularRuta := FALSE;
    end;

    Q.Close;
    FreeAndNil(Q);

  end;

  if (not bErr) and (bRecalcularRuta) then try
    gaLogFile.Write ( 'Recalcular ruta', sIDCall  );
    bErr := not SGA_Check_PreparacionOrdenada (
      gsPath,
      Conn,
      CodigoEmpresa,
      CodigoUsuario,
      YY,
      IdPreparacion,
      aUbicacion.CodigoAlmacen,
      CodigoUbicacionExpedicion,
      sConsiderarReservas,
      sSoloReservas,
      sIgnorarPartidaSolicitada,
      sIgnorarUbicacionSolicitada,
      sMsg,
      TRUE,
      bIsBuilding
    );
    gaLogFile.Write ( 'Recalcular ruta OK', sIDCall  );
  except
    on E:Exception do begin
      sMsg := E.Message;
      bErr := TRUE;
    end;
  end;

  sSQL := 'DELETE FROM FS_SGA_Picking_Pedido_Lineas_Detalle ' +
          'WHERE ' +
          '  PreparacionId = ' + IntToStr(IdPreparacion) + ' AND ' +
          '  Unidades=0 and UnidadesBase=0';
  if not bErr then try
    gaLogFile.Write ( 'Purgar líneas completadas', sIDCall  );
    SQL_Execute_NoRes ( Conn, sSQL );
  except
    on E:Exception do begin
      bErr := TRUE;
      sMsg := E.Message;
    end;
  end;

  if bErr then begin
    gaLogFile.Write ( 'ERROR: ' + sMsg, sIDCall  );
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + JSON_Str(sMsg) + '","Data":[]}';
    Exit;
  end;

  {$ENDREGION}

  // Postprocesa UPDATE
  if SQL_Procedure_Exists ( Conn, 'FS_SGA_PROC_UpdateCantidadPreparacion_AFTER', sPROCCustom) then
  begin

    sSQL := 'EXEC dbo.[' + sPROCCustom + '] ' +
            IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
            IntToStr(IdPreparacion);
    try
      SQL_Execute_NoRes ( Conn, sSQL );
    except
      on E:Exception do
      begin
        gaLogFile.Write_DBException(E,sSQL,'Error al preprocesar la cantidad de preparación', CONST_LOGID_BBDD );
      end;
    end;
  end;

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;
  LP.MovOrigen := sNewMovOrigen;
 
  if gaMov.UnidadesBase<0 then
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UNPREPARE-PROD', 'Quitar artículo (' + gaMov.CodigoArticulo + ') de la zona de expedición', @LP )
  else
    LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'PREPARE-PROD', 'Mover artículo (' + gaMov.CodigoArticulo + ') a la zona de expedición', @LP );

  Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[';

  Result := Result +
    '{' +
    '"AutoID":' + IntToStr(iAutoID) +
    '}';

  Result := Result +
    ']}';

  (*
  Request.QueryFields.AddPair('CodigoAlmacen', aUbicacion.CodigoAlmacen );
  contentfields.AddPair('CodigoAlmacen', aUbicacion.CodigoAlmacen );
  Request.QueryFields.AddPair('Partida', Partida );
  contentfields.AddPair('Partida', Partida );
  WebModule1preparacionUbicacionesAction ( Sender, Request, Response, Handled );
  *)

end;


procedure WebModule1freeLicenseAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; Port: Integer; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  MAC: String;
  Username: String;
  IP: String;
  license_code: AnsiString;
  grace_period: integer;
  Res: Boolean;
  sParams2: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  if contentfields.values['data']<>'' then
  begin
    try
      sParams2 := LICENSE_TwoFish_DEC ( contentfields.values['data'] );
      REQUEST_Split ( sParams2, contentfields );
    except
    end;
  end;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  MAC           := contentfields.Values['UUID'];
  Username      := contentfields.Values['Username'];
  IP            := sRemoteAddr;

  Res := LICENSE_Free ( Conn, 'PDA', MAC, IP, gsCustomerCode, CONST_SGA );
  Result := '{"Result":"OK","Message":"","Data":[]}';


  {$ENDREGION}

end;


procedure WebModule1encodeUrlAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; Port: Integer; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  sSQL: String;
  Q: TADOQuery;
  Res: Integer;
  encoded: string;
{$ENDREGION}

begin

  {$REGION 'Recuperació de paràmetres'}

  encoded := LICENSE_TwoFish_ENC ( sParams );

  Result :=
    '{"Result":"OK","Message":"","Data":[' +
    '{"encoded":"' + JSON_Str(encoded) + '"}' +
    ']}';

  {$ENDREGION}

end;


procedure WebModule1checkLicenseAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; Port: Integer; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  MAC: String;
  Username: String;
  IP: String;
  license_code: AnsiString;
  grace_period: integer;
  Res: Integer;
  sParams2: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  if contentfields.values['data']<>'' then
  begin
    try
      sParams2 := LICENSE_TwoFish_DEC ( contentfields.values['data'] );
      REQUEST_Split ( sParams2, contentfields );
    except
    end;
  end;


  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  MAC           := contentfields.Values['UUID'];
  Username      := contentfields.Values['Username'];
  IP            := sRemoteAddr;

  Res := LICENSE_Check ( Conn, 'PDA', MAC, IP, Username, Port, gsCustomerCode, CONST_SGA, license_code, grace_period);

  Result := '{"Result":"OK","Message":"","Data":[]}';

  case Res of

    CONST_LICERR_INVALID_LICENSE:
    begin
      Result := '{"Result":"ERROR","Message":"Licencia no válida. Contacte con el administrador del sistema.","Data":[]}';
    end;

    CONST_LICERR_NOT_ENOUGHT_LICENSES:
    begin
      Result := '{"Result":"ERROR","Message":"No hay licencias suficientes disponibles. Contacte con el administrador del sistema.","Data":[]}';
    end;

    CONST_LICERR_EXPIRED_LICENSE:
    begin
      Result := '{"Result":"ERROR","Message":"Licencia expirada. Contacte con el administrador del sistema.","Data":[]}';
    end;

    CONST_LICENSE_DATABASE_ERROR:
    begin
      Result := '{"Result":"ERROR","Message":"Error de base de datos. Contacte con el administrador del sistema.","Data":[]}';
    end;

  end;

  {$ENDREGION}

end;


procedure WebModule1getMaxUsedPartidaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  IdPreparacion: Integer;
  IdExpedicion: Integer;
  PickingId: Integer;
  CajaId: Integer;
  Partida: String;
  fMaxUnidadesPartida: Double;
  fMaxUnidadesPartidaBase: Double;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  IdExpedicion := StrToIntDef(contentfields.values['IdExpedicion'],0);
  if IdExpedicion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de expedición no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  PickingId := StrToIntDef(contentfields.values['PickingId'],0);
  if PickingId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Identificador de línea no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  CajaId := StrToIntDef(contentfields.values['CajaId'],0);
  if CajaId=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Número de caja no especificado","Data":[]}';
    gaLogFile.Write ( Result, sIDCall  );
    Exit;
  end;

  Partida := contentfields.Values['Partida'];

  sSQL :=
    'SELECT ' +
    '  unidades, unidadesBase ' +
    'FROM FS_SGA_PACKINGLIST WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND IdentificadorExpedicion = ' + IntToStr(IdExpedicion) + ' ' +
    '  AND PickingId = ' + IntToStr(PickingId) + ' ' +
    '  AND CajaId = ' + IntToStr(CajaId) + ' ' +
    '  AND Partida = ''' + SQL_Str(Partida) + '''';
  Q := SQL_PrepareQuery ( Conn, sSQL );
  Q.Open;

  fMaxUnidadesPartida := 0;
  fMaxUnidadesPartidaBase := 0;

  if not Q.EOF then
  begin
    fMaxUnidadesPartida := Q.FieldByName('unidades').AsFloat;
    fMaxUnidadesPartidaBase := Q.FieldByName('unidadesBase').AsFloat;
  end;

  Q.Close;
  FreeAndNil(Q);

  Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[';

  Result := Result +
    '{"maxUsedPartida":' + SQL_FloatToStr(fMaxUnidadesPartida) + ',' +
    '"maxUsedPartidaBase":' + SQL_FloatToStr(fMaxUnidadesPartidaBase) + '}';

  Result := Result +
    ']}';

  {$ENDREGION}

end;


procedure WebModule1reconnectDBAction  ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoUsuario: Integer;
  contentfields: TStringList;
  MAC: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  MAC           := contentfields.Values['UUID'];

  try
    Conn.Close;
  except
    on E:Exception do
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Close: ' + JSON_Str(E.Message) + '","Data":[]}';
      gbFinalitzar := TRUE;
      Exit;
    end;
  end;

  try
    Conn.Open;
  except
    on E:Exception do
    begin
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Open: ' + JSON_Str(E.Message) + '","Data":[]}';
      gbFinalitzar := TRUE;
      Exit;
    end;
  end;

  Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"OK","Message":"","Data":[]}';

  {$ENDREGION}

end;

procedure WebModule1testPrinterAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  EmpresaOrigen: Integer;
  sSQL: String;
  Q: TADOQuery;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  i: Integer;
  IdPreparacion: Integer;
  IdExpedicion: Integer;
  NumCaja: Integer;
  Impresora: string;
  HPrinter: NativeUInt;
  Ret: NativeInt;
  bin: array[0..511,0..23] of char;
  pDevMode: PDeviceMode;
  Sep: string;
  DevCtrl: TMemo;
{$ENDREGION}

//-----------------------------------------------
  procedure MakeInt(S: string; key: Integer);
  begin
    S := UpperCase(S);
    Result := Result + (UpperCase(Format(' %36S = %d ',
      [s, GetDeviceCaps(Printer.Handle, Key)]))) + #13;
  end;
  //-----------------------------------------------
  function StringToBits(S: string): string;
  var
    H: string;
    i: Integer;
    //-----------------------------------------------
    function SubStr(C: Char): string;
    begin
      if c = '0' then SubStr := '0000';
      if c = '1' then SubStr := '0001';
      if c = '2' then SubStr := '0010';
      if c = '3' then SubStr := '0011';
      if c = '4' then SubStr := '0100';
      if c = '5' then SubStr := '0101';
      if c = '6' then SubStr := '0110';
      if c = '7' then SubStr := '0111';
      if c = '8' then SubStr := '1000';
      if c = '9' then SubStr := '1001';
      if c = 'A' then SubStr := '1010';
      if c = 'B' then SubStr := '1011';
      if c = 'C' then SubStr := '1100';
      if c = 'D' then SubStr := '1101';
      if c = 'E' then SubStr := '1110';
      if c = 'F' then SubStr := '1111';
    end;
    //-----------------------------------------------
  begin
    StringToBits := '';
    S := UpperCase(s);
    H := '';
    if Length(S) = 0 then Exit;
    if Length(S) = 1 then S := '0000' + S;
    if Length(S) = 2 then S := '000' + S;
    if Length(S) = 3 then S := '00' + S;
    if Length(S) = 4 then S := '0' + S;
    for i := 1 to Length(s) do
      H := H + ' ' + SubStr(S[i]);
    StringToBits := H;
  end;
  //-----------------------------------------------
  procedure MakeHex(S: string; key: Cardinal);
  var
    h: string;
  begin
    S := UpperCase(S);
    h := Format('%X', [GetDeviceCaps(Printer.Handle, Key)]);
    if Length(H) = 0 then Exit;
    if Length(H) = 1 then H := '0000' + H;
    if Length(H) = 2 then H := '000' + H;
    if Length(H) = 3 then H := '00' + H;
    if Length(H) = 4 then H := '0' + H;
    Result := Result + #13;
    Result := Result + sep;
    Result := Result + #13;
    Result := Result + Format('%37S = Flags(%S) Key(%S)',
      [s, h, StringToBits(H)]
      ) + #13;
    // (( GetDeviceCaps(Printer.Handle,Key),
  end;

  procedure MakeStr(S: string; index, key: Cardinal);
  var
    pDevMode: PDeviceMode;
    bin: array[0..511,0..23] of char;
    i: DWORD;
    Res: DWORD;
    found: Boolean;
    iNum: Integer;
  begin
     iNum := DeviceCapabilities ( PChar(Printer.Printers[index]), nil, key, PChar(@bin), nil );
     if (iNum>0) then
     begin
       for i := 0 to iNum-1 do
       begin
         if StrPas(bin[i])<>'' then
         begin
           if i=0 then
             Result := Result + ' ' + StrPas(bin[i]) + #13
           else
             Result := Result + Format(' %39S%S', [' ',StrPas(bin[i])]) + #13;
         end;
       end;
     end else begin
       Result := Result + #13;
     end;

  end;
  //----------------------------------------------------
  procedure MakeFlag(S: string; key, subKey: Cardinal);
  var
    i: Cardinal;
  begin
    S := UpperCase(S);
    i := GetDeviceCaps(Printer.Handle, Key);
    if i and SubKey <> 0 then
      Result := Result + Format(' %34S = Flag(%4S) Key(%6D,%S)',
        [s, 'ON ', SubKey, StringToBits(Format('%x', [SubKey]))]) + #13
    else
      Result := Result + Format(' %34S = Flag(%4S) Key(%6D,%S)',
        [s, 'OFF', SubKey, StringToBits(Format('%x', [SubKey]))]) + #13;
  end;
  //----------------------------------------------------
  function TechnoToStr(i: Integer): string;
  begin
    TechnoToStr := '#ERROR# is Unknwon';
    case i of
      DT_PLOTTER: TechnoToStr    := 'Vector Plotter' + #13;
      DT_RASDISPLAY: TechnoToStr := 'Raster Display' + #13;
      DT_RASPRINTER: TechnoToStr := 'Raster Printer' + #13;
      DT_RASCAMERA: TechnoToStr  := 'Raster Camera' + #13;
      DT_CHARSTREAM: TechnoToStr := 'Character Stream' + #13;
      DT_METAFILE: TechnoToStr   := 'Metafile' + #13;
      DT_DISPFILE: TechnoToStr   := 'Display file' + #13;
    end;
  end;

begin

  REQUEST_Split ( sParams, contentfields );

  Result := '';

  Impresora := contentfields.Values['Printer'];
  Impresora := TNetEncoding.URL.Decode(Impresora);
  if Printer.Printers.IndexOf(Impresora)<0 then
  begin
    Result := 'Impresora desconocida';
    Exit;
  end;

  Printer.PrinterIndex := Printer.Printers.IndexOf(Impresora);

  // Device Organisation
  try

    if not (GetMapMode(Printer.Handle) = MM_TEXT) then
      SetMapMode(Printer.Handle, MM_Text);
    Result := '';

    Sep := '______________________________________________________________________________________________' + #13;
    Result := Result + sep;
    Result := Result + #13;
    Result := Result + ' PRINTER : ' + Printer.Printers[Printer.PrinterIndex] + #13;
    Result := Result + sep;
    Result := Result + #13;

    Result := Result + sep;
    Result := Result + #13;
    Result := Result + (Format('%36S = %D', ['NUMBER Of COPIES', Printer.Copies])) + #13;
    if Printer.Orientation = poLandscape then
      Result := Result + (Format('%36S = LANDSCAPE', ['ORIENTATION'])) + #13;
    if Printer.Orientation = poPortrait then
      Result := Result + (Format('%36S = PORTRAIT', ['ORIENTATION'])) + #13;


    Result := Result + sep;
    Result := Result + #13;
    MakeInt('DRIVERVERSION', DRIVERVERSION);
    Result := Result + (Format(' %36S = %S', ['TECHNOLOGY',
      UpperCase(TechnoToStr(GetDeviceCaps(Printer.Handle, Technology)))])) + #13;
    Result := Result + sep;
    Result := Result + #13;
    Result := Result + Format(' %27S%S', [' ','BIN NAMES =']);

    MakeStr('Bin Names', Printer.PrinterIndex, DC_BINNAMES );
    Result := Result + sep;
    Result := Result + #13;

    MakeInt('WIDTH [mm]', HORZSIZE);
    MakeInt('HEIGHT [mm]', VERTSIZE);
    MakeInt('WIDTH [pix]', HORZRES);
    MakeInt('HEIGHT [pix]', VERTRES);
    Result := Result + sep;
    Result := Result + #13;
    MakeInt('Physical Width [pix]', PHYSICALWIDTH);
    MakeInt('Physical Height[pix]', PHYSICALHEIGHT);
    MakeInt('Physical Offset X [pix]', PHYSICALOFFSETX);
    MakeInt('Physical Offset Y [pix]', PHYSICALOFFSETY);
    MakeInt('SCALING FACTOR X', SCALINGFACTORX);
    MakeInt('SCALING FACTOR Y', SCALINGFACTORY);
    Result := Result + sep;
    Result := Result + #13;
    MakeInt('horizontal [DPI]', LOGPIXELSX);
    MakeInt('vertial [DPI]', LOGPIXELSY);
    MakeInt('BITS PER PIXEL', BITSPIXEL);
    MakeInt('COLOR PLANES', PLANES);
    Result := Result + sep;
    Result := Result + #13;
    MakeInt('NUMBER OF BRUSHES', NUMBRUSHES);
    MakeInt('NUMBER OF PENS', NUMPENS);
    MakeInt('NUMBER OF FONTS', NUMFONTS);
    MakeInt('NUMBER OF COLORS', NUMCOLORS);
    Result := Result + sep;
    Result := Result + #13;
    MakeInt('ASPECT Ratio X [DPI]', ASPECTX);
    MakeInt('ASPECT Ratio Y [DPI]', ASPECTY);
    MakeInt('ASPECT Ratio XY [DPI]', ASPECTXY);
    Result := Result + sep;
    Result := Result + #13;
    MakeInt('SIZE OF PALETTE', SIZEPALETTE);
    MakeInt('RESERVED TO SYSTEM PALETTE **', NUMRESERVED);
    MakeInt('ACTUAL RASTER RESOLUTION **', COLORRES);
    Result := Result + #13;
    Result := Result + (' **...only true if KEY RASTERCAPS(RC_PALETTE)= ON') + #13;
    MakeFlag('... KEY RASTERCAPS (RC_PALETTE)', RasterCaps, RC_PALETTE);
    Result := Result + #13;

    MakeHex('Clipping Capablities ', ClipCaps);
    Result := Result + sep;
    Result := Result + #13;
    MakeFlag('No Support ', ClipCaps, CP_NONE);
    MakeFlag('Support Rectangles', ClipCaps, CP_RECTANGLE);
    MakeFlag('Support PolyRegion 32 Bit', ClipCaps, CP_REGION);

    MakeHex('Raster Printing Flags ', RasterCaps);
    Result := Result + sep;
    Result := Result + #13;
    MakeFlag('Support Bitmap Transfer', RasterCaps, RC_BITBLT);
    MakeFlag('Support Banding', RasterCaps, RC_BANDING);
    MakeFlag('Support Scaling', RasterCaps, RC_SCALING);
    MakeFlag('Support Bitmaps > 64 kByte', RasterCaps, RC_BITMAP64);
    MakeFlag('Support features of Win 2.0', RasterCaps, RC_GDI20_OUTPUT);
    MakeFlag('Support Set~/GetDIBITS()', RasterCaps, RC_DI_BITMAP);
    MakeFlag('Support Palette Devices', RasterCaps, RC_PALETTE);
    MakeFlag('Support SetDIBitsToDevice()', RasterCaps, RC_DIBTODEV);
    MakeFlag('Support Floodfill', RasterCaps, RC_FLOODFILL);
    MakeFlag('Support StretchBlt()', RasterCaps, RC_STRETCHBLT);
    MakeFlag('Support StretchBID()', RasterCaps, RC_STRETCHDIB);
    MakeFlag('Support DIBS', RasterCaps, RC_DEVBITS);

    MakeHex('Curve Printion Flages', CurveCaps);
    Result := Result + sep;
    Result := Result + #13;
    MakeFlag('No Curve support', CurveCaps, CC_NONE);
    MakeFlag('Support Circles', CurveCaps, CC_Circles);
    MakeFlag('Support Pie', CurveCaps, CC_PIE);
    MakeFlag('Support Arces', CurveCaps, CC_CHORD);
    MakeFlag('Support Ellipses', CurveCaps, CC_ELLIPSEs);
    MakeFlag('Support WIDE FRAMES', CurveCaps, CC_WIDE);
    MakeFlag('Support STYLED FRAMES', CurveCaps, CC_STYLED);
    MakeFlag('Support WIDE&STYLED FRAMES', CurveCaps, CC_WIDESTYLED);
    MakeFlag('Support INTERIORS', CurveCaps, CC_INTERIORS);
    MakeFlag('Support ROUNDRECT', CurveCaps, CC_ROUNDRECT);

    MakeHex('Line & Polygon Printing Flags', LineCaps);
    Result := Result + sep;
    Result := Result + #13;
    MakeFlag('No Line Support', LineCaps, LC_NONE);
    MakeFlag('Support Polylines', LineCaps, LC_PolyLine);
    MakeFlag('Support Marker', LineCaps, LC_Marker);
    MakeFlag('Support PolyMarker', LineCaps, LC_PolyMarker);
    MakeFlag('Support Wide Lines', LineCaps, LC_WIDE);
    MakeFlag('Support STYLED Lines', LineCaps, LC_STYLED);
    MakeFlag('Support WIDE&STYLED Lines', LineCaps, LC_WIDESTYLED);
    MakeFlag('Support Lines Interiors', LineCaps, LC_INTERIORS);

    MakeHex('Polygon (Areal) Printing Flags', POLYGONALCAPS);
    Result := Result + sep;
    Result := Result + #13;
    MakeFlag('No Polygon Support', PolygonalCaps, PC_NONE);
    MakeFlag('Filling Alternate Polygons', PolygonalCaps, PC_POLYGON);
    MakeFlag('Drawing Rectangles', PolygonalCaps, PC_RECTANGLE);
    MakeFlag('Filling Winding Polygons', PolygonalCaps, PC_WINDPOLYGON);
    MakeFlag('Drawing Trapezoid (??Flag)', PolygonalCaps, PC_Trapezoid);
    MakeFlag('Drawing a ScanLine', PolygonalCaps, PC_SCANLINE);
    MakeFlag('Drawing Wide Border', PolygonalCaps, PC_WIDE);
    MakeFlag('Drawing Styled Border', PolygonalCaps, PC_STYLED);
    MakeFlag('Drawing WIDE&STYLED Border', PolygonalCaps, PC_WIDESTYLED);
    MakeFlag('Drawing Interiors', PolygonalCaps, PC_INTERIORS);

    MakeHex('Text Printing Flags', TEXTCAPS);
    Result := Result + sep;
    Result := Result + #13;
    MakeFlag('Support Character Output Precision', TextCaps, TC_OP_CHARACTER);
    MakeFlag('Support Stroke Output Precision', TextCaps, TC_OP_STROKE);
    MakeFlag('Support Stroke Clip Precision', TextCaps, TC_CP_STROKE);
    MakeFlag('Support 90° Character Rotation', TextCaps, TC_CR_90);
    MakeFlag('Support any Character Rotaion', TextCaps, TC_CR_ANY);
    MakeFlag('Support Character Scaling in X&Y', TextCaps, TC_SF_X_YINDEP);
    MakeFlag('Support Character Scaling REAL', TextCaps, TC_SA_DOUBLE);
    MakeFlag('Support Character Scaling RATIONAL', TextCaps, TC_SA_INTEGER);
    MakeFlag('Support Character Scaling EXACT', TextCaps, TC_SA_CONTIN);
    MakeFlag('Support Character Weight REAL', TextCaps, TC_EA_DOUBLE);
    MakeFlag('Support Character Italic', TextCaps, TC_IA_ABLE);
    MakeFlag('Support Character Underline', TextCaps, TC_UA_ABLE);
    MakeFlag('Support Character Strikeout', TextCaps, TC_SO_ABLE);
    MakeFlag('Support Character as RASTER FONT', TextCaps, TC_RA_ABLE);
    MakeFlag('Support Character as VECTOR FONT', TextCaps, TC_VA_ABLE);
    MakeFlag('Reserved Flag ???', TextCaps, TC_Reserved);
    MakeFlag('DEVICE NOT USE a SCROLLBIT BLOCK ?', TextCaps, TC_SCROLLBLT);

    Result := '..THE RESULTS ARE:' + #13 + Result;
  except
    // MessageDlg('The Current Printer is not valid ! ',
    // mtError,[mbok],0);
    Printer.PrinterIndex := -1;
    Result := Result + (' ! The Printer is not valid !');
  end;

end;


procedure WebModule1updatePackagingMatriculaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  IdPreparacion: Integer;
  Matricula: String;
  contentfields: TStringList;
  iMaxCaja: Integer;
  IdPalet: Integer;
  PaletPackagingId: Integer;
  IdCaja: Integer;
  CajaPackagingId: Integer;
  UUID: string;
  Ejercicio: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario   := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID            := contentfields.values['UUID'];
  IdPreparacion   := StrToIntDef(contentfields.Values['IdPreparacion'], 0 );
  Matricula       := contentfields.Values['Matricula'];
  IdCaja          := StrToIntDef(contentfields.Values['CajaActual'],0);
  IdPalet         := StrToIntDef(contentfields.Values['PaletActual'],0);
  CajaPackagingId := StrToIntDef(contentfields.Values['CajaPackagingId'],0);
  iMaxCaja        := 0;

  sSQL := 'SELECT Ejercicio FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  // MIREM SI EXISTEIX LA MATRÍCULA DEL PALET AL PACKING LIST
  if Matricula<>'' then
  begin

    sSQL :=
      'SELECT IdPalet ' +
      'FROM FS_SGA_PackingList_PackagingPalet WITH (NOLOCK) ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND Matricula = ''' + SQL_Str(Matricula) + '''';
    IdPalet := SQL_Execute ( Conn, sSQL );

  end;

  // ESBORREM TOTS ELS PALETS QUE ENCARA NO S'HAN FET SERVIR
  sSQL :=
    'DELETE FROM FS_SGA_PackingList_PackagingPalet ' +
    'WHERE ' +
    '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND Matricula NOT IN ( ' +
    '    SELECT Matricula ' +
    '    FROM FS_SGA_PackingList WITH (NOLOCK) ' +
    '    WHERE PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  )';
  SQL_Execute_NoRes ( Conn, sSQL );

  // ESBORREM TOTES LES CAIXES QUE ENCARA NO S'HAN FET SERVIR
  sSQL :=
    'DELETE FROM FS_SGA_PackingList_PackagingCaja ' +
    'WHERE ' +
    '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND Matricula NOT IN ( ' +
    '    SELECT Matricula ' +
    '    FROM FS_SGA_PackingList WITH (NOLOCK) ' +
    '    WHERE PreparacionId = ' + IntToStr(IdPreparacion) + ' ' +
    '  )';
  SQL_Execute_NoRes ( Conn, sSQL );

  sSQL :=
    'DELETE FROM FS_SGA_PackingList_PackagingPalet ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND Matricula = ''' + SQL_Str(Matricula) + '''';
  SQL_Execute_NoRes ( Conn, sSQL );

  if (IdPalet=0) and (Matricula<>'') then
  begin

    sSQL :=
      'SELECT MAX(IdPalet) ' +
      'FROM FS_SGA_PackingList_PackagingPalet WITH (NOLOCK) ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND IdPreparacion = ' + IntToStr(IdPreparacion);
    IdPalet := SQL_Execute ( Conn, sSQL ) + 1;

  end;

  {$ENDREGION}

  {$REGION 'Actualització de dades'}

  // BUSQUEM L'ÚLTIMA CAIXA DE LA NOVA MATRÍCULA
  sSQL :=
    'SELECT MAX(IdCaja) ' +
    'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND Matricula = ''' + SQL_Str(Matricula) + ''' ';
  iMaxCaja := SQL_Execute ( Conn, sSQL );

  if iMaxCaja=0 then
  begin

    iMaxCaja := 1;

  end else begin

    // RECUPEREM EL PACKAGING DE L'ÚLTIMA CAIXA DE LA MATRÍCULA
    sSQL :=
      'SELECT IdPackaging ' +
      'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
      '  AND IdPalet = ' + IntToStr(IdPalet) + ' ' +
      '  AND Matricula = ''' + SQL_Str(Matricula) + ''' ' +
      '  AND IdCaja = ' + IntToStr(iMaxCaja);
    CajaPackagingId := SQL_Execute ( Conn, sSQL );

  end;

  sSQL :=
    'SELECT PackagingId ' +
    'FROM FS_SGA_Palet WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '  AND Matricula = ''' + SQL_Str(Matricula) + '''';
  PaletPackagingId := SQL_Execute ( Conn, sSQL );

  sSQL :=
    'INSERT INTO FS_SGA_PackingList_PackagingPalet ( CodigoEmpresa, IdPreparacion, Ejercicio, IdPalet, Matricula, IdPackaging )' +
    'VALUES ( ' +
    IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
    IntToStr(IdPreparacion) + ', ' +
    IntToStr(Ejercicio) + ', ' +
    IntToStr(IdPalet) + ', ' +
    '''' + SQL_Str(Matricula) + ''', ' +
    IntToStr(PaletPackagingId) + ' ' +
    ')';
  SQL_Execute_NoRes ( Conn, sSQL );

  sSQL :=
    'DELETE FROM FS_SGA_PackingList_PackagingCaja ' +
    'WHERE ' +
    '  IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND IdPalet = ' + IntToStr(IdPalet) + ' ' +
    '  AND Matricula = ''' + SQL_Str(Matricula) + ''' ' +
    '  AND IdCaja = ' + IntToStr(iMaxCaja);
  SQL_Execute_NoRes ( Conn, sSQL );

  sSQL :=
    'INSERT INTO FS_SGA_PackingList_PackagingCaja ( CodigoEmpresa, IdPreparacion, Ejercicio, IdPalet, Matricula, IdCaja, IdPackaging ) ' +
    'VALUES ( ' +
    IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
    IntToStr(IdPreparacion) + ', ' +
    IntToStr(Ejercicio) + ', ' +
    IntToStr(IdPalet) + ', ' +
    '''' + SQL_Str(Matricula) + ''', ' +
    IntToStr(iMaxCaja) + ', ' +
    IntToStr(CajaPackagingId) + ' ' +
    ')';
  SQL_Execute_NoRes ( Conn, sSQL );

  sSQL :=
    'UPDATE FS_SGA_Picking_Preparaciones ' +
    'SET ' +
    '  MatriculaActual = ''' + SQL_Str(Matricula) + ''', ' +
    '  PaletActual = ' + IntToStr(IdPalet) + ', ' +
    '  CajaActual = ' + IntToStr(iMaxCaja) + ' ' +
    'WHERE ' +
    '  PreparacionId = ' + IntToStr(IdPreparacion);
  SQL_Execute_NoRes ( Conn, sSQL );

  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[' +
    '{' +
    '"actualCaja":' + IntToStr(iMaxCaja) + ',' +
    '"actualPalet":' + IntToStr(iMaxCaja) +
    '}' +
  ']}';

  LP := LOG_Clear();
  LP.Matricula := Matricula;
  LP.IdPreparacion := IdPreparacion;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-PACK-PALLET', 'Actualizar packaging de la matrícula a ' + IntToStr(PaletPackagingId), @LP );

  {$ENDREGION}

end;


procedure WebModule1updatePackagingMatriculaCajaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  IdPreparacion: Integer;
  Matricula: String;
  contentfields: TStringList;
  iMaxCaja: Integer;
  IdPalet: Integer;
  IdCaja: Integer;
  IdPackaging: Integer;
  UUID: string;
  Ejercicio: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID          := contentfields.values['UUID'];
  IdPreparacion := StrToIntDef(contentfields.Values['IdPreparacion'], 0 );
  Matricula     := contentfields.Values['Matricula'];
  IdPalet       := StrToIntDef(contentfields.Values['PaletId'], 0 );
  IdCaja        := StrToIntDef(contentfields.Values['CajaId'], 0 );
  IdPackaging   := StrToIntDef(contentfields.Values['IdPackaging'], 0 );

  sSQL := 'SELECT Ejercicio FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  {$ENDREGION}

  {$REGION 'Actualització de dades'}

  sSQL :=
    'DELETE FROM FS_SGA_PackingList_PackagingCaja ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND Matricula = ''' + SQL_Str(Matricula) + ''' ' +
    '  AND IdPalet = ' + IntToStr(IdPalet) + ' ' +
    '  AND IdCaja = ' + IntToStr(abs(IdCaja));
  SQL_Execute_NoRes ( Conn, sSQL );

  sSQL :=
    'INSERT INTO FS_SGA_PackingList_PackagingCaja ( CodigoEmpresa, IdPreparacion, Ejercicio, IdPalet, Matricula, IdCaja, IdPackaging )' +
    'VALUES ( ' +
    IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
    IntToStr(IdPreparacion) + ', ' +
    IntToStr(Ejercicio) + ', ' +
    IntToStr(IdPalet) + ', ' +
    '''' + SQL_Str(Matricula) + ''', ' +
    IntToStr(abs(IdCaja)) + ', ' +
    IntToStr(IdPackaging) + ' ' +
    ')';
  SQL_Execute_NoRes ( Conn, sSQL );

  LP := LOG_Clear();
  LP.Matricula := Matricula;
  LP.IdPreparacion := IdPreparacion;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-PACK-CAJA', 'Actualizar packaging de la caja a ' + IntToStr(IdPackaging), @LP );


  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[' +
  ']}';

  {$ENDREGION}

end;



procedure WebModule1setBloqueoUbicacionAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  CodigoUbicacion: String;
  Bloqueada: Boolean;
  contentfields: TStringList;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario   := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID            := contentfields.Values['UUID'];
  CodigoUbicacion := contentfields.Values['CodigoUbicacion'];
  Bloqueada       := (AnsiLowerCase(contentfields.Values['Bloqueada'])='true');

  sSQL :=
    'UPDATE FS_SGA_ESTR_UBICA ' +
    'SET Bloqueada = ' + SQL_BooleanToStr(Bloqueada) + ' ' +
    'WHERE CodigoUbicacion = ''' + SQL_Str(CodigoUbicacion) + '''';
  SQL_Execute_NoRes ( Conn, sSQL );

  Result :=
    '{"Result":"OK","Error":"","TotalRecords":0,"NumPages":0,"NumRecords":0,"Data":[' +
    ']}';

end;



procedure WebModule1changePaletPackagingAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  Matricula: String;
  PackagingId: Integer;
  contentfields: TStringList;
  NovaMatricula: String;
  SSCCGenerado: string;
  OldDigito: Integer;
  NewDigito: Integer;
  YY: Integer;
  PrefijoEmpresaGS1: String;
  sErrMsg: string;
  UUID: string;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.Values['CodigoUsuario'], 0 );
  UUID          := contentfields.Values['UUID'];  
  Matricula     := contentfields.Values['Matricula'];
  PackagingId   := StrToIntDef(contentfields.Values['PackagingId'], 0 );
  
  sSQL :=
    'SELECT FSPD.Dt_DigitoMatricula ' +
    'FROM FS_SGA_PackagingDetalle FSPD WITH (NOLOCK) ' +
    'INNER JOIN FS_SGA_Palet FSP WITH (NOLOCK) ' +
    'ON ' +
    '  FSP.PackagingId = FSPD.Dt_Id ' +
    'WHERE ' +
    '  FSP.CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '  AND FSP.Matricula = ''' + SQL_Str(Matricula) + '''';
  OldDigito := SQL_Execute ( Conn, sSQL );

  sSQL :=
    'SELECT FSPD.Dt_DigitoMatricula ' +
    'FROM FS_SGA_PackagingDetalle FSPD WITH (NOLOCK) ' +
    'WHERE ' +
    '  FSPD.Dt_Id = ' + IntToStr(PackagingId);
  NewDigito := SQL_Execute ( Conn, sSQL );

  {$ENDREGION}

  {$REGION 'Actualitzar packaging de la matrícula'}

  sSQL :=
    'UPDATE FS_SGA_Palet ' +
    'SET ' +
    '  PackagingId = ' + IntToStr(PackagingId) + ' ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '  AND Matricula = ''' + SQL_Str(Matricula) + '''';
  SQL_Execute_NoRes ( Conn, sSQL );

  sSQL :=
    'UPDATE FS_SGA_PackingList_PackagingPalet ' +
    'SET ' +
    '  IdPackaging = ' + IntToStr(PackagingId) + ' ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
    '  AND Matricula = ''' + SQL_Str(Matricula) + '''';
  SQL_Execute_NoRes ( Conn, sSQL );

  // COM QUE CANVIA EL TIPUS DE PALET, HEM DE REGENERAR LA MATRÍCULA I ACTUALITZAR-HO A TOT ARREU
  // SI CANVIA EL DÍGIT AL GENERAR LA MATRÍCULA
  // DE MOMENT NO FEM RES
  (*
  if OldDigito<>NewDigito then
  begin

    YY := SGA_FECHA_AnoActivo ( Conn, CodigoEmpresa, Now() );

    sSQL :=
      'SELECT TOP 1 parametro_value ' +
      'FROM FS_SGA_Parametros WITH (NOLOCK) ' +
      'WHERE parametro_CodigoEmpresa IN ( 0, ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ) ' +
      'AND parametro_id = 114 ' +
      'ORDER BY parametro_CodigoEmpresa DESC';
    PrefijoEmpresaGS1 := SQL_Execute ( Conn, sSQL );

    SSCCGenerado := FS_SGA_GenerarMatricula (
      Conn,
      CodigoEmpresa,
      YY,
      PrefijoEmpresaGS1,
      NewDigito,
      sErrMsg
    );

    sSQL :=
      'UPDATE FS_SGA_Palet ' +
      'SET ' +
      '  Matricula = ''' + SSCCGenerado + ''' ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
      '  AND Matricula = ''' + SQL_Str(Matricula) + '''';
    SQL_Execute_NoRes ( Conn, sSQL );

    sSQL :=
      'UPDATE FS_SGA_MovimientosAlmacen ' +
      'SET ' +
      '  Matricula = ''' + SSCCGenerado + ''' ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.Stocks) + ' ' +
      '  AND Matricula = ''' + SQL_Str(Matricula) + '''';
    SQL_Execute_NoRes ( Conn, sSQL );

    sSQL :=
      'UPDATE FS_SGA_PackingList ' +
      'SET ' +
      '  Matricula = ''' + SSCCGenerado + ''' ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND Matricula = ''' + SQL_Str(Matricula) + '''';
    SQL_Execute_NoRes ( Conn, sSQL );

    sSQL :=
      'UPDATE FS_SGA_PackingList_PackagingPalet ' +
      'SET ' +
      '  Matricula = ''' + SSCCGenerado + ''' ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND Matricula = ''' + SQL_Str(Matricula) + '''';
    SQL_Execute_NoRes ( Conn, sSQL );

    sSQL :=
      'UPDATE FS_SGA_PackingList_PackagingCaja ' +
      'SET ' +
      '  Matricula = ''' + SSCCGenerado + ''' ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND Matricula = ''' + SQL_Str(Matricula) + '''';
    SQL_Execute_NoRes ( Conn, sSQL );

    sSQL :=
      'UPDATE FS_SGA_Devoluciones_Lineas_Detalle ' +
      'SET ' +
      '  Matricula = ''' + SSCCGenerado + ''' ' +
      'WHERE ' +
      '  Matricula = ''' + SQL_Str(Matricula) + '''';
    SQL_Execute_NoRes ( Conn, sSQL );

    sSQL :=
      'UPDATE FS_SGA_Devoluciones_Lineas_Detalle ' +
      'SET ' +
      '  MatriculaRechazos = ''' + SSCCGenerado + ''' ' +
      'WHERE ' +
      '  MatriculaRechazos = ''' + SQL_Str(Matricula) + '''';
    SQL_Execute_NoRes ( Conn, sSQL );

    sSQL :=
      'UPDATE FS_SGA_Picking_Preparaciones ' +
      'SET ' +
      '  MatriculaActual = ''' + SSCCGenerado + ''' ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND MatriculaActual = ''' + SQL_Str(Matricula) + '''';
    SQL_Execute_NoRes ( Conn, sSQL );

    sSQL :=
      'UPDATE FS_SGA_Recepciones_Lineas_Detalle ' +
      'SET ' +
      '  Matricula = ''' + SSCCGenerado + ''' ' +
      'WHERE ' +
      '  Matricula = ''' + SQL_Str(Matricula) + '''';
    SQL_Execute_NoRes ( Conn, sSQL );

    sSQL :=
      'UPDATE FS_SGA_Recepciones_Lineas_Detalle ' +
      'SET ' +
      '  MatriculaRechazos = ''' + SSCCGenerado + ''' ' +
      'WHERE ' +
      '  MatriculaRechazos  = ''' + SQL_Str(Matricula) + '''';
    SQL_Execute_NoRes ( Conn, sSQL );

    sSQL :=
      'UPDATE FS_SGA_TraceExpedicion ' +
      'SET ' +
      '  Matricula = ''' + SSCCGenerado + ''' ' +
      'WHERE ' +
      '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
      '  AND Matricula  = ''' + SQL_Str(Matricula) + '''';
    SQL_Execute_NoRes ( Conn, sSQL );

  end;
  *)

  LP := LOG_Clear();
  LP.Matricula := Matricula;
  
  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-PALLET-TYPE', 'Cambio de palet a tipo ' + IntToStr(PackagingId), @LP );
  
  Result :=
    '{"Result":"OK","Error":"","TotalRecords":0,"NumPages":0,"NumRecords":0,"Data":[' +
    ']}';

end;


procedure WebModule1updatePackagingPaletAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  IdPreparacion: Integer;
  PaletId: Integer;
  PackagingId: Integer;
  contentfields: TStringList;
  iMaxCaja: Integer;
  UUID: string;
  Ejercicio: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID          := contentfields.values['UUID'];
  IdPreparacion := StrToIntDef(contentfields.Values['IdPreparacion'], 0 );
  PaletId       := StrToIntDef(contentfields.Values['PaletId'], 0 );
  PackagingId   := StrToIntDef(contentfields.Values['PackagingId'], 0 );

  sSQL := 'SELECT Ejercicio FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  {
  sSQL :=
    'SELECT MAX(cajaId) ' +
    'FROM FS_SGA_PackingList WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND PreparacionId = ' + IntToStr(IdPreparacion);
  iMaxCaja := SQL_Execute ( Conn, sSQL );
  if iMaxCaja=0 then iMaxCaja := 1;
  }

  sSQL :=
    'SELECT MAX(IdCaja) ' +
    'FROM FS_SGA_PackingList_PackagingCaja WITH (NOLOCK) ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND IdPalet = ' + IntToStr(PaletId);
  iMaxCaja := SQL_Execute ( Conn, sSQL );
  if iMaxCaja=0 then iMaxCaja := 1;

  {$ENDREGION}

  {$REGION 'Actualització de dades'}

  sSQL :=
    'DELETE FROM FS_SGA_PackingList_PackagingPalet ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND IdPalet = ' + IntToStr(PaletId);
  SQL_Execute_NoRes ( Conn, sSQL );

  (*if PackagingId<0 then
  begin
    Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[' +
      '{"actualCaja":' + IntToStr(iMaxCaja) + '}]}';
    Exit;
  end;*)

  sSQL :=
    'INSERT INTO FS_SGA_PackingList_PackagingPalet ( CodigoEmpresa, IdPreparacion, Ejercicio, IdPalet, IdPackaging )' +
    'VALUES ( ' +
    IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
    IntToStr(IdPreparacion) + ', ' +
    IntToStr(Ejercicio) + ', ' +
    IntToStr(PaletId) + ', ' +
    IntToStr(PackagingId) + ' ' +
    ')';
  SQL_Execute_NoRes ( Conn, sSQL );

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-PACK-PALLET', 'Actualizar packaging del palet ' + IntToStr(PaletId) + ' a ' + IntToStr(PackagingId), @LP );

  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[' +
    '{"actualCaja":' + IntToStr(iMaxCaja) + '}]}';

  {$ENDREGION}

end;


procedure WebModule1updatePackagingCajaAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  IdPreparacion: Integer;
  PaletId: Integer;
  Matricula: String;
  CajaId: Integer;
  PackagingId: Integer;
  contentfields: TStringList;
  UUID: string;
  Ejercicio: Integer;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  // CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Almacenes' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  CodigoUsuario := StrToIntDef(contentfields.values['CodigoUsuario'],0);
  UUID          := contentfields.values['UUID'];
  IdPreparacion := StrToIntDef(contentfields.Values['IdPreparacion'], 0 );
  PaletId       := StrToIntDef(contentfields.Values['PaletId'], 0 );
  Matricula     := contentfields.Values['Matricula'];
  CajaId        := Abs(StrToIntDef(contentfields.Values['CajaId'], 0 ));
  PackagingId   := StrToIntDef(contentfields.Values['PackagingId'], 0 );

  sSQL := 'SELECT Ejercicio FROM FS_SGA_Picking_Preparaciones WITH (NOLOCK) WHERE PreparacionId = ' + IntToStr(IdPreparacion);
  Ejercicio := SQL_Execute ( Conn, sSQL );

  {$ENDREGION}

  {$REGION 'Actualització de dades'}

  sSQL :=
    'DELETE FROM FS_SGA_PackingList_PackagingCaja ' +
    'WHERE ' +
    '  CodigoEmpresa = ' + IntToStr(CodigoEmpresa.EmpresaOrigen) + ' ' +
    '  AND IdPreparacion = ' + IntToStr(IdPreparacion) + ' ' +
    '  AND IdPalet = ' + IntToStr(PaletId) + ' ' +
    '  AND Matricula = ''' + SQL_Str(Matricula) + ''' ' +
    '  AND IdCaja = ' + IntToStr(abs(CajaId));
  SQL_Execute_NoRes ( Conn, sSQL );

  (*if PackagingId<0 then
  begin
    Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[]}';
    Exit;
  end;*)

  sSQL :=
    'INSERT INTO FS_SGA_PackingList_PackagingCaja ( CodigoEmpresa, IdPreparacion, Ejercicio, IdPalet, Matricula, IdCaja, IdPackaging )' +
    'VALUES ( ' +
    IntToStr(CodigoEmpresa.EmpresaOrigen) + ', ' +
    IntToStr(IdPreparacion) + ', ' +
    IntToStr(Ejercicio) + ', ' +
    IntToStr(PaletId) + ', ' +
    '''' + SQL_Str(Matricula) + ''', ' +
    IntToStr(abs(CajaId)) + ', ' +
    IntToStr(PackagingId) + ' ' +
    ')';
  SQL_Execute_NoRes ( Conn, sSQL );

  LP := LOG_Clear();
  LP.IdPreparacion := IdPreparacion;

  LOG_Add ( Conn, CodigoUsuario, UUID, sRemoteAddr, 'UPDATE-PACK-CAJA', 'Actualizar packaging de la caja ' + IntToStr(CajaId) + ' a ' + IntToStr(PackagingId), @LP );

  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[]}';

  {$ENDREGION}

end;


procedure WebModule1listPackagingsPreparacionAction (
  Conn: TADOConnection;
  sParams, sRemoteAddr: String;
  var statusCode: Integer;
  var statusText: String;
  var Result: String
);

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  IdPreparacion: Integer;
  UsarMatricula: Boolean;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iTotalRegsFiltered, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  contentfields: TStringList;
  sPacking: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;
  //CodigoEmpresa := SAGE_EMPRESA_EmpresaOrigen ( Conn, EmpresaOrigen, 'Articulos' );

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  IdPreparacion := StrToIntDef(contentfields.values['IdPreparacion'],0);
  if IdPreparacion=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de preparación no especificado","Data":[]}';
    Exit;
  end;

  UsarMatricula := (AnsiUpperCase(contentfields.values['UsarMatricula'])='TRUE');

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';

  sPacking := FS_SGA_GetPackagingPreparacion ( Conn, CodigoEmpresa, IdPreparacion, UsarMatricula );

  Result := Result +
    sPacking +
    ']}';

end;


procedure WebModule1listPackagingsAction ( Conn: TADOConnection; sParams, sRemoteAddr: String; var statusCode: Integer; var statusText: String; var Result: String );

{$REGION 'Declaració de variables'}
var
  CodigoEmpresa: TOrigenCodigoEmpresa;
  sSQL: String;
  Q: TADOQuery;
  iTotalRegs, iNumRegs: Integer;
  iPageSize, iPage: Integer;
  iPages: Integer;
  EmpresaOrigen: Integer;
  CodigoUsuario: Integer;
  contentfields: TStringList;
  jsonPalet, jsonCaja: String;
  iNumRegsPalet: Integer;
  iNumRegsCaja: Integer;
  Tipo: String;
  Packagings: String;
{$ENDREGION}

begin

  REQUEST_Split ( sParams, contentfields );

  {$REGION 'Recuperació de paràmetres'}

  iPage     := StrToIntDef(contentfields.values['Page'],0);
  iPageSize := StrToIntDef(contentfields.values['PageSize'],DEFAULT_PAGE_SIZE);
  if iPageSize=0 then iPageSize := DEFAULT_PAGE_SIZE;

  EmpresaOrigen := StrToIntDef(contentfields.Values['CodigoEmpresa'], 0 );
  if EmpresaOrigen=0 then begin
    Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"Código de empresa no especificado","Data":[]}';
    Exit;
  end;

  Tipo       := AnsiUpperCase(trim(contentfields.values['Tipo']));
  Packagings := contentfields.values['Packagings'];
  Packagings := StringReplace(Packagings,'[','',[rfReplaceAll]);
  Packagings := StringReplace(Packagings,']','',[rfReplaceAll]);

  SAGE_GetEmpresasStocks (
    Conn,
    EmpresaOrigen,
    '',
    CodigoEmpresa
  );

  {$ENDREGION}

  {$REGION 'Recuperació de totals'}

  sSQL :=
    'SELECT ' +
    '  COUNT(*) ' +
    'FROM FS_SGA_PackagingDetalle WITH (NOLOCK) ';
  if Tipo<>'' then
  begin
    sSQL := sSQL +
      'WHERE Dt_Tipo = ''' + SQL_Str(Tipo) + '''';
  end;
  if Packagings<>'' then
  begin
    sSQL := sSQL +
      'AND Dt_Id IN (' + Packagings + ') ';
  end;

  try
    iTotalRegs := SQL_Execute ( Conn, sSQL );
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', sIDCall, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      Exit;
    end;
  end;

  if Frac(iTotalRegs / iPageSize)=0 then begin
    iPages := iTotalRegs div iPageSize;
  end else begin
    iPages := Trunc(iTotalRegs div iPageSize)+1;
  end;

  {$ENDREGION}

  {$REGION 'Recuperació de dades'}

  sSQL :=
    'SELECT * ' +
    'FROM FS_SGA_PackagingDetalle WITH (NOLOCK) ';

  if Tipo<>'' then
  begin
    sSQL := sSQL +
      'WHERE Dt_Tipo = ''' + SQL_Str(Tipo) + '''';
  end;

  if Packagings<>'' then
  begin
    sSQL := sSQL +
      'AND Dt_Id IN (' + Packagings + ') ';
  end;


  sSQL := sSQL +
    'ORDER BY ' +
    '  Dt_Tipo, DT_Nombre';

  Q := SQL_PrepareQuery ( Conn, sSQL );
  try
    Q.Open;
  except
    on E:Exception do begin
      gaLogFile.Write_DBException(E, sSQL, 'Error al recuperar datos', sIDCall, LOG_LEVEL_EXCEPTION );
      Result := '{"Request":"' + JSON_StrWeb(contentfields.Text) + '","Result":"ERROR","Message":"' + E.Message + '"","Data":[]}';
      FreeAndNil(Q);
      Exit;
    end;
  end;

  iNumRegs := Q.RecordCount;
  Result := '{"Result":"OK","Error":"","TotalRecords":' + IntToStr(iTotalRegs) + ',"NumPages":' + IntToStr(iPages) + ',"NumRecords":' + IntToStr(iNumRegs) + ',"Data":[';
  iNumRegs := 0;
  iNumRegsPalet := 0;
  iNumRegsCaja := 0;

  jsonPalet := '';
  jsonCaja  := '';

  while not Q.Eof do begin

    if AnsiUpperCase(Q.FieldByName('Dt_Tipo').AsString)='PALET' then
    begin

      if iNumRegsPalet<>0 then
        jsonPalet := jsonPalet + ',';

      iNumRegsPalet := iNumRegsPalet + 1;

      jsonPalet := jsonPalet +
        '{' +
        '"Dt_Id":' + IntToStr(Q.FieldByName('Dt_Id').AsInteger) + ',' +
        '"Dt_Nombre":"' + JSON_Str(Q.FieldByName('Dt_Nombre').AsString) + '",' +
        '"Dt_Descripcion":"' + JSON_Str(Q.FieldByName('Dt_Descripcion').AsString) + '",' +
        '"Dt_DigitoMatricula":' + IntToStr(Q.FieldByName('Dt_DigitoMatricula').AsInteger) + ',' +
        '"Dt_CodigoSAGE":"' + JSON_Str(Q.FieldByName('Dt_CodigoSAGE').AsString) + '",' +
        '"Dt_CodigoSAGE_EDI":"' + JSON_Str(Q.FieldByName('Dt_CodigoSAGE_EDI').AsString) + '"' +
        '}';

    end else begin

      if iNumRegsCaja<>0 then
        jsonCaja := jsonCaja + ',';

      iNumRegsCaja := iNumRegsCaja + 1;

      jsonCaja := jsonCaja +
        '{' +
        '"Dt_Id":' + IntToStr(Q.FieldByName('Dt_Id').AsInteger) + ',' +
        '"Dt_Nombre":"' + JSON_Str(Q.FieldByName('Dt_Nombre').AsString) + '",' +
        '"Dt_Descripcion":"' + JSON_Str(Q.FieldByName('Dt_Descripcion').AsString) + '",' +
        '"Dt_CodigoSAGE":"' + JSON_Str(Q.FieldByName('Dt_CodigoSAGE').AsString) + '",' +
        '"Dt_CodigoSAGE_EDI":"' + JSON_Str(Q.FieldByName('Dt_CodigoSAGE_EDI').AsString) + '"' +
        '}';

    end;

    Q.Next;

  end;

  Result := Result +
    '{' +
    '"palets":[' + jsonPalet + '],' +
    '"cajas":[' + jsonCaja + ']' +
    '}';

  Result := Result + ']}';

  Q.Close;
  FreeAndNil(Q);

  {$ENDREGION}

end;


end.
